<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Liquidity Regimes and the Death (and Return) of Valuations: – Deb Bose</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b3b235ae6ba71d6e5c2a90c00144237d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Deb Bose</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../posts/"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../notebooks/index.html"> 
<span class="menu-text">Notebooks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../papers/index.html"> 
<span class="menu-text">Papers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dbose"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#high-level-structure-of-the-paper" id="toc-high-level-structure-of-the-paper" class="nav-link active" data-scroll-target="#high-level-structure-of-the-paper">2. High-Level Structure of the Paper</a></li>
  <li><a href="#abstract-150200-words" id="toc-abstract-150200-words" class="nav-link" data-scroll-target="#abstract-150200-words">3. Abstract (150–200 words)</a></li>
  <li><a href="#motivation" id="toc-motivation" class="nav-link" data-scroll-target="#motivation">4. Motivation</a></li>
  <li><a href="#intuition" id="toc-intuition" class="nav-link" data-scroll-target="#intuition">5. Intuition</a></li>
  <li><a href="#literature-sketch-very-short" id="toc-literature-sketch-very-short" class="nav-link" data-scroll-target="#literature-sketch-very-short">6. Literature Sketch (very short)</a></li>
  <li><a href="#contributions" id="toc-contributions" class="nav-link" data-scroll-target="#contributions">7. Contributions</a></li>
  <li><a href="#data-variables" id="toc-data-variables" class="nav-link" data-scroll-target="#data-variables"><strong>8. Data &amp; Variables</strong></a>
  <ul class="collapse">
  <li><a href="#timeframe-frequency" id="toc-timeframe-frequency" class="nav-link" data-scroll-target="#timeframe-frequency"><strong>8.1 Timeframe &amp; Frequency</strong></a></li>
  <li><a href="#equity-factor-data" id="toc-equity-factor-data" class="nav-link" data-scroll-target="#equity-factor-data"><strong>8.2 Equity &amp; Factor Data</strong></a></li>
  <li><a href="#macro-liquidity-variables" id="toc-macro-liquidity-variables" class="nav-link" data-scroll-target="#macro-liquidity-variables"><strong>8.3 Macro &amp; Liquidity Variables</strong></a></li>
  </ul></li>
  <li><a href="#math" id="toc-math" class="nav-link" data-scroll-target="#math">9. Math</a>
  <ul class="collapse">
  <li><a href="#liquidity-proxies-standardisation" id="toc-liquidity-proxies-standardisation" class="nav-link" data-scroll-target="#liquidity-proxies-standardisation">1. Liquidity Proxies &amp; Standardisation</a></li>
  <li><a href="#example-macro-liquidity-variables" id="toc-example-macro-liquidity-variables" class="nav-link" data-scroll-target="#example-macro-liquidity-variables">2. Example Macro / Liquidity Variables</a></li>
  <li><a href="#covariance-matrix-pca-liquidity-index" id="toc-covariance-matrix-pca-liquidity-index" class="nav-link" data-scroll-target="#covariance-matrix-pca-liquidity-index">3. Covariance Matrix &amp; PCA Liquidity Index</a></li>
  <li><a href="#hmm-liquidity-regimes" id="toc-hmm-liquidity-regimes" class="nav-link" data-scroll-target="#hmm-liquidity-regimes">4. HMM Liquidity Regimes</a></li>
  <li><a href="#multivariate-regime-switching-optional" id="toc-multivariate-regime-switching-optional" class="nav-link" data-scroll-target="#multivariate-regime-switching-optional">5. Multivariate Regime-Switching (Optional)</a></li>
  <li><a href="#valuation-spreads-factor-returns-by-regime" id="toc-valuation-spreads-factor-returns-by-regime" class="nav-link" data-scroll-target="#valuation-spreads-factor-returns-by-regime">6. Valuation Spreads &amp; Factor Returns by Regime</a></li>
  <li><a href="#predictive-regressions-with-liquidity" id="toc-predictive-regressions-with-liquidity" class="nav-link" data-scroll-target="#predictive-regressions-with-liquidity">7. Predictive Regressions with Liquidity</a></li>
  <li><a href="#cross-sectional-famamacbeth-by-regime" id="toc-cross-sectional-famamacbeth-by-regime" class="nav-link" data-scroll-target="#cross-sectional-famamacbeth-by-regime">8. Cross-Sectional (Fama–MacBeth) by Regime</a></li>
  <li><a href="#regime-aware-portfolio" id="toc-regime-aware-portfolio" class="nav-link" data-scroll-target="#regime-aware-portfolio">9. Regime-Aware Portfolio</a></li>
  </ul></li>
  <li><a href="#pca-and-sparse-pca" id="toc-pca-and-sparse-pca" class="nav-link" data-scroll-target="#pca-and-sparse-pca">PCA and Sparse-PCA</a>
  <ul class="collapse">
  <li><a href="#pca-wants-the-direction-with-maximum-variance" id="toc-pca-wants-the-direction-with-maximum-variance" class="nav-link" data-scroll-target="#pca-wants-the-direction-with-maximum-variance"><strong>1. PCA wants the direction with maximum variance</strong></a></li>
  <li><a href="#why-the-constraint-v-2-1" id="toc-why-the-constraint-v-2-1" class="nav-link" data-scroll-target="#why-the-constraint-v-2-1"><strong>2. Why the constraint ( <span class="math inline">\(| v |^{2} = 1\)</span> )?</strong></a></li>
  <li><a href="#reformulating-using-the-covariance-matrix" id="toc-reformulating-using-the-covariance-matrix" class="nav-link" data-scroll-target="#reformulating-using-the-covariance-matrix"><strong>3. Reformulating using the covariance matrix</strong></a></li>
  <li><a href="#intuition-1" id="toc-intuition-1" class="nav-link" data-scroll-target="#intuition-1">Intuition</a></li>
  </ul></li>
  <li><a href="#sparse-pca" id="toc-sparse-pca" class="nav-link" data-scroll-target="#sparse-pca">Sparse PCA</a>
  <ul class="collapse">
  <li><a href="#standard-pca" id="toc-standard-pca" class="nav-link" data-scroll-target="#standard-pca">1. Standard PCA</a></li>
  <li><a href="#what-is-sparse-pca" id="toc-what-is-sparse-pca" class="nav-link" data-scroll-target="#what-is-sparse-pca">2. What is <em>Sparse PCA</em>?</a></li>
  <li><a href="#key-difference" id="toc-key-difference" class="nav-link" data-scroll-target="#key-difference">Key Difference</a></li>
  <li><a href="#why-sparse-pcs-become-interpretable-as-macro-factors" id="toc-why-sparse-pcs-become-interpretable-as-macro-factors" class="nav-link" data-scroll-target="#why-sparse-pcs-become-interpretable-as-macro-factors">Why sparse PCs become interpretable as macro factors</a></li>
  <li><a href="#concrete-example-how-sparse-pcs-isolate-macro-themes" id="toc-concrete-example-how-sparse-pcs-isolate-macro-themes" class="nav-link" data-scroll-target="#concrete-example-how-sparse-pcs-isolate-macro-themes"><strong>Concrete example (how sparse PCs isolate macro themes)</strong></a></li>
  <li><a href="#sparse-pc3-loadings" id="toc-sparse-pc3-loadings" class="nav-link" data-scroll-target="#sparse-pc3-loadings"><strong>Sparse PC3 loadings:</strong></a></li>
  <li><a href="#this-does-not-happen-with-standard-pca." id="toc-this-does-not-happen-with-standard-pca." class="nav-link" data-scroll-target="#this-does-not-happen-with-standard-pca.">This <strong>does not happen</strong> with standard PCA.</a></li>
  <li><a href="#how-sparse-pca-yields-domain-specific-macro-factors" id="toc-how-sparse-pca-yields-domain-specific-macro-factors" class="nav-link" data-scroll-target="#how-sparse-pca-yields-domain-specific-macro-factors">How sparse PCA yields <em>domain-specific macro factors</em></a></li>
  <li><a href="#why-does-this-matter" id="toc-why-does-this-matter" class="nav-link" data-scroll-target="#why-does-this-matter">Why does this matter</a></li>
  <li><a href="#tldr-the-clean-intuition" id="toc-tldr-the-clean-intuition" class="nav-link" data-scroll-target="#tldr-the-clean-intuition">TL;DR — The clean intuition</a></li>
  <li><a href="#standard-pca-1" id="toc-standard-pca-1" class="nav-link" data-scroll-target="#standard-pca-1"><strong>Standard PCA</strong></a></li>
  <li><a href="#sparse-pca-1" id="toc-sparse-pca-1" class="nav-link" data-scroll-target="#sparse-pca-1"><strong>Sparse PCA</strong></a></li>
  <li><a href="#sparse-pcs-are-explainable-because" id="toc-sparse-pcs-are-explainable-because" class="nav-link" data-scroll-target="#sparse-pcs-are-explainable-because">Sparse PCs are explainable because:</a></li>
  </ul></li>
  <li><a href="#config-date-range-series" id="toc-config-date-range-series" class="nav-link" data-scroll-target="#config-date-range-series">Config: Date Range &amp; Series</a></li>
  <li><a href="#download-macro-liquidity-variables-from-fred" id="toc-download-macro-liquidity-variables-from-fred" class="nav-link" data-scroll-target="#download-macro-liquidity-variables-from-fred">Download Macro &amp; Liquidity Variables from FRED</a>
  <ul class="collapse">
  <li><a href="#transform-raw-macro-series-into-j-liquidity-proxies-x_t" id="toc-transform-raw-macro-series-into-j-liquidity-proxies-x_t" class="nav-link" data-scroll-target="#transform-raw-macro-series-into-j-liquidity-proxies-x_t">Transform Raw Macro Series into <span class="math inline">\(J\)</span> Liquidity Proxies <span class="math inline">\(x_t\)</span></a></li>
  <li><a href="#standardize-sign-flip-and-stack-liquidity-proxies-to-get-z_jt" id="toc-standardize-sign-flip-and-stack-liquidity-proxies-to-get-z_jt" class="nav-link" data-scroll-target="#standardize-sign-flip-and-stack-liquidity-proxies-to-get-z_jt">Standardize, Sign-Flip and Stack Liquidity Proxies to Get <span class="math inline">\(z_{j,t}\)</span></a></li>
  <li><a href="#sparse-pca-liquidity-index-l_t" id="toc-sparse-pca-liquidity-index-l_t" class="nav-link" data-scroll-target="#sparse-pca-liquidity-index-l_t">Sparse PCA Liquidity Index <span class="math inline">\(L_{t}\)</span></a></li>
  <li><a href="#hmm-markov-regime-detection-on-l_t" id="toc-hmm-markov-regime-detection-on-l_t" class="nav-link" data-scroll-target="#hmm-markov-regime-detection-on-l_t">HMM / Markov Regime Detection on <span class="math inline">\(L_t\)</span></a></li>
  <li><a href="#equity-factor-data-famafrench" id="toc-equity-factor-data-famafrench" class="nav-link" data-scroll-target="#equity-factor-data-famafrench">Equity Factor Data (Fama–French)</a></li>
  <li><a href="#factor-returns-by-liquidity-regime" id="toc-factor-returns-by-liquidity-regime" class="nav-link" data-scroll-target="#factor-returns-by-liquidity-regime">Factor returns by liquidity regime</a></li>
  <li><a href="#whats-going-on" id="toc-whats-going-on" class="nav-link" data-scroll-target="#whats-going-on">What’s going on ?</a></li>
  <li><a href="#question-is-why-high-liquidity-is-rare-look-at-the-kde-of-gree-state-0" id="toc-question-is-why-high-liquidity-is-rare-look-at-the-kde-of-gree-state-0" class="nav-link" data-scroll-target="#question-is-why-high-liquidity-is-rare-look-at-the-kde-of-gree-state-0">Question is why high liquidity is rare (look at the KDE of gree state 0) ?</a></li>
  <li><a href="#sp-500-monthly-prices" id="toc-sp-500-monthly-prices" class="nav-link" data-scroll-target="#sp-500-monthly-prices">S&amp;P 500 monthly prices</a></li>
  <li><a href="#cape-data-from-httpsshillerdata.com" id="toc-cape-data-from-httpsshillerdata.com" class="nav-link" data-scroll-target="#cape-data-from-httpsshillerdata.com">CAPE Data from https://shillerdata.com/</a></li>
  <li><a href="#from-valuation-levels-into-a-spread-series" id="toc-from-valuation-levels-into-a-spread-series" class="nav-link" data-scroll-target="#from-valuation-levels-into-a-spread-series">From valuation levels into a spread series</a></li>
  <li><a href="#combine-liquidity-regime-with-valuation-spread" id="toc-combine-liquidity-regime-with-valuation-spread" class="nav-link" data-scroll-target="#combine-liquidity-regime-with-valuation-spread">Combine Liquidity Regime with Valuation Spread</a></li>
  <li><a href="#regime-conditional-valuation-spreads" id="toc-regime-conditional-valuation-spreads" class="nav-link" data-scroll-target="#regime-conditional-valuation-spreads">Regime-conditional valuation spreads</a></li>
  <li><a href="#valuation-spreads-factor-returns-by-regime-math" id="toc-valuation-spreads-factor-returns-by-regime-math" class="nav-link" data-scroll-target="#valuation-spreads-factor-returns-by-regime-math">Valuation Spreads &amp; Factor Returns by Regime Math</a></li>
  <li><a href="#insigts" id="toc-insigts" class="nav-link" data-scroll-target="#insigts">Insigts</a></li>
  <li><a href="#plot-lt-sp-500-and-v_spread_t-together-with-regime-shading" id="toc-plot-lt-sp-500-and-v_spread_t-together-with-regime-shading" class="nav-link" data-scroll-target="#plot-lt-sp-500-and-v_spread_t-together-with-regime-shading">Plot L(t), S&amp;P 500, and V_spread_t together with regime shading,</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Liquidity Regimes and the Death (and Return) of Valuations:</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>A 35-Year Quantitative Analysis of Factor Premiums (1990–2025)</p>
<section id="high-level-structure-of-the-paper" class="level2">
<h2 class="anchored" data-anchor-id="high-level-structure-of-the-paper">2. High-Level Structure of the Paper</h2>
<ul>
<li>Story – why this matters (intro + conclusion)</li>
<li>Data – what you measure (markets, factors, liquidity proxies)</li>
<li>Models – how you measure (liquidity index, regimes, cross-sectional tests)</li>
<li>Portfolio – what to do with it (conditional allocation</li>
</ul>
</section>
<section id="abstract-150200-words" class="level2">
<h2 class="anchored" data-anchor-id="abstract-150200-words">3. Abstract (150–200 words)</h2>
<ul>
<li>The “valuations don’t matter in infinite money printing” meme.</li>
<li>Your construction of a liquidity index and liquidity regimes.</li>
<li>Key findings:</li>
<li>Valuations do matter, but <strong>conditional on liquidity regimes</strong>.</li>
<li>Growth dominates in <strong>high-liquidity, negative-real-rate regimes</strong>.</li>
<li>Value premia revive after QT / real rate normalization.</li>
</ul>
<p>Portfolio takeaway: a simple regime-aware factor-tilt model.</p>
</section>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">4. Motivation</h2>
<ul>
<li><p>Narrative: post-GFC QE, ZIRP, NIRP, 2010–2021 “TINA”, tech bubble 2.0.</p></li>
<li><blockquote class="blockquote">
<p>“We live in a world of infinite money printing, so valuations don’t matter.”</p>
</blockquote></li>
<li><p>Research question: &gt; Do valuations truly die under abundant liquidity, or do they merely become regime-dependent?</p></li>
<li><p>Do valuation spreads (cheap vs expensive deciles) expand under high-liquidity regimes and compress under tight liquidity?</p></li>
<li><p>How do factor premia (value, momentum, quality, low vol) vary conditional on liquidity regimes?</p></li>
<li><p>Can a macro-liquidity index predict the timing of factor rotations (growth vs value, long-duration vs short-duration equities)?</p></li>
<li><p>Does a regime-aware factor allocation deliver better risk-adjusted returns than a static factor mix?</p></li>
</ul>
</section>
<section id="intuition" class="level2">
<h2 class="anchored" data-anchor-id="intuition">5. Intuition</h2>
<ul>
<li>Valuation spread: the gap between cheap and expensive stocks (e.g., top vs bottom decile by B/M).</li>
<li>Liquidity regime: periods of systematically easy vs tight financial conditions driven by monetary and fiscal variables.</li>
</ul>
</section>
<section id="literature-sketch-very-short" class="level2">
<h2 class="anchored" data-anchor-id="literature-sketch-very-short">6. Literature Sketch (very short)</h2>
<ul>
<li><strong>Systemic Strategy</strong>: Factor investing: value, momentum, quality.</li>
<li><strong>Risk Factors and Risk premia</strong>: Liquidity</li>
<li><strong>Regime-switching</strong>: macro-conditional factors.</li>
</ul>
</section>
<section id="contributions" class="level2">
<h2 class="anchored" data-anchor-id="contributions">7. Contributions</h2>
<ul>
<li>Build a macro liquidity index from multiple public series.</li>
<li>Use HMM / Markov regimes to label high vs low liquidity states.</li>
<li>Show how valuation spreads and factor returns behave across liquidity regimes.</li>
<li>Propose a simple implementable regime-aware factor strategy.</li>
</ul>
</section>
<section id="data-variables" class="level2">
<h2 class="anchored" data-anchor-id="data-variables"><strong>8. Data &amp; Variables</strong></h2>
<hr>
<section id="timeframe-frequency" class="level3">
<h3 class="anchored" data-anchor-id="timeframe-frequency"><strong>8.1 Timeframe &amp; Frequency</strong></h3>
<ul>
<li>Horizon: <strong>1990–2025</strong>, <strong>monthly</strong> frequency (or weekly if feasible).</li>
<li>Market: US equities (CRSP/Compustat-type universe); optional robustness on AUS/EU.</li>
</ul>
<hr>
</section>
<section id="equity-factor-data" class="level3">
<h3 class="anchored" data-anchor-id="equity-factor-data"><strong>8.2 Equity &amp; Factor Data</strong></h3>
<ul>
<li>Individual stock returns <span class="math inline">\(r_{i,t}\)</span>, market cap, book equity, earnings, etc.</li>
<li>Characteristics <span class="math inline">\(X_{i,t}\)</span>:</li>
</ul>
<p><span class="math display">\[
\text{B/M},\ \text{E/P},\ \text{P/S},\ \text{size},\ \beta,\ \text{12–1 momentum},\ \text{profitability},\ \text{volatility}.
\]</span></p>
<ul>
<li>Factor returns <span class="math inline">\(f_t\)</span>:</li>
</ul>
<p><span class="math display">\[
\text{MKT},\ \text{HML},\ \text{SMB},\ \text{MOM},\ \text{Quality},\ \text{LowVol}.
\]</span></p>
<p>Define a <strong>valuation spread</strong>:</p>
<p><span class="math display">\[
V_t^{\text{spread}} = \text{Long top decile of B/M} - \text{Short bottom decile}.
\]</span></p>
<hr>
</section>
<section id="macro-liquidity-variables" class="level3">
<h3 class="anchored" data-anchor-id="macro-liquidity-variables"><strong>8.3 Macro &amp; Liquidity Variables</strong></h3>
<p>Let raw macro/liquidity variables at time <span class="math inline">\(t\)</span> be <span class="math inline">\(x_{j,t}\)</span>, including:</p>
<hr>
<section id="monetary-balance-sheet" class="level4">
<h4 class="anchored" data-anchor-id="monetary-balance-sheet"><strong>Monetary &amp; Balance Sheet</strong></h4>
<ul>
<li><p>Money growth: <span class="math display">\[\Delta \log(M2_t)\]</span></p></li>
<li><p>Fed balance sheet growth: <span class="math display">\[\Delta \log(\text{BS}_t)\]</span></p></li>
</ul>
<hr>
</section>
<section id="rates-term-structure" class="level4">
<h4 class="anchored" data-anchor-id="rates-term-structure"><strong>Rates &amp; Term Structure</strong></h4>
<ul>
<li><p>Short rate: <span class="math display">\[i_t\]</span></p></li>
<li><p>10Y yield: <span class="math display">\[y_{10,t}\]</span></p></li>
<li><p>Slope: <span class="math display">\[\text{TS}_t = y_{10,t} - i_t\]</span></p></li>
<li><p>Real short rate: <span class="math display">\[r_t^{\text{real}} = i_t - \pi_t^e\]</span></p></li>
</ul>
<hr>
</section>
<section id="risk-spreads" class="level4">
<h4 class="anchored" data-anchor-id="risk-spreads"><strong>Risk &amp; Spreads</strong></h4>
<ul>
<li><p>Credit spread: <span class="math display">\[\text{CS}_t = y_{\text{Baa},t} - y_{\text{Aaa},t}\]</span></p></li>
<li><p>VIX level: <span class="math display">\[\text{VIX}_t\]</span></p></li>
</ul>
<hr>
</section>
<section id="plumbing-variables-if-available" class="level4">
<h4 class="anchored" data-anchor-id="plumbing-variables-if-available"><strong>Plumbing Variables (if available)</strong></h4>
<ul>
<li>ON RRP usage</li>
<li>TGA balance</li>
</ul>
<hr>
<p>All variables <span class="math inline">\(x_{j,t}\)</span> will then be standardized (e.g., z-scored) and aggregated into a <strong>single liquidity index</strong>.</p>
</section>
</section>
</section>
<section id="math" class="level2">
<h2 class="anchored" data-anchor-id="math">9. Math</h2>
<section id="liquidity-proxies-standardisation" class="level3">
<h3 class="anchored" data-anchor-id="liquidity-proxies-standardisation">1. Liquidity Proxies &amp; Standardisation</h3>
<p>Let the raw liquidity indicators be collected in the vector</p>
<p><span class="math display">\[
x_t =
\begin{bmatrix}
x_{1,t} \\
x_{2,t} \\
\vdots \\
x_{J,t}
\end{bmatrix}
\in \mathbb{R}^J.
\]</span></p>
<p>For each series <span class="math display">\[x_{j,t}\]</span>, compute the sample mean <span class="math display">\[
\mu_j = \frac{1}{T} \sum_{t=1}^{T} x_{j,t}
\]</span> and variance <span class="math display">\[
\sigma_j^2 = \frac{1}{T-1} \sum_{t=1}^{T} (x_{j,t} - \mu_j)^2.
\]</span></p>
<p>Standardised variables are then <span class="math display">\[
z_{j,t} = \frac{x_{j,t} - \mu_j}{\sigma_j}, \qquad j = 1,\dots,J,
\]</span> with stacked vector <span class="math display">\[z_t = (z_{1,t},\dots,z_{J,t})^\top\]</span>.</p>
<p>Series may be sign-flipped so that higher values of <span class="math display">\[z_{j,t}\]</span> correspond to easier liquidity; for example, use <span class="math display">\[-r_t^{\text{real}}\]</span> instead of <span class="math display">\[r_t^{\text{real}}\]</span>, <span class="math display">\[-CS_t\]</span> instead of <span class="math display">\[CS_t\]</span>, and <span class="math display">\[-VIX_t\]</span> instead of <span class="math display">\[VIX_t\]</span>.</p>
<hr>
</section>
<section id="example-macro-liquidity-variables" class="level3">
<h3 class="anchored" data-anchor-id="example-macro-liquidity-variables">2. Example Macro / Liquidity Variables</h3>
<p>Typical inputs include <span class="math display">\[\Delta \log M2_t\]</span>, <span class="math display">\[\Delta \log \text{BS}_t\]</span>, the term spread <span class="math display">\[\text{TS}_t = y_{10,t} - i_t\]</span>, the real rate <span class="math display">\[r_t^{\text{real}} = i_t - \pi_t^e\]</span>, and the credit spread <span class="math display">\[\text{CS}_t = y_{Baa,t} - y_{Aaa,t}\]</span>.</p>
<hr>
</section>
<section id="covariance-matrix-pca-liquidity-index" class="level3">
<h3 class="anchored" data-anchor-id="covariance-matrix-pca-liquidity-index">3. Covariance Matrix &amp; PCA Liquidity Index</h3>
<p>Define the covariance matrix <span class="math display">\[
\Sigma = \frac{1}{T} \sum_{t=1}^{T} z_t z_t^\top.
\]</span></p>
<p>Let <span class="math display">\[(\lambda_k, v_k)\]</span> solve <span class="math display">\[\Sigma v_k = \lambda_k v_k\]</span>, with eigenvalues ordered <span class="math display">\[\lambda_1 \ge \lambda_2 \ge \dots \ge \lambda_J\]</span>. The first principal-component liquidity index is then <span class="math display">\[L_t = v_1^\top z_t\]</span>. Alternatively, one may use a fixed-weight index <span class="math display">\[L_t = w^\top z_t\]</span>.</p>
<hr>
</section>
<section id="hmm-liquidity-regimes" class="level3">
<h3 class="anchored" data-anchor-id="hmm-liquidity-regimes">4. HMM Liquidity Regimes</h3>
<p>Let the latent regime variable satisfy <span class="math display">\[s_t \in \{1,\dots,K\}\]</span>, with regime-conditional dynamics <span class="math display">\[
L_t \mid (s_t = k) \sim \mathcal{N}(\mu_k, \sigma_k^2).
\]</span></p>
<p>Transition probabilities are <span class="math display">\[\Pr(s_t = j \mid s_{t-1} = i) = p_{ij}\]</span>, forming the matrix <span class="math display">\[
P =
\begin{bmatrix}
p_{11} &amp; \cdots &amp; p_{1K} \\
\vdots &amp; \ddots &amp; \vdots \\
p_{K1} &amp; \cdots &amp; p_{KK}
\end{bmatrix},
\qquad \sum_{j=1}^{K} p_{ij} = 1.
\]</span></p>
<p>Filtered or smoothed regime classification is given by <span class="math display">\[
\hat{s}_t = \arg\max_{k} \Pr(s_t = k \mid L_{1:T}).
\]</span></p>
<p>Define the high- and tight-liquidity regimes as <span class="math display">\[k_{\text{High}} = \arg\max_k \mu_k\]</span> and <span class="math display">\[k_{\text{Tight}} = \arg\min_k \mu_k\]</span>, with indicator <span class="math display">\[
I_t^{\text{High}} = \mathbf{1}\!\left[\Pr(s_t = k_{\text{High}} \mid L_{1:T}) &gt; 0.5\right].
\]</span></p>
<hr>
</section>
<section id="multivariate-regime-switching-optional" class="level3">
<h3 class="anchored" data-anchor-id="multivariate-regime-switching-optional">5. Multivariate Regime-Switching (Optional)</h3>
<p>In a multivariate setting, define <span class="math display">\[
y_t =
\begin{bmatrix}
L_t \\
r_t^{\text{MKT}} \\
r_t^{\text{HML}} \\
\text{VIX}_t \\
\vdots
\end{bmatrix},
\]</span> with regime-dependent dynamics <span class="math display">\[y_t = A_k y_{t-1} + \varepsilon_t^{(k)}\]</span> and <span class="math display">\[\varepsilon_t^{(k)} \sim \mathcal{N}(0,\Sigma_k)\]</span> when <span class="math display">\[s_t = k\]</span>.</p>
<hr>
</section>
<section id="valuation-spreads-factor-returns-by-regime" class="level3">
<h3 class="anchored" data-anchor-id="valuation-spreads-factor-returns-by-regime">6. Valuation Spreads &amp; Factor Returns by Regime</h3>
<p>Let <span class="math display">\[V_t^{\text{spread}}\]</span> denote a valuation-spread series (e.g., top–bottom decile). The regime-conditional mean is <span class="math display">\[
\bar{V}^{(k)} = \mathbb{E}[V_t^{\text{spread}} \mid s_t = k],
\]</span> with sample estimate <span class="math display">\[
\hat{\bar{V}}^{(k)} =
\frac{\sum_{t=1}^{T} V_t^{\text{spread}} \mathbf{1}(\hat{s}_t = k)}
{\sum_{t=1}^{T} \mathbf{1}(\hat{s}_t = k)}.
\]</span></p>
<p>Differences such as <span class="math display">\[\hat{\bar{V}}^{(\text{High})} - \hat{\bar{V}}^{(\text{Tight})}\]</span> summarise regime effects. Analogously, for factor returns <span class="math display">\[r_t^{(F)}\]</span>, <span class="math display">\[
\bar{r}_F^{(k)} = \mathbb{E}[r_t^{(F)} \mid s_t = k],
\]</span> with Sharpe ratio <span class="math display">\[\text{SR}_F^{(k)} = \hat{\bar{r}}_F^{(k)} / \hat{\sigma}_F^{(k)}\]</span>.</p>
<hr>
</section>
<section id="predictive-regressions-with-liquidity" class="level3">
<h3 class="anchored" data-anchor-id="predictive-regressions-with-liquidity">7. Predictive Regressions with Liquidity</h3>
<p>Continuous-index predictability is tested via <span class="math display">\[
r_{t+1}^{(F)} = \alpha + \beta L_t + \gamma^\top c_t + \varepsilon_{t+1},
\]</span> while regime-based predictability uses <span class="math display">\[
r_{t+1}^{(F)} =
\alpha
+ \delta_{\text{High}} I_t^{\text{High}}
+ \delta_{\text{Tight}} I_t^{\text{Tight}}
+ \delta_{\text{Neutral}} I_t^{\text{Neutral}}
+ \varepsilon_{t+1}.
\]</span></p>
<hr>
</section>
<section id="cross-sectional-famamacbeth-by-regime" class="level3">
<h3 class="anchored" data-anchor-id="cross-sectional-famamacbeth-by-regime">8. Cross-Sectional (Fama–MacBeth) by Regime</h3>
<p>At each time <span class="math display">\[t\]</span>, estimate <span class="math display">\[
r_{i,t+1} =
\alpha_t
+ \lambda_{1,t}\text{Valuation}_{i,t}
+ \lambda_{2,t}\text{Size}_{i,t}
+ \lambda_{3,t}\text{Momentum}_{i,t}
+ \dots
+ \varepsilon_{i,t+1}.
\]</span></p>
<p>Regime-conditional slopes satisfy <span class="math display">\[\bar{\lambda}_1^{(k)} = \mathbb{E}[\lambda_{1,t} \mid s_t = k]\]</span>, with sample analogue <span class="math display">\[
\hat{\bar{\lambda}}_1^{(k)} =
\frac{\sum_{t=1}^{T} \lambda_{1,t} \mathbf{1}(\hat{s}_t = k)}
{\sum_{t=1}^{T} \mathbf{1}(\hat{s}_t = k)}.
\]</span></p>
<hr>
</section>
<section id="regime-aware-portfolio" class="level3">
<h3 class="anchored" data-anchor-id="regime-aware-portfolio">9. Regime-Aware Portfolio</h3>
<p>Let <span class="math display">\[f_t \in \mathbb{R}^K\]</span> denote factor returns and <span class="math display">\[w^{(k)} \in \mathbb{R}^K\]</span> the regime-specific weights. The applied weights are <span class="math display">\[w_t = w^{(\hat{s}_t)}\]</span>, yielding portfolio return <span class="math display">\[
R_{p,t+1} = w_t^\top f_{t+1}.
\]</span></p>
</section>
</section>
<section id="pca-and-sparse-pca" class="level2">
<h2 class="anchored" data-anchor-id="pca-and-sparse-pca">PCA and Sparse-PCA</h2>
<p>Standard PCA solves:</p>
<p><span class="math display">\[
\max_{v} \; \| X v \|^{2}
\quad \text{s.t.} \quad \| v \|^{2} = 1
\]</span></p>
<hr>
<section id="pca-wants-the-direction-with-maximum-variance" class="level3">
<h3 class="anchored" data-anchor-id="pca-wants-the-direction-with-maximum-variance"><strong>1. PCA wants the direction with maximum variance</strong></h3>
<p>PCA tries to find the direction ( <span class="math inline">\(v\)</span> ) (a unit vector) along which the projected data ( <span class="math inline">\(Xv\)</span> ) has <strong>maximum variance</strong>.</p>
<p>Variance of the projection:</p>
<p><span class="math display">\[
\text{Var}(Xv) = \frac{1}{n} |Xv|^{2}.
\]</span></p>
<p>So maximizing variance is equivalent to maximizing ( <span class="math inline">\(|Xv|^{2}\)</span> ).</p>
<hr>
</section>
<section id="why-the-constraint-v-2-1" class="level3">
<h3 class="anchored" data-anchor-id="why-the-constraint-v-2-1"><strong>2. Why the constraint ( <span class="math inline">\(| v |^{2} = 1\)</span> )?</strong></h3>
<p>Without this constraint, the problem would blow up:</p>
<p><span class="math display">\[
|X(\alpha v)|^{2} = \alpha^{2} |Xv|^{2},
\]</span></p>
<p>and the maximum would be infinite by choosing ( <span class="math inline">\(\alpha\)</span> <span class="math inline">\(\infty\)</span> ).</p>
<p>So PCA forces ( <span class="math inline">\(v\)</span> ) to be a <strong>direction</strong>, not a magnitude → a unit vector.</p>
<hr>
</section>
<section id="reformulating-using-the-covariance-matrix" class="level3">
<h3 class="anchored" data-anchor-id="reformulating-using-the-covariance-matrix"><strong>3. Reformulating using the covariance matrix</strong></h3>
<p><span class="math display">\[
|Xv|^{2} = v^\top X^\top X v.
\]</span></p>
<p>Let:</p>
<p><span class="math display">\[
S = X^\top X
\]</span></p>
<p>(the unnormalized covariance matrix). Then PCA solves:</p>
<p><span class="math display">\[
\max_{v} ; v^\top S v
\quad\text{s.t.}\quad v^\top v = 1.
\]</span></p>
<p>This is exactly the <strong>Rayleigh quotient</strong>.</p>
</section>
<section id="intuition-1" class="level3">
<h3 class="anchored" data-anchor-id="intuition-1">Intuition</h3>
<blockquote class="blockquote">
<p>PCA finds the direction (unit vector) along which the data cloud has <strong>maximum spread</strong>. That direction is exactly the eigenvector of the covariance matrix with the largest eigenvalue.</p>
</blockquote>
<hr>
</section>
</section>
<section id="sparse-pca" class="level2">
<h2 class="anchored" data-anchor-id="sparse-pca">Sparse PCA</h2>
<section id="standard-pca" class="level3">
<h3 class="anchored" data-anchor-id="standard-pca">1. Standard PCA</h3>
<ul>
<li>PCA rotates the data into orthogonal directions capturing maximum variance.</li>
<li>Each principal component is a <strong>linear combination of all variables</strong>.</li>
<li>Loadings are typically <strong>dense</strong> (every variable has some non-zero weight).</li>
<li>This makes interpretation difficult:</li>
</ul>
<blockquote class="blockquote">
<p>“PC1 of 127 economic multicolinear variables is 127-dimensional mush of everything.”</p>
</blockquote>
<p>This is why PCA is almost never used directly for economic interpretation — PCs are not sparse.</p>
<hr>
</section>
<section id="what-is-sparse-pca" class="level3">
<h3 class="anchored" data-anchor-id="what-is-sparse-pca">2. What is <em>Sparse PCA</em>?</h3>
<p><strong>Sparse PCA = PCA where most loadings are forced to be zero.</strong></p>
<p>Mathematically:</p>
<p>Standard PCA solves:</p>
<p><span class="math display">\[
\max_{v} \ |Xv|^2 \quad \text{s.t. } |v|_2 = 1
\]</span></p>
<p>Sparse PCA adds an <strong>L1 penalty</strong> (lasso-style sparsity) or constrains the number of non-zero elements:</p>
<p><span class="math display">\[
\max_{v} \ |Xv|^2 - \lambda |v|_1
\]</span></p>
<p>or equivalently:</p>
<p><span class="math display">\[
\max_{v} \ |Xv|^2 \quad \text{s.t. } |v|_2 = 1,\ |v|_1 \leq c
\]</span></p>
<p>This forces:</p>
<ul>
<li>Only a <strong>small subset</strong> of variables to load on each component.</li>
<li>Components become <strong>interpretable</strong> (e.g., PC1 loads on CPI, PCE, core CPI → “inflation”).</li>
</ul>
<p>The specific implementation cited (“penalized matrix decomposition” by Witten et al.&nbsp;2009) solves:</p>
<p><span class="math display">\[
\max_{u, v} \ u^\top X v \quad
\text{s.t. } |u|_2 = 1,\ |v|_2 = 1,\ |v|_1 \le c
\]</span></p>
<p>This is a general sparse factor extraction algorithm.</p>
<p>Intuition: &gt; Sparse PCA forces components to use <strong>only the relevant variables</strong>, not a smear across 127 series.</p>
<hr>
</section>
<section id="key-difference" class="level3">
<h3 class="anchored" data-anchor-id="key-difference">Key Difference</h3>
<ul>
<li><strong>Standard PCA components ≈ dense, uninterpretable mixtures</strong></li>
<li><strong>Sparse PCA components ≈ targeted clusters of interpretable economic variables</strong></li>
</ul>
<hr>
</section>
<section id="why-sparse-pcs-become-interpretable-as-macro-factors" class="level3">
<h3 class="anchored" data-anchor-id="why-sparse-pcs-become-interpretable-as-macro-factors">Why sparse PCs become interpretable as macro factors</h3>
<p>Take FRED-MD’s 127 macro series.</p>
<p>If you run <em>standard</em> PCA:</p>
<ul>
<li>PC1 loads on 100+ variables.</li>
<li>PC2 loads on another 80+.</li>
<li>Interpreting them is basically hopeless.</li>
</ul>
<p>Sparse PCA, with lasso constraints:</p>
<ul>
<li>allows PC1 to load only on inflation-related variables</li>
<li>PC2 to load only on housing-related variables</li>
<li>PC3 on credit spreads</li>
<li>PC4 on yields</li>
<li>PC5 on production</li>
<li>etc.</li>
</ul>
<p>This resembles the <strong>Stock–Watson macro factor model</strong>, but with sparsity for interpretability.</p>
<hr>
</section>
<section id="concrete-example-how-sparse-pcs-isolate-macro-themes" class="level3">
<h3 class="anchored" data-anchor-id="concrete-example-how-sparse-pcs-isolate-macro-themes"><strong>Concrete example (how sparse PCs isolate macro themes)</strong></h3>
<p>Suppose sparse PCA gives:</p>
<section id="sparse-pc1-loadings" class="level4">
<h4 class="anchored" data-anchor-id="sparse-pc1-loadings"><strong>Sparse PC1 loadings:</strong></h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Loading</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CPI YoY</td>
<td>0.71</td>
</tr>
<tr class="even">
<td>Core CPI YoY</td>
<td>0.68</td>
</tr>
<tr class="odd">
<td>PCE Deflator</td>
<td>0.66</td>
</tr>
<tr class="even">
<td>PCE core</td>
<td>0.64</td>
</tr>
<tr class="odd">
<td>All other 123 variables</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>-&gt; You immediately label PC1 as <strong>“inflation factor”</strong>.</p>
</section>
<section id="sparse-pc2-loadings" class="level4">
<h4 class="anchored" data-anchor-id="sparse-pc2-loadings"><strong>Sparse PC2 loadings:</strong></h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Loading</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Housing starts</td>
<td>0.62</td>
</tr>
<tr class="even">
<td>Building permits</td>
<td>0.59</td>
</tr>
<tr class="odd">
<td>New homes sold</td>
<td>0.61</td>
</tr>
<tr class="even">
<td>Mortgage applications</td>
<td>0.58</td>
</tr>
<tr class="odd">
<td>Everything else</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>-&gt; PC2 = <strong>“housing &amp; construction cycle”</strong></p>
</section>
</section>
<section id="sparse-pc3-loadings" class="level3">
<h3 class="anchored" data-anchor-id="sparse-pc3-loadings"><strong>Sparse PC3 loadings:</strong></h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Loading</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Corporate spreads (BAA–AAA)</td>
<td>0.72</td>
</tr>
<tr class="even">
<td>High yield spread</td>
<td>0.69</td>
</tr>
<tr class="odd">
<td>Commercial paper spread</td>
<td>0.64</td>
</tr>
<tr class="even">
<td>Others</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>-&gt; PC3 = <strong>“credit stress”</strong></p>
<p>…and so on.</p>
</section>
<section id="this-does-not-happen-with-standard-pca." class="level3">
<h3 class="anchored" data-anchor-id="this-does-not-happen-with-standard-pca.">This <strong>does not happen</strong> with standard PCA.</h3>
<p>Sparse PCA essentially performs <strong>dimension reduction + variable selection</strong> simultaneously.</p>
<hr>
</section>
<section id="how-sparse-pca-yields-domain-specific-macro-factors" class="level3">
<h3 class="anchored" data-anchor-id="how-sparse-pca-yields-domain-specific-macro-factors">How sparse PCA yields <em>domain-specific macro factors</em></h3>
<p>Sparse PCA encourages:</p>
<ul>
<li><strong>grouping</strong> variables that co-move strongly</li>
<li><strong>dropping</strong> variables unrelated to the theme</li>
<li><strong>choosing</strong> a small number of representative series</li>
</ul>
<p>Given economic data naturally clusters (inflation variables co-move, housing variables co-move), sparse PCA isolates these clusters.</p>
<p>This is similar to economic intuition:</p>
<ul>
<li>inflationary variables form a single latent factor</li>
<li>spreads form a financial stress factor</li>
<li>yields form a term-structure factor</li>
<li>employment variables form a labor factor</li>
</ul>
<p>Sparse PCA “discovers” these clusters automatically.</p>
<hr>
</section>
<section id="why-does-this-matter" class="level3">
<h3 class="anchored" data-anchor-id="why-does-this-matter">Why does this matter</h3>
<p><strong>Sparse PCA → interpretable macro drivers → better regime classification → better factor conditioning.</strong></p>
<p>Especially when constructing a <strong>macro liquidity index</strong> or <strong>financial conditions index</strong>.</p>
<p>Sparse PCA gives:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Component</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PC1</td>
<td>Liquidity / money conditions</td>
</tr>
<tr class="even">
<td>PC2</td>
<td>Credit spreads</td>
</tr>
<tr class="odd">
<td>PC3</td>
<td>Housing activity</td>
</tr>
<tr class="even">
<td>PC4</td>
<td>Yield curve / rates</td>
</tr>
<tr class="odd">
<td>PC5</td>
<td>Employment</td>
</tr>
<tr class="even">
<td>PC6</td>
<td>Production</td>
</tr>
<tr class="odd">
<td>PC7</td>
<td>Income</td>
</tr>
<tr class="even">
<td>PC8</td>
<td>Market stress</td>
</tr>
</tbody>
</table>
<p>These are exactly the components McCracken &amp; Ng (2016) find in FRED-MD.</p>
<hr>
</section>
<section id="tldr-the-clean-intuition" class="level3">
<h3 class="anchored" data-anchor-id="tldr-the-clean-intuition">TL;DR — The clean intuition</h3>
</section>
<section id="standard-pca-1" class="level3">
<h3 class="anchored" data-anchor-id="standard-pca-1"><strong>Standard PCA</strong></h3>
<ul>
<li>Dense loadings</li>
<li>Hard to interpret</li>
<li>PCs are linear mush</li>
</ul>
</section>
<section id="sparse-pca-1" class="level3">
<h3 class="anchored" data-anchor-id="sparse-pca-1"><strong>Sparse PCA</strong></h3>
<ul>
<li>Forces many loadings to zero</li>
<li>Each PC focuses on a small cluster of variables</li>
<li>Becomes interpretable as a “macro theme”</li>
<li>Matches how economists think about the business cycle</li>
<li>Perfect for regime classification &amp; factor research</li>
</ul>
</section>
<section id="sparse-pcs-are-explainable-because" class="level3">
<h3 class="anchored" data-anchor-id="sparse-pcs-are-explainable-because">Sparse PCs are explainable because:</h3>
<ul>
<li>Economic data naturally clusters into themes</li>
<li>Sparse PCA forces components to choose only the strongest cluster</li>
<li>This matches known macro factors (inflation, employment, credit, etc.)</li>
</ul>
<div id="5c2aa549-9af8-4d8d-8199-b3609180c04f" class="cell" data-execution_count="132">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install pandas pandas_datareader numpy scikit-learn hmmlearn matplotlib</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas_datareader <span class="im">import</span> data <span class="im">as</span> pdr</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> SparsePCA</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hmmlearn.hmm <span class="im">import</span> GaussianHMM</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="config-date-range-series" class="level2">
<h2 class="anchored" data-anchor-id="config-date-range-series">Config: Date Range &amp; Series</h2>
<div id="3a242f4a-e57d-4436-abc5-c44afbf16e8d" class="cell" data-execution_count="133">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"1990-01-01"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>end_date   <span class="op">=</span> <span class="st">"2025-12-31"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- FRED series codes ---</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>FRED_SERIES <span class="op">=</span> {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"M2SL"</span>:   <span class="st">"M2SL"</span>,      <span class="co"># M2 money stock (monthly, SA)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FED_BAL"</span>:<span class="st">"WALCL"</span>,     <span class="co"># Fed balance sheet total assets (weekly)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TB3M"</span>:   <span class="st">"TB3MS"</span>,     <span class="co"># 3-Month T-Bill rate (monthly)</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DGS10"</span>:  <span class="st">"DGS10"</span>,     <span class="co"># 10-Year Treasury yield (daily -&gt; resample monthly)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"BAA"</span>:    <span class="st">"BAA"</span>,       <span class="co"># Moody's Baa corporate yield (monthly)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AAA"</span>:    <span class="st">"AAA"</span>,       <span class="co"># Moody's Aaa corporate yield (monthly)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CPI"</span>:    <span class="st">"CPIAUCSL"</span>,  <span class="co"># CPI index (monthly, SA)</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"GDP"</span>:    <span class="st">"GDP"</span>,       <span class="co"># Nominal GDP (quarterly, SAAR)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># For equity factors: Fama-French via pandas_datareader (famafrench)</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>FF_FACTORS_DATASET <span class="op">=</span> <span class="st">"F-F_Research_Data_5_Factors_2x3"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="download-macro-liquidity-variables-from-fred" class="level2">
<h2 class="anchored" data-anchor-id="download-macro-liquidity-variables-from-fred">Download Macro &amp; Liquidity Variables from FRED</h2>
<div id="30b4c0d7-8e94-48e1-b256-61c0cd40db18" class="cell" data-execution_count="134">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_fred_series(series_dict, start, end):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Download FRED series into a single monthly DataFrame.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    series_dict : dict</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Mapping logical_name -&gt; FRED code.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    dfs <span class="op">=</span> []</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, code <span class="kw">in</span> series_dict.items():</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Downloading </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">) from FRED..."</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> pdr.DataReader(code, <span class="st">"fred"</span>, start, end)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> s.rename(columns<span class="op">=</span>{code: name})</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        dfs.append(s)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.concat(dfs, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure monthly freq by end-of-month sampling</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.resample(<span class="st">"M"</span>).last()</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>macro_raw <span class="op">=</span> download_fred_series(FRED_SERIES, start_date, end_date)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>macro_raw.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading M2SL (M2SL) from FRED...
Downloading FED_BAL (WALCL) from FRED...
Downloading TB3M (TB3MS) from FRED...
Downloading DGS10 (DGS10) from FRED...
Downloading BAA (BAA) from FRED...
Downloading AAA (AAA) from FRED...
Downloading CPI (CPIAUCSL) from FRED...
Downloading GDP (GDP) from FRED...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="134">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2SL</th>
<th data-quarto-table-cell-role="th">FED_BAL</th>
<th data-quarto-table-cell-role="th">TB3M</th>
<th data-quarto-table-cell-role="th">DGS10</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">GDP</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-01-31</th>
<td>3166.8</td>
<td>NaN</td>
<td>7.64</td>
<td>8.43</td>
<td>9.94</td>
<td>8.99</td>
<td>127.5</td>
<td>5872.701</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1990-02-28</th>
<td>3179.2</td>
<td>NaN</td>
<td>7.74</td>
<td>8.51</td>
<td>10.14</td>
<td>9.22</td>
<td>128.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-03-31</th>
<td>3190.1</td>
<td>NaN</td>
<td>7.90</td>
<td>8.65</td>
<td>10.21</td>
<td>9.37</td>
<td>128.6</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1990-04-30</th>
<td>3201.6</td>
<td>NaN</td>
<td>7.77</td>
<td>9.04</td>
<td>10.30</td>
<td>9.46</td>
<td>128.9</td>
<td>5960.028</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-05-31</th>
<td>3200.6</td>
<td>NaN</td>
<td>7.74</td>
<td>8.60</td>
<td>10.41</td>
<td>9.47</td>
<td>129.1</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="93037475-da13-401a-a68e-2c907568352c" class="cell" data-execution_count="135">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>macro_raw.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="135">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2SL</th>
<th data-quarto-table-cell-role="th">FED_BAL</th>
<th data-quarto-table-cell-role="th">TB3M</th>
<th data-quarto-table-cell-role="th">DGS10</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">GDP</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>22108.3</td>
<td>6603384.0</td>
<td>4.12</td>
<td>4.23</td>
<td>6.00</td>
<td>5.35</td>
<td>323.364</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.4</td>
<td>6608395.0</td>
<td>3.92</td>
<td>4.16</td>
<td>5.83</td>
<td>5.21</td>
<td>324.368</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>22298.0</td>
<td>6587034.0</td>
<td>3.82</td>
<td>4.11</td>
<td>5.74</td>
<td>5.13</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>22322.4</td>
<td>6552419.0</td>
<td>3.78</td>
<td>4.02</td>
<td>5.86</td>
<td>5.26</td>
<td>325.031</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-12-31</th>
<td>NaN</td>
<td>6640618.0</td>
<td>3.59</td>
<td>4.18</td>
<td>5.90</td>
<td>5.31</td>
<td>326.030</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="transform-raw-macro-series-into-j-liquidity-proxies-x_t" class="level3">
<h3 class="anchored" data-anchor-id="transform-raw-macro-series-into-j-liquidity-proxies-x_t">Transform Raw Macro Series into <span class="math inline">\(J\)</span> Liquidity Proxies <span class="math inline">\(x_t\)</span></h3>
$ x_t =
<span class="math display">\[\begin{bmatrix}
x_{1,t} \
x_{2,t} \
\vdots \
x_{J,t}
\end{bmatrix}\]</span>
<p><br>
x_{J,t} \end{bmatrix} ^J $</p>
<ul>
<li>Money &amp; balance sheet growth: <span class="math inline">\(\Delta \log(\cdot)\)</span></li>
<li>Term spread: <span class="math inline">\(y_{10} - i_{3m}\)</span></li>
<li>Real short rate: <span class="math inline">\(i_{3m} - \pi_{\text{year-on-year}}\)</span></li>
<li>Credit spread: <span class="math inline">\(\text{BAA} - \text{AAA}\)</span></li>
<li>etc.​</li>
</ul>
<div id="e037f67a-dae5-43bb-a338-7b55b460a53c" class="cell" data-execution_count="138">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_liquidity_proxies(macro_df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> macro_df.copy()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Growth of M2 and Fed balance sheet</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dlog_M2"</span>] <span class="op">=</span> np.log(df[<span class="st">"M2SL"</span>]).diff()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dlog_FED_BAL"</span>] <span class="op">=</span> np.log(df[<span class="st">"FED_BAL"</span>]).diff()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Term structure: 10Y - 3M</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"term_spread"</span>] <span class="op">=</span> df[<span class="st">"DGS10"</span>] <span class="op">-</span> df[<span class="st">"TB3M"</span>]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Year-on-year inflation (CPI yoy)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"infl_yoy"</span>] <span class="op">=</span> np.log(df[<span class="st">"CPI"</span>]).diff(<span class="dv">12</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Real short rate: nominal 3M - inflation</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"real_rate"</span>] <span class="op">=</span> df[<span class="st">"TB3M"</span>] <span class="op">-</span> (<span class="dv">100</span> <span class="op">*</span> df[<span class="st">"infl_yoy"</span>])  <span class="co"># TB3M in %, infl_yoy in log -&gt; approx*100</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Credit spread: BAA - AAA</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"credit_spread"</span>] <span class="op">=</span> df[<span class="st">"BAA"</span>] <span class="op">-</span> df[<span class="st">"AAA"</span>]</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop rows with NaNs from diff(12) etc.</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    proxies <span class="op">=</span> df[[<span class="st">"dlog_M2"</span>, <span class="st">"dlog_FED_BAL"</span>, <span class="st">"term_spread"</span>,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"real_rate"</span>, <span class="st">"credit_spread"</span>]].dropna()</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> proxies</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>liquidity_proxies <span class="op">=</span> build_liquidity_proxies(macro_raw)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8846f757-4e43-4aed-845c-f7b1d058e426" class="cell" data-execution_count="141">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>liquidity_proxies.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="141">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dlog_M2</th>
<th data-quarto-table-cell-role="th">dlog_FED_BAL</th>
<th data-quarto-table-cell-role="th">term_spread</th>
<th data-quarto-table-cell-role="th">real_rate</th>
<th data-quarto-table-cell-role="th">credit_spread</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2003-01-31</th>
<td>0.005642</td>
<td>-0.026648</td>
<td>2.83</td>
<td>-1.550123</td>
<td>1.18</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2003-02-28</th>
<td>0.006192</td>
<td>0.012784</td>
<td>2.54</td>
<td>-1.927593</td>
<td>1.11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2003-03-31</th>
<td>0.003448</td>
<td>0.004200</td>
<td>2.70</td>
<td>-1.850353</td>
<td>1.06</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2003-04-30</th>
<td>0.006302</td>
<td>0.028922</td>
<td>2.76</td>
<td>-1.021807</td>
<td>1.11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2003-05-31</th>
<td>0.010075</td>
<td>-0.001875</td>
<td>2.30</td>
<td>-0.806435</td>
<td>1.16</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="standardize-sign-flip-and-stack-liquidity-proxies-to-get-z_jt" class="level3">
<h3 class="anchored" data-anchor-id="standardize-sign-flip-and-stack-liquidity-proxies-to-get-z_jt">Standardize, Sign-Flip and Stack Liquidity Proxies to Get <span class="math inline">\(z_{j,t}\)</span></h3>
<p>We want higher <span class="math inline">\(z_{j,t}\)</span> – to mean easier liquidity.</p>
<ul>
<li>Growth of M2 / Fed balance sheet: already “easier = higher value” -&gt; keeping sign</li>
<li>Term spread: steeper (more positive) often associated with easier conditions -&gt; keeping sign</li>
<li>Real rate: easier liquidity when real rates are low -&gt; flipping sign</li>
<li>Credit spread: easier liquidity when spreads are tight (low) -&gt; flipping sign</li>
</ul>
<div id="00deb5e9-7372-404c-a872-15aaa066c852" class="cell" data-execution_count="305">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> standardize_and_signflip(proxies: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Standardize each column and flip signs so that higher z_{j,t}</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">    always corresponds to easier liquidity.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">    proxies : pd.DataFrame</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Liquidity proxy variables including flows, stocks, and momentum terms</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Standardized and sign-adjusted proxies</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> proxies.copy()</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize all variables to z-scores</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    z_vals <span class="op">=</span> scaler.fit_transform(z)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> pd.DataFrame(z_vals, index<span class="op">=</span>z.index, columns<span class="op">=</span>z.columns)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sign flips so "higher" = easier liquidity</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    sign_flips <span class="op">=</span> {</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==========================================</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># FLOW VARIABLES (month-over-month changes)</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==========================================</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dlog_M2"</span>: <span class="op">+</span><span class="dv">1</span>,          <span class="co"># Higher M2 growth = easier</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dlog_FED_BAL"</span>: <span class="op">+</span><span class="dv">1</span>,     <span class="co"># Higher Fed BS growth = easier</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"term_spread"</span>: <span class="op">+</span><span class="dv">1</span>,      <span class="co"># Steeper yield curve = easier</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"real_rate"</span>: <span class="op">-</span><span class="dv">1</span>,        <span class="co"># Higher real rate = TIGHTER → flip to negative</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"credit_spread"</span>: <span class="op">-</span><span class="dv">1</span>,    <span class="co"># Higher credit spread = TIGHTER → flip to negative</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==========================================</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># STOCK/LEVEL VARIABLES (deviations from trend)</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==========================================</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"EM"</span>: <span class="op">+</span><span class="dv">1</span>,               <span class="co"># Excess M2 above trend = easier</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"EB"</span>: <span class="op">+</span><span class="dv">1</span>,               <span class="co"># Excess Fed BS above trend = easier</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"EL_3y"</span>: <span class="op">+</span><span class="dv">1</span>,            <span class="co"># 3-year excess liquidity vs GDP = easier</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ZIRP_dummy"</span>: <span class="op">+</span><span class="dv">1</span>,       <span class="co"># In ZIRP regime = easier</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==========================================</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># MOMENTUM VARIABLES (rate of change)</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ==========================================</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dL_3m"</span>: <span class="op">+</span><span class="dv">1</span>,            <span class="co"># Increasing excess M2 = easier</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dL_12m"</span>: <span class="op">+</span><span class="dv">1</span>,           <span class="co"># 12-month acceleration in excess M2 = easier</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dEB_dt"</span>: <span class="op">+</span><span class="dv">1</span>,           <span class="co"># Accelerating Fed BS expansion = easier</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"accel_ZIRP"</span>: <span class="op">+</span><span class="dv">1</span>,       <span class="co"># Entering ZIRP (0→1) = easier; Exiting (1→0) = tighter</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Optional: Add second derivatives if included</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"d2L_dt2"</span>: <span class="op">+</span><span class="dv">1</span>,          <span class="co"># Positive acceleration = easier</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vol_L"</span>: <span class="op">-</span><span class="dv">1</span>,            <span class="co"># Higher volatility = uncertainty = tighter</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply sign flips to all present columns</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col, sgn <span class="kw">in</span> sign_flips.items():</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> z.columns:</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>            z[col] <span class="op">=</span> sgn <span class="op">*</span> z[col]</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># else:</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     # Optionally warn if expected column is missing</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">#     print(f"Warning: Expected column '{col}' not found in proxies")</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> z</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>z_t <span class="op">=</span> standardize_and_signflip(liquidity_proxies)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0cfd8829-7870-4d9f-9e4f-873e95fdd4fe" class="cell" data-execution_count="186">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>z_t.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="186">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dlog_M2</th>
<th data-quarto-table-cell-role="th">dlog_FED_BAL</th>
<th data-quarto-table-cell-role="th">term_spread</th>
<th data-quarto-table-cell-role="th">real_rate</th>
<th data-quarto-table-cell-role="th">credit_spread</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>0.054918</td>
<td>-0.226158</td>
<td>-1.082298</td>
<td>-1.208083</td>
<td>0.782405</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-0.162427</td>
<td>-0.256413</td>
<td>-0.996504</td>
<td>-1.189743</td>
<td>0.879895</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-0.213553</td>
<td>-0.325854</td>
<td>-1.004304</td>
<td>-1.027790</td>
<td>0.879895</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-0.035859</td>
<td>-0.169662</td>
<td>-0.902911</td>
<td>-0.890559</td>
<td>0.953012</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>-0.623037</td>
<td>-0.310671</td>
<td>-0.902911</td>
<td>-0.969690</td>
<td>1.001756</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sparse-pca-liquidity-index-l_t" class="level3">
<h3 class="anchored" data-anchor-id="sparse-pca-liquidity-index-l_t">Sparse PCA Liquidity Index <span class="math inline">\(L_{t}\)</span></h3>
<div id="fa2901dd-276d-42d1-a9e7-fa9e12c6dac1" class="cell" data-execution_count="140">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>pd.Series(z_t.index).describe()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="140">
<pre><code>count                              274
mean     2014-06-15 16:38:32.408759040
min                2003-01-31 00:00:00
25%                2008-10-07 18:00:00
50%                2014-06-15 00:00:00
75%                2020-02-21 18:00:00
max                2025-11-30 00:00:00
Name: DATE, dtype: object</code></pre>
</div>
</div>
<div id="c487ec96-abbc-42c3-809d-2f6b8e9200fc" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>z_t.values</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>array([[ 0.1180247 , -0.81081346,  1.11713917,  0.32626822, -0.41183909],
       [ 0.20761695,  0.11166407,  0.89095592,  0.51056885, -0.24123275],
       [-0.23943481, -0.08914208,  1.01574668,  0.47285631, -0.11937107],
       ...,
       [-0.21355338, -0.32585415, -1.00430373, -1.0277896 ,  0.87989467],
       [-0.03585918, -0.1696623 , -0.90291124, -0.89055947,  0.95301167],
       [-0.62303684, -0.31067073, -0.90291124, -0.96969022,  1.00175634]])</code></pre>
</div>
</div>
<div id="22f22dd0-3c7b-4aff-89ed-8fcc5c5de664" class="cell" data-execution_count="333">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_sparse_pca_liquidity_index(z_df: pd.DataFrame,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                                     alpha: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                     random_state: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                    n_check: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply SparsePCA with 1 component to z_{j,t} to obtain L_t.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    spca <span class="op">=</span> SparsePCA(</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        n_components<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>random_state</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    L_scores <span class="op">=</span> spca.fit_transform(z_df.values)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> pd.Series(L_scores.flatten(), index<span class="op">=</span>z_df.index, name<span class="op">=</span><span class="st">"L"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get loadings</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    loadings <span class="op">=</span> spca.components_[<span class="dv">0</span>]</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SparsePCA components (loadings):"</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    loading_dict <span class="op">=</span> {}</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> coef, col <span class="kw">in</span> <span class="bu">zip</span>(loadings, z_df.columns):</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>coef<span class="sc">:+.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        loading_dict[col] <span class="op">=</span> coef</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ========================================</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># WEIGHTED VOTING FOR SIGN ENFORCEMENT</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ========================================</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get top N variables by absolute loading</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    abs_loadings <span class="op">=</span> np.<span class="bu">abs</span>(loadings)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    top_indices <span class="op">=</span> np.argsort(abs_loadings)[<span class="op">-</span>n_check:][::<span class="op">-</span><span class="dv">1</span>]  <span class="co"># Top n_check, descending</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Top </span><span class="sc">{</span>n_check<span class="sc">}</span><span class="ss"> variables by absolute loading:"</span>)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Weighted voting: correlation * absolute loading</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    weighted_corr_sum <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    total_weight <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> top_indices:</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        var <span class="op">=</span> z_df.columns[idx]</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>        weight <span class="op">=</span> abs_loadings[idx]</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        corr <span class="op">=</span> np.corrcoef(L, z_df[var])[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        weighted_corr <span class="op">=</span> corr <span class="op">*</span> weight</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">: loading=</span><span class="sc">{</span>loadings[idx]<span class="sc">:+.3f}</span><span class="ss">, corr=</span><span class="sc">{</span>corr<span class="sc">:+.3f}</span><span class="ss">, weighted=</span><span class="sc">{</span>weighted_corr<span class="sc">:+.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>        weighted_corr_sum <span class="op">+=</span> weighted_corr</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>        total_weight <span class="op">+=</span> weight</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average weighted correlation</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    avg_weighted_corr <span class="op">=</span> weighted_corr_sum <span class="op">/</span> total_weight</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Weighted average correlation: </span><span class="sc">{</span>avg_weighted_corr<span class="sc">:+.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flip if weighted average is negative</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> avg_weighted_corr <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"⚠️  FLIPPING SIGN: L_t weighted correlation negative"</span>)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>        L <span class="op">=</span> <span class="op">-</span>L</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"✅ Sign correct: L_t weighted correlation positive"</span>)</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>L_t <span class="op">=</span> build_sparse_pca_liquidity_index(z_t, alpha<span class="op">=</span><span class="fl">0.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SparsePCA components (loadings):
  dlog_M2: +0.429
  dlog_FED_BAL: +0.524
  term_spread: +0.493
  real_rate: +0.390
  credit_spread: -0.383

Top 3 variables by absolute loading:
  dlog_FED_BAL: loading=+0.524, corr=+0.698, weighted=+0.366
  term_spread: loading=+0.493, corr=+0.658, weighted=+0.324
  dlog_M2: loading=+0.429, corr=+0.577, weighted=+0.248

Weighted average correlation: +0.649
✅ Sign correct: L_t weighted correlation positive</code></pre>
</div>
</div>
<div id="f1a1246c-fe23-403c-aed1-3af3fc18e600" class="cell" data-execution_count="334">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>L_t.plot(title<span class="op">=</span><span class="st">"Sparse PCA Liquidity Index L(t)"</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">0</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hmm-markov-regime-detection-on-l_t" class="level3">
<h3 class="anchored" data-anchor-id="hmm-markov-regime-detection-on-l_t">HMM / Markov Regime Detection on <span class="math inline">\(L_t\)</span></h3>
<p>​Fit a Gaussian HMM on the liquidity index. 2 or 3 regimes ?</p>
<div id="31367413-2efd-4b03-aa4a-c81137cfbaba" class="cell" data-execution_count="193">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hmmlearn.hmm <span class="im">import</span> GaussianHMM</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit_hmm_on_liquidity(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    L: pd.Series,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    n_states: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    covariance_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">"full"</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    random_state: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    standardize: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Fit a Gaussian HMM on L(t) and return the model and a DataFrame</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">    with inferred regimes and posterior probabilities.</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">    L : pd.Series</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Liquidity index (indexed by date).</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co">    n_states : int</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of hidden states (regimes).</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co">    standardize : bool</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co">        If True, standardize L before fitting the HMM.</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="co">    model : GaussianHMM</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="co">    df_regime : pd.DataFrame</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns: L, state, p_state_k, state_label</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) Prepare X</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> L.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> <span class="va">None</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> standardize:</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) Fit HMM</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> GaussianHMM(</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>        n_components<span class="op">=</span>n_states,</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        covariance_type<span class="op">=</span>covariance_type,</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>random_state,</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>        n_iter<span class="op">=</span><span class="dv">500</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    model.fit(X)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    hidden_states <span class="op">=</span> model.predict(X)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    post_probs <span class="op">=</span> model.predict_proba(X)  <span class="co"># T x n_states</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) Build output DataFrame on original index</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    df_regime <span class="op">=</span> pd.DataFrame(</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"L"</span>: L, <span class="st">"state"</span>: hidden_states},</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>L.index</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(n_states):</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>        df_regime[<span class="ss">f"p_state_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> post_probs[:, k]</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) Use state means to order regimes</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> pd.Series(model.means_.flatten(), index<span class="op">=</span><span class="bu">range</span>(n_states))</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"HMM state means (unsorted, in fitted scale):"</span>)</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, m <span class="kw">in</span> means.items():</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  state </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: mean L = </span><span class="sc">{</span>m<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Order states from low liquidity to high liquidity</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    ordering <span class="op">=</span> means.sort_values().index.tolist()</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    state_label_map <span class="op">=</span> {}</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_states <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>        state_label_map[ordering[<span class="dv">0</span>]] <span class="op">=</span> <span class="st">"Tight"</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>        state_label_map[ordering[<span class="dv">1</span>]] <span class="op">=</span> <span class="st">"Neutral"</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>        state_label_map[ordering[<span class="dv">2</span>]] <span class="op">=</span> <span class="st">"High"</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> n_states <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>        state_label_map[ordering[<span class="dv">0</span>]] <span class="op">=</span> <span class="st">"Tight"</span></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>        state_label_map[ordering[<span class="dv">1</span>]] <span class="op">=</span> <span class="st">"High"</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generic labels if you ever use more states</span></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, s <span class="kw">in</span> <span class="bu">enumerate</span>(ordering):</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>            state_label_map[s] <span class="op">=</span> <span class="ss">f"Regime_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>    df_regime[<span class="st">"state_label"</span>] <span class="op">=</span> df_regime[<span class="st">"state"</span>].<span class="bu">map</span>(state_label_map)</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, df_regime</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e1a99b29-c613-41d2-a297-12f0f12729ed" class="cell" data-execution_count="194">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>n_states <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>model, regimes_df <span class="op">=</span> fit_hmm_on_liquidity(L_t,n_states)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>HMM state means (unsorted, in fitted scale):
  state 0: mean L = 2.689
  state 1: mean L = 0.379
  state 2: mean L = -0.861</code></pre>
</div>
</div>
<div id="2f031232-40cb-47ef-8607-61a290fcf924" class="cell" data-execution_count="195">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>regimes_df.tail(<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="195">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">p_state_2</th>
<th data-quarto-table-cell-role="th">state_label</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>-1.620391</td>
<td>2</td>
<td>0.000292</td>
<td>2.068795e-07</td>
<td>0.999708</td>
<td>Tight</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="16148df3-0533-4043-aada-e64b93601a79" class="cell" data-execution_count="196">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>means <span class="op">=</span> pd.Series(model.means_.flatten(), index<span class="op">=</span><span class="bu">range</span>(n_states))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>var_covar <span class="op">=</span> pd.Series(model._covars_.flatten(), index<span class="op">=</span><span class="bu">range</span>(n_states))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>model_df <span class="op">=</span> pd.DataFrame({<span class="st">'means'</span>: means, <span class="st">'var'</span>: var_covar})</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>model_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="196">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">means</th>
<th data-quarto-table-cell-role="th">var</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2.689160</td>
<td>3.067263</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0.378674</td>
<td>0.112808</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>-0.860576</td>
<td>0.190807</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="ffefef6d-f628-4d9d-aef4-7eb1e4b74718" class="cell" data-execution_count="197">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_regime_summary(regimes_df, L_series, state_col<span class="op">=</span><span class="st">'state_label'</span>):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate summary statistics for regime table.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    summary <span class="op">=</span> []</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> state <span class="kw">in</span> <span class="bu">sorted</span>(regimes_df[state_col].unique()):</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        state_mask <span class="op">=</span> regimes_df[state_col] <span class="op">==</span> state</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        L_values <span class="op">=</span> L_series[state_mask]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        n_months <span class="op">=</span> state_mask.<span class="bu">sum</span>()</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        pct_months <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> n_months <span class="op">/</span> <span class="bu">len</span>(regimes_df)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        summary.append({</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Regime'</span>: state,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Mean L(t)'</span>: L_values.mean(),</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Std Dev'</span>: L_values.std(),</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Months'</span>: n_months,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Percent'</span>: pct_months</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(summary)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> calculate_regime_summary(regimes_df, L_t)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Regime  Mean L(t)   Std Dev  Months    Percent
0     High   3.799643  2.379628      12   4.379562
1  Neutral   0.502652  0.450198     155  56.569343
2    Tight  -1.154269  0.575142     107  39.051095</code></pre>
</div>
</div>
<div id="5f36427e-915a-458c-853e-6b35095ed5cf" class="cell" data-execution_count="198">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># TOP PANEL — L(t) + shading</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].plot(regimes_df.index, regimes_df[<span class="st">"L"</span>], color<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="fl">1.2</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Sparse PCA Liquidity Index L(t) with Regime Shading"</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Define plain colors for each regime</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>regime_colors <span class="op">=</span> {</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tight"</span>:   <span class="st">"green"</span>,</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Neutral"</span>: <span class="st">"gray"</span>,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"High"</span>:    <span class="st">"crimson"</span>,</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>shade_alpha <span class="op">=</span> <span class="fl">0.2</span>  <span class="co"># semi-opaque</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label, color <span class="kw">in</span> regime_colors.items():</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> regimes_df[<span class="st">"state_label"</span>] <span class="op">==</span> label</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    in_region <span class="op">=</span> <span class="va">False</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="va">None</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(mask)):</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mask.iloc[i] <span class="kw">and</span> <span class="kw">not</span> in_region:</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>            in_region <span class="op">=</span> <span class="va">True</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> regimes_df.index[i]</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="kw">not</span> mask.iloc[i] <span class="kw">and</span> in_region:</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>            in_region <span class="op">=</span> <span class="va">False</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> regimes_df.index[i]</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">0</span>].axvspan(start, end, color<span class="op">=</span>color, alpha<span class="op">=</span>shade_alpha, linewidth<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If region extends to the end of the sample</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> in_region:</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].axvspan(start, regimes_df.index[<span class="op">-</span><span class="dv">1</span>], color<span class="op">=</span>color, alpha<span class="op">=</span>shade_alpha, linewidth<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Legend for regimes (shaded colors)</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.lines <span class="im">import</span> Line2D</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>legend_patches <span class="op">=</span> [</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">"green"</span>,   lw<span class="op">=</span><span class="dv">6</span>, alpha<span class="op">=</span>shade_alpha, label<span class="op">=</span><span class="st">"Tight"</span>),</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">"gray"</span>,    lw<span class="op">=</span><span class="dv">6</span>, alpha<span class="op">=</span>shade_alpha, label<span class="op">=</span><span class="st">"Neutral"</span>),</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">"crimson"</span>, lw<span class="op">=</span><span class="dv">6</span>, alpha<span class="op">=</span>shade_alpha, label<span class="op">=</span><span class="st">"High"</span>),</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].legend(handles<span class="op">=</span>legend_patches, loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="co"># BOTTOM PANEL — High regime probability</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"p_state_0"</span> <span class="kw">in</span> regimes_df.columns:</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    high_state_id <span class="op">=</span> regimes_df.groupby(<span class="st">"state_label"</span>)[<span class="st">"state"</span>].first()[<span class="st">"High"</span>]</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].plot(regimes_df.index,</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>               regimes_df[<span class="ss">f"p_state_</span><span class="sc">{</span>high_state_id<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span><span class="st">"crimson"</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].set_title(<span class="st">"Posterior Probability of High Liquidity Regime"</span>)</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="equity-factor-data-famafrench" class="level3">
<h3 class="anchored" data-anchor-id="equity-factor-data-famafrench">Equity Factor Data (Fama–French)</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/9845e494-dbbc-4be7-b3b4-5dff7c897fe7-1-6a346252-d5d4-4144-9c69-10966ab34764.png" class="img-fluid figure-img"></p>
<figcaption>image.png</figcaption>
</figure>
</div>
<p>These five factors extend the original 3-factor model to better explain cross-sectional stock returns.</p>
<p>They are:</p>
<ol type="1">
<li><strong>Rm–Rf</strong> — Market excess return</li>
<li><strong>SMB</strong> — Size (Small Minus Big)</li>
<li><strong>HML</strong> — Value (High Book/Market minus Low)</li>
<li><strong>RMW</strong> — Profitability (Robust Minus Weak)</li>
<li><strong>CMA</strong> — Investment (Conservative Minus Aggressive)</li>
</ol>
<p>Let’s break each down precisely.</p>
<hr>
<section id="rm-rf-market-excess-return" class="level4">
<h4 class="anchored" data-anchor-id="rm-rf-market-excess-return"><strong>Rm – Rf: Market Excess Return</strong></h4>
<p><span class="math display">\[
R_{m}-R_{f}
\]</span> The return of the <strong>broad market</strong> minus the <strong>risk-free rate</strong>.</p>
<ul>
<li>Positive → market went up more than cash.</li>
<li>Negative → market underperformed cash/T-bills.</li>
</ul>
<p><strong>In above table:</strong></p>
<ul>
<li>Last 12 months: <strong>+17.54%</strong> → very strong bull market year.</li>
<li>Last 3 months: <strong>+7.40%</strong> → strong quarter.</li>
<li>October 2025: <strong>+1.95%</strong> → moderate positive month.</li>
</ul>
<hr>
</section>
<section id="smb-size-factor-small-minus-big" class="level4">
<h4 class="anchored" data-anchor-id="smb-size-factor-small-minus-big"><strong>SMB: Size Factor (Small Minus Big)</strong></h4>
<p><span class="math display">\[
\text{SMB} = R_{\text{small}} - R_{\text{big}}
\]</span></p>
<ul>
<li>Positive → small caps outperform large caps.</li>
<li>Negative → large caps outperform small caps.</li>
</ul>
<p><strong>In above table:</strong></p>
<ul>
<li>Last 12 months: <strong>–10.71%</strong> → a <em>massive</em> large-cap dominance year.</li>
<li>This is consistent with mega-cap tech leadership.</li>
</ul>
<hr>
</section>
<section id="hml-value-factor-high-minus-low-book-to-market" class="level4">
<h4 class="anchored" data-anchor-id="hml-value-factor-high-minus-low-book-to-market"><strong>HML: Value Factor (High Minus Low Book-to-Market)</strong></h4>
<p><span class="math display">\[
\text{HML} = R_{\text{value}} - R_{\text{growth}}
\]</span></p>
<ul>
<li>Positive → value outperforms growth.</li>
<li>Negative → growth outperforms value.</li>
</ul>
<p><strong>In above table:</strong></p>
<ul>
<li>Last 12 months: <strong>–2.36%</strong> → growth beat value.</li>
<li>October 2025: <strong>–3.10%</strong> → especially growth-heavy month.</li>
</ul>
<p>This aligns with liquidity-driven growth leadership.</p>
<hr>
</section>
<section id="rmw-profitability-robust-minus-weak" class="level4">
<h4 class="anchored" data-anchor-id="rmw-profitability-robust-minus-weak"><strong>RMW: Profitability (Robust Minus Weak)</strong></h4>
<p><span class="math display">\[
\text{RMW} = R_{\text{robust}} - R_{\text{weak}}
\]</span></p>
<p>Robust = high operating profitability. Weak = low profitability.</p>
<ul>
<li>Positive → profitable companies outperform weak ones.</li>
<li>Negative → weak/low-profit companies outperform.</li>
</ul>
<p><strong>In above table:</strong></p>
<ul>
<li>Last 12 months: <strong>–13.60%</strong> → very unusual.</li>
<li>This means <strong>unprofitable firms outperformed</strong> profitable ones over the year.</li>
</ul>
<p>That usually happens in:</p>
<ul>
<li>early speculative bubbles</li>
<li>liquidity-driven rallies</li>
<li>retail-led tech/small-cap frenzies</li>
<li>AI/futuristic narrative periods</li>
</ul>
<hr>
</section>
<section id="cma-investment-factor-conservative-minus-aggressive" class="level4">
<h4 class="anchored" data-anchor-id="cma-investment-factor-conservative-minus-aggressive"><strong>CMA: Investment Factor (Conservative Minus Aggressive)</strong></h4>
<p><span class="math display">\[
\text{CMA} = R_{\text{conservative}} - R_{\text{aggressive}}
\]</span></p>
<ul>
<li>Conservative = firms investing slowly</li>
<li>Aggressive = firms aggressively expanding assets</li>
</ul>
<p>High investment → lower expected returns historically (consistent with q-theory: empire-building destroys value).</p>
<ul>
<li>Positive → conservative firms outperform heavy spenders.</li>
<li>Negative → aggressive investment firms outperform.</li>
</ul>
<p><strong>In above table:</strong></p>
<ul>
<li>Last 12 months: <strong>–10.46%</strong></li>
<li>Last 3 months: <strong>–4.47%</strong></li>
<li>October 2025: <strong>–4.03%</strong></li>
</ul>
<p>Interpretation: Aggressively investing companies — think AI, R&amp;D, biotech, high-growth tech — massively outperformed low-investment firms.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 65%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th>Factor</th>
<th>Sign</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Rm–Rf: +</strong></td>
<td>Strong bull market</td>
<td></td>
</tr>
<tr class="even">
<td><strong>SMB: –</strong></td>
<td>Mega-caps beat small caps massively</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>HML: –</strong></td>
<td>Growth beat value</td>
<td></td>
</tr>
<tr class="even">
<td><strong>RMW: –</strong></td>
<td>Low-profit firms beat profitable firms</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>CMA: –</strong></td>
<td>Aggressive-investment firms beat conservative ones</td>
<td></td>
</tr>
</tbody>
</table>
<p>This is the <strong>textbook signature of a liquidity-driven growth/tech momentum regime</strong>, almost identical to:</p>
<ul>
<li>1998–1999 Dotcom</li>
<li>2019–2021 QE wave</li>
<li>2023–2024 AI mega-cap boom</li>
</ul>
<p>It means:</p>
</section>
<section id="investors-preferred" class="level4">
<h4 class="anchored" data-anchor-id="investors-preferred">Investors preferred</h4>
<ul>
<li>large</li>
<li>growth</li>
<li>unprofitable</li>
<li>high-spending</li>
<li>high-duration <strong>tech/AI/future-theme stocks</strong></li>
</ul>
</section>
<section id="fundamentals-profitability-valuation-conservative-investment-were-penalized" class="level4">
<h4 class="anchored" data-anchor-id="fundamentals-profitability-valuation-conservative-investment-were-penalized">Fundamentals (profitability, valuation, conservative investment) were <em>penalized</em></h4>
<p>This is exactly the kind of environment where:</p>
<ul>
<li>Value fails</li>
<li>Small cap fails</li>
<li>Profitability fails</li>
<li>Investment works negatively</li>
<li>Growth dominates</li>
<li>Mega-caps dominate</li>
</ul>
<div id="61a50746-539d-4114-8f6b-1452b00ae55d" class="cell" data-execution_count="199">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_ff_factors(start, end):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Download monthly Fama-French 5 factors (2x3) using pandas_datareader.</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Downloading Fama-French factors (famafrench)..."</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    ff_raw <span class="op">=</span> pdr.DataReader(</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>FF_FACTORS_DATASET,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        data_source<span class="op">=</span><span class="st">"famafrench"</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        start<span class="op">=</span>start,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        end<span class="op">=</span>end</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    )[<span class="dv">0</span>]  <span class="co"># table [0] contains the data</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    ff <span class="op">=</span> (ff_raw</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>          .divide(<span class="dv">100</span>)  <span class="co"># convert from % to decimal</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>          .reset_index(names<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>          .assign(date<span class="op">=</span><span class="kw">lambda</span> x: pd.to_datetime(x[<span class="st">"date"</span>].astype(<span class="bu">str</span>)))</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>          .rename(<span class="bu">str</span>.lower, axis<span class="op">=</span><span class="st">"columns"</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>          .rename(columns<span class="op">=</span>{<span class="st">"mkt-rf"</span>: <span class="st">"mkt_excess"</span>}))</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    ff <span class="op">=</span> ff.set_index(<span class="st">"date"</span>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ff</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>ff_factors <span class="op">=</span> download_ff_factors(start_date, end_date)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading Fama-French factors (famafrench)...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_raw = pdr.DataReader(
&lt;ipython-input-199-55f7e03990a5&gt;:6: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_raw = pdr.DataReader(</code></pre>
</div>
</div>
<div id="b4549377-7aa7-428a-b1e7-90b8c2b507c6" class="cell" data-execution_count="201">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>ff_factors.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="201">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-01</th>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-01</th>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0067</td>
<td>0.0208</td>
<td>0.0038</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-01</th>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-10-01</th>
<td>0.0196</td>
<td>-0.0131</td>
<td>-0.0309</td>
<td>-0.0522</td>
<td>-0.0403</td>
<td>0.0037</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-01</th>
<td>-0.0013</td>
<td>0.0147</td>
<td>0.0376</td>
<td>0.0143</td>
<td>0.0068</td>
<td>0.0030</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="fix-famafrench-dates-shift-one-month-backward-to-align-with-regimes_df" class="level4">
<h4 class="anchored" data-anchor-id="fix-famafrench-dates-shift-one-month-backward-to-align-with-regimes_df">Fix Fama–French dates (shift one month backward) to align with <code>regimes_df</code></h4>
<div id="a9d15ae6-9f1a-471e-8136-4ddad6d81c66" class="cell" data-execution_count="355">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix Fama–French dates (shift one month backward)</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>ff_adj <span class="op">=</span> ff_factors.copy()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">### Actual Fama-French Convention:</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Label          Contains Returns FOR</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2020-03-01  →  March 2020 (Mar 1 - Mar 31)</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2020-04-01  →  April 2020 (Apr 1 - Apr 30)</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2020-05-01  →  May 2020 (May 1 - May 31)</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>ff_adj.index <span class="op">=</span> ff_adj.index.to_period(<span class="st">"M"</span>).to_timestamp(<span class="st">"M"</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>ff_adj.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="355">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0067</td>
<td>0.0208</td>
<td>0.0038</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>0.0196</td>
<td>-0.0131</td>
<td>-0.0309</td>
<td>-0.0522</td>
<td>-0.0403</td>
<td>0.0037</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>-0.0013</td>
<td>0.0147</td>
<td>0.0376</td>
<td>0.0143</td>
<td>0.0068</td>
<td>0.0030</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="join-regimes_df-with-famafrench-factors" class="level4">
<h4 class="anchored" data-anchor-id="join-regimes_df-with-famafrench-factors">Join regimes_df with Fama–French factors</h4>
<div id="bfc54de2-549c-41b7-a2dd-b1ce8c5a364a" class="cell" data-execution_count="356">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure regimes are month-end</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> regimes_df.copy()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>reg.index <span class="op">=</span> reg.index.to_period(<span class="st">"M"</span>).to_timestamp(<span class="st">"M"</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Join on month-end date</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> reg.join(ff_adj, how<span class="op">=</span><span class="st">"inner"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6aed8a4b-ff9d-4ab3-b3ba-7aa6dedaf720" class="cell" data-execution_count="357">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>combined.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="357">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">p_state_2</th>
<th data-quarto-table-cell-role="th">state_label</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>-1.384971</td>
<td>2</td>
<td>1.763643e-10</td>
<td>3.461616e-08</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0161</td>
<td>-0.0320</td>
<td>0.0144</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-1.481025</td>
<td>2</td>
<td>4.213931e-09</td>
<td>1.477532e-08</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-1.480004</td>
<td>2</td>
<td>1.745053e-07</td>
<td>1.492070e-08</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0067</td>
<td>0.0208</td>
<td>0.0038</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-1.248705</td>
<td>2</td>
<td>7.336618e-06</td>
<td>1.134537e-07</td>
<td>0.999993</td>
<td>Tight</td>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>-1.620391</td>
<td>2</td>
<td>2.921088e-04</td>
<td>2.068795e-07</td>
<td>0.999708</td>
<td>Tight</td>
<td>-0.0013</td>
<td>0.0147</td>
<td>0.0376</td>
<td>0.0143</td>
<td>0.0068</td>
<td>0.0030</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="factor-returns-by-liquidity-regime" class="level3">
<h3 class="anchored" data-anchor-id="factor-returns-by-liquidity-regime">Factor returns by liquidity regime</h3>
<div id="9285b97b-2bde-47bb-8551-1a7aad334054" class="cell" data-execution_count="164">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_factor_statistics_by_regime_accurate(df, factor_cols, regime_col<span class="op">=</span><span class="st">'state_label_lag1'</span>, </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                                                   regime_order<span class="op">=</span>[<span class="st">'High'</span>, <span class="st">'Neutral'</span>, <span class="st">'Tight'</span>]):</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate comprehensive factor statistics by regime with accurate annualization.</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses geometric compounding for returns and proper volatility scaling.</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with monthly factor returns and regime labels</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">    factor_cols : list</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">        List of factor column names</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">    regime_col : str</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Column name for regime labels</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">    regime_order : list</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Order of regimes for display</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with all statistics</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate statistics by regime</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {}</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> regime <span class="kw">not</span> <span class="kw">in</span> df[regime_col].unique():</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        regime_data <span class="op">=</span> df[df[regime_col] <span class="op">==</span> regime][factor_cols]</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>        stats[regime] <span class="op">=</span> {</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean'</span>: regime_data.mean(),</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std'</span>: regime_data.std(),</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sharpe'</span>: regime_data.mean() <span class="op">/</span> regime_data.std(),</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_months'</span>: <span class="bu">len</span>(regime_data),</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">'data'</span>: regime_data  <span class="co"># Store for geometric calculation</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build results dataframe</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> factor <span class="kw">in</span> factor_cols:</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> {<span class="st">'Factor'</span>: factor.upper()}</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> regime <span class="kw">in</span> stats:</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Monthly statistics (as percentages)</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>                monthly_mean <span class="op">=</span> stats[regime][<span class="st">'mean'</span>][factor]</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>                monthly_std <span class="op">=</span> stats[regime][<span class="st">'std'</span>][factor]</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>                monthly_sharpe <span class="op">=</span> stats[regime][<span class="st">'sharpe'</span>][factor]</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>                row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_mean'</span>] <span class="op">=</span> monthly_mean <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>                row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_std'</span>] <span class="op">=</span> monthly_std <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>                row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_sharpe'</span>] <span class="op">=</span> monthly_sharpe</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>                <span class="co"># ACCURATE ANNUALIZATION</span></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 1. Annualized return using geometric compounding</span></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Formula: (1 + r_m)^12 - 1</span></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>                ann_return <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> monthly_mean)<span class="op">**</span><span class="dv">12</span> <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 2. Annualized volatility</span></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Under IID assumption: σ_annual = σ_monthly * sqrt(12)</span></span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>                ann_std <span class="op">=</span> monthly_std <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 3. Annualized Sharpe ratio (two methods - should be equivalent)</span></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Method 1: Scale monthly Sharpe by sqrt(12)</span></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>                ann_sharpe_method1 <span class="op">=</span> monthly_sharpe <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Method 2: Direct calculation from annualized values</span></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>                ann_sharpe_method2 <span class="op">=</span> ann_return <span class="op">/</span> ann_std <span class="cf">if</span> ann_std <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Store annualized values</span></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>                row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_mean_ann'</span>] <span class="op">=</span> ann_return <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>                row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_std_ann'</span>] <span class="op">=</span> ann_std <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>                row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_sharpe_ann'</span>] <span class="op">=</span> ann_sharpe_method1  <span class="co"># Using standard method</span></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Optional: Store geometric return for verification</span></span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>                <span class="co"># This calculates actual cumulative return over the period</span></span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>                actual_returns <span class="op">=</span> stats[regime][<span class="st">'data'</span>][factor].values</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>                cumulative_return <span class="op">=</span> np.prod(<span class="dv">1</span> <span class="op">+</span> actual_returns) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>                n_years <span class="op">=</span> <span class="bu">len</span>(actual_returns) <span class="op">/</span> <span class="dv">12</span></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> n_years <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>                    geometric_annual <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> cumulative_return)<span class="op">**</span>(<span class="dv">1</span><span class="op">/</span>n_years) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>                    row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_geom_ann'</span>] <span class="op">=</span> geometric_annual <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>        results.append(row)</span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_formatted_table_accurate(stats_df, regime_order<span class="op">=</span>[<span class="st">'High'</span>, <span class="st">'Tight'</span>], show_geometric<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a><span class="co">    Print a beautifully formatted table with accurate annualization.</span></span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">90</span>)</span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"FACTOR RETURNS BY REGIME (Monthly)"</span>)</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">90</span>)</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Header</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">''</span><span class="sc">:6}</span><span class="ss">"</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Mean Return'</span><span class="sc">:&gt;24}</span><span class="ss">  </span><span class="sc">{</span><span class="st">'Std Dev'</span><span class="sc">:&gt;24}</span><span class="ss">  </span><span class="sc">{</span><span class="st">'Sharpe Ratio'</span><span class="sc">:&gt;24}</span><span class="ss">"</span>)</span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Factor'</span><span class="sc">:6}</span><span class="ss">"</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>regime<span class="sc">:&gt;11}</span><span class="ss"> "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">" "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>regime<span class="sc">:&gt;11}</span><span class="ss"> "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">" "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>regime<span class="sc">:&gt;11}</span><span class="ss"> "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">90</span>)</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data rows</span></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> stats_df.iterrows():</span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>        factor <span class="op">=</span> row[<span class="st">'Factor'</span>]</span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">:6}</span><span class="ss">"</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mean returns</span></span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_mean'</span>]</span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>val<span class="sc">:10.2f}</span><span class="ss">% "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">" "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Std dev</span></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_std'</span>]</span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>val<span class="sc">:10.2f}</span><span class="ss">% "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">" "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sharpe</span></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_sharpe'</span>]</span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>val<span class="sc">:11.3f}</span><span class="ss"> "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>()</span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annualized section</span></span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Annualized (geometric compounding: (1+r_m)^12-1; volatility: σ_m*√12)"</span>)</span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">90</span>)</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> stats_df.iterrows():</span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a>        factor <span class="op">=</span> row[<span class="st">'Factor'</span>]</span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">:6}</span><span class="ss">"</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Annualized mean returns</span></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_mean_ann'</span>]</span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>val<span class="sc">:10.1f}</span><span class="ss">% "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">" "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Annualized std dev</span></span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_std_ann'</span>]</span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>val<span class="sc">:10.1f}</span><span class="ss">% "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">" "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Annualized Sharpe</span></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_sharpe_ann'</span>]</span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>val<span class="sc">:11.3f}</span><span class="ss"> "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>()</span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: Show geometric returns based on actual cumulative performance</span></span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_geometric:</span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>()</span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Geometric Annual Returns (from actual cumulative performance)"</span>)</span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">90</span>)</span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> stats_df.iterrows():</span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>            factor <span class="op">=</span> row[<span class="st">'Factor'</span>]</span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>factor<span class="sc">:6}</span><span class="ss">"</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> regime <span class="kw">in</span> regime_order:</span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_geom_ann'</span> <span class="kw">in</span> row:</span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a>                    val <span class="op">=</span> row[<span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">_geom_ann'</span>]</span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>val<span class="sc">:10.1f}</span><span class="ss">% "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'N/A'</span><span class="sc">:&gt;11}</span><span class="ss"> "</span>, end<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>()</span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">90</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="eca12a49-72b7-40c6-bcfb-9e969d52c860" class="cell" data-execution_count="267">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> combined.copy()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Regime at t (end-of-month) predicting factor returns at t+1</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>df2[<span class="st">"state_label_lag1"</span>] <span class="op">=</span> df2[<span class="st">"state_label"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop first row (no lag)</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> df2.dropna(subset<span class="op">=</span>[<span class="st">"state_label_lag1"</span>, <span class="st">"mkt_excess"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>])</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Define factors</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>factor_cols <span class="op">=</span> [<span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate statistics with ACCURATE annualization</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>stats_df <span class="op">=</span> calculate_factor_statistics_by_regime_accurate(</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    df2, </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    factor_cols, </span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    regime_col<span class="op">=</span><span class="st">'state_label_lag1'</span>,</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    regime_order<span class="op">=</span>[<span class="st">'High'</span>, <span class="st">'Neutral'</span>, <span class="st">'Tight'</span>]</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Print formatted table (like your image but with accurate formulas)</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>print_formatted_table_accurate(stats_df, regime_order<span class="op">=</span>[<span class="st">'High'</span>, <span class="st">'Tight'</span>], show_geometric<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
==========================================================================================
FACTOR RETURNS BY REGIME (Monthly)
==========================================================================================
                   Mean Return                   Std Dev              Sharpe Ratio
Factor       High       Tight         High       Tight         High       Tight 
------------------------------------------------------------------------------------------
MKT_EXCESS      1.85%       0.74%        6.96%       4.00%        0.266       0.185 
HML        -1.75%      -0.53%        4.97%       2.94%       -0.352      -0.179 
RMW         0.29%       0.03%        1.76%       1.58%        0.164       0.019 
CMA        -0.28%      -0.35%        1.86%       1.79%       -0.150      -0.197 

Annualized (geometric compounding: (1+r_m)^12-1; volatility: σ_m*√12)
------------------------------------------------------------------------------------------
MKT_EXCESS      24.6%        9.3%        24.1%       13.9%        0.921       0.642 
HML        -19.1%       -6.1%        17.2%       10.2%       -1.220      -0.620 
RMW          3.5%        0.4%         6.1%        5.5%        0.569       0.064 
CMA         -3.3%       -4.1%         6.4%        6.2%       -0.518      -0.681 

Geometric Annual Returns (from actual cumulative performance)
------------------------------------------------------------------------------------------
MKT_EXCESS      21.3%        8.2% 
HML        -20.2%       -6.6% 
RMW          3.4%        0.2% 
CMA         -3.5%       -4.3% 
==========================================================================================
</code></pre>
</div>
</div>
</section>
<section id="whats-going-on" class="level3">
<h3 class="anchored" data-anchor-id="whats-going-on">What’s going on ?</h3>
<p>This is reverse of what you’d expect. In a tight liquidity regime, <span class="math inline">\(R^{smb}\)</span> and <span class="math inline">\(R^{hml}\)</span> should be deeply positive. You’d expect small under-valued companies to outperform big companies with premium valuation.</p>
<p>Let’s go back to the <span class="math inline">\(L_t\)</span> and understand what’s going on</p>
<div id="49eeeef1-963e-407b-b56e-43e06199e348" class="cell" data-execution_count="335">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1: Time series with regimes</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>L_t.index,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>L_t.values,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span>regimes_df[<span class="st">"state"</span>],</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"green"</span>, <span class="dv">1</span>: <span class="st">"orange"</span>, <span class="dv">2</span>: <span class="st">"red"</span>},</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax[<span class="dv">0</span>],</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span><span class="dv">15</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Liquidity Index L(t) with HMM States"</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">"L(t)"</span>)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2: KDE (distribution) by state</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>regimes_df,</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"L"</span>,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"state"</span>,</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"green"</span>, <span class="dv">1</span>: <span class="st">"orange"</span>, <span class="dv">2</span>: <span class="st">"red"</span>},</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax[<span class="dv">1</span>]</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Distribution of L(t) by HMM State"</span>)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">"L(t)"</span>)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="98ff7b1f-65d6-4a34-bb33-f406a65ec9b8" class="cell" data-execution_count="94">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>means <span class="op">=</span> pd.Series(model.means_.flatten(), index<span class="op">=</span><span class="bu">range</span>(n_states))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>var_covar <span class="op">=</span> pd.Series(model._covars_.flatten(), index<span class="op">=</span><span class="bu">range</span>(n_states))</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>model_df <span class="op">=</span> pd.DataFrame({<span class="st">'means'</span>: means, <span class="st">'var'</span>: var_covar})</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>model_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">means</th>
<th data-quarto-table-cell-role="th">var</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2.689160</td>
<td>3.067263</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0.378674</td>
<td>0.112808</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>-0.860576</td>
<td>0.190807</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>From the KDE (bottom panel):</p>
<ul>
<li>States 2 (red) and 1 (yellow) heavily overlap</li>
<li>Only state 0 (green) is clearly separated — the “high liquidity spike”</li>
<li>This corresponds to crisis/QE events (2008, 2020), where liquidity jumps dramatically</li>
</ul>
<p>So the natural clustering is:</p>
<ul>
<li>One large cluster (normal-tight-neutral combined)</li>
<li>One <strong>rare extreme spike cluster</strong></li>
</ul>
<p>My HMM is being forced to split the unimodal bulk distribution into two states, resulting in:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>means <span class="op">=</span> pd.Series(model.means_.flatten(), index<span class="op">=</span><span class="bu">range</span>(n_states))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>means</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>   <span class="op">-</span><span class="fl">0.159797</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>   <span class="op">-</span><span class="fl">0.105787</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>    <span class="fl">2.717670</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>dtype: float64</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>I initially thought alpha=0.5 in SparsePCA might be the cause. But the plot shows:</p>
<ul>
<li>L(t) has a healthy dynamic range across time (≈ −2.5 to +12)</li>
<li>The high liquidity cluster is clear and <strong>RARE</strong></li>
<li>The rest of L(t) is genuinely one blob</li>
</ul>
<p>If Sparse PCA was “overshrinking,” L(t) would be compressed; but it is not.</p>
</section>
<section id="question-is-why-high-liquidity-is-rare-look-at-the-kde-of-gree-state-0" class="level3">
<h3 class="anchored" data-anchor-id="question-is-why-high-liquidity-is-rare-look-at-the-kde-of-gree-state-0">Question is why high liquidity is rare (look at the KDE of gree state 0) ?</h3>
<ul>
<li>Is Liquidity is fundamentally spiky ?</li>
<li>Why ?</li>
<li>Am I defining Liquidity incorrectly ?</li>
</ul>
<p>Fed/Treasury continuously debased currency throughout 2008-2019 period. Liquidity injection (bailing out banks during GFC/2008, ZIRP era, M2 stimulius of 2019 are visible ones). How would I capture this events as proxy of “liquidity” ?</p>
<hr>
<blockquote class="blockquote">
<p>Right now your <span class="math inline">\(L_t\)</span> is basically a <strong>short-horizon “flow” liquidity shock index</strong>.</p>
</blockquote>
<blockquote class="blockquote">
<p>Whereas I’m looking for slow, structural debasement / regime of easy money (2008–2019, QE, ZIRP, etc.).</p>
</blockquote>
<blockquote class="blockquote">
<p>Those are not the same object.</p>
</blockquote>
<p>Because I use 1-month growth rates <span class="math inline">\(\Delta \log(\cdot)\)</span>, my index reacts to spikes / changes, not the level of the monetary stock.</p>
<p>I need to factor in more factors to the liquidity index such as -</p>
<ul>
<li><strong>Level of money / balance sheet relative to trend</strong> / GDP, not just monthly change</li>
<li><strong>Prolonged ZIRP</strong> / negative real rate period</li>
<li><strong>Excess liquidity</strong> over economic activity</li>
</ul>
<section id="liquidity-vector-augmentation-two-layer-liquidity-flow-vs-stock-excess" class="level4">
<h4 class="anchored" data-anchor-id="liquidity-vector-augmentation-two-layer-liquidity-flow-vs-stock-excess">Liquidity Vector Augmentation: Two-layer liquidity: Flow vs Stock / Excess</h4>
</section>
<section id="add-level-excess-variables" class="level4">
<h4 class="anchored" data-anchor-id="add-level-excess-variables">Add level / excess variables</h4>
<p>Examples (all can be pulled from FRED):</p>
<p><strong>Log level vs pre-2008 trend</strong></p>
<p>Let <span class="math inline">\(m_t = \log M2_t\)</span>. Fit a linear trend on a pre-QE baseline (say 1985–2007):</p>
<p><span class="math inline">\(m_t \approx a + bt \quad (t \le 2007)\)</span></p>
<p>Then define excess money stock:</p>
<p><span class="math inline">\(EM_t = m_t - (a + bt)\)</span></p>
<p>After 2008, <span class="math inline">\(EM_t\)</span> becomes increasingly positive if M2 grows above its historical trend.</p>
<p>Similarly for the Fed Balance Sheet, let <span class="math inline">\(b_t = \log(\text{FedBal}_t)\)</span>:</p>
<p><span class="math inline">\(EB_t = b_t - (\alpha + \beta t)\)</span> (pre-2007 trend)</p>
<hr>
<p><strong>Excess liquidity versus real economy</strong></p>
<p>Use real GDP series (e.g., GDPC1) and define:</p>
<p><span class="math inline">\(EL_t = \log M2_t - \log GDP_t\)</span></p>
<p>Or measure multi-year excess growth:</p>
<p><span class="math inline">\(EL_t(3y) = \log M2_t - \log M2_{t-36} - (\log GDP_t - \log GDP_{t-36})\)</span></p>
<hr>
<p><strong>ZIRP / negative real-rate indicator</strong></p>
<p><span class="math inline">\(D_t^{ZIRP} = 1(r_t^{real} &lt; 0)\)</span></p>
<p>From 2009–2015, this should be mostly 1.</p>
<hr>
</section>
<section id="build-an-augmented-feature-vector" class="level4">
<h4 class="anchored" data-anchor-id="build-an-augmented-feature-vector">Build an augmented feature vector</h4>
<p>Instead of only:</p>
<p><span class="math inline">\(x_t = \{ \Delta \log M2_t,\; \Delta \log FedBal_t,\; TS_t,\; r_t^{real},\; CS_t \}\)</span></p>
<p>Let’s expand to:</p>
<p><span class="math inline">\(x_t^{aug} = \{
\Delta \log M2_t,\;
\Delta \log FedBal_t,\;
TS_t,\;
r_t^{real},\;
CS_t,\;
EM_t,\;
EB_t,\;
EL_t,\;
EL_t(3y),\;
D_t^{ZIRP}
\}\)</span></p>
<p>Then standardize and perform PCA / SparsePCA on this.</p>
<ul>
<li><strong>PC1</strong> (or a combination) loading heavily on <span class="math inline">\(EM\)</span>, <span class="math inline">\(EB\)</span>, <span class="math inline">\(EL\)</span>, <span class="math inline">\(D_t^{ZIRP}\)</span> → structural easy-money regime<br>
</li>
<li><strong>PC2</strong> (or your current PC1) loading on short-horizon changes → flow / shock liquidity</li>
</ul>
<div id="8cb1e9bb-aab5-4ba2-883a-07fcb826d355" class="cell" data-execution_count="208">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>macro_raw.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="208">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2SL</th>
<th data-quarto-table-cell-role="th">FED_BAL</th>
<th data-quarto-table-cell-role="th">TB3M</th>
<th data-quarto-table-cell-role="th">DGS10</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">GDP</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>22108.3</td>
<td>6603384.0</td>
<td>4.12</td>
<td>4.23</td>
<td>6.00</td>
<td>5.35</td>
<td>323.364</td>
<td>30485.729</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.4</td>
<td>6608395.0</td>
<td>3.92</td>
<td>4.16</td>
<td>5.83</td>
<td>5.21</td>
<td>324.368</td>
<td>31095.089</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>22298.0</td>
<td>6587034.0</td>
<td>3.82</td>
<td>4.11</td>
<td>5.74</td>
<td>5.13</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>22322.4</td>
<td>6552419.0</td>
<td>3.78</td>
<td>4.02</td>
<td>5.86</td>
<td>5.26</td>
<td>325.031</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-12-31</th>
<td>NaN</td>
<td>6640618.0</td>
<td>3.59</td>
<td>4.18</td>
<td>5.90</td>
<td>5.31</td>
<td>326.030</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="da853d89-fec4-48e9-b33c-ad4a0e68f3a0" class="cell" data-execution_count="210">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Start from the original GDP values only (drop NaNs)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>gdp_series <span class="op">=</span> macro_raw[<span class="st">"GDP"</span>].dropna()</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Collapse to unique quarter-end values</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co">#    - If GDP is timestamped at quarter *start* (e.g. 2025-04-01),</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">#      this will move it to the quarter end (2025-06-30) and give unique labels.</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>gdp_q <span class="op">=</span> gdp_series.resample(<span class="st">"Q"</span>).last()   <span class="co"># quarterly, at quarter-end (e.g. 2025-03-31, 2025-06-30, ...)</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Downsample to monthly and forward-fill within the quarter</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>gdp_m <span class="op">=</span> gdp_q.resample(<span class="st">"M"</span>).ffill()</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Assign back into macro_raw, aligning on the monthly index</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>macro_raw[<span class="st">"GDP"</span>] <span class="op">=</span> gdp_m</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>macro_raw.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="210">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2SL</th>
<th data-quarto-table-cell-role="th">FED_BAL</th>
<th data-quarto-table-cell-role="th">TB3M</th>
<th data-quarto-table-cell-role="th">DGS10</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">GDP</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>22108.3</td>
<td>6603384.0</td>
<td>4.12</td>
<td>4.23</td>
<td>6.00</td>
<td>5.35</td>
<td>323.364</td>
<td>30485.729</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.4</td>
<td>6608395.0</td>
<td>3.92</td>
<td>4.16</td>
<td>5.83</td>
<td>5.21</td>
<td>324.368</td>
<td>31095.089</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>22298.0</td>
<td>6587034.0</td>
<td>3.82</td>
<td>4.11</td>
<td>5.74</td>
<td>5.13</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>22322.4</td>
<td>6552419.0</td>
<td>3.78</td>
<td>4.02</td>
<td>5.86</td>
<td>5.26</td>
<td>325.031</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-12-31</th>
<td>NaN</td>
<td>6640618.0</td>
<td>3.59</td>
<td>4.18</td>
<td>5.90</td>
<td>5.31</td>
<td>326.030</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="b2f4cea5-c7ba-496e-aaa7-63b96b91d2f2" class="cell" data-execution_count="244">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_liquidity_proxies_augmented(macro_df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> macro_df.copy()</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Flow proxies</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dlog_M2"</span>]       <span class="op">=</span> np.log(df[<span class="st">"M2SL"</span>]).diff()</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dlog_FED_BAL"</span>]  <span class="op">=</span> np.log(df[<span class="st">"FED_BAL"</span>]).diff()</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"term_spread"</span>]   <span class="op">=</span> df[<span class="st">"DGS10"</span>] <span class="op">-</span> df[<span class="st">"TB3M"</span>]</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"infl_yoy"</span>]      <span class="op">=</span> np.log(df[<span class="st">"CPI"</span>]).diff(<span class="dv">12</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"real_rate"</span>]     <span class="op">=</span> df[<span class="st">"TB3M"</span>] <span class="op">-</span> <span class="dv">100</span> <span class="op">*</span> df[<span class="st">"infl_yoy"</span>]</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"credit_spread"</span>] <span class="op">=</span> df[<span class="st">"BAA"</span>] <span class="op">-</span> df[<span class="st">"AAA"</span>]</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Levels</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_M2"</span>]      <span class="op">=</span> np.log(df[<span class="st">"M2SL"</span>])</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_FED_BAL"</span>] <span class="op">=</span> np.log(df[<span class="st">"FED_BAL"</span>])</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use data up to 2007-12-31 to fit trends</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    pre <span class="op">=</span> df.loc[: <span class="st">"2007-12-31"</span>].copy()</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Trend for M2 ---</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    pre_m2 <span class="op">=</span> pre[<span class="st">"log_M2"</span>].dropna()</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    t_m2   <span class="op">=</span> np.arange(<span class="bu">len</span>(pre_m2))</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    coefs_M2 <span class="op">=</span> np.polyfit(t_m2, pre_m2.values, deg<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    t_full <span class="op">=</span> np.arange(<span class="bu">len</span>(df))</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    trend_M2 <span class="op">=</span> np.polyval(coefs_M2, t_full)</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"EM"</span>] <span class="op">=</span> df[<span class="st">"log_M2"</span>] <span class="op">-</span> trend_M2</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Trend for Fed balance sheet ---</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>    pre_fb <span class="op">=</span> pre[<span class="st">"log_FED_BAL"</span>].dropna()</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    t_fb   <span class="op">=</span> np.arange(<span class="bu">len</span>(pre_fb))</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    coefs_FB <span class="op">=</span> np.polyfit(t_fb, pre_fb.values, deg<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    trend_FB <span class="op">=</span> np.polyval(coefs_FB, t_full)</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"EB"</span>] <span class="op">=</span> df[<span class="st">"log_FED_BAL"</span>] <span class="op">-</span> trend_FB</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Excess liquidity vs GDP over 3y</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_GDP"</span>] <span class="op">=</span> np.log(df[<span class="st">"GDP"</span>])</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"EL_3y"</span>] <span class="op">=</span> (df[<span class="st">"log_M2"</span>] <span class="op">-</span> df[<span class="st">"log_M2"</span>].shift(<span class="dv">36</span>)) <span class="op">-</span> <span class="op">\</span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>                  (df[<span class="st">"log_GDP"</span>] <span class="op">-</span> df[<span class="st">"log_GDP"</span>].shift(<span class="dv">36</span>))</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. ZIRP dummy</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ZIRP_dummy"</span>] <span class="op">=</span> (df[<span class="st">"real_rate"</span>] <span class="op">&lt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Build augmented proxy matrix</span></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>    cols_aug <span class="op">=</span> [</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dlog_M2"</span>, <span class="st">"dlog_FED_BAL"</span>, <span class="st">"term_spread"</span>, <span class="st">"real_rate"</span>, <span class="st">"credit_spread"</span>,</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"EM"</span>, <span class="st">"EB"</span>, <span class="st">"EL_3y"</span>, <span class="st">"ZIRP_dummy"</span></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[cols_aug].dropna()</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>liquidity_proxies_aug <span class="op">=</span> build_liquidity_proxies_augmented(macro_raw)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6f01b5d3-29be-4590-b669-b4477759ff06" class="cell" data-execution_count="245">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>liquidity_proxies_aug.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="245">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dlog_M2</th>
<th data-quarto-table-cell-role="th">dlog_FED_BAL</th>
<th data-quarto-table-cell-role="th">term_spread</th>
<th data-quarto-table-cell-role="th">real_rate</th>
<th data-quarto-table-cell-role="th">credit_spread</th>
<th data-quarto-table-cell-role="th">EM</th>
<th data-quarto-table-cell-role="th">EB</th>
<th data-quarto-table-cell-role="th">EL_3y</th>
<th data-quarto-table-cell-role="th">ZIRP_dummy</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>0.002610</td>
<td>-0.005385</td>
<td>0.16</td>
<td>1.901852</td>
<td>0.75</td>
<td>0.196762</td>
<td>0.724600</td>
<td>-0.167473</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>0.005255</td>
<td>-0.001656</td>
<td>0.01</td>
<td>1.592409</td>
<td>0.69</td>
<td>0.197696</td>
<td>0.719428</td>
<td>-0.150763</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>0.003921</td>
<td>-0.002950</td>
<td>0.12</td>
<td>1.554846</td>
<td>0.65</td>
<td>0.197296</td>
<td>0.712962</td>
<td>-0.146787</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>0.003607</td>
<td>-0.005918</td>
<td>0.11</td>
<td>1.223147</td>
<td>0.65</td>
<td>0.196583</td>
<td>0.703528</td>
<td>-0.141566</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>0.004698</td>
<td>0.000759</td>
<td>0.24</td>
<td>0.942084</td>
<td>0.62</td>
<td>0.196960</td>
<td>0.700771</td>
<td>-0.134480</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="7b90e8e2-7be4-4910-aabb-35b163254685" class="cell" data-execution_count="336">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>z1_t <span class="op">=</span> standardize_and_signflip(liquidity_proxies_aug)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>L1_t <span class="op">=</span> build_sparse_pca_liquidity_index(z1_t, alpha<span class="op">=</span><span class="fl">0.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SparsePCA components (loadings):
  dlog_M2: +0.135
  dlog_FED_BAL: +0.166
  term_spread: +0.406
  real_rate: +0.508
  credit_spread: -0.067
  EM: +0.077
  EB: +0.101
  EL_3y: +0.518
  ZIRP_dummy: +0.491

Top 3 variables by absolute loading:
  EL_3y: loading=+0.518, corr=+0.886, weighted=+0.460
  real_rate: loading=+0.508, corr=+0.870, weighted=+0.442
  ZIRP_dummy: loading=+0.491, corr=+0.841, weighted=+0.413

Weighted average correlation: +0.866
✅ Sign correct: L_t weighted correlation positive</code></pre>
</div>
</div>
<div id="3e63886f-768b-4d7a-92ac-8d1019441466" class="cell" data-execution_count="337">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>n_states<span class="op">=</span><span class="dv">2</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>model, regimes_aug_df <span class="op">=</span> fit_hmm_on_liquidity(L1_t,n_states<span class="op">=</span>n_states)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>HMM state means (unsorted, in fitted scale):
  state 0: mean L = 0.501
  state 1: mean L = -1.516</code></pre>
</div>
</div>
</section>
<section id="retrospective-validation" class="level4">
<h4 class="anchored" data-anchor-id="retrospective-validation">Retrospective Validation</h4>
<div id="ca096fce-b65a-4acd-96be-cda3f7158e2c" class="cell" data-execution_count="312">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>summary_aug <span class="op">=</span> calculate_regime_summary(regimes_aug_df, L1_t)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary_aug)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Regime  Mean L(t)   Std Dev  Months    Percent
0   High   0.859600  0.900571     205  75.091575
1  Tight  -2.591442  0.597277      68  24.908425</code></pre>
</div>
</div>
<div id="cfcf1eb4-3c71-40cd-80c6-3940fc0cf722" class="cell" data-execution_count="358">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure regimes are month-end</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> regimes_aug_df.copy()</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>reg.index <span class="op">=</span> reg.index.to_period(<span class="st">"M"</span>).to_timestamp(<span class="st">"M"</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Join on month-end date</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>combined_aug <span class="op">=</span> reg.join(ff_adj, how<span class="op">=</span><span class="st">"inner"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="current-combined_aug-structure-check" class="level4">
<h4 class="anchored" data-anchor-id="current-combined_aug-structure-check">Current combined_aug structure check</h4>
<div id="a084c686-9e1d-4e99-a463-da5b8c4de515" class="cell" data-execution_count="359">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DETAILED DATE ALIGNMENT CHECK: COVID Period (Feb-May 2020)"</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Show window around COVID crash</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>covid_window <span class="op">=</span> [<span class="st">'2020-01-31'</span>, <span class="st">'2020-02-29'</span>, <span class="st">'2020-03-31'</span>, <span class="st">'2020-04-30'</span>, <span class="st">'2020-05-31'</span>]</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Date         | MKT_EXCESS | HML    | Regime      | What Should This Be?"</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> date <span class="kw">in</span> covid_window:</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> date <span class="kw">in</span> combined_aug.index:</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> combined_aug.loc[date]</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>        mkt <span class="op">=</span> row[<span class="st">'mkt_excess'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>        hml <span class="op">=</span> row[<span class="st">'hml'</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>        regime <span class="op">=</span> row.get(<span class="st">'regime_3state'</span>, row.get(<span class="st">'state_label'</span>, <span class="st">'Unknown'</span>))</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Expected values</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>        expected <span class="op">=</span> {</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">'2020-01-31'</span>: (<span class="st">'Jan: Normal'</span>,          <span class="op">-</span><span class="fl">0.16</span>),</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">'2020-02-29'</span>: (<span class="st">'Feb: Start of fear'</span>,   <span class="op">-</span><span class="fl">8.23</span>),</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">'2020-03-31'</span>: (<span class="st">'Mar: CRASH'</span>,          <span class="op">-</span><span class="fl">12.35</span>),</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">'2020-04-30'</span>: (<span class="st">'Apr: Recovery'</span>,       <span class="op">+</span><span class="fl">12.68</span>),</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">'2020-05-31'</span>: (<span class="st">'May: Continued rally'</span>, <span class="op">+</span><span class="fl">4.53</span>),</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>        exp_desc, exp_ret <span class="op">=</span> expected.get(date, (<span class="st">'Unknown'</span>, <span class="dv">0</span>))</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if close to expected</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>        status <span class="op">=</span> <span class="st">"✅"</span> <span class="cf">if</span> <span class="bu">abs</span>(mkt <span class="op">-</span> exp_ret) <span class="op">&lt;</span> <span class="fl">2.0</span> <span class="cf">else</span> <span class="st">"❌"</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss">   | </span><span class="sc">{</span>mkt<span class="sc">:+7.2f}</span><span class="ss">%  | </span><span class="sc">{</span>hml<span class="sc">:+6.2f}</span><span class="ss">% | </span><span class="sc">{</span>regime<span class="sc">:11s}</span><span class="ss"> | </span><span class="sc">{</span>status<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>exp_desc<span class="sc">}</span><span class="ss"> (exp: </span><span class="sc">{</span>exp_ret<span class="sc">:+.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss"> | NOT FOUND IN INDEX"</span>)</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
DETAILED DATE ALIGNMENT CHECK: COVID Period (Feb-May 2020)
================================================================================

--------------------------------------------------------------------------------
Date         | MKT_EXCESS | HML    | Regime      | What Should This Be?
--------------------------------------------------------------------------------
2020-01-31   |   -0.09%  |  -6.22% | High        | ✅ Jan: Normal (exp: -0.16%)
2020-02-29   |   -8.15%  |  -3.82% | High        | ✅ Feb: Start of fear (exp: -8.23%)
2020-03-31   |  -13.35%  | -13.83% | High        | ✅ Mar: CRASH (exp: -12.35%)
2020-04-30   |  +13.58%  |  -1.34% | High        | ✅ Apr: Recovery (exp: +12.68%)
2020-05-31   |   +5.59%  |  -5.00% | High        | ✅ May: Continued rally (exp: +4.53%)
--------------------------------------------------------------------------------</code></pre>
</div>
</div>
<div id="1b5e2880-c0c3-43fa-aa4d-259d7b8ec724" class="cell" data-execution_count="360">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>ax.plot(combined_aug.index, combined_aug[<span class="st">'L'</span>], label<span class="op">=</span><span class="st">'L(t)'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Color by regime</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> combined_aug[<span class="st">'state_label'</span>].<span class="bu">map</span>({<span class="st">'High'</span>: <span class="st">'red'</span>, <span class="st">'Tight'</span>: <span class="st">'green'</span>})</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>ax.scatter(combined_aug.index, combined_aug[<span class="st">'L'</span>], c<span class="op">=</span>colors, s<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Liquidity Index with HMM Regime Colors (Red=High, Green=Tight)'</span>)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1febb9df-189a-447a-a753-2bff3276d728" class="cell" data-execution_count="361">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check factor performance in specific periods we KNOW the regime</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>known_periods <span class="op">=</span> {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2010-2014 (QE era)'</span>: (<span class="st">'2010-01'</span>, <span class="st">'2014-12'</span>),</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2015-2019 (Late cycle)'</span>: (<span class="st">'2015-01'</span>, <span class="st">'2019-12'</span>), </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2020-2021 (COVID QE)'</span>: (<span class="st">'2020-01'</span>, <span class="st">'2021-12'</span>),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2022-2024 (QT/hiking)'</span>: (<span class="st">'2022-01'</span>, <span class="st">'2024-12'</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label, (start, end) <span class="kw">in</span> known_periods.items():</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    period_data <span class="op">=</span> combined_aug.loc[start:end]</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean L: </span><span class="sc">{</span>period_data[<span class="st">'L'</span>]<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Dominant regime: </span><span class="sc">{</span>period_data[<span class="st">'state_label'</span>]<span class="sc">.</span>mode()[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  HML: </span><span class="sc">{</span>period_data[<span class="st">'hml'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  SMB: </span><span class="sc">{</span>period_data[<span class="st">'smb'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
2010-2014 (QE era):
  Mean L: 1.13
  Dominant regime: High
  HML: -0.0005
  SMB: 0.0012

2015-2019 (Late cycle):
  Mean L: -0.15
  Dominant regime: High
  HML: -0.0034
  SMB: -0.0018

2020-2021 (COVID QE):
  Mean L: 1.86
  Dominant regime: High
  HML: -0.0056
  SMB: 0.0023

2022-2024 (QT/hiking):
  Mean L: -1.19
  Dominant regime: Tight
  HML: 0.0033
  SMB: -0.0041</code></pre>
</div>
</div>
<div id="14e56528-0be4-4475-8bca-556d0f7ed575" class="cell" data-execution_count="362">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define factors</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>factors <span class="op">=</span> [<span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>df3 <span class="op">=</span> combined_aug.copy()</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Regime at t (end-of-month) predicting factor returns at t+1</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>df3[<span class="st">"state_label_lag1"</span>] <span class="op">=</span> df3[<span class="st">"state_label"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate statistics with ACCURATE annualization</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>stats_df_aug <span class="op">=</span> calculate_factor_statistics_by_regime_accurate(</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    df3, </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    factor_cols, </span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    regime_col<span class="op">=</span><span class="st">'state_label_lag1'</span>,</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    regime_order<span class="op">=</span>[<span class="st">'High'</span>, <span class="st">'Neutral'</span>, <span class="st">'Tight'</span>]</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Print formatted table (like your image but with accurate formulas)</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>print_formatted_table_accurate(stats_df_aug, regime_order<span class="op">=</span>[<span class="st">'High'</span>, <span class="st">'Tight'</span>], show_geometric<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
==========================================================================================
FACTOR RETURNS BY REGIME (Monthly)
==========================================================================================
                   Mean Return                   Std Dev              Sharpe Ratio
Factor       High       Tight         High       Tight         High       Tight 
------------------------------------------------------------------------------------------
MKT_EXCESS      0.88%       0.89%        4.54%       3.69%        0.193       0.240 
HML         0.06%      -0.29%        3.20%       2.74%        0.018      -0.106 
RMW         0.28%       0.18%        2.08%       1.51%        0.135       0.118 
CMA         0.15%      -0.31%        1.93%       1.73%        0.079      -0.181 

Annualized (geometric compounding: (1+r_m)^12-1; volatility: σ_m*√12)
------------------------------------------------------------------------------------------
MKT_EXCESS      11.1%       11.2%        15.7%       12.8%        0.670       0.831 
HML          0.7%       -3.4%        11.1%        9.5%        0.063      -0.366 
RMW          3.4%        2.2%         7.2%        5.2%        0.466       0.409 
CMA          1.8%       -3.7%         6.7%        6.0%        0.272      -0.628 

Geometric Annual Returns (from actual cumulative performance)
------------------------------------------------------------------------------------------
MKT_EXCESS       9.7%       10.3% 
HML          0.1%       -3.8% 
RMW          3.1%        2.0% 
CMA          1.6%       -3.9% 
==========================================================================================
</code></pre>
</div>
</div>
</section>
<section id="root-cause-crisis-contamination" class="level4">
<h4 class="anchored" data-anchor-id="root-cause-crisis-contamination">Root Cause: Crisis Contamination</h4>
<p>The problem is 2008-2009 and 2020 dominate my “High” regime but have CRISIS-driven factor dynamics, not QE-driven dynamic</p>
<p>liquidity index is working perfectly - it correctly identifies:</p>
<p>2008-2009: Massive liquidity injection (L spikes) 2022-2024: Liquidity withdrawal (L crashes)</p>
<p>BUT during structural shocks (financial crisis, pandemic):</p>
<ul>
<li>Normal factor relationships break down</li>
<li>Flight to quality dominates</li>
<li>Value/defensive assets outperform despite high liquidity</li>
</ul>
<div id="a6ddf467-e096-492c-bbdc-bee138068509" class="cell" data-execution_count="363">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"2010-2014 QE era:"</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>qe_period <span class="op">=</span> combined_3regime.loc[<span class="st">'2010-01'</span>:<span class="st">'2014-12'</span>]</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean L: </span><span class="sc">{</span>qe_period[<span class="st">'L'</span>]<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Regime mode: </span><span class="sc">{</span>qe_period[<span class="st">'regime_3state'</span>]<span class="sc">.</span>mode()[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  HML: </span><span class="sc">{</span>qe_period[<span class="st">'hml'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss"> bps"</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean MKT: </span><span class="sc">{</span>qe_period[<span class="st">'mkt_excess'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss"> bps"</span>)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">2022-2024 QT era:"</span>)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>qt_period <span class="op">=</span> combined_3regime.loc[<span class="st">'2022-01'</span>:<span class="st">'2024-12'</span>]</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean L: </span><span class="sc">{</span>qt_period[<span class="st">'L'</span>]<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Regime mode: </span><span class="sc">{</span>qt_period[<span class="st">'regime_3state'</span>]<span class="sc">.</span>mode()[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  HML: </span><span class="sc">{</span>qt_period[<span class="st">'hml'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss"> bps"</span>)</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean MKT: </span><span class="sc">{</span>qt_period[<span class="st">'mkt_excess'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss"> bps"</span>)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">2008-09 Crisis:"</span>)</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>crisis_period <span class="op">=</span> combined_3regime.loc[<span class="st">'2008-09'</span>:<span class="st">'2009-03'</span>]</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean L: </span><span class="sc">{</span>crisis_period[<span class="st">'L'</span>]<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Regime mode: </span><span class="sc">{</span>crisis_period[<span class="st">'regime_3state'</span>]<span class="sc">.</span>mode()[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  HML: </span><span class="sc">{</span>crisis_period[<span class="st">'hml'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss"> bps"</span>)</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean MKT: </span><span class="sc">{</span>crisis_period[<span class="st">'mkt_excess'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss"> bps"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>2010-2014 QE era:
  Mean L: 1.13
  Regime mode: High
  HML: -0.12 bps
  Mean MKT: 1.30 bps

2022-2024 QT era:
  Mean L: -1.19
  Regime mode: Tight
  HML: 0.02 bps
  Mean MKT: 0.73 bps

2008-09 Crisis:
  Mean L: 1.08
  Regime mode: Crisis
  HML: -2.40 bps
  Mean MKT: -3.17 bps</code></pre>
</div>
</div>
<div id="fff34216-1c17-4c5f-b0ae-3a30f91eeaf4" class="cell" data-execution_count="364">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_factor_returns_by_regime(combined_aug):</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Analyze factor returns DURING each regime (contemporaneous).</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co">    For crisis identification, use date-based approach.</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> combined_aug.copy()</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 1: Classify regimes (no lag!)</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Date-based crisis periods</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    crisis_dates <span class="op">=</span> (</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>        ((df.index <span class="op">&gt;=</span> <span class="st">'2008-09'</span>) <span class="op">&amp;</span> (df.index <span class="op">&lt;=</span> <span class="st">'2009-03'</span>)) <span class="op">|</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>        ((df.index <span class="op">&gt;=</span> <span class="st">'2020-02'</span>) <span class="op">&amp;</span> (df.index <span class="op">&lt;=</span> <span class="st">'2020-04'</span>))</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Liquidity-based classification</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'regime_3state'</span>] <span class="op">=</span> <span class="st">'Tight'</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">'L'</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">'regime_3state'</span>] <span class="op">=</span> <span class="st">'High'</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    df.loc[crisis_dates, <span class="st">'regime_3state'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Regime distribution:"</span>)</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df[<span class="st">'regime_3state'</span>].value_counts())</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 2: Returns DURING each regime</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>    factors <span class="op">=</span> [<span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly returns</span></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>    returns_monthly <span class="op">=</span> df.groupby(<span class="st">'regime_3state'</span>)[factors].agg([<span class="st">'mean'</span>, <span class="st">'std'</span>])</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>    returns_monthly <span class="op">=</span> returns_monthly <span class="op">*</span> <span class="dv">100</span>  <span class="co"># Convert to percentage</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"FACTOR RETURNS DURING EACH REGIME (Monthly %)"</span>)</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> factor <span class="kw">in</span> factors:</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>factor<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Crisis'</span>, <span class="st">'High'</span>, <span class="st">'Tight'</span>]:</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> regime <span class="kw">in</span> returns_monthly.index:</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>                mean <span class="op">=</span> returns_monthly.loc[regime, (factor, <span class="st">'mean'</span>)]</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>                std <span class="op">=</span> returns_monthly.loc[regime, (factor, <span class="st">'std'</span>)]</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>                sharpe <span class="op">=</span> mean <span class="op">/</span> std <span class="cf">if</span> std <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>                n_months <span class="op">=</span> (df[<span class="st">'regime_3state'</span>] <span class="op">==</span> regime).<span class="bu">sum</span>()</span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>regime<span class="sc">:8s}</span><span class="ss">: </span><span class="sc">{</span>mean<span class="sc">:+6.2f}</span><span class="ss">% ± </span><span class="sc">{</span>std<span class="sc">:5.2f}</span><span class="ss">%  (Sharpe: </span><span class="sc">{</span>sharpe<span class="sc">:+.3f}</span><span class="ss">, N=</span><span class="sc">{</span>n_months<span class="sc">}</span><span class="ss"> months)"</span>)</span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 3: Annualized returns</span></span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"ANNUALIZED RETURNS (Geometric)"</span>)</span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> factor <span class="kw">in</span> factors:</span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>factor<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Crisis'</span>, <span class="st">'High'</span>, <span class="st">'Tight'</span>]:</span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> regime <span class="kw">in</span> df[<span class="st">'regime_3state'</span>].unique():</span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a>                regime_data <span class="op">=</span> df[df[<span class="st">'regime_3state'</span>] <span class="op">==</span> regime][factor]</span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Geometric return: (1+r1)*(1+r2)*...*(1+rN) then annualize</span></span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a>                cumulative <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> regime_data).prod()</span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a>                n_months <span class="op">=</span> <span class="bu">len</span>(regime_data)</span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb58-66"><a href="#cb58-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> n_months <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb58-67"><a href="#cb58-67" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Annualize: raise to power of (12/n_months)</span></span>
<span id="cb58-68"><a href="#cb58-68" aria-hidden="true" tabindex="-1"></a>                    annual_return <span class="op">=</span> (cumulative <span class="op">**</span> (<span class="dv">12</span> <span class="op">/</span> n_months) <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb58-69"><a href="#cb58-69" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>regime<span class="sc">:8s}</span><span class="ss">: </span><span class="sc">{</span>annual_return<span class="sc">:+6.2f}</span><span class="ss">%"</span>)</span>
<span id="cb58-70"><a href="#cb58-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-71"><a href="#cb58-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb58-72"><a href="#cb58-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-73"><a href="#cb58-73" aria-hidden="true" tabindex="-1"></a>combined_3regime <span class="op">=</span> analyze_factor_returns_by_regime(combined_aug)</span>
<span id="cb58-74"><a href="#cb58-74" aria-hidden="true" tabindex="-1"></a>combined_3regime</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Regime distribution:
regime_3state
High      167
Tight      98
Crisis      8
Name: count, dtype: int64

================================================================================
FACTOR RETURNS DURING EACH REGIME (Monthly %)
================================================================================

MKT_EXCESS:
  Crisis  :  -9.03% ±  5.43%  (Sharpe: -1.662, N=8 months)
  High    :  +1.33% ±  4.09%  (Sharpe: +0.324, N=167 months)
  Tight   :  +0.95% ±  3.66%  (Sharpe: +0.261, N=98 months)

HML:
  Crisis  :  -4.71% ±  6.18%  (Sharpe: -0.761, N=8 months)
  High    :  +0.25% ±  2.82%  (Sharpe: +0.088, N=167 months)
  Tight   :  -0.13% ±  2.90%  (Sharpe: -0.045, N=98 months)

RMW:
  Crisis  :  +0.97% ±  2.17%  (Sharpe: +0.449, N=8 months)
  High    :  +0.24% ±  2.15%  (Sharpe: +0.110, N=167 months)
  Tight   :  +0.20% ±  1.53%  (Sharpe: +0.131, N=98 months)

CMA:
  Crisis  :  +0.10% ±  1.78%  (Sharpe: +0.058, N=8 months)
  High    :  +0.19% ±  1.99%  (Sharpe: +0.093, N=167 months)
  Tight   :  -0.25% ±  1.68%  (Sharpe: -0.149, N=98 months)

================================================================================
ANNUALIZED RETURNS (Geometric)
================================================================================

MKT_EXCESS:
  Crisis  : -68.47%
  High    : +16.00%
  Tight   : +11.19%

HML:
  Crisis  : -45.16%
  High    :  +2.56%
  Tight   :  -2.06%

RMW:
  Crisis  : +12.08%
  High    :  +2.61%
  Tight   :  +2.28%

CMA:
  Crisis  :  +1.08%
  High    :  +2.02%
  Tight   :  -3.14%</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="364">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">state_label</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
<th data-quarto-table-cell-role="th">regime_3state</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2003-01-31</th>
<td>0.869090</td>
<td>0</td>
<td>1.000000e+00</td>
<td>6.190372e-63</td>
<td>High</td>
<td>-0.0257</td>
<td>0.0071</td>
<td>-0.0079</td>
<td>-0.0093</td>
<td>0.0069</td>
<td>0.0010</td>
<td>High</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2003-02-28</th>
<td>1.041793</td>
<td>0</td>
<td>1.000000e+00</td>
<td>1.286573e-11</td>
<td>High</td>
<td>-0.0188</td>
<td>-0.0087</td>
<td>-0.0136</td>
<td>0.0079</td>
<td>-0.0068</td>
<td>0.0009</td>
<td>High</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2003-03-31</th>
<td>0.957294</td>
<td>0</td>
<td>1.000000e+00</td>
<td>2.965294e-11</td>
<td>High</td>
<td>0.0109</td>
<td>0.0077</td>
<td>-0.0211</td>
<td>0.0168</td>
<td>-0.0081</td>
<td>0.0010</td>
<td>High</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2003-04-30</th>
<td>0.917277</td>
<td>0</td>
<td>1.000000e+00</td>
<td>4.386328e-11</td>
<td>High</td>
<td>0.0818</td>
<td>0.0114</td>
<td>0.0122</td>
<td>-0.0468</td>
<td>0.0098</td>
<td>0.0010</td>
<td>High</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2003-05-31</th>
<td>0.756118</td>
<td>0</td>
<td>1.000000e+00</td>
<td>2.069103e-10</td>
<td>High</td>
<td>0.0605</td>
<td>0.0478</td>
<td>0.0070</td>
<td>-0.0694</td>
<td>0.0307</td>
<td>0.0009</td>
<td>High</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>-2.880509</td>
<td>1</td>
<td>1.340116e-07</td>
<td>9.999999e-01</td>
<td>Tight</td>
<td>0.0606</td>
<td>-0.0072</td>
<td>-0.0288</td>
<td>0.0129</td>
<td>0.0251</td>
<td>0.0038</td>
<td>Tight</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>-2.709857</td>
<td>1</td>
<td>2.610193e-07</td>
<td>9.999997e-01</td>
<td>Tight</td>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0161</td>
<td>-0.0320</td>
<td>0.0144</td>
<td>0.0034</td>
<td>Tight</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-2.689149</td>
<td>1</td>
<td>2.839775e-07</td>
<td>9.999997e-01</td>
<td>Tight</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
<td>Tight</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-2.606319</td>
<td>1</td>
<td>4.195012e-07</td>
<td>9.999996e-01</td>
<td>Tight</td>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0067</td>
<td>0.0208</td>
<td>0.0038</td>
<td>Tight</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-2.418377</td>
<td>1</td>
<td>4.483466e-05</td>
<td>9.999552e-01</td>
<td>Tight</td>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
<td>Tight</td>
</tr>
</tbody>
</table>

<p>273 rows × 12 columns</p>
</div>
</div>
</div>
<div id="5d143e77-602c-4828-8c9e-c673bccfe388" class="cell" data-execution_count="372">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_three_regimes_hmm(combined_aug):</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Use HMM states directly instead of L &gt; 0 threshold.</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> combined_aug.copy()</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crisis indicator (date-based)</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    crisis <span class="op">=</span> (</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>        ((df.index <span class="op">&gt;=</span> <span class="st">'2008-09'</span>) <span class="op">&amp;</span> (df.index <span class="op">&lt;=</span> <span class="st">'2009-03'</span>)) <span class="op">|</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>        ((df.index <span class="op">&gt;=</span> <span class="st">'2020-02'</span>) <span class="op">&amp;</span> (df.index <span class="op">&lt;=</span> <span class="st">'2020-04'</span>))</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use HMM state_label directly</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># State 1 = High (mean = +1.485)</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># State 0 = Tight (mean = -0.305)</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'regime_3state'</span>] <span class="op">=</span> df[<span class="st">'state_label'</span>].copy()</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Override crisis</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    df.loc[crisis, <span class="st">'regime_3state'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>combined_3regime <span class="op">=</span> classify_three_regimes_hmm(combined_aug)</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Factor returns by 3 regimes</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>df_3regime <span class="op">=</span> combined_3regime.copy()</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>df_3regime <span class="op">=</span> df_3regime.dropna(subset<span class="op">=</span>[<span class="st">"regime_3state"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>])</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>means_3regime <span class="op">=</span> (</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>    df_3regime.groupby(<span class="st">"regime_3state"</span>)[[<span class="st">"mkt_excess"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>    .mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Factor Returns by 3 Regimes (monthly %):"</span>)</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(means_3regime)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Factor Returns by 3 Regimes (monthly %):
               mkt_excess       hml       rmw       cma
regime_3state                                          
Crisis          -9.031250 -4.707500  0.975000  0.103750
High             1.190558  0.208934  0.266142  0.135888
Tight            1.184853 -0.182500  0.100147 -0.298235</code></pre>
</div>
</div>
<div id="80aaa6af-cf0e-49e0-8c78-e8f73cd84be8" class="cell" data-execution_count="375">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC: Known period classification</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> diagnose_regime_classification(combined_df):</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Check if known historical periods are correctly classified.</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"REGIME CLASSIFICATION CHECK: Known Historical Periods"</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    known_periods <span class="op">=</span> {</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2010-2014 (QE2/QE3)'</span>: (<span class="st">'2010-01'</span>, <span class="st">'2014-12'</span>, <span class="st">'High'</span>),</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2015-2019 (Late Cycle)'</span>: (<span class="st">'2015-01'</span>, <span class="st">'2019-12'</span>, <span class="st">'High/Mixed'</span>),</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2020-2020 (COVID Crisis)'</span>: (<span class="st">'2020-02'</span>, <span class="st">'2020-04'</span>, <span class="st">'Crisis'</span>),</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2020-2021 (COVID QE)'</span>: (<span class="st">'2020-05'</span>, <span class="st">'2021-12'</span>, <span class="st">'High'</span>),  <span class="co"># Exclude crisis months</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2022-2024 (QT)'</span>: (<span class="st">'2022-03'</span>, <span class="st">'2024-12'</span>, <span class="st">'Tight'</span>),</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label, (start, end, expected) <span class="kw">in</span> known_periods.items():</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>        period_data <span class="op">=</span> combined_df.loc[start:end]</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>        mean_L <span class="op">=</span> period_data[<span class="st">'L'</span>].mean()</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>        mode_regime <span class="op">=</span> period_data[<span class="st">'regime_3state'</span>].mode()[<span class="dv">0</span>]</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>        regime_dist <span class="op">=</span> period_data[<span class="st">'regime_3state'</span>].value_counts()</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Factor returns</span></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>        hml <span class="op">=</span> period_data[<span class="st">'hml'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>        cma <span class="op">=</span> period_data[<span class="st">'cma'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>        mkt <span class="op">=</span> period_data[<span class="st">'mkt_excess'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Mean L: </span><span class="sc">{</span>mean_L<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Classified as: </span><span class="sc">{</span>mode_regime<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Expected: </span><span class="sc">{</span>expected<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Distribution: </span><span class="sc">{</span>regime_dist<span class="sc">.</span>to_dict()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Returns: MKT=</span><span class="sc">{</span>mkt<span class="sc">:+.2f}</span><span class="ss">%, HML=</span><span class="sc">{</span>hml<span class="sc">:+.2f}</span><span class="ss">%, CMA=</span><span class="sc">{</span>cma<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validation</span></span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> expected <span class="op">==</span> <span class="st">'High'</span> <span class="kw">and</span> mode_regime <span class="op">!=</span> <span class="st">'High'</span>:</span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  ⚠️  WARNING: Should be High but classified as </span><span class="sc">{</span>mode_regime<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> expected <span class="op">==</span> <span class="st">'Tight'</span> <span class="kw">and</span> mode_regime <span class="op">!=</span> <span class="st">'Tight'</span>:</span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  ⚠️  WARNING: Should be Tight but classified as </span><span class="sc">{</span>mode_regime<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Run diagnostic</span></span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>diagnose_regime_classification(combined_3regime)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
REGIME CLASSIFICATION CHECK: Known Historical Periods
================================================================================

2010-2014 (QE2/QE3):
  Mean L: +1.13
  Classified as: High
  Expected: High
  Distribution: {'High': 60}
  Returns: MKT=+1.29%, HML=-0.05%, CMA=+0.25%

2015-2019 (Late Cycle):
  Mean L: -0.15
  Classified as: High
  Expected: High/Mixed
  Distribution: {'High': 49, 'Tight': 11}
  Returns: MKT=+0.89%, HML=-0.34%, CMA=-0.22%

2020-2020 (COVID Crisis):
  Mean L: +1.23
  Classified as: Crisis
  Expected: Crisis
  Distribution: {'Crisis': 2, 'High': 1}
  Returns: MKT=-2.64%, HML=-6.33%, CMA=-0.79%

2020-2021 (COVID QE):
  Mean L: +2.07
  Classified as: High
  Expected: High
  Distribution: {'High': 20}
  Returns: MKT=+2.74%, HML=+0.58%, CMA=+0.28%

2022-2024 (QT):
  Mean L: -1.44
  Classified as: Tight
  Expected: Tight
  Distribution: {'Tight': 21, 'High': 13}
  Returns: MKT=+0.76%, HML=-0.12%, CMA=-0.27%</code></pre>
</div>
</div>
<div id="3d485ae0-e001-4552-bdf3-f3ff8879f176" class="cell" data-execution_count="376">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hmmlearn.hmm <span class="im">import</span> GaussianHMM</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> zscore</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hierarchical_hmm_regimes(combined_aug):</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Two-layer HMM for automated regime classification.</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Layer 1: Crisis vs Normal (based on volatility + returns)</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Layer 2: High vs Tight (based on liquidity, within Normal)</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> combined_aug.copy()</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LAYER 1: Crisis Detection HMM</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Features: Returns volatility + absolute returns + liquidity vol</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ret_vol'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">3</span>).std()</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'L_vol'</span>] <span class="op">=</span> df[<span class="st">'L'</span>].rolling(<span class="dv">3</span>).std()</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'abs_ret'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].<span class="bu">abs</span>()</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stack features for crisis detection</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>    X_crisis <span class="op">=</span> df[[<span class="st">'ret_vol'</span>, <span class="st">'abs_ret'</span>, <span class="st">'L_vol'</span>]].dropna()</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>    X_crisis_scaled <span class="op">=</span> zscore(X_crisis, nan_policy<span class="op">=</span><span class="st">'omit'</span>)</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit 2-state HMM (Crisis vs Normal)</span></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>    hmm_crisis <span class="op">=</span> GaussianHMM(</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>        n_components<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>        covariance_type<span class="op">=</span><span class="st">"full"</span>,</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>        n_iter<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a>    hmm_crisis.fit(X_crisis_scaled)</span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict crisis states</span></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>    crisis_states <span class="op">=</span> hmm_crisis.predict(X_crisis_scaled)</span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identify which state is "Crisis" (higher volatility)</span></span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a>    state_vols <span class="op">=</span> []</span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> crisis_states <span class="op">==</span> s</span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a>        state_vols.append(X_crisis.loc[mask, <span class="st">'ret_vol'</span>].mean())</span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a>    crisis_state_id <span class="op">=</span> np.argmax(state_vols)</span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_crisis'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a>    df.loc[X_crisis.index, <span class="st">'is_crisis'</span>] <span class="op">=</span> (crisis_states <span class="op">==</span> crisis_state_id)</span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Layer 1 (Crisis Detection): </span><span class="sc">{</span>df[<span class="st">'is_crisis'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> crisis months identified"</span>)</span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LAYER 2: High/Tight Liquidity HMM (Normal Periods Only)</span></span>
<span id="cb64-53"><a href="#cb64-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb64-54"><a href="#cb64-54" aria-hidden="true" tabindex="-1"></a>    df_normal <span class="op">=</span> df[<span class="op">~</span>df[<span class="st">'is_crisis'</span>]].copy()</span>
<span id="cb64-55"><a href="#cb64-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-56"><a href="#cb64-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use liquidity index for regime classification</span></span>
<span id="cb64-57"><a href="#cb64-57" aria-hidden="true" tabindex="-1"></a>    X_liquidity <span class="op">=</span> df_normal[[<span class="st">'L'</span>]].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb64-58"><a href="#cb64-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-59"><a href="#cb64-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit 2-state HMM (High vs Tight)</span></span>
<span id="cb64-60"><a href="#cb64-60" aria-hidden="true" tabindex="-1"></a>    hmm_liquidity <span class="op">=</span> GaussianHMM(</span>
<span id="cb64-61"><a href="#cb64-61" aria-hidden="true" tabindex="-1"></a>        n_components<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb64-62"><a href="#cb64-62" aria-hidden="true" tabindex="-1"></a>        covariance_type<span class="op">=</span><span class="st">"full"</span>,</span>
<span id="cb64-63"><a href="#cb64-63" aria-hidden="true" tabindex="-1"></a>        n_iter<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb64-64"><a href="#cb64-64" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb64-65"><a href="#cb64-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb64-66"><a href="#cb64-66" aria-hidden="true" tabindex="-1"></a>    hmm_liquidity.fit(X_liquidity)</span>
<span id="cb64-67"><a href="#cb64-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-68"><a href="#cb64-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict liquidity states</span></span>
<span id="cb64-69"><a href="#cb64-69" aria-hidden="true" tabindex="-1"></a>    liquidity_states <span class="op">=</span> hmm_liquidity.predict(X_liquidity)</span>
<span id="cb64-70"><a href="#cb64-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-71"><a href="#cb64-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identify High vs Tight (higher mean L = High)</span></span>
<span id="cb64-72"><a href="#cb64-72" aria-hidden="true" tabindex="-1"></a>    state_means <span class="op">=</span> hmm_liquidity.means_.flatten()</span>
<span id="cb64-73"><a href="#cb64-73" aria-hidden="true" tabindex="-1"></a>    high_state_id <span class="op">=</span> np.argmax(state_means)</span>
<span id="cb64-74"><a href="#cb64-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-75"><a href="#cb64-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign regimes</span></span>
<span id="cb64-76"><a href="#cb64-76" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'regime_hierarchical'</span>] <span class="op">=</span> <span class="st">'Tight'</span>  <span class="co"># default</span></span>
<span id="cb64-77"><a href="#cb64-77" aria-hidden="true" tabindex="-1"></a>    df.loc[df_normal.index, <span class="st">'regime_hierarchical'</span>] <span class="op">=</span> <span class="op">\</span></span>
<span id="cb64-78"><a href="#cb64-78" aria-hidden="true" tabindex="-1"></a>        np.where(liquidity_states <span class="op">==</span> high_state_id, <span class="st">'High'</span>, <span class="st">'Tight'</span>)</span>
<span id="cb64-79"><a href="#cb64-79" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">'is_crisis'</span>], <span class="st">'regime_hierarchical'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb64-80"><a href="#cb64-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-81"><a href="#cb64-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb64-82"><a href="#cb64-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STATISTICS</span></span>
<span id="cb64-83"><a href="#cb64-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb64-84"><a href="#cb64-84" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Layer 2 (Liquidity Regimes in Normal Periods):"</span>)</span>
<span id="cb64-85"><a href="#cb64-85" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  State means: </span><span class="sc">{</span>state_means<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb64-86"><a href="#cb64-86" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  High regime: state </span><span class="sc">{</span>high_state_id<span class="sc">}</span><span class="ss"> (mean L = </span><span class="sc">{</span>state_means[high_state_id]<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb64-87"><a href="#cb64-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-88"><a href="#cb64-88" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Final regime distribution:"</span>)</span>
<span id="cb64-89"><a href="#cb64-89" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df[<span class="st">'regime_hierarchical'</span>].value_counts())</span>
<span id="cb64-90"><a href="#cb64-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-91"><a href="#cb64-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, hmm_crisis, hmm_liquidity</span>
<span id="cb64-92"><a href="#cb64-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-93"><a href="#cb64-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply hierarchical HMM</span></span>
<span id="cb64-94"><a href="#cb64-94" aria-hidden="true" tabindex="-1"></a>combined_hier, crisis_model, liquidity_model <span class="op">=</span> hierarchical_hmm_regimes(combined_aug_mom)</span>
<span id="cb64-95"><a href="#cb64-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-96"><a href="#cb64-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Factor returns by hierarchical regime</span></span>
<span id="cb64-97"><a href="#cb64-97" aria-hidden="true" tabindex="-1"></a>means_hier <span class="op">=</span> (</span>
<span id="cb64-98"><a href="#cb64-98" aria-hidden="true" tabindex="-1"></a>    combined_hier.groupby(<span class="st">"regime_hierarchical"</span>)[[<span class="st">"mkt_excess"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb64-99"><a href="#cb64-99" aria-hidden="true" tabindex="-1"></a>    .mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb64-100"><a href="#cb64-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-101"><a href="#cb64-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-102"><a href="#cb64-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb64-103"><a href="#cb64-103" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FACTOR RETURNS BY HIERARCHICAL HMM REGIMES (Monthly %)"</span>)</span>
<span id="cb64-104"><a href="#cb64-104" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb64-105"><a href="#cb64-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(means_hier)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Layer 1 (Crisis Detection): 66 crisis months identified

Layer 2 (Liquidity Regimes in Normal Periods):
  State means: [ 0.64300839 -2.24740945]
  High regime: state 0 (mean L = 0.643)

Final regime distribution:
regime_hierarchical
High      138
Crisis     66
Tight      57
Name: count, dtype: int64

================================================================================
FACTOR RETURNS BY HIERARCHICAL HMM REGIMES (Monthly %)
================================================================================
                     mkt_excess       hml       rmw       cma
regime_hierarchical                                          
Crisis                 0.471667 -0.817879  0.281970  0.050000
High                   0.962971  0.310290  0.408841  0.075000
Tight                  0.901930 -0.021754  0.132105 -0.305965</code></pre>
</div>
</div>
<div id="7cf6a78d-1e66-451e-b4e6-844612925b80" class="cell" data-execution_count="381">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check which months were classified as crisis</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>crisis_months <span class="op">=</span> combined_hier[combined_hier[<span class="st">'regime_hierarchical'</span>] <span class="op">==</span> <span class="st">'Crisis'</span>]</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Crisis months identified by HMM:"</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total: </span><span class="sc">{</span><span class="bu">len</span>(crisis_months)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Breakdown by year:"</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(crisis_months.groupby(crisis_months.index.year).size())</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Sample crisis months:"</span>)</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(crisis_months[[<span class="st">'L'</span>, <span class="st">'mkt_excess'</span>, <span class="st">'ret_vol'</span>]].head(<span class="dv">20</span>))</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if 2010-2014 QE got misclassified</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>qe_period <span class="op">=</span> combined_hier.loc[<span class="st">'2010-01'</span>:<span class="st">'2014-12'</span>]</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">2010-2014 QE Classification:"</span>)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(qe_period[<span class="st">'regime_hierarchical'</span>].value_counts())</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Check actual 2008-09 crisis</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>crash_period <span class="op">=</span> combined_hier.loc[<span class="st">'2008-09'</span>:<span class="st">'2009-03'</span>]</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">2008-09 Actual Crisis:"</span>)</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(crash_period[<span class="st">'regime_hierarchical'</span>].value_counts())</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean returns: </span><span class="sc">{</span>crash_period[<span class="st">'mkt_excess'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Crisis months identified by HMM:
Total: 66

Breakdown by year:
2008     7
2009     9
2010     6
2011     4
2015     2
2018     3
2019     7
2020    11
2021     1
2022     9
2023     7
dtype: int64

Sample crisis months:
                   L  mkt_excess   ret_vol
2008-06-30  0.070369     -0.0843  0.068756
2008-07-31  0.989026     -0.0075  0.053531
2008-08-31  0.146175      0.0153  0.052183
2008-09-30  4.564198     -0.0935  0.057378
2008-10-31  7.816953     -0.1720  0.094058
2008-11-30  2.246385     -0.0774  0.050614
2008-12-31  2.540236      0.0177  0.094850
2009-01-31 -0.491676     -0.0809  0.055944
2009-02-28  0.724004     -0.1014  0.063675
2009-03-31  1.745156      0.0901  0.105146
2009-04-30  0.266637      0.1017  0.114059
2009-05-31  0.677084      0.0520  0.026001
2009-06-30 -0.312000      0.0042  0.048753
2009-07-31 -0.429254      0.0774  0.037167
2009-11-30  1.132449      0.0558  0.043263
2009-12-31  0.783644      0.0274  0.041261
2010-05-31  0.577706     -0.0790  0.072817
2010-06-30  0.256471     -0.0557  0.051760
2010-07-31  0.142053      0.0692  0.079693
2010-08-31  0.097191     -0.0477  0.069916

2010-2014 QE Classification:
regime_hierarchical
High      50
Crisis    10
Name: count, dtype: int64

2008-09 Actual Crisis:
regime_hierarchical
Crisis    7
Name: count, dtype: int64
Mean returns: -5.96%</code></pre>
</div>
</div>
</section>
<section id="two-dimesnions---liquidity-and-vol." class="level4">
<h4 class="anchored" data-anchor-id="two-dimesnions---liquidity-and-vol.">Two Dimesnions - Liquidity and Vol.</h4>
<div id="afb6d1df-34f8-4d8e-865b-a1cd850f80bf" class="cell" data-execution_count="383">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> two_dimensional_regime_classification(combined_aug, n_breakpoints<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Fully automated regime classification with proper NaN handling.</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> combined_aug.copy()</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 1: Bai-Perron Structural Break Detection</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 1: BAI-PERRON STRUCTURAL BREAK DETECTION"</span>)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute volatility (creates NaNs at start)</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ret_vol'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>).std()</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CRITICAL: Drop NaNs before Bai-Perron</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    signal_data <span class="op">=</span> df[[<span class="st">'L'</span>, <span class="st">'ret_vol'</span>]].dropna()</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    signal <span class="op">=</span> signal_data.values</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Data for break detection: </span><span class="sc">{</span><span class="bu">len</span>(signal)<span class="sc">}</span><span class="ss"> months (after dropping NaNs)"</span>)</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bai-Perron algorithm</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>    algo <span class="op">=</span> rpt.Dynp(model<span class="op">=</span><span class="st">"rbf"</span>, min_size<span class="op">=</span><span class="dv">24</span>, jump<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>    algo.fit(signal)</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Detect breakpoints</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>    breakpoints <span class="op">=</span> algo.predict(n_bkps<span class="op">=</span>n_breakpoints)</span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map breakpoints back to original dataframe index</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>    breakpoint_dates <span class="op">=</span> signal_data.index[breakpoints[:<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Detected </span><span class="sc">{</span>n_breakpoints<span class="sc">}</span><span class="ss"> structural breaks:"</span>)</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, date <span class="kw">in</span> <span class="bu">enumerate</span>(breakpoint_dates):</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Break </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>date<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign periods based on breakpoint dates</span></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'period'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, break_date <span class="kw">in</span> <span class="bu">enumerate</span>(breakpoint_dates):</span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>        df.loc[df.index <span class="op">&gt;=</span> break_date, <span class="st">'period'</span>] <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 2: Characterize Each Period</span></span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STRUCTURAL PERIOD CHARACTERISTICS"</span>)</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> period <span class="kw">in</span> <span class="bu">sorted</span>(df[<span class="st">'period'</span>].unique()):</span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>        period_data <span class="op">=</span> df[df[<span class="st">'period'</span>] <span class="op">==</span> period].dropna(subset<span class="op">=</span>[<span class="st">'L'</span>, <span class="st">'ret_vol'</span>])</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(period_data) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> period_data.index[<span class="dv">0</span>]</span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> period_data.index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a>        mean_L <span class="op">=</span> period_data[<span class="st">'L'</span>].mean()</span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a>        mean_vol <span class="op">=</span> period_data[<span class="st">'ret_vol'</span>].mean()</span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a>        mean_ret <span class="op">=</span> period_data[<span class="st">'mkt_excess'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Period </span><span class="sc">{</span>period<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>start<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>end<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(period_data)<span class="sc">}</span><span class="ss"> months)"</span>)</span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Mean Liquidity: </span><span class="sc">{</span>mean_L<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Mean Volatility: </span><span class="sc">{</span>mean_vol<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Mean Return: </span><span class="sc">{</span>mean_ret<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 3: 2D HMM on Stable Periods</span></span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 3: TWO-DIMENSIONAL HMM (Liquidity × Volatility)"</span>)</span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Exclude highest-volatility period (likely crisis)</span></span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true" tabindex="-1"></a>    period_vols <span class="op">=</span> df.groupby(<span class="st">'period'</span>)[<span class="st">'ret_vol'</span>].mean()</span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true" tabindex="-1"></a>    crisis_period <span class="op">=</span> period_vols.idxmax()</span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Identified crisis period: Period </span><span class="sc">{</span>crisis_period<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-78"><a href="#cb68-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean volatility: </span><span class="sc">{</span>period_vols[crisis_period]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb68-79"><a href="#cb68-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_crisis'</span>] <span class="op">=</span> (df[<span class="st">'period'</span>] <span class="op">==</span> crisis_period)</span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get normal periods and drop NaNs</span></span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true" tabindex="-1"></a>    df_normal <span class="op">=</span> df[<span class="op">~</span>df[<span class="st">'is_crisis'</span>]].copy()</span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true" tabindex="-1"></a>    df_normal_clean <span class="op">=</span> df_normal[[<span class="st">'L'</span>, <span class="st">'ret_vol'</span>]].dropna()</span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Normal periods for HMM: </span><span class="sc">{</span><span class="bu">len</span>(df_normal_clean)<span class="sc">}</span><span class="ss"> months (after dropping NaNs)"</span>)</span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CRITICAL: Verify no NaNs</span></span>
<span id="cb68-89"><a href="#cb68-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df_normal_clean.isnull().<span class="bu">any</span>().<span class="bu">any</span>():</span>
<span id="cb68-90"><a href="#cb68-90" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"⚠️  WARNING: Still have NaNs after dropna!"</span>)</span>
<span id="cb68-91"><a href="#cb68-91" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(df_normal_clean.isnull().<span class="bu">sum</span>())</span>
<span id="cb68-92"><a href="#cb68-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Force drop any remaining NaNs</span></span>
<span id="cb68-93"><a href="#cb68-93" aria-hidden="true" tabindex="-1"></a>        df_normal_clean <span class="op">=</span> df_normal_clean.dropna()</span>
<span id="cb68-94"><a href="#cb68-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-95"><a href="#cb68-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare 2D features</span></span>
<span id="cb68-96"><a href="#cb68-96" aria-hidden="true" tabindex="-1"></a>    X_2d <span class="op">=</span> df_normal_clean.values</span>
<span id="cb68-97"><a href="#cb68-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-98"><a href="#cb68-98" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">X_2d shape: </span><span class="sc">{</span>X_2d<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-99"><a href="#cb68-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Contains NaN: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(X_2d)<span class="sc">.</span><span class="bu">any</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-100"><a href="#cb68-100" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Contains Inf: </span><span class="sc">{</span>np<span class="sc">.</span>isinf(X_2d)<span class="sc">.</span><span class="bu">any</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-101"><a href="#cb68-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-102"><a href="#cb68-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize</span></span>
<span id="cb68-103"><a href="#cb68-103" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb68-104"><a href="#cb68-104" aria-hidden="true" tabindex="-1"></a>    X_2d_scaled <span class="op">=</span> scaler.fit_transform(X_2d)</span>
<span id="cb68-105"><a href="#cb68-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-106"><a href="#cb68-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify scaled data</span></span>
<span id="cb68-107"><a href="#cb68-107" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Scaled data - Contains NaN: </span><span class="sc">{</span>np<span class="sc">.</span>isnan(X_2d_scaled)<span class="sc">.</span><span class="bu">any</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-108"><a href="#cb68-108" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Scaled data - Contains Inf: </span><span class="sc">{</span>np<span class="sc">.</span>isinf(X_2d_scaled)<span class="sc">.</span><span class="bu">any</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-109"><a href="#cb68-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-110"><a href="#cb68-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit 4-state HMM</span></span>
<span id="cb68-111"><a href="#cb68-111" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Fitting 4-state HMM..."</span>)</span>
<span id="cb68-112"><a href="#cb68-112" aria-hidden="true" tabindex="-1"></a>    hmm_2d <span class="op">=</span> GaussianHMM(</span>
<span id="cb68-113"><a href="#cb68-113" aria-hidden="true" tabindex="-1"></a>        n_components<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb68-114"><a href="#cb68-114" aria-hidden="true" tabindex="-1"></a>        covariance_type<span class="op">=</span><span class="st">"full"</span>,</span>
<span id="cb68-115"><a href="#cb68-115" aria-hidden="true" tabindex="-1"></a>        n_iter<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb68-116"><a href="#cb68-116" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb68-117"><a href="#cb68-117" aria-hidden="true" tabindex="-1"></a>        tol<span class="op">=</span><span class="fl">1e-4</span>,</span>
<span id="cb68-118"><a href="#cb68-118" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="va">False</span></span>
<span id="cb68-119"><a href="#cb68-119" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb68-120"><a href="#cb68-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-121"><a href="#cb68-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb68-122"><a href="#cb68-122" aria-hidden="true" tabindex="-1"></a>        hmm_2d.fit(X_2d_scaled)</span>
<span id="cb68-123"><a href="#cb68-123" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"✅ HMM fitting successful!"</span>)</span>
<span id="cb68-124"><a href="#cb68-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb68-125"><a href="#cb68-125" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"❌ HMM fitting failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-126"><a href="#cb68-126" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Diagnostic info:"</span>)</span>
<span id="cb68-127"><a href="#cb68-127" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  X_2d_scaled stats:"</span>)</span>
<span id="cb68-128"><a href="#cb68-128" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    Mean: </span><span class="sc">{</span>X_2d_scaled<span class="sc">.</span>mean(axis<span class="op">=</span><span class="dv">0</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-129"><a href="#cb68-129" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    Std: </span><span class="sc">{</span>X_2d_scaled<span class="sc">.</span>std(axis<span class="op">=</span><span class="dv">0</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-130"><a href="#cb68-130" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    Min: </span><span class="sc">{</span>X_2d_scaled<span class="sc">.</span><span class="bu">min</span>(axis<span class="op">=</span><span class="dv">0</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-131"><a href="#cb68-131" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    Max: </span><span class="sc">{</span>X_2d_scaled<span class="sc">.</span><span class="bu">max</span>(axis<span class="op">=</span><span class="dv">0</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-132"><a href="#cb68-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span></span>
<span id="cb68-133"><a href="#cb68-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-134"><a href="#cb68-134" aria-hidden="true" tabindex="-1"></a>    states_2d <span class="op">=</span> hmm_2d.predict(X_2d_scaled)</span>
<span id="cb68-135"><a href="#cb68-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-136"><a href="#cb68-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform means back to original scale</span></span>
<span id="cb68-137"><a href="#cb68-137" aria-hidden="true" tabindex="-1"></a>    state_means_original <span class="op">=</span> scaler.inverse_transform(hmm_2d.means_)</span>
<span id="cb68-138"><a href="#cb68-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-139"><a href="#cb68-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Classify states into 2×2 grid</span></span>
<span id="cb68-140"><a href="#cb68-140" aria-hidden="true" tabindex="-1"></a>    median_L <span class="op">=</span> np.median(state_means_original[:, <span class="dv">0</span>])</span>
<span id="cb68-141"><a href="#cb68-141" aria-hidden="true" tabindex="-1"></a>    median_vol <span class="op">=</span> np.median(state_means_original[:, <span class="dv">1</span>])</span>
<span id="cb68-142"><a href="#cb68-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-143"><a href="#cb68-143" aria-hidden="true" tabindex="-1"></a>    state_labels <span class="op">=</span> {}</span>
<span id="cb68-144"><a href="#cb68-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb68-145"><a href="#cb68-145" aria-hidden="true" tabindex="-1"></a>        L_level <span class="op">=</span> <span class="st">"High_Liq"</span> <span class="cf">if</span> state_means_original[i, <span class="dv">0</span>] <span class="op">&gt;</span> median_L <span class="cf">else</span> <span class="st">"Tight_Liq"</span></span>
<span id="cb68-146"><a href="#cb68-146" aria-hidden="true" tabindex="-1"></a>        vol_level <span class="op">=</span> <span class="st">"High_Vol"</span> <span class="cf">if</span> state_means_original[i, <span class="dv">1</span>] <span class="op">&gt;</span> median_vol <span class="cf">else</span> <span class="st">"Low_Vol"</span></span>
<span id="cb68-147"><a href="#cb68-147" aria-hidden="true" tabindex="-1"></a>        state_labels[i] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>L_level<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>vol_level<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb68-148"><a href="#cb68-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-149"><a href="#cb68-149" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">HMM State Characteristics (Normal Periods):"</span>)</span>
<span id="cb68-150"><a href="#cb68-150" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'State'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Mean L'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Mean Vol'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Label'</span><span class="sc">:&lt;25}</span><span class="ss">"</span>)</span>
<span id="cb68-151"><a href="#cb68-151" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb68-152"><a href="#cb68-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb68-153"><a href="#cb68-153" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>i<span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span>state_means_original[i,<span class="dv">0</span>]<span class="sc">:&gt;+8.2f}</span><span class="ss">  </span><span class="sc">{</span>state_means_original[i,<span class="dv">1</span>]<span class="sc">:&gt;10.4f}</span><span class="ss">  </span><span class="sc">{</span>state_labels[i]<span class="sc">:&lt;25}</span><span class="ss">"</span>)</span>
<span id="cb68-154"><a href="#cb68-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-155"><a href="#cb68-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign regime labels (only for rows that were in df_normal_clean)</span></span>
<span id="cb68-156"><a href="#cb68-156" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'regime_2d'</span>] <span class="op">=</span> <span class="st">'Unknown'</span></span>
<span id="cb68-157"><a href="#cb68-157" aria-hidden="true" tabindex="-1"></a>    df.loc[df_normal_clean.index, <span class="st">'regime_2d'</span>] <span class="op">=</span> [state_labels[s] <span class="cf">for</span> s <span class="kw">in</span> states_2d]</span>
<span id="cb68-158"><a href="#cb68-158" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">'is_crisis'</span>], <span class="st">'regime_2d'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb68-159"><a href="#cb68-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-160"><a href="#cb68-160" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Final 2D Regime Distribution:"</span>)</span>
<span id="cb68-161"><a href="#cb68-161" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df[<span class="st">'regime_2d'</span>].value_counts().sort_index())</span>
<span id="cb68-162"><a href="#cb68-162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-163"><a href="#cb68-163" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb68-164"><a href="#cb68-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 4: Aggregate into Interpretable Regimes</span></span>
<span id="cb68-165"><a href="#cb68-165" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb68-166"><a href="#cb68-166" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-167"><a href="#cb68-167" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 4: SIMPLIFIED REGIME CLASSIFICATION"</span>)</span>
<span id="cb68-168"><a href="#cb68-168" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-169"><a href="#cb68-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-170"><a href="#cb68-170" aria-hidden="true" tabindex="-1"></a>    regime_map <span class="op">=</span> {</span>
<span id="cb68-171"><a href="#cb68-171" aria-hidden="true" tabindex="-1"></a>        <span class="st">'High_Liq_Low_Vol'</span>: <span class="st">'Goldilocks'</span>,</span>
<span id="cb68-172"><a href="#cb68-172" aria-hidden="true" tabindex="-1"></a>        <span class="st">'High_Liq_High_Vol'</span>: <span class="st">'Intervention'</span>,</span>
<span id="cb68-173"><a href="#cb68-173" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Tight_Liq_Low_Vol'</span>: <span class="st">'Risk_Off'</span>,</span>
<span id="cb68-174"><a href="#cb68-174" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Tight_Liq_High_Vol'</span>: <span class="st">'Bear'</span>,</span>
<span id="cb68-175"><a href="#cb68-175" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Crisis'</span>: <span class="st">'Crisis'</span>,</span>
<span id="cb68-176"><a href="#cb68-176" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Unknown'</span>: <span class="st">'Unknown'</span>  <span class="co"># For NaN rows</span></span>
<span id="cb68-177"><a href="#cb68-177" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb68-178"><a href="#cb68-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-179"><a href="#cb68-179" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'regime_simple'</span>] <span class="op">=</span> df[<span class="st">'regime_2d'</span>].<span class="bu">map</span>(regime_map)</span>
<span id="cb68-180"><a href="#cb68-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-181"><a href="#cb68-181" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Simplified Regime Distribution:"</span>)</span>
<span id="cb68-182"><a href="#cb68-182" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df[<span class="st">'regime_simple'</span>].value_counts())</span>
<span id="cb68-183"><a href="#cb68-183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-184"><a href="#cb68-184" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb68-185"><a href="#cb68-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VALIDATION: Check known periods</span></span>
<span id="cb68-186"><a href="#cb68-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb68-187"><a href="#cb68-187" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-188"><a href="#cb68-188" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"VALIDATION: Known Historical Periods"</span>)</span>
<span id="cb68-189"><a href="#cb68-189" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-190"><a href="#cb68-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-191"><a href="#cb68-191" aria-hidden="true" tabindex="-1"></a>    known <span class="op">=</span> {</span>
<span id="cb68-192"><a href="#cb68-192" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2010-2014 QE'</span>: (<span class="st">'2010-01'</span>, <span class="st">'2014-12'</span>),</span>
<span id="cb68-193"><a href="#cb68-193" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2015-2019 Late Cycle'</span>: (<span class="st">'2015-01'</span>, <span class="st">'2019-12'</span>),</span>
<span id="cb68-194"><a href="#cb68-194" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2020-2021 COVID QE'</span>: (<span class="st">'2020-05'</span>, <span class="st">'2021-12'</span>),</span>
<span id="cb68-195"><a href="#cb68-195" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2022-2024 QT'</span>: (<span class="st">'2022-03'</span>, <span class="st">'2024-12'</span>),</span>
<span id="cb68-196"><a href="#cb68-196" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb68-197"><a href="#cb68-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-198"><a href="#cb68-198" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label, (start, end) <span class="kw">in</span> known.items():</span>
<span id="cb68-199"><a href="#cb68-199" aria-hidden="true" tabindex="-1"></a>        period <span class="op">=</span> df.loc[start:end]</span>
<span id="cb68-200"><a href="#cb68-200" aria-hidden="true" tabindex="-1"></a>        valid_regimes <span class="op">=</span> period[period[<span class="st">'regime_simple'</span>] <span class="op">!=</span> <span class="st">'Unknown'</span>]</span>
<span id="cb68-201"><a href="#cb68-201" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb68-202"><a href="#cb68-202" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_regimes) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb68-203"><a href="#cb68-203" aria-hidden="true" tabindex="-1"></a>            mode_regime <span class="op">=</span> valid_regimes[<span class="st">'regime_simple'</span>].mode()[<span class="dv">0</span>]</span>
<span id="cb68-204"><a href="#cb68-204" aria-hidden="true" tabindex="-1"></a>            dist <span class="op">=</span> valid_regimes[<span class="st">'regime_simple'</span>].value_counts().to_dict()</span>
<span id="cb68-205"><a href="#cb68-205" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb68-206"><a href="#cb68-206" aria-hidden="true" tabindex="-1"></a>            mean_L <span class="op">=</span> valid_regimes[<span class="st">'L'</span>].mean()</span>
<span id="cb68-207"><a href="#cb68-207" aria-hidden="true" tabindex="-1"></a>            mean_vol <span class="op">=</span> valid_regimes[<span class="st">'ret_vol'</span>].mean()</span>
<span id="cb68-208"><a href="#cb68-208" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb68-209"><a href="#cb68-209" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb68-210"><a href="#cb68-210" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Primary regime: </span><span class="sc">{</span>mode_regime<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-211"><a href="#cb68-211" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Distribution: </span><span class="sc">{</span>dist<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb68-212"><a href="#cb68-212" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Mean L = </span><span class="sc">{</span>mean_L<span class="sc">:+.2f}</span><span class="ss">, Mean Vol = </span><span class="sc">{</span>mean_vol<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb68-213"><a href="#cb68-213" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-214"><a href="#cb68-214" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, hmm_2d, scaler, breakpoint_dates</span>
<span id="cb68-215"><a href="#cb68-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-216"><a href="#cb68-216" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb68-217"><a href="#cb68-217" aria-hidden="true" tabindex="-1"></a><span class="co"># APPLY 2D REGIME CLASSIFICATION</span></span>
<span id="cb68-218"><a href="#cb68-218" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb68-219"><a href="#cb68-219" aria-hidden="true" tabindex="-1"></a>combined_2d, hmm_2d_model, scaler_2d, breaks <span class="op">=</span> two_dimensional_regime_classification(</span>
<span id="cb68-220"><a href="#cb68-220" aria-hidden="true" tabindex="-1"></a>    combined_aug_mom,</span>
<span id="cb68-221"><a href="#cb68-221" aria-hidden="true" tabindex="-1"></a>    n_breakpoints<span class="op">=</span><span class="dv">3</span></span>
<span id="cb68-222"><a href="#cb68-222" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-223"><a href="#cb68-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-224"><a href="#cb68-224" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb68-225"><a href="#cb68-225" aria-hidden="true" tabindex="-1"></a><span class="co"># FACTOR RETURNS BY 2D REGIME</span></span>
<span id="cb68-226"><a href="#cb68-226" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb68-227"><a href="#cb68-227" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-228"><a href="#cb68-228" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FACTOR RETURNS BY TWO-DIMENSIONAL REGIMES (Monthly %)"</span>)</span>
<span id="cb68-229"><a href="#cb68-229" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-230"><a href="#cb68-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-231"><a href="#cb68-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Only analyze regimes with valid data</span></span>
<span id="cb68-232"><a href="#cb68-232" aria-hidden="true" tabindex="-1"></a>valid_data <span class="op">=</span> combined_2d[combined_2d[<span class="st">'regime_simple'</span>] <span class="op">!=</span> <span class="st">'Unknown'</span>].copy()</span>
<span id="cb68-233"><a href="#cb68-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-234"><a href="#cb68-234" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Crisis'</span>, <span class="st">'Goldilocks'</span>, <span class="st">'Intervention'</span>, <span class="st">'Risk_Off'</span>, <span class="st">'Bear'</span>]:</span>
<span id="cb68-235"><a href="#cb68-235" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> regime <span class="kw">in</span> valid_data[<span class="st">'regime_simple'</span>].unique():</span>
<span id="cb68-236"><a href="#cb68-236" aria-hidden="true" tabindex="-1"></a>        regime_data <span class="op">=</span> valid_data[valid_data[<span class="st">'regime_simple'</span>] <span class="op">==</span> regime]</span>
<span id="cb68-237"><a href="#cb68-237" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(regime_data)</span>
<span id="cb68-238"><a href="#cb68-238" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb68-239"><a href="#cb68-239" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> months):"</span>)</span>
<span id="cb68-240"><a href="#cb68-240" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb68-241"><a href="#cb68-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> factor <span class="kw">in</span> [<span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]:</span>
<span id="cb68-242"><a href="#cb68-242" aria-hidden="true" tabindex="-1"></a>            mean <span class="op">=</span> regime_data[factor].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb68-243"><a href="#cb68-243" aria-hidden="true" tabindex="-1"></a>            std <span class="op">=</span> regime_data[factor].std() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb68-244"><a href="#cb68-244" aria-hidden="true" tabindex="-1"></a>            sharpe <span class="op">=</span> mean <span class="op">/</span> std <span class="cf">if</span> std <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb68-245"><a href="#cb68-245" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb68-246"><a href="#cb68-246" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>factor<span class="sc">.</span>upper()<span class="sc">:12s}</span><span class="ss">: </span><span class="sc">{</span>mean<span class="sc">:+6.2f}</span><span class="ss">% ± </span><span class="sc">{</span>std<span class="sc">:5.2f}</span><span class="ss">%  SR=</span><span class="sc">{</span>sharpe<span class="sc">:+.3f}</span><span class="ss">"</span>)</span>
<span id="cb68-247"><a href="#cb68-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-248"><a href="#cb68-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary table</span></span>
<span id="cb68-249"><a href="#cb68-249" aria-hidden="true" tabindex="-1"></a>means_2d <span class="op">=</span> valid_data.groupby(<span class="st">'regime_simple'</span>)[[<span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb68-250"><a href="#cb68-250" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-251"><a href="#cb68-251" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SUMMARY TABLE"</span>)</span>
<span id="cb68-252"><a href="#cb68-252" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb68-253"><a href="#cb68-253" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(means_2d.<span class="bu">round</span>(<span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
STEP 1: BAI-PERRON STRUCTURAL BREAK DETECTION
================================================================================

Data for break detection: 256 months (after dropping NaNs)

Detected 3 structural breaks:
  Break 1: 2007-12-31 00:00:00
  Break 2: 2020-03-31 00:00:00
  Break 3: 2022-10-31 00:00:00

================================================================================
STRUCTURAL PERIOD CHARACTERISTICS
================================================================================

Period 0: 2004-06 to 2007-11 (42 months)
  Mean Liquidity: -1.37
  Mean Volatility: 0.0234
  Mean Return: +0.58%

Period 1: 2007-12 to 2020-02 (147 months)
  Mean Liquidity: +0.41
  Mean Volatility: 0.0387
  Mean Return: +0.72%

Period 2: 2020-03 to 2022-09 (31 months)
  Mean Liquidity: +3.08
  Mean Volatility: 0.0553
  Mean Return: +0.91%

Period 3: 2022-10 to 2025-09 (36 months)
  Mean Liquidity: -2.79
  Mean Volatility: 0.0455
  Mean Return: +1.54%

================================================================================
STEP 3: TWO-DIMENSIONAL HMM (Liquidity × Volatility)
================================================================================

Identified crisis period: Period 2
  Mean volatility: 0.0553

Normal periods for HMM: 225 months (after dropping NaNs)

X_2d shape: (225, 2)
Contains NaN: False
Contains Inf: False

Scaled data - Contains NaN: False
Scaled data - Contains Inf: False

Fitting 4-state HMM...
✅ HMM fitting successful!

HMM State Characteristics (Normal Periods):
State    Mean L     Mean Vol     Label                    
------------------------------------------------------------
0           +0.55      0.0296  High_Liq_Low_Vol         
1           -2.65      0.0319  Tight_Liq_High_Vol       
2           +0.09      0.0660  High_Liq_High_Vol        
3           -0.73      0.0296  Tight_Liq_Low_Vol        

Final 2D Regime Distribution:
regime_2d
Crisis                31
High_Liq_High_Vol     43
High_Liq_Low_Vol      99
Tight_Liq_High_Vol    49
Tight_Liq_Low_Vol     34
Unknown                5
Name: count, dtype: int64

================================================================================
STEP 4: SIMPLIFIED REGIME CLASSIFICATION
================================================================================

Simplified Regime Distribution:
regime_simple
Goldilocks      99
Bear            49
Intervention    43
Risk_Off        34
Crisis          31
Unknown          5
Name: count, dtype: int64

================================================================================
VALIDATION: Known Historical Periods
================================================================================

2010-2014 QE:
  Primary regime: Goldilocks
  Distribution: {'Goldilocks': 47, 'Intervention': 13}
  Mean L = +0.89, Mean Vol = 0.0371

2015-2019 Late Cycle:
  Primary regime: Goldilocks
  Distribution: {'Goldilocks': 32, 'Risk_Off': 16, 'Intervention': 12}
  Mean L = -0.26, Mean Vol = 0.0337

2020-2021 COVID QE:
  Primary regime: Crisis
  Distribution: {'Crisis': 20}
  Mean L = +3.37, Mean Vol = 0.0519

2022-2024 QT:
  Primary regime: Bear
  Distribution: {'Bear': 21, 'Crisis': 7, 'Intervention': 6}
  Mean L = -2.07, Mean Vol = 0.0495

================================================================================
FACTOR RETURNS BY TWO-DIMENSIONAL REGIMES (Monthly %)
================================================================================

Crisis (31 months):
  MKT_EXCESS  :  +0.91% ±  6.33%  SR=+0.143
  HML         :  +0.49% ±  5.38%  SR=+0.091
  RMW         :  +0.71% ±  2.93%  SR=+0.241
  CMA         :  +0.60% ±  3.16%  SR=+0.191

Goldilocks (99 months):
  MKT_EXCESS  :  +1.08% ±  3.13%  SR=+0.346
  HML         :  +0.18% ±  2.35%  SR=+0.079
  RMW         :  +0.32% ±  1.73%  SR=+0.183
  CMA         :  +0.03% ±  1.37%  SR=+0.022

Intervention (43 months):
  MKT_EXCESS  :  +0.43% ±  6.85%  SR=+0.063
  HML         :  -0.72% ±  3.94%  SR=-0.183
  RMW         :  +0.46% ±  1.84%  SR=+0.248
  CMA         :  +0.29% ±  2.20%  SR=+0.130

Risk_Off (34 months):
  MKT_EXCESS  :  +0.18% ±  2.85%  SR=+0.062
  HML         :  -0.48% ±  1.84%  SR=-0.264
  RMW         :  +0.01% ±  1.23%  SR=+0.010
  CMA         :  -0.66% ±  1.08%  SR=-0.611

Bear (49 months):
  MKT_EXCESS  :  +1.10% ±  3.26%  SR=+0.338
  HML         :  +0.03% ±  2.64%  SR=+0.010
  RMW         :  +0.14% ±  1.71%  SR=+0.083
  CMA         :  -0.28% ±  1.84%  SR=-0.152

================================================================================
SUMMARY TABLE
================================================================================
               mkt_excess   hml   rmw   cma
regime_simple                              
Bear                 1.10  0.03  0.14 -0.28
Crisis               0.91  0.49  0.71  0.60
Goldilocks           1.08  0.18  0.32  0.03
Intervention         0.43 -0.72  0.46  0.29
Risk_Off             0.18 -0.48  0.01 -0.66</code></pre>
</div>
</div>
<div id="bedc40ea-7415-4fbc-bc01-294cfee5d960" class="cell" data-execution_count="384">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 1: What did Bai-Perron identify as "Crisis"?</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DIAGNOSTIC 1: Bai-Perron Crisis Period"</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>crisis_data <span class="op">=</span> combined_2d[combined_2d[<span class="st">'regime_simple'</span>] <span class="op">==</span> <span class="st">'Crisis'</span>]</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total crisis months: </span><span class="sc">{</span><span class="bu">len</span>(crisis_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(crisis_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Crisis months identified:"</span>)</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(crisis_data.index.tolist())</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Crisis period statistics:"</span>)</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean MKT return: </span><span class="sc">{</span>crisis_data[<span class="st">'mkt_excess'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean L: </span><span class="sc">{</span>crisis_data[<span class="st">'L'</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean Vol: </span><span class="sc">{</span>crisis_data[<span class="st">'ret_vol'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Breakdown by year:"</span>)</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(crisis_data.groupby(crisis_data.index.year).size())</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 2: Check each 2D regime characteristics</span></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DIAGNOSTIC 2: 2D Regime Characteristics"</span>)</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Goldilocks'</span>, <span class="st">'Intervention'</span>, <span class="st">'Risk_Off'</span>, <span class="st">'Bear'</span>, <span class="st">'Crisis'</span>]:</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> regime <span class="kw">in</span> combined_2d[<span class="st">'regime_simple'</span>].unique():</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>        regime_data <span class="op">=</span> combined_2d[combined_2d[<span class="st">'regime_simple'</span>] <span class="op">==</span> regime]</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(regime_data)<span class="sc">}</span><span class="ss"> months):"</span>)</span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Mean L: </span><span class="sc">{</span>regime_data[<span class="st">'L'</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Mean Volatility: </span><span class="sc">{</span>regime_data[<span class="st">'ret_vol'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Sample months: </span><span class="sc">{</span>regime_data<span class="sc">.</span>index[:<span class="dv">5</span>]<span class="sc">.</span>tolist()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 3: Known periods - which regime were they assigned?</span></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DIAGNOSTIC 3: Known Period Classifications"</span>)</span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>known_periods <span class="op">=</span> {</span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2008-2009 Crisis'</span>: (<span class="st">'2008-09'</span>, <span class="st">'2009-03'</span>),</span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2010-2014 QE'</span>: (<span class="st">'2010-01'</span>, <span class="st">'2014-12'</span>),</span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2020 COVID Crash'</span>: (<span class="st">'2020-02'</span>, <span class="st">'2020-04'</span>),</span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2020-2021 Reopening'</span>: (<span class="st">'2020-05'</span>, <span class="st">'2021-12'</span>),</span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">'2022-2024 QT'</span>: (<span class="st">'2022-03'</span>, <span class="st">'2024-12'</span>),</span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label, (start, end) <span class="kw">in</span> known_periods.items():</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>    period <span class="op">=</span> combined_2d.loc[start:end]</span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>    valid <span class="op">=</span> period[period[<span class="st">'regime_simple'</span>] <span class="op">!=</span> <span class="st">'Unknown'</span>]</span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>        dist <span class="op">=</span> valid[<span class="st">'regime_simple'</span>].value_counts()</span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>        mode <span class="op">=</span> dist.idxmax()</span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>        mean_ret <span class="op">=</span> valid[<span class="st">'mkt_excess'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>        mean_hml <span class="op">=</span> valid[<span class="st">'hml'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Classified as: </span><span class="sc">{</span>mode<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>dist[mode]<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(valid)<span class="sc">}</span><span class="ss"> months)"</span>)</span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Full distribution: </span><span class="sc">{</span>dist<span class="sc">.</span>to_dict()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Actual returns: MKT=</span><span class="sc">{</span>mean_ret<span class="sc">:+.2f}</span><span class="ss">%, HML=</span><span class="sc">{</span>mean_hml<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a><span class="co"># DIAGNOSTIC 4: Check HMM state means</span></span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DIAGNOSTIC 4: HMM State Assignments"</span>)</span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the raw 2D regime (before simplification)</span></span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Raw 2D regime distribution:"</span>)</span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(combined_2d[<span class="st">'regime_2d'</span>].value_counts())</span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Check state means from HMM</span></span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">HMM state means (from model):"</span>)</span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'hmm_2d_model'</span> <span class="kw">in</span> <span class="bu">globals</span>():</span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a>    state_means <span class="op">=</span> scaler_2d.inverse_transform(hmm_2d_model.means_)</span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(state_means)):</span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  State </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: L=</span><span class="sc">{</span>state_means[i,<span class="dv">0</span>]<span class="sc">:+.2f}</span><span class="ss">, Vol=</span><span class="sc">{</span>state_means[i,<span class="dv">1</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
DIAGNOSTIC 1: Bai-Perron Crisis Period
================================================================================

Total crisis months: 31

Crisis months identified:
[Timestamp('2020-03-31 00:00:00'), Timestamp('2020-04-30 00:00:00'), Timestamp('2020-05-31 00:00:00'), Timestamp('2020-06-30 00:00:00'), Timestamp('2020-07-31 00:00:00'), Timestamp('2020-08-31 00:00:00'), Timestamp('2020-09-30 00:00:00'), Timestamp('2020-10-31 00:00:00'), Timestamp('2020-11-30 00:00:00'), Timestamp('2020-12-31 00:00:00'), Timestamp('2021-01-31 00:00:00'), Timestamp('2021-02-28 00:00:00'), Timestamp('2021-03-31 00:00:00'), Timestamp('2021-04-30 00:00:00'), Timestamp('2021-05-31 00:00:00'), Timestamp('2021-06-30 00:00:00'), Timestamp('2021-07-31 00:00:00'), Timestamp('2021-08-31 00:00:00'), Timestamp('2021-09-30 00:00:00'), Timestamp('2021-10-31 00:00:00'), Timestamp('2021-11-30 00:00:00'), Timestamp('2021-12-31 00:00:00'), Timestamp('2022-01-31 00:00:00'), Timestamp('2022-02-28 00:00:00'), Timestamp('2022-03-31 00:00:00'), Timestamp('2022-04-30 00:00:00'), Timestamp('2022-05-31 00:00:00'), Timestamp('2022-06-30 00:00:00'), Timestamp('2022-07-31 00:00:00'), Timestamp('2022-08-31 00:00:00'), Timestamp('2022-09-30 00:00:00')]

Crisis period statistics:
  Mean MKT return: +0.91%
  Mean L: +3.08
  Mean Vol: 0.0553

Breakdown by year:
2020    10
2021    12
2022     9
dtype: int64

================================================================================
DIAGNOSTIC 2: 2D Regime Characteristics
================================================================================

Goldilocks (99 months):
  Mean L: +0.56
  Mean Volatility: 0.0295
  Sample months: [Timestamp('2004-06-30 00:00:00'), Timestamp('2004-07-31 00:00:00'), Timestamp('2004-08-31 00:00:00'), Timestamp('2004-09-30 00:00:00'), Timestamp('2004-10-31 00:00:00')]

Intervention (43 months):
  Mean L: +0.08
  Mean Volatility: 0.0658
  Sample months: [Timestamp('2008-09-30 00:00:00'), Timestamp('2008-10-31 00:00:00'), Timestamp('2008-11-30 00:00:00'), Timestamp('2008-12-31 00:00:00'), Timestamp('2009-01-31 00:00:00')]

Risk_Off (34 months):
  Mean L: -0.75
  Mean Volatility: 0.0293
  Sample months: [Timestamp('2004-12-31 00:00:00'), Timestamp('2005-01-31 00:00:00'), Timestamp('2005-02-28 00:00:00'), Timestamp('2005-03-31 00:00:00'), Timestamp('2005-04-30 00:00:00')]

Bear (49 months):
  Mean L: -2.67
  Mean Volatility: 0.0319
  Sample months: [Timestamp('2006-01-31 00:00:00'), Timestamp('2006-02-28 00:00:00'), Timestamp('2006-03-31 00:00:00'), Timestamp('2006-04-30 00:00:00'), Timestamp('2006-05-31 00:00:00')]

Crisis (31 months):
  Mean L: +3.08
  Mean Volatility: 0.0553
  Sample months: [Timestamp('2020-03-31 00:00:00'), Timestamp('2020-04-30 00:00:00'), Timestamp('2020-05-31 00:00:00'), Timestamp('2020-06-30 00:00:00'), Timestamp('2020-07-31 00:00:00')]

================================================================================
DIAGNOSTIC 3: Known Period Classifications
================================================================================

2008-2009 Crisis:
  Classified as: Intervention (7/7 months)
  Full distribution: {'Intervention': 7}
  Actual returns: MKT=-5.96%, HML=-2.36%

2010-2014 QE:
  Classified as: Goldilocks (47/60 months)
  Full distribution: {'Goldilocks': 47, 'Intervention': 13}
  Actual returns: MKT=+1.29%, HML=-0.05%

2020 COVID Crash:
  Classified as: Crisis (2/3 months)
  Full distribution: {'Crisis': 2, 'Intervention': 1}
  Actual returns: MKT=-2.64%, HML=-6.33%

2020-2021 Reopening:
  Classified as: Crisis (20/20 months)
  Full distribution: {'Crisis': 20}
  Actual returns: MKT=+2.74%, HML=+0.58%

2022-2024 QT:
  Classified as: Bear (21/34 months)
  Full distribution: {'Bear': 21, 'Crisis': 7, 'Intervention': 6}
  Actual returns: MKT=+0.76%, HML=-0.12%

================================================================================
DIAGNOSTIC 4: HMM State Assignments
================================================================================

Raw 2D regime distribution:
regime_2d
High_Liq_Low_Vol      99
Tight_Liq_High_Vol    49
High_Liq_High_Vol     43
Tight_Liq_Low_Vol     34
Crisis                31
Unknown                5
Name: count, dtype: int64

HMM state means (from model):
  State 0: L=+0.55, Vol=0.0296
  State 1: L=-2.65, Vol=0.0319
  State 2: L=+0.09, Vol=0.0660
  State 3: L=-0.73, Vol=0.0296</code></pre>
</div>
</div>
<div id="b207b44f-cc43-4a44-840e-dfe6d6a294b9" class="cell" data-execution_count="389">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> improved_two_dimensional_regimes(combined_aug):</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Improved regime classification with better thresholds.</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> combined_aug.copy()</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 1: Crisis Detection (same as before)</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 1: CRISIS DETECTION"</span>)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ret_vol'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>).std()</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'L_vol'</span>] <span class="op">=</span> df[<span class="st">'L'</span>].rolling(<span class="dv">3</span>).std()</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'abs_ret'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].<span class="bu">abs</span>()</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'cum_ret_3m'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">'mkt_excess'</span>]).rolling(<span class="dv">3</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.prod()) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>    crisis_features <span class="op">=</span> df[[<span class="st">'ret_vol'</span>, <span class="st">'abs_ret'</span>, <span class="st">'cum_ret_3m'</span>, <span class="st">'L_vol'</span>]].dropna()</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.ensemble <span class="im">import</span> IsolationForest</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>    iso_forest <span class="op">=</span> IsolationForest(</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>        contamination<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span><span class="dv">100</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>    outlier_labels <span class="op">=</span> iso_forest.fit_predict(crisis_features.values)</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_outlier'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>    df.loc[crisis_features.index, <span class="st">'is_outlier'</span>] <span class="op">=</span> (outlier_labels <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_crisis'</span>] <span class="op">=</span> df[<span class="st">'is_outlier'</span>] <span class="op">&amp;</span> (df[<span class="st">'mkt_excess'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.02</span>)</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>    crisis_months <span class="op">=</span> df[df[<span class="st">'is_crisis'</span>]]</span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Crisis months: </span><span class="sc">{</span><span class="bu">len</span>(crisis_months)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean return: </span><span class="sc">{</span>crisis_months[<span class="st">'mkt_excess'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 2: 2D HMM on Normal Periods</span></span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 2: 2D HMM"</span>)</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>    df_normal <span class="op">=</span> df[<span class="op">~</span>df[<span class="st">'is_crisis'</span>]].copy()</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>    df_clean <span class="op">=</span> df_normal[[<span class="st">'L'</span>, <span class="st">'ret_vol'</span>]].dropna()</span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>    vol_scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>    df_clean[<span class="st">'ret_vol_scaled'</span>] <span class="op">=</span> vol_scaler.fit_transform(df_clean[[<span class="st">'ret_vol'</span>]])</span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a>    X_for_hmm <span class="op">=</span> df_clean[[<span class="st">'L'</span>, <span class="st">'ret_vol_scaled'</span>]].values</span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> hmmlearn.hmm <span class="im">import</span> GaussianHMM</span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a>    hmm <span class="op">=</span> GaussianHMM(n_components<span class="op">=</span><span class="dv">4</span>, covariance_type<span class="op">=</span><span class="st">"full"</span>, </span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a>                      n_iter<span class="op">=</span><span class="dv">1000</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a>    hmm.fit(X_for_hmm)</span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a>    states <span class="op">=</span> hmm.predict(X_for_hmm)</span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-60"><a href="#cb72-60" aria-hidden="true" tabindex="-1"></a>    state_means <span class="op">=</span> vol_scaler.inverse_transform(hmm.means_)</span>
<span id="cb72-61"><a href="#cb72-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-62"><a href="#cb72-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">HMM State Means:"</span>)</span>
<span id="cb72-63"><a href="#cb72-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb72-64"><a href="#cb72-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  State </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: L=</span><span class="sc">{</span>state_means[i,<span class="dv">0</span>]<span class="sc">:+.2f}</span><span class="ss">, Vol=</span><span class="sc">{</span>state_means[i,<span class="dv">1</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb72-65"><a href="#cb72-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-66"><a href="#cb72-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb72-67"><a href="#cb72-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 3: IMPROVED STATE LABELING</span></span>
<span id="cb72-68"><a href="#cb72-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb72-69"><a href="#cb72-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-70"><a href="#cb72-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 3: IMPROVED STATE LABELING"</span>)</span>
<span id="cb72-71"><a href="#cb72-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-72"><a href="#cb72-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-73"><a href="#cb72-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use DATA percentiles, not state means median</span></span>
<span id="cb72-74"><a href="#cb72-74" aria-hidden="true" tabindex="-1"></a>    L_threshold <span class="op">=</span> df_clean[<span class="st">'L'</span>].median()  <span class="co"># Median of actual data</span></span>
<span id="cb72-75"><a href="#cb72-75" aria-hidden="true" tabindex="-1"></a>    vol_threshold <span class="op">=</span> df_clean[<span class="st">'ret_vol'</span>].quantile(<span class="fl">0.60</span>)  <span class="co"># 60th percentile</span></span>
<span id="cb72-76"><a href="#cb72-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-77"><a href="#cb72-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Data-based thresholds:"</span>)</span>
<span id="cb72-78"><a href="#cb72-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Liquidity median: </span><span class="sc">{</span>L_threshold<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb72-79"><a href="#cb72-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Volatility 60th %ile: </span><span class="sc">{</span>vol_threshold<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb72-80"><a href="#cb72-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-81"><a href="#cb72-81" aria-hidden="true" tabindex="-1"></a>    state_labels <span class="op">=</span> {}</span>
<span id="cb72-82"><a href="#cb72-82" aria-hidden="true" tabindex="-1"></a>    state_descriptions <span class="op">=</span> {}</span>
<span id="cb72-83"><a href="#cb72-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-84"><a href="#cb72-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb72-85"><a href="#cb72-85" aria-hidden="true" tabindex="-1"></a>        L_val <span class="op">=</span> state_means[i, <span class="dv">0</span>]</span>
<span id="cb72-86"><a href="#cb72-86" aria-hidden="true" tabindex="-1"></a>        vol_val <span class="op">=</span> state_means[i, <span class="dv">1</span>]</span>
<span id="cb72-87"><a href="#cb72-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-88"><a href="#cb72-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># More nuanced classification</span></span>
<span id="cb72-89"><a href="#cb72-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> L_val <span class="op">&gt;</span> <span class="fl">1.0</span>:  <span class="co"># Very high liquidity</span></span>
<span id="cb72-90"><a href="#cb72-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> vol_val <span class="op">&gt;</span> vol_threshold:</span>
<span id="cb72-91"><a href="#cb72-91" aria-hidden="true" tabindex="-1"></a>                label <span class="op">=</span> <span class="st">"Intervention"</span></span>
<span id="cb72-92"><a href="#cb72-92" aria-hidden="true" tabindex="-1"></a>                desc <span class="op">=</span> <span class="st">"Very High Liq + High Vol"</span></span>
<span id="cb72-93"><a href="#cb72-93" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb72-94"><a href="#cb72-94" aria-hidden="true" tabindex="-1"></a>                label <span class="op">=</span> <span class="st">"Goldilocks"</span></span>
<span id="cb72-95"><a href="#cb72-95" aria-hidden="true" tabindex="-1"></a>                desc <span class="op">=</span> <span class="st">"Very High Liq + Low Vol"</span></span>
<span id="cb72-96"><a href="#cb72-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> L_val <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Positive but moderate liquidity</span></span>
<span id="cb72-97"><a href="#cb72-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> vol_val <span class="op">&gt;</span> vol_threshold:</span>
<span id="cb72-98"><a href="#cb72-98" aria-hidden="true" tabindex="-1"></a>                label <span class="op">=</span> <span class="st">"Goldilocks"</span>  <span class="co"># Still expansionary despite vol</span></span>
<span id="cb72-99"><a href="#cb72-99" aria-hidden="true" tabindex="-1"></a>                desc <span class="op">=</span> <span class="st">"Moderate High Liq + High Vol"</span></span>
<span id="cb72-100"><a href="#cb72-100" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb72-101"><a href="#cb72-101" aria-hidden="true" tabindex="-1"></a>                label <span class="op">=</span> <span class="st">"Goldilocks"</span>  <span class="co"># Best regime</span></span>
<span id="cb72-102"><a href="#cb72-102" aria-hidden="true" tabindex="-1"></a>                desc <span class="op">=</span> <span class="st">"Moderate High Liq + Low Vol"</span></span>
<span id="cb72-103"><a href="#cb72-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># Negative liquidity (tight)</span></span>
<span id="cb72-104"><a href="#cb72-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> vol_val <span class="op">&gt;</span> vol_threshold:</span>
<span id="cb72-105"><a href="#cb72-105" aria-hidden="true" tabindex="-1"></a>                label <span class="op">=</span> <span class="st">"Bear"</span></span>
<span id="cb72-106"><a href="#cb72-106" aria-hidden="true" tabindex="-1"></a>                desc <span class="op">=</span> <span class="st">"Tight Liq + High Vol"</span></span>
<span id="cb72-107"><a href="#cb72-107" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb72-108"><a href="#cb72-108" aria-hidden="true" tabindex="-1"></a>                label <span class="op">=</span> <span class="st">"Risk_Off"</span></span>
<span id="cb72-109"><a href="#cb72-109" aria-hidden="true" tabindex="-1"></a>                desc <span class="op">=</span> <span class="st">"Tight Liq + Low Vol"</span></span>
<span id="cb72-110"><a href="#cb72-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-111"><a href="#cb72-111" aria-hidden="true" tabindex="-1"></a>        state_labels[i] <span class="op">=</span> label</span>
<span id="cb72-112"><a href="#cb72-112" aria-hidden="true" tabindex="-1"></a>        state_descriptions[i] <span class="op">=</span> desc</span>
<span id="cb72-113"><a href="#cb72-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-114"><a href="#cb72-114" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  State </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: L=</span><span class="sc">{</span>L_val<span class="sc">:+.2f}</span><span class="ss">, Vol=</span><span class="sc">{</span>vol_val<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb72-115"><a href="#cb72-115" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    → </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>desc<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb72-116"><a href="#cb72-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-117"><a href="#cb72-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign regimes</span></span>
<span id="cb72-118"><a href="#cb72-118" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'regime_improved'</span>] <span class="op">=</span> <span class="st">'Unknown'</span></span>
<span id="cb72-119"><a href="#cb72-119" aria-hidden="true" tabindex="-1"></a>    df.loc[df_clean.index, <span class="st">'regime_improved'</span>] <span class="op">=</span> [state_labels[s] <span class="cf">for</span> s <span class="kw">in</span> states]</span>
<span id="cb72-120"><a href="#cb72-120" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">'is_crisis'</span>], <span class="st">'regime_improved'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb72-121"><a href="#cb72-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-122"><a href="#cb72-122" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Final distribution:"</span>)</span>
<span id="cb72-123"><a href="#cb72-123" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df[<span class="st">'regime_improved'</span>].value_counts())</span>
<span id="cb72-124"><a href="#cb72-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-125"><a href="#cb72-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb72-126"><a href="#cb72-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VALIDATION</span></span>
<span id="cb72-127"><a href="#cb72-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb72-128"><a href="#cb72-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-129"><a href="#cb72-129" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"VALIDATION"</span>)</span>
<span id="cb72-130"><a href="#cb72-130" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-131"><a href="#cb72-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-132"><a href="#cb72-132" aria-hidden="true" tabindex="-1"></a>    known <span class="op">=</span> {</span>
<span id="cb72-133"><a href="#cb72-133" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2008-2009 Crisis'</span>: (<span class="st">'2008-09'</span>, <span class="st">'2009-03'</span>),</span>
<span id="cb72-134"><a href="#cb72-134" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2010-2014 QE'</span>: (<span class="st">'2010-01'</span>, <span class="st">'2014-12'</span>),</span>
<span id="cb72-135"><a href="#cb72-135" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2020 COVID'</span>: (<span class="st">'2020-02'</span>, <span class="st">'2020-04'</span>),</span>
<span id="cb72-136"><a href="#cb72-136" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2020-2021 Reopening'</span>: (<span class="st">'2020-05'</span>, <span class="st">'2021-12'</span>),</span>
<span id="cb72-137"><a href="#cb72-137" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2022-2024 QT'</span>: (<span class="st">'2022-03'</span>, <span class="st">'2024-12'</span>),</span>
<span id="cb72-138"><a href="#cb72-138" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb72-139"><a href="#cb72-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-140"><a href="#cb72-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label, (start, end) <span class="kw">in</span> known.items():</span>
<span id="cb72-141"><a href="#cb72-141" aria-hidden="true" tabindex="-1"></a>        period <span class="op">=</span> df.loc[start:end]</span>
<span id="cb72-142"><a href="#cb72-142" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> period[period[<span class="st">'regime_improved'</span>] <span class="op">!=</span> <span class="st">'Unknown'</span>]</span>
<span id="cb72-143"><a href="#cb72-143" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-144"><a href="#cb72-144" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb72-145"><a href="#cb72-145" aria-hidden="true" tabindex="-1"></a>            mode <span class="op">=</span> valid[<span class="st">'regime_improved'</span>].mode()[<span class="dv">0</span>]</span>
<span id="cb72-146"><a href="#cb72-146" aria-hidden="true" tabindex="-1"></a>            dist <span class="op">=</span> valid[<span class="st">'regime_improved'</span>].value_counts().to_dict()</span>
<span id="cb72-147"><a href="#cb72-147" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb72-148"><a href="#cb72-148" aria-hidden="true" tabindex="-1"></a>            mean_ret <span class="op">=</span> valid[<span class="st">'mkt_excess'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb72-149"><a href="#cb72-149" aria-hidden="true" tabindex="-1"></a>            mean_hml <span class="op">=</span> valid[<span class="st">'hml'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb72-150"><a href="#cb72-150" aria-hidden="true" tabindex="-1"></a>            mean_L <span class="op">=</span> valid[<span class="st">'L'</span>].mean()</span>
<span id="cb72-151"><a href="#cb72-151" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb72-152"><a href="#cb72-152" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb72-153"><a href="#cb72-153" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Primary: </span><span class="sc">{</span>mode<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>dist<span class="sc">.</span>get(mode, <span class="dv">0</span>)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(valid)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb72-154"><a href="#cb72-154" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Mean L=</span><span class="sc">{</span>mean_L<span class="sc">:+.2f}</span><span class="ss">, MKT=</span><span class="sc">{</span>mean_ret<span class="sc">:+.2f}</span><span class="ss">%, HML=</span><span class="sc">{</span>mean_hml<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb72-155"><a href="#cb72-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-156"><a href="#cb72-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, hmm, vol_scaler</span>
<span id="cb72-157"><a href="#cb72-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-158"><a href="#cb72-158" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb72-159"><a href="#cb72-159" aria-hidden="true" tabindex="-1"></a><span class="co"># RUN IMPROVED VERSION</span></span>
<span id="cb72-160"><a href="#cb72-160" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb72-161"><a href="#cb72-161" aria-hidden="true" tabindex="-1"></a>combined_improved, hmm_improved, scaler_improved <span class="op">=</span> improved_two_dimensional_regimes(combined_aug_mom)</span>
<span id="cb72-162"><a href="#cb72-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-163"><a href="#cb72-163" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb72-164"><a href="#cb72-164" aria-hidden="true" tabindex="-1"></a><span class="co"># FACTOR RETURNS</span></span>
<span id="cb72-165"><a href="#cb72-165" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb72-166"><a href="#cb72-166" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-167"><a href="#cb72-167" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FACTOR RETURNS BY IMPROVED REGIMES"</span>)</span>
<span id="cb72-168"><a href="#cb72-168" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-169"><a href="#cb72-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-170"><a href="#cb72-170" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> combined_improved[combined_improved[<span class="st">'regime_improved'</span>] <span class="op">!=</span> <span class="st">'Unknown'</span>]</span>
<span id="cb72-171"><a href="#cb72-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-172"><a href="#cb72-172" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> []</span>
<span id="cb72-173"><a href="#cb72-173" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Crisis'</span>, <span class="st">'Goldilocks'</span>, <span class="st">'Intervention'</span>, <span class="st">'Risk_Off'</span>, <span class="st">'Bear'</span>]:</span>
<span id="cb72-174"><a href="#cb72-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> regime <span class="kw">in</span> valid[<span class="st">'regime_improved'</span>].unique():</span>
<span id="cb72-175"><a href="#cb72-175" aria-hidden="true" tabindex="-1"></a>        regime_data <span class="op">=</span> valid[valid[<span class="st">'regime_improved'</span>] <span class="op">==</span> regime]</span>
<span id="cb72-176"><a href="#cb72-176" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(regime_data)</span>
<span id="cb72-177"><a href="#cb72-177" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-178"><a href="#cb72-178" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> {<span class="st">'Regime'</span>: regime, <span class="st">'N'</span>: n}</span>
<span id="cb72-179"><a href="#cb72-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> factor <span class="kw">in</span> [<span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]:</span>
<span id="cb72-180"><a href="#cb72-180" aria-hidden="true" tabindex="-1"></a>            row[factor.upper()] <span class="op">=</span> regime_data[factor].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb72-181"><a href="#cb72-181" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-182"><a href="#cb72-182" aria-hidden="true" tabindex="-1"></a>        summary.append(row)</span>
<span id="cb72-183"><a href="#cb72-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-184"><a href="#cb72-184" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb72-185"><a href="#cb72-185" aria-hidden="true" tabindex="-1"></a>summary_df <span class="op">=</span> pd.DataFrame(summary)</span>
<span id="cb72-186"><a href="#cb72-186" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> summary_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb72-187"><a href="#cb72-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-188"><a href="#cb72-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Detailed stats</span></span>
<span id="cb72-189"><a href="#cb72-189" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-190"><a href="#cb72-190" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DETAILED STATISTICS"</span>)</span>
<span id="cb72-191"><a href="#cb72-191" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb72-192"><a href="#cb72-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-193"><a href="#cb72-193" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Crisis'</span>, <span class="st">'Goldilocks'</span>, <span class="st">'Intervention'</span>, <span class="st">'Risk_Off'</span>, <span class="st">'Bear'</span>]:</span>
<span id="cb72-194"><a href="#cb72-194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> regime <span class="kw">in</span> valid[<span class="st">'regime_improved'</span>].unique():</span>
<span id="cb72-195"><a href="#cb72-195" aria-hidden="true" tabindex="-1"></a>        regime_data <span class="op">=</span> valid[valid[<span class="st">'regime_improved'</span>] <span class="op">==</span> regime]</span>
<span id="cb72-196"><a href="#cb72-196" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(regime_data)</span>
<span id="cb72-197"><a href="#cb72-197" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-198"><a href="#cb72-198" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> months):"</span>)</span>
<span id="cb72-199"><a href="#cb72-199" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> factor <span class="kw">in</span> [<span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]:</span>
<span id="cb72-200"><a href="#cb72-200" aria-hidden="true" tabindex="-1"></a>            mean <span class="op">=</span> regime_data[factor].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb72-201"><a href="#cb72-201" aria-hidden="true" tabindex="-1"></a>            std <span class="op">=</span> regime_data[factor].std() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb72-202"><a href="#cb72-202" aria-hidden="true" tabindex="-1"></a>            t_stat <span class="op">=</span> mean <span class="op">/</span> (std <span class="op">/</span> np.sqrt(n)) <span class="cf">if</span> std <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb72-203"><a href="#cb72-203" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb72-204"><a href="#cb72-204" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Rough significance (|t| &gt; 2 for p &lt; 0.05)</span></span>
<span id="cb72-205"><a href="#cb72-205" aria-hidden="true" tabindex="-1"></a>            sig <span class="op">=</span> <span class="st">"**"</span> <span class="cf">if</span> <span class="bu">abs</span>(t_stat) <span class="op">&gt;</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">"  "</span></span>
<span id="cb72-206"><a href="#cb72-206" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb72-207"><a href="#cb72-207" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>factor<span class="sc">.</span>upper()<span class="sc">:12s}</span><span class="ss">: </span><span class="sc">{</span>mean<span class="sc">:+6.2f}</span><span class="ss">% ± </span><span class="sc">{</span>std<span class="sc">:5.2f}</span><span class="ss">%  t=</span><span class="sc">{</span>t_stat<span class="sc">:+.2f}</span><span class="ss"> </span><span class="sc">{</span>sig<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
STEP 1: CRISIS DETECTION
================================================================================

Crisis months: 5
Mean return: -11.56%

================================================================================
STEP 2: 2D HMM
================================================================================

HMM State Means:
  State 0: L=+0.05, Vol=0.0294
  State 1: L=-0.01, Vol=0.0320
  State 2: L=+0.06, Vol=0.0572
  State 3: L=+0.02, Vol=0.0296

================================================================================
STEP 3: IMPROVED STATE LABELING
================================================================================

Data-based thresholds:
  Liquidity median: +0.10
  Volatility 60th %ile: 0.0380
  State 0: L=+0.05, Vol=0.0294
    → Goldilocks (Moderate High Liq + Low Vol)
  State 1: L=-0.01, Vol=0.0320
    → Risk_Off (Tight Liq + Low Vol)
  State 2: L=+0.06, Vol=0.0572
    → Goldilocks (Moderate High Liq + High Vol)
  State 3: L=+0.02, Vol=0.0296
    → Goldilocks (Moderate High Liq + Low Vol)

Final distribution:
regime_improved
Goldilocks    202
Risk_Off       49
Unknown         5
Crisis          5
Name: count, dtype: int64

================================================================================
VALIDATION
================================================================================

2008-2009 Crisis:
  Primary: Crisis (4/7)
  Mean L=+2.74, MKT=-5.96%, HML=-2.36%

2010-2014 QE:
  Primary: Goldilocks (60/60)
  Mean L=+0.89, MKT=+1.29%, HML=-0.05%

2020 COVID:
  Primary: Goldilocks (2/3)
  Mean L=+4.40, MKT=-2.64%, HML=-6.33%

2020-2021 Reopening:
  Primary: Goldilocks (20/20)
  Mean L=+3.37, MKT=+2.74%, HML=+0.58%

2022-2024 QT:
  Primary: Risk_Off (21/34)
  Mean L=-2.07, MKT=+0.76%, HML=-0.12%

================================================================================
FACTOR RETURNS BY IMPROVED REGIMES
================================================================================

    Regime   N  MKT_EXCESS       HML      RMW       CMA
    Crisis   5  -11.556000 -4.574000 1.840000  1.208000
Goldilocks 202    1.077327  0.044356 0.316584  0.027574
  Risk_Off  49    1.102041  0.026939 0.141633 -0.280816

================================================================================
DETAILED STATISTICS
================================================================================

Crisis (5 months):
  MKT_EXCESS  : -11.56% ±  3.76%  t=-6.88 **
  HML         :  -4.57% ±  7.15%  t=-1.43   
  RMW         :  +1.84% ±  2.33%  t=+1.77   
  CMA         :  +1.21% ±  1.12%  t=+2.41 **

Goldilocks (202 months):
  MKT_EXCESS  :  +1.08% ±  4.23%  t=+3.62 **
  HML         :  +0.04% ±  3.08%  t=+0.20   
  RMW         :  +0.32% ±  1.89%  t=+2.38 **
  CMA         :  +0.03% ±  1.92%  t=+0.20   

Risk_Off (49 months):
  MKT_EXCESS  :  +1.10% ±  3.26%  t=+2.37 **
  HML         :  +0.03% ±  2.64%  t=+0.07   
  RMW         :  +0.14% ±  1.71%  t=+0.58   
  CMA         :  -0.28% ±  1.84%  t=-1.07   </code></pre>
</div>
</div>
<div id="86669952-5d7c-4ac5-93f8-9280bcf0d08f" class="cell" data-execution_count="391">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> factor_based_regime_discovery(combined_aug):</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Factor-based regime discovery with CORRECT standardization.</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> combined_aug.copy()</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 1: Crisis Detection</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 1: CRISIS OUTLIER DETECTION"</span>)</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ret_vol'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>).std()</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'L_vol'</span>] <span class="op">=</span> df[<span class="st">'L'</span>].rolling(<span class="dv">3</span>).std()</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'abs_ret'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].<span class="bu">abs</span>()</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'cum_ret_3m'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">'mkt_excess'</span>]).rolling(<span class="dv">3</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.prod()) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>    crisis_features <span class="op">=</span> df[[<span class="st">'ret_vol'</span>, <span class="st">'abs_ret'</span>, <span class="st">'cum_ret_3m'</span>, <span class="st">'L_vol'</span>]].dropna()</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.ensemble <span class="im">import</span> IsolationForest</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>    iso_forest <span class="op">=</span> IsolationForest(contamination<span class="op">=</span><span class="fl">0.05</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>    outlier_labels <span class="op">=</span> iso_forest.fit_predict(crisis_features.values)</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_crisis'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>    df.loc[crisis_features.index, <span class="st">'is_crisis'</span>] <span class="op">=</span> (outlier_labels <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>) <span class="op">&amp;</span> (df.loc[crisis_features.index, <span class="st">'mkt_excess'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.02</span>)</span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Crisis months: </span><span class="sc">{</span>df[<span class="st">'is_crisis'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 2: Factor-Based Clustering</span></span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 2: FACTOR RETURN-BASED REGIME CLUSTERING"</span>)</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>    df_normal <span class="op">=</span> df[<span class="op">~</span>df[<span class="st">'is_crisis'</span>]].copy()</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> [<span class="st">'L'</span>, <span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'ret_vol'</span>]</span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>    df_features <span class="op">=</span> df_normal[feature_cols].dropna()</span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Normal periods: </span><span class="sc">{</span><span class="bu">len</span>(df_features)<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CORRECT STANDARDIZATION</span></span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Standardization:"</span>)</span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  L: Keep as-is (already z-scored)"</span>)</span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  Others: Standardize"</span>)</span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a>    L_values <span class="op">=</span> df_features[[<span class="st">'L'</span>]].values</span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a>    other_features <span class="op">=</span> df_features[[<span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'ret_vol'</span>]]</span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb74-55"><a href="#cb74-55" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb74-56"><a href="#cb74-56" aria-hidden="true" tabindex="-1"></a>    other_scaled <span class="op">=</span> scaler.fit_transform(other_features.values)</span>
<span id="cb74-57"><a href="#cb74-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-58"><a href="#cb74-58" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> np.hstack([L_values, other_scaled])</span>
<span id="cb74-59"><a href="#cb74-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-60"><a href="#cb74-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Verification - L unchanged:"</span>)</span>
<span id="cb74-61"><a href="#cb74-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Original L mean: </span><span class="sc">{</span>df_features[<span class="st">'L'</span>]<span class="sc">.</span>mean()<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb74-62"><a href="#cb74-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  X_scaled[:,0] mean: </span><span class="sc">{</span>X_scaled[:,<span class="dv">0</span>]<span class="sc">.</span>mean()<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb74-63"><a href="#cb74-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-64"><a href="#cb74-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-65"><a href="#cb74-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 2.1: Optimal Number via BIC</span></span>
<span id="cb74-66"><a href="#cb74-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-67"><a href="#cb74-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-68"><a href="#cb74-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"MODEL SELECTION (BIC)"</span>)</span>
<span id="cb74-69"><a href="#cb74-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-70"><a href="#cb74-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-71"><a href="#cb74-71" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.mixture <span class="im">import</span> GaussianMixture  <span class="co"># Use regular GMM for BIC</span></span>
<span id="cb74-72"><a href="#cb74-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-73"><a href="#cb74-73" aria-hidden="true" tabindex="-1"></a>    bic_scores <span class="op">=</span> []</span>
<span id="cb74-74"><a href="#cb74-74" aria-hidden="true" tabindex="-1"></a>    aic_scores <span class="op">=</span> []</span>
<span id="cb74-75"><a href="#cb74-75" aria-hidden="true" tabindex="-1"></a>    n_components_range <span class="op">=</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">8</span>)</span>
<span id="cb74-76"><a href="#cb74-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-77"><a href="#cb74-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n <span class="kw">in</span> n_components_range:</span>
<span id="cb74-78"><a href="#cb74-78" aria-hidden="true" tabindex="-1"></a>        gmm <span class="op">=</span> GaussianMixture(</span>
<span id="cb74-79"><a href="#cb74-79" aria-hidden="true" tabindex="-1"></a>            n_components<span class="op">=</span>n,</span>
<span id="cb74-80"><a href="#cb74-80" aria-hidden="true" tabindex="-1"></a>            covariance_type<span class="op">=</span><span class="st">'full'</span>,</span>
<span id="cb74-81"><a href="#cb74-81" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb74-82"><a href="#cb74-82" aria-hidden="true" tabindex="-1"></a>            n_init<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb74-83"><a href="#cb74-83" aria-hidden="true" tabindex="-1"></a>            max_iter<span class="op">=</span><span class="dv">500</span></span>
<span id="cb74-84"><a href="#cb74-84" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb74-85"><a href="#cb74-85" aria-hidden="true" tabindex="-1"></a>        gmm.fit(X_scaled)</span>
<span id="cb74-86"><a href="#cb74-86" aria-hidden="true" tabindex="-1"></a>        bic_scores.append(gmm.bic(X_scaled))</span>
<span id="cb74-87"><a href="#cb74-87" aria-hidden="true" tabindex="-1"></a>        aic_scores.append(gmm.aic(X_scaled))</span>
<span id="cb74-88"><a href="#cb74-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-89"><a href="#cb74-89" aria-hidden="true" tabindex="-1"></a>    optimal_n_bic <span class="op">=</span> n_components_range[np.argmin(bic_scores)]</span>
<span id="cb74-90"><a href="#cb74-90" aria-hidden="true" tabindex="-1"></a>    optimal_n_aic <span class="op">=</span> n_components_range[np.argmin(aic_scores)]</span>
<span id="cb74-91"><a href="#cb74-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-92"><a href="#cb74-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'N'</span><span class="sc">:&lt;5}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'BIC'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'AIC'</span><span class="sc">:&lt;15}</span><span class="ss">"</span>)</span>
<span id="cb74-93"><a href="#cb74-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">35</span>)</span>
<span id="cb74-94"><a href="#cb74-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n, bic, aic <span class="kw">in</span> <span class="bu">zip</span>(n_components_range, bic_scores, aic_scores):</span>
<span id="cb74-95"><a href="#cb74-95" aria-hidden="true" tabindex="-1"></a>        bic_marker <span class="op">=</span> <span class="st">" ← BIC optimal"</span> <span class="cf">if</span> n <span class="op">==</span> optimal_n_bic <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb74-96"><a href="#cb74-96" aria-hidden="true" tabindex="-1"></a>        aic_marker <span class="op">=</span> <span class="st">" ← AIC optimal"</span> <span class="cf">if</span> n <span class="op">==</span> optimal_n_aic <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb74-97"><a href="#cb74-97" aria-hidden="true" tabindex="-1"></a>        marker <span class="op">=</span> bic_marker <span class="kw">or</span> aic_marker</span>
<span id="cb74-98"><a href="#cb74-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>n<span class="sc">:&lt;5}</span><span class="ss"> </span><span class="sc">{</span>bic<span class="sc">:&lt;15,.1f}</span><span class="ss"> </span><span class="sc">{</span>aic<span class="sc">:&lt;15,.1f}{</span>marker<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb74-99"><a href="#cb74-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-100"><a href="#cb74-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use BIC optimal</span></span>
<span id="cb74-101"><a href="#cb74-101" aria-hidden="true" tabindex="-1"></a>    optimal_n <span class="op">=</span> optimal_n_bic</span>
<span id="cb74-102"><a href="#cb74-102" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Selected: </span><span class="sc">{</span>optimal_n<span class="sc">}</span><span class="ss"> regimes (BIC criterion)"</span>)</span>
<span id="cb74-103"><a href="#cb74-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-104"><a href="#cb74-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-105"><a href="#cb74-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 2.2: Fit Final Model</span></span>
<span id="cb74-106"><a href="#cb74-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-107"><a href="#cb74-107" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Fitting final GMM with </span><span class="sc">{</span>optimal_n<span class="sc">}</span><span class="ss"> components..."</span>)</span>
<span id="cb74-108"><a href="#cb74-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-109"><a href="#cb74-109" aria-hidden="true" tabindex="-1"></a>    gmm_final <span class="op">=</span> GaussianMixture(</span>
<span id="cb74-110"><a href="#cb74-110" aria-hidden="true" tabindex="-1"></a>        n_components<span class="op">=</span>optimal_n,</span>
<span id="cb74-111"><a href="#cb74-111" aria-hidden="true" tabindex="-1"></a>        covariance_type<span class="op">=</span><span class="st">'full'</span>,</span>
<span id="cb74-112"><a href="#cb74-112" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb74-113"><a href="#cb74-113" aria-hidden="true" tabindex="-1"></a>        n_init<span class="op">=</span><span class="dv">20</span>,  <span class="co"># More initializations for stability</span></span>
<span id="cb74-114"><a href="#cb74-114" aria-hidden="true" tabindex="-1"></a>        max_iter<span class="op">=</span><span class="dv">500</span></span>
<span id="cb74-115"><a href="#cb74-115" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-116"><a href="#cb74-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-117"><a href="#cb74-117" aria-hidden="true" tabindex="-1"></a>    gmm_final.fit(X_scaled)</span>
<span id="cb74-118"><a href="#cb74-118" aria-hidden="true" tabindex="-1"></a>    cluster_labels <span class="op">=</span> gmm_final.predict(X_scaled)</span>
<span id="cb74-119"><a href="#cb74-119" aria-hidden="true" tabindex="-1"></a>    cluster_probs <span class="op">=</span> gmm_final.predict_proba(X_scaled)</span>
<span id="cb74-120"><a href="#cb74-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-121"><a href="#cb74-121" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Converged: </span><span class="sc">{</span>gmm_final<span class="sc">.</span>converged_<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb74-122"><a href="#cb74-122" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Iterations: </span><span class="sc">{</span>gmm_final<span class="sc">.</span>n_iter_<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb74-123"><a href="#cb74-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-124"><a href="#cb74-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-125"><a href="#cb74-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 3: Characterize Clusters</span></span>
<span id="cb74-126"><a href="#cb74-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-127"><a href="#cb74-127" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-128"><a href="#cb74-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CLUSTER CHARACTERIZATION"</span>)</span>
<span id="cb74-129"><a href="#cb74-129" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-130"><a href="#cb74-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-131"><a href="#cb74-131" aria-hidden="true" tabindex="-1"></a>    cluster_chars <span class="op">=</span> []</span>
<span id="cb74-132"><a href="#cb74-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-133"><a href="#cb74-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cluster <span class="kw">in</span> <span class="bu">range</span>(optimal_n):</span>
<span id="cb74-134"><a href="#cb74-134" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> cluster_labels <span class="op">==</span> cluster</span>
<span id="cb74-135"><a href="#cb74-135" aria-hidden="true" tabindex="-1"></a>        cluster_data <span class="op">=</span> df_features[mask]</span>
<span id="cb74-136"><a href="#cb74-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-137"><a href="#cb74-137" aria-hidden="true" tabindex="-1"></a>        n_months <span class="op">=</span> mask.<span class="bu">sum</span>()</span>
<span id="cb74-138"><a href="#cb74-138" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-139"><a href="#cb74-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n_months <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb74-140"><a href="#cb74-140" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb74-141"><a href="#cb74-141" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-142"><a href="#cb74-142" aria-hidden="true" tabindex="-1"></a>        char <span class="op">=</span> {</span>
<span id="cb74-143"><a href="#cb74-143" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cluster'</span>: cluster,</span>
<span id="cb74-144"><a href="#cb74-144" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_months'</span>: n_months,</span>
<span id="cb74-145"><a href="#cb74-145" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_L'</span>: cluster_data[<span class="st">'L'</span>].mean(),</span>
<span id="cb74-146"><a href="#cb74-146" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std_L'</span>: cluster_data[<span class="st">'L'</span>].std(),</span>
<span id="cb74-147"><a href="#cb74-147" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_vol'</span>: cluster_data[<span class="st">'ret_vol'</span>].mean(),</span>
<span id="cb74-148"><a href="#cb74-148" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std_vol'</span>: cluster_data[<span class="st">'ret_vol'</span>].std(),</span>
<span id="cb74-149"><a href="#cb74-149" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_mkt'</span>: cluster_data[<span class="st">'mkt_excess'</span>].mean() <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb74-150"><a href="#cb74-150" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std_mkt'</span>: cluster_data[<span class="st">'mkt_excess'</span>].std() <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb74-151"><a href="#cb74-151" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_hml'</span>: cluster_data[<span class="st">'hml'</span>].mean() <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb74-152"><a href="#cb74-152" aria-hidden="true" tabindex="-1"></a>            <span class="st">'std_hml'</span>: cluster_data[<span class="st">'hml'</span>].std() <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb74-153"><a href="#cb74-153" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_rmw'</span>: cluster_data[<span class="st">'rmw'</span>].mean() <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb74-154"><a href="#cb74-154" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_cma'</span>: cluster_data[<span class="st">'cma'</span>].mean() <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb74-155"><a href="#cb74-155" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb74-156"><a href="#cb74-156" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-157"><a href="#cb74-157" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Automatic regime naming</span></span>
<span id="cb74-158"><a href="#cb74-158" aria-hidden="true" tabindex="-1"></a>        L <span class="op">=</span> char[<span class="st">'mean_L'</span>]</span>
<span id="cb74-159"><a href="#cb74-159" aria-hidden="true" tabindex="-1"></a>        vol <span class="op">=</span> char[<span class="st">'mean_vol'</span>]</span>
<span id="cb74-160"><a href="#cb74-160" aria-hidden="true" tabindex="-1"></a>        hml <span class="op">=</span> char[<span class="st">'mean_hml'</span>]</span>
<span id="cb74-161"><a href="#cb74-161" aria-hidden="true" tabindex="-1"></a>        rmw <span class="op">=</span> char[<span class="st">'mean_rmw'</span>]</span>
<span id="cb74-162"><a href="#cb74-162" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-163"><a href="#cb74-163" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> L <span class="op">&gt;</span> <span class="fl">1.5</span>:  <span class="co"># Very high liquidity</span></span>
<span id="cb74-164"><a href="#cb74-164" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> vol <span class="op">&gt;</span> <span class="fl">0.045</span>:</span>
<span id="cb74-165"><a href="#cb74-165" aria-hidden="true" tabindex="-1"></a>                regime <span class="op">=</span> <span class="st">"Intervention"</span></span>
<span id="cb74-166"><a href="#cb74-166" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb74-167"><a href="#cb74-167" aria-hidden="true" tabindex="-1"></a>                regime <span class="op">=</span> <span class="st">"Goldilocks"</span></span>
<span id="cb74-168"><a href="#cb74-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> L <span class="op">&gt;</span> <span class="dv">0</span>:  <span class="co"># Moderate positive</span></span>
<span id="cb74-169"><a href="#cb74-169" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> hml <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.3</span>:</span>
<span id="cb74-170"><a href="#cb74-170" aria-hidden="true" tabindex="-1"></a>                regime <span class="op">=</span> <span class="st">"Expansion"</span></span>
<span id="cb74-171"><a href="#cb74-171" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb74-172"><a href="#cb74-172" aria-hidden="true" tabindex="-1"></a>                regime <span class="op">=</span> <span class="st">"Goldilocks"</span></span>
<span id="cb74-173"><a href="#cb74-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># Negative liquidity</span></span>
<span id="cb74-174"><a href="#cb74-174" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> vol <span class="op">&gt;</span> <span class="fl">0.045</span>:</span>
<span id="cb74-175"><a href="#cb74-175" aria-hidden="true" tabindex="-1"></a>                regime <span class="op">=</span> <span class="st">"Bear"</span></span>
<span id="cb74-176"><a href="#cb74-176" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb74-177"><a href="#cb74-177" aria-hidden="true" tabindex="-1"></a>                regime <span class="op">=</span> <span class="st">"Tight"</span></span>
<span id="cb74-178"><a href="#cb74-178" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-179"><a href="#cb74-179" aria-hidden="true" tabindex="-1"></a>        char[<span class="st">'regime'</span>] <span class="op">=</span> regime</span>
<span id="cb74-180"><a href="#cb74-180" aria-hidden="true" tabindex="-1"></a>        cluster_chars.append(char)</span>
<span id="cb74-181"><a href="#cb74-181" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-182"><a href="#cb74-182" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print table</span></span>
<span id="cb74-183"><a href="#cb74-183" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'Cluster'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Regime'</span><span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'N'</span><span class="sc">:&lt;5}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'L'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Vol'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'MKT%'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'HML%'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'RMW%'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'CMA%'</span><span class="sc">:&lt;8}</span><span class="ss">"</span>)</span>
<span id="cb74-184"><a href="#cb74-184" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb74-185"><a href="#cb74-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-186"><a href="#cb74-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> char <span class="kw">in</span> <span class="bu">sorted</span>(cluster_chars, key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'mean_L'</span>], reverse<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb74-187"><a href="#cb74-187" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>char[<span class="st">'cluster'</span>]<span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span>char[<span class="st">'regime'</span>]<span class="sc">:&lt;15}</span><span class="ss"> </span><span class="sc">{</span>char[<span class="st">'n_months'</span>]<span class="sc">:&lt;5}</span><span class="ss"> "</span></span>
<span id="cb74-188"><a href="#cb74-188" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>char[<span class="st">'mean_L'</span>]<span class="sc">:&gt;+6.2f}</span><span class="ss">    </span><span class="sc">{</span>char[<span class="st">'mean_vol'</span>]<span class="sc">:&gt;7.4f}</span><span class="ss">   "</span></span>
<span id="cb74-189"><a href="#cb74-189" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>char[<span class="st">'mean_mkt'</span>]<span class="sc">:&gt;+6.2f}</span><span class="ss">  </span><span class="sc">{</span>char[<span class="st">'mean_hml'</span>]<span class="sc">:&gt;+6.2f}</span><span class="ss">  "</span></span>
<span id="cb74-190"><a href="#cb74-190" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>char[<span class="st">'mean_rmw'</span>]<span class="sc">:&gt;+6.2f}</span><span class="ss">  </span><span class="sc">{</span>char[<span class="st">'mean_cma'</span>]<span class="sc">:&gt;+6.2f}</span><span class="ss">"</span>)</span>
<span id="cb74-191"><a href="#cb74-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-192"><a href="#cb74-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-193"><a href="#cb74-193" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 4: Assign to Dataframe</span></span>
<span id="cb74-194"><a href="#cb74-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-195"><a href="#cb74-195" aria-hidden="true" tabindex="-1"></a>    cluster_to_regime <span class="op">=</span> {char[<span class="st">'cluster'</span>]: char[<span class="st">'regime'</span>] <span class="cf">for</span> char <span class="kw">in</span> cluster_chars}</span>
<span id="cb74-196"><a href="#cb74-196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-197"><a href="#cb74-197" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'regime_final'</span>] <span class="op">=</span> <span class="st">'Unknown'</span></span>
<span id="cb74-198"><a href="#cb74-198" aria-hidden="true" tabindex="-1"></a>    df.loc[df_features.index, <span class="st">'regime_final'</span>] <span class="op">=</span> [cluster_to_regime[c] <span class="cf">for</span> c <span class="kw">in</span> cluster_labels]</span>
<span id="cb74-199"><a href="#cb74-199" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">'is_crisis'</span>], <span class="st">'regime_final'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb74-200"><a href="#cb74-200" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-201"><a href="#cb74-201" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'regime_prob'</span>] <span class="op">=</span> np.nan</span>
<span id="cb74-202"><a href="#cb74-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, idx <span class="kw">in</span> <span class="bu">enumerate</span>(df_features.index):</span>
<span id="cb74-203"><a href="#cb74-203" aria-hidden="true" tabindex="-1"></a>        assigned_cluster <span class="op">=</span> cluster_labels[i]</span>
<span id="cb74-204"><a href="#cb74-204" aria-hidden="true" tabindex="-1"></a>        df.loc[idx, <span class="st">'regime_prob'</span>] <span class="op">=</span> cluster_probs[i, assigned_cluster]</span>
<span id="cb74-205"><a href="#cb74-205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-206"><a href="#cb74-206" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-207"><a href="#cb74-207" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"REGIME DISTRIBUTION"</span>)</span>
<span id="cb74-208"><a href="#cb74-208" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-209"><a href="#cb74-209" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df[<span class="st">'regime_final'</span>].value_counts().sort_index())</span>
<span id="cb74-210"><a href="#cb74-210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-211"><a href="#cb74-211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-212"><a href="#cb74-212" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VALIDATION</span></span>
<span id="cb74-213"><a href="#cb74-213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb74-214"><a href="#cb74-214" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-215"><a href="#cb74-215" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"VALIDATION: Known Historical Periods"</span>)</span>
<span id="cb74-216"><a href="#cb74-216" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-217"><a href="#cb74-217" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-218"><a href="#cb74-218" aria-hidden="true" tabindex="-1"></a>    known <span class="op">=</span> {</span>
<span id="cb74-219"><a href="#cb74-219" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2008-2009 Crisis'</span>: (<span class="st">'2008-09'</span>, <span class="st">'2009-03'</span>),</span>
<span id="cb74-220"><a href="#cb74-220" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2010-2014 QE'</span>: (<span class="st">'2010-01'</span>, <span class="st">'2014-12'</span>),</span>
<span id="cb74-221"><a href="#cb74-221" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2015-2019 Late Cycle'</span>: (<span class="st">'2015-01'</span>, <span class="st">'2019-12'</span>),</span>
<span id="cb74-222"><a href="#cb74-222" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2020 COVID'</span>: (<span class="st">'2020-02'</span>, <span class="st">'2020-04'</span>),</span>
<span id="cb74-223"><a href="#cb74-223" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2020-2021 Reopening'</span>: (<span class="st">'2020-05'</span>, <span class="st">'2021-12'</span>),</span>
<span id="cb74-224"><a href="#cb74-224" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2022-2024 QT'</span>: (<span class="st">'2022-03'</span>, <span class="st">'2024-12'</span>),</span>
<span id="cb74-225"><a href="#cb74-225" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb74-226"><a href="#cb74-226" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-227"><a href="#cb74-227" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label, (start, end) <span class="kw">in</span> known.items():</span>
<span id="cb74-228"><a href="#cb74-228" aria-hidden="true" tabindex="-1"></a>        period <span class="op">=</span> df.loc[start:end]</span>
<span id="cb74-229"><a href="#cb74-229" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> period[period[<span class="st">'regime_final'</span>] <span class="op">!=</span> <span class="st">'Unknown'</span>]</span>
<span id="cb74-230"><a href="#cb74-230" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-231"><a href="#cb74-231" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb74-232"><a href="#cb74-232" aria-hidden="true" tabindex="-1"></a>            dist <span class="op">=</span> valid[<span class="st">'regime_final'</span>].value_counts()</span>
<span id="cb74-233"><a href="#cb74-233" aria-hidden="true" tabindex="-1"></a>            mode <span class="op">=</span> dist.idxmax() <span class="cf">if</span> <span class="bu">len</span>(dist) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'None'</span></span>
<span id="cb74-234"><a href="#cb74-234" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb74-235"><a href="#cb74-235" aria-hidden="true" tabindex="-1"></a>            mean_L <span class="op">=</span> valid[<span class="st">'L'</span>].mean()</span>
<span id="cb74-236"><a href="#cb74-236" aria-hidden="true" tabindex="-1"></a>            mean_vol <span class="op">=</span> valid[<span class="st">'ret_vol'</span>].mean()</span>
<span id="cb74-237"><a href="#cb74-237" aria-hidden="true" tabindex="-1"></a>            mean_mkt <span class="op">=</span> valid[<span class="st">'mkt_excess'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb74-238"><a href="#cb74-238" aria-hidden="true" tabindex="-1"></a>            mean_hml <span class="op">=</span> valid[<span class="st">'hml'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb74-239"><a href="#cb74-239" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb74-240"><a href="#cb74-240" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb74-241"><a href="#cb74-241" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Primary: </span><span class="sc">{</span>mode<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>dist<span class="sc">.</span>get(mode, <span class="dv">0</span>)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(valid)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb74-242"><a href="#cb74-242" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Distribution: </span><span class="sc">{</span>dist<span class="sc">.</span>to_dict()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb74-243"><a href="#cb74-243" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  L=</span><span class="sc">{</span>mean_L<span class="sc">:+.2f}</span><span class="ss">, Vol=</span><span class="sc">{</span>mean_vol<span class="sc">:.4f}</span><span class="ss">, MKT=</span><span class="sc">{</span>mean_mkt<span class="sc">:+.2f}</span><span class="ss">%, HML=</span><span class="sc">{</span>mean_hml<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb74-244"><a href="#cb74-244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-245"><a href="#cb74-245" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, gmm_final, scaler, cluster_chars</span>
<span id="cb74-246"><a href="#cb74-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-247"><a href="#cb74-247" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb74-248"><a href="#cb74-248" aria-hidden="true" tabindex="-1"></a><span class="co"># RUN</span></span>
<span id="cb74-249"><a href="#cb74-249" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb74-250"><a href="#cb74-250" aria-hidden="true" tabindex="-1"></a>combined_final, gmm_model, scaler_final, cluster_info <span class="op">=</span> factor_based_regime_discovery(combined_aug_mom)</span>
<span id="cb74-251"><a href="#cb74-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-252"><a href="#cb74-252" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb74-253"><a href="#cb74-253" aria-hidden="true" tabindex="-1"></a><span class="co"># RESULTS</span></span>
<span id="cb74-254"><a href="#cb74-254" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb74-255"><a href="#cb74-255" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-256"><a href="#cb74-256" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FACTOR RETURNS BY DATA-DRIVEN REGIMES"</span>)</span>
<span id="cb74-257"><a href="#cb74-257" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb74-258"><a href="#cb74-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-259"><a href="#cb74-259" aria-hidden="true" tabindex="-1"></a>valid <span class="op">=</span> combined_final[combined_final[<span class="st">'regime_final'</span>] <span class="op">!=</span> <span class="st">'Unknown'</span>]</span>
<span id="cb74-260"><a href="#cb74-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-261"><a href="#cb74-261" aria-hidden="true" tabindex="-1"></a>summary_rows <span class="op">=</span> []</span>
<span id="cb74-262"><a href="#cb74-262" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> regime <span class="kw">in</span> <span class="bu">sorted</span>(valid[<span class="st">'regime_final'</span>].unique()):</span>
<span id="cb74-263"><a href="#cb74-263" aria-hidden="true" tabindex="-1"></a>    regime_data <span class="op">=</span> valid[valid[<span class="st">'regime_final'</span>] <span class="op">==</span> regime]</span>
<span id="cb74-264"><a href="#cb74-264" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(regime_data)</span>
<span id="cb74-265"><a href="#cb74-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-266"><a href="#cb74-266" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> {</span>
<span id="cb74-267"><a href="#cb74-267" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Regime'</span>: regime,</span>
<span id="cb74-268"><a href="#cb74-268" aria-hidden="true" tabindex="-1"></a>        <span class="st">'N'</span>: n,</span>
<span id="cb74-269"><a href="#cb74-269" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Mean_L'</span>: regime_data[<span class="st">'L'</span>].mean(),</span>
<span id="cb74-270"><a href="#cb74-270" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Mean_Vol'</span>: regime_data[<span class="st">'ret_vol'</span>].mean(),</span>
<span id="cb74-271"><a href="#cb74-271" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb74-272"><a href="#cb74-272" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-273"><a href="#cb74-273" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> factor <span class="kw">in</span> [<span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]:</span>
<span id="cb74-274"><a href="#cb74-274" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> regime_data[factor].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb74-275"><a href="#cb74-275" aria-hidden="true" tabindex="-1"></a>        std <span class="op">=</span> regime_data[factor].std() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb74-276"><a href="#cb74-276" aria-hidden="true" tabindex="-1"></a>        t_stat <span class="op">=</span> mean <span class="op">/</span> (std <span class="op">/</span> np.sqrt(n)) <span class="cf">if</span> std <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> n <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb74-277"><a href="#cb74-277" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-278"><a href="#cb74-278" aria-hidden="true" tabindex="-1"></a>        row[factor.upper()] <span class="op">=</span> mean</span>
<span id="cb74-279"><a href="#cb74-279" aria-hidden="true" tabindex="-1"></a>        row[<span class="ss">f'</span><span class="sc">{</span>factor<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">_t'</span>] <span class="op">=</span> t_stat</span>
<span id="cb74-280"><a href="#cb74-280" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-281"><a href="#cb74-281" aria-hidden="true" tabindex="-1"></a>    summary_rows.append(row)</span>
<span id="cb74-282"><a href="#cb74-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-283"><a href="#cb74-283" aria-hidden="true" tabindex="-1"></a>summary_df <span class="op">=</span> pd.DataFrame(summary_rows)</span>
<span id="cb74-284"><a href="#cb74-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-285"><a href="#cb74-285" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Summary Table:"</span>)</span>
<span id="cb74-286"><a href="#cb74-286" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary_df[[<span class="st">'Regime'</span>, <span class="st">'N'</span>, <span class="st">'Mean_L'</span>, <span class="st">'Mean_Vol'</span>, <span class="st">'MKT_EXCESS'</span>, <span class="st">'HML'</span>, <span class="st">'RMW'</span>, <span class="st">'CMA'</span>]].to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb74-287"><a href="#cb74-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-288"><a href="#cb74-288" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\n</span><span class="st">Detailed Statistics by Regime:"</span>)</span>
<span id="cb74-289"><a href="#cb74-289" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> summary_df.iterrows():</span>
<span id="cb74-290"><a href="#cb74-290" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>row[<span class="st">'Regime'</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>row[<span class="st">'N'</span>]<span class="sc">}</span><span class="ss"> months):"</span>)</span>
<span id="cb74-291"><a href="#cb74-291" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Liquidity: </span><span class="sc">{</span>row[<span class="st">'Mean_L'</span>]<span class="sc">:+.2f}</span><span class="ss">, Volatility: </span><span class="sc">{</span>row[<span class="st">'Mean_Vol'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb74-292"><a href="#cb74-292" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  MKT: </span><span class="sc">{</span>row[<span class="st">'MKT_EXCESS'</span>]<span class="sc">:+.2f}</span><span class="ss">% (t=</span><span class="sc">{</span>row[<span class="st">'MKT_EXCESS_t'</span>]<span class="sc">:+.2f}</span><span class="ss">)"</span>)</span>
<span id="cb74-293"><a href="#cb74-293" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  HML: </span><span class="sc">{</span>row[<span class="st">'HML'</span>]<span class="sc">:+.2f}</span><span class="ss">% (t=</span><span class="sc">{</span>row[<span class="st">'HML_t'</span>]<span class="sc">:+.2f}</span><span class="ss">)"</span>)</span>
<span id="cb74-294"><a href="#cb74-294" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  RMW: </span><span class="sc">{</span>row[<span class="st">'RMW'</span>]<span class="sc">:+.2f}</span><span class="ss">% (t=</span><span class="sc">{</span>row[<span class="st">'RMW_t'</span>]<span class="sc">:+.2f}</span><span class="ss">)"</span>)</span>
<span id="cb74-295"><a href="#cb74-295" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  CMA: </span><span class="sc">{</span>row[<span class="st">'CMA'</span>]<span class="sc">:+.2f}</span><span class="ss">% (t=</span><span class="sc">{</span>row[<span class="st">'CMA_t'</span>]<span class="sc">:+.2f}</span><span class="ss">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
STEP 1: CRISIS OUTLIER DETECTION
================================================================================
Crisis months: 5

================================================================================
STEP 2: FACTOR RETURN-BASED REGIME CLUSTERING
================================================================================
Normal periods: 251 months

Standardization:
  L: Keep as-is (already z-scored)
  Others: Standardize

Verification - L unchanged:
  Original L mean: -0.088497
  X_scaled[:,0] mean: -0.088497

================================================================================
MODEL SELECTION (BIC)
================================================================================

N     BIC             AIC            
-----------------------------------
2     4,445.5         4,251.6         ← BIC optimal
3     4,530.3         4,237.6        
4     4,556.7         4,165.4        
5     4,631.2         4,141.2        
6     4,740.1         4,151.3        
7     4,758.1         4,070.7         ← AIC optimal

Selected: 2 regimes (BIC criterion)

Fitting final GMM with 2 components...
Converged: True
Iterations: 17

================================================================================
CLUSTER CHARACTERIZATION
================================================================================

Cluster  Regime          N     L          Vol        MKT%     HML%     RMW%     CMA%    
----------------------------------------------------------------------------------------------------
0        Goldilocks      107    +0.20     0.0547    +0.85   +0.35   +0.54   +0.26
1        Tight           144    -0.31     0.0267    +1.26   -0.19   +0.09   -0.25

================================================================================
REGIME DISTRIBUTION
================================================================================
regime_final
Crisis          5
Goldilocks    107
Tight         144
Unknown         5
Name: count, dtype: int64

================================================================================
VALIDATION: Known Historical Periods
================================================================================

2008-2009 Crisis:
  Primary: Crisis (4/7)
  Distribution: {'Crisis': 4, 'Goldilocks': 3}
  L=+2.74, Vol=0.0717, MKT=-5.96%, HML=-2.36%

2010-2014 QE:
  Primary: Tight (42/60)
  Distribution: {'Tight': 42, 'Goldilocks': 18}
  L=+0.89, Vol=0.0371, MKT=+1.29%, HML=-0.05%

2015-2019 Late Cycle:
  Primary: Tight (41/60)
  Distribution: {'Tight': 41, 'Goldilocks': 19}
  L=-0.26, Vol=0.0337, MKT=+0.89%, HML=-0.34%

2020 COVID:
  Primary: Goldilocks (2/3)
  Distribution: {'Goldilocks': 2, 'Crisis': 1}
  L=+4.40, Vol=0.0695, MKT=-2.64%, HML=-6.33%

2020-2021 Reopening:
  Primary: Goldilocks (18/20)
  Distribution: {'Goldilocks': 18, 'Tight': 2}
  L=+3.37, Vol=0.0519, MKT=+2.74%, HML=+0.58%

2022-2024 QT:
  Primary: Goldilocks (26/34)
  Distribution: {'Goldilocks': 26, 'Tight': 8}
  L=-2.07, Vol=0.0495, MKT=+0.76%, HML=-0.12%

================================================================================
FACTOR RETURNS BY DATA-DRIVEN REGIMES
================================================================================

Summary Table:
    Regime   N    Mean_L  Mean_Vol  MKT_EXCESS       HML      RMW       CMA
    Crisis   5  4.111773  0.066251  -11.556000 -4.574000 1.840000  1.208000
Goldilocks 107  0.204691  0.054710    0.846636  0.347570 0.541402  0.257009
     Tight 144 -0.306352  0.026653    1.257153 -0.186875 0.090000 -0.247847


Detailed Statistics by Regime:

Crisis (5 months):
  Liquidity: +4.11, Volatility: 0.0663
  MKT: -11.56% (t=-6.88)
  HML: -4.57% (t=-1.43)
  RMW: +1.84% (t=+1.77)
  CMA: +1.21% (t=+2.41)

Goldilocks (107 months):
  Liquidity: +0.20, Volatility: 0.0547
  MKT: +0.85% (t=+1.57)
  HML: +0.35% (t=+0.92)
  RMW: +0.54% (t=+2.32)
  CMA: +0.26% (t=+1.03)

Tight (144 months):
  Liquidity: -0.31, Volatility: 0.0267
  MKT: +1.26% (t=+6.37)
  HML: -0.19% (t=-1.10)
  RMW: +0.09% (t=+0.85)
  CMA: -0.25% (t=-2.55)</code></pre>
</div>
</div>
<div id="cb07e659-14ef-40ae-af46-677da8727669" class="cell" data-execution_count="398">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>combined_aug_mom[<span class="st">'L'</span>].describe()</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="co"># What period has this extreme value?</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>extreme_L <span class="op">=</span> combined_aug_mom[combined_aug_mom[<span class="st">'L'</span>] <span class="op">&gt;</span> <span class="dv">5</span>]</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Extreme liquidity periods (L &gt; 5):"</span>)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(extreme_L[[<span class="st">'L'</span>, <span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>]].sort_values(<span class="st">'L'</span>, ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution check</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">L value distribution:"</span>)</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean: </span><span class="sc">{</span>combined_aug_mom[<span class="st">'L'</span>]<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Std:  </span><span class="sc">{</span>combined_aug_mom[<span class="st">'L'</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Skew: </span><span class="sc">{</span>combined_aug_mom[<span class="st">'L'</span>]<span class="sc">.</span>skew()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Kurtosis: </span><span class="sc">{</span>combined_aug_mom[<span class="st">'L'</span>]<span class="sc">.</span>kurtosis()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Percentiles</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Percentiles:"</span>)</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> [<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">75</span>, <span class="dv">90</span>, <span class="dv">95</span>, <span class="dv">99</span>]:</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    val <span class="op">=</span> combined_aug_mom[<span class="st">'L'</span>].quantile(p<span class="op">/</span><span class="dv">100</span>)</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>p<span class="sc">:2d}</span><span class="ss">%: </span><span class="sc">{</span>val<span class="sc">:+.2f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Extreme liquidity periods (L &gt; 5):
                   L  mkt_excess     hml
2020-04-30  8.523441      0.1358 -0.0134
2008-10-31  7.816953     -0.1720 -0.0189
2020-05-31  7.224145      0.0559 -0.0500
2020-03-31  5.207325     -0.1335 -0.1383

L value distribution:
Mean: -0.00
Std:  1.95
Skew: 0.69
Kurtosis: 2.22

Percentiles:
   1%: -3.86
   5%: -3.22
  10%: -2.31
  25%: -1.36
  50%: +0.14
  75%: +0.84
  90%: +2.56
  95%: +3.05
  99%: +6.01</code></pre>
</div>
</div>
<div id="aae5a358-0b89-4d10-bf60-dc474171c52d" class="cell" data-execution_count="412">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cart_optimal_regime_thresholds(combined_aug):</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Use CART to find OPTIMAL L and Vol thresholds that maximize</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="co">    factor return predictability.</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Academic approach: Let the data tell us the best thresholds,</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="co">    then validate economically.</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeClassifier</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> KBinsDiscretizer</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> combined_aug.copy()</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 0: Standardize L</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'L_original'</span>] <span class="op">=</span> df[<span class="st">'L'</span>]</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'L_std'</span>] <span class="op">=</span> df[<span class="st">'L'</span>] <span class="op">/</span> df[<span class="st">'L'</span>].std()</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CART-BASED OPTIMAL THRESHOLD DISCOVERY"</span>)</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 1: Crisis Detection (same)</span></span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ret_vol'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>).std()</span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'L_vol'</span>] <span class="op">=</span> df[<span class="st">'L_std'</span>].rolling(<span class="dv">3</span>).std()</span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'abs_ret'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].<span class="bu">abs</span>()</span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'cum_ret_3m'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">'mkt_excess'</span>]).rolling(<span class="dv">3</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.prod()) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>    crisis_features <span class="op">=</span> df[[<span class="st">'ret_vol'</span>, <span class="st">'abs_ret'</span>, <span class="st">'cum_ret_3m'</span>, <span class="st">'L_vol'</span>]].dropna()</span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.ensemble <span class="im">import</span> IsolationForest</span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a>    iso_forest <span class="op">=</span> IsolationForest(contamination<span class="op">=</span><span class="fl">0.05</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a>    outlier_labels <span class="op">=</span> iso_forest.fit_predict(crisis_features.values)</span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_crisis'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true" tabindex="-1"></a>    df.loc[crisis_features.index, <span class="st">'is_crisis'</span>] <span class="op">=</span> (outlier_labels <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>) <span class="op">&amp;</span> (df.loc[crisis_features.index, <span class="st">'mkt_excess'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.02</span>)</span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Crisis months: </span><span class="sc">{</span>df[<span class="st">'is_crisis'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-45"><a href="#cb78-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-46"><a href="#cb78-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 2: Create TARGET Variable for CART</span></span>
<span id="cb78-47"><a href="#cb78-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-48"><a href="#cb78-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-49"><a href="#cb78-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CREATE TARGET LABELS (HML Quantiles)"</span>)</span>
<span id="cb78-50"><a href="#cb78-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-51"><a href="#cb78-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-52"><a href="#cb78-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Key insight: Regimes should PREDICT factor returns</span></span>
<span id="cb78-53"><a href="#cb78-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create target = HML terciles (Growth/Neutral/Value periods)</span></span>
<span id="cb78-54"><a href="#cb78-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-55"><a href="#cb78-55" aria-hidden="true" tabindex="-1"></a>    df_normal <span class="op">=</span> df[<span class="op">~</span>df[<span class="st">'is_crisis'</span>]].copy()</span>
<span id="cb78-56"><a href="#cb78-56" aria-hidden="true" tabindex="-1"></a>    df_clean <span class="op">=</span> df_normal[[<span class="st">'L_std'</span>, <span class="st">'ret_vol'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]].dropna()</span>
<span id="cb78-57"><a href="#cb78-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-58"><a href="#cb78-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create HML-based target (which regime are we in based on realized HML?)</span></span>
<span id="cb78-59"><a href="#cb78-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is forward-looking: "Did growth or value win this month?"</span></span>
<span id="cb78-60"><a href="#cb78-60" aria-hidden="true" tabindex="-1"></a>    hml_quantiles <span class="op">=</span> pd.qcut(df_clean[<span class="st">'hml'</span>], q<span class="op">=</span><span class="dv">3</span>, labels<span class="op">=</span>[<span class="st">'Growth'</span>, <span class="st">'Neutral'</span>, <span class="st">'Value'</span>])</span>
<span id="cb78-61"><a href="#cb78-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-62"><a href="#cb78-62" aria-hidden="true" tabindex="-1"></a>    df_clean[<span class="st">'target'</span>] <span class="op">=</span> hml_quantiles</span>
<span id="cb78-63"><a href="#cb78-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-64"><a href="#cb78-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Target distribution:"</span>)</span>
<span id="cb78-65"><a href="#cb78-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df_clean[<span class="st">'target'</span>].value_counts())</span>
<span id="cb78-66"><a href="#cb78-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-67"><a href="#cb78-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-68"><a href="#cb78-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 3: Train CART to Find Optimal Thresholds</span></span>
<span id="cb78-69"><a href="#cb78-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-70"><a href="#cb78-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-71"><a href="#cb78-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TRAIN CART TO FIND OPTIMAL THRESHOLDS"</span>)</span>
<span id="cb78-72"><a href="#cb78-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-73"><a href="#cb78-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-74"><a href="#cb78-74" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df_clean[[<span class="st">'L_std'</span>, <span class="st">'ret_vol'</span>]].values</span>
<span id="cb78-75"><a href="#cb78-75" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df_clean[<span class="st">'target'</span>].values</span>
<span id="cb78-76"><a href="#cb78-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-77"><a href="#cb78-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train decision tree (this finds optimal splits)</span></span>
<span id="cb78-78"><a href="#cb78-78" aria-hidden="true" tabindex="-1"></a>    cart <span class="op">=</span> DecisionTreeClassifier(</span>
<span id="cb78-79"><a href="#cb78-79" aria-hidden="true" tabindex="-1"></a>        max_depth<span class="op">=</span><span class="dv">3</span>,  <span class="co"># Simple tree for interpretability</span></span>
<span id="cb78-80"><a href="#cb78-80" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span><span class="dv">20</span>,  <span class="co"># Minimum regime size = 20 months</span></span>
<span id="cb78-81"><a href="#cb78-81" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb78-82"><a href="#cb78-82" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb78-83"><a href="#cb78-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-84"><a href="#cb78-84" aria-hidden="true" tabindex="-1"></a>    cart.fit(X, y)</span>
<span id="cb78-85"><a href="#cb78-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-86"><a href="#cb78-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract learned thresholds</span></span>
<span id="cb78-87"><a href="#cb78-87" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.tree <span class="im">import</span> export_text</span>
<span id="cb78-88"><a href="#cb78-88" aria-hidden="true" tabindex="-1"></a>    tree_rules <span class="op">=</span> export_text(cart, feature_names<span class="op">=</span>[<span class="st">'L_std'</span>, <span class="st">'ret_vol'</span>])</span>
<span id="cb78-89"><a href="#cb78-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-90"><a href="#cb78-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Learned Decision Rules:"</span>)</span>
<span id="cb78-91"><a href="#cb78-91" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(tree_rules)</span>
<span id="cb78-92"><a href="#cb78-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-93"><a href="#cb78-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get predictions</span></span>
<span id="cb78-94"><a href="#cb78-94" aria-hidden="true" tabindex="-1"></a>    regime_predictions <span class="op">=</span> cart.predict(X)</span>
<span id="cb78-95"><a href="#cb78-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-96"><a href="#cb78-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-97"><a href="#cb78-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 4: Translate to Economic Regimes</span></span>
<span id="cb78-98"><a href="#cb78-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-99"><a href="#cb78-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-100"><a href="#cb78-100" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TRANSLATE PREDICTIONS TO ECONOMIC REGIMES"</span>)</span>
<span id="cb78-101"><a href="#cb78-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-102"><a href="#cb78-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-103"><a href="#cb78-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map growth/neutral/value to liquidity regimes</span></span>
<span id="cb78-104"><a href="#cb78-104" aria-hidden="true" tabindex="-1"></a>    df_clean[<span class="st">'cart_prediction'</span>] <span class="op">=</span> regime_predictions</span>
<span id="cb78-105"><a href="#cb78-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-106"><a href="#cb78-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Characterize each prediction category by L_std and vol</span></span>
<span id="cb78-107"><a href="#cb78-107" aria-hidden="true" tabindex="-1"></a>    regime_chars <span class="op">=</span> []</span>
<span id="cb78-108"><a href="#cb78-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-109"><a href="#cb78-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pred_class <span class="kw">in</span> [<span class="st">'Growth'</span>, <span class="st">'Neutral'</span>, <span class="st">'Value'</span>]:</span>
<span id="cb78-110"><a href="#cb78-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pred_class <span class="kw">not</span> <span class="kw">in</span> df_clean[<span class="st">'cart_prediction'</span>].unique():</span>
<span id="cb78-111"><a href="#cb78-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb78-112"><a href="#cb78-112" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb78-113"><a href="#cb78-113" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> df_clean[<span class="st">'cart_prediction'</span>] <span class="op">==</span> pred_class</span>
<span id="cb78-114"><a href="#cb78-114" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> df_clean[mask]</span>
<span id="cb78-115"><a href="#cb78-115" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-116"><a href="#cb78-116" aria-hidden="true" tabindex="-1"></a>        mean_L <span class="op">=</span> subset[<span class="st">'L_std'</span>].mean()</span>
<span id="cb78-117"><a href="#cb78-117" aria-hidden="true" tabindex="-1"></a>        mean_vol <span class="op">=</span> subset[<span class="st">'ret_vol'</span>].mean()</span>
<span id="cb78-118"><a href="#cb78-118" aria-hidden="true" tabindex="-1"></a>        mean_hml <span class="op">=</span> subset[<span class="st">'hml'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb78-119"><a href="#cb78-119" aria-hidden="true" tabindex="-1"></a>        mean_rmw <span class="op">=</span> subset[<span class="st">'rmw'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb78-120"><a href="#cb78-120" aria-hidden="true" tabindex="-1"></a>        mean_cma <span class="op">=</span> subset[<span class="st">'cma'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb78-121"><a href="#cb78-121" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-122"><a href="#cb78-122" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Economic interpretation</span></span>
<span id="cb78-123"><a href="#cb78-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mean_L <span class="op">&gt;</span> <span class="fl">0.3</span>:</span>
<span id="cb78-124"><a href="#cb78-124" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mean_vol <span class="op">&gt;</span> subset[<span class="st">'ret_vol'</span>].median():</span>
<span id="cb78-125"><a href="#cb78-125" aria-hidden="true" tabindex="-1"></a>                regime <span class="op">=</span> <span class="st">"High_Liq_High_Vol"</span></span>
<span id="cb78-126"><a href="#cb78-126" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb78-127"><a href="#cb78-127" aria-hidden="true" tabindex="-1"></a>                regime <span class="op">=</span> <span class="st">"High_Liq_Low_Vol"</span></span>
<span id="cb78-128"><a href="#cb78-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> mean_L <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.3</span>:</span>
<span id="cb78-129"><a href="#cb78-129" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mean_vol <span class="op">&gt;</span> subset[<span class="st">'ret_vol'</span>].median():</span>
<span id="cb78-130"><a href="#cb78-130" aria-hidden="true" tabindex="-1"></a>                regime <span class="op">=</span> <span class="st">"Tight_Liq_High_Vol"</span></span>
<span id="cb78-131"><a href="#cb78-131" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb78-132"><a href="#cb78-132" aria-hidden="true" tabindex="-1"></a>                regime <span class="op">=</span> <span class="st">"Tight_Liq_Low_Vol"</span></span>
<span id="cb78-133"><a href="#cb78-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb78-134"><a href="#cb78-134" aria-hidden="true" tabindex="-1"></a>            regime <span class="op">=</span> <span class="st">"Neutral_Liq"</span></span>
<span id="cb78-135"><a href="#cb78-135" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-136"><a href="#cb78-136" aria-hidden="true" tabindex="-1"></a>        char <span class="op">=</span> {</span>
<span id="cb78-137"><a href="#cb78-137" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cart_class'</span>: pred_class,</span>
<span id="cb78-138"><a href="#cb78-138" aria-hidden="true" tabindex="-1"></a>            <span class="st">'regime'</span>: regime,</span>
<span id="cb78-139"><a href="#cb78-139" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n'</span>: <span class="bu">len</span>(subset),</span>
<span id="cb78-140"><a href="#cb78-140" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_L_std'</span>: mean_L,</span>
<span id="cb78-141"><a href="#cb78-141" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_vol'</span>: mean_vol,</span>
<span id="cb78-142"><a href="#cb78-142" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_hml'</span>: mean_hml,</span>
<span id="cb78-143"><a href="#cb78-143" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_rmw'</span>: mean_rmw,</span>
<span id="cb78-144"><a href="#cb78-144" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_cma'</span>: mean_cma,</span>
<span id="cb78-145"><a href="#cb78-145" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb78-146"><a href="#cb78-146" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-147"><a href="#cb78-147" aria-hidden="true" tabindex="-1"></a>        regime_chars.append(char)</span>
<span id="cb78-148"><a href="#cb78-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-149"><a href="#cb78-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print characterization</span></span>
<span id="cb78-150"><a href="#cb78-150" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'CART Class'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Regime'</span><span class="sc">:&lt;25}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'N'</span><span class="sc">:&lt;5}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'L_std'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Vol'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'HML%'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'RMW%'</span><span class="sc">:&lt;8}</span><span class="ss">"</span>)</span>
<span id="cb78-151"><a href="#cb78-151" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">95</span>)</span>
<span id="cb78-152"><a href="#cb78-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-153"><a href="#cb78-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> char <span class="kw">in</span> <span class="bu">sorted</span>(regime_chars, key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'mean_L_std'</span>], reverse<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb78-154"><a href="#cb78-154" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>char[<span class="st">'cart_class'</span>]<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>char[<span class="st">'regime'</span>]<span class="sc">:&lt;25}</span><span class="ss"> </span><span class="sc">{</span>char[<span class="st">'n'</span>]<span class="sc">:&lt;5}</span><span class="ss"> "</span></span>
<span id="cb78-155"><a href="#cb78-155" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>char[<span class="st">'mean_L_std'</span>]<span class="sc">:&gt;+6.2f}</span><span class="ss">  </span><span class="sc">{</span>char[<span class="st">'mean_vol'</span>]<span class="sc">:&gt;6.4f}</span><span class="ss">  "</span></span>
<span id="cb78-156"><a href="#cb78-156" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>char[<span class="st">'mean_hml'</span>]<span class="sc">:&gt;+6.2f}</span><span class="ss">  </span><span class="sc">{</span>char[<span class="st">'mean_rmw'</span>]<span class="sc">:&gt;+6.2f}</span><span class="ss">"</span>)</span>
<span id="cb78-157"><a href="#cb78-157" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-158"><a href="#cb78-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map to dataframe</span></span>
<span id="cb78-159"><a href="#cb78-159" aria-hidden="true" tabindex="-1"></a>    cart_to_regime <span class="op">=</span> {char[<span class="st">'cart_class'</span>]: char[<span class="st">'regime'</span>] <span class="cf">for</span> char <span class="kw">in</span> regime_chars}</span>
<span id="cb78-160"><a href="#cb78-160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-161"><a href="#cb78-161" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'regime_final'</span>] <span class="op">=</span> <span class="st">'Unknown'</span></span>
<span id="cb78-162"><a href="#cb78-162" aria-hidden="true" tabindex="-1"></a>    df.loc[df_clean.index, <span class="st">'regime_final'</span>] <span class="op">=</span> [cart_to_regime[p] <span class="cf">for</span> p <span class="kw">in</span> regime_predictions]</span>
<span id="cb78-163"><a href="#cb78-163" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">'is_crisis'</span>], <span class="st">'regime_final'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb78-164"><a href="#cb78-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-165"><a href="#cb78-165" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-166"><a href="#cb78-166" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"REGIME DISTRIBUTION"</span>)</span>
<span id="cb78-167"><a href="#cb78-167" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-168"><a href="#cb78-168" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df[<span class="st">'regime_final'</span>].value_counts())</span>
<span id="cb78-169"><a href="#cb78-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-170"><a href="#cb78-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-171"><a href="#cb78-171" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VALIDATION</span></span>
<span id="cb78-172"><a href="#cb78-172" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb78-173"><a href="#cb78-173" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-174"><a href="#cb78-174" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"VALIDATION"</span>)</span>
<span id="cb78-175"><a href="#cb78-175" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb78-176"><a href="#cb78-176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-177"><a href="#cb78-177" aria-hidden="true" tabindex="-1"></a>    known <span class="op">=</span> {</span>
<span id="cb78-178"><a href="#cb78-178" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2008-2009 Crisis'</span>: (<span class="st">'2008-09'</span>, <span class="st">'2009-03'</span>),</span>
<span id="cb78-179"><a href="#cb78-179" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2010-2014 QE'</span>: (<span class="st">'2010-01'</span>, <span class="st">'2014-12'</span>),</span>
<span id="cb78-180"><a href="#cb78-180" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2015-2019 Late Cycle'</span>: (<span class="st">'2015-01'</span>, <span class="st">'2019-12'</span>),</span>
<span id="cb78-181"><a href="#cb78-181" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2020 COVID'</span>: (<span class="st">'2020-02'</span>, <span class="st">'2020-04'</span>),</span>
<span id="cb78-182"><a href="#cb78-182" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2020-2021 Reopening'</span>: (<span class="st">'2020-05'</span>, <span class="st">'2021-12'</span>),</span>
<span id="cb78-183"><a href="#cb78-183" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2022-2024 QT'</span>: (<span class="st">'2022-03'</span>, <span class="st">'2024-12'</span>),</span>
<span id="cb78-184"><a href="#cb78-184" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb78-185"><a href="#cb78-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-186"><a href="#cb78-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label, (start, end) <span class="kw">in</span> known.items():</span>
<span id="cb78-187"><a href="#cb78-187" aria-hidden="true" tabindex="-1"></a>        period <span class="op">=</span> df.loc[start:end]</span>
<span id="cb78-188"><a href="#cb78-188" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> period[period[<span class="st">'regime_final'</span>] <span class="op">!=</span> <span class="st">'Unknown'</span>]</span>
<span id="cb78-189"><a href="#cb78-189" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-190"><a href="#cb78-190" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb78-191"><a href="#cb78-191" aria-hidden="true" tabindex="-1"></a>            dist <span class="op">=</span> valid[<span class="st">'regime_final'</span>].value_counts()</span>
<span id="cb78-192"><a href="#cb78-192" aria-hidden="true" tabindex="-1"></a>            mode <span class="op">=</span> dist.idxmax()</span>
<span id="cb78-193"><a href="#cb78-193" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb78-194"><a href="#cb78-194" aria-hidden="true" tabindex="-1"></a>            mean_L_std <span class="op">=</span> valid[<span class="st">'L_std'</span>].mean()</span>
<span id="cb78-195"><a href="#cb78-195" aria-hidden="true" tabindex="-1"></a>            mean_hml <span class="op">=</span> valid[<span class="st">'hml'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb78-196"><a href="#cb78-196" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb78-197"><a href="#cb78-197" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb78-198"><a href="#cb78-198" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Primary: </span><span class="sc">{</span>mode<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>dist<span class="sc">.</span>get(mode, <span class="dv">0</span>)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(valid)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb78-199"><a href="#cb78-199" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  L_std=</span><span class="sc">{</span>mean_L_std<span class="sc">:+.2f}</span><span class="ss">, HML=</span><span class="sc">{</span>mean_hml<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb78-200"><a href="#cb78-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-201"><a href="#cb78-201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cart_class <span class="kw">in</span> [<span class="st">'Growth'</span>, <span class="st">'Neutral'</span>, <span class="st">'Value'</span>]:</span>
<span id="cb78-202"><a href="#cb78-202" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> df_clean[<span class="st">'cart_prediction'</span>] <span class="op">==</span> cart_class</span>
<span id="cb78-203"><a href="#cb78-203" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> df_clean[mask]</span>
<span id="cb78-204"><a href="#cb78-204" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-205"><a href="#cb78-205" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb78-206"><a href="#cb78-206" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>cart_class<span class="sc">}</span><span class="ss"> Class (</span><span class="sc">{</span><span class="bu">len</span>(subset)<span class="sc">}</span><span class="ss"> months)"</span>)</span>
<span id="cb78-207"><a href="#cb78-207" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb78-208"><a href="#cb78-208" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-209"><a href="#cb78-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Statistics</span></span>
<span id="cb78-210"><a href="#cb78-210" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"L_std: </span><span class="sc">{</span>subset[<span class="st">'L_std'</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss"> (range: </span><span class="sc">{</span>subset[<span class="st">'L_std'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:+.2f}</span><span class="ss"> to </span><span class="sc">{</span>subset[<span class="st">'L_std'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:+.2f}</span><span class="ss">)"</span>)</span>
<span id="cb78-211"><a href="#cb78-211" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Vol:   </span><span class="sc">{</span>subset[<span class="st">'ret_vol'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb78-212"><a href="#cb78-212" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"HML:   </span><span class="sc">{</span>subset[<span class="st">'hml'</span>]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">100</span><span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb78-213"><a href="#cb78-213" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-214"><a href="#cb78-214" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Time distribution</span></span>
<span id="cb78-215"><a href="#cb78-215" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Year distribution:"</span>)</span>
<span id="cb78-216"><a href="#cb78-216" aria-hidden="true" tabindex="-1"></a>        year_counts <span class="op">=</span> subset.index.year.value_counts().sort_index()</span>
<span id="cb78-217"><a href="#cb78-217" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> year, count <span class="kw">in</span> year_counts.items():</span>
<span id="cb78-218"><a href="#cb78-218" aria-hidden="true" tabindex="-1"></a>            pct <span class="op">=</span> count <span class="op">/</span> <span class="bu">len</span>(subset) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb78-219"><a href="#cb78-219" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">:3d}</span><span class="ss"> months (</span><span class="sc">{</span>pct<span class="sc">:5.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb78-220"><a href="#cb78-220" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-221"><a href="#cb78-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Known periods</span></span>
<span id="cb78-222"><a href="#cb78-222" aria-hidden="true" tabindex="-1"></a>        periods_in_class <span class="op">=</span> {</span>
<span id="cb78-223"><a href="#cb78-223" aria-hidden="true" tabindex="-1"></a>            <span class="st">'2008-2009'</span>: ((subset.index <span class="op">&gt;=</span> <span class="st">'2008-09'</span>) <span class="op">&amp;</span> (subset.index <span class="op">&lt;=</span> <span class="st">'2009-03'</span>)).<span class="bu">sum</span>(),</span>
<span id="cb78-224"><a href="#cb78-224" aria-hidden="true" tabindex="-1"></a>            <span class="st">'2010-2014 QE'</span>: ((subset.index <span class="op">&gt;=</span> <span class="st">'2010-01'</span>) <span class="op">&amp;</span> (subset.index <span class="op">&lt;=</span> <span class="st">'2014-12'</span>)).<span class="bu">sum</span>(),</span>
<span id="cb78-225"><a href="#cb78-225" aria-hidden="true" tabindex="-1"></a>            <span class="st">'2015-2019'</span>: ((subset.index <span class="op">&gt;=</span> <span class="st">'2015-01'</span>) <span class="op">&amp;</span> (subset.index <span class="op">&lt;=</span> <span class="st">'2019-12'</span>)).<span class="bu">sum</span>(),</span>
<span id="cb78-226"><a href="#cb78-226" aria-hidden="true" tabindex="-1"></a>            <span class="st">'2020-2021 Reopening'</span>: ((subset.index <span class="op">&gt;=</span> <span class="st">'2020-05'</span>) <span class="op">&amp;</span> (subset.index <span class="op">&lt;=</span> <span class="st">'2021-12'</span>)).<span class="bu">sum</span>(),</span>
<span id="cb78-227"><a href="#cb78-227" aria-hidden="true" tabindex="-1"></a>            <span class="st">'2022-2024 QT'</span>: ((subset.index <span class="op">&gt;=</span> <span class="st">'2022-03'</span>) <span class="op">&amp;</span> (subset.index <span class="op">&lt;=</span> <span class="st">'2024-12'</span>)).<span class="bu">sum</span>(),</span>
<span id="cb78-228"><a href="#cb78-228" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb78-229"><a href="#cb78-229" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb78-230"><a href="#cb78-230" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Known periods in this class:"</span>)</span>
<span id="cb78-231"><a href="#cb78-231" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> period, count <span class="kw">in</span> periods_in_class.items():</span>
<span id="cb78-232"><a href="#cb78-232" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb78-233"><a href="#cb78-233" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>period<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb78-234"><a href="#cb78-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-235"><a href="#cb78-235" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, cart, regime_chars, X</span>
<span id="cb78-236"><a href="#cb78-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-237"><a href="#cb78-237" aria-hidden="true" tabindex="-1"></a><span class="co"># RUN CART APPROACH</span></span>
<span id="cb78-238"><a href="#cb78-238" aria-hidden="true" tabindex="-1"></a>combined_cart, cart_model, cart_chars, X <span class="op">=</span> cart_optimal_regime_thresholds(combined_aug_mom)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
CART-BASED OPTIMAL THRESHOLD DISCOVERY
================================================================================
Crisis months: 5

================================================================================
CREATE TARGET LABELS (HML Quantiles)
================================================================================

Target distribution:
target
Growth     85
Value      84
Neutral    82
Name: count, dtype: int64

================================================================================
TRAIN CART TO FIND OPTIMAL THRESHOLDS
================================================================================

Learned Decision Rules:
|--- ret_vol &lt;= 0.03
|   |--- ret_vol &lt;= 0.02
|   |   |--- ret_vol &lt;= 0.02
|   |   |   |--- class: Neutral
|   |   |--- ret_vol &gt;  0.02
|   |   |   |--- class: Value
|   |--- ret_vol &gt;  0.02
|   |   |--- class: Neutral
|--- ret_vol &gt;  0.03
|   |--- L_std &lt;= -0.56
|   |   |--- L_std &lt;= -1.29
|   |   |   |--- class: Growth
|   |   |--- L_std &gt;  -1.29
|   |   |   |--- class: Growth
|   |--- L_std &gt;  -0.56
|   |   |--- L_std &lt;= 0.64
|   |   |   |--- class: Neutral
|   |   |--- L_std &gt;  0.64
|   |   |   |--- class: Value


================================================================================
TRANSLATE PREDICTIONS TO ECONOMIC REGIMES
================================================================================

CART Class   Regime                    N     L_std    Vol      HML%     RMW%    
-----------------------------------------------------------------------------------------------
Value        High_Liq_High_Vol         58     +0.71  0.0406   +0.60   +0.52
Neutral      Neutral_Liq               145    +0.06  0.0355   +0.08   +0.24
Growth       Tight_Liq_High_Vol        48     -1.26  0.0456   -0.75   +0.13

================================================================================
REGIME DISTRIBUTION
================================================================================
regime_final
Neutral_Liq           145
High_Liq_High_Vol      58
Tight_Liq_High_Vol     48
Unknown                 5
Crisis                  5
Name: count, dtype: int64

================================================================================
VALIDATION
================================================================================

2008-2009 Crisis:
  Primary: Crisis (4/7)
  L_std=+1.40, HML=-2.36%

2010-2014 QE:
  Primary: Neutral_Liq (48/60)
  L_std=+0.46, HML=-0.05%

2015-2019 Late Cycle:
  Primary: Neutral_Liq (45/60)
  L_std=-0.13, HML=-0.34%

2020 COVID:
  Primary: Neutral_Liq (1/3)
  L_std=+2.25, HML=-6.33%

2020-2021 Reopening:
  Primary: High_Liq_High_Vol (18/20)
  L_std=+1.73, HML=+0.58%

2022-2024 QT:
  Primary: Tight_Liq_High_Vol (23/34)
  L_std=-1.06, HML=-0.12%

============================================================
Growth Class (48 months)
============================================================
L_std: -1.26 (range: -2.03 to -0.64)
Vol:   0.0456
HML:   -0.75%

Year distribution:
  2005:   3 months (  6.2%)
  2007:   4 months (  8.3%)
  2018:   2 months (  4.2%)
  2019:   8 months ( 16.7%)
  2022:   1 months (  2.1%)
  2023:  12 months ( 25.0%)
  2024:  10 months ( 20.8%)
  2025:   8 months ( 16.7%)

Known periods in this class:
  2015-2019: 10 months
  2022-2024 QT: 22 months

============================================================
Neutral Class (145 months)
============================================================
L_std: +0.06 (range: -1.42 to +1.40)
Vol:   0.0355
HML:   +0.08%

Year distribution:
  2004:   5 months (  3.4%)
  2005:   9 months (  6.2%)
  2006:   4 months (  2.8%)
  2007:   6 months (  4.1%)
  2008:   8 months (  5.5%)
  2009:  10 months (  6.9%)
  2010:  12 months (  8.3%)
  2011:   5 months (  3.4%)
  2012:  11 months (  7.6%)
  2013:   9 months (  6.2%)
  2014:  11 months (  7.6%)
  2015:  12 months (  8.3%)
  2016:  11 months (  7.6%)
  2017:  11 months (  7.6%)
  2018:   8 months (  5.5%)
  2019:   3 months (  2.1%)
  2020:   1 months (  0.7%)
  2021:   2 months (  1.4%)
  2022:   5 months (  3.4%)
  2024:   1 months (  0.7%)
  2025:   1 months (  0.7%)

Known periods in this class:
  2008-2009: 1 months
  2010-2014 QE: 47 months
  2015-2019: 45 months
  2020-2021 Reopening: 2 months
  2022-2024 QT: 6 months

============================================================
Value Class (58 months)
============================================================
L_std: +0.71 (range: -1.47 to +4.36)
Vol:   0.0406
HML:   +0.60%

Year distribution:
  2004:   2 months (  3.4%)
  2006:   8 months ( 13.8%)
  2007:   2 months (  3.4%)
  2008:   1 months (  1.7%)
  2009:   1 months (  1.7%)
  2011:   7 months ( 12.1%)
  2012:   1 months (  1.7%)
  2013:   3 months (  5.2%)
  2014:   1 months (  1.7%)
  2016:   1 months (  1.7%)
  2017:   1 months (  1.7%)
  2018:   2 months (  3.4%)
  2019:   1 months (  1.7%)
  2020:  10 months ( 17.2%)
  2021:  10 months ( 17.2%)
  2022:   6 months ( 10.3%)
  2024:   1 months (  1.7%)

Known periods in this class:
  2008-2009: 1 months
  2010-2014 QE: 12 months
  2015-2019: 4 months
  2020-2021 Reopening: 17 months
  2022-2024 QT: 5 months</code></pre>
</div>
</div>
<div id="2be8e875-dcc7-49af-9b30-8d0fbaa1b8ef" class="cell" data-execution_count="411">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> export_text</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the actual decision rules</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>tree_rules <span class="op">=</span> export_text(cart_model, feature_names<span class="op">=</span>[<span class="st">'L_std'</span>, <span class="st">'ret_vol'</span>])</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CART Decision Rules:"</span>)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tree_rules)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Also show feature importance</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature Importance:"</span>)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  L_std: </span><span class="sc">{</span>cart_model<span class="sc">.</span>feature_importances_[<span class="dv">0</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  ret_vol: </span><span class="sc">{</span>cart_model<span class="sc">.</span>feature_importances_[<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Check class distribution</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">CART class predictions:"</span>)</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(Counter(cart_model.predict(X)))</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Show sample months from each regime</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cart_class <span class="kw">in</span> [<span class="st">'Growth'</span>, <span class="st">'Neutral'</span>, <span class="st">'Value'</span>]:</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> combined_cart[<span class="st">'cart_prediction'</span>] <span class="op">==</span> cart_class</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    sample_months <span class="op">=</span> combined_cart[mask].index[:<span class="dv">10</span>].tolist()</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>cart_class<span class="sc">}</span><span class="ss"> regime - sample months:"</span>)</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(sample_months)</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show distribution by year</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>    year_dist <span class="op">=</span> combined_cart[mask].index.year.value_counts().sort_index()</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Distribution by year:"</span>)</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(year_dist.head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>CART Decision Rules:
|--- ret_vol &lt;= 0.03
|   |--- ret_vol &lt;= 0.02
|   |   |--- ret_vol &lt;= 0.02
|   |   |   |--- class: Neutral
|   |   |--- ret_vol &gt;  0.02
|   |   |   |--- class: Value
|   |--- ret_vol &gt;  0.02
|   |   |--- class: Neutral
|--- ret_vol &gt;  0.03
|   |--- L_std &lt;= -0.56
|   |   |--- L_std &lt;= -1.29
|   |   |   |--- class: Growth
|   |   |--- L_std &gt;  -1.29
|   |   |   |--- class: Growth
|   |--- L_std &gt;  -0.56
|   |   |--- L_std &lt;= 0.64
|   |   |   |--- class: Neutral
|   |   |--- L_std &gt;  0.64
|   |   |   |--- class: Value


Feature Importance:
  L_std: 0.525
  ret_vol: 0.475

CART class predictions:
Counter({'Neutral': 145, 'Value': 58, 'Growth': 48})</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/pandas/core/indexes/base.py:3653</span>, in <span class="ansi-cyan-fg">Index.get_loc</span><span class="ansi-blue-fg">(self, key)</span>
<span class="ansi-green-fg ansi-bold">   3652</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">-&gt; 3653</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_engine</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get_loc</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">casted_key</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   3654</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">KeyError</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> err:

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/pandas/_libs/index.pyx:147</span>, in <span class="ansi-cyan-fg">pandas._libs.index.IndexEngine.get_loc</span><span class="ansi-blue-fg">()</span>

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/pandas/_libs/index.pyx:176</span>, in <span class="ansi-cyan-fg">pandas._libs.index.IndexEngine.get_loc</span><span class="ansi-blue-fg">()</span>

File <span class="ansi-green-fg">pandas/_libs/hashtable_class_helper.pxi:7080</span>, in <span class="ansi-cyan-fg">pandas._libs.hashtable.PyObjectHashTable.get_item</span><span class="ansi-blue-fg">()</span>

File <span class="ansi-green-fg">pandas/_libs/hashtable_class_helper.pxi:7088</span>, in <span class="ansi-cyan-fg">pandas._libs.hashtable.PyObjectHashTable.get_item</span><span class="ansi-blue-fg">()</span>

<span class="ansi-red-fg">KeyError</span>: 'cart_prediction'

The above exception was the direct cause of the following exception:

<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[411], line 20</span>
<span class="ansi-green-fg ansi-bold">     18</span> <span style="font-style:italic;color:rgb(95,135,135)"># Show sample months from each regime</span>
<span class="ansi-green-fg ansi-bold">     19</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> cart_class <span style="font-weight:bold;color:rgb(175,0,255)">in</span> [<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Growth</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Neutral</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Value</span><span style="color:rgb(175,0,0)">'</span>]:
<span class="ansi-green-fg">---&gt; 20</span>     mask <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">combined_cart</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">cart_prediction</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">]</span> <span style="color:rgb(98,98,98)">==</span> cart_class
<span class="ansi-green-fg ansi-bold">     21</span>     sample_months <span style="color:rgb(98,98,98)">=</span> combined_cart[mask]<span style="color:rgb(98,98,98)">.</span>index[:<span style="color:rgb(98,98,98)">10</span>]<span style="color:rgb(98,98,98)">.</span>tolist()
<span class="ansi-green-fg ansi-bold">     23</span>     <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>cart_class<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> regime - sample months:</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/pandas/core/frame.py:3761</span>, in <span class="ansi-cyan-fg">DataFrame.__getitem__</span><span class="ansi-blue-fg">(self, key)</span>
<span class="ansi-green-fg ansi-bold">   3759</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>columns<span style="color:rgb(98,98,98)">.</span>nlevels <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">1</span>:
<span class="ansi-green-fg ansi-bold">   3760</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_getitem_multilevel(key)
<span class="ansi-green-fg">-&gt; 3761</span> indexer <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">columns</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get_loc</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">key</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   3762</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> is_integer(indexer):
<span class="ansi-green-fg ansi-bold">   3763</span>     indexer <span style="color:rgb(98,98,98)">=</span> [indexer]

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/pandas/core/indexes/base.py:3655</span>, in <span class="ansi-cyan-fg">Index.get_loc</span><span class="ansi-blue-fg">(self, key)</span>
<span class="ansi-green-fg ansi-bold">   3653</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_engine<span style="color:rgb(98,98,98)">.</span>get_loc(casted_key)
<span class="ansi-green-fg ansi-bold">   3654</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">KeyError</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> err:
<span class="ansi-green-fg">-&gt; 3655</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">KeyError</span>(key) <span style="font-weight:bold;color:rgb(0,135,0)">from</span> <span style="font-weight:bold;color:rgb(0,0,255)">err</span>
<span class="ansi-green-fg ansi-bold">   3656</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">TypeError</span>:
<span class="ansi-green-fg ansi-bold">   3657</span>     <span style="font-style:italic;color:rgb(95,135,135)"># If we have a listlike key, _check_indexing_error will raise</span>
<span class="ansi-green-fg ansi-bold">   3658</span>     <span style="font-style:italic;color:rgb(95,135,135)">#  InvalidIndexError. Otherwise we fall through and re-raise</span>
<span class="ansi-green-fg ansi-bold">   3659</span>     <span style="font-style:italic;color:rgb(95,135,135)">#  the TypeError.</span>
<span class="ansi-green-fg ansi-bold">   3660</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_check_indexing_error(key)

<span class="ansi-red-fg">KeyError</span>: 'cart_prediction'</pre>
</div>
</div>
</div>
<div id="2aba7bcf-2da6-42fb-b56c-d5bc9ac7e346" class="cell" data-execution_count="365">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1: Time series with regimes</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>L1_t.index,</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>L1_t.values,</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span>regimes_aug_df[<span class="st">"state"</span>],</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"green"</span>, <span class="dv">1</span>: <span class="st">"red"</span>},</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax[<span class="dv">0</span>],</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span><span class="dv">15</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Augmented Liquidity Index L(t) with HMM States"</span>)</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">"Augmented L(t)"</span>)</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2: KDE (distribution) by state</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>regimes_aug_df,</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"L"</span>,</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"state"</span>,</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"green"</span>, <span class="dv">1</span>: <span class="st">"red"</span>},</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax[<span class="dv">1</span>]</span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Distribution/KDE of Augmented L(t) by HMM State"</span>)</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">"Augmented L(t)"</span>)</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-54-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In KDE of augmented liquidity index <span class="math inline">\(L_t^{aug}\)</span>, clusters are clearly separated, unlike last one</p>
</section>
<section id="liquidity-vector-w-momentum" class="level4">
<h4 class="anchored" data-anchor-id="liquidity-vector-w-momentum">Liquidity Vector w/ Momentum</h4>
<div id="f290a3a0-e344-451f-a4ee-b4f8ec1c90a6" class="cell" data-execution_count="369">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_liquidity_proxies_with_momentum(macro_df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> build_liquidity_proxies_augmented(macro_df)  <span class="co"># Your existing function</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add momentum features</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dL_3m"</span>] <span class="op">=</span> df[<span class="st">"EM"</span>].diff(<span class="dv">3</span>)  <span class="co"># 3-month change in excess M2</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dL_12m"</span>] <span class="op">=</span> df[<span class="st">"EM"</span>].diff(<span class="dv">12</span>)  <span class="co"># 12-month change</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dEB_dt"</span>] <span class="op">=</span> df[<span class="st">"EB"</span>].diff()  <span class="co"># Rate of Fed balance sheet expansion</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"accel_ZIRP"</span>] <span class="op">=</span> df[<span class="st">"ZIRP_dummy"</span>].diff()  <span class="co"># Entry/exit from ZIRP</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    cols_final <span class="op">=</span> [</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dlog_M2"</span>, <span class="st">"dlog_FED_BAL"</span>, <span class="st">"term_spread"</span>, <span class="st">"real_rate"</span>, <span class="st">"credit_spread"</span>,</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"EM"</span>, <span class="st">"EB"</span>, <span class="st">"EL_3y"</span>, <span class="st">"ZIRP_dummy"</span>,</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dL_3m"</span>, <span class="st">"dL_12m"</span>, <span class="st">"dEB_dt"</span>, <span class="st">"accel_ZIRP"</span>  <span class="co"># Momentum terms</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[cols_final].dropna()</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>liquidity_proxies_with_momentum <span class="op">=</span> build_liquidity_proxies_with_momentum(macro_raw)</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>z2_t <span class="op">=</span> standardize_and_signflip(liquidity_proxies_with_momentum)</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>L2_t <span class="op">=</span> build_sparse_pca_liquidity_index(z2_t, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>n_states<span class="op">=</span><span class="dv">2</span></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>model, regimes_aug_mom_df <span class="op">=</span> fit_hmm_on_liquidity(L2_t,n_states<span class="op">=</span>n_states)</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> regimes_aug_mom_df.copy()</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>reg.index <span class="op">=</span> reg.index.to_period(<span class="st">"M"</span>).to_timestamp(<span class="st">"M"</span>)</span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Join on month-end date</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>combined_aug_mom <span class="op">=</span> reg.join(ff_adj, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>combined_aug_mom.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SparsePCA components (loadings):
  dlog_M2: +0.306
  dlog_FED_BAL: +0.267
  term_spread: +0.284
  real_rate: +0.344
  credit_spread: -0.114
  EM: +0.080
  EB: +0.098
  EL_3y: +0.412
  ZIRP_dummy: +0.340
  dL_3m: +0.324
  dL_12m: +0.380
  dEB_dt: +0.267
  accel_ZIRP: +0.025

Top 3 variables by absolute loading:
  EL_3y: loading=+0.412, corr=+0.802, weighted=+0.331
  dL_12m: loading=+0.380, corr=+0.741, weighted=+0.281
  real_rate: loading=+0.344, corr=+0.675, weighted=+0.233

Weighted average correlation: +0.743
✅ Sign correct: L_t weighted correlation positive
HMM state means (unsorted, in fitted scale):
  state 0: mean L = -0.305
  state 1: mean L = 1.485</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="369">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">state_label</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>-2.474098</td>
<td>0</td>
<td>0.999985</td>
<td>0.000015</td>
<td>Tight</td>
<td>0.0606</td>
<td>-0.0072</td>
<td>-0.0288</td>
<td>0.0129</td>
<td>0.0251</td>
<td>0.0038</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>-2.179103</td>
<td>0</td>
<td>0.999980</td>
<td>0.000020</td>
<td>Tight</td>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0161</td>
<td>-0.0320</td>
<td>0.0144</td>
<td>0.0034</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-2.252183</td>
<td>0</td>
<td>0.999981</td>
<td>0.000019</td>
<td>Tight</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-2.218250</td>
<td>0</td>
<td>0.999976</td>
<td>0.000024</td>
<td>Tight</td>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0067</td>
<td>0.0208</td>
<td>0.0038</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-1.997313</td>
<td>0</td>
<td>0.999675</td>
<td>0.000325</td>
<td>Tight</td>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="b39da623-a2e2-4340-9ec7-709f9325c46c" class="cell" data-execution_count="367">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>ax.plot(combined_aug_mom.index, combined_aug_mom[<span class="st">'L'</span>], label<span class="op">=</span><span class="st">'L(t)'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Color by regime</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> combined_aug_mom[<span class="st">'state_label'</span>].<span class="bu">map</span>({<span class="st">'High'</span>: <span class="st">'red'</span>, <span class="st">'Tight'</span>: <span class="st">'green'</span>})</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>ax.scatter(combined_aug_mom.index, combined_aug_mom[<span class="st">'L'</span>], c<span class="op">=</span>colors, s<span class="op">=</span><span class="dv">5</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Liquidity Index w/ Momentum Factors with HMM Regime Colors (Red=High, Green=Tight)'</span>)</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-57-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="c5267a92-6367-4532-bdfc-d184c3de2cc7" class="cell" data-execution_count="370">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_three_regimes(combined_aug):</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Three-regime classification:</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Crisis: L spikes + VIX spikes + negative returns</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="co">    2. High: L &gt; threshold, not crisis</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Tight: L &lt; threshold, not crisis</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> combined_aug.copy()</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crisis indicator</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    crisis <span class="op">=</span> (</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>        ((df.index <span class="op">&gt;=</span> <span class="st">'2008-09'</span>) <span class="op">&amp;</span> (df.index <span class="op">&lt;=</span> <span class="st">'2009-03'</span>)) <span class="op">|</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>        ((df.index <span class="op">&gt;=</span> <span class="st">'2020-02'</span>) <span class="op">&amp;</span> (df.index <span class="op">&lt;=</span> <span class="st">'2020-04'</span>))</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Regime classification</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'regime_3state'</span>] <span class="op">=</span> <span class="st">'Tight'</span>  <span class="co"># default</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">'L'</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">'regime_3state'</span>] <span class="op">=</span> <span class="st">'High'</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    df.loc[crisis, <span class="st">'regime_3state'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply three-regime classification</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>combined_3regime <span class="op">=</span> classify_three_regimes(combined_aug_mom)</span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Factor returns by 3 regimes</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>df_3regime <span class="op">=</span> combined_3regime.copy()</span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>df_3regime <span class="op">=</span> df_3regime.dropna(subset<span class="op">=</span>[<span class="st">"regime_3state"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>])</span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>means_3regime <span class="op">=</span> (</span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>    df_3regime.groupby(<span class="st">"regime_3state"</span>)[[<span class="st">"mkt_excess"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>    .mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Factor Returns by 3 Regimes (monthly %):"</span>)</span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(means_3regime)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Factor Returns by 3 Regimes (monthly %):
               mkt_excess       hml       rmw       cma
regime_3state                                          
Crisis          -9.031250 -4.707500  0.975000  0.103750
High             1.375368  0.279191  0.363824  0.127206
Tight            0.860085 -0.108632  0.216068 -0.187350</code></pre>
</div>
</div>
<div id="3532bcbb-3526-4cdc-beac-b221b3099774" class="cell" data-execution_count="329">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define factors</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>factors <span class="op">=</span> [<span class="st">'mkt_excess'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>df4 <span class="op">=</span> combined_aug_mom.copy()</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Regime at t (end-of-month) predicting factor returns at t+1</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>df4[<span class="st">"state_label_lag1"</span>] <span class="op">=</span> df4[<span class="st">"state_label"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate statistics with ACCURATE annualization</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>stats_df_aug_mom <span class="op">=</span> calculate_factor_statistics_by_regime_accurate(</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>    df4, </span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>    factor_cols, </span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    regime_col<span class="op">=</span><span class="st">'state_label_lag1'</span>,</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    regime_order<span class="op">=</span>[<span class="st">'High'</span>, <span class="st">'Neutral'</span>, <span class="st">'Tight'</span>]</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Print formatted table (like your image but with accurate formulas)</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>print_formatted_table_accurate(stats_df_aug_mom, regime_order<span class="op">=</span>[<span class="st">'High'</span>, <span class="st">'Tight'</span>], show_geometric<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
==========================================================================================
FACTOR RETURNS BY REGIME (Monthly)
==========================================================================================
                   Mean Return                   Std Dev              Sharpe Ratio
Factor       High       Tight         High       Tight         High       Tight 
------------------------------------------------------------------------------------------
MKT_EXCESS      0.09%       0.97%        6.40%       3.84%        0.014       0.252 
HML         0.16%      -0.10%        4.72%       2.73%        0.033      -0.037 
RMW         1.11%       0.17%        2.56%       1.67%        0.436       0.103 
CMA         0.59%      -0.15%        2.55%       1.72%        0.231      -0.089 

Annualized (geometric compounding: (1+r_m)^12-1; volatility: σ_m*√12)
------------------------------------------------------------------------------------------
MKT_EXCESS       1.1%       12.3%        22.2%       13.3%        0.049       0.875 
HML          1.9%       -1.2%        16.4%        9.5%        0.115      -0.128 
RMW         14.2%        2.1%         8.9%        5.8%        1.511       0.357 
CMA          7.3%       -1.8%         8.8%        5.9%        0.800      -0.308 

Geometric Annual Returns (from actual cumulative performance)
------------------------------------------------------------------------------------------
MKT_EXCESS      -1.4%       11.3% 
HML          0.6%       -1.6% 
RMW         13.8%        1.9% 
CMA          6.9%       -2.0% 
==========================================================================================
</code></pre>
</div>
</div>
</section>
</section>
<section id="sp-500-monthly-prices" class="level3">
<h3 class="anchored" data-anchor-id="sp-500-monthly-prices">S&amp;P 500 monthly prices</h3>
</section>
<section id="cape-data-from-httpsshillerdata.com" class="level3">
<h3 class="anchored" data-anchor-id="cape-data-from-httpsshillerdata.com">CAPE Data from https://shillerdata.com/</h3>
<div id="97e00120-9798-43b7-8bf6-4b9594c65329" class="cell" data-execution_count="421">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_yyyy_mm_to_date(s: <span class="bu">str</span>):</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert 'YYYY.MM' to a proper datetime.</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Handles the special case where October appears as YYYY.1 instead of YYYY.10.</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(s).strip()</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> s.split(<span class="st">"."</span>)</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(parts) <span class="op">!=</span> <span class="dv">2</span>:</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unexpected date format: </span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>    year <span class="op">=</span> <span class="bu">int</span>(parts[<span class="dv">0</span>])</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    mm <span class="op">=</span> parts[<span class="dv">1</span>]</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fix: "1" should be "10" (October)</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mm <span class="op">==</span> <span class="st">"1"</span>:</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> <span class="bu">int</span>(mm)</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Timestamp(year<span class="op">=</span>year, month<span class="op">=</span>month, day<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load CAPE CSV ---</span></span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>sp500_cape_raw <span class="op">=</span> pd.read_csv(<span class="st">"data/sp500-cape-1990-2025.csv"</span>)</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean + parse</span></span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>sp500_cape_raw[<span class="st">"date"</span>] <span class="op">=</span> sp500_cape_raw[<span class="st">"Date"</span>].<span class="bu">apply</span>(parse_yyyy_mm_to_date)</span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>sp500_cape_raw <span class="op">=</span> (</span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>    sp500_cape_raw[[<span class="st">"date"</span>, <span class="st">"SP500"</span>, <span class="st">"CAPE"</span>]]</span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>    .set_index(<span class="st">"date"</span>)</span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a>    .sort_index()</span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to month-end aligned CAPE series</span></span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>sp500_cape_m <span class="op">=</span> sp500_cape_raw.resample(<span class="st">"M"</span>).last()</span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>sp500_cape_m.rename(columns<span class="op">=</span>{<span class="st">"CAPE"</span>: <span class="st">"cape"</span>, <span class="st">"SP500"</span>: <span class="st">"sp500"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>sp500_cape_m.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="421">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sp500</th>
<th data-quarto-table-cell-role="th">cape</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>6408.95</td>
<td>37.85</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>6584.02</td>
<td>38.58</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>6735.69</td>
<td>39.21</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>6740.89</td>
<td>39.12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-12-31</th>
<td>6812.63</td>
<td>39.42</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="from-valuation-levels-into-a-spread-series" class="level3">
<h3 class="anchored" data-anchor-id="from-valuation-levels-into-a-spread-series">From valuation levels into a spread series</h3>
<p><strong>Long-Term Average/Median</strong>: The S&amp;P 500’s historical long-term average CAPE ratio is around 16-18, with a median value of approximately 16.04 (since 1881). This provides a central benchmark.</p>
<p><strong>High Valuation (Expensive)</strong>: A CAPE ratio that is notably higher than the historical average (e.g., above 25 or 30) is considered indicative of a highly valued or overvalued market. Historically, values exceeding 30 have only occurred during major market peaks like the 1929 crash, the dot-com bubble in the late 1990s (peaking over 44), and the post-pandemic period around 2021. Such high readings have typically been followed by periods of lower-than-average, or even negative, long-term returns.</p>
<p><strong>Low Valuation (Cheap)</strong>: A CAPE ratio well below the historical average (e.g., below 15 or 10) suggests an undervalued or cheap market. Historically, such levels have been associated with minimal downside risk and higher average long-term returns.</p>
<p>Could have calculated</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>V_spread <span class="op">=</span> (x <span class="op">-</span> baseline) <span class="op">/</span> baseline <span class="co"># baseline = 16</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Problem is, if the whole world “structurally” shifted (e.g.&nbsp;post-1990 lower inflation), “16” stops being meaningful.</p>
<p>We are instead measuring,</p>
<p><span class="math display">\[
V_t = \frac{CAPE_t - \mathrm{median}(CAPE)}{\mathrm{IQR}(CAPE)}
\]</span></p>
<div id="745a0ebb-debe-4362-bb3a-cc6077a4e579" class="cell" data-execution_count="422">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_valuation_spread_baseline(</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    val_df: pd.DataFrame,</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    metric: <span class="bu">str</span> <span class="op">=</span> <span class="st">"cape"</span>,</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    baseline: <span class="bu">float</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    scale: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> val_df[metric].astype(<span class="bu">float</span>)</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> baseline <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># robust long-run baseline</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>        median <span class="op">=</span> x.median()</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>        iqr <span class="op">=</span> x.quantile(<span class="fl">0.75</span>) <span class="op">-</span> x.quantile(<span class="fl">0.25</span>)</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>        baseline <span class="op">=</span> median</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>        denom <span class="op">=</span> iqr <span class="cf">if</span> scale <span class="kw">and</span> iqr <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> baseline</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>        denom <span class="op">=</span> baseline <span class="cf">if</span> scale <span class="cf">else</span> <span class="fl">1.0</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    diff <span class="op">=</span> x <span class="op">-</span> baseline          </span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>    V_spread <span class="op">=</span> diff <span class="op">/</span> denom <span class="cf">if</span> scale <span class="cf">else</span> diff</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>    V_spread.name <span class="op">=</span> <span class="st">"V_spread"</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> V_spread</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: baseline at 16.04 (long-run median)</span></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>V_spread_t <span class="op">=</span> build_valuation_spread_baseline(</span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>    sp500_cape_m,</span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>    metric<span class="op">=</span><span class="st">"cape"</span>,</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>    baseline<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>    scale<span class="op">=</span><span class="va">True</span>,   <span class="co"># or False if you prefer "CAPE points below baseline"</span></span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>V_spread_t.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="422">
<pre><code>date
2025-08-31    1.259380
2025-09-30    1.338771
2025-10-31    1.407287
2025-11-30    1.397499
2025-12-31    1.430125
Freq: M, Name: V_spread, dtype: float64</code></pre>
</div>
</div>
<div id="6282aefb-ae21-417a-ae12-ffd396d934f2" class="cell" data-execution_count="423">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>V_spread_t.plot(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">4</span>), title<span class="op">=</span><span class="st">"S&amp;P 500 Valuation Spread (cheap vs own history)"</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">0</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-62-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="combine-liquidity-regime-with-valuation-spread" class="level3">
<h3 class="anchored" data-anchor-id="combine-liquidity-regime-with-valuation-spread">Combine Liquidity Regime with Valuation Spread</h3>
<div id="2ec0b08b-a4df-4a55-9964-71cd2dabebc0" class="cell" data-execution_count="424">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>regimes_df.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="424">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">p_state_2</th>
<th data-quarto-table-cell-role="th">state_label</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>-1.384971</td>
<td>2</td>
<td>1.763643e-10</td>
<td>3.461616e-08</td>
<td>1.000000</td>
<td>Tight</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-1.481025</td>
<td>2</td>
<td>4.213931e-09</td>
<td>1.477532e-08</td>
<td>1.000000</td>
<td>Tight</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-1.480004</td>
<td>2</td>
<td>1.745053e-07</td>
<td>1.492070e-08</td>
<td>1.000000</td>
<td>Tight</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-1.248705</td>
<td>2</td>
<td>7.336618e-06</td>
<td>1.134537e-07</td>
<td>0.999993</td>
<td>Tight</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>-1.620391</td>
<td>2</td>
<td>2.921088e-04</td>
<td>2.068795e-07</td>
<td>0.999708</td>
<td>Tight</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="9c8d3fa4-d031-443e-b53b-ccb287f201d5" class="cell" data-execution_count="425">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>combined_aug.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="425">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">state_label</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>-2.880509</td>
<td>1</td>
<td>1.340116e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0606</td>
<td>-0.0072</td>
<td>-0.0288</td>
<td>0.0129</td>
<td>0.0251</td>
<td>0.0038</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>-2.709857</td>
<td>1</td>
<td>2.610193e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0161</td>
<td>-0.0320</td>
<td>0.0144</td>
<td>0.0034</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-2.689149</td>
<td>1</td>
<td>2.839775e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-2.606319</td>
<td>1</td>
<td>4.195012e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0067</td>
<td>0.0208</td>
<td>0.0038</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-2.418377</td>
<td>1</td>
<td>4.483466e-05</td>
<td>0.999955</td>
<td>Tight</td>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="bad8b500-2a2c-4c59-848c-78531eb4d95b" class="cell" data-execution_count="426">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># regimes_df: index is month-end</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> combined_aug.copy()</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>reg.index <span class="op">=</span> reg.index.to_period(<span class="st">"M"</span>).to_timestamp(<span class="st">"M"</span>)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Align valuation spread to month-end, then join</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>V_spread_m <span class="op">=</span> V_spread_t.resample(<span class="st">"M"</span>).last()</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>combined_aug_val <span class="op">=</span> (</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    reg</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    .join(V_spread_m.to_frame(), how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>combined_aug_val.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="426">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">state_label</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
<th data-quarto-table-cell-role="th">V_spread</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>-2.880509</td>
<td>1</td>
<td>1.340116e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0606</td>
<td>-0.0072</td>
<td>-0.0288</td>
<td>0.0129</td>
<td>0.0251</td>
<td>0.0038</td>
<td>0.958129</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>-2.709857</td>
<td>1</td>
<td>2.610193e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0161</td>
<td>-0.0320</td>
<td>0.0144</td>
<td>0.0034</td>
<td>1.070147</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-2.689149</td>
<td>1</td>
<td>2.839775e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
<td>1.218053</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-2.606319</td>
<td>1</td>
<td>4.195012e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0067</td>
<td>0.0208</td>
<td>0.0038</td>
<td>1.259380</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-2.418377</td>
<td>1</td>
<td>4.483466e-05</td>
<td>0.999955</td>
<td>Tight</td>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
<td>1.338771</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="ed036a16-eb6e-4b16-bceb-f9f8fb2f7dc0" class="cell" data-execution_count="413">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cart_with_valuation_3d(combined_aug, sp500_cape_m):</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Three-dimensional CART: Liquidity × Volatility × Valuation</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co">    This should resolve the 2010-2014 and 2023-2024 anomalies.</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> combined_aug.copy()</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'L_std'</span>] <span class="op">=</span> df[<span class="st">'L'</span>] <span class="op">/</span> df[<span class="st">'L'</span>].std()</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build valuation spread</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> sp500_cape_m[<span class="st">'cape'</span>].astype(<span class="bu">float</span>)</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>    median <span class="op">=</span> x.median()</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>    iqr <span class="op">=</span> x.quantile(<span class="fl">0.75</span>) <span class="op">-</span> x.quantile(<span class="fl">0.25</span>)</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>    V_spread <span class="op">=</span> (x <span class="op">-</span> median) <span class="op">/</span> iqr</span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>    V_spread.name <span class="op">=</span> <span class="st">"V_spread"</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align to month-end</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>    V_spread_m <span class="op">=</span> V_spread.resample(<span class="st">"M"</span>).last()</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crisis Detection</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"3D CART: Liquidity × Volatility × Valuation"</span>)</span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ret_vol'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>).std()</span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'L_vol'</span>] <span class="op">=</span> df[<span class="st">'L_std'</span>].rolling(<span class="dv">3</span>).std()</span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'abs_ret'</span>] <span class="op">=</span> df[<span class="st">'mkt_excess'</span>].<span class="bu">abs</span>()</span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'cum_ret_3m'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">'mkt_excess'</span>]).rolling(<span class="dv">3</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.prod()) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>    crisis_features <span class="op">=</span> df[[<span class="st">'ret_vol'</span>, <span class="st">'abs_ret'</span>, <span class="st">'cum_ret_3m'</span>, <span class="st">'L_vol'</span>]].dropna()</span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.ensemble <span class="im">import</span> IsolationForest</span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>    iso_forest <span class="op">=</span> IsolationForest(contamination<span class="op">=</span><span class="fl">0.05</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a>    outlier_labels <span class="op">=</span> iso_forest.fit_predict(crisis_features.values)</span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_crisis'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a>    df.loc[crisis_features.index, <span class="st">'is_crisis'</span>] <span class="op">=</span> (outlier_labels <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>) <span class="op">&amp;</span> (df.loc[crisis_features.index, <span class="st">'mkt_excess'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.02</span>)</span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Crisis months: </span><span class="sc">{</span>df[<span class="st">'is_crisis'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join Valuation</span></span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a>    df_normal <span class="op">=</span> df[<span class="op">~</span>df[<span class="st">'is_crisis'</span>]].copy()</span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a>    df_with_val <span class="op">=</span> df_normal.join(V_spread_m.to_frame(), how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Data with valuation: </span><span class="sc">{</span><span class="bu">len</span>(df_with_val)<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean data</span></span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a>    df_clean <span class="op">=</span> df_with_val[[<span class="st">'L_std'</span>, <span class="st">'ret_vol'</span>, <span class="st">'V_spread'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]].dropna()</span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Clean data: </span><span class="sc">{</span><span class="bu">len</span>(df_clean)<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Valuation spread stats:"</span>)</span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean: </span><span class="sc">{</span>df_clean[<span class="st">'V_spread'</span>]<span class="sc">.</span>mean()<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Std:  </span><span class="sc">{</span>df_clean[<span class="st">'V_spread'</span>]<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Min:  </span><span class="sc">{</span>df_clean[<span class="st">'V_spread'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Max:  </span><span class="sc">{</span>df_clean[<span class="st">'V_spread'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create Target</span></span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a>    hml_quantiles <span class="op">=</span> pd.qcut(df_clean[<span class="st">'hml'</span>], q<span class="op">=</span><span class="dv">3</span>, labels<span class="op">=</span>[<span class="st">'Growth'</span>, <span class="st">'Neutral'</span>, <span class="st">'Value'</span>])</span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a>    df_clean[<span class="st">'target'</span>] <span class="op">=</span> hml_quantiles</span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Target distribution:"</span>)</span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df_clean[<span class="st">'target'</span>].value_counts())</span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train 3D CART</span></span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TRAINING 3D CART"</span>)</span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># THREE features now: L_std, ret_vol, V_spread</span></span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df_clean[[<span class="st">'L_std'</span>, <span class="st">'ret_vol'</span>, <span class="st">'V_spread'</span>]].values</span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df_clean[<span class="st">'target'</span>].values</span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeClassifier, export_text</span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-82"><a href="#cb98-82" aria-hidden="true" tabindex="-1"></a>    cart_3d <span class="op">=</span> DecisionTreeClassifier(</span>
<span id="cb98-83"><a href="#cb98-83" aria-hidden="true" tabindex="-1"></a>        max_depth<span class="op">=</span><span class="dv">4</span>,  <span class="co"># Deeper tree for 3 dimensions</span></span>
<span id="cb98-84"><a href="#cb98-84" aria-hidden="true" tabindex="-1"></a>        min_samples_leaf<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb98-85"><a href="#cb98-85" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb98-86"><a href="#cb98-86" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-87"><a href="#cb98-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-88"><a href="#cb98-88" aria-hidden="true" tabindex="-1"></a>    cart_3d.fit(X, y)</span>
<span id="cb98-89"><a href="#cb98-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-90"><a href="#cb98-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Learned Decision Rules:"</span>)</span>
<span id="cb98-91"><a href="#cb98-91" aria-hidden="true" tabindex="-1"></a>    tree_rules <span class="op">=</span> export_text(cart_3d, feature_names<span class="op">=</span>[<span class="st">'L_std'</span>, <span class="st">'ret_vol'</span>, <span class="st">'V_spread'</span>])</span>
<span id="cb98-92"><a href="#cb98-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(tree_rules)</span>
<span id="cb98-93"><a href="#cb98-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-94"><a href="#cb98-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature Importance:"</span>)</span>
<span id="cb98-95"><a href="#cb98-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, feat <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">'L_std'</span>, <span class="st">'ret_vol'</span>, <span class="st">'V_spread'</span>]):</span>
<span id="cb98-96"><a href="#cb98-96" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>feat<span class="sc">:12s}</span><span class="ss">: </span><span class="sc">{</span>cart_3d<span class="sc">.</span>feature_importances_[i]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb98-97"><a href="#cb98-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-98"><a href="#cb98-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-99"><a href="#cb98-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predictions</span></span>
<span id="cb98-100"><a href="#cb98-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-101"><a href="#cb98-101" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> cart_3d.predict(X)</span>
<span id="cb98-102"><a href="#cb98-102" aria-hidden="true" tabindex="-1"></a>    df_clean[<span class="st">'cart_prediction'</span>] <span class="op">=</span> predictions</span>
<span id="cb98-103"><a href="#cb98-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-104"><a href="#cb98-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-105"><a href="#cb98-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Characterize Classes</span></span>
<span id="cb98-106"><a href="#cb98-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-107"><a href="#cb98-107" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb98-108"><a href="#cb98-108" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"REGIME CHARACTERIZATION (3D)"</span>)</span>
<span id="cb98-109"><a href="#cb98-109" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb98-110"><a href="#cb98-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-111"><a href="#cb98-111" aria-hidden="true" tabindex="-1"></a>    regime_chars <span class="op">=</span> []</span>
<span id="cb98-112"><a href="#cb98-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-113"><a href="#cb98-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pred_class <span class="kw">in</span> [<span class="st">'Growth'</span>, <span class="st">'Neutral'</span>, <span class="st">'Value'</span>]:</span>
<span id="cb98-114"><a href="#cb98-114" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> df_clean[<span class="st">'cart_prediction'</span>] <span class="op">==</span> pred_class</span>
<span id="cb98-115"><a href="#cb98-115" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> df_clean[mask]</span>
<span id="cb98-116"><a href="#cb98-116" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-117"><a href="#cb98-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(subset) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb98-118"><a href="#cb98-118" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb98-119"><a href="#cb98-119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-120"><a href="#cb98-120" aria-hidden="true" tabindex="-1"></a>        char <span class="op">=</span> {</span>
<span id="cb98-121"><a href="#cb98-121" aria-hidden="true" tabindex="-1"></a>            <span class="st">'class'</span>: pred_class,</span>
<span id="cb98-122"><a href="#cb98-122" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n'</span>: <span class="bu">len</span>(subset),</span>
<span id="cb98-123"><a href="#cb98-123" aria-hidden="true" tabindex="-1"></a>            <span class="st">'L_std'</span>: subset[<span class="st">'L_std'</span>].mean(),</span>
<span id="cb98-124"><a href="#cb98-124" aria-hidden="true" tabindex="-1"></a>            <span class="st">'vol'</span>: subset[<span class="st">'ret_vol'</span>].mean(),</span>
<span id="cb98-125"><a href="#cb98-125" aria-hidden="true" tabindex="-1"></a>            <span class="st">'V_spread'</span>: subset[<span class="st">'V_spread'</span>].mean(),</span>
<span id="cb98-126"><a href="#cb98-126" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hml'</span>: subset[<span class="st">'hml'</span>].mean() <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb98-127"><a href="#cb98-127" aria-hidden="true" tabindex="-1"></a>            <span class="st">'rmw'</span>: subset[<span class="st">'rmw'</span>].mean() <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb98-128"><a href="#cb98-128" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cma'</span>: subset[<span class="st">'cma'</span>].mean() <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb98-129"><a href="#cb98-129" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb98-130"><a href="#cb98-130" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-131"><a href="#cb98-131" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Economic interpretation</span></span>
<span id="cb98-132"><a href="#cb98-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> char[<span class="st">'L_std'</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>:</span>
<span id="cb98-133"><a href="#cb98-133" aria-hidden="true" tabindex="-1"></a>            liq <span class="op">=</span> <span class="st">"High_Liq"</span></span>
<span id="cb98-134"><a href="#cb98-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> char[<span class="st">'L_std'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.5</span>:</span>
<span id="cb98-135"><a href="#cb98-135" aria-hidden="true" tabindex="-1"></a>            liq <span class="op">=</span> <span class="st">"Tight_Liq"</span></span>
<span id="cb98-136"><a href="#cb98-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb98-137"><a href="#cb98-137" aria-hidden="true" tabindex="-1"></a>            liq <span class="op">=</span> <span class="st">"Neutral_Liq"</span></span>
<span id="cb98-138"><a href="#cb98-138" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-139"><a href="#cb98-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> char[<span class="st">'V_spread'</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>:</span>
<span id="cb98-140"><a href="#cb98-140" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> <span class="st">"Expensive"</span></span>
<span id="cb98-141"><a href="#cb98-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> char[<span class="st">'V_spread'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.5</span>:</span>
<span id="cb98-142"><a href="#cb98-142" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> <span class="st">"Cheap"</span></span>
<span id="cb98-143"><a href="#cb98-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb98-144"><a href="#cb98-144" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> <span class="st">"Fair"</span></span>
<span id="cb98-145"><a href="#cb98-145" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-146"><a href="#cb98-146" aria-hidden="true" tabindex="-1"></a>        regime <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>liq<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>val<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb98-147"><a href="#cb98-147" aria-hidden="true" tabindex="-1"></a>        char[<span class="st">'regime'</span>] <span class="op">=</span> regime</span>
<span id="cb98-148"><a href="#cb98-148" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-149"><a href="#cb98-149" aria-hidden="true" tabindex="-1"></a>        regime_chars.append(char)</span>
<span id="cb98-150"><a href="#cb98-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-151"><a href="#cb98-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print table</span></span>
<span id="cb98-152"><a href="#cb98-152" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'Class'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Regime'</span><span class="sc">:&lt;25}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'N'</span><span class="sc">:&lt;5}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'L_std'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'V_spread'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'HML%'</span><span class="sc">:&lt;8}</span><span class="ss">"</span>)</span>
<span id="cb98-153"><a href="#cb98-153" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">85</span>)</span>
<span id="cb98-154"><a href="#cb98-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-155"><a href="#cb98-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> char <span class="kw">in</span> <span class="bu">sorted</span>(regime_chars, key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'hml'</span>], reverse<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb98-156"><a href="#cb98-156" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>char[<span class="st">'class'</span>]<span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span>char[<span class="st">'regime'</span>]<span class="sc">:&lt;25}</span><span class="ss"> </span><span class="sc">{</span>char[<span class="st">'n'</span>]<span class="sc">:&lt;5}</span><span class="ss"> "</span></span>
<span id="cb98-157"><a href="#cb98-157" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>char[<span class="st">'L_std'</span>]<span class="sc">:&gt;+6.2f}</span><span class="ss">  </span><span class="sc">{</span>char[<span class="st">'V_spread'</span>]<span class="sc">:&gt;+8.2f}</span><span class="ss">  </span><span class="sc">{</span>char[<span class="st">'hml'</span>]<span class="sc">:&gt;+6.2f}</span><span class="ss">"</span>)</span>
<span id="cb98-158"><a href="#cb98-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-159"><a href="#cb98-159" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-160"><a href="#cb98-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validation</span></span>
<span id="cb98-161"><a href="#cb98-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb98-162"><a href="#cb98-162" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb98-163"><a href="#cb98-163" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"VALIDATION: Known Periods"</span>)</span>
<span id="cb98-164"><a href="#cb98-164" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb98-165"><a href="#cb98-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-166"><a href="#cb98-166" aria-hidden="true" tabindex="-1"></a>    known <span class="op">=</span> {</span>
<span id="cb98-167"><a href="#cb98-167" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2010-2014 QE'</span>: (<span class="st">'2010-01'</span>, <span class="st">'2014-12'</span>),</span>
<span id="cb98-168"><a href="#cb98-168" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2015-2019 Late Cycle'</span>: (<span class="st">'2015-01'</span>, <span class="st">'2019-12'</span>),</span>
<span id="cb98-169"><a href="#cb98-169" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2020-2021 Reopening'</span>: (<span class="st">'2020-05'</span>, <span class="st">'2021-12'</span>),</span>
<span id="cb98-170"><a href="#cb98-170" aria-hidden="true" tabindex="-1"></a>        <span class="st">'2022-2024 QT'</span>: (<span class="st">'2022-03'</span>, <span class="st">'2024-12'</span>),</span>
<span id="cb98-171"><a href="#cb98-171" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb98-172"><a href="#cb98-172" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-173"><a href="#cb98-173" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> label, (start, end) <span class="kw">in</span> known.items():</span>
<span id="cb98-174"><a href="#cb98-174" aria-hidden="true" tabindex="-1"></a>        period <span class="op">=</span> df_clean.loc[start:end]</span>
<span id="cb98-175"><a href="#cb98-175" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-176"><a href="#cb98-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(period) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb98-177"><a href="#cb98-177" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb98-178"><a href="#cb98-178" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-179"><a href="#cb98-179" aria-hidden="true" tabindex="-1"></a>        dist <span class="op">=</span> period[<span class="st">'cart_prediction'</span>].value_counts()</span>
<span id="cb98-180"><a href="#cb98-180" aria-hidden="true" tabindex="-1"></a>        mode <span class="op">=</span> dist.idxmax()</span>
<span id="cb98-181"><a href="#cb98-181" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-182"><a href="#cb98-182" aria-hidden="true" tabindex="-1"></a>        mean_L <span class="op">=</span> period[<span class="st">'L_std'</span>].mean()</span>
<span id="cb98-183"><a href="#cb98-183" aria-hidden="true" tabindex="-1"></a>        mean_V <span class="op">=</span> period[<span class="st">'V_spread'</span>].mean()</span>
<span id="cb98-184"><a href="#cb98-184" aria-hidden="true" tabindex="-1"></a>        mean_hml <span class="op">=</span> period[<span class="st">'hml'</span>].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb98-185"><a href="#cb98-185" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb98-186"><a href="#cb98-186" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb98-187"><a href="#cb98-187" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Classified: </span><span class="sc">{</span>mode<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>dist<span class="sc">.</span>get(mode, <span class="dv">0</span>)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(period)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb98-188"><a href="#cb98-188" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  L_std=</span><span class="sc">{</span>mean_L<span class="sc">:+.2f}</span><span class="ss">, V_spread=</span><span class="sc">{</span>mean_V<span class="sc">:+.2f}</span><span class="ss">, HML=</span><span class="sc">{</span>mean_hml<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb98-189"><a href="#cb98-189" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Distribution: </span><span class="sc">{</span>dist<span class="sc">.</span>to_dict()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb98-190"><a href="#cb98-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-191"><a href="#cb98-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_clean, cart_3d, regime_chars</span>
<span id="cb98-192"><a href="#cb98-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-193"><a href="#cb98-193" aria-hidden="true" tabindex="-1"></a><span class="co"># RUN 3D CART</span></span>
<span id="cb98-194"><a href="#cb98-194" aria-hidden="true" tabindex="-1"></a>df_3d, cart_3d_model, chars_3d <span class="op">=</span> cart_with_valuation_3d(combined_aug_mom, sp500_cape_m)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
3D CART: Liquidity × Volatility × Valuation
================================================================================
Crisis months: 5

Data with valuation: 256 months
Clean data: 251 months

Valuation spread stats:
  Mean: +0.10
  Std:  0.56
  Min:  -1.41
  Max:  +1.34

Target distribution:
target
Growth     85
Value      84
Neutral    82
Name: count, dtype: int64

================================================================================
TRAINING 3D CART
================================================================================

Learned Decision Rules:
|--- V_spread &lt;= 0.04
|   |--- ret_vol &lt;= 0.02
|   |   |--- class: Value
|   |--- ret_vol &gt;  0.02
|   |   |--- ret_vol &lt;= 0.03
|   |   |   |--- class: Neutral
|   |   |--- ret_vol &gt;  0.03
|   |   |   |--- V_spread &lt;= -0.63
|   |   |   |   |--- class: Growth
|   |   |   |--- V_spread &gt;  -0.63
|   |   |   |   |--- class: Value
|--- V_spread &gt;  0.04
|   |--- V_spread &lt;= 0.82
|   |   |--- L_std &lt;= 0.10
|   |   |   |--- ret_vol &lt;= 0.05
|   |   |   |   |--- class: Growth
|   |   |   |--- ret_vol &gt;  0.05
|   |   |   |   |--- class: Growth
|   |   |--- L_std &gt;  0.10
|   |   |   |--- class: Growth
|   |--- V_spread &gt;  0.82
|   |   |--- class: Value


Feature Importance:
  L_std       : 0.172
  ret_vol     : 0.298
  V_spread    : 0.530

================================================================================
REGIME CHARACTERIZATION (3D)
================================================================================

Class      Regime                    N     L_std    V_spread   HML%    
-------------------------------------------------------------------------------------
Value      Neutral_Liq_Fair          111    +0.12     +0.14   +0.76
Neutral    Neutral_Liq_Fair          23     +0.07     -0.18   -0.38
Growth     Neutral_Liq_Fair          117    -0.23     +0.12   -0.56

================================================================================
VALIDATION: Known Periods
================================================================================

2010-2014 QE:
  Classified: Value (34/60)
  L_std=+0.46, V_spread=-0.41, HML=-0.05%
  Distribution: {'Value': 34, 'Neutral': 14, 'Growth': 12}

2015-2019 Late Cycle:
  Classified: Growth (45/60)
  L_std=-0.13, V_spread=+0.25, HML=-0.34%
  Distribution: {'Growth': 45, 'Value': 14, 'Neutral': 1}

2020-2021 Reopening:
  Classified: Value (12/20)
  L_std=+1.73, V_spread=+0.88, HML=+0.58%
  Distribution: {'Value': 12, 'Growth': 8}

2022-2024 QT:
  Classified: Growth (25/34)
  L_std=-1.06, V_spread=+0.57, HML=-0.12%
  Distribution: {'Growth': 25, 'Value': 9}</code></pre>
</div>
</div>
<div id="7c4afd98-84da-4aab-943d-66eff5398ede" class="cell" data-execution_count="427">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>combined_aug_val.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="427">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">state_label</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
<th data-quarto-table-cell-role="th">V_spread</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>-2.880509</td>
<td>1</td>
<td>1.340116e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0606</td>
<td>-0.0072</td>
<td>-0.0288</td>
<td>0.0129</td>
<td>0.0251</td>
<td>0.0038</td>
<td>0.958129</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>-2.709857</td>
<td>1</td>
<td>2.610193e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0161</td>
<td>-0.0320</td>
<td>0.0144</td>
<td>0.0034</td>
<td>1.070147</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-2.689149</td>
<td>1</td>
<td>2.839775e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
<td>1.218053</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-2.606319</td>
<td>1</td>
<td>4.195012e-07</td>
<td>1.000000</td>
<td>Tight</td>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0067</td>
<td>0.0208</td>
<td>0.0038</td>
<td>1.259380</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-2.418377</td>
<td>1</td>
<td>4.483466e-05</td>
<td>0.999955</td>
<td>Tight</td>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
<td>1.338771</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="e02704b8-f456-431d-a2eb-76344b742409" class="cell" data-execution_count="432">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_liquidity_predicts_valuation(combined_aug):</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Test if L(t) predicts V_spread(t+k) using Granger causality.</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TEST 1: Does Liquidity Predict Future Valuation?"</span>)</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> combined_aug.copy()</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test different lags</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lag <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">24</span>]:</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>        df[<span class="ss">f'V_lead_</span><span class="sc">{</span>lag<span class="sc">}</span><span class="ss">m'</span>] <span class="op">=</span> df[<span class="st">'V_spread'</span>].shift(<span class="op">-</span>lag)</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Clean data</span></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> df[[<span class="st">'L'</span>, <span class="ss">f'V_lead_</span><span class="sc">{</span>lag<span class="sc">}</span><span class="ss">m'</span>]].dropna()</span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Regression: V(t+k) = α + β*L(t) + ε</span></span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> scipy.stats <span class="im">import</span> pearsonr, linregress</span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>        slope, intercept, r_value, p_value, std_err <span class="op">=</span> linregress(</span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>            valid[<span class="st">'L'</span>], </span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>            valid[<span class="ss">f'V_lead_</span><span class="sc">{</span>lag<span class="sc">}</span><span class="ss">m'</span>]</span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a>        r_squared <span class="op">=</span> r_value <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Lag = </span><span class="sc">{</span>lag<span class="sc">}</span><span class="ss"> months:"</span>)</span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  L(t) → V(t+</span><span class="sc">{</span>lag<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Coefficient: </span><span class="sc">{</span>slope<span class="sc">:+.3f}</span><span class="ss">"</span>)</span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  R²: </span><span class="sc">{</span>r_squared<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  p-value: </span><span class="sc">{</span>p_value<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> p_value <span class="op">&lt;</span> <span class="fl">0.05</span>:</span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  ✅ Liquidity DOES predict valuation </span><span class="sc">{</span>lag<span class="sc">}</span><span class="ss"> months ahead!"</span>)</span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  ❌ No significant relationship"</span>)</span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a>test_liquidity_predicts_valuation(combined_aug_val)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
TEST 1: Does Liquidity Predict Future Valuation?
================================================================================

Lag = 3 months:
  L(t) → V(t+3)
  Coefficient: -0.088
  R²: 0.070
  p-value: 0.0000
  ✅ Liquidity DOES predict valuation 3 months ahead!

Lag = 6 months:
  L(t) → V(t+6)
  Coefficient: -0.089
  R²: 0.071
  p-value: 0.0000
  ✅ Liquidity DOES predict valuation 6 months ahead!

Lag = 12 months:
  L(t) → V(t+12)
  Coefficient: -0.070
  R²: 0.040
  p-value: 0.0012
  ✅ Liquidity DOES predict valuation 12 months ahead!

Lag = 24 months:
  L(t) → V(t+24)
  Coefficient: +0.032
  R²: 0.006
  p-value: 0.2076
  ❌ No significant relationship</code></pre>
</div>
</div>
<div id="be20d135-bcde-43ca-ad71-11f4d91b392a" class="cell" data-execution_count="434">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> granger_liquidity_to_valuation(df, max_lag<span class="op">=</span><span class="dv">24</span>):</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Proper Granger causality test:</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Does L Granger-cause V_spread?</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> statsmodels.tsa.stattools <span class="im">import</span> grangercausalitytests</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">90</span>)</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"GRANGER CAUSALITY TEST: L → V_spread"</span>)</span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">90</span>)</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only required columns</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> df[[<span class="st">'V_spread'</span>, <span class="st">'L'</span>]].dropna()</span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># statsmodels expects: [target, predictor]</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test whether L causes V_spread</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> grangercausalitytests(</span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>        data,</span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>        maxlag<span class="op">=</span>max_lag,</span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="va">False</span></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Lag | F-stat p-value | χ² p-value | Verdict"</span>)</span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span><span class="op">*</span><span class="dv">70</span>)</span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lag <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, max_lag <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a>        f_pval <span class="op">=</span> results[lag][<span class="dv">0</span>][<span class="st">'ssr_ftest'</span>][<span class="dv">1</span>]</span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a>        chi2_pval <span class="op">=</span> results[lag][<span class="dv">0</span>][<span class="st">'ssr_chi2test'</span>][<span class="dv">1</span>]</span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a>        verdict <span class="op">=</span> <span class="st">"✅ YES"</span> <span class="cf">if</span> f_pval <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="cf">else</span> <span class="st">"❌ NO"</span></span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>lag<span class="sc">:&gt;3}</span><span class="ss"> | </span><span class="sc">{</span>f_pval<span class="sc">:&gt;13.4f}</span><span class="ss"> | </span><span class="sc">{</span>chi2_pval<span class="sc">:&gt;11.4f}</span><span class="ss"> | </span><span class="sc">{</span>verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-37"><a href="#cb103-37" aria-hidden="true" tabindex="-1"></a>granger_liquidity_to_valuation(combined_aug_val, max_lag<span class="op">=</span><span class="dv">24</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>==========================================================================================
GRANGER CAUSALITY TEST: L → V_spread
==========================================================================================

Lag | F-stat p-value | χ² p-value | Verdict
----------------------------------------------------------------------
  1 |        0.0899 |      0.0870 | ❌ NO
  2 |        0.3760 |      0.3678 | ❌ NO
  3 |        0.4680 |      0.4547 | ❌ NO
  4 |        0.5816 |      0.5640 | ❌ NO
  5 |        0.5879 |      0.5636 | ❌ NO
  6 |        0.5844 |      0.5522 | ❌ NO
  7 |        0.7117 |      0.6789 | ❌ NO
  8 |        0.6999 |      0.6582 | ❌ NO
  9 |        0.6900 |      0.6385 | ❌ NO
 10 |        0.8036 |      0.7585 | ❌ NO
 11 |        0.8664 |      0.8266 | ❌ NO
 12 |        0.8785 |      0.8352 | ❌ NO
 13 |        0.8521 |      0.7936 | ❌ NO
 14 |        0.8598 |      0.7951 | ❌ NO
 15 |        0.8944 |      0.8348 | ❌ NO
 16 |        0.9224 |      0.8691 | ❌ NO
 17 |        0.8087 |      0.6924 | ❌ NO
 18 |        0.8156 |      0.6886 | ❌ NO
 19 |        0.8553 |      0.7343 | ❌ NO
 20 |        0.8645 |      0.7355 | ❌ NO
 21 |        0.9428 |      0.8657 | ❌ NO
 22 |        0.9325 |      0.8348 | ❌ NO
 23 |        0.9342 |      0.8273 | ❌ NO
 24 |        0.9138 |      0.7700 | ❌ NO</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/dbose/anaconda3/envs/py-data/lib/python3.8/site-packages/statsmodels/tsa/stattools.py:1545: FutureWarning: verbose is deprecated since functions should not print results
  warnings.warn(</code></pre>
</div>
</div>
</section>
<section id="regime-conditional-valuation-spreads" class="level3">
<h3 class="anchored" data-anchor-id="regime-conditional-valuation-spreads">Regime-conditional valuation spreads</h3>
</section>
<section id="valuation-spreads-factor-returns-by-regime-math" class="level3">
<h3 class="anchored" data-anchor-id="valuation-spreads-factor-returns-by-regime-math">Valuation Spreads &amp; Factor Returns by Regime Math</h3>
<p>(Valuation spread series, e.g.&nbsp;top–bottom decile)</p>
<p>$ V_t^{} $</p>
<p>(Regime-conditional mean valuation spread)</p>
<p>$ {V}^{(k)} = $</p>
<p>$ ^{(k)} = {_{t=1}^T (_t = k)} $</p>
<p>(Difference in spreads between regimes)</p>
<p>$ ^{()} - ^{()} $</p>
<p>(Factor return in regime ( k ))</p>
<p>$ r_t^{(F)} $</p>
<p>$ {r}_F^{(k)} = $</p>
<p>$ <em>F^{(k)} = {</em>{t=1}^T (_t = k)} $</p>
<p>(Regime-specific Sharpe ratio)</p>
<p>$ _F^{(k)} = $</p>
<div id="e9f8084a-a26b-41f1-bd41-d8fed797c02b" class="cell" data-execution_count="124">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Regime-conditional mean valuation spread:  V̄^(k)</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>val_means_by_regime <span class="op">=</span> (</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    combined_aug_val</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"state_label"</span>)[<span class="st">"V_spread"</span>]</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>val_stds_by_regime <span class="op">=</span> (</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    combined_aug_val</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"state_label"</span>)[<span class="st">"V_spread"</span>]</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    .std()</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Regime-conditional mean valuation spread:"</span>)</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(val_means_by_regime)</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Regime-conditional valuation z-score std dev:"</span>)</span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(val_stds_by_regime)</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Difference in spreads between regimes:  V̂^(High) − V̂^(Tight)</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> {<span class="st">"High"</span>, <span class="st">"Tight"</span>}.issubset(val_means_by_regime.index):</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>    spread_diff <span class="op">=</span> (</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>        val_means_by_regime[<span class="st">"High"</span>] <span class="op">-</span> val_means_by_regime[<span class="st">"Tight"</span>]</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Difference in spreads High − Tight:"</span>)</span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(spread_diff)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Regime-conditional mean valuation spread:
state_label
High    -0.049269
Tight    0.419617
Name: V_spread, dtype: float64

Regime-conditional valuation z-score std dev:
state_label
High     0.551632
Tight    0.438484
Name: V_spread, dtype: float64

Difference in spreads High − Tight:
-0.4688859970837499</code></pre>
</div>
</div>
</section>
<section id="insigts" class="level3">
<h3 class="anchored" data-anchor-id="insigts">Insigts</h3>
<ul>
<li>Tight liquidity = cheaper markets (value regime),</li>
<li>High liquidity = expensive markets (growth regime).</li>
</ul>
<blockquote class="blockquote">
<p>Markets are ~0.43σ more expensive in High liquidity regimes than Tight liquidity regimes.</p>
</blockquote>
</section>
<section id="plot-lt-sp-500-and-v_spread_t-together-with-regime-shading" class="level3">
<h3 class="anchored" data-anchor-id="plot-lt-sp-500-and-v_spread_t-together-with-regime-shading">Plot L(t), S&amp;P 500, and V_spread_t together with regime shading,</h3>
<div id="a95682e0-35ca-4a72-9d77-cd3280ed8f7d" class="cell" data-execution_count="125">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume you already have:</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   L_t              : pd.Series (liquidity index), monthly, name "L"</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   sp500_cape_m     : DataFrame with column "sp500" (S&amp;P 500)</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   V_spread_t       : pd.Series ("V_spread"), monthly valuation cheapness</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   regimes_df       : DataFrame with column "state_label"</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Build a common monthly dataframe</span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>L_t.index.union(sp500_cape_m.index).union(V_spread_t.index))</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>df_plot[<span class="st">"L"</span>]         <span class="op">=</span> L_t.reindex(df_plot.index)</span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>df_plot[<span class="st">"spx_price"</span>] <span class="op">=</span> sp500_cape_m[<span class="st">"sp500"</span>].reindex(df_plot.index)</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>df_plot[<span class="st">"V_spread"</span>]  <span class="op">=</span> V_spread_t.reindex(df_plot.index)</span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Attach regimes (forward-fill in case of any slight index mismatch)</span></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>reg_states <span class="op">=</span> combined_aug_val[<span class="st">"state_label"</span>].reindex(df_plot.index).ffill()</span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>df_plot[<span class="st">"state_label"</span>] <span class="op">=</span> reg_states</span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: drop rows before we have all three series</span></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot.dropna(subset<span class="op">=</span>[<span class="st">"L"</span>, <span class="st">"spx_price"</span>, <span class="st">"V_spread"</span>, <span class="st">"state_label"</span>])</span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Helper: find contiguous regime segments for shading</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_regime_segments(states: pd.Series):</span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Given a Series of regime labels indexed by date,</span></span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a><span class="co">    return list of (start_date, end_date, label) segments</span></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a><span class="co">    where the label is constant.</span></span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>    segments <span class="op">=</span> []</span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a>    prev_label <span class="op">=</span> <span class="va">None</span></span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>    start_date <span class="op">=</span> <span class="va">None</span></span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> dt, label <span class="kw">in</span> states.items():</span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prev_label <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a>            prev_label <span class="op">=</span> label</span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a>            start_date <span class="op">=</span> dt</span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label <span class="op">!=</span> prev_label:</span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># segment ended at previous date</span></span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a>            end_date <span class="op">=</span> dt</span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a>            segments.append((start_date, end_date, prev_label))</span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a>            start_date <span class="op">=</span> dt</span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a>            prev_label <span class="op">=</span> label</span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># last segment</span></span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prev_label <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> start_date <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb108-53"><a href="#cb108-53" aria-hidden="true" tabindex="-1"></a>        segments.append((start_date, states.index[<span class="op">-</span><span class="dv">1</span>], prev_label))</span>
<span id="cb108-54"><a href="#cb108-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-55"><a href="#cb108-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> segments</span>
<span id="cb108-56"><a href="#cb108-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-57"><a href="#cb108-57" aria-hidden="true" tabindex="-1"></a>segments <span class="op">=</span> get_regime_segments(df_plot[<span class="st">"state_label"</span>])</span>
<span id="cb108-58"><a href="#cb108-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-59"><a href="#cb108-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Colors for regimes</span></span>
<span id="cb108-60"><a href="#cb108-60" aria-hidden="true" tabindex="-1"></a>regime_colors <span class="op">=</span> {</span>
<span id="cb108-61"><a href="#cb108-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"High"</span>:    <span class="st">"#ffe0e0"</span>,  <span class="co"># pale red</span></span>
<span id="cb108-62"><a href="#cb108-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Neutral"</span>: <span class="st">"#f7f7f7"</span>,  <span class="co"># light gray</span></span>
<span id="cb108-63"><a href="#cb108-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tight"</span>:   <span class="st">"#d1ffd1"</span>,  <span class="co"># pale green</span></span>
<span id="cb108-64"><a href="#cb108-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb108-65"><a href="#cb108-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-66"><a href="#cb108-66" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Plot: 3 stacked subplots with shared x-axis</span></span>
<span id="cb108-67"><a href="#cb108-67" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb108-68"><a href="#cb108-68" aria-hidden="true" tabindex="-1"></a>                         gridspec_kw<span class="op">=</span>{<span class="st">"height_ratios"</span>: [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>]})</span>
<span id="cb108-69"><a href="#cb108-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-70"><a href="#cb108-70" aria-hidden="true" tabindex="-1"></a>ax_L, ax_spx, ax_val <span class="op">=</span> axes</span>
<span id="cb108-71"><a href="#cb108-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-72"><a href="#cb108-72" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Shading first so lines render on top ---</span></span>
<span id="cb108-73"><a href="#cb108-73" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (start, end, label) <span class="kw">in</span> segments:</span>
<span id="cb108-74"><a href="#cb108-74" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> regime_colors.get(label, <span class="st">"#f0f0f0"</span>)</span>
<span id="cb108-75"><a href="#cb108-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax <span class="kw">in</span> axes:</span>
<span id="cb108-76"><a href="#cb108-76" aria-hidden="true" tabindex="-1"></a>        ax.axvspan(start, end, color<span class="op">=</span>color, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb108-77"><a href="#cb108-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-78"><a href="#cb108-78" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Panel 1: Liquidity index L(t) ---</span></span>
<span id="cb108-79"><a href="#cb108-79" aria-hidden="true" tabindex="-1"></a>ax_L.plot(df_plot.index, df_plot[<span class="st">"L"</span>], label<span class="op">=</span><span class="st">"L(t)"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb108-80"><a href="#cb108-80" aria-hidden="true" tabindex="-1"></a>ax_L.set_ylabel(<span class="st">"L(t)"</span>)</span>
<span id="cb108-81"><a href="#cb108-81" aria-hidden="true" tabindex="-1"></a>ax_L.set_title(<span class="st">"Liquidity Index, S&amp;P 500, and Valuation Spread by Liquidity Regime"</span>)</span>
<span id="cb108-82"><a href="#cb108-82" aria-hidden="true" tabindex="-1"></a>ax_L.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb108-83"><a href="#cb108-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-84"><a href="#cb108-84" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Panel 2: S&amp;P 500 level ---</span></span>
<span id="cb108-85"><a href="#cb108-85" aria-hidden="true" tabindex="-1"></a>ax_spx.plot(df_plot.index, df_plot[<span class="st">"spx_price"</span>], label<span class="op">=</span><span class="st">"S&amp;P 500"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb108-86"><a href="#cb108-86" aria-hidden="true" tabindex="-1"></a>ax_spx.set_ylabel(<span class="st">"S&amp;P 500"</span>)</span>
<span id="cb108-87"><a href="#cb108-87" aria-hidden="true" tabindex="-1"></a>ax_spx.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb108-88"><a href="#cb108-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-89"><a href="#cb108-89" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Panel 3: Valuation cheapness (V_spread) ---</span></span>
<span id="cb108-90"><a href="#cb108-90" aria-hidden="true" tabindex="-1"></a>ax_val.plot(df_plot.index, df_plot[<span class="st">"V_spread"</span>], label<span class="op">=</span><span class="st">"V_spread (cheap vs baseline)"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb108-91"><a href="#cb108-91" aria-hidden="true" tabindex="-1"></a>ax_val.axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb108-92"><a href="#cb108-92" aria-hidden="true" tabindex="-1"></a>ax_val.set_ylabel(<span class="st">"V_spread"</span>)</span>
<span id="cb108-93"><a href="#cb108-93" aria-hidden="true" tabindex="-1"></a>ax_val.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb108-94"><a href="#cb108-94" aria-hidden="true" tabindex="-1"></a>ax_val.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb108-95"><a href="#cb108-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-96"><a href="#cb108-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional legends</span></span>
<span id="cb108-97"><a href="#cb108-97" aria-hidden="true" tabindex="-1"></a>ax_L.legend(loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb108-98"><a href="#cb108-98" aria-hidden="true" tabindex="-1"></a>ax_spx.legend(loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb108-99"><a href="#cb108-99" aria-hidden="true" tabindex="-1"></a>ax_val.legend(loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb108-100"><a href="#cb108-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-101"><a href="#cb108-101" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb108-102"><a href="#cb108-102" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-71-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/dbose\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>