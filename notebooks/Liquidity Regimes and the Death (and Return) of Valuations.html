<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Deb Bose">
<meta name="dcterms.date" content="2025-01-02">
<meta name="keywords" content="Liquidity Regimes, Sparse PCA, Hidden Markov Models (HMM), Fama-French 5-Factor Model, Factor Premiums, Valuation Spreads">

<title>Liquidity Regimes and the Death (and Return) of Valuations – Deb Bose</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-635a35c16803d16fd9db22f392043487.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Deb Bose</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../posts/"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../notebooks/index.html"> 
<span class="menu-text">Notebooks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../papers/index.html"> 
<span class="menu-text">Papers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dbose"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#liquidity-regimes-and-the-death-and-return-of-valuations" id="toc-liquidity-regimes-and-the-death-and-return-of-valuations" class="nav-link active" data-scroll-target="#liquidity-regimes-and-the-death-and-return-of-valuations">Liquidity Regimes and the Death (and Return) of Valuations:</a>
  <ul class="collapse">
  <li><a href="#high-level-structure-of-the-paper" id="toc-high-level-structure-of-the-paper" class="nav-link" data-scroll-target="#high-level-structure-of-the-paper">2. High-Level Structure of the Paper</a></li>
  <li><a href="#abstract-150200-words" id="toc-abstract-150200-words" class="nav-link" data-scroll-target="#abstract-150200-words">3. Abstract (150–200 words)</a></li>
  <li><a href="#motivation" id="toc-motivation" class="nav-link" data-scroll-target="#motivation">4. Motivation</a></li>
  <li><a href="#intuition" id="toc-intuition" class="nav-link" data-scroll-target="#intuition">5. Intuition</a></li>
  <li><a href="#literature-sketch-very-short" id="toc-literature-sketch-very-short" class="nav-link" data-scroll-target="#literature-sketch-very-short">6. Literature Sketch (very short)</a></li>
  <li><a href="#contributions" id="toc-contributions" class="nav-link" data-scroll-target="#contributions">7. Contributions</a></li>
  <li><a href="#data-variables" id="toc-data-variables" class="nav-link" data-scroll-target="#data-variables"><strong>8. Data &amp; Variables</strong></a>
  <ul class="collapse">
  <li><a href="#timeframe-frequency" id="toc-timeframe-frequency" class="nav-link" data-scroll-target="#timeframe-frequency"><strong>8.1 Timeframe &amp; Frequency</strong></a></li>
  <li><a href="#equity-factor-data" id="toc-equity-factor-data" class="nav-link" data-scroll-target="#equity-factor-data"><strong>8.2 Equity &amp; Factor Data</strong></a></li>
  <li><a href="#macro-liquidity-variables" id="toc-macro-liquidity-variables" class="nav-link" data-scroll-target="#macro-liquidity-variables"><strong>8.3 Macro &amp; Liquidity Variables</strong></a></li>
  </ul></li>
  <li><a href="#math" id="toc-math" class="nav-link" data-scroll-target="#math">9. Math</a>
  <ul class="collapse">
  <li><a href="#liquidity-proxies-standardisation" id="toc-liquidity-proxies-standardisation" class="nav-link" data-scroll-target="#liquidity-proxies-standardisation">1. Liquidity Proxies &amp; Standardisation</a></li>
  <li><a href="#example-macro-liquidity-variables" id="toc-example-macro-liquidity-variables" class="nav-link" data-scroll-target="#example-macro-liquidity-variables">2. Example Macro / Liquidity Variables</a></li>
  <li><a href="#covariance-matrix-pca-liquidity-index" id="toc-covariance-matrix-pca-liquidity-index" class="nav-link" data-scroll-target="#covariance-matrix-pca-liquidity-index">3. Covariance Matrix &amp; PCA Liquidity Index</a></li>
  <li><a href="#hmm-liquidity-regimes" id="toc-hmm-liquidity-regimes" class="nav-link" data-scroll-target="#hmm-liquidity-regimes">4. HMM Liquidity Regimes</a></li>
  <li><a href="#multivariate-regime-switching-optional" id="toc-multivariate-regime-switching-optional" class="nav-link" data-scroll-target="#multivariate-regime-switching-optional">5. Multivariate Regime-Switching (Optional)</a></li>
  <li><a href="#valuation-spreads-factor-returns-by-regime" id="toc-valuation-spreads-factor-returns-by-regime" class="nav-link" data-scroll-target="#valuation-spreads-factor-returns-by-regime">6. Valuation Spreads &amp; Factor Returns by Regime</a></li>
  <li><a href="#predictive-regressions-with-liquidity" id="toc-predictive-regressions-with-liquidity" class="nav-link" data-scroll-target="#predictive-regressions-with-liquidity">7. Predictive Regressions with Liquidity</a></li>
  <li><a href="#cross-sectional-famamacbeth-by-regime" id="toc-cross-sectional-famamacbeth-by-regime" class="nav-link" data-scroll-target="#cross-sectional-famamacbeth-by-regime">8. Cross-Sectional (Fama–MacBeth) by Regime</a></li>
  <li><a href="#regime-aware-portfolio" id="toc-regime-aware-portfolio" class="nav-link" data-scroll-target="#regime-aware-portfolio">9. Regime-Aware Portfolio</a></li>
  </ul></li>
  <li><a href="#pca-and-sparse-pca" id="toc-pca-and-sparse-pca" class="nav-link" data-scroll-target="#pca-and-sparse-pca">PCA and Sparse-PCA</a>
  <ul class="collapse">
  <li><a href="#pca-wants-the-direction-with-maximum-variance" id="toc-pca-wants-the-direction-with-maximum-variance" class="nav-link" data-scroll-target="#pca-wants-the-direction-with-maximum-variance"><strong>1. PCA wants the direction with maximum variance</strong></a></li>
  <li><a href="#why-the-constraint-v-2-1" id="toc-why-the-constraint-v-2-1" class="nav-link" data-scroll-target="#why-the-constraint-v-2-1"><strong>2. Why the constraint ( <span class="math inline">\(| v |^{2} = 1\)</span> )?</strong></a></li>
  <li><a href="#reformulating-using-the-covariance-matrix" id="toc-reformulating-using-the-covariance-matrix" class="nav-link" data-scroll-target="#reformulating-using-the-covariance-matrix"><strong>3. Reformulating using the covariance matrix</strong></a></li>
  <li><a href="#intuition-1" id="toc-intuition-1" class="nav-link" data-scroll-target="#intuition-1">Intuition</a></li>
  </ul></li>
  <li><a href="#sparse-pca" id="toc-sparse-pca" class="nav-link" data-scroll-target="#sparse-pca">Sparse PCA</a>
  <ul class="collapse">
  <li><a href="#standard-pca" id="toc-standard-pca" class="nav-link" data-scroll-target="#standard-pca">1. Standard PCA</a></li>
  <li><a href="#what-is-sparse-pca" id="toc-what-is-sparse-pca" class="nav-link" data-scroll-target="#what-is-sparse-pca">2. What is <em>Sparse PCA</em>?</a></li>
  <li><a href="#key-difference" id="toc-key-difference" class="nav-link" data-scroll-target="#key-difference">Key Difference</a></li>
  <li><a href="#why-sparse-pcs-become-interpretable-as-macro-factors" id="toc-why-sparse-pcs-become-interpretable-as-macro-factors" class="nav-link" data-scroll-target="#why-sparse-pcs-become-interpretable-as-macro-factors">Why sparse PCs become interpretable as macro factors</a></li>
  <li><a href="#concrete-example-how-sparse-pcs-isolate-macro-themes" id="toc-concrete-example-how-sparse-pcs-isolate-macro-themes" class="nav-link" data-scroll-target="#concrete-example-how-sparse-pcs-isolate-macro-themes"><strong>Concrete example (how sparse PCs isolate macro themes)</strong></a></li>
  <li><a href="#sparse-pc3-loadings" id="toc-sparse-pc3-loadings" class="nav-link" data-scroll-target="#sparse-pc3-loadings"><strong>Sparse PC3 loadings:</strong></a></li>
  <li><a href="#this-does-not-happen-with-standard-pca." id="toc-this-does-not-happen-with-standard-pca." class="nav-link" data-scroll-target="#this-does-not-happen-with-standard-pca.">This <strong>does not happen</strong> with standard PCA.</a></li>
  <li><a href="#how-sparse-pca-yields-domain-specific-macro-factors" id="toc-how-sparse-pca-yields-domain-specific-macro-factors" class="nav-link" data-scroll-target="#how-sparse-pca-yields-domain-specific-macro-factors">How sparse PCA yields <em>domain-specific macro factors</em></a></li>
  <li><a href="#why-does-this-matter" id="toc-why-does-this-matter" class="nav-link" data-scroll-target="#why-does-this-matter">Why does this matter</a></li>
  <li><a href="#tldr-the-clean-intuition" id="toc-tldr-the-clean-intuition" class="nav-link" data-scroll-target="#tldr-the-clean-intuition">TL;DR — The clean intuition</a></li>
  <li><a href="#standard-pca-1" id="toc-standard-pca-1" class="nav-link" data-scroll-target="#standard-pca-1"><strong>Standard PCA</strong></a></li>
  <li><a href="#sparse-pca-1" id="toc-sparse-pca-1" class="nav-link" data-scroll-target="#sparse-pca-1"><strong>Sparse PCA</strong></a></li>
  <li><a href="#sparse-pcs-are-explainable-because" id="toc-sparse-pcs-are-explainable-because" class="nav-link" data-scroll-target="#sparse-pcs-are-explainable-because">Sparse PCs are explainable because:</a></li>
  </ul></li>
  <li><a href="#config-date-range-series" id="toc-config-date-range-series" class="nav-link" data-scroll-target="#config-date-range-series">Config: Date Range &amp; Series</a></li>
  <li><a href="#download-macro-liquidity-variables-from-fred" id="toc-download-macro-liquidity-variables-from-fred" class="nav-link" data-scroll-target="#download-macro-liquidity-variables-from-fred">Download Macro &amp; Liquidity Variables from FRED</a>
  <ul class="collapse">
  <li><a href="#transform-raw-macro-series-into-j-liquidity-proxies-x_t" id="toc-transform-raw-macro-series-into-j-liquidity-proxies-x_t" class="nav-link" data-scroll-target="#transform-raw-macro-series-into-j-liquidity-proxies-x_t">Transform Raw Macro Series into <span class="math inline">\(J\)</span> Liquidity Proxies <span class="math inline">\(x_t\)</span></a></li>
  <li><a href="#standardize-sign-flip-and-stack-liquidity-proxies-to-get-z_jt" id="toc-standardize-sign-flip-and-stack-liquidity-proxies-to-get-z_jt" class="nav-link" data-scroll-target="#standardize-sign-flip-and-stack-liquidity-proxies-to-get-z_jt">Standardize, Sign-Flip and Stack Liquidity Proxies to Get <span class="math inline">\(z_{j,t}\)</span></a></li>
  <li><a href="#sparse-pca-liquidity-index-l_t" id="toc-sparse-pca-liquidity-index-l_t" class="nav-link" data-scroll-target="#sparse-pca-liquidity-index-l_t">Sparse PCA Liquidity Index <span class="math inline">\(L_{t}\)</span></a></li>
  <li><a href="#hmm-markov-regime-detection-on-l_t" id="toc-hmm-markov-regime-detection-on-l_t" class="nav-link" data-scroll-target="#hmm-markov-regime-detection-on-l_t">HMM / Markov Regime Detection on <span class="math inline">\(L_t\)</span></a></li>
  <li><a href="#equity-factor-data-famafrench" id="toc-equity-factor-data-famafrench" class="nav-link" data-scroll-target="#equity-factor-data-famafrench">Equity Factor Data (Fama–French)</a></li>
  <li><a href="#factor-returns-by-liquidity-regime" id="toc-factor-returns-by-liquidity-regime" class="nav-link" data-scroll-target="#factor-returns-by-liquidity-regime">Factor returns by liquidity regime</a></li>
  <li><a href="#whats-going-on" id="toc-whats-going-on" class="nav-link" data-scroll-target="#whats-going-on">What’s going on ?</a></li>
  <li><a href="#question-is-why-high-liquidity-is-rare-look-at-the-kde-of-red-state-2" id="toc-question-is-why-high-liquidity-is-rare-look-at-the-kde-of-red-state-2" class="nav-link" data-scroll-target="#question-is-why-high-liquidity-is-rare-look-at-the-kde-of-red-state-2">Question is why high liquidity is rare (look at the KDE of red state 2) ?</a></li>
  <li><a href="#two-layer-liquidity-flow-vs-stock-excess" id="toc-two-layer-liquidity-flow-vs-stock-excess" class="nav-link" data-scroll-target="#two-layer-liquidity-flow-vs-stock-excess">Two-layer liquidity: Flow vs Stock / Excess</a></li>
  </ul></li>
  <li><a href="#yes" id="toc-yes" class="nav-link" data-scroll-target="#yes">Yes !!</a>
  <ul class="collapse">
  <li><a href="#sp-500-monthly-prices" id="toc-sp-500-monthly-prices" class="nav-link" data-scroll-target="#sp-500-monthly-prices">S&amp;P 500 monthly prices</a></li>
  <li><a href="#cape-data-from-httpsshillerdata.com" id="toc-cape-data-from-httpsshillerdata.com" class="nav-link" data-scroll-target="#cape-data-from-httpsshillerdata.com">CAPE Data from https://shillerdata.com/</a></li>
  <li><a href="#from-valuation-levels-into-a-spread-series" id="toc-from-valuation-levels-into-a-spread-series" class="nav-link" data-scroll-target="#from-valuation-levels-into-a-spread-series">From valuation levels into a spread series</a></li>
  <li><a href="#combine-liquidity-regime-with-valuation-spread" id="toc-combine-liquidity-regime-with-valuation-spread" class="nav-link" data-scroll-target="#combine-liquidity-regime-with-valuation-spread">Combine Liquidity Regime with Valuation Spread</a></li>
  <li><a href="#regime-conditional-valuation-spreads" id="toc-regime-conditional-valuation-spreads" class="nav-link" data-scroll-target="#regime-conditional-valuation-spreads">Regime-conditional valuation spreads</a></li>
  <li><a href="#valuation-spreads-factor-returns-by-regime-math" id="toc-valuation-spreads-factor-returns-by-regime-math" class="nav-link" data-scroll-target="#valuation-spreads-factor-returns-by-regime-math">Valuation Spreads &amp; Factor Returns by Regime Math</a></li>
  <li><a href="#insigts" id="toc-insigts" class="nav-link" data-scroll-target="#insigts">Insigts</a></li>
  <li><a href="#plot-lt-sp-500-and-v_spread_t-together-with-regime-shading" id="toc-plot-lt-sp-500-and-v_spread_t-together-with-regime-shading" class="nav-link" data-scroll-target="#plot-lt-sp-500-and-v_spread_t-together-with-regime-shading">Plot L(t), S&amp;P 500, and V_spread_t together with regime shading,</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Liquidity Regimes and the Death (and Return) of Valuations</h1>
<p class="subtitle lead">A 35-Year Quantitative Analysis of Factor Premiums (1990–2025)</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Deb Bose </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 2, 2025</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>This research utilizes Sparse PCA and Hidden Markov Models to demonstrate that equity factor premiums are strictly regime-dependent, revealing that while growth dominates during expansive liquidity, value and conservative investment factors revive significantly during periods of liquidity tightening. Findings prove that market valuations remain relevant but fluctuate predictably, with the S&amp;P 500 trading approximately 0.43σ more expensive in high-liquidity states compared to tight regimes.</p>
  </div>
</div>

<div>
  <div class="keywords">
    <div class="block-title">Keywords</div>
    <p>Liquidity Regimes, Sparse PCA, Hidden Markov Models (HMM), Fama-French 5-Factor Model, Factor Premiums, Valuation Spreads</p>
  </div>
</div>

</header>


<section id="liquidity-regimes-and-the-death-and-return-of-valuations" class="level1">
<h1>Liquidity Regimes and the Death (and Return) of Valuations:</h1>
<p>A 35-Year Quantitative Analysis of Factor Premiums (1990–2025)</p>
<section id="high-level-structure-of-the-paper" class="level2">
<h2 class="anchored" data-anchor-id="high-level-structure-of-the-paper">2. High-Level Structure of the Paper</h2>
<ul>
<li>Story – why this matters (intro + conclusion)</li>
<li>Data – what you measure (markets, factors, liquidity proxies)</li>
<li>Models – how you measure (liquidity index, regimes, cross-sectional tests)</li>
<li>Portfolio – what to do with it (conditional allocation</li>
</ul>
</section>
<section id="abstract-150200-words" class="level2">
<h2 class="anchored" data-anchor-id="abstract-150200-words">3. Abstract (150–200 words)</h2>
<ul>
<li>The “valuations don’t matter in infinite money printing” meme.</li>
<li>Your construction of a liquidity index and liquidity regimes.</li>
<li>Key findings:</li>
<li>Valuations do matter, but <strong>conditional on liquidity regimes</strong>.</li>
<li>Growth dominates in <strong>high-liquidity, negative-real-rate regimes</strong>.</li>
<li>Value premia revive after QT / real rate normalization.</li>
</ul>
<p>Portfolio takeaway: a simple regime-aware factor-tilt model.</p>
</section>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">4. Motivation</h2>
<ul>
<li><p>Narrative: post-GFC QE, ZIRP, NIRP, 2010–2021 “TINA”, tech bubble 2.0.</p></li>
<li><blockquote class="blockquote">
<p>“We live in a world of infinite money printing, so valuations don’t matter.”</p>
</blockquote></li>
<li><p>Research question: &gt; Do valuations truly die under abundant liquidity, or do they merely become regime-dependent?</p></li>
<li><p>Do valuation spreads (cheap vs expensive deciles) expand under high-liquidity regimes and compress under tight liquidity?</p></li>
<li><p>How do factor premia (value, momentum, quality, low vol) vary conditional on liquidity regimes?</p></li>
<li><p>Can a macro-liquidity index predict the timing of factor rotations (growth vs value, long-duration vs short-duration equities)?</p></li>
<li><p>Does a regime-aware factor allocation deliver better risk-adjusted returns than a static factor mix?</p></li>
</ul>
</section>
<section id="intuition" class="level2">
<h2 class="anchored" data-anchor-id="intuition">5. Intuition</h2>
<ul>
<li>Valuation spread: the gap between cheap and expensive stocks (e.g., top vs bottom decile by B/M).</li>
<li>Liquidity regime: periods of systematically easy vs tight financial conditions driven by monetary and fiscal variables.</li>
</ul>
</section>
<section id="literature-sketch-very-short" class="level2">
<h2 class="anchored" data-anchor-id="literature-sketch-very-short">6. Literature Sketch (very short)</h2>
<ul>
<li><strong>Systemic Strategy</strong>: Factor investing: value, momentum, quality.</li>
<li><strong>Risk Factors and Risk premia</strong>: Liquidity</li>
<li><strong>Regime-switching</strong>: macro-conditional factors.</li>
</ul>
</section>
<section id="contributions" class="level2">
<h2 class="anchored" data-anchor-id="contributions">7. Contributions</h2>
<ul>
<li>Build a macro liquidity index from multiple public series.</li>
<li>Use HMM / Markov regimes to label high vs low liquidity states.</li>
<li>Show how valuation spreads and factor returns behave across liquidity regimes.</li>
<li>Propose a simple implementable regime-aware factor strategy.</li>
</ul>
</section>
<section id="data-variables" class="level2">
<h2 class="anchored" data-anchor-id="data-variables"><strong>8. Data &amp; Variables</strong></h2>
<hr>
<section id="timeframe-frequency" class="level3">
<h3 class="anchored" data-anchor-id="timeframe-frequency"><strong>8.1 Timeframe &amp; Frequency</strong></h3>
<ul>
<li>Horizon: <strong>1990–2025</strong>, <strong>monthly</strong> frequency (or weekly if feasible).</li>
<li>Market: US equities (CRSP/Compustat-type universe); optional robustness on AUS/EU.</li>
</ul>
<hr>
</section>
<section id="equity-factor-data" class="level3">
<h3 class="anchored" data-anchor-id="equity-factor-data"><strong>8.2 Equity &amp; Factor Data</strong></h3>
<ul>
<li>Individual stock returns <span class="math inline">\(r_{i,t}\)</span>, market cap, book equity, earnings, etc.</li>
<li>Characteristics <span class="math inline">\(X_{i,t}\)</span>:</li>
</ul>
<p><span class="math display">\[
\text{B/M},\ \text{E/P},\ \text{P/S},\ \text{size},\ \beta,\ \text{12–1 momentum},\ \text{profitability},\ \text{volatility}.
\]</span></p>
<ul>
<li>Factor returns <span class="math inline">\(f_t\)</span>:</li>
</ul>
<p><span class="math display">\[
\text{MKT},\ \text{HML},\ \text{SMB},\ \text{MOM},\ \text{Quality},\ \text{LowVol}.
\]</span></p>
<p>Define a <strong>valuation spread</strong>:</p>
<p><span class="math display">\[
V_t^{\text{spread}} = \text{Long top decile of B/M} - \text{Short bottom decile}.
\]</span></p>
<hr>
</section>
<section id="macro-liquidity-variables" class="level3">
<h3 class="anchored" data-anchor-id="macro-liquidity-variables"><strong>8.3 Macro &amp; Liquidity Variables</strong></h3>
<p>Let raw macro/liquidity variables at time <span class="math inline">\(t\)</span> be <span class="math inline">\(x_{j,t}\)</span>, including:</p>
<hr>
<section id="monetary-balance-sheet" class="level4">
<h4 class="anchored" data-anchor-id="monetary-balance-sheet"><strong>Monetary &amp; Balance Sheet</strong></h4>
<ul>
<li><p>Money growth: <span class="math display">\[\Delta \log(M2_t)\]</span></p></li>
<li><p>Fed balance sheet growth: <span class="math display">\[\Delta \log(\text{BS}_t)\]</span></p></li>
</ul>
<hr>
</section>
<section id="rates-term-structure" class="level4">
<h4 class="anchored" data-anchor-id="rates-term-structure"><strong>Rates &amp; Term Structure</strong></h4>
<ul>
<li><p>Short rate: <span class="math display">\[i_t\]</span></p></li>
<li><p>10Y yield: <span class="math display">\[y_{10,t}\]</span></p></li>
<li><p>Slope: <span class="math display">\[\text{TS}_t = y_{10,t} - i_t\]</span></p></li>
<li><p>Real short rate: <span class="math display">\[r_t^{\text{real}} = i_t - \pi_t^e\]</span></p></li>
</ul>
<hr>
</section>
<section id="risk-spreads" class="level4">
<h4 class="anchored" data-anchor-id="risk-spreads"><strong>Risk &amp; Spreads</strong></h4>
<ul>
<li><p>Credit spread: <span class="math display">\[\text{CS}_t = y_{\text{Baa},t} - y_{\text{Aaa},t}\]</span></p></li>
<li><p>VIX level: <span class="math display">\[\text{VIX}_t\]</span></p></li>
</ul>
<hr>
</section>
<section id="plumbing-variables-if-available" class="level4">
<h4 class="anchored" data-anchor-id="plumbing-variables-if-available"><strong>Plumbing Variables (if available)</strong></h4>
<ul>
<li>ON RRP usage</li>
<li>TGA balance</li>
</ul>
<hr>
<p>All variables <span class="math inline">\(x_{j,t}\)</span> will then be standardized (e.g., z-scored) and aggregated into a <strong>single liquidity index</strong>.</p>
</section>
</section>
</section>
<section id="math" class="level2">
<h2 class="anchored" data-anchor-id="math">9. Math</h2>
<section id="liquidity-proxies-standardisation" class="level3">
<h3 class="anchored" data-anchor-id="liquidity-proxies-standardisation">1. Liquidity Proxies &amp; Standardisation</h3>
$ x_t =
<span class="math display">\[\begin{bmatrix}
x_{1,t} \
x_{2,t} \
\vdots \
x_{J,t}
\end{bmatrix}\]</span>
<p><br>
x_{J,t} \end{bmatrix} ^J $</p>
<p>$ <em>j = </em>{t=1}^{T} x_{j,t} $</p>
<p>$ <em>j^2 = </em>{t=1}^{T} (x_{j,t} - _j)^2 $</p>
<p>$ z_{j,t} = , j = 1,,J $</p>
$ z_t =
<span class="math display">\[\begin{bmatrix}
z_{1,t} \
z_{2,t} \
\vdots \
z_{J,t}
\end{bmatrix}\]</span>
<p><br>
z_{J,t} \end{bmatrix} $</p>
<p>One may sign-flip the series so that higher <span class="math inline">\(z_{j,t}\)</span> always corresponds to easier liquidity. For example:</p>
<p>Use <span class="math inline">\(-r^{\text{real}}_{t}\)</span> instead of <span class="math inline">\(r^{\text{real}}_{t}\)</span>.</p>
<p>Use <span class="math inline">\(-CS_{t}\)</span> instead of <span class="math inline">\(CS_{t}\)</span>.</p>
<p>Use <span class="math inline">\(-VIX_{t}\)</span> instead of <span class="math inline">\(VIX_{t}\)</span>.</p>
<hr>
</section>
<section id="example-macro-liquidity-variables" class="level3">
<h3 class="anchored" data-anchor-id="example-macro-liquidity-variables">2. Example Macro / Liquidity Variables</h3>
<p>$ M2_t $</p>
<p>$ _t $</p>
<p>$ <em>t = y</em>{10,t} - i_t $</p>
<p>$ r_t^{} = i_t - _t^e $</p>
<p>$ <em>t = y</em>{Baa,t} - y_{Aaa,t} $</p>
<hr>
</section>
<section id="covariance-matrix-pca-liquidity-index" class="level3">
<h3 class="anchored" data-anchor-id="covariance-matrix-pca-liquidity-index">3. Covariance Matrix &amp; PCA Liquidity Index</h3>
<p>$ = _{t=1}^{T} z_t z_t^$</p>
<p>$ v_k = _k v_k, k = 1,,J $</p>
<p>$ _1 _2 _J $</p>
<p>$ L_t = v_1^z_t $</p>
<p>(Alternative weighted index)</p>
<p>$ L_t = w^z_t $</p>
<hr>
</section>
<section id="hmm-liquidity-regimes" class="level3">
<h3 class="anchored" data-anchor-id="hmm-liquidity-regimes">4. HMM Liquidity Regimes</h3>
<p>$ s_t $</p>
<p>$ L_t (s_t = k) (_k, _k^2), k = 1,,K $</p>
<p>$ (s_t = j s_{t-1} = i) = p_{ij} $</p>
$ P =
<span class="math display">\[\begin{bmatrix}
p_{11} &amp; \cdots &amp; p_{1K} \
\vdots &amp; \ddots &amp; \vdots \
p_{K1} &amp; \cdots &amp; p_{KK}
\end{bmatrix}\]</span>
<p>ts &amp; <br>
p_{K1} &amp; &amp; p_{KK} \end{bmatrix}, <em>{j=1}^K p</em>{ij} = 1 &nbsp;i $</p>
<p>(Filtered / smoothed state classification)</p>
<p>$ <em>t = </em>{k } (s_t = k L_{1:T}) $</p>
<p>(High- and Tight-liquidity labels)</p>
<p>$ k_{} = _k _k $</p>
<p>$ k_{} = _k _k $</p>
<p>(Regime indicator using probability threshold)</p>
<p>$ I_t^{} = $</p>
<hr>
</section>
<section id="multivariate-regime-switching-optional" class="level3">
<h3 class="anchored" data-anchor-id="multivariate-regime-switching-optional">5. Multivariate Regime-Switching (Optional)</h3>
$ y_t =
<span class="math display">\[\begin{bmatrix}
L_t \
r_t^{\text{MKT}} \
r_t^{\text{HML}} \
\text{VIX}_t \
\vdots
\end{bmatrix}\]</span>
<p>T}}<br>
r_t^{}<br>
_t<br>
\end{bmatrix} $</p>
<p>$ y_t (s_t = k) = A_k y_{t-1} + _t^{(k)} $</p>
<p>$ _t^{(k)} (0, _k) $</p>
<hr>
</section>
<section id="valuation-spreads-factor-returns-by-regime" class="level3">
<h3 class="anchored" data-anchor-id="valuation-spreads-factor-returns-by-regime">6. Valuation Spreads &amp; Factor Returns by Regime</h3>
<p>(Valuation spread series, e.g.&nbsp;top–bottom decile)</p>
<p>$ V_t^{} $</p>
<p>(Regime-conditional mean valuation spread)</p>
<p>$ {V}^{(k)} = $</p>
<p>$ ^{(k)} = {_{t=1}^T (_t = k)} $</p>
<p>(Difference in spreads between regimes)</p>
<p>$ ^{()} - ^{()} $</p>
<p>(Factor return in regime ( k ))</p>
<p>$ r_t^{(F)} $</p>
<p>$ {r}_F^{(k)} = $</p>
<p>$ <em>F^{(k)} = {</em>{t=1}^T (_t = k)} $</p>
<p>(Regime-specific Sharpe ratio)</p>
<p>$ _F^{(k)} = $</p>
<hr>
</section>
<section id="predictive-regressions-with-liquidity" class="level3">
<h3 class="anchored" data-anchor-id="predictive-regressions-with-liquidity">7. Predictive Regressions with Liquidity</h3>
<p>(Continuous liquidity index)</p>
<p>$ r_{t+1}^{(F)} = + L_t + ^c_t + _{t+1} $</p>
<p>(Regime dummy regression)</p>
<p>$ r_{t+1}^{(F)} = + <em>{} I_t^{} + </em>{} I_t^{} + <em>{} I_t^{} + </em>{t+1} $</p>
<hr>
</section>
<section id="cross-sectional-famamacbeth-by-regime" class="level3">
<h3 class="anchored" data-anchor-id="cross-sectional-famamacbeth-by-regime">8. Cross-Sectional (Fama–MacBeth) by Regime</h3>
<p>(Cross-sectional regression at time ( t ))</p>
<p>$ r_{i,t+1} = <em>t + </em>{1,t} <em>{i,t} + </em>{2,t} <em>{i,t} + </em>{3,t} <em>{i,t} + + </em>{i,t+1} $</p>
<p>(Regime-conditional average valuation slope)</p>
<p>$ {}_1^{(k)} = $</p>
<p>$ <em>1^{(k)} = {</em>{t=1}^T (_t = k)} $</p>
<hr>
</section>
<section id="regime-aware-portfolio" class="level3">
<h3 class="anchored" data-anchor-id="regime-aware-portfolio">9. Regime-Aware Portfolio</h3>
<p>(Factor return vector and regime weights)</p>
<p>$ f_t ^K $</p>
<p>$ w^{(k)} ^K $</p>
<p>$ w_t = w^{(_t)} $</p>
<p>(Portfolio return)</p>
<p>$ R_{p,t+1} = w_t^f_{t+1} $</p>
</section>
</section>
<section id="pca-and-sparse-pca" class="level2">
<h2 class="anchored" data-anchor-id="pca-and-sparse-pca">PCA and Sparse-PCA</h2>
<p>Standard PCA solves:</p>
<p><span class="math display">\[
\max_{v} \; \| X v \|^{2}
\quad \text{s.t.} \quad \| v \|^{2} = 1
\]</span></p>
<hr>
<section id="pca-wants-the-direction-with-maximum-variance" class="level3">
<h3 class="anchored" data-anchor-id="pca-wants-the-direction-with-maximum-variance"><strong>1. PCA wants the direction with maximum variance</strong></h3>
<p>PCA tries to find the direction ( <span class="math inline">\(v\)</span> ) (a unit vector) along which the projected data ( <span class="math inline">\(Xv\)</span> ) has <strong>maximum variance</strong>.</p>
<p>Variance of the projection:</p>
<p><span class="math display">\[
\text{Var}(Xv) = \frac{1}{n} |Xv|^{2}.
\]</span></p>
<p>So maximizing variance is equivalent to maximizing ( <span class="math inline">\(|Xv|^{2}\)</span> ).</p>
<hr>
</section>
<section id="why-the-constraint-v-2-1" class="level3">
<h3 class="anchored" data-anchor-id="why-the-constraint-v-2-1"><strong>2. Why the constraint ( <span class="math inline">\(| v |^{2} = 1\)</span> )?</strong></h3>
<p>Without this constraint, the problem would blow up:</p>
<p><span class="math display">\[
|X(\alpha v)|^{2} = \alpha^{2} |Xv|^{2},
\]</span></p>
<p>and the maximum would be infinite by choosing ( <span class="math inline">\(\alpha\)</span> <span class="math inline">\(\infty\)</span> ).</p>
<p>So PCA forces ( <span class="math inline">\(v\)</span> ) to be a <strong>direction</strong>, not a magnitude → a unit vector.</p>
<hr>
</section>
<section id="reformulating-using-the-covariance-matrix" class="level3">
<h3 class="anchored" data-anchor-id="reformulating-using-the-covariance-matrix"><strong>3. Reformulating using the covariance matrix</strong></h3>
<p><span class="math display">\[
|Xv|^{2} = v^\top X^\top X v.
\]</span></p>
<p>Let:</p>
<p><span class="math display">\[
S = X^\top X
\]</span></p>
<p>(the unnormalized covariance matrix). Then PCA solves:</p>
<p><span class="math display">\[
\max_{v} ; v^\top S v
\quad\text{s.t.}\quad v^\top v = 1.
\]</span></p>
<p>This is exactly the <strong>Rayleigh quotient</strong>.</p>
</section>
<section id="intuition-1" class="level3">
<h3 class="anchored" data-anchor-id="intuition-1">Intuition</h3>
<blockquote class="blockquote">
<p>PCA finds the direction (unit vector) along which the data cloud has <strong>maximum spread</strong>. That direction is exactly the eigenvector of the covariance matrix with the largest eigenvalue.</p>
</blockquote>
<hr>
</section>
</section>
<section id="sparse-pca" class="level2">
<h2 class="anchored" data-anchor-id="sparse-pca">Sparse PCA</h2>
<section id="standard-pca" class="level3">
<h3 class="anchored" data-anchor-id="standard-pca">1. Standard PCA</h3>
<ul>
<li>PCA rotates the data into orthogonal directions capturing maximum variance.</li>
<li>Each principal component is a <strong>linear combination of all variables</strong>.</li>
<li>Loadings are typically <strong>dense</strong> (every variable has some non-zero weight).</li>
<li>This makes interpretation difficult:</li>
</ul>
<blockquote class="blockquote">
<p>“PC1 of 127 economic multicolinear variables is 127-dimensional mush of everything.”</p>
</blockquote>
<p>This is why PCA is almost never used directly for economic interpretation — PCs are not sparse.</p>
<hr>
</section>
<section id="what-is-sparse-pca" class="level3">
<h3 class="anchored" data-anchor-id="what-is-sparse-pca">2. What is <em>Sparse PCA</em>?</h3>
<p><strong>Sparse PCA = PCA where most loadings are forced to be zero.</strong></p>
<p>Mathematically:</p>
<p>Standard PCA solves:</p>
<p><span class="math display">\[
\max_{v} \ |Xv|^2 \quad \text{s.t. } |v|_2 = 1
\]</span></p>
<p>Sparse PCA adds an <strong>L1 penalty</strong> (lasso-style sparsity) or constrains the number of non-zero elements:</p>
<p><span class="math display">\[
\max_{v} \ |Xv|^2 - \lambda |v|_1
\]</span></p>
<p>or equivalently:</p>
<p><span class="math display">\[
\max_{v} \ |Xv|^2 \quad \text{s.t. } |v|_2 = 1,\ |v|_1 \leq c
\]</span></p>
<p>This forces:</p>
<ul>
<li>Only a <strong>small subset</strong> of variables to load on each component.</li>
<li>Components become <strong>interpretable</strong> (e.g., PC1 loads on CPI, PCE, core CPI → “inflation”).</li>
</ul>
<p>The specific implementation cited (“penalized matrix decomposition” by Witten et al.&nbsp;2009) solves:</p>
<p><span class="math display">\[
\max_{u, v} \ u^\top X v \quad
\text{s.t. } |u|_2 = 1,\ |v|_2 = 1,\ |v|_1 \le c
\]</span></p>
<p>This is a general sparse factor extraction algorithm.</p>
<p>Intuition: &gt; Sparse PCA forces components to use <strong>only the relevant variables</strong>, not a smear across 127 series.</p>
<hr>
</section>
<section id="key-difference" class="level3">
<h3 class="anchored" data-anchor-id="key-difference">Key Difference</h3>
<ul>
<li><strong>Standard PCA components ≈ dense, uninterpretable mixtures</strong></li>
<li><strong>Sparse PCA components ≈ targeted clusters of interpretable economic variables</strong></li>
</ul>
<hr>
</section>
<section id="why-sparse-pcs-become-interpretable-as-macro-factors" class="level3">
<h3 class="anchored" data-anchor-id="why-sparse-pcs-become-interpretable-as-macro-factors">Why sparse PCs become interpretable as macro factors</h3>
<p>Take FRED-MD’s 127 macro series.</p>
<p>If you run <em>standard</em> PCA:</p>
<ul>
<li>PC1 loads on 100+ variables.</li>
<li>PC2 loads on another 80+.</li>
<li>Interpreting them is basically hopeless.</li>
</ul>
<p>Sparse PCA, with lasso constraints:</p>
<ul>
<li>allows PC1 to load only on inflation-related variables</li>
<li>PC2 to load only on housing-related variables</li>
<li>PC3 on credit spreads</li>
<li>PC4 on yields</li>
<li>PC5 on production</li>
<li>etc.</li>
</ul>
<p>This resembles the <strong>Stock–Watson macro factor model</strong>, but with sparsity for interpretability.</p>
<hr>
</section>
<section id="concrete-example-how-sparse-pcs-isolate-macro-themes" class="level3">
<h3 class="anchored" data-anchor-id="concrete-example-how-sparse-pcs-isolate-macro-themes"><strong>Concrete example (how sparse PCs isolate macro themes)</strong></h3>
<p>Suppose sparse PCA gives:</p>
<section id="sparse-pc1-loadings" class="level4">
<h4 class="anchored" data-anchor-id="sparse-pc1-loadings"><strong>Sparse PC1 loadings:</strong></h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Loading</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CPI YoY</td>
<td>0.71</td>
</tr>
<tr class="even">
<td>Core CPI YoY</td>
<td>0.68</td>
</tr>
<tr class="odd">
<td>PCE Deflator</td>
<td>0.66</td>
</tr>
<tr class="even">
<td>PCE core</td>
<td>0.64</td>
</tr>
<tr class="odd">
<td>All other 123 variables</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>-&gt; You immediately label PC1 as <strong>“inflation factor”</strong>.</p>
</section>
<section id="sparse-pc2-loadings" class="level4">
<h4 class="anchored" data-anchor-id="sparse-pc2-loadings"><strong>Sparse PC2 loadings:</strong></h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Loading</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Housing starts</td>
<td>0.62</td>
</tr>
<tr class="even">
<td>Building permits</td>
<td>0.59</td>
</tr>
<tr class="odd">
<td>New homes sold</td>
<td>0.61</td>
</tr>
<tr class="even">
<td>Mortgage applications</td>
<td>0.58</td>
</tr>
<tr class="odd">
<td>Everything else</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>-&gt; PC2 = <strong>“housing &amp; construction cycle”</strong></p>
</section>
</section>
<section id="sparse-pc3-loadings" class="level3">
<h3 class="anchored" data-anchor-id="sparse-pc3-loadings"><strong>Sparse PC3 loadings:</strong></h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Loading</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Corporate spreads (BAA–AAA)</td>
<td>0.72</td>
</tr>
<tr class="even">
<td>High yield spread</td>
<td>0.69</td>
</tr>
<tr class="odd">
<td>Commercial paper spread</td>
<td>0.64</td>
</tr>
<tr class="even">
<td>Others</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>-&gt; PC3 = <strong>“credit stress”</strong></p>
<p>…and so on.</p>
</section>
<section id="this-does-not-happen-with-standard-pca." class="level3">
<h3 class="anchored" data-anchor-id="this-does-not-happen-with-standard-pca.">This <strong>does not happen</strong> with standard PCA.</h3>
<p>Sparse PCA essentially performs <strong>dimension reduction + variable selection</strong> simultaneously.</p>
<hr>
</section>
<section id="how-sparse-pca-yields-domain-specific-macro-factors" class="level3">
<h3 class="anchored" data-anchor-id="how-sparse-pca-yields-domain-specific-macro-factors">How sparse PCA yields <em>domain-specific macro factors</em></h3>
<p>Sparse PCA encourages:</p>
<ul>
<li><strong>grouping</strong> variables that co-move strongly</li>
<li><strong>dropping</strong> variables unrelated to the theme</li>
<li><strong>choosing</strong> a small number of representative series</li>
</ul>
<p>Given economic data naturally clusters (inflation variables co-move, housing variables co-move), sparse PCA isolates these clusters.</p>
<p>This is similar to economic intuition:</p>
<ul>
<li>inflationary variables form a single latent factor</li>
<li>spreads form a financial stress factor</li>
<li>yields form a term-structure factor</li>
<li>employment variables form a labor factor</li>
</ul>
<p>Sparse PCA “discovers” these clusters automatically.</p>
<hr>
</section>
<section id="why-does-this-matter" class="level3">
<h3 class="anchored" data-anchor-id="why-does-this-matter">Why does this matter</h3>
<p><strong>Sparse PCA → interpretable macro drivers → better regime classification → better factor conditioning.</strong></p>
<p>Especially when constructing a <strong>macro liquidity index</strong> or <strong>financial conditions index</strong>.</p>
<p>Sparse PCA gives:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Component</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PC1</td>
<td>Liquidity / money conditions</td>
</tr>
<tr class="even">
<td>PC2</td>
<td>Credit spreads</td>
</tr>
<tr class="odd">
<td>PC3</td>
<td>Housing activity</td>
</tr>
<tr class="even">
<td>PC4</td>
<td>Yield curve / rates</td>
</tr>
<tr class="odd">
<td>PC5</td>
<td>Employment</td>
</tr>
<tr class="even">
<td>PC6</td>
<td>Production</td>
</tr>
<tr class="odd">
<td>PC7</td>
<td>Income</td>
</tr>
<tr class="even">
<td>PC8</td>
<td>Market stress</td>
</tr>
</tbody>
</table>
<p>These are exactly the components McCracken &amp; Ng (2016) find in FRED-MD.</p>
<hr>
</section>
<section id="tldr-the-clean-intuition" class="level3">
<h3 class="anchored" data-anchor-id="tldr-the-clean-intuition">TL;DR — The clean intuition</h3>
</section>
<section id="standard-pca-1" class="level3">
<h3 class="anchored" data-anchor-id="standard-pca-1"><strong>Standard PCA</strong></h3>
<ul>
<li>Dense loadings</li>
<li>Hard to interpret</li>
<li>PCs are linear mush</li>
</ul>
</section>
<section id="sparse-pca-1" class="level3">
<h3 class="anchored" data-anchor-id="sparse-pca-1"><strong>Sparse PCA</strong></h3>
<ul>
<li>Forces many loadings to zero</li>
<li>Each PC focuses on a small cluster of variables</li>
<li>Becomes interpretable as a “macro theme”</li>
<li>Matches how economists think about the business cycle</li>
<li>Perfect for regime classification &amp; factor research</li>
</ul>
</section>
<section id="sparse-pcs-are-explainable-because" class="level3">
<h3 class="anchored" data-anchor-id="sparse-pcs-are-explainable-because">Sparse PCs are explainable because:</h3>
<ul>
<li>Economic data naturally clusters into themes</li>
<li>Sparse PCA forces components to choose only the strongest cluster</li>
<li>This matches known macro factors (inflation, employment, credit, etc.)</li>
</ul>
<div id="5c2aa549-9af8-4d8d-8199-b3609180c04f" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install pandas pandas_datareader numpy scikit-learn hmmlearn matplotlib</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas_datareader <span class="im">import</span> data <span class="im">as</span> pdr</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> SparsePCA</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hmmlearn.hmm <span class="im">import</span> GaussianHMM</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="config-date-range-series" class="level2">
<h2 class="anchored" data-anchor-id="config-date-range-series">Config: Date Range &amp; Series</h2>
<div id="3a242f4a-e57d-4436-abc5-c44afbf16e8d" class="cell" data-execution_count="95">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"1990-01-01"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>end_date   <span class="op">=</span> <span class="st">"2025-12-31"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- FRED series codes ---</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>FRED_SERIES <span class="op">=</span> {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"M2SL"</span>:   <span class="st">"M2SL"</span>,      <span class="co"># M2 money stock (monthly, SA)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FED_BAL"</span>:<span class="st">"WALCL"</span>,     <span class="co"># Fed balance sheet total assets (weekly)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TB3M"</span>:   <span class="st">"TB3MS"</span>,     <span class="co"># 3-Month T-Bill rate (monthly)</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DGS10"</span>:  <span class="st">"DGS10"</span>,     <span class="co"># 10-Year Treasury yield (daily -&gt; resample monthly)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"BAA"</span>:    <span class="st">"BAA"</span>,       <span class="co"># Moody's Baa corporate yield (monthly)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AAA"</span>:    <span class="st">"AAA"</span>,       <span class="co"># Moody's Aaa corporate yield (monthly)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CPI"</span>:    <span class="st">"CPIAUCSL"</span>,  <span class="co"># CPI index (monthly, SA)</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"GDP"</span>:    <span class="st">"GDP"</span>,       <span class="co"># Nominal GDP (quarterly, SAAR)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># For equity factors: Fama-French via pandas_datareader (famafrench)</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>FF_FACTORS_DATASET <span class="op">=</span> <span class="st">"F-F_Research_Data_5_Factors_2x3"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="download-macro-liquidity-variables-from-fred" class="level2">
<h2 class="anchored" data-anchor-id="download-macro-liquidity-variables-from-fred">Download Macro &amp; Liquidity Variables from FRED</h2>
<div id="30b4c0d7-8e94-48e1-b256-61c0cd40db18" class="cell" data-execution_count="106">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_fred_series(series_dict, start, end):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Download FRED series into a single monthly DataFrame.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    series_dict : dict</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Mapping logical_name -&gt; FRED code.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    dfs <span class="op">=</span> []</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, code <span class="kw">in</span> series_dict.items():</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Downloading </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">) from FRED..."</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> pdr.DataReader(code, <span class="st">"fred"</span>, start, end)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> s.rename(columns<span class="op">=</span>{code: name})</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        dfs.append(s)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.concat(dfs, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure monthly freq by end-of-month sampling</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.resample(<span class="st">"M"</span>).last()</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>macro_raw <span class="op">=</span> download_fred_series(FRED_SERIES, start_date, end_date)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>macro_raw.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading M2SL (M2SL) from FRED...
Downloading FED_BAL (WALCL) from FRED...
Downloading TB3M (TB3MS) from FRED...
Downloading DGS10 (DGS10) from FRED...
Downloading BAA (BAA) from FRED...
Downloading AAA (AAA) from FRED...
Downloading CPI (CPIAUCSL) from FRED...
Downloading GDP (GDP) from FRED...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="106">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2SL</th>
<th data-quarto-table-cell-role="th">FED_BAL</th>
<th data-quarto-table-cell-role="th">TB3M</th>
<th data-quarto-table-cell-role="th">DGS10</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">GDP</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-01-31</th>
<td>3166.8</td>
<td>NaN</td>
<td>7.64</td>
<td>8.43</td>
<td>9.94</td>
<td>8.99</td>
<td>127.5</td>
<td>5872.701</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1990-02-28</th>
<td>3179.2</td>
<td>NaN</td>
<td>7.74</td>
<td>8.51</td>
<td>10.14</td>
<td>9.22</td>
<td>128.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-03-31</th>
<td>3190.1</td>
<td>NaN</td>
<td>7.90</td>
<td>8.65</td>
<td>10.21</td>
<td>9.37</td>
<td>128.6</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1990-04-30</th>
<td>3201.6</td>
<td>NaN</td>
<td>7.77</td>
<td>9.04</td>
<td>10.30</td>
<td>9.46</td>
<td>128.9</td>
<td>5960.028</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1990-05-31</th>
<td>3200.6</td>
<td>NaN</td>
<td>7.74</td>
<td>8.60</td>
<td>10.41</td>
<td>9.47</td>
<td>129.1</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="93037475-da13-401a-a68e-2c907568352c" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>macro_raw.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2SL</th>
<th data-quarto-table-cell-role="th">FED_BAL</th>
<th data-quarto-table-cell-role="th">TB3M</th>
<th data-quarto-table-cell-role="th">DGS10</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>22028.8</td>
<td>6642578.0</td>
<td>4.25</td>
<td>4.37</td>
<td>6.10</td>
<td>5.45</td>
<td>322.132</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>22108.4</td>
<td>6603384.0</td>
<td>4.12</td>
<td>4.23</td>
<td>6.00</td>
<td>5.35</td>
<td>323.364</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.5</td>
<td>6608395.0</td>
<td>3.92</td>
<td>4.16</td>
<td>5.83</td>
<td>5.21</td>
<td>324.368</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>22298.1</td>
<td>6587034.0</td>
<td>3.82</td>
<td>4.11</td>
<td>5.74</td>
<td>5.13</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>NaN</td>
<td>6552419.0</td>
<td>NaN</td>
<td>4.00</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="transform-raw-macro-series-into-j-liquidity-proxies-x_t" class="level3">
<h3 class="anchored" data-anchor-id="transform-raw-macro-series-into-j-liquidity-proxies-x_t">Transform Raw Macro Series into <span class="math inline">\(J\)</span> Liquidity Proxies <span class="math inline">\(x_t\)</span></h3>
$ x_t =
<span class="math display">\[\begin{bmatrix}
x_{1,t} \
x_{2,t} \
\vdots \
x_{J,t}
\end{bmatrix}\]</span>
<p><br>
x_{J,t} \end{bmatrix} ^J $</p>
<ul>
<li>Money &amp; balance sheet growth: <span class="math inline">\(\Delta \log(\cdot)\)</span></li>
<li>Term spread: <span class="math inline">\(y_{10} - i_{3m}\)</span></li>
<li>Real short rate: <span class="math inline">\(i_{3m} - \pi_{\text{year-on-year}}\)</span></li>
<li>Credit spread: <span class="math inline">\(\text{BAA} - \text{AAA}\)</span></li>
<li>etc.​</li>
</ul>
<div id="e037f67a-dae5-43bb-a338-7b55b460a53c" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_liquidity_proxies(macro_df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> macro_df.copy()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Growth of M2 and Fed balance sheet</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dlog_M2"</span>] <span class="op">=</span> np.log(df[<span class="st">"M2SL"</span>]).diff()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dlog_FED_BAL"</span>] <span class="op">=</span> np.log(df[<span class="st">"FED_BAL"</span>]).diff()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Term structure: 10Y - 3M</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"term_spread"</span>] <span class="op">=</span> df[<span class="st">"DGS10"</span>] <span class="op">-</span> df[<span class="st">"TB3M"</span>]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Year-on-year inflation (CPI yoy)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"infl_yoy"</span>] <span class="op">=</span> np.log(df[<span class="st">"CPI"</span>]).diff(<span class="dv">12</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Real short rate: nominal 3M - inflation</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"real_rate"</span>] <span class="op">=</span> df[<span class="st">"TB3M"</span>] <span class="op">-</span> (<span class="dv">100</span> <span class="op">*</span> df[<span class="st">"infl_yoy"</span>])  <span class="co"># TB3M in %, infl_yoy in log -&gt; approx*100</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Credit spread: BAA - AAA</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"credit_spread"</span>] <span class="op">=</span> df[<span class="st">"BAA"</span>] <span class="op">-</span> df[<span class="st">"AAA"</span>]</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop rows with NaNs from diff(12) etc.</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    proxies <span class="op">=</span> df[[<span class="st">"dlog_M2"</span>, <span class="st">"dlog_FED_BAL"</span>, <span class="st">"term_spread"</span>,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"real_rate"</span>, <span class="st">"credit_spread"</span>]].dropna()</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> proxies</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>liquidity_proxies <span class="op">=</span> build_liquidity_proxies(macro_raw)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8846f757-4e43-4aed-845c-f7b1d058e426" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>liquidity_proxies.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dlog_M2</th>
<th data-quarto-table-cell-role="th">dlog_FED_BAL</th>
<th data-quarto-table-cell-role="th">term_spread</th>
<th data-quarto-table-cell-role="th">real_rate</th>
<th data-quarto-table-cell-role="th">credit_spread</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>0.002610</td>
<td>-0.005385</td>
<td>0.16</td>
<td>1.901852</td>
<td>0.75</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>0.005255</td>
<td>-0.001656</td>
<td>0.01</td>
<td>1.592409</td>
<td>0.69</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>0.003930</td>
<td>-0.002950</td>
<td>0.12</td>
<td>1.554846</td>
<td>0.65</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>0.003607</td>
<td>-0.005918</td>
<td>0.11</td>
<td>1.223147</td>
<td>0.65</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>0.004698</td>
<td>0.000759</td>
<td>0.24</td>
<td>0.942084</td>
<td>0.62</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="standardize-sign-flip-and-stack-liquidity-proxies-to-get-z_jt" class="level3">
<h3 class="anchored" data-anchor-id="standardize-sign-flip-and-stack-liquidity-proxies-to-get-z_jt">Standardize, Sign-Flip and Stack Liquidity Proxies to Get <span class="math inline">\(z_{j,t}\)</span></h3>
<p>We want higher <span class="math inline">\(z_{j,t}\)</span> – to mean easier liquidity.</p>
<ul>
<li>Growth of M2 / Fed balance sheet: already “easier = higher value” -&gt; keeping sign</li>
<li>Term spread: steeper (more positive) often associated with easier conditions -&gt; keeping sign</li>
<li>Real rate: easier liquidity when real rates are low -&gt; flipping sign</li>
<li>Credit spread: easier liquidity when spreads are tight (low) -&gt; flipping sign</li>
</ul>
<div id="00deb5e9-7372-404c-a872-15aaa066c852" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> standardize_and_signflip(proxies: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Standardize each column and flip signs so that higher z_{j,t}</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">    always corresponds to easier liquidity.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> proxies.copy()</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    z_vals <span class="op">=</span> scaler.fit_transform(z)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> pd.DataFrame(z_vals, index<span class="op">=</span>z.index, columns<span class="op">=</span>z.columns)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sign flips so "higher" = easier liquidity</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dlog_M2: easier when higher -&gt; keep</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dlog_FED_BAL: easier when higher -&gt; keep</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># term_spread: easier when steeper -&gt; keep (or adjust, depending on your view)</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># real_rate: easier when more negative -&gt; flip sign</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># credit_spread: easier when lower -&gt; flip sign</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    sign_flips <span class="op">=</span> {</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dlog_M2"</span>: <span class="op">+</span><span class="dv">1</span>,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dlog_FED_BAL"</span>: <span class="op">+</span><span class="dv">1</span>,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"term_spread"</span>: <span class="op">+</span><span class="dv">1</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"real_rate"</span>: <span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"credit_spread"</span>: <span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col, sgn <span class="kw">in</span> sign_flips.items():</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        z[col] <span class="op">=</span> sgn <span class="op">*</span> z[col]</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> z</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>z_t <span class="op">=</span> standardize_and_signflip(liquidity_proxies)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0cfd8829-7870-4d9f-9e4f-873e95fdd4fe" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>z_t.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dlog_M2</th>
<th data-quarto-table-cell-role="th">dlog_FED_BAL</th>
<th data-quarto-table-cell-role="th">term_spread</th>
<th data-quarto-table-cell-role="th">real_rate</th>
<th data-quarto-table-cell-role="th">credit_spread</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>-0.377813</td>
<td>-0.314009</td>
<td>-0.968292</td>
<td>-1.362581</td>
<td>0.639849</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>0.052579</td>
<td>-0.226920</td>
<td>-1.085244</td>
<td>-1.211510</td>
<td>0.786085</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-0.163048</td>
<td>-0.257126</td>
<td>-0.999479</td>
<td>-1.193172</td>
<td>0.883576</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-0.215601</td>
<td>-0.326453</td>
<td>-1.007276</td>
<td>-1.031235</td>
<td>0.883576</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-0.038105</td>
<td>-0.170518</td>
<td>-0.905917</td>
<td>-0.894019</td>
<td>0.956694</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sparse-pca-liquidity-index-l_t" class="level3">
<h3 class="anchored" data-anchor-id="sparse-pca-liquidity-index-l_t">Sparse PCA Liquidity Index <span class="math inline">\(L_{t}\)</span></h3>
<div id="fa2901dd-276d-42d1-a9e7-fa9e12c6dac1" class="cell" data-execution_count="81">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>pd.Series(z_t.index).describe()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>count                              273
mean     2014-05-31 08:42:11.868131840
min                2003-01-31 00:00:00
25%                2008-09-30 00:00:00
50%                2014-05-31 00:00:00
75%                2020-01-31 00:00:00
max                2025-09-30 00:00:00
Name: DATE, dtype: object</code></pre>
</div>
</div>
<div id="c487ec96-abbc-42c3-809d-2f6b8e9200fc" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>z_t.values</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>array([[ 0.11561096, -0.81061174,  1.11346119,  0.322683  , -0.40817503],
       [ 0.20510346,  0.11034372,  0.8873532 ,  0.50696464, -0.23756644],
       [-0.24145055, -0.0901311 ,  1.01210244,  0.46925598, -0.11570316],
       ...,
       [-0.163048  , -0.25712611, -0.999479  , -1.1931718 ,  0.88357574],
       [-0.2156006 , -0.32645261, -1.00727583, -1.03123533,  0.88357574],
       [-0.03810504, -0.17051847, -0.90591708, -0.89401934,  0.95669371]])</code></pre>
</div>
</div>
<div id="22f22dd0-3c7b-4aff-89ed-8fcc5c5de664" class="cell" data-execution_count="91">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_sparse_pca_liquidity_index(z_df: pd.DataFrame,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                                     alpha: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                     random_state: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply SparsePCA with 1 component to z_{j,t} to obtain L_t.</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    spca <span class="op">=</span> SparsePCA(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        n_components<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span>alpha,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>random_state</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit on standardized proxies</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    L_scores <span class="op">=</span> spca.fit_transform(z_df.values)  <span class="co"># shape (T, 1)</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> pd.Series(L_scores.flatten(), index<span class="op">=</span>z_df.index, name<span class="op">=</span><span class="st">"L"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: enforce that L_t is positively correlated with dlog_M2</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># corr = np.corrcoef(L, z_df["dlog_FED_BAL"])[0, 1]</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if corr &lt; 0:</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     L = -L</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SparsePCA components (loadings):"</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> coef, col <span class="kw">in</span> <span class="bu">zip</span>(spca.components_[<span class="dv">0</span>], z_df.columns):</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>coef<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>L_t <span class="op">=</span> build_sparse_pca_liquidity_index(z_t, alpha<span class="op">=</span><span class="fl">0.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SparsePCA components (loadings):
  dlog_M2: 0.430
  dlog_FED_BAL: 0.526
  term_spread: 0.492
  real_rate: 0.389
  credit_spread: -0.381</code></pre>
</div>
</div>
<div id="9ca94cc3-5549-4470-a48b-7cf3a4c886b4" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>L_t.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>DATE
2003-01-31    0.447153
2003-02-28    0.861556
2003-03-31    0.567234
2003-04-30    0.979006
2003-05-31    0.696500
Freq: M, Name: L, dtype: float64</code></pre>
</div>
</div>
<div id="f1a1246c-fe23-403c-aed1-3af3fc18e600" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>L_t.plot(title<span class="op">=</span><span class="st">"Sparse PCA Liquidity Index L(t)"</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">0</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hmm-markov-regime-detection-on-l_t" class="level3">
<h3 class="anchored" data-anchor-id="hmm-markov-regime-detection-on-l_t">HMM / Markov Regime Detection on <span class="math inline">\(L_t\)</span></h3>
<p>​Fit a Gaussian HMM on the liquidity index. 2 or 3 regimes ?</p>
<div id="31367413-2efd-4b03-aa4a-c81137cfbaba" class="cell" data-execution_count="66">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hmmlearn.hmm <span class="im">import</span> GaussianHMM</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit_hmm_on_liquidity(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    L: pd.Series,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    n_states: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    covariance_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">"full"</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    random_state: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    standardize: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Fit a Gaussian HMM on L(t) and return the model and a DataFrame</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    with inferred regimes and posterior probabilities.</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">    L : pd.Series</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Liquidity index (indexed by date).</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">    n_states : int</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of hidden states (regimes).</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co">    standardize : bool</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co">        If True, standardize L before fitting the HMM.</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co">    model : GaussianHMM</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co">    df_regime : pd.DataFrame</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns: L, state, p_state_k, state_label</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) Prepare X</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> L.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> <span class="va">None</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> standardize:</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) Fit HMM</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> GaussianHMM(</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        n_components<span class="op">=</span>n_states,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        covariance_type<span class="op">=</span>covariance_type,</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>random_state,</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>        n_iter<span class="op">=</span><span class="dv">500</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>    model.fit(X)</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    hidden_states <span class="op">=</span> model.predict(X)</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    post_probs <span class="op">=</span> model.predict_proba(X)  <span class="co"># T x n_states</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) Build output DataFrame on original index</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>    df_regime <span class="op">=</span> pd.DataFrame(</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"L"</span>: L, <span class="st">"state"</span>: hidden_states},</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>L.index</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(n_states):</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>        df_regime[<span class="ss">f"p_state_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> post_probs[:, k]</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) Use state means to order regimes</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> pd.Series(model.means_.flatten(), index<span class="op">=</span><span class="bu">range</span>(n_states))</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"HMM state means (unsorted, in fitted scale):"</span>)</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, m <span class="kw">in</span> means.items():</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  state </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: mean L = </span><span class="sc">{</span>m<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Order states from low liquidity to high liquidity</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    ordering <span class="op">=</span> means.sort_values().index.tolist()</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    state_label_map <span class="op">=</span> {}</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_states <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>        state_label_map[ordering[<span class="dv">0</span>]] <span class="op">=</span> <span class="st">"Tight"</span></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>        state_label_map[ordering[<span class="dv">1</span>]] <span class="op">=</span> <span class="st">"Neutral"</span></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>        state_label_map[ordering[<span class="dv">2</span>]] <span class="op">=</span> <span class="st">"High"</span></span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> n_states <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>        state_label_map[ordering[<span class="dv">0</span>]] <span class="op">=</span> <span class="st">"Tight"</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>        state_label_map[ordering[<span class="dv">1</span>]] <span class="op">=</span> <span class="st">"High"</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generic labels if you ever use more states</span></span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, s <span class="kw">in</span> <span class="bu">enumerate</span>(ordering):</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>            state_label_map[s] <span class="op">=</span> <span class="ss">f"Regime_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>    df_regime[<span class="st">"state_label"</span>] <span class="op">=</span> df_regime[<span class="st">"state"</span>].<span class="bu">map</span>(state_label_map)</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, df_regime</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e1a99b29-c613-41d2-a297-12f0f12729ed" class="cell" data-execution_count="156">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>n_states <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>model, regimes_df <span class="op">=</span> fit_hmm_on_liquidity(L_t,n_states)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>HMM state means (unsorted, in fitted scale):
  state 0: mean L = -0.160
  state 1: mean L = -0.106
  state 2: mean L = 2.718</code></pre>
</div>
</div>
<div id="eb499457-693d-4338-a026-e98c5a331a58" class="cell" data-execution_count="158">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>means <span class="op">=</span> pd.Series(model.means_.flatten(), index<span class="op">=</span><span class="bu">range</span>(n_states))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>means</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="158">
<pre><code>0   -0.159797
1   -0.105787
2    2.717670
dtype: float64</code></pre>
</div>
</div>
<div id="2f031232-40cb-47ef-8607-61a290fcf924" class="cell" data-execution_count="157">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>regimes_df.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="157">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">p_state_2</th>
<th data-quarto-table-cell-role="th">state_label</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>-1.561611</td>
<td>0</td>
<td>0.837436</td>
<td>0.162306</td>
<td>0.000258</td>
<td>Tight</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>-1.387057</td>
<td>1</td>
<td>0.162268</td>
<td>0.837667</td>
<td>0.000066</td>
<td>Neutral</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-1.482573</td>
<td>0</td>
<td>0.837414</td>
<td>0.162331</td>
<td>0.000255</td>
<td>Tight</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-1.482572</td>
<td>1</td>
<td>0.162274</td>
<td>0.837635</td>
<td>0.000091</td>
<td>Neutral</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-1.251226</td>
<td>0</td>
<td>0.836419</td>
<td>0.162339</td>
<td>0.001242</td>
<td>Tight</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="5f36427e-915a-458c-853e-6b35095ed5cf" class="cell" data-execution_count="82">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># TOP PANEL — L(t) + shading</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].plot(regimes_df.index, regimes_df[<span class="st">"L"</span>], color<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="fl">1.2</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Sparse PCA Liquidity Index L(t) with Regime Shading"</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Define plain colors for each regime</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>regime_colors <span class="op">=</span> {</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tight"</span>:   <span class="st">"green"</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Neutral"</span>: <span class="st">"gray"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"High"</span>:    <span class="st">"crimson"</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>shade_alpha <span class="op">=</span> <span class="fl">0.2</span>  <span class="co"># semi-opaque</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label, color <span class="kw">in</span> regime_colors.items():</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> regimes_df[<span class="st">"state_label"</span>] <span class="op">==</span> label</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    in_region <span class="op">=</span> <span class="va">False</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="va">None</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(mask)):</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mask.iloc[i] <span class="kw">and</span> <span class="kw">not</span> in_region:</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>            in_region <span class="op">=</span> <span class="va">True</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> regimes_df.index[i]</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="kw">not</span> mask.iloc[i] <span class="kw">and</span> in_region:</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>            in_region <span class="op">=</span> <span class="va">False</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> regimes_df.index[i]</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>            ax[<span class="dv">0</span>].axvspan(start, end, color<span class="op">=</span>color, alpha<span class="op">=</span>shade_alpha, linewidth<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If region extends to the end of the sample</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> in_region:</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>        ax[<span class="dv">0</span>].axvspan(start, regimes_df.index[<span class="op">-</span><span class="dv">1</span>], color<span class="op">=</span>color, alpha<span class="op">=</span>shade_alpha, linewidth<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Legend for regimes (shaded colors)</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.lines <span class="im">import</span> Line2D</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>legend_patches <span class="op">=</span> [</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">"green"</span>,   lw<span class="op">=</span><span class="dv">6</span>, alpha<span class="op">=</span>shade_alpha, label<span class="op">=</span><span class="st">"Tight"</span>),</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">"gray"</span>,    lw<span class="op">=</span><span class="dv">6</span>, alpha<span class="op">=</span>shade_alpha, label<span class="op">=</span><span class="st">"Neutral"</span>),</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>    Line2D([<span class="dv">0</span>], [<span class="dv">0</span>], color<span class="op">=</span><span class="st">"crimson"</span>, lw<span class="op">=</span><span class="dv">6</span>, alpha<span class="op">=</span>shade_alpha, label<span class="op">=</span><span class="st">"High"</span>),</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].legend(handles<span class="op">=</span>legend_patches, loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a><span class="co"># BOTTOM PANEL — High regime probability</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"p_state_0"</span> <span class="kw">in</span> regimes_df.columns:</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    high_state_id <span class="op">=</span> regimes_df.groupby(<span class="st">"state_label"</span>)[<span class="st">"state"</span>].first()[<span class="st">"High"</span>]</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].plot(regimes_df.index,</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>               regimes_df[<span class="ss">f"p_state_</span><span class="sc">{</span>high_state_id<span class="sc">}</span><span class="ss">"</span>],</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span><span class="st">"crimson"</span>, lw<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    ax[<span class="dv">1</span>].set_title(<span class="st">"Posterior Probability of High Liquidity Regime"</span>)</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="equity-factor-data-famafrench" class="level3">
<h3 class="anchored" data-anchor-id="equity-factor-data-famafrench">Equity Factor Data (Fama–French)</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/9845e494-dbbc-4be7-b3b4-5dff7c897fe7-1-6a346252-d5d4-4144-9c69-10966ab34764.png" class="img-fluid figure-img"></p>
<figcaption>image.png</figcaption>
</figure>
</div>
<p>These five factors extend the original 3-factor model to better explain cross-sectional stock returns.</p>
<p>They are:</p>
<ol type="1">
<li><strong>Rm–Rf</strong> — Market excess return</li>
<li><strong>SMB</strong> — Size (Small Minus Big)</li>
<li><strong>HML</strong> — Value (High Book/Market minus Low)</li>
<li><strong>RMW</strong> — Profitability (Robust Minus Weak)</li>
<li><strong>CMA</strong> — Investment (Conservative Minus Aggressive)</li>
</ol>
<p>Let’s break each down precisely.</p>
<hr>
<section id="rm-rf-market-excess-return" class="level4">
<h4 class="anchored" data-anchor-id="rm-rf-market-excess-return"><strong>Rm – Rf: Market Excess Return</strong></h4>
<p><span class="math display">\[
R_{m}-R_{f}
\]</span> The return of the <strong>broad market</strong> minus the <strong>risk-free rate</strong>.</p>
<ul>
<li>Positive → market went up more than cash.</li>
<li>Negative → market underperformed cash/T-bills.</li>
</ul>
<p><strong>In above table:</strong></p>
<ul>
<li>Last 12 months: <strong>+17.54%</strong> → very strong bull market year.</li>
<li>Last 3 months: <strong>+7.40%</strong> → strong quarter.</li>
<li>October 2025: <strong>+1.95%</strong> → moderate positive month.</li>
</ul>
<hr>
</section>
<section id="smb-size-factor-small-minus-big" class="level4">
<h4 class="anchored" data-anchor-id="smb-size-factor-small-minus-big"><strong>SMB: Size Factor (Small Minus Big)</strong></h4>
<p><span class="math display">\[
\text{SMB} = R_{\text{small}} - R_{\text{big}}
\]</span></p>
<ul>
<li>Positive → small caps outperform large caps.</li>
<li>Negative → large caps outperform small caps.</li>
</ul>
<p><strong>In above table:</strong></p>
<ul>
<li>Last 12 months: <strong>–10.71%</strong> → a <em>massive</em> large-cap dominance year.</li>
<li>This is consistent with mega-cap tech leadership.</li>
</ul>
<hr>
</section>
<section id="hml-value-factor-high-minus-low-book-to-market" class="level4">
<h4 class="anchored" data-anchor-id="hml-value-factor-high-minus-low-book-to-market"><strong>HML: Value Factor (High Minus Low Book-to-Market)</strong></h4>
<p><span class="math display">\[
\text{HML} = R_{\text{value}} - R_{\text{growth}}
\]</span></p>
<ul>
<li>Positive → value outperforms growth.</li>
<li>Negative → growth outperforms value.</li>
</ul>
<p><strong>In above table:</strong></p>
<ul>
<li>Last 12 months: <strong>–2.36%</strong> → growth beat value.</li>
<li>October 2025: <strong>–3.10%</strong> → especially growth-heavy month.</li>
</ul>
<p>This aligns with liquidity-driven growth leadership.</p>
<hr>
</section>
<section id="rmw-profitability-robust-minus-weak" class="level4">
<h4 class="anchored" data-anchor-id="rmw-profitability-robust-minus-weak"><strong>RMW: Profitability (Robust Minus Weak)</strong></h4>
<p><span class="math display">\[
\text{RMW} = R_{\text{robust}} - R_{\text{weak}}
\]</span></p>
<p>Robust = high operating profitability. Weak = low profitability.</p>
<ul>
<li>Positive → profitable companies outperform weak ones.</li>
<li>Negative → weak/low-profit companies outperform.</li>
</ul>
<p><strong>In above table:</strong></p>
<ul>
<li>Last 12 months: <strong>–13.60%</strong> → very unusual.</li>
<li>This means <strong>unprofitable firms outperformed</strong> profitable ones over the year.</li>
</ul>
<p>That usually happens in:</p>
<ul>
<li>early speculative bubbles</li>
<li>liquidity-driven rallies</li>
<li>retail-led tech/small-cap frenzies</li>
<li>AI/futuristic narrative periods</li>
</ul>
<hr>
</section>
<section id="cma-investment-factor-conservative-minus-aggressive" class="level4">
<h4 class="anchored" data-anchor-id="cma-investment-factor-conservative-minus-aggressive"><strong>CMA: Investment Factor (Conservative Minus Aggressive)</strong></h4>
<p><span class="math display">\[
\text{CMA} = R_{\text{conservative}} - R_{\text{aggressive}}
\]</span></p>
<ul>
<li>Conservative = firms investing slowly</li>
<li>Aggressive = firms aggressively expanding assets</li>
</ul>
<p>High investment → lower expected returns historically (consistent with q-theory: empire-building destroys value).</p>
<ul>
<li>Positive → conservative firms outperform heavy spenders.</li>
<li>Negative → aggressive investment firms outperform.</li>
</ul>
<p><strong>In above table:</strong></p>
<ul>
<li>Last 12 months: <strong>–10.46%</strong></li>
<li>Last 3 months: <strong>–4.47%</strong></li>
<li>October 2025: <strong>–4.03%</strong></li>
</ul>
<p>Interpretation: Aggressively investing companies — think AI, R&amp;D, biotech, high-growth tech — massively outperformed low-investment firms.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 65%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th>Factor</th>
<th>Sign</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Rm–Rf: +</strong></td>
<td>Strong bull market</td>
<td></td>
</tr>
<tr class="even">
<td><strong>SMB: –</strong></td>
<td>Mega-caps beat small caps massively</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>HML: –</strong></td>
<td>Growth beat value</td>
<td></td>
</tr>
<tr class="even">
<td><strong>RMW: –</strong></td>
<td>Low-profit firms beat profitable firms</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>CMA: –</strong></td>
<td>Aggressive-investment firms beat conservative ones</td>
<td></td>
</tr>
</tbody>
</table>
<p>This is the <strong>textbook signature of a liquidity-driven growth/tech momentum regime</strong>, almost identical to:</p>
<ul>
<li>1998–1999 Dotcom</li>
<li>2019–2021 QE wave</li>
<li>2023–2024 AI mega-cap boom</li>
</ul>
<p>It means:</p>
</section>
<section id="investors-preferred" class="level4">
<h4 class="anchored" data-anchor-id="investors-preferred">Investors preferred</h4>
<ul>
<li>large</li>
<li>growth</li>
<li>unprofitable</li>
<li>high-spending</li>
<li>high-duration <strong>tech/AI/future-theme stocks</strong></li>
</ul>
</section>
<section id="fundamentals-profitability-valuation-conservative-investment-were-penalized" class="level4">
<h4 class="anchored" data-anchor-id="fundamentals-profitability-valuation-conservative-investment-were-penalized">Fundamentals (profitability, valuation, conservative investment) were <em>penalized</em></h4>
<p>This is exactly the kind of environment where:</p>
<ul>
<li>Value fails</li>
<li>Small cap fails</li>
<li>Profitability fails</li>
<li>Investment works negatively</li>
<li>Growth dominates</li>
<li>Mega-caps dominate</li>
</ul>
<div id="61a50746-539d-4114-8f6b-1452b00ae55d" class="cell" data-execution_count="69">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_ff_factors(start, end):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Download monthly Fama-French 5 factors (2x3) using pandas_datareader.</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Downloading Fama-French factors (famafrench)..."</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    ff_raw <span class="op">=</span> pdr.DataReader(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>FF_FACTORS_DATASET,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        data_source<span class="op">=</span><span class="st">"famafrench"</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        start<span class="op">=</span>start,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        end<span class="op">=</span>end</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    )[<span class="dv">0</span>]  <span class="co"># table [0] contains the data</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    ff <span class="op">=</span> (ff_raw</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>          .divide(<span class="dv">100</span>)  <span class="co"># convert from % to decimal</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>          .reset_index(names<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>          .assign(date<span class="op">=</span><span class="kw">lambda</span> x: pd.to_datetime(x[<span class="st">"date"</span>].astype(<span class="bu">str</span>)))</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>          .rename(<span class="bu">str</span>.lower, axis<span class="op">=</span><span class="st">"columns"</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>          .rename(columns<span class="op">=</span>{<span class="st">"mkt-rf"</span>: <span class="st">"mkt_excess"</span>}))</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    ff <span class="op">=</span> ff.set_index(<span class="st">"date"</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ff</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>ff_factors <span class="op">=</span> download_ff_factors(start_date, end_date)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading Fama-French factors (famafrench)...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_raw = pdr.DataReader(
&lt;ipython-input-69-55f7e03990a5&gt;:6: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_raw = pdr.DataReader(</code></pre>
</div>
</div>
<div id="b4549377-7aa7-428a-b1e7-90b8c2b507c6" class="cell" data-execution_count="70">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>ff_factors.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-06-01</th>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0160</td>
<td>-0.0320</td>
<td>0.0145</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-07-01</th>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-01</th>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0068</td>
<td>0.0207</td>
<td>0.0038</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-01</th>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-10-01</th>
<td>0.0195</td>
<td>-0.0131</td>
<td>-0.0310</td>
<td>-0.0522</td>
<td>-0.0403</td>
<td>0.0037</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="fix-famafrench-dates-shift-one-month-backward-to-align-with-regimes_df" class="level4">
<h4 class="anchored" data-anchor-id="fix-famafrench-dates-shift-one-month-backward-to-align-with-regimes_df">Fix Fama–French dates (shift one month backward) to align with <code>regimes_df</code></h4>
<div id="a9d15ae6-9f1a-471e-8136-4ddad6d81c66" class="cell" data-execution_count="83">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix Fama–French dates (shift one month backward)</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>ff_adj <span class="op">=</span> ff_factors.copy()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># FF data comes labeled as YYYY-MM-01 meaning return for previous month.</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># So shift index back to previous month-end.</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>ff_adj.index <span class="op">=</span> (ff_adj.index.to_period(<span class="st">"M"</span>) <span class="op">-</span> <span class="dv">1</span>).to_timestamp(<span class="st">"M"</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>ff_adj.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0160</td>
<td>-0.0320</td>
<td>0.0145</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0068</td>
<td>0.0207</td>
<td>0.0038</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>0.0195</td>
<td>-0.0131</td>
<td>-0.0310</td>
<td>-0.0522</td>
<td>-0.0403</td>
<td>0.0037</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="join-regimes_df-with-famafrench-factors" class="level4">
<h4 class="anchored" data-anchor-id="join-regimes_df-with-famafrench-factors">Join regimes_df with Fama–French factors</h4>
<div id="bfc54de2-549c-41b7-a2dd-b1ce8c5a364a" class="cell" data-execution_count="84">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure regimes are month-end</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> regimes_df.copy()</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>reg.index <span class="op">=</span> reg.index.to_period(<span class="st">"M"</span>).to_timestamp(<span class="st">"M"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Join on month-end date</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> reg.join(ff_adj, how<span class="op">=</span><span class="st">"inner"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6aed8a4b-ff9d-4ab3-b3ba-7aa6dedaf720" class="cell" data-execution_count="86">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>combined.tail(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">p_state_2</th>
<th data-quarto-table-cell-role="th">state_label</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-12-31</th>
<td>-1.651021</td>
<td>1</td>
<td>0.162158</td>
<td>0.837762</td>
<td>0.000079</td>
<td>Tight</td>
<td>0.0280</td>
<td>-0.0123</td>
<td>0.0163</td>
<td>-0.0235</td>
<td>-0.0324</td>
<td>0.0037</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-01-31</th>
<td>-1.496425</td>
<td>0</td>
<td>0.837514</td>
<td>0.162233</td>
<td>0.000253</td>
<td>Tight</td>
<td>-0.0243</td>
<td>-0.0491</td>
<td>0.0491</td>
<td>0.0108</td>
<td>0.0306</td>
<td>0.0033</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-02-28</th>
<td>-1.643180</td>
<td>1</td>
<td>0.162188</td>
<td>0.837738</td>
<td>0.000075</td>
<td>Tight</td>
<td>-0.0639</td>
<td>-0.0149</td>
<td>0.0290</td>
<td>0.0211</td>
<td>-0.0047</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-03-31</th>
<td>-1.627975</td>
<td>0</td>
<td>0.837473</td>
<td>0.162258</td>
<td>0.000269</td>
<td>Tight</td>
<td>-0.0084</td>
<td>-0.0186</td>
<td>-0.0340</td>
<td>-0.0285</td>
<td>-0.0267</td>
<td>0.0035</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-04-30</th>
<td>-1.400432</td>
<td>1</td>
<td>0.162220</td>
<td>0.837714</td>
<td>0.000067</td>
<td>Tight</td>
<td>0.0606</td>
<td>-0.0072</td>
<td>-0.0288</td>
<td>0.0129</td>
<td>0.0251</td>
<td>0.0038</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>-1.561611</td>
<td>0</td>
<td>0.837459</td>
<td>0.162284</td>
<td>0.000258</td>
<td>Tight</td>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0160</td>
<td>-0.0320</td>
<td>0.0145</td>
<td>0.0034</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>-1.387057</td>
<td>1</td>
<td>0.162245</td>
<td>0.837689</td>
<td>0.000066</td>
<td>Tight</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-1.482573</td>
<td>0</td>
<td>0.837437</td>
<td>0.162308</td>
<td>0.000255</td>
<td>Tight</td>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0068</td>
<td>0.0207</td>
<td>0.0038</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-1.482572</td>
<td>1</td>
<td>0.162251</td>
<td>0.837658</td>
<td>0.000091</td>
<td>Tight</td>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-1.251226</td>
<td>0</td>
<td>0.836442</td>
<td>0.162316</td>
<td>0.001242</td>
<td>Tight</td>
<td>0.0195</td>
<td>-0.0131</td>
<td>-0.0310</td>
<td>-0.0522</td>
<td>-0.0403</td>
<td>0.0037</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="factor-returns-by-liquidity-regime" class="level3">
<h3 class="anchored" data-anchor-id="factor-returns-by-liquidity-regime">Factor returns by liquidity regime</h3>
<div id="eca12a49-72b7-40c6-bcfb-9e969d52c860" class="cell" data-execution_count="87">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> combined.copy()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Regime at t (end-of-month) predicting factor returns at t+1</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>df2[<span class="st">"state_label_lag1"</span>] <span class="op">=</span> df2[<span class="st">"state_label"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop first row (no lag)</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> df2.dropna(subset<span class="op">=</span>[<span class="st">"state_label_lag1"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>])</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Regime-wise averages (conditional on *previous* month's liquidity)</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>means_by_regime <span class="op">=</span> (</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    df2.groupby(<span class="st">"state_label_lag1"</span>)[[<span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>       .mean()</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>std_by_regime <span class="op">=</span> (</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    df2.groupby(<span class="st">"state_label_lag1"</span>)[[<span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>       .std()</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>sharpe_by_regime <span class="op">=</span> means_by_regime <span class="op">/</span> std_by_regime</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean factor returns by *lagged* regime:"</span>)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(means_by_regime)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean factor returns by *lagged* regime:
                       smb       hml       rmw       cma
state_label_lag1                                        
Tight            -0.005439 -0.005360  0.000540 -0.003311
Neutral           0.003200  0.002938  0.001051 -0.000056
High              0.003327  0.001228  0.005127  0.003575</code></pre>
</div>
</div>
</section>
<section id="whats-going-on" class="level3">
<h3 class="anchored" data-anchor-id="whats-going-on">What’s going on ?</h3>
<p>This is reverse of what you’d expect. In a tight liquidity regime, <span class="math inline">\(R^{smb}\)</span> and <span class="math inline">\(R^{hml}\)</span> should be deeply positive. You’d expect small under-valued companies to outperform big companies with premium valuation.</p>
<p>Let’s go back to the <span class="math inline">\(L_t\)</span> and understand what’s going on</p>
<div id="49eeeef1-963e-407b-b56e-43e06199e348" class="cell" data-execution_count="88">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1: Time series with regimes</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>L_t.index,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>L_t.values,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span>regimes_df[<span class="st">"state"</span>],</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"green"</span>, <span class="dv">1</span>: <span class="st">"orange"</span>, <span class="dv">2</span>: <span class="st">"red"</span>},</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax[<span class="dv">0</span>],</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span><span class="dv">15</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Liquidity Index L(t) with HMM States"</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">"L(t)"</span>)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2: KDE (distribution) by state</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>regimes_df,</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"L"</span>,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"state"</span>,</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"green"</span>, <span class="dv">1</span>: <span class="st">"orange"</span>, <span class="dv">2</span>: <span class="st">"red"</span>},</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax[<span class="dv">1</span>]</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Distribution of L(t) by HMM State"</span>)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">"L(t)"</span>)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>From the KDE (bottom panel):</p>
<ul>
<li>States 0 (green) and 1 (yellow) heavily overlap</li>
<li>Only state 2 (red) is clearly separated — the “high liquidity spike”</li>
<li>This corresponds to crisis/QE events (2008, 2020), where liquidity jumps dramatically</li>
</ul>
<p>So the natural clustering is:</p>
<ul>
<li>One large cluster (normal-tight-neutral combined)</li>
<li>One <strong>rare extreme spike cluster</strong></li>
</ul>
<p>Your HMM is being forced to split the unimodal bulk distribution into two states, resulting in:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>means <span class="op">=</span> pd.Series(model.means_.flatten(), index<span class="op">=</span><span class="bu">range</span>(n_states))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>means</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>   <span class="op">-</span><span class="fl">0.159797</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>   <span class="op">-</span><span class="fl">0.105787</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>    <span class="fl">2.717670</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>dtype: float64</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>I initially thought alpha=0.5 in SparsePCA might be the cause. But the plot shows:</p>
<ul>
<li>L(t) has a healthy dynamic range across time (≈ −2.5 to +12)</li>
<li>The high liquidity cluster is clear and <strong>RARE</strong></li>
<li>The rest of L(t) is genuinely one blob</li>
</ul>
<p>If Sparse PCA was “overshrinking,” L(t) would be compressed; but it is not.</p>
</section>
<section id="question-is-why-high-liquidity-is-rare-look-at-the-kde-of-red-state-2" class="level3">
<h3 class="anchored" data-anchor-id="question-is-why-high-liquidity-is-rare-look-at-the-kde-of-red-state-2">Question is why high liquidity is rare (look at the KDE of red state 2) ?</h3>
<ul>
<li>Is Liquidity is fundamentally spiky ?</li>
<li>Why ?</li>
<li>Am I defining Liquidity incorrectly ?</li>
</ul>
<p>Fed/Treasury continuously debased currency throughout 2008-2019 period. Liquidity injection (bailing out banks during GFC/2008, ZIRP era, M2 stimulius of 2019 are visible ones). How would I capture this events as proxy of “liquidity” ?</p>
<hr>
<blockquote class="blockquote">
<p>Right now your <span class="math inline">\(L_t\)</span> is basically a <strong>short-horizon “flow” liquidity shock index</strong>.</p>
</blockquote>
<blockquote class="blockquote">
<p>Whereas I’m looking for slow, structural debasement / regime of easy money (2008–2019, QE, ZIRP, etc.).</p>
</blockquote>
<blockquote class="blockquote">
<p>Those are not the same object.</p>
</blockquote>
<p>Because I use 1-month growth rates <span class="math inline">\(\Delta \log(\cdot)\)</span>, my index reacts to spikes / changes, not the level of the monetary stock.</p>
<p>I need to factor in more factors to the liquidity index such as -</p>
<ul>
<li><strong>Level of money / balance sheet relative to trend</strong> / GDP, not just monthly change</li>
<li><strong>Prolonged ZIRP</strong> / negative real rate period</li>
<li><strong>Excess liquidity</strong> over economic activity</li>
</ul>
</section>
<section id="two-layer-liquidity-flow-vs-stock-excess" class="level3">
<h3 class="anchored" data-anchor-id="two-layer-liquidity-flow-vs-stock-excess">Two-layer liquidity: Flow vs Stock / Excess</h3>
<section id="add-level-excess-variables" class="level4">
<h4 class="anchored" data-anchor-id="add-level-excess-variables">Add level / excess variables</h4>
<p>Examples (all can be pulled from FRED):</p>
<p><strong>Log level vs pre-2008 trend</strong></p>
<p>Let <span class="math inline">\(m_t = \log M2_t\)</span>. Fit a linear trend on a pre-QE baseline (say 1985–2007):</p>
<p><span class="math inline">\(m_t \approx a + bt \quad (t \le 2007)\)</span></p>
<p>Then define excess money stock:</p>
<p><span class="math inline">\(EM_t = m_t - (a + bt)\)</span></p>
<p>After 2008, <span class="math inline">\(EM_t\)</span> becomes increasingly positive if M2 grows above its historical trend.</p>
<p>Similarly for the Fed Balance Sheet, let <span class="math inline">\(b_t = \log(\text{FedBal}_t)\)</span>:</p>
<p><span class="math inline">\(EB_t = b_t - (\alpha + \beta t)\)</span> (pre-2007 trend)</p>
<hr>
<p><strong>Excess liquidity versus real economy</strong></p>
<p>Use real GDP series (e.g., GDPC1) and define:</p>
<p><span class="math inline">\(EL_t = \log M2_t - \log GDP_t\)</span></p>
<p>Or measure multi-year excess growth:</p>
<p><span class="math inline">\(EL_t(3y) = \log M2_t - \log M2_{t-36} - (\log GDP_t - \log GDP_{t-36})\)</span></p>
<hr>
<p><strong>ZIRP / negative real-rate indicator</strong></p>
<p><span class="math inline">\(D_t^{ZIRP} = 1(r_t^{real} &lt; 0)\)</span></p>
<p>From 2009–2015, this should be mostly 1.</p>
<hr>
</section>
<section id="build-an-augmented-feature-vector" class="level4">
<h4 class="anchored" data-anchor-id="build-an-augmented-feature-vector">Build an augmented feature vector</h4>
<p>Instead of only:</p>
<p><span class="math inline">\(x_t = \{ \Delta \log M2_t,\; \Delta \log FedBal_t,\; TS_t,\; r_t^{real},\; CS_t \}\)</span></p>
<p>Let’s expand to:</p>
<p><span class="math inline">\(x_t^{aug} = \{
\Delta \log M2_t,\;
\Delta \log FedBal_t,\;
TS_t,\;
r_t^{real},\;
CS_t,\;
EM_t,\;
EB_t,\;
EL_t,\;
EL_t(3y),\;
D_t^{ZIRP}
\}\)</span></p>
<p>Then standardize and perform PCA / SparsePCA on this.</p>
<ul>
<li><strong>PC1</strong> (or a combination) loading heavily on <span class="math inline">\(EM\)</span>, <span class="math inline">\(EB\)</span>, <span class="math inline">\(EL\)</span>, <span class="math inline">\(D_t^{ZIRP}\)</span> → structural easy-money regime<br>
</li>
<li><strong>PC2</strong> (or your current PC1) loading on short-horizon changes → flow / shock liquidity</li>
</ul>
<div id="8cb1e9bb-aab5-4ba2-883a-07fcb826d355" class="cell" data-execution_count="100">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>macro_raw.tail(<span class="dv">20</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2SL</th>
<th data-quarto-table-cell-role="th">FED_BAL</th>
<th data-quarto-table-cell-role="th">TB3M</th>
<th data-quarto-table-cell-role="th">DGS10</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">GDP</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-05-31</th>
<td>20989.4</td>
<td>7284319.0</td>
<td>5.25</td>
<td>4.51</td>
<td>5.95</td>
<td>5.25</td>
<td>313.140</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-06-30</th>
<td>21053.0</td>
<td>7231163.0</td>
<td>5.24</td>
<td>4.36</td>
<td>5.82</td>
<td>5.13</td>
<td>313.131</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-31</th>
<td>21084.2</td>
<td>7178391.0</td>
<td>5.20</td>
<td>4.09</td>
<td>5.84</td>
<td>5.12</td>
<td>313.566</td>
<td>29511.664</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-08-31</th>
<td>21171.0</td>
<td>7123238.0</td>
<td>5.05</td>
<td>3.91</td>
<td>5.60</td>
<td>4.87</td>
<td>314.131</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-09-30</th>
<td>21257.5</td>
<td>7080059.0</td>
<td>4.72</td>
<td>3.81</td>
<td>5.42</td>
<td>4.68</td>
<td>314.851</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-10-31</th>
<td>21308.1</td>
<td>7013490.0</td>
<td>4.51</td>
<td>4.28</td>
<td>5.63</td>
<td>4.95</td>
<td>315.564</td>
<td>29825.182</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-11-30</th>
<td>21407.9</td>
<td>6905140.0</td>
<td>4.42</td>
<td>4.18</td>
<td>5.78</td>
<td>5.14</td>
<td>316.449</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-12-31</th>
<td>21424.5</td>
<td>6885963.0</td>
<td>4.27</td>
<td>4.58</td>
<td>5.80</td>
<td>5.20</td>
<td>317.603</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-01-31</th>
<td>21492.4</td>
<td>6818186.0</td>
<td>4.21</td>
<td>4.58</td>
<td>6.08</td>
<td>5.46</td>
<td>319.086</td>
<td>30042.113</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-02-28</th>
<td>21564.6</td>
<td>6766101.0</td>
<td>4.22</td>
<td>4.24</td>
<td>5.92</td>
<td>5.32</td>
<td>319.775</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-03-31</th>
<td>21636.7</td>
<td>6740253.0</td>
<td>4.20</td>
<td>4.23</td>
<td>5.93</td>
<td>5.29</td>
<td>319.615</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-04-30</th>
<td>21770.5</td>
<td>6709277.0</td>
<td>4.21</td>
<td>4.17</td>
<td>6.18</td>
<td>5.45</td>
<td>320.321</td>
<td>30485.729</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>21827.4</td>
<td>6673244.0</td>
<td>4.25</td>
<td>4.41</td>
<td>6.29</td>
<td>5.54</td>
<td>320.580</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>21942.4</td>
<td>6662200.0</td>
<td>4.23</td>
<td>4.24</td>
<td>6.15</td>
<td>5.46</td>
<td>321.500</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>22028.8</td>
<td>6642578.0</td>
<td>4.25</td>
<td>4.37</td>
<td>6.10</td>
<td>5.45</td>
<td>322.132</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>22108.4</td>
<td>6603384.0</td>
<td>4.12</td>
<td>4.23</td>
<td>6.00</td>
<td>5.35</td>
<td>323.364</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.5</td>
<td>6608395.0</td>
<td>3.92</td>
<td>4.16</td>
<td>5.83</td>
<td>5.21</td>
<td>324.368</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>22298.1</td>
<td>6587034.0</td>
<td>3.82</td>
<td>4.11</td>
<td>5.74</td>
<td>5.13</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>NaN</td>
<td>6552419.0</td>
<td>3.78</td>
<td>4.02</td>
<td>5.86</td>
<td>5.26</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-12-31</th>
<td>NaN</td>
<td>6535781.0</td>
<td>NaN</td>
<td>4.11</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="da853d89-fec4-48e9-b33c-ad4a0e68f3a0" class="cell" data-execution_count="134">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Start from the original GDP values only (drop NaNs)</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>gdp_series <span class="op">=</span> macro_raw[<span class="st">"GDP"</span>].dropna()</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Collapse to unique quarter-end values</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">#    - If GDP is timestamped at quarter *start* (e.g. 2025-04-01),</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">#      this will move it to the quarter end (2025-06-30) and give unique labels.</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>gdp_q <span class="op">=</span> gdp_series.resample(<span class="st">"Q"</span>).last()   <span class="co"># quarterly, at quarter-end (e.g. 2025-03-31, 2025-06-30, ...)</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Upsample to monthly and forward-fill within the quarter</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>gdp_m <span class="op">=</span> gdp_q.resample(<span class="st">"M"</span>).ffill()</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Assign back into macro_raw, aligning on the monthly index</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>macro_raw[<span class="st">"GDP"</span>] <span class="op">=</span> gdp_m</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>macro_raw.tail(<span class="dv">20</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="134">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2SL</th>
<th data-quarto-table-cell-role="th">FED_BAL</th>
<th data-quarto-table-cell-role="th">TB3M</th>
<th data-quarto-table-cell-role="th">DGS10</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">GDP</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-05-31</th>
<td>20989.4</td>
<td>7284319.0</td>
<td>5.25</td>
<td>4.51</td>
<td>5.95</td>
<td>5.25</td>
<td>313.140</td>
<td>28708.161</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-06-30</th>
<td>21053.0</td>
<td>7231163.0</td>
<td>5.24</td>
<td>4.36</td>
<td>5.82</td>
<td>5.13</td>
<td>313.131</td>
<td>29147.044</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-07-31</th>
<td>21084.2</td>
<td>7178391.0</td>
<td>5.20</td>
<td>4.09</td>
<td>5.84</td>
<td>5.12</td>
<td>313.566</td>
<td>29147.044</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-08-31</th>
<td>21171.0</td>
<td>7123238.0</td>
<td>5.05</td>
<td>3.91</td>
<td>5.60</td>
<td>4.87</td>
<td>314.131</td>
<td>29147.044</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-09-30</th>
<td>21257.5</td>
<td>7080059.0</td>
<td>4.72</td>
<td>3.81</td>
<td>5.42</td>
<td>4.68</td>
<td>314.851</td>
<td>29511.664</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-10-31</th>
<td>21308.1</td>
<td>7013490.0</td>
<td>4.51</td>
<td>4.28</td>
<td>5.63</td>
<td>4.95</td>
<td>315.564</td>
<td>29511.664</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-11-30</th>
<td>21407.9</td>
<td>6905140.0</td>
<td>4.42</td>
<td>4.18</td>
<td>5.78</td>
<td>5.14</td>
<td>316.449</td>
<td>29511.664</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-12-31</th>
<td>21424.5</td>
<td>6885963.0</td>
<td>4.27</td>
<td>4.58</td>
<td>5.80</td>
<td>5.20</td>
<td>317.603</td>
<td>29825.182</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-01-31</th>
<td>21492.4</td>
<td>6818186.0</td>
<td>4.21</td>
<td>4.58</td>
<td>6.08</td>
<td>5.46</td>
<td>319.086</td>
<td>29825.182</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-02-28</th>
<td>21564.6</td>
<td>6766101.0</td>
<td>4.22</td>
<td>4.24</td>
<td>5.92</td>
<td>5.32</td>
<td>319.775</td>
<td>29825.182</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-03-31</th>
<td>21636.7</td>
<td>6740253.0</td>
<td>4.20</td>
<td>4.23</td>
<td>5.93</td>
<td>5.29</td>
<td>319.615</td>
<td>30042.113</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-04-30</th>
<td>21770.5</td>
<td>6709277.0</td>
<td>4.21</td>
<td>4.17</td>
<td>6.18</td>
<td>5.45</td>
<td>320.321</td>
<td>30042.113</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>21827.4</td>
<td>6673244.0</td>
<td>4.25</td>
<td>4.41</td>
<td>6.29</td>
<td>5.54</td>
<td>320.580</td>
<td>30042.113</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>21942.4</td>
<td>6662200.0</td>
<td>4.23</td>
<td>4.24</td>
<td>6.15</td>
<td>5.46</td>
<td>321.500</td>
<td>30485.729</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>22028.8</td>
<td>6642578.0</td>
<td>4.25</td>
<td>4.37</td>
<td>6.10</td>
<td>5.45</td>
<td>322.132</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>22108.4</td>
<td>6603384.0</td>
<td>4.12</td>
<td>4.23</td>
<td>6.00</td>
<td>5.35</td>
<td>323.364</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.5</td>
<td>6608395.0</td>
<td>3.92</td>
<td>4.16</td>
<td>5.83</td>
<td>5.21</td>
<td>324.368</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>22298.1</td>
<td>6587034.0</td>
<td>3.82</td>
<td>4.11</td>
<td>5.74</td>
<td>5.13</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>NaN</td>
<td>6552419.0</td>
<td>3.78</td>
<td>4.02</td>
<td>5.86</td>
<td>5.26</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-12-31</th>
<td>NaN</td>
<td>6535781.0</td>
<td>NaN</td>
<td>4.11</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="b2f4cea5-c7ba-496e-aaa7-63b96b91d2f2" class="cell" data-execution_count="136">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_liquidity_proxies_augmented(macro_df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> macro_df.copy()</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Flow proxies</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dlog_M2"</span>]       <span class="op">=</span> np.log(df[<span class="st">"M2SL"</span>]).diff()</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dlog_FED_BAL"</span>]  <span class="op">=</span> np.log(df[<span class="st">"FED_BAL"</span>]).diff()</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"term_spread"</span>]   <span class="op">=</span> df[<span class="st">"DGS10"</span>] <span class="op">-</span> df[<span class="st">"TB3M"</span>]</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"infl_yoy"</span>]      <span class="op">=</span> np.log(df[<span class="st">"CPI"</span>]).diff(<span class="dv">12</span>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"real_rate"</span>]     <span class="op">=</span> df[<span class="st">"TB3M"</span>] <span class="op">-</span> <span class="dv">100</span> <span class="op">*</span> df[<span class="st">"infl_yoy"</span>]</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"credit_spread"</span>] <span class="op">=</span> df[<span class="st">"BAA"</span>] <span class="op">-</span> df[<span class="st">"AAA"</span>]</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Levels</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_M2"</span>]      <span class="op">=</span> np.log(df[<span class="st">"M2SL"</span>])</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_FED_BAL"</span>] <span class="op">=</span> np.log(df[<span class="st">"FED_BAL"</span>])</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use data up to 2007-12-31 to fit trends</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    pre <span class="op">=</span> df.loc[: <span class="st">"2007-12-31"</span>].copy()</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Trend for M2 ---</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    pre_m2 <span class="op">=</span> pre[<span class="st">"log_M2"</span>].dropna()</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    t_m2   <span class="op">=</span> np.arange(<span class="bu">len</span>(pre_m2))</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    coefs_M2 <span class="op">=</span> np.polyfit(t_m2, pre_m2.values, deg<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    t_full <span class="op">=</span> np.arange(<span class="bu">len</span>(df))</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>    trend_M2 <span class="op">=</span> np.polyval(coefs_M2, t_full)</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"EM"</span>] <span class="op">=</span> df[<span class="st">"log_M2"</span>] <span class="op">-</span> trend_M2</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Trend for Fed balance sheet ---</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    pre_fb <span class="op">=</span> pre[<span class="st">"log_FED_BAL"</span>].dropna()</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    t_fb   <span class="op">=</span> np.arange(<span class="bu">len</span>(pre_fb))</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>    coefs_FB <span class="op">=</span> np.polyfit(t_fb, pre_fb.values, deg<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>    trend_FB <span class="op">=</span> np.polyval(coefs_FB, t_full)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"EB"</span>] <span class="op">=</span> df[<span class="st">"log_FED_BAL"</span>] <span class="op">-</span> trend_FB</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Excess liquidity vs GDP over 3y</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_GDP"</span>] <span class="op">=</span> np.log(df[<span class="st">"GDP"</span>])</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"EL_3y"</span>] <span class="op">=</span> (df[<span class="st">"log_M2"</span>] <span class="op">-</span> df[<span class="st">"log_M2"</span>].shift(<span class="dv">36</span>)) <span class="op">-</span> <span class="op">\</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>                  (df[<span class="st">"log_GDP"</span>] <span class="op">-</span> df[<span class="st">"log_GDP"</span>].shift(<span class="dv">36</span>))</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. ZIRP dummy</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ZIRP_dummy"</span>] <span class="op">=</span> (df[<span class="st">"real_rate"</span>] <span class="op">&lt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Build augmented proxy matrix</span></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>    cols_aug <span class="op">=</span> [</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dlog_M2"</span>, <span class="st">"dlog_FED_BAL"</span>, <span class="st">"term_spread"</span>, <span class="st">"real_rate"</span>, <span class="st">"credit_spread"</span>,</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"EM"</span>, <span class="st">"EB"</span>, <span class="st">"EL_3y"</span>, <span class="st">"ZIRP_dummy"</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[cols_aug].dropna()</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>liquidity_proxies_aug <span class="op">=</span> build_liquidity_proxies_augmented(macro_raw)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6f01b5d3-29be-4590-b669-b4477759ff06" class="cell" data-execution_count="137">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>liquidity_proxies_aug.tail(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="137">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dlog_M2</th>
<th data-quarto-table-cell-role="th">dlog_FED_BAL</th>
<th data-quarto-table-cell-role="th">term_spread</th>
<th data-quarto-table-cell-role="th">real_rate</th>
<th data-quarto-table-cell-role="th">credit_spread</th>
<th data-quarto-table-cell-role="th">EM</th>
<th data-quarto-table-cell-role="th">EB</th>
<th data-quarto-table-cell-role="th">EL_3y</th>
<th data-quarto-table-cell-role="th">ZIRP_dummy</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-09-30</th>
<td>0.004077</td>
<td>-0.006080</td>
<td>-0.91</td>
<td>2.316574</td>
<td>0.74</td>
<td>0.204864</td>
<td>0.811903</td>
<td>-0.194283</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-10-31</th>
<td>0.002378</td>
<td>-0.009447</td>
<td>-0.23</td>
<td>1.971101</td>
<td>0.68</td>
<td>0.202921</td>
<td>0.798940</td>
<td>-0.199645</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-11-30</th>
<td>0.004673</td>
<td>-0.015569</td>
<td>-0.24</td>
<td>1.742012</td>
<td>0.64</td>
<td>0.203273</td>
<td>0.779855</td>
<td>-0.203197</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-12-31</th>
<td>0.000775</td>
<td>-0.002781</td>
<td>0.31</td>
<td>1.438113</td>
<td>0.60</td>
<td>0.199728</td>
<td>0.773558</td>
<td>-0.186129</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-01-31</th>
<td>0.003164</td>
<td>-0.009892</td>
<td>0.37</td>
<td>1.254690</td>
<td>0.62</td>
<td>0.198572</td>
<td>0.760151</td>
<td>-0.188367</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-02-28</th>
<td>0.003354</td>
<td>-0.007668</td>
<td>0.02</td>
<td>1.444603</td>
<td>0.60</td>
<td>0.197605</td>
<td>0.748966</td>
<td>-0.189520</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-03-31</th>
<td>0.003338</td>
<td>-0.003828</td>
<td>0.03</td>
<td>1.822893</td>
<td>0.64</td>
<td>0.196623</td>
<td>0.741623</td>
<td>-0.177663</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-04-30</th>
<td>0.006165</td>
<td>-0.004606</td>
<td>-0.04</td>
<td>1.903069</td>
<td>0.73</td>
<td>0.198467</td>
<td>0.733501</td>
<td>-0.172818</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>0.002610</td>
<td>-0.005385</td>
<td>0.16</td>
<td>1.901852</td>
<td>0.75</td>
<td>0.196757</td>
<td>0.724600</td>
<td>-0.167478</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>0.005255</td>
<td>-0.001656</td>
<td>0.01</td>
<td>1.592409</td>
<td>0.69</td>
<td>0.197692</td>
<td>0.719428</td>
<td>-0.150768</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="0b0a41da-a64f-4c22-b573-bdd90ae5a08a" class="cell" data-execution_count="138">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>z1_t <span class="op">=</span> standardize_and_signflip(liquidity_proxies_aug)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>z1_t.tail(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="138">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dlog_M2</th>
<th data-quarto-table-cell-role="th">dlog_FED_BAL</th>
<th data-quarto-table-cell-role="th">term_spread</th>
<th data-quarto-table-cell-role="th">real_rate</th>
<th data-quarto-table-cell-role="th">credit_spread</th>
<th data-quarto-table-cell-role="th">EM</th>
<th data-quarto-table-cell-role="th">EB</th>
<th data-quarto-table-cell-role="th">EL_3y</th>
<th data-quarto-table-cell-role="th">ZIRP_dummy</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-09-30</th>
<td>-0.139814</td>
<td>-0.331324</td>
<td>-1.812889</td>
<td>-1.577541</td>
<td>0.673692</td>
<td>0.888682</td>
<td>0.786734</td>
<td>-2.353880</td>
<td>-1.527525</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-10-31</th>
<td>-0.414988</td>
<td>-0.409551</td>
<td>-1.282837</td>
<td>-1.408779</td>
<td>0.819794</td>
<td>0.868074</td>
<td>0.764262</td>
<td>-2.404333</td>
<td>-1.527525</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-11-30</th>
<td>-0.043456</td>
<td>-0.551814</td>
<td>-1.290631</td>
<td>-1.296871</td>
<td>0.917195</td>
<td>0.871811</td>
<td>0.731177</td>
<td>-2.437752</td>
<td>-1.527525</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-12-31</th>
<td>-0.674370</td>
<td>-0.254667</td>
<td>-0.861913</td>
<td>-1.148418</td>
<td>1.014596</td>
<td>0.834206</td>
<td>0.720261</td>
<td>-2.277159</td>
<td>-1.527525</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-01-31</th>
<td>-0.287635</td>
<td>-0.419885</td>
<td>-0.815143</td>
<td>-1.058817</td>
<td>0.965896</td>
<td>0.821943</td>
<td>0.697018</td>
<td>-2.298214</td>
<td>-1.527525</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-02-28</th>
<td>-0.256970</td>
<td>-0.368230</td>
<td>-1.087964</td>
<td>-1.151588</td>
<td>1.014596</td>
<td>0.811689</td>
<td>0.677630</td>
<td>-2.309059</td>
<td>-1.527525</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-03-31</th>
<td>-0.259533</td>
<td>-0.278983</td>
<td>-1.080169</td>
<td>-1.336381</td>
<td>0.917195</td>
<td>0.801267</td>
<td>0.664900</td>
<td>-2.197496</td>
<td>-1.527525</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-04-30</th>
<td>0.198084</td>
<td>-0.297077</td>
<td>-1.134734</td>
<td>-1.375546</td>
<td>0.698042</td>
<td>0.820833</td>
<td>0.650819</td>
<td>-2.151913</td>
<td>-1.527525</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>-0.377318</td>
<td>-0.315174</td>
<td>-0.978836</td>
<td>-1.374952</td>
<td>0.649342</td>
<td>0.802693</td>
<td>0.635389</td>
<td>-2.101665</td>
<td>-1.527525</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>0.050761</td>
<td>-0.228533</td>
<td>-1.095759</td>
<td>-1.223790</td>
<td>0.795443</td>
<td>0.812604</td>
<td>0.626423</td>
<td>-1.944440</td>
<td>-1.527525</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="7b90e8e2-7be4-4910-aabb-35b163254685" class="cell" data-execution_count="139">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>L1_t <span class="op">=</span> build_sparse_pca_liquidity_index(z1_t, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>L1_t.tail(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SparsePCA components (loadings):
  dlog_M2: -0.132
  dlog_FED_BAL: -0.159
  term_spread: -0.389
  real_rate: -0.515
  credit_spread: 0.046
  EM: -0.114
  EB: -0.134
  EL_3y: -0.518
  ZIRP_dummy: -0.490</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="139">
<pre><code>DATE
2024-09-30    3.347080
2024-10-31    3.143188
2024-11-30    3.088484
2024-12-31    2.811365
2025-01-31    2.736110
2025-02-28    2.887801
2025-03-31    2.906425
2025-04-30    2.856634
2025-05-31    2.850481
2025-06-30    2.674924
Freq: M, Name: L, dtype: float64</code></pre>
</div>
</div>
<div id="02fb59fe-c47f-4657-895a-2bcdec3690ed" class="cell" data-execution_count="195">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>L1_t.plot(title<span class="op">=</span><span class="st">"Sparse PCA Liquidity Index L(t) - Augmented w/ Flow &amp; Stock Indicators"</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">0</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="3e63886f-768b-4d7a-92ac-8d1019441466" class="cell" data-execution_count="161">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>model, regimes_aug_df <span class="op">=</span> fit_hmm_on_liquidity(L1_t,n_states<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>HMM state means (unsorted, in fitted scale):
  state 0: mean L = -0.484
  state 1: mean L = 1.536</code></pre>
</div>
</div>
<div id="fb483b2e-7f0e-464a-b22d-b3bb99d1bc48" class="cell" data-execution_count="162">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>regime_aug_df.tail(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="162">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">state_label</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-09-30</th>
<td>3.347080</td>
<td>1</td>
<td>7.082075e-08</td>
<td>1.000000</td>
<td>High</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-10-31</th>
<td>3.143188</td>
<td>1</td>
<td>1.226701e-07</td>
<td>1.000000</td>
<td>High</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-11-30</th>
<td>3.088484</td>
<td>1</td>
<td>1.441515e-07</td>
<td>1.000000</td>
<td>High</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-12-31</th>
<td>2.811365</td>
<td>1</td>
<td>3.564580e-07</td>
<td>1.000000</td>
<td>High</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-01-31</th>
<td>2.736110</td>
<td>1</td>
<td>4.676727e-07</td>
<td>1.000000</td>
<td>High</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-02-28</th>
<td>2.887801</td>
<td>1</td>
<td>2.736315e-07</td>
<td>1.000000</td>
<td>High</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-03-31</th>
<td>2.906425</td>
<td>1</td>
<td>2.569518e-07</td>
<td>1.000000</td>
<td>High</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-04-30</th>
<td>2.856634</td>
<td>1</td>
<td>3.043360e-07</td>
<td>1.000000</td>
<td>High</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>2.850481</td>
<td>1</td>
<td>3.200660e-07</td>
<td>1.000000</td>
<td>High</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>2.674924</td>
<td>1</td>
<td>2.893931e-05</td>
<td>0.999971</td>
<td>High</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="613ef9ee-689d-49fb-b707-9f18f23d4e1b" class="cell" data-execution_count="163">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure regimes are month-end</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> regimes_aug_df.copy()</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>reg.index <span class="op">=</span> reg.index.to_period(<span class="st">"M"</span>).to_timestamp(<span class="st">"M"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Join on month-end date</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>combined_aug <span class="op">=</span> reg.join(ff_adj, how<span class="op">=</span><span class="st">"inner"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="60b9083a-cab1-4d79-96a2-8d7ed878924b" class="cell" data-execution_count="164">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>combined_aug.tail(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="164">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">state_label</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-09-30</th>
<td>3.347080</td>
<td>1</td>
<td>7.082075e-08</td>
<td>1.000000</td>
<td>High</td>
<td>-0.0100</td>
<td>-0.0089</td>
<td>0.0086</td>
<td>-0.0148</td>
<td>0.0098</td>
<td>0.0039</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-10-31</th>
<td>3.143188</td>
<td>1</td>
<td>1.226701e-07</td>
<td>1.000000</td>
<td>High</td>
<td>0.0649</td>
<td>0.0459</td>
<td>0.0015</td>
<td>-0.0231</td>
<td>-0.0205</td>
<td>0.0040</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2024-11-30</th>
<td>3.088484</td>
<td>1</td>
<td>1.441515e-07</td>
<td>1.000000</td>
<td>High</td>
<td>-0.0315</td>
<td>-0.0383</td>
<td>-0.0300</td>
<td>0.0189</td>
<td>-0.0121</td>
<td>0.0037</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2024-12-31</th>
<td>2.811365</td>
<td>1</td>
<td>3.564580e-07</td>
<td>1.000000</td>
<td>High</td>
<td>0.0280</td>
<td>-0.0123</td>
<td>0.0163</td>
<td>-0.0235</td>
<td>-0.0324</td>
<td>0.0037</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-01-31</th>
<td>2.736110</td>
<td>1</td>
<td>4.676727e-07</td>
<td>1.000000</td>
<td>High</td>
<td>-0.0243</td>
<td>-0.0491</td>
<td>0.0491</td>
<td>0.0108</td>
<td>0.0306</td>
<td>0.0033</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-02-28</th>
<td>2.887801</td>
<td>1</td>
<td>2.736315e-07</td>
<td>1.000000</td>
<td>High</td>
<td>-0.0639</td>
<td>-0.0149</td>
<td>0.0290</td>
<td>0.0211</td>
<td>-0.0047</td>
<td>0.0034</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-03-31</th>
<td>2.906425</td>
<td>1</td>
<td>2.569518e-07</td>
<td>1.000000</td>
<td>High</td>
<td>-0.0084</td>
<td>-0.0186</td>
<td>-0.0340</td>
<td>-0.0285</td>
<td>-0.0267</td>
<td>0.0035</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-04-30</th>
<td>2.856634</td>
<td>1</td>
<td>3.043360e-07</td>
<td>1.000000</td>
<td>High</td>
<td>0.0606</td>
<td>-0.0072</td>
<td>-0.0288</td>
<td>0.0129</td>
<td>0.0251</td>
<td>0.0038</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>2.850481</td>
<td>1</td>
<td>3.200660e-07</td>
<td>1.000000</td>
<td>High</td>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0160</td>
<td>-0.0320</td>
<td>0.0145</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>2.674924</td>
<td>1</td>
<td>2.893931e-05</td>
<td>0.999971</td>
<td>High</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="14e56528-0be4-4475-8bca-556d0f7ed575" class="cell" data-execution_count="165">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> combined_aug.copy()</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Regime at t (end-of-month) predicting factor returns at t+1</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>df2[<span class="st">"state_label_lag1"</span>] <span class="op">=</span> df2[<span class="st">"state_label"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop first row (no lag)</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>df2 <span class="op">=</span> df2.dropna(subset<span class="op">=</span>[<span class="st">"state_label_lag1"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>])</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Regime-wise averages (conditional on *previous* month's liquidity)</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>means_by_regime <span class="op">=</span> (</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    df2.groupby(<span class="st">"state_label_lag1"</span>)[[<span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>       .mean()</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>std_by_regime <span class="op">=</span> (</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    df2.groupby(<span class="st">"state_label_lag1"</span>)[[<span class="st">"smb"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>       .std()</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>sharpe_by_regime <span class="op">=</span> means_by_regime <span class="op">/</span> std_by_regime</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Mean factor returns by Liquidity Regime:"</span>)</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(means_by_regime)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean factor returns by Liquidity Regime:
                       smb       hml       rmw       cma
state_label_lag1                                        
High             -0.004519 -0.001700  0.001564 -0.003006
Tight             0.001896  0.000038  0.002920  0.001302</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="yes" class="level2">
<h2 class="anchored" data-anchor-id="yes">Yes !!</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 14%">
<col style="width: 28%">
<col style="width: 29%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>Factor</th>
<th>High Liquidity</th>
<th>Tight Liquidity</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>SMB</strong></td>
<td>Negative</td>
<td>Positive</td>
<td>Small caps thrive when liquidity tightens</td>
</tr>
<tr class="even">
<td><strong>HML</strong></td>
<td>Negative</td>
<td>Slightly positive</td>
<td>Value improves in tight regimes</td>
</tr>
<tr class="odd">
<td><strong>RMW</strong></td>
<td>Positive</td>
<td>More positive</td>
<td>Profitability is the strongest cross-regime performer</td>
</tr>
<tr class="even">
<td><strong>CMA</strong></td>
<td>Negative</td>
<td>Positive</td>
<td>Conservative investment becomes favored when liquidity tightens</td>
</tr>
</tbody>
</table>
<div id="2aba7bcf-2da6-42fb-b56c-d5bc9ac7e346" class="cell" data-execution_count="159">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1: Time series with regimes</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>sns.scatterplot(</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>L1_t.index,</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>L1_t.values,</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span>regimes_aug_df[<span class="st">"state"</span>],</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"green"</span>, <span class="dv">1</span>: <span class="st">"red"</span>},</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax[<span class="dv">0</span>],</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span><span class="dv">15</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Augmented Liquidity Index L(t) with HMM States"</span>)</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">"Augmented L(t)"</span>)</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2: KDE (distribution) by state</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>regimes_aug_df,</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"L"</span>,</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"state"</span>,</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>    fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"green"</span>, <span class="dv">1</span>: <span class="st">"red"</span>},</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax[<span class="dv">1</span>]</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Distribution/KDE of Augmented L(t) by HMM State"</span>)</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">"Augmented L(t)"</span>)</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-39-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In KDE of augmented liquidity index <span class="math inline">\(L_t^{aug}\)</span>, clusters are clearly separated, unlike last one</p>
<section id="sp-500-monthly-prices" class="level3">
<h3 class="anchored" data-anchor-id="sp-500-monthly-prices">S&amp;P 500 monthly prices</h3>
</section>
<section id="cape-data-from-httpsshillerdata.com" class="level3">
<h3 class="anchored" data-anchor-id="cape-data-from-httpsshillerdata.com">CAPE Data from https://shillerdata.com/</h3>
<div id="97e00120-9798-43b7-8bf6-4b9594c65329" class="cell" data-execution_count="173">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_yyyy_mm_to_date(s: <span class="bu">str</span>):</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert 'YYYY.MM' to a proper datetime.</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Handles the special case where October appears as YYYY.1 instead of YYYY.10.</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(s).strip()</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> s.split(<span class="st">"."</span>)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(parts) <span class="op">!=</span> <span class="dv">2</span>:</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unexpected date format: </span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    year <span class="op">=</span> <span class="bu">int</span>(parts[<span class="dv">0</span>])</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    mm <span class="op">=</span> parts[<span class="dv">1</span>]</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fix: "1" should be "10" (October)</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mm <span class="op">==</span> <span class="st">"1"</span>:</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> <span class="bu">int</span>(mm)</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Timestamp(year<span class="op">=</span>year, month<span class="op">=</span>month, day<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load CAPE CSV ---</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>sp500_cape_raw <span class="op">=</span> pd.read_csv(<span class="st">"data/sp500-cape-1990-2025.csv"</span>)</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean + parse</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>sp500_cape_raw[<span class="st">"date"</span>] <span class="op">=</span> sp500_cape_raw[<span class="st">"Date"</span>].<span class="bu">apply</span>(parse_yyyy_mm_to_date)</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>sp500_cape_raw <span class="op">=</span> (</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    sp500_cape_raw[[<span class="st">"date"</span>, <span class="st">"SP500"</span>, <span class="st">"CAPE"</span>]]</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>    .set_index(<span class="st">"date"</span>)</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    .sort_index()</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to month-end aligned CAPE series</span></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>sp500_cape_m <span class="op">=</span> sp500_cape_raw.resample(<span class="st">"M"</span>).last()</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>sp500_cape_m.rename(columns<span class="op">=</span>{<span class="st">"CAPE"</span>: <span class="st">"cape"</span>, <span class="st">"SP500"</span>: <span class="st">"sp500"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>sp500_cape_m.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="173">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sp500</th>
<th data-quarto-table-cell-role="th">cape</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>6408.95</td>
<td>37.85</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>6584.02</td>
<td>38.58</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>6735.69</td>
<td>39.21</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>6740.89</td>
<td>39.12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-12-31</th>
<td>6812.63</td>
<td>39.42</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="from-valuation-levels-into-a-spread-series" class="level3">
<h3 class="anchored" data-anchor-id="from-valuation-levels-into-a-spread-series">From valuation levels into a spread series</h3>
<p><strong>Long-Term Average/Median</strong>: The S&amp;P 500’s historical long-term average CAPE ratio is around 16-18, with a median value of approximately 16.04 (since 1881). This provides a central benchmark.</p>
<p><strong>High Valuation (Expensive)</strong>: A CAPE ratio that is notably higher than the historical average (e.g., above 25 or 30) is considered indicative of a highly valued or overvalued market. Historically, values exceeding 30 have only occurred during major market peaks like the 1929 crash, the dot-com bubble in the late 1990s (peaking over 44), and the post-pandemic period around 2021. Such high readings have typically been followed by periods of lower-than-average, or even negative, long-term returns.</p>
<p><strong>Low Valuation (Cheap)</strong>: A CAPE ratio well below the historical average (e.g., below 15 or 10) suggests an undervalued or cheap market. Historically, such levels have been associated with minimal downside risk and higher average long-term returns.</p>
<p>Could have calculated</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>V_spread <span class="op">=</span> (x <span class="op">-</span> baseline) <span class="op">/</span> baseline <span class="co"># baseline = 16</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Problem is, if the whole world “structurally” shifted (e.g.&nbsp;post-1990 lower inflation), “16” stops being meaningful.</p>
<p>We are instead measuring,</p>
<p><span class="math display">\[
V_t = \frac{CAPE_t - \mathrm{median}(CAPE)}{\mathrm{IQR}(CAPE)}
\]</span></p>
<div id="745a0ebb-debe-4362-bb3a-cc6077a4e579" class="cell" data-execution_count="186">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_valuation_spread_baseline(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    val_df: pd.DataFrame,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    metric: <span class="bu">str</span> <span class="op">=</span> <span class="st">"cape"</span>,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    baseline: <span class="bu">float</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    scale: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> val_df[metric].astype(<span class="bu">float</span>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> baseline <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># robust long-run baseline</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>        median <span class="op">=</span> x.median()</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>        iqr <span class="op">=</span> x.quantile(<span class="fl">0.75</span>) <span class="op">-</span> x.quantile(<span class="fl">0.25</span>)</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>        baseline <span class="op">=</span> median</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>        denom <span class="op">=</span> iqr <span class="cf">if</span> scale <span class="kw">and</span> iqr <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> baseline</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>        denom <span class="op">=</span> baseline <span class="cf">if</span> scale <span class="cf">else</span> <span class="fl">1.0</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    diff <span class="op">=</span> x <span class="op">-</span> baseline          </span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    V_spread <span class="op">=</span> diff <span class="op">/</span> denom <span class="cf">if</span> scale <span class="cf">else</span> diff</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    V_spread.name <span class="op">=</span> <span class="st">"V_spread"</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> V_spread</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: baseline at 16.04 (long-run median)</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>V_spread_t <span class="op">=</span> build_valuation_spread_baseline(</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    sp500_cape_m,</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>    metric<span class="op">=</span><span class="st">"cape"</span>,</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>    baseline<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    scale<span class="op">=</span><span class="va">True</span>,   <span class="co"># or False if you prefer "CAPE points below baseline"</span></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>V_spread_t.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="186">
<pre><code>date
2025-08-31    1.259380
2025-09-30    1.338771
2025-10-31    1.407287
2025-11-30    1.397499
2025-12-31    1.430125
Freq: M, Name: V_spread, dtype: float64</code></pre>
</div>
</div>
<div id="6282aefb-ae21-417a-ae12-ffd396d934f2" class="cell" data-execution_count="188">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>V_spread_t.plot(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">4</span>), title<span class="op">=</span><span class="st">"S&amp;P 500 Valuation Spread (cheap vs own history)"</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">0</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="combine-liquidity-regime-with-valuation-spread" class="level3">
<h3 class="anchored" data-anchor-id="combine-liquidity-regime-with-valuation-spread">Combine Liquidity Regime with Valuation Spread</h3>
<div id="2ec0b08b-a4df-4a55-9964-71cd2dabebc0" class="cell" data-execution_count="190">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>regimes_df.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="190">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">p_state_2</th>
<th data-quarto-table-cell-role="th">state_label</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>-1.561611</td>
<td>0</td>
<td>0.837436</td>
<td>0.162306</td>
<td>0.000258</td>
<td>Tight</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>-1.387057</td>
<td>1</td>
<td>0.162268</td>
<td>0.837667</td>
<td>0.000066</td>
<td>Neutral</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>-1.482573</td>
<td>0</td>
<td>0.837414</td>
<td>0.162331</td>
<td>0.000255</td>
<td>Tight</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>-1.482572</td>
<td>1</td>
<td>0.162274</td>
<td>0.837635</td>
<td>0.000091</td>
<td>Neutral</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>-1.251226</td>
<td>0</td>
<td>0.836419</td>
<td>0.162339</td>
<td>0.001242</td>
<td>Tight</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="9c8d3fa4-d031-443e-b53b-ccb287f201d5" class="cell" data-execution_count="196">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>combined_aug.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="196">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">state_label</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-02-28</th>
<td>2.887801</td>
<td>1</td>
<td>2.736315e-07</td>
<td>1.000000</td>
<td>High</td>
<td>-0.0639</td>
<td>-0.0149</td>
<td>0.0290</td>
<td>0.0211</td>
<td>-0.0047</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-03-31</th>
<td>2.906425</td>
<td>1</td>
<td>2.569518e-07</td>
<td>1.000000</td>
<td>High</td>
<td>-0.0084</td>
<td>-0.0186</td>
<td>-0.0340</td>
<td>-0.0285</td>
<td>-0.0267</td>
<td>0.0035</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-04-30</th>
<td>2.856634</td>
<td>1</td>
<td>3.043360e-07</td>
<td>1.000000</td>
<td>High</td>
<td>0.0606</td>
<td>-0.0072</td>
<td>-0.0288</td>
<td>0.0129</td>
<td>0.0251</td>
<td>0.0038</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>2.850481</td>
<td>1</td>
<td>3.200660e-07</td>
<td>1.000000</td>
<td>High</td>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0160</td>
<td>-0.0320</td>
<td>0.0145</td>
<td>0.0034</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>2.674924</td>
<td>1</td>
<td>2.893931e-05</td>
<td>0.999971</td>
<td>High</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="bad8b500-2a2c-4c59-848c-78531eb4d95b" class="cell" data-execution_count="198">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># regimes_df: index is month-end</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> combined_aug.copy()</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>reg.index <span class="op">=</span> reg.index.to_period(<span class="st">"M"</span>).to_timestamp(<span class="st">"M"</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Align valuation spread to month-end, then join</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>V_spread_m <span class="op">=</span> V_spread_t.resample(<span class="st">"M"</span>).last()</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> (</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    reg</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    .join(V_spread_m.to_frame(), how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>combined.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="198">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">L</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">p_state_0</th>
<th data-quarto-table-cell-role="th">p_state_1</th>
<th data-quarto-table-cell-role="th">state_label</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
<th data-quarto-table-cell-role="th">V_spread</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-02-28</th>
<td>2.887801</td>
<td>1</td>
<td>2.736315e-07</td>
<td>1.000000</td>
<td>High</td>
<td>-0.0639</td>
<td>-0.0149</td>
<td>0.0290</td>
<td>0.0211</td>
<td>-0.0047</td>
<td>0.0034</td>
<td>1.187602</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-03-31</th>
<td>2.906425</td>
<td>1</td>
<td>2.569518e-07</td>
<td>1.000000</td>
<td>High</td>
<td>-0.0084</td>
<td>-0.0186</td>
<td>-0.0340</td>
<td>-0.0285</td>
<td>-0.0267</td>
<td>0.0035</td>
<td>0.925503</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-04-30</th>
<td>2.856634</td>
<td>1</td>
<td>3.043360e-07</td>
<td>1.000000</td>
<td>High</td>
<td>0.0606</td>
<td>-0.0072</td>
<td>-0.0288</td>
<td>0.0129</td>
<td>0.0251</td>
<td>0.0038</td>
<td>0.690593</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-05-31</th>
<td>2.850481</td>
<td>1</td>
<td>3.200660e-07</td>
<td>1.000000</td>
<td>High</td>
<td>0.0486</td>
<td>-0.0002</td>
<td>-0.0160</td>
<td>-0.0320</td>
<td>0.0145</td>
<td>0.0034</td>
<td>0.958129</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-06-30</th>
<td>2.674924</td>
<td>1</td>
<td>2.893931e-05</td>
<td>0.999971</td>
<td>High</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
<td>1.070147</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="regime-conditional-valuation-spreads" class="level3">
<h3 class="anchored" data-anchor-id="regime-conditional-valuation-spreads">Regime-conditional valuation spreads</h3>
</section>
<section id="valuation-spreads-factor-returns-by-regime-math" class="level3">
<h3 class="anchored" data-anchor-id="valuation-spreads-factor-returns-by-regime-math">Valuation Spreads &amp; Factor Returns by Regime Math</h3>
<p>(Valuation spread series, e.g.&nbsp;top–bottom decile)</p>
<p>$ V_t^{} $</p>
<p>(Regime-conditional mean valuation spread)</p>
<p>$ {V}^{(k)} = $</p>
<p>$ ^{(k)} = {_{t=1}^T (_t = k)} $</p>
<p>(Difference in spreads between regimes)</p>
<p>$ ^{()} - ^{()} $</p>
<p>(Factor return in regime ( k ))</p>
<p>$ r_t^{(F)} $</p>
<p>$ {r}_F^{(k)} = $</p>
<p>$ <em>F^{(k)} = {</em>{t=1}^T (_t = k)} $</p>
<p>(Regime-specific Sharpe ratio)</p>
<p>$ _F^{(k)} = $</p>
<div id="e9f8084a-a26b-41f1-bd41-d8fed797c02b" class="cell" data-execution_count="199">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Regime-conditional mean valuation spread:  V̄^(k)</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>val_means_by_regime <span class="op">=</span> (</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    combined</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"state_label"</span>)[<span class="st">"V_spread"</span>]</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>val_stds_by_regime <span class="op">=</span> (</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    combined</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"state_label"</span>)[<span class="st">"V_spread"</span>]</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    .std()</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Regime-conditional mean valuation spread:"</span>)</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(val_means_by_regime)</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Regime-conditional valuation z-score std dev:"</span>)</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(val_stds_by_regime)</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Difference in spreads between regimes:  V̂^(High) − V̂^(Tight)</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> {<span class="st">"High"</span>, <span class="st">"Tight"</span>}.issubset(val_means_by_regime.index):</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    spread_diff <span class="op">=</span> (</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>        val_means_by_regime[<span class="st">"High"</span>] <span class="op">-</span> val_means_by_regime[<span class="st">"Tight"</span>]</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Difference in spreads High − Tight:"</span>)</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(spread_diff)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Regime-conditional mean valuation spread:
state_label
High     0.380274
Tight   -0.049269
Name: V_spread, dtype: float64

Regime-conditional valuation z-score std dev:
state_label
High     0.406851
Tight    0.551632
Name: V_spread, dtype: float64

Difference in spreads High − Tight:
0.42954211798360936</code></pre>
</div>
</div>
</section>
<section id="insigts" class="level3">
<h3 class="anchored" data-anchor-id="insigts">Insigts</h3>
<ul>
<li>Tight liquidity = cheaper markets (value regime),</li>
<li>High liquidity = expensive markets (growth regime).</li>
</ul>
<blockquote class="blockquote">
<p>Markets are ~0.43σ more expensive in High liquidity regimes than Tight liquidity regimes.</p>
</blockquote>
</section>
<section id="plot-lt-sp-500-and-v_spread_t-together-with-regime-shading" class="level3">
<h3 class="anchored" data-anchor-id="plot-lt-sp-500-and-v_spread_t-together-with-regime-shading">Plot L(t), S&amp;P 500, and V_spread_t together with regime shading,</h3>
<div id="a95682e0-35ca-4a72-9d77-cd3280ed8f7d" class="cell" data-execution_count="202">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume you already have:</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   L_t              : pd.Series (liquidity index), monthly, name "L"</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   sp500_cape_m     : DataFrame with column "sp500" (S&amp;P 500)</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   V_spread_t       : pd.Series ("V_spread"), monthly valuation cheapness</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   regimes_df       : DataFrame with column "state_label"</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Build a common monthly dataframe</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>L_t.index.union(sp500_cape_m.index).union(V_spread_t.index))</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>df_plot[<span class="st">"L"</span>]         <span class="op">=</span> L_t.reindex(df_plot.index)</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>df_plot[<span class="st">"spx_price"</span>] <span class="op">=</span> sp500_cape_m[<span class="st">"sp500"</span>].reindex(df_plot.index)</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>df_plot[<span class="st">"V_spread"</span>]  <span class="op">=</span> V_spread_t.reindex(df_plot.index)</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Attach regimes (forward-fill in case of any slight index mismatch)</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>reg_states <span class="op">=</span> combined[<span class="st">"state_label"</span>].reindex(df_plot.index).ffill()</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>df_plot[<span class="st">"state_label"</span>] <span class="op">=</span> reg_states</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: drop rows before we have all three series</span></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df_plot.dropna(subset<span class="op">=</span>[<span class="st">"L"</span>, <span class="st">"spx_price"</span>, <span class="st">"V_spread"</span>, <span class="st">"state_label"</span>])</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Helper: find contiguous regime segments for shading</span></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_regime_segments(states: pd.Series):</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Given a Series of regime labels indexed by date,</span></span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a><span class="co">    return list of (start_date, end_date, label) segments</span></span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a><span class="co">    where the label is constant.</span></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>    segments <span class="op">=</span> []</span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>    prev_label <span class="op">=</span> <span class="va">None</span></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>    start_date <span class="op">=</span> <span class="va">None</span></span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> dt, label <span class="kw">in</span> states.items():</span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prev_label <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a>            prev_label <span class="op">=</span> label</span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a>            start_date <span class="op">=</span> dt</span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> label <span class="op">!=</span> prev_label:</span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># segment ended at previous date</span></span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a>            end_date <span class="op">=</span> dt</span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a>            segments.append((start_date, end_date, prev_label))</span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true" tabindex="-1"></a>            start_date <span class="op">=</span> dt</span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true" tabindex="-1"></a>            prev_label <span class="op">=</span> label</span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># last segment</span></span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> prev_label <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> start_date <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb64-53"><a href="#cb64-53" aria-hidden="true" tabindex="-1"></a>        segments.append((start_date, states.index[<span class="op">-</span><span class="dv">1</span>], prev_label))</span>
<span id="cb64-54"><a href="#cb64-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-55"><a href="#cb64-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> segments</span>
<span id="cb64-56"><a href="#cb64-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-57"><a href="#cb64-57" aria-hidden="true" tabindex="-1"></a>segments <span class="op">=</span> get_regime_segments(df_plot[<span class="st">"state_label"</span>])</span>
<span id="cb64-58"><a href="#cb64-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-59"><a href="#cb64-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Colors for regimes</span></span>
<span id="cb64-60"><a href="#cb64-60" aria-hidden="true" tabindex="-1"></a>regime_colors <span class="op">=</span> {</span>
<span id="cb64-61"><a href="#cb64-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"High"</span>:    <span class="st">"#ffe0e0"</span>,  <span class="co"># pale red</span></span>
<span id="cb64-62"><a href="#cb64-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Neutral"</span>: <span class="st">"#f7f7f7"</span>,  <span class="co"># light gray</span></span>
<span id="cb64-63"><a href="#cb64-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tight"</span>:   <span class="st">"#d1ffd1"</span>,  <span class="co"># pale green</span></span>
<span id="cb64-64"><a href="#cb64-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-65"><a href="#cb64-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-66"><a href="#cb64-66" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Plot: 3 stacked subplots with shared x-axis</span></span>
<span id="cb64-67"><a href="#cb64-67" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>), sharex<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb64-68"><a href="#cb64-68" aria-hidden="true" tabindex="-1"></a>                         gridspec_kw<span class="op">=</span>{<span class="st">"height_ratios"</span>: [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>]})</span>
<span id="cb64-69"><a href="#cb64-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-70"><a href="#cb64-70" aria-hidden="true" tabindex="-1"></a>ax_L, ax_spx, ax_val <span class="op">=</span> axes</span>
<span id="cb64-71"><a href="#cb64-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-72"><a href="#cb64-72" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Shading first so lines render on top ---</span></span>
<span id="cb64-73"><a href="#cb64-73" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (start, end, label) <span class="kw">in</span> segments:</span>
<span id="cb64-74"><a href="#cb64-74" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> regime_colors.get(label, <span class="st">"#f0f0f0"</span>)</span>
<span id="cb64-75"><a href="#cb64-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax <span class="kw">in</span> axes:</span>
<span id="cb64-76"><a href="#cb64-76" aria-hidden="true" tabindex="-1"></a>        ax.axvspan(start, end, color<span class="op">=</span>color, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb64-77"><a href="#cb64-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-78"><a href="#cb64-78" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Panel 1: Liquidity index L(t) ---</span></span>
<span id="cb64-79"><a href="#cb64-79" aria-hidden="true" tabindex="-1"></a>ax_L.plot(df_plot.index, df_plot[<span class="st">"L"</span>], label<span class="op">=</span><span class="st">"L(t)"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb64-80"><a href="#cb64-80" aria-hidden="true" tabindex="-1"></a>ax_L.set_ylabel(<span class="st">"L(t)"</span>)</span>
<span id="cb64-81"><a href="#cb64-81" aria-hidden="true" tabindex="-1"></a>ax_L.set_title(<span class="st">"Liquidity Index, S&amp;P 500, and Valuation Spread by Liquidity Regime"</span>)</span>
<span id="cb64-82"><a href="#cb64-82" aria-hidden="true" tabindex="-1"></a>ax_L.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb64-83"><a href="#cb64-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-84"><a href="#cb64-84" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Panel 2: S&amp;P 500 level ---</span></span>
<span id="cb64-85"><a href="#cb64-85" aria-hidden="true" tabindex="-1"></a>ax_spx.plot(df_plot.index, df_plot[<span class="st">"spx_price"</span>], label<span class="op">=</span><span class="st">"S&amp;P 500"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb64-86"><a href="#cb64-86" aria-hidden="true" tabindex="-1"></a>ax_spx.set_ylabel(<span class="st">"S&amp;P 500"</span>)</span>
<span id="cb64-87"><a href="#cb64-87" aria-hidden="true" tabindex="-1"></a>ax_spx.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb64-88"><a href="#cb64-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-89"><a href="#cb64-89" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Panel 3: Valuation cheapness (V_spread) ---</span></span>
<span id="cb64-90"><a href="#cb64-90" aria-hidden="true" tabindex="-1"></a>ax_val.plot(df_plot.index, df_plot[<span class="st">"V_spread"</span>], label<span class="op">=</span><span class="st">"V_spread (cheap vs baseline)"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb64-91"><a href="#cb64-91" aria-hidden="true" tabindex="-1"></a>ax_val.axhline(<span class="fl">0.0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb64-92"><a href="#cb64-92" aria-hidden="true" tabindex="-1"></a>ax_val.set_ylabel(<span class="st">"V_spread"</span>)</span>
<span id="cb64-93"><a href="#cb64-93" aria-hidden="true" tabindex="-1"></a>ax_val.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb64-94"><a href="#cb64-94" aria-hidden="true" tabindex="-1"></a>ax_val.grid(<span class="va">True</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb64-95"><a href="#cb64-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-96"><a href="#cb64-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional legends</span></span>
<span id="cb64-97"><a href="#cb64-97" aria-hidden="true" tabindex="-1"></a>ax_L.legend(loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb64-98"><a href="#cb64-98" aria-hidden="true" tabindex="-1"></a>ax_spx.legend(loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb64-99"><a href="#cb64-99" aria-hidden="true" tabindex="-1"></a>ax_val.legend(loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb64-100"><a href="#cb64-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-101"><a href="#cb64-101" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb64-102"><a href="#cb64-102" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="Liquidity Regimes and the Death (and Return) of Valuations_files/figure-html/cell-47-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/dbose\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>