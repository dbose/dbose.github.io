<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Expert Financial Analysis">
<meta name="dcterms.date" content="2024-05-22">

<title>Mini-Fund Volatility Regime Backtest Analysis (2000–2024) – Deb Bose</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b3b235ae6ba71d6e5c2a90c00144237d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Deb Bose</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../posts/"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../notebooks/index.html"> 
<span class="menu-text">Notebooks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../papers/index.html"> 
<span class="menu-text">Papers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dbose"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-philosophy-investing-in-enablers-not-just-innovators" id="toc-the-philosophy-investing-in-enablers-not-just-innovators" class="nav-link active" data-scroll-target="#the-philosophy-investing-in-enablers-not-just-innovators">The Philosophy: Investing in Enablers, Not Just Innovators</a></li>
  <li><a href="#initial-portfolio-composition" id="toc-initial-portfolio-composition" class="nav-link" data-scroll-target="#initial-portfolio-composition">Initial Portfolio Composition</a>
  <ul class="collapse">
  <li><a href="#companies-in-the-portfolio" id="toc-companies-in-the-portfolio" class="nav-link" data-scroll-target="#companies-in-the-portfolio">Companies in the Portfolio</a></li>
  <li><a href="#asml-holding-n.v.-asml" id="toc-asml-holding-n.v.-asml" class="nav-link" data-scroll-target="#asml-holding-n.v.-asml"><strong>ASML Holding N.V. (ASML)</strong></a></li>
  <li><a href="#solaredge-technologies-inc.-sedg" id="toc-solaredge-technologies-inc.-sedg" class="nav-link" data-scroll-target="#solaredge-technologies-inc.-sedg"><strong>SolarEdge Technologies, Inc.&nbsp;(SEDG)</strong></a></li>
  <li><a href="#rockwell-automation-inc.-rok" id="toc-rockwell-automation-inc.-rok" class="nav-link" data-scroll-target="#rockwell-automation-inc.-rok"><strong>Rockwell Automation, Inc.&nbsp;(ROK)</strong></a></li>
  <li><a href="#illumina-inc.-ilmn" id="toc-illumina-inc.-ilmn" class="nav-link" data-scroll-target="#illumina-inc.-ilmn"><strong>Illumina, Inc.&nbsp;(ILMN)</strong></a></li>
  <li><a href="#lockheed-martin-corporation-lmt" id="toc-lockheed-martin-corporation-lmt" class="nav-link" data-scroll-target="#lockheed-martin-corporation-lmt"><strong>Lockheed Martin Corporation (LMT)</strong></a></li>
  </ul></li>
  <li><a href="#beginning" id="toc-beginning" class="nav-link" data-scroll-target="#beginning">Beginning</a></li>
  <li><a href="#perf-across-vol-regimes" id="toc-perf-across-vol-regimes" class="nav-link" data-scroll-target="#perf-across-vol-regimes">Perf across vol regimes</a></li>
  <li><a href="#performance-during-recessions" id="toc-performance-during-recessions" class="nav-link" data-scroll-target="#performance-during-recessions">Performance during recessions</a></li>
  <li><a href="#cwarp" id="toc-cwarp" class="nav-link" data-scroll-target="#cwarp">CWARP</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><strong>Mini-Fund Volatility Regime Backtest Analysis (2000–2024)</strong></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Expert Financial Analysis </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 22, 2024</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>This study evaluates the long-term performance and risk metrics of a high-growth “Mini-Fund” portfolio—consisting of ASML, TSLA, BRK-B, MSFT, ABBV, and LMT—relative to the S&amp;P 500 and Nasdaq-100 benchmarks. Using Hidden Markov Models to categorize market behavior into low, mid, and high volatility regimes, the analysis demonstrates that the optimized “Portfolio-GV-O2” consistently outpaced benchmarks, delivering an annualized return of 30.8% and a Sharpe ratio of 1.25, compared to 11.4% and 0.60 for the S&amp;P 500. The portfolio proved highly resilient during historical recessions, yielding a -2.9% return while the S&amp;P 500 declined by 19.4%. Furthermore, the strategic inclusion of the protective TAIL ETF reduced the maximum drawdown from -35.0% to -27.6%, enhancing downside protection without sacrificing significant growth. CWARP values of 162.3 against the S&amp;P 500 and 78.8 against the Nasdaq-100 further validate the portfolio’s superior risk-adjusted efficiency.</p>
  </div>
</div>


</header>


<div id="057ebfce-cff0-4200-8046-24264f3d66f7" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate annualized return</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annualized_return(returns, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    compounded_growth <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns).prod()</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    n_periods <span class="op">=</span> returns.count()</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> compounded_growth <span class="op">**</span> (periods_per_year <span class="op">/</span> n_periods) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate volatility (annualized standard deviation)</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annualized_volatility(returns, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> returns.std() <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Sharpe Ratio</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sharpe_ratio(returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    excess_returns <span class="op">=</span> returns <span class="op">-</span> risk_free_rate <span class="op">/</span> periods_per_year</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean(excess_returns) <span class="op">/</span> np.std(excess_returns) <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Sortino Ratio</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sortino_ratio(returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    downside_returns <span class="op">=</span> returns[returns <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    excess_returns <span class="op">=</span> returns <span class="op">-</span> risk_free_rate <span class="op">/</span> periods_per_year</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean(excess_returns) <span class="op">/</span> downside_returns.std() <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Maximum drawdown</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> max_drawdown(returns):</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    cumulative_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns).cumprod()</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    peak <span class="op">=</span> cumulative_returns.expanding(min_periods<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>()</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    drawdown <span class="op">=</span> (cumulative_returns <span class="op">-</span> peak) <span class="op">/</span> peak</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> drawdown.<span class="bu">min</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="the-philosophy-investing-in-enablers-not-just-innovators" class="level2">
<h2 class="anchored" data-anchor-id="the-philosophy-investing-in-enablers-not-just-innovators">The Philosophy: Investing in Enablers, Not Just Innovators</h2>
<p>The concept of a K-wave, named after economist Nikolai Kondratiev, describes long-term economic cycles driven by technological innovation. Each wave—spanning roughly 40-60 years—ushers in transformative advancements, from the Industrial Revolution to the Information Age. We’re now entering what many believe is the sixth K-wave, propelled by AI, clean energy, and advanced manufacturing. While companies at the forefront of these technologies (e.g., pure-play AI startups or speculative renewable energy firms) often dominate headlines, their volatility can make them risky bets for long-term investors</p>
<p>During the 1848 California Gold Rush, it wasn’t the gold miners who reaped the most consistent rewards—it was the “shovelmakers,” the suppliers of tools and infrastructure, who built lasting wealth by enabling the frenzy. Today, as we stand on the cusp of a new technological era defined by artificial intelligence, renewable energy, and advanced manufacturing, a similar strategy can guide us toward sustainable growth.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://westernmininghistory.com/images/town_gallery/Auburn_Ravine_ca1852-restored-1400.jpg" class="img-fluid figure-img"></p>
<figcaption>Gold Rush</figcaption>
</figure>
</div>
<p>Instead, our mini-fund targets companies that enable these breakthroughs—those building the “picks and shovels” of the modern era. ASML, for instance, powers the semiconductor industry with its photolithography machines, a cornerstone of AI and computing advancements. Tesla, beyond its electric vehicles, drives innovation in energy storage and autonomous driving infrastructure. Microsoft provides cloud computing and AI platforms that underpin countless applications, while Berkshire Hathaway offers stability and diversified exposure to industrial and financial sectors. AbbVie contributes healthcare innovation, a critical pillar of societal progress, and Lockheed Martin strengthens the portfolio with its leadership in aerospace and defense—sectors poised for growth amid geopolitical shifts and technological integration. This blend of high-growth and value stocks creates a portfolio that captures multiple growth trends while maintaining a solid foundation. By avoiding overexposure to speculative “gold miners,” we aim to deliver consistent returns with reduced downside risk—a strategy validated by our backtest results.</p>
</section>
<section id="initial-portfolio-composition" class="level2">
<h2 class="anchored" data-anchor-id="initial-portfolio-composition">Initial Portfolio Composition</h2>
<p>The original portfolio comprises five stocks — <strong>ASML Holding N.V. (ASML), SolarEdge Technologies, Inc.&nbsp;(SEDG), Rockwell Automation, Inc.&nbsp;(ROK), Illumina, Inc.&nbsp;(ILMN), and Lockheed Martin Corporation (LMT)</strong> — each allocated an equal weight of <strong>20%</strong>.</p>
<p>This portfolio was backtested using historical closing prices from <strong>January 1, 2000, to January 1, 2024</strong>, sourced via Yahoo Finance (<code>yf.download</code>). Daily returns were calculated with <code>pct_change()</code> and cleaned with <code>dropna()</code> to ensure data integrity. The portfolio is benchmarked against the <strong>S&amp;P 500 (<code>^GSPC</code>)</strong> and <strong>Nasdaq-100 (<code>^NDX</code>)</strong>, reflecting a strategy to measure performance against broad market and technology-focused indices.</p>
<p>This portfolio embodies the <em>“shovelmakers of tomorrow”</em> philosophy outlined earlier. Rather than chasing speculative leaders in emerging technologies, it targets companies that provide critical infrastructure, tools, and services enabling the next <strong>Kondratiev wave (K-wave)</strong> — such as renewable energy, automation, genomics, and aerospace.</p>
<p>The equal-weight allocation ensures diversification across the following sectors, balancing growth potential with stability:</p>
<ul>
<li><strong>Semiconductors</strong></li>
<li><strong>Solar Energy</strong></li>
<li><strong>Industrial Automation</strong></li>
<li><strong>Genomics</strong></li>
<li><strong>Defense</strong></li>
</ul>
<hr>
<section id="companies-in-the-portfolio" class="level3">
<h3 class="anchored" data-anchor-id="companies-in-the-portfolio">Companies in the Portfolio</h3>
<hr>
</section>
<section id="asml-holding-n.v.-asml" class="level3">
<h3 class="anchored" data-anchor-id="asml-holding-n.v.-asml"><strong>ASML Holding N.V. (ASML)</strong></h3>
<p><strong>Sector:</strong> Technology (Semiconductors)<br>
<strong>Weight:</strong> 20%<br>
<strong>Role:</strong><br>
ASML is the global leader in photolithography systems, essential for manufacturing integrated circuits (microchips). Its extreme ultraviolet (EUV) lithography machines are critical for producing advanced chips used in AI, 5G, and high-performance computing.</p>
<p><strong>K-Wave Relevance:</strong><br>
ASML is a quintessential <em>shovelmaker</em>, supplying the tools that power the semiconductor industry—a backbone of the sixth K-wave. As demand for AI and IoT grows, ASML’s equipment enables chipmakers like TSMC and Intel to push technological boundaries.</p>
<p><strong>Portfolio Fit:</strong><br>
ASML contributes high-growth potential, capitalizing on secular trends in technology, while its dominant market position adds resilience.</p>
<hr>
</section>
<section id="solaredge-technologies-inc.-sedg" class="level3">
<h3 class="anchored" data-anchor-id="solaredge-technologies-inc.-sedg"><strong>SolarEdge Technologies, Inc.&nbsp;(SEDG)</strong></h3>
<p><strong>Sector:</strong> Renewable Energy (Solar)<br>
<strong>Weight:</strong> 20%<br>
<strong>Role:</strong><br>
SolarEdge specializes in power optimizers, inverters, and monitoring systems for solar photovoltaic (PV) installations. Its solutions maximize energy efficiency and reliability for residential, commercial, and utility-scale solar projects.</p>
<p><strong>K-Wave Relevance:</strong><br>
The transition to clean energy is a defining feature of the next K-wave, with solar power at the forefront. SolarEdge’s technologies enhance the scalability and affordability of solar energy, positioning it as an enabler of the renewable revolution. Unlike solar panel manufacturers, SolarEdge focuses on the <em>tools</em> that optimize energy output, aligning with the shovelmaker strategy.</p>
<p><strong>Portfolio Fit:</strong><br>
SEDG introduces exposure to the fast-growing renewable energy sector, offering growth potential tempered by the volatility inherent in clean energy markets.</p>
<hr>
</section>
<section id="rockwell-automation-inc.-rok" class="level3">
<h3 class="anchored" data-anchor-id="rockwell-automation-inc.-rok"><strong>Rockwell Automation, Inc.&nbsp;(ROK)</strong></h3>
<p><strong>Sector:</strong> Industrials (Automation)<br>
<strong>Weight:</strong> 20%<br>
<strong>Role:</strong><br>
Rockwell Automation provides industrial automation and digital transformation solutions, including programmable logic controllers (PLCs), sensors, and software for smart manufacturing. It serves industries like automotive, food and beverage, and pharmaceuticals.</p>
<p><strong>K-Wave Relevance:</strong><br>
Automation is a cornerstone of the sixth K-wave, driving efficiency in manufacturing and supply chains. Rockwell’s technologies enable “Industry 4.0”—the integration of IoT, AI, and robotics into production—making it a key supplier of tools for industrial innovation. Its focus on software and analytics further aligns with digital transformation trends.</p>
<p><strong>Portfolio Fit:</strong><br>
ROK adds a value-oriented component, balancing growth with stability. Its diversified client base mitigates sector-specific risks, enhancing portfolio resilience.</p>
<hr>
</section>
<section id="illumina-inc.-ilmn" class="level3">
<h3 class="anchored" data-anchor-id="illumina-inc.-ilmn"><strong>Illumina, Inc.&nbsp;(ILMN)</strong></h3>
<p><strong>Sector:</strong> Healthcare (Genomics)<br>
<strong>Weight:</strong> 20%<br>
<strong>Role:</strong><br>
Illumina is a leader in DNA sequencing and genomics, providing instruments, reagents, and software for genetic analysis. Its technologies support applications in personalized medicine, cancer research, and agriculture.</p>
<p><strong>K-Wave Relevance:</strong><br>
Genomics is poised to transform healthcare, a critical pillar of societal progress in the next K-wave. Illumina’s sequencing platforms are the <em>shovels</em> of this revolution, enabling researchers and clinicians to decode genetic data at scale. Its dominance in sequencing technology ensures long-term growth potential.</p>
<p><strong>Portfolio Fit:</strong><br>
ILMN brings exposure to healthcare innovation, a sector with defensive qualities and high growth. It diversifies the portfolio away from pure technology, reducing correlation with market cycles.</p>
<hr>
</section>
<section id="lockheed-martin-corporation-lmt" class="level3">
<h3 class="anchored" data-anchor-id="lockheed-martin-corporation-lmt"><strong>Lockheed Martin Corporation (LMT)</strong></h3>
<p><strong>Sector:</strong> Aerospace and Defense<br>
<strong>Weight:</strong> 20%<br>
<strong>Role:</strong><br>
Lockheed Martin is a global leader in aerospace, defense, and security, known for products like the F-35 fighter jet, missile systems, and space technologies. It serves government and commercial clients worldwide.</p>
<p><strong>K-Wave Relevance:</strong><br>
Defense and aerospace are integral to the next K-wave, driven by geopolitical dynamics and technological advancements (e.g., hypersonics, space exploration). Lockheed Martin’s role as a systems integrator and innovator positions it as an enabler of national security and space infrastructure—a stable <em>shovelmaker</em> in a high-stakes field.</p>
<p><strong>Portfolio Fit:</strong><br>
LMT anchors the portfolio with defensive characteristics, offering steady cash flows and dividends. Its low correlation with tech sectors enhances diversification, mitigating downside risk during market downturns. ownside risk during market downturns.</p>
<div id="2743db8c-d0ec-49d1-81f8-b1734b131145" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stocks and benchmark indices</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'SEDG'</span>, <span class="st">'ROK'</span>, <span class="st">'ILMN'</span>, <span class="st">'LMT'</span>]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Close'</span>]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change()</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> returns.dropna()</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Equal weights for portfolio</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>]) </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate cumulative returns</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_returns).cumprod()</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^GSPC'</span>]).cumprod()</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^NDX'</span>]).cumprod()</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize cumulative returns to 100 for easy comparison</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_normalized <span class="op">=</span> cumulative_portfolio_returns <span class="op">/</span> cumulative_portfolio_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns_normalized <span class="op">=</span> cumulative_sp500_returns <span class="op">/</span> cumulative_sp500_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns_normalized <span class="op">=</span> cumulative_ndx_returns <span class="op">/</span> cumulative_ndx_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the portfolio</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_portfolio_returns_normalized, label<span class="op">=</span><span class="st">'Mini-Fund Portfolio'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot benchmark indices</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_sp500_returns_normalized, label<span class="op">=</span><span class="st">'S&amp;P 500'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_ndx_returns_normalized, label<span class="op">=</span><span class="st">'Nasdaq-100'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Growth of Mini-Fund Portfolio vs S&amp;P 500 and Nasdaq-100 (2000-2024)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Growth (Normalized to 100)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for mini-fund portfolio</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>portfolio_metrics <span class="op">=</span> {</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(portfolio_returns),</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(portfolio_returns),</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(portfolio_returns),</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(portfolio_returns),</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(portfolio_returns)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for S&amp;P 500</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>sp500_metrics <span class="op">=</span> {</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^GSPC'</span>])</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for Nasdaq-100</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>ndx_metrics <span class="op">=</span> {</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^NDX'</span>])</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a DataFrame</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame([portfolio_metrics, sp500_metrics, ndx_metrics], index<span class="op">=</span>[<span class="st">'Mini-Fund'</span>, <span class="st">'S&amp;P 500'</span>, <span class="st">'Nasdaq-100'</span>])</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="dv">1000</span>)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  7 of 7 completed</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="MiniFund_VolatilityRegime_Backtest_2000_2024_files/figure-html/cell-3-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            Annualized Return  Volatility  Sharpe Ratio  Sortino Ratio  Max Drawdown
Mini-Fund            0.194025    0.269933      0.718391       0.997384     -0.411544
S&amp;P 500              0.100897    0.184097      0.506164       0.610701     -0.339250
Nasdaq-100           0.168178    0.225889      0.713269       0.905724     -0.355631</code></pre>
</div>
</div>
</section>
</section>
<section id="beginning" class="level2">
<h2 class="anchored" data-anchor-id="beginning">Beginning</h2>
<div id="635f59e3-c527-4745-a4a9-cf149a8d794a" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stocks and benchmark indices</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'NVDA'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>]</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># stocks = ['ASML', 'TSLA', 'BRK-B', 'MSFT']</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">#stocks = ['ASML', 'TSLA', 'BRK-B', 'MSFT', 'ABBV']</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Close'</span>]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change()</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> returns.dropna()</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Equal weights for portfolio</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>])</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># weights = np.array([0.1639441, 0.2852132, 0.3240187, 0.2268240])</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># weights = np.array([0.14, 0.25, 0.29, 0.20, 0.12]) </span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate cumulative returns</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_returns).cumprod()</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^GSPC'</span>]).cumprod()</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^NDX'</span>]).cumprod()</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for mini-fund portfolio</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>portfolio_metrics <span class="op">=</span> {</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(portfolio_returns),</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(portfolio_returns),</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(portfolio_returns),</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(portfolio_returns),</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(portfolio_returns)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for S&amp;P 500</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>sp500_metrics <span class="op">=</span> {</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^GSPC'</span>])</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for Nasdaq-100</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>ndx_metrics <span class="op">=</span> {</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^NDX'</span>])</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize cumulative returns to 100 for easy comparison</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_normalized <span class="op">=</span> cumulative_portfolio_returns <span class="op">/</span> cumulative_portfolio_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns_normalized <span class="op">=</span> cumulative_sp500_returns <span class="op">/</span> cumulative_sp500_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns_normalized <span class="op">=</span> cumulative_ndx_returns <span class="op">/</span> cumulative_ndx_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the portfolio</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_portfolio_returns_normalized, label<span class="op">=</span><span class="st">'Portfolio-GV'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot benchmark indices</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_sp500_returns_normalized, label<span class="op">=</span><span class="st">'S&amp;P 500'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_ndx_returns_normalized, label<span class="op">=</span><span class="st">'Nasdaq-100'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Growth of Portfolio-GV vs S&amp;P 500 and Nasdaq-100 (2000-2024)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Growth (Normalized to 100)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a DataFrame</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame([portfolio_metrics, sp500_metrics, ndx_metrics], index<span class="op">=</span>[<span class="st">'Mini-Fund'</span>, <span class="st">'S&amp;P 500'</span>, <span class="st">'Nasdaq-100'</span>])</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  7 of 7 completed</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="MiniFund_VolatilityRegime_Backtest_2000_2024_files/figure-html/cell-4-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            Annualized Return  Volatility  Sharpe Ratio  Sortino Ratio  Max Drawdown
Mini-Fund            0.367925    0.272138      1.214923       1.683422     -0.421506
S&amp;P 500              0.119445    0.174019      0.621038       0.762031     -0.339250
Nasdaq-100           0.181999    0.207497      0.813858       1.043914     -0.355631</code></pre>
</div>
</div>
<div id="ef443616-763e-40cf-bcfa-05ec8421504d" class="cell" data-execution_count="52">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stocks and benchmark indices</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># stocks = ['ASML', 'NVDA', 'TSLA', 'BRK-B', 'MSFT']</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># stocks = ['ASML', 'TSLA', 'BRK-B', 'MSFT', 'ABBV']</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change()</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> returns.dropna()</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Equal weights for portfolio</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>,  <span class="fl">0.2</span>])</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># weights = np.array([0.1639441, 0.2852132, 0.3240187, 0.2268240])</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># weights = np.array([0.14, 0.25, 0.29, 0.20, 0.12]) </span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate cumulative returns</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_returns).cumprod()</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^GSPC'</span>]).cumprod()</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^NDX'</span>]).cumprod()</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for mini-fund portfolio</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>portfolio_metrics <span class="op">=</span> {</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(portfolio_returns),</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(portfolio_returns),</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(portfolio_returns),</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(portfolio_returns),</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(portfolio_returns)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for S&amp;P 500</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>sp500_metrics <span class="op">=</span> {</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^GSPC'</span>])</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for Nasdaq-100</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>ndx_metrics <span class="op">=</span> {</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^NDX'</span>])</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize cumulative returns to 100 for easy comparison</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_normalized <span class="op">=</span> cumulative_portfolio_returns <span class="op">/</span> cumulative_portfolio_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns_normalized <span class="op">=</span> cumulative_sp500_returns <span class="op">/</span> cumulative_sp500_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns_normalized <span class="op">=</span> cumulative_ndx_returns <span class="op">/</span> cumulative_ndx_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the portfolio</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_portfolio_returns_normalized, label<span class="op">=</span><span class="st">'Mini-Fund Portfolio'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot benchmark indices</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_sp500_returns_normalized, label<span class="op">=</span><span class="st">'S&amp;P 500'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_ndx_returns_normalized, label<span class="op">=</span><span class="st">'Nasdaq-100'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Growth of Portfolio-GV-O1 vs S&amp;P 500 and Nasdaq-100 (2000-2024)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Growth (Normalized to 100)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a DataFrame</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame([portfolio_metrics, sp500_metrics, ndx_metrics], index<span class="op">=</span>[<span class="st">'Mini-Fund'</span>, <span class="st">'S&amp;P 500'</span>, <span class="st">'Nasdaq-100'</span>])</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  7 of 7 completed</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="MiniFund_VolatilityRegime_Backtest_2000_2024_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            Annualized Return  Volatility  Sharpe Ratio  Sortino Ratio  Max Drawdown
Mini-Fund            0.325947    0.240479      1.211467       1.630888     -0.371925
S&amp;P 500              0.113679    0.172243      0.595699       0.721428     -0.339250
Nasdaq-100           0.179487    0.210365      0.795558       1.003233     -0.355631</code></pre>
</div>
</div>
<div id="6b0b8db4-0b7f-4f07-9220-23a099d1dde7" class="cell" data-execution_count="53">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stocks and benchmark indices</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">#stocks = ['ASML', 'NVDA', 'TSLA', 'BRK-B', 'MSFT']</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#stocks = ['ASML', 'TSLA', 'BRK-B', 'MSFT']</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>, <span class="st">'ABBV'</span>, <span class="st">'LMT'</span>]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change()</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> returns.dropna()</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Equal weights for portfolio</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># weights = np.array([0.2, 0.2, 0.2, 0.2, 0.2])</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># weights = np.array([0.1639441, 0.2852132, 0.3240187, 0.2268240])</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>, <span class="fl">0.18</span>, <span class="fl">0.10</span>, <span class="fl">0.12</span>])</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate cumulative returns</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_returns).cumprod()</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^GSPC'</span>]).cumprod()</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^NDX'</span>]).cumprod()</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for mini-fund portfolio</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>portfolio_metrics <span class="op">=</span> {</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(portfolio_returns),</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(portfolio_returns),</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(portfolio_returns),</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(portfolio_returns),</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(portfolio_returns)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for S&amp;P 500</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>sp500_metrics <span class="op">=</span> {</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^GSPC'</span>])</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for Nasdaq-100</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>ndx_metrics <span class="op">=</span> {</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^NDX'</span>]),</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^NDX'</span>])</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize cumulative returns to 100 for easy comparison</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_normalized <span class="op">=</span> cumulative_portfolio_returns <span class="op">/</span> cumulative_portfolio_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns_normalized <span class="op">=</span> cumulative_sp500_returns <span class="op">/</span> cumulative_sp500_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns_normalized <span class="op">=</span> cumulative_ndx_returns <span class="op">/</span> cumulative_ndx_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the portfolio</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_portfolio_returns_normalized, label<span class="op">=</span><span class="st">'Mini-Fund Portfolio'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot benchmark indices</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_sp500_returns_normalized, label<span class="op">=</span><span class="st">'S&amp;P 500'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_ndx_returns_normalized, label<span class="op">=</span><span class="st">'Nasdaq-100'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Growth of Portfolio-GV-O2 vs S&amp;P 500 and Nasdaq-100 (2000-2024)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Growth (Normalized to 100)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a DataFrame</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame([portfolio_metrics, sp500_metrics, ndx_metrics], index<span class="op">=</span>[<span class="st">'Mini-Fund'</span>, <span class="st">'S&amp;P 500'</span>, <span class="st">'Nasdaq-100'</span>])</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  8 of 8 completed</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="MiniFund_VolatilityRegime_Backtest_2000_2024_files/figure-html/cell-6-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            Annualized Return  Volatility  Sharpe Ratio  Sortino Ratio  Max Drawdown
Mini-Fund            0.308158    0.218942      1.246309       1.642653     -0.350050
S&amp;P 500              0.113679    0.172243      0.595699       0.721428     -0.339250
Nasdaq-100           0.179487    0.210365      0.795558       1.003233     -0.355631</code></pre>
</div>
</div>
<div id="5f03f8a2-be9e-4297-a95d-07db60ac5996" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stocks and benchmark indices</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>, <span class="st">'ABBV'</span>, <span class="st">'LMT'</span>]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Equal weights for portfolio</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>, <span class="fl">0.18</span>, <span class="fl">0.10</span>, <span class="fl">0.12</span>])</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the density plots for Portfolio, S&amp;P 500, and Nasdaq-100 returns</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Full Density Plot</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(portfolio_returns, label<span class="op">=</span><span class="st">'Portfolio-GV-O2'</span>, color<span class="op">=</span><span class="st">'blue'</span>, shade<span class="op">=</span><span class="va">True</span>, clip<span class="op">=</span>(<span class="op">-</span><span class="fl">0.06</span>, <span class="fl">0.06</span>))</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(returns[<span class="st">'^GSPC'</span>], label<span class="op">=</span><span class="st">'S&amp;P 500'</span>, color<span class="op">=</span><span class="st">'orange'</span>, shade<span class="op">=</span><span class="va">True</span>, clip<span class="op">=</span>(<span class="op">-</span><span class="fl">0.06</span>, <span class="fl">0.06</span>))</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(returns[<span class="st">'^NDX'</span>], label<span class="op">=</span><span class="st">'Nasdaq-100'</span>, color<span class="op">=</span><span class="st">'green'</span>, shade<span class="op">=</span><span class="va">True</span>, clip<span class="op">=</span>(<span class="op">-</span><span class="fl">0.06</span>, <span class="fl">0.06</span>))</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Zoomed-In Density Plot: Left and Right Tails'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Daily Return'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Density'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust layout and show plot</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  8 of 8 completed
&lt;ipython-input-23-b30301a8e790&gt;:28: FutureWarning: 

`shade` is now deprecated in favor of `fill`; setting `fill=True`.
This will become an error in seaborn v0.14.0; please update your code.

  sns.kdeplot(portfolio_returns, label='Mini-Fund Portfolio', color='blue', shade=True, clip=(-0.06, 0.06))
&lt;ipython-input-23-b30301a8e790&gt;:29: FutureWarning: 

`shade` is now deprecated in favor of `fill`; setting `fill=True`.
This will become an error in seaborn v0.14.0; please update your code.

  sns.kdeplot(returns['^GSPC'], label='S&amp;P 500', color='orange', shade=True, clip=(-0.06, 0.06))
&lt;ipython-input-23-b30301a8e790&gt;:30: FutureWarning: 

`shade` is now deprecated in favor of `fill`; setting `fill=True`.
This will become an error in seaborn v0.14.0; please update your code.

  sns.kdeplot(returns['^NDX'], label='Nasdaq-100', color='green', shade=True, clip=(-0.06, 0.06))</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="MiniFund_VolatilityRegime_Backtest_2000_2024_files/figure-html/cell-7-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="perf-across-vol-regimes" class="level2">
<h2 class="anchored" data-anchor-id="perf-across-vol-regimes">Perf across vol regimes</h2>
<div id="871881de-83c1-4cb3-9376-db93eea66149" class="cell" data-scrolled="true" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hmmlearn.hmm <span class="im">import</span> GaussianHMM</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stocks and benchmark indices</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>, <span class="st">'ABBV'</span>, <span class="st">'LMT'</span>]</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Equal weights for portfolio</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>, <span class="fl">0.18</span>, <span class="fl">0.10</span>, <span class="fl">0.12</span>])</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a 3-state HMM to detect volatility regimes</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> GaussianHMM(n_components<span class="op">=</span><span class="dv">3</span>, covariance_type<span class="op">=</span><span class="st">"full"</span>, n_iter<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>model.fit(portfolio_returns.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict regimes</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>hidden_states <span class="op">=</span> model.predict(portfolio_returns.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Add hidden state labels to returns DataFrame</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>returns_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Portfolio Returns'</span>: portfolio_returns,</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'^GSPC Returns'</span>: returns[<span class="st">'^GSPC'</span>],</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'^NDX Returns'</span>: returns[<span class="st">'^NDX'</span>],</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Hidden State'</span>: hidden_states</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average volatility of each regime to determine regime labels</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>average_volatility <span class="op">=</span> returns_df.groupby(<span class="st">'Hidden State'</span>)[<span class="st">'Portfolio Returns'</span>].std()</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the volatilities to label regimes</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>volatility_rank <span class="op">=</span> average_volatility.sort_values().index</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>regime_labels <span class="op">=</span> {volatility_rank[<span class="dv">0</span>]: <span class="st">'Low Volatility'</span>,</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>                 volatility_rank[<span class="dv">1</span>]: <span class="st">'Mid Volatility'</span>,</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>                 volatility_rank[<span class="dv">2</span>]: <span class="st">'High Volatility'</span>}</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Add regime labels to DataFrame</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>returns_df[<span class="st">'Volatility Regime'</span>] <span class="op">=</span> returns_df[<span class="st">'Hidden State'</span>].<span class="bu">map</span>(regime_labels)</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Define metric functions</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annualized_return(returns, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    compounded_growth <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns).prod()</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    n_periods <span class="op">=</span> returns.count()</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> compounded_growth <span class="op">**</span> (periods_per_year <span class="op">/</span> n_periods) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annualized_volatility(returns, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> returns.std() <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sharpe_ratio(returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    excess_returns <span class="op">=</span> returns <span class="op">-</span> risk_free_rate <span class="op">/</span> periods_per_year</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean(excess_returns) <span class="op">/</span> np.std(excess_returns) <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sortino_ratio(returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    downside_returns <span class="op">=</span> returns[returns <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    excess_returns <span class="op">=</span> returns <span class="op">-</span> risk_free_rate <span class="op">/</span> periods_per_year</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean(excess_returns) <span class="op">/</span> downside_returns.std() <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> max_drawdown(returns):</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>    cumulative_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns).cumprod()</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>    peak <span class="op">=</span> cumulative_returns.expanding(min_periods<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>()</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    drawdown <span class="op">=</span> (cumulative_returns <span class="op">-</span> peak) <span class="op">/</span> peak</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> drawdown.<span class="bu">min</span>()</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for each volatility regime for portfolio, S&amp;P 500, and Nasdaq-100</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> {}</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Low Volatility'</span>, <span class="st">'Mid Volatility'</span>, <span class="st">'High Volatility'</span>]:</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    state_data <span class="op">=</span> returns_df[returns_df[<span class="st">'Volatility Regime'</span>] <span class="op">==</span> regime]</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    state_metrics <span class="op">=</span> {}</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Portfolio Returns'</span>, <span class="st">'^GSPC Returns'</span>, <span class="st">'^NDX Returns'</span>]:</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>        state_metrics[col] <span class="op">=</span> {</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Annualized Return'</span>: annualized_return(state_data[col]),</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Volatility'</span>: annualized_volatility(state_data[col]),</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(state_data[col]),</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Sortino Ratio'</span>: sortino_ratio(state_data[col]),</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Max Drawdown'</span>: max_drawdown(state_data[col])</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>    metrics[regime] <span class="op">=</span> state_metrics</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert metrics to a DataFrame for better visualization</span></span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>metrics_dict <span class="op">=</span> {}</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> regime, data <span class="kw">in</span> metrics.items():</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> asset, values <span class="kw">in</span> data.items():</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>        row_key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>asset<span class="sc">.</span>replace(<span class="st">'Portfolio Returns'</span>, <span class="st">'Mini-Fund'</span>)<span class="sc">.</span>replace(<span class="st">'^GSPC Returns'</span>, <span class="st">'S&amp;P 500'</span>)<span class="sc">.</span>replace(<span class="st">'^NDX Returns'</span>, <span class="st">'Nasdaq-100'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>        metrics_dict[row_key] <span class="op">=</span> values</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame(metrics_dict).T</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> metrics_df.rename_axis(<span class="st">'Regime and Asset'</span>).reset_index()</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Group the table display by Low/Mid/High Volatility Regimes to enhance readability</span></span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>grouped_metrics <span class="op">=</span> metrics_df.copy()</span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Formatting the DataFrame to show Regime and Metrics without repetition of the regime</span></span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>grouped_metrics[<span class="st">'Volatility Regime'</span>] <span class="op">=</span> grouped_metrics[<span class="st">'Regime and Asset'</span>].<span class="bu">str</span>.extract(<span class="vs">r'</span><span class="dv">^</span><span class="kw">(</span><span class="vs">Low</span><span class="cf">|</span><span class="vs">Mid</span><span class="cf">|</span><span class="vs">High</span><span class="kw">)</span><span class="vs"> Volatility'</span>)</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>grouped_metrics[<span class="st">'Asset'</span>] <span class="op">=</span> grouped_metrics[<span class="st">'Regime and Asset'</span>].<span class="bu">str</span>.replace(<span class="vs">r'</span><span class="dv">^</span><span class="kw">(</span><span class="vs">Low</span><span class="cf">|</span><span class="vs">Mid</span><span class="cf">|</span><span class="vs">High</span><span class="kw">)</span><span class="vs"> Volatility - '</span>, <span class="st">''</span>)</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>grouped_metrics.drop(columns<span class="op">=</span>[<span class="st">'Regime and Asset'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Reorder columns for better readability</span></span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>grouped_metrics <span class="op">=</span> grouped_metrics[[<span class="st">'Volatility Regime'</span>, <span class="st">'Asset'</span>, <span class="st">'Annualized Return'</span>, <span class="st">'Volatility'</span>, <span class="st">'Sharpe Ratio'</span>, <span class="st">'Sortino Ratio'</span>, <span class="st">'Max Drawdown'</span>]]</span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Sorting the DataFrame by 'Volatility Regime' to ensure grouping</span></span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a>grouped_metrics <span class="op">=</span> grouped_metrics.sort_values(by<span class="op">=</span>[<span class="st">'Volatility Regime'</span>, <span class="st">'Asset'</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Display in a more readable format</span></span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)</span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="st">'</span><span class="sc">{:.4f}</span><span class="st">'</span>.<span class="bu">format</span>)</span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="dv">1000</span>)</span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Performance Metrics Grouped by Volatility Regime:"</span>)</span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(grouped_metrics)</span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting cumulative returns for each regime</span></span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Low Volatility'</span>, <span class="st">'Mid Volatility'</span>, <span class="st">'High Volatility'</span>]:</span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>    state_data <span class="op">=</span> returns_df[returns_df[<span class="st">'Volatility Regime'</span>] <span class="op">==</span> regime]</span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>    cumulative_portfolio_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> state_data[<span class="st">'Portfolio Returns'</span>]).cumprod()</span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>    cumulative_sp500_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> state_data[<span class="st">'^GSPC Returns'</span>]).cumprod()</span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>    cumulative_ndx_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> state_data[<span class="st">'^NDX Returns'</span>]).cumprod()</span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>    plt.plot(cumulative_portfolio_returns, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss"> - Mini-Fund Cumulative Returns'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, color<span class="op">=</span><span class="ss">f'C</span><span class="sc">{</span><span class="bu">list</span>(regime_labels.values())<span class="sc">.</span>index(regime)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>    plt.plot(cumulative_sp500_returns, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss"> - S&amp;P 500 Cumulative Returns'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="ss">f'C</span><span class="sc">{</span><span class="bu">list</span>(regime_labels.values())<span class="sc">.</span>index(regime)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a>    plt.plot(cumulative_ndx_returns, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss"> - Nasdaq-100 Cumulative Returns'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, color<span class="op">=</span><span class="ss">f'C</span><span class="sc">{</span><span class="bu">list</span>(regime_labels.values())<span class="sc">.</span>index(regime)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title</span></span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Cumulative Returns of Portfolio-GV-O2, S&amp;P 500, and Nasdaq-100 Across Volatility Regimes'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Cumulative Growth'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  8 of 8 completed
Model is not converging.  Current: 8306.194727967259 is not greater than 8306.204205929746. Delta is -0.009477962486926117</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Performance Metrics Grouped by Volatility Regime:
  Volatility Regime                         Asset  Annualized Return  Volatility  Sharpe Ratio  Sortino Ratio  Max Drawdown
0              High   High Volatility - Mini-Fund            -0.8314      0.8617       -1.6850        -2.4929       -0.3083
1              High  High Volatility - Nasdaq-100            -0.7188      0.8288       -1.1669        -2.0536       -0.2297
2              High     High Volatility - S&amp;P 500            -0.8402      0.8390       -1.8236        -3.2338       -0.3064
3               Low    Low Volatility - Mini-Fund             0.3906      0.1553        2.0735         3.2254       -0.1154
4               Low   Low Volatility - Nasdaq-100             0.3058      0.1421        1.8093         2.5148       -0.1106
5               Low      Low Volatility - S&amp;P 500             0.2072      0.1101        1.5845         2.1873       -0.1028
6               Mid    Mid Volatility - Mini-Fund             0.1974      0.2961        0.6896         1.0894       -0.3166
7               Mid   Mid Volatility - Nasdaq-100            -0.0683      0.2950       -0.1602        -0.2455       -0.4023
8               Mid      Mid Volatility - S&amp;P 500            -0.0423      0.2274       -0.1644        -0.2437       -0.3408</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="MiniFund_VolatilityRegime_Backtest_2000_2024_files/figure-html/cell-8-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8c90d9ff-1771-4685-ae55-8dfbee497f61" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hmmlearn.hmm <span class="im">import</span> GaussianHMM</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stocks and benchmark indices</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>, <span class="st">'ABBV'</span>, <span class="st">'LMT'</span>]</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Equal weights for portfolio</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>, <span class="fl">0.18</span>, <span class="fl">0.10</span>, <span class="fl">0.12</span>])</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a 3-state HMM to detect volatility regimes</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> GaussianHMM(n_components<span class="op">=</span><span class="dv">3</span>, covariance_type<span class="op">=</span><span class="st">"full"</span>, n_iter<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>model.fit(portfolio_returns.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict regimes</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>hidden_states <span class="op">=</span> model.predict(portfolio_returns.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Add hidden state labels to returns DataFrame</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>returns_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Date'</span>: returns.index,</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Portfolio Returns'</span>: portfolio_returns,</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'S&amp;P 500 Returns'</span>: returns[<span class="st">'^GSPC'</span>],</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Nasdaq-100 Returns'</span>: returns[<span class="st">'^NDX'</span>],</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Hidden State'</span>: hidden_states</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average volatility of each regime to determine regime labels</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>average_volatility <span class="op">=</span> returns_df.groupby(<span class="st">'Hidden State'</span>)[<span class="st">'Portfolio Returns'</span>].std()</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the volatilities to label regimes</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>volatility_rank <span class="op">=</span> average_volatility.sort_values().index</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>regime_labels <span class="op">=</span> {volatility_rank[<span class="dv">0</span>]: <span class="st">'Low Volatility'</span>,</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>                 volatility_rank[<span class="dv">1</span>]: <span class="st">'Mid Volatility'</span>,</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>                 volatility_rank[<span class="dv">2</span>]: <span class="st">'High Volatility'</span>}</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Add regime labels to DataFrame</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>returns_df[<span class="st">'Volatility Regime'</span>] <span class="op">=</span> returns_df[<span class="st">'Hidden State'</span>].<span class="bu">map</span>(regime_labels)</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate cumulative returns for each asset and add to DataFrame</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>returns_df[<span class="st">'Cumulative Portfolio Returns'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns_df[<span class="st">'Portfolio Returns'</span>]).cumprod()</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>returns_df[<span class="st">'Cumulative S&amp;P 500 Returns'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns_df[<span class="st">'S&amp;P 500 Returns'</span>]).cumprod()</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>returns_df[<span class="st">'Cumulative Nasdaq-100 Returns'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns_df[<span class="st">'Nasdaq-100 Returns'</span>]).cumprod()</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Melt the DataFrame for seaborn compatibility</span></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>cumulative_returns_df <span class="op">=</span> pd.melt(</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    returns_df,</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    id_vars<span class="op">=</span>[<span class="st">'Date'</span>, <span class="st">'Volatility Regime'</span>],</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    value_vars<span class="op">=</span>[<span class="st">'Cumulative Portfolio Returns'</span>, <span class="st">'Cumulative S&amp;P 500 Returns'</span>, <span class="st">'Cumulative Nasdaq-100 Returns'</span>],</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    var_name<span class="op">=</span><span class="st">'Asset'</span>,</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    value_name<span class="op">=</span><span class="st">'Cumulative Returns'</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a faceted plot using seaborn's FacetGrid</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.FacetGrid(cumulative_returns_df, col<span class="op">=</span><span class="st">'Volatility Regime'</span>, hue<span class="op">=</span><span class="st">'Asset'</span>, col_wrap<span class="op">=</span><span class="dv">3</span>, height<span class="op">=</span><span class="dv">4</span>, aspect<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>g.<span class="bu">map</span>(plt.plot, <span class="st">'Date'</span>, <span class="st">'Cumulative Returns'</span>).add_legend()</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust plot aesthetics</span></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>g.set_axis_labels(<span class="st">'Date'</span>, <span class="st">'Cumulative Growth'</span>)</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>g.set_titles(col_template<span class="op">=</span><span class="st">'</span><span class="sc">{col_name}</span><span class="st"> Regime'</span>)</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>g.fig.suptitle(<span class="st">'Cumulative Returns Across Volatility Regimes for Portfolio, S&amp;P 500, and Nasdaq-100'</span>, y<span class="op">=</span><span class="fl">1.05</span>)</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  8 of 8 completed
Model is not converging.  Current: 8305.528897318622 is not greater than 8305.57159532981. Delta is -0.042698011187894735</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="MiniFund_VolatilityRegime_Backtest_2000_2024_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8564d596-5caa-4fe7-a3a5-d2e6504c9b69" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> t</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> arch <span class="im">import</span> arch_model  <span class="co"># To use GARCH for volatility forecasting</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Define risk-free rate (approximation)</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>risk_free_rate <span class="op">=</span> <span class="fl">0.02</span>  <span class="co"># 2% annually</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stocks and benchmark indices</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>, <span class="st">'ABBV'</span>, <span class="st">'LMT'</span>]  <span class="co"># Example portfolio stocks</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Equal weights for portfolio</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>, <span class="fl">0.18</span>, <span class="fl">0.10</span>, <span class="fl">0.12</span>])</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate benchmark returns</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> returns[<span class="st">'^GSPC'</span>]  <span class="co"># S&amp;P 500 as benchmark</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Alpha, Beta, R-Square</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="op">=</span> np.cov(portfolio_returns, market_returns)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>beta_portfolio <span class="op">=</span> cov_matrix[<span class="dv">0</span>, <span class="dv">1</span>] <span class="op">/</span> cov_matrix[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>alpha_portfolio <span class="op">=</span> np.mean(portfolio_returns) <span class="op">-</span> beta_portfolio <span class="op">*</span> np.mean(market_returns)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>r_square <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> (np.var(portfolio_returns <span class="op">-</span> beta_portfolio <span class="op">*</span> market_returns) <span class="op">/</span> np.var(portfolio_returns))</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Value at Risk (VaR) and Expected Shortfall (ES)</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> var_es(returns, confidence_level<span class="op">=</span><span class="fl">0.95</span>):</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate VaR and Expected Shortfall using the normal distribution.</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a><span class="co">        returns (pd.Series): A pandas Series of historical returns.</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a><span class="co">        confidence_level (float): Confidence level for VaR and ES calculation.</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a><span class="co">        Tuple: VaR and ES for 1-month, 6-month, and 1-year periods.</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the mean return and standard deviation (daily)</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    mean_return_daily <span class="op">=</span> returns.mean()</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    std_dev_daily <span class="op">=</span> returns.std()</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># z-score for the given confidence level (left tail)</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> norm.ppf(confidence_level)</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time horizons in days</span></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    periods <span class="op">=</span> {<span class="st">'1m'</span>: <span class="dv">21</span>, <span class="st">'6m'</span>: <span class="dv">126</span>, <span class="st">'1y'</span>: <span class="dv">252</span>}</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    var_list <span class="op">=</span> []</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    es_list <span class="op">=</span> []</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> days <span class="kw">in</span> periods.values():</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>        mean_return_period <span class="op">=</span> mean_return_daily <span class="op">*</span> days</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>        std_dev_period <span class="op">=</span> std_dev_daily <span class="op">*</span> np.sqrt(days)</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VaR Calculation</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>        var <span class="op">=</span> <span class="op">-</span> (mean_return_period <span class="op">+</span> z <span class="op">*</span> std_dev_period)</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ES Calculation</span></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>        es_factor <span class="op">=</span> norm.pdf(z) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> confidence_level)</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>        es <span class="op">=</span> <span class="op">-</span> (mean_return_period <span class="op">+</span> es_factor <span class="op">*</span> std_dev_period)</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>        var_list.append(var)</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>        es_list.append(es)</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>    var_1m, var_6m, var_1y <span class="op">=</span> var_list</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>    es_1m, es_6m, es_1y <span class="op">=</span> es_list</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> var_1m, var_6m, var_1y, es_1m, es_6m, es_1y</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> var_es_tf(returns, confidence_level<span class="op">=</span><span class="fl">0.95</span>, forecast_volatility<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate VaR and Expected Shortfall using Student's t-distribution, with optional GARCH volatility forecasting.</span></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a><span class="co">        returns (pd.Series): A pandas Series of historical returns.</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a><span class="co">        confidence_level (float): Confidence level for VaR and ES calculation.</span></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a><span class="co">        forecast_volatility (bool): If True, use GARCH(1,1) to forecast volatility.</span></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a><span class="co">        Tuple: VaR and ES for 1-month, 6-month, and 1-year periods.</span></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the mean return (daily)</span></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>    mean_return_daily <span class="op">=</span> returns.mean()</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Volatility calculation</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> forecast_volatility:</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit GARCH(1,1) model to the return series</span></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>        am <span class="op">=</span> arch_model(returns <span class="op">*</span> <span class="dv">100</span>, vol<span class="op">=</span><span class="st">'Garch'</span>, p<span class="op">=</span><span class="dv">1</span>, q<span class="op">=</span><span class="dv">1</span>, dist<span class="op">=</span><span class="st">'t'</span>)</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> am.fit(disp<span class="op">=</span><span class="st">'off'</span>)</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use last forecasted volatility (scaled back to decimal)</span></span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>        std_dev_daily <span class="op">=</span> res.forecast(horizon<span class="op">=</span><span class="dv">1</span>).variance.values[<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>] <span class="op">**</span> <span class="fl">0.5</span> <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use historical standard deviation</span></span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>        std_dev_daily <span class="op">=</span> returns.std()</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degrees of freedom for Student's t-distribution</span></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Adjust as needed based on data</span></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>    t_dist <span class="op">=</span> t(df)</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># t-score for the given confidence level (left tail)</span></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>    t_score <span class="op">=</span> t_dist.ppf(confidence_level)</span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time horizons in days</span></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>    periods <span class="op">=</span> {<span class="st">'1m'</span>: <span class="dv">21</span>, <span class="st">'6m'</span>: <span class="dv">126</span>, <span class="st">'1y'</span>: <span class="dv">252</span>}</span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>    var_list <span class="op">=</span> []</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>    es_list <span class="op">=</span> []</span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> days <span class="kw">in</span> periods.values():</span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>        mean_return_period <span class="op">=</span> mean_return_daily <span class="op">*</span> days</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>        std_dev_period <span class="op">=</span> std_dev_daily <span class="op">*</span> np.sqrt(days)</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VaR Calculation</span></span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>        var <span class="op">=</span> <span class="op">-</span> (mean_return_period <span class="op">+</span> t_score <span class="op">*</span> std_dev_period)</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ES Calculation</span></span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>        es_factor <span class="op">=</span> (t_dist.pdf(t_score) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> confidence_level)) <span class="op">*</span> ((df <span class="op">+</span> t_score<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> (df <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>        es <span class="op">=</span> <span class="op">-</span> (mean_return_period <span class="op">+</span> es_factor <span class="op">*</span> std_dev_period)</span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>        var_list.append(var)</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>        es_list.append(es)</span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>    var_1m, var_6m, var_1y <span class="op">=</span> var_list</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>    es_1m, es_6m, es_1y <span class="op">=</span> es_list</span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> var_1m, var_6m, var_1y, es_1m, es_6m, es_1y</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a><span class="co"># Get VaR and Expected Shortfall for the portfolio</span></span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a><span class="co">#var_1m, var_6m, var_1y, es_1m, es_6m, es_1y = var_es(portfolio_returns)</span></span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>var_1m, var_6m, var_1y, es_1m, es_6m, es_1y <span class="op">=</span> var_es_tf(portfolio_returns, forecast_volatility<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate standard performance metrics (already in your code)</span></span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>portfolio_metrics <span class="op">=</span> {</span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Alpha'</span>: alpha_portfolio,</span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Beta'</span>: beta_portfolio,</span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>    <span class="st">'R-Square'</span>: r_square,</span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(portfolio_returns),</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(portfolio_returns),</span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(portfolio_returns),</span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(portfolio_returns),</span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(portfolio_returns),</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1M (95%)'</span>: var_1m,</span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 6M (95%)'</span>: var_6m,</span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1Y (95%)'</span>: var_1y,</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1M (95%)'</span>: es_1m,</span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 6M (95%)'</span>: es_6m,</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1Y (95%)'</span>: es_1y</span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate VaR and ES for S&amp;P 500 benchmark</span></span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a><span class="co">#var_1m_sp500, var_6m_sp500, var_1y_sp500, es_1m_sp500, es_6m_sp500, es_1y_sp500 = var_es(returns['^GSPC'])</span></span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>var_1m_sp500, var_6m_sp500, var_1y_sp500, es_1m_sp500, es_6m_sp500, es_1y_sp500 <span class="op">=</span> var_es_tf(returns[<span class="st">'^GSPC'</span>], forecast_volatility<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the same for S&amp;P 500 benchmark</span></span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a>sp500_metrics <span class="op">=</span> {</span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Beta'</span>: <span class="dv">1</span>,</span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a>    <span class="st">'R-Square'</span>: <span class="dv">1</span>,</span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1M (95%)'</span>: var_1m_sp500,</span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 6M (95%)'</span>: var_6m_sp500,</span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1Y (95%)'</span>: var_1y_sp500,</span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1M (95%)'</span>: es_1m_sp500,</span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 6M (95%)'</span>: es_6m_sp500,</span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1Y (95%)'</span>: es_1y_sp500</span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a DataFrame</span></span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame([portfolio_metrics, sp500_metrics], index<span class="op">=</span>[<span class="st">'Portfolio-GV-O2'</span>, <span class="st">'S&amp;P 500'</span>])</span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust display settings to show all columns without wrapping</span></span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)          <span class="co"># Show all columns</span></span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.expand_frame_repr'</span>, <span class="va">False</span>)   <span class="co"># Prevent DataFrame from wrapping</span></span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="dv">1000</span>)                <span class="co"># Set width to large enough value</span></span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.colheader_justify'</span>, <span class="st">'center'</span>) <span class="co"># Center align the headers</span></span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="st">'</span><span class="sc">{:.6f}</span><span class="st">'</span>.<span class="bu">format</span>)  <span class="co"># Format float to 6 decimal places</span></span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  8 of 8 completed</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                  Alpha    Beta    R-Square  Annualized Return  Volatility  Sharpe Ratio  Sortino Ratio  Max Drawdown  VaR 1M (95%)  VaR 6M (95%)  VaR 1Y (95%)  ES 1M (95%)  ES 6M (95%)  ES 1Y (95%)
Portfolio-GV-O2 0.000635 1.083823  0.727009      0.308158        0.218942     1.246309      1.642654      -0.350050     -0.105416     -0.344853     -0.573462    -0.140598    -0.431032    -0.695336  
S&amp;P 500              NaN 1.000000  1.000000      0.113679        0.172243     0.595699      0.721428      -0.339250     -0.068273     -0.203504     -0.323703    -0.093486    -0.265263    -0.411043  </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
/Users/dbose/anaconda3/envs/py-data/lib/python3.8/site-packages/arch/__future__/_utility.py:11: FutureWarning: 
The default for reindex is True. After September 2021 this will change to
False. Set reindex to True or False to silence this message. Alternatively,
you can use the import comment

from arch.__future__ import reindexing

to globally set reindex to True and silence this warning.

  warnings.warn(
/Users/dbose/anaconda3/envs/py-data/lib/python3.8/site-packages/arch/__future__/_utility.py:11: FutureWarning: 
The default for reindex is True. After September 2021 this will change to
False. Set reindex to True or False to silence this message. Alternatively,
you can use the import comment

from arch.__future__ import reindexing

to globally set reindex to True and silence this warning.

  warnings.warn(</code></pre>
</div>
</div>
<div id="37de5804-3897-4f16-8e4e-791619d920f7" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm, t</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> arch <span class="im">import</span> arch_model</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stocks, benchmark indices, and TAIL ETF</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>, <span class="st">'ABBV'</span>, <span class="st">'LMT'</span>]</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>protective_etf <span class="op">=</span> [<span class="st">'TAIL'</span>]</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices <span class="op">+</span> protective_etf, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Weights for portfolio without TAIL</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>weights_without_tail <span class="op">=</span> np.array([<span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>, <span class="fl">0.18</span>, <span class="fl">0.10</span>, <span class="fl">0.12</span>])</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns without TAIL</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>portfolio_returns_without_tail <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights_without_tail).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Weights for portfolio including TAIL</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>weights_with_tail <span class="op">=</span> np.array([<span class="fl">0.13</span>, <span class="fl">0.18</span>, <span class="fl">0.22</span>, <span class="fl">0.16</span>, <span class="fl">0.10</span>, <span class="fl">0.11</span>, <span class="fl">0.10</span>])  <span class="co"># Added 10% weight to TAIL</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns with TAIL</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>portfolio_returns_with_tail <span class="op">=</span> (returns[stocks <span class="op">+</span> protective_etf] <span class="op">*</span> weights_with_tail).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate cumulative returns</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_without_tail <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_returns_without_tail).cumprod()</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_with_tail <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_returns_with_tail).cumprod()</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^GSPC'</span>]).cumprod()</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^NDX'</span>]).cumprod()</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Define metrics functions</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annualized_return(returns, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    compounded_growth <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns).prod()</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    n_periods <span class="op">=</span> returns.count()</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> compounded_growth <span class="op">**</span> (periods_per_year <span class="op">/</span> n_periods) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annualized_volatility(returns, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> returns.std() <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sharpe_ratio(returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    excess_returns <span class="op">=</span> returns <span class="op">-</span> risk_free_rate <span class="op">/</span> periods_per_year</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> excess_returns.mean() <span class="op">/</span> returns.std() <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sortino_ratio(returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    downside_returns <span class="op">=</span> returns[returns <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    excess_returns <span class="op">=</span> returns <span class="op">-</span> risk_free_rate <span class="op">/</span> periods_per_year</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> excess_returns.mean() <span class="op">/</span> downside_returns.std() <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> max_drawdown(returns):</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    cumulative_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns).cumprod()</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>    peak <span class="op">=</span> cumulative_returns.expanding(min_periods<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>()</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>    drawdown <span class="op">=</span> (cumulative_returns <span class="op">-</span> peak) <span class="op">/</span> peak</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> drawdown.<span class="bu">min</span>()</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> alpha_beta(returns, benchmark_returns):</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> np.cov(returns, benchmark_returns)</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> cov_matrix[<span class="dv">0</span>, <span class="dv">1</span>] <span class="op">/</span> cov_matrix[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> returns.mean() <span class="op">-</span> beta <span class="op">*</span> benchmark_returns.mean()</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alpha, beta</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> var_es(returns, confidence_level<span class="op">=</span><span class="fl">0.95</span>, forecast_volatility<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the mean return (daily)</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>    mean_return_daily <span class="op">=</span> returns.mean()</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Volatility calculation</span></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> forecast_volatility:</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit GARCH(1,1) model to the return series</span></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>        am <span class="op">=</span> arch_model(returns <span class="op">*</span> <span class="dv">100</span>, vol<span class="op">=</span><span class="st">'Garch'</span>, p<span class="op">=</span><span class="dv">1</span>, q<span class="op">=</span><span class="dv">1</span>, dist<span class="op">=</span><span class="st">'t'</span>)</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> am.fit(disp<span class="op">=</span><span class="st">'off'</span>)</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use last forecasted volatility (scaled back to decimal)</span></span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>        std_dev_daily <span class="op">=</span> res.forecast(horizon<span class="op">=</span><span class="dv">1</span>).variance.values[<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>] <span class="op">**</span> <span class="fl">0.5</span> <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use historical standard deviation</span></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>        std_dev_daily <span class="op">=</span> returns.std()</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degrees of freedom for Student's t-distribution</span></span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Adjust as needed based on data</span></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>    t_dist <span class="op">=</span> t(df)</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># t-score for the given confidence level (left tail)</span></span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>    t_score <span class="op">=</span> t_dist.ppf(confidence_level)</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time horizons in days</span></span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>    periods <span class="op">=</span> {<span class="st">'1m'</span>: <span class="dv">21</span>, <span class="st">'6m'</span>: <span class="dv">126</span>, <span class="st">'1y'</span>: <span class="dv">252</span>}</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>    var_list <span class="op">=</span> []</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>    es_list <span class="op">=</span> []</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> days <span class="kw">in</span> periods.values():</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>        mean_return_period <span class="op">=</span> mean_return_daily <span class="op">*</span> days</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>        std_dev_period <span class="op">=</span> std_dev_daily <span class="op">*</span> np.sqrt(days)</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VaR Calculation</span></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>        var <span class="op">=</span> <span class="op">-</span> (mean_return_period <span class="op">+</span> t_score <span class="op">*</span> std_dev_period)</span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ES Calculation</span></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>        es_factor <span class="op">=</span> (t_dist.pdf(t_score) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> confidence_level)) <span class="op">*</span> ((df <span class="op">+</span> t_score<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> (df <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>        es <span class="op">=</span> <span class="op">-</span> (mean_return_period <span class="op">+</span> es_factor <span class="op">*</span> std_dev_period)</span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>        var_list.append(var)</span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>        es_list.append(es)</span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>    var_1m, var_6m, var_1y <span class="op">=</span> var_list</span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>    es_1m, es_6m, es_1y <span class="op">=</span> es_list</span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> var_1m, var_6m, var_1y, es_1m, es_6m, es_1y</span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Alpha, Beta, VaR, and ES for portfolios and benchmarks</span></span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> returns[<span class="st">'^GSPC'</span>]</span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a>alpha_portfolio_without_tail, beta_portfolio_without_tail <span class="op">=</span> alpha_beta(portfolio_returns_without_tail, market_returns)</span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a>alpha_portfolio_with_tail, beta_portfolio_with_tail <span class="op">=</span> alpha_beta(portfolio_returns_with_tail, market_returns)</span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>var_1m_without_tail, var_6m_without_tail, var_1y_without_tail, es_1m_without_tail, es_6m_without_tail, es_1y_without_tail <span class="op">=</span> var_es(portfolio_returns_without_tail, forecast_volatility<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a>var_1m_with_tail, var_6m_with_tail, var_1y_with_tail, es_1m_with_tail, es_6m_with_tail, es_1y_with_tail <span class="op">=</span> var_es(portfolio_returns_with_tail, forecast_volatility<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for mini-fund portfolio without TAIL</span></span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a>portfolio_metrics_without_tail <span class="op">=</span> {</span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Alpha'</span>: alpha_portfolio_without_tail,</span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Beta'</span>: beta_portfolio_without_tail,</span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(portfolio_returns_without_tail),</span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(portfolio_returns_without_tail),</span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(portfolio_returns_without_tail),</span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(portfolio_returns_without_tail),</span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(portfolio_returns_without_tail),</span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1M (95%)'</span>: var_1m_without_tail,</span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 6M (95%)'</span>: var_6m_without_tail,</span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1Y (95%)'</span>: var_1y_without_tail,</span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1M (95%)'</span>: es_1m_without_tail,</span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 6M (95%)'</span>: es_6m_without_tail,</span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1Y (95%)'</span>: es_1y_without_tail</span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for mini-fund portfolio with TAIL</span></span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a>portfolio_metrics_with_tail <span class="op">=</span> {</span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Alpha'</span>: alpha_portfolio_with_tail,</span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Beta'</span>: beta_portfolio_with_tail,</span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(portfolio_returns_with_tail),</span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(portfolio_returns_with_tail),</span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(portfolio_returns_with_tail),</span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(portfolio_returns_with_tail),</span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(portfolio_returns_with_tail),</span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1M (95%)'</span>: var_1m_with_tail,</span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 6M (95%)'</span>: var_6m_with_tail,</span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1Y (95%)'</span>: var_1y_with_tail,</span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1M (95%)'</span>: es_1m_with_tail,</span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 6M (95%)'</span>: es_6m_with_tail,</span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1Y (95%)'</span>: es_1y_with_tail</span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for S&amp;P 500</span></span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a>sp500_metrics <span class="op">=</span> {</span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Beta'</span>: <span class="dv">1</span>,</span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a>    <span class="st">'R-Square'</span>: <span class="dv">1</span>,</span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb25-165"><a href="#cb25-165" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb25-166"><a href="#cb25-166" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1M (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">0</span>],</span>
<span id="cb25-167"><a href="#cb25-167" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 6M (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">1</span>],</span>
<span id="cb25-168"><a href="#cb25-168" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1Y (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">2</span>],</span>
<span id="cb25-169"><a href="#cb25-169" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1M (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">3</span>],</span>
<span id="cb25-170"><a href="#cb25-170" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 6M (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">4</span>],</span>
<span id="cb25-171"><a href="#cb25-171" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1Y (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">5</span>]</span>
<span id="cb25-172"><a href="#cb25-172" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-173"><a href="#cb25-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-174"><a href="#cb25-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-175"><a href="#cb25-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize cumulative returns to 100 for easy comparison</span></span>
<span id="cb25-176"><a href="#cb25-176" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_without_tail_normalized <span class="op">=</span> cumulative_portfolio_returns_without_tail <span class="op">/</span> cumulative_portfolio_returns_without_tail.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb25-177"><a href="#cb25-177" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_with_tail_normalized <span class="op">=</span> cumulative_portfolio_returns_with_tail <span class="op">/</span> cumulative_portfolio_returns_with_tail.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb25-178"><a href="#cb25-178" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns_normalized <span class="op">=</span> cumulative_sp500_returns <span class="op">/</span> cumulative_sp500_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb25-179"><a href="#cb25-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-180"><a href="#cb25-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data</span></span>
<span id="cb25-181"><a href="#cb25-181" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb25-182"><a href="#cb25-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-183"><a href="#cb25-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the portfolio without TAIL</span></span>
<span id="cb25-184"><a href="#cb25-184" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_portfolio_returns_without_tail_normalized, label<span class="op">=</span><span class="st">'Portfolio-GV-O2 Portfolio without TAIL'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb25-185"><a href="#cb25-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-186"><a href="#cb25-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the portfolio with TAIL</span></span>
<span id="cb25-187"><a href="#cb25-187" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_portfolio_returns_with_tail_normalized, label<span class="op">=</span><span class="st">'Portfolio-GV-O2 Portfolio with TAIL'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb25-188"><a href="#cb25-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-189"><a href="#cb25-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot benchmark indices</span></span>
<span id="cb25-190"><a href="#cb25-190" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_sp500_returns_normalized, label<span class="op">=</span><span class="st">'S&amp;P 500'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb25-191"><a href="#cb25-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-192"><a href="#cb25-192" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title</span></span>
<span id="cb25-193"><a href="#cb25-193" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Growth of Portfolio-GV-O2 with and without TAIL vs S&amp;P 500 and Nasdaq-100 (2000-2024)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb25-194"><a href="#cb25-194" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb25-195"><a href="#cb25-195" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Growth (Normalized to 100)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb25-196"><a href="#cb25-196" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb25-197"><a href="#cb25-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-198"><a href="#cb25-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb25-199"><a href="#cb25-199" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb25-200"><a href="#cb25-200" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb25-201"><a href="#cb25-201" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb25-202"><a href="#cb25-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-203"><a href="#cb25-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a DataFrame</span></span>
<span id="cb25-204"><a href="#cb25-204" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame([portfolio_metrics_without_tail, portfolio_metrics_with_tail, sp500_metrics, ndx_metrics], </span>
<span id="cb25-205"><a href="#cb25-205" aria-hidden="true" tabindex="-1"></a>                          index<span class="op">=</span>[<span class="st">'Portfolio-GV-O2 without TAIL'</span>, <span class="st">'Portfolio-GV-O2 with TAIL'</span>, <span class="st">'S&amp;P 500'</span>, <span class="st">'Nasdaq-100'</span>])</span>
<span id="cb25-206"><a href="#cb25-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-207"><a href="#cb25-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust display settings to show all columns without wrapping</span></span>
<span id="cb25-208"><a href="#cb25-208" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)          <span class="co"># Show all columns</span></span>
<span id="cb25-209"><a href="#cb25-209" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.expand_frame_repr'</span>, <span class="va">False</span>)   <span class="co"># Prevent DataFrame from wrapping</span></span>
<span id="cb25-210"><a href="#cb25-210" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="dv">1000</span>)                <span class="co"># Set width to large enough value</span></span>
<span id="cb25-211"><a href="#cb25-211" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.colheader_justify'</span>, <span class="st">'center'</span>) <span class="co"># Center align the headers</span></span>
<span id="cb25-212"><a href="#cb25-212" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="st">'</span><span class="sc">{:.6f}</span><span class="st">'</span>.<span class="bu">format</span>)  <span class="co"># Format float to 6 decimal places</span></span>
<span id="cb25-213"><a href="#cb25-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-214"><a href="#cb25-214" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  9 of 9 completed
/Users/dbose/anaconda3/envs/py-data/lib/python3.8/site-packages/arch/__future__/_utility.py:11: FutureWarning: 
The default for reindex is True. After September 2021 this will change to
False. Set reindex to True or False to silence this message. Alternatively,
you can use the import comment

from arch.__future__ import reindexing

to globally set reindex to True and silence this warning.

  warnings.warn(
/Users/dbose/anaconda3/envs/py-data/lib/python3.8/site-packages/arch/__future__/_utility.py:11: FutureWarning: 
The default for reindex is True. After September 2021 this will change to
False. Set reindex to True or False to silence this message. Alternatively,
you can use the import comment

from arch.__future__ import reindexing

to globally set reindex to True and silence this warning.

  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="MiniFund_VolatilityRegime_Backtest_2000_2024_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                               Alpha    Beta    Annualized Return  Volatility  Sharpe Ratio  Sortino Ratio  Max Drawdown  VaR 1M (95%)  VaR 6M (95%)  VaR 1Y (95%)  ES 1M (95%)  ES 6M (95%)  ES 1Y (95%)  R-Square
Portfolio-GV-O2 without TAIL 0.000622 1.086780      0.299328        0.243712     1.115379      1.433413      -0.350050     -0.106745     -0.347816     -0.577361    -0.142540    -0.435495    -0.701359         NaN
Portfolio-GV-O2 with TAIL    0.000560 0.912985      0.262029        0.208124     1.127078      1.462300      -0.300293     -0.093390     -0.304079     -0.504595    -0.124734    -0.380856    -0.613174         NaN
S&amp;P 500                           NaN 1.000000      0.110526        0.196321     0.530843      0.634252      -0.339250     -0.124550     -0.341836     -0.519811    -0.174143    -0.463314    -0.691607    1.000000
Nasdaq-100                        NaN 1.000000      0.183523        0.241768     0.735701      0.939876      -0.355631     -0.157124     -0.443419     -0.685044    -0.218199    -0.593020    -0.896611    1.000000</code></pre>
</div>
</div>
</section>
<section id="performance-during-recessions" class="level2">
<h2 class="anchored" data-anchor-id="performance-during-recessions">Performance during recessions</h2>
<div id="efafc6b5-a528-4ca3-8691-422123dfe29f" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>recession_data <span class="op">=</span> pd.read_csv(<span class="st">'recession_indicator.csv'</span>, parse_dates<span class="op">=</span>[<span class="st">'DATE'</span>])</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>recession_data[<span class="st">"DATE"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>0      1854-12-01
1      1855-01-01
2      1855-02-01
3      1855-03-01
4      1855-04-01
          ...    
2033   2024-05-01
2034   2024-06-01
2035   2024-07-01
2036   2024-08-01
2037   2024-09-01
Name: DATE, Length: 2038, dtype: datetime64[ns]</code></pre>
</div>
</div>
<div id="4b7e46b7-abe5-4221-94fb-1d49242200eb" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the stocks and benchmark indices</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>, <span class="st">'ABBV'</span>, <span class="st">'LMT'</span>]</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Close'</span>]</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change()</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>returns.index <span class="op">=</span> returns.index.tz_localize(<span class="va">None</span>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Equal weights for portfolio</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>, <span class="fl">0.18</span>, <span class="fl">0.10</span>, <span class="fl">0.12</span>])</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove time zone information to ensure compatibility</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>portfolio_returns.index <span class="op">=</span> portfolio_returns.index.tz_localize(<span class="va">None</span>)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Load recession periods from uploaded CSV file</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>recession_data <span class="op">=</span> pd.read_csv(<span class="st">'recession_indicator.csv'</span>, parse_dates<span class="op">=</span>[<span class="st">'DATE'</span>])</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>recession_data.set_index(<span class="st">'DATE'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>recession_data.index <span class="op">=</span> recession_data.index.tz_localize(<span class="va">None</span>)</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>recession_daily <span class="op">=</span> recession_data.reindex(pd.date_range(start<span class="op">=</span>returns.index.<span class="bu">min</span>(), </span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>                                                       end<span class="op">=</span>returns.index.<span class="bu">max</span>(), </span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>                                                       freq<span class="op">=</span><span class="st">'D'</span>)).ffill()</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="co"># # Align the indices of returns and recession data</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="co"># recession_daily = recession_daily.reindex(returns.index, method='ffill')</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter returns for recession periods (only select days when recession is indicated)</span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>recession_days_index <span class="op">=</span> recession_daily[recession_daily[<span class="st">'VALUE'</span>] <span class="op">==</span> <span class="dv">1</span>].index</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter returns for recession periods (only select days when recession is indicated)</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>portfolio_recession_returns <span class="op">=</span> portfolio_returns.loc[portfolio_returns.index.intersection(recession_days_index)]</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Define metrics functions</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annualized_return(returns):</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>    compounded_growth <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns).prod()</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    n_years <span class="op">=</span> <span class="bu">len</span>(returns) <span class="op">/</span> <span class="dv">252</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> compounded_growth <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> n_years) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annualized_volatility(returns):</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sharpe_ratio(returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>):</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>    excess_returns <span class="op">=</span> returns <span class="op">-</span> risk_free_rate <span class="op">/</span> <span class="dv">252</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> excess_returns.mean() <span class="op">/</span> returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sortino_ratio(returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>):</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>    downside_returns <span class="op">=</span> returns[returns <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>    downside_deviation <span class="op">=</span> downside_returns.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (returns.mean() <span class="op">-</span> risk_free_rate <span class="op">/</span> <span class="dv">252</span>) <span class="op">/</span> downside_deviation</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> max_drawdown(returns):</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>    cumulative <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns).cumprod()</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>    peak <span class="op">=</span> cumulative.cummax()</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>    drawdown <span class="op">=</span> (cumulative <span class="op">-</span> peak) <span class="op">/</span> peak</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> drawdown.<span class="bu">min</span>()</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for mini-fund portfolio during recession periods</span></span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>portfolio_metrics_recession <span class="op">=</span> {</span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(portfolio_recession_returns),</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(portfolio_recession_returns),</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(portfolio_recession_returns),</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(portfolio_recession_returns),</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(portfolio_recession_returns)</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for S&amp;P 500 during recession periods</span></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>sp500_recession_returns <span class="op">=</span> returns[<span class="st">'^GSPC'</span>].loc[returns.index.intersection(recession_days_index)]</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>sp500_metrics_recession <span class="op">=</span> {</span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(sp500_recession_returns),</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(sp500_recession_returns),</span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(sp500_recession_returns),</span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(sp500_recession_returns),</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(sp500_recession_returns)</span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for Nasdaq-100 during recession periods</span></span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>ndx_recession_returns <span class="op">=</span> returns[<span class="st">'^NDX'</span>].loc[returns.index.intersection(recession_days_index)]</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>ndx_metrics_recession <span class="op">=</span> {</span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(ndx_recession_returns),</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(ndx_recession_returns),</span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(ndx_recession_returns),</span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(ndx_recession_returns),</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(ndx_recession_returns)</span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a DataFrame</span></span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>metrics_df_recession <span class="op">=</span> pd.DataFrame([portfolio_metrics_recession, sp500_metrics_recession, ndx_metrics_recession], index<span class="op">=</span>[<span class="st">'Mini-Fund'</span>, <span class="st">'S&amp;P 500'</span>, <span class="st">'Nasdaq-100'</span>])</span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Portfolio Performance During Recession Periods:"</span>)</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics_df_recession)</span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the cumulative returns during recession periods</span></span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_recession <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_recession_returns).cumprod()</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns_recession <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> sp500_recession_returns).cumprod()</span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns_recession <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> ndx_recession_returns).cumprod()</span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize cumulative returns to 100 for easy comparison</span></span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_normalized <span class="op">=</span> cumulative_portfolio_returns_recession <span class="op">/</span> cumulative_portfolio_returns_recession.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns_normalized <span class="op">=</span> cumulative_sp500_returns_recession <span class="op">/</span> cumulative_sp500_returns_recession.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns_normalized <span class="op">=</span> cumulative_ndx_returns_recession <span class="op">/</span> cumulative_ndx_returns_recession.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data</span></span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the portfolio</span></span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_portfolio_returns_normalized, label<span class="op">=</span><span class="st">'Mini-Fund Portfolio (Recession)'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot benchmark indices</span></span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_sp500_returns_normalized, label<span class="op">=</span><span class="st">'S&amp;P 500 (Recession)'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_ndx_returns_normalized, label<span class="op">=</span><span class="st">'Nasdaq-100 (Recession)'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title</span></span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Growth of Portfolio-GV-O2 vs S&amp;P 500 and Nasdaq-100 During Recession Periods'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Growth (Normalized to 100)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  8 of 8 completed</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Portfolio Performance During Recession Periods:
            Annualized Return  Volatility  Sharpe Ratio  Sortino Ratio  Max Drawdown
Mini-Fund           -0.031372    0.300771     -0.021338      -0.000109     -0.397179
S&amp;P 500             -0.193706    0.385337     -0.417644      -0.002256     -0.600109
Nasdaq-100          -0.109028    0.460166     -0.065060      -0.000393     -0.613428</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="MiniFund_VolatilityRegime_Backtest_2000_2024_files/figure-html/cell-14-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="72f8aed9-921c-4135-a180-b7c33267eb7a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>recession_data</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="32d40048-678a-4320-94b0-0893f06dcdd9" class="cell" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data for the stocks</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'NVDA'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>]</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks, start<span class="op">=</span><span class="st">'2010-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the function to calculate portfolio performance</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> portfolio_performance(weights, mean_returns, cov_matrix, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>):</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    returns <span class="op">=</span> np.<span class="bu">sum</span>(mean_returns <span class="op">*</span> weights) <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    std <span class="op">=</span> np.sqrt(np.dot(weights.T, np.dot(cov_matrix, weights))) <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    sharpe_ratio <span class="op">=</span> (returns <span class="op">-</span> risk_free_rate) <span class="op">/</span> std</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> returns, std, sharpe_ratio</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the objective function for optimization (negative Sharpe ratio)</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> negative_sharpe_ratio(weights, mean_returns, cov_matrix, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>):</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    returns, std, sharpe_ratio <span class="op">=</span> portfolio_performance(weights, mean_returns, cov_matrix, risk_free_rate)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>sharpe_ratio</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Constraints: sum of weights must be 1</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_sum(weights):</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">sum</span>(weights) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Boundaries: weights between 0 and 1</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>bounds <span class="op">=</span> <span class="bu">tuple</span>((<span class="dv">0</span>, <span class="dv">1</span>) <span class="cf">for</span> stock <span class="kw">in</span> stocks)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial guess (equal weight distribution)</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>initial_weights <span class="op">=</span> np.array([<span class="dv">1</span><span class="op">/</span><span class="bu">len</span>(stocks)] <span class="op">*</span> <span class="bu">len</span>(stocks))</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean returns and covariance matrix</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>mean_returns <span class="op">=</span> returns.mean()</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="op">=</span> returns.cov()</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimization using minimize from scipy.optimize</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>optimal_solution <span class="op">=</span> minimize(negative_sharpe_ratio, initial_weights, args<span class="op">=</span>(mean_returns, cov_matrix),</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>                            method<span class="op">=</span><span class="st">'SLSQP'</span>, bounds<span class="op">=</span>bounds, constraints<span class="op">=</span>{<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: check_sum})</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>optimal_weights <span class="op">=</span> optimal_solution.x</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Display optimal weights</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>optimal_weights_df <span class="op">=</span> pd.DataFrame(optimal_weights, index<span class="op">=</span>stocks, columns<span class="op">=</span>[<span class="st">'Optimal Weight'</span>])</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>optimal_weights_percent <span class="op">=</span> optimal_weights_df <span class="op">*</span> <span class="dv">10000000000</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the weights in percentage form</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(optimal_weights_percent)</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a><span class="co">#print(optimal_weights_df)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  5 of 5 completed</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       Optimal Weight
ASML     1.639441e+01
NVDA     2.097931e-15
TSLA     2.852132e+01
BRK-B    3.240187e+01
MSFT     2.268240e+01</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<div id="2b3d672f-9b24-4756-b9fb-492a6cfbb95b" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> t</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> arch <span class="im">import</span> arch_model</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> arch.__future__ <span class="im">import</span> reindexing</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>, <span class="st">'ABBV'</span>, <span class="st">'LMT'</span>]</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>protective_etf <span class="op">=</span> [<span class="st">'TAIL'</span>]</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine stocks and protective ETF</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>all_assets <span class="op">=</span> stocks <span class="op">+</span> protective_etf</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(all_assets, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the function to calculate portfolio performance</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> portfolio_performance(weights, returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>, confidence_level<span class="op">=</span><span class="fl">0.95</span>, forecast_volatility<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    mean_returns <span class="op">=</span> returns.mean()</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> returns.cov()</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    portfolio_returns <span class="op">=</span> np.dot(mean_returns, weights) <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    portfolio_std <span class="op">=</span> np.sqrt(np.dot(weights.T, np.dot(cov_matrix, weights))) <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    sharpe_ratio <span class="op">=</span> (portfolio_returns <span class="op">-</span> risk_free_rate) <span class="op">/</span> portfolio_std</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Volatility calculation (GARCH(1,1) model)</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> forecast_volatility:</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>        am <span class="op">=</span> arch_model(np.dot(returns, weights) <span class="op">*</span> <span class="dv">100</span>, vol<span class="op">=</span><span class="st">'Garch'</span>, p<span class="op">=</span><span class="dv">1</span>, q<span class="op">=</span><span class="dv">1</span>, dist<span class="op">=</span><span class="st">'t'</span>)</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> am.fit(disp<span class="op">=</span><span class="st">'off'</span>)</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>        std_dev_daily <span class="op">=</span> res.forecast(horizon<span class="op">=</span><span class="dv">1</span>).variance.values[<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>] <span class="op">**</span> <span class="fl">0.5</span> <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        std_dev_daily <span class="op">=</span> np.std(np.dot(returns, weights))</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degrees of freedom for Student's t-distribution</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Adjust as needed based on data</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    t_dist <span class="op">=</span> t(df)</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># t-score for the given confidence level (left tail)</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>    t_score <span class="op">=</span> t_dist.ppf(confidence_level)</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time horizons in days</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    periods <span class="op">=</span> {<span class="st">'1m'</span>: <span class="dv">21</span>, <span class="st">'6m'</span>: <span class="dv">126</span>}</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    var_list <span class="op">=</span> []</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    es_list <span class="op">=</span> []</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> days <span class="kw">in</span> periods.values():</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>        mean_return_period <span class="op">=</span> portfolio_returns <span class="op">/</span> <span class="dv">252</span> <span class="op">*</span> days</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>        std_dev_period <span class="op">=</span> std_dev_daily <span class="op">*</span> np.sqrt(days)</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VaR Calculation</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>        var <span class="op">=</span> <span class="op">-</span> (mean_return_period <span class="op">+</span> t_score <span class="op">*</span> std_dev_period)</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ES Calculation</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>        es_factor <span class="op">=</span> (t_dist.pdf(t_score) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> confidence_level)) <span class="op">*</span> ((df <span class="op">+</span> t_score<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> (df <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>        es <span class="op">=</span> <span class="op">-</span> (mean_return_period <span class="op">+</span> es_factor <span class="op">*</span> std_dev_period)</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>        var_list.append(var)</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>        es_list.append(es)</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>    var_1m, var_6m <span class="op">=</span> var_list</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>    es_1m, es_6m <span class="op">=</span> es_list</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> portfolio_returns, portfolio_std, sharpe_ratio, var_1m, var_6m, es_1m, es_6m</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the objective function for optimization</span></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> objective(weights, returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>, confidence_level<span class="op">=</span><span class="fl">0.95</span>):</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>    portfolio_returns, portfolio_std, sharpe_ratio, var_1m, var_6m, es_1m, es_6m <span class="op">=</span> portfolio_performance(weights, returns, risk_free_rate, confidence_level)</span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Weights for multi-objective optimization</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>    w_sharpe, w_var, w_es <span class="op">=</span> <span class="fl">1.0</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>  <span class="co"># Adjust these weights as per preference</span></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Objective value to minimize: negative Sharpe ratio + VaR + ES</span></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>    objective_value <span class="op">=</span> (</span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>        w_sharpe <span class="op">*</span> <span class="op">-</span>sharpe_ratio <span class="op">+</span>  <span class="co"># Maximizing Sharpe Ratio by minimizing its negative</span></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>        w_var <span class="op">*</span> (var_1m <span class="op">+</span> var_6m) <span class="op">+</span>  <span class="co"># Minimize VaR (1 month and 6 months)</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>        w_es <span class="op">*</span> (es_1m <span class="op">+</span> es_6m)       <span class="co"># Minimize ES (1 month and 6 months)</span></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> objective_value</span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Constraints: sum of weights must be 1</span></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_sum(weights):</span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">sum</span>(weights) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Boundaries: weights between 0 and 1</span></span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>bounds <span class="op">=</span> <span class="bu">tuple</span>((<span class="dv">0</span>, <span class="dv">1</span>) <span class="cf">for</span> _ <span class="kw">in</span> all_assets)</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial guess (equal weight distribution)</span></span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a><span class="co"># initial_weights = np.array([1 / len(all_assets)] * len(all_assets))</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>initial_weights <span class="op">=</span> np.array([<span class="fl">0.13</span>, <span class="fl">0.18</span>, <span class="fl">0.22</span>, <span class="fl">0.16</span>, <span class="fl">0.10</span>, <span class="fl">0.11</span>, <span class="fl">0.10</span>])  <span class="co"># Added 10% weight to TAIL</span></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimization using minimize from scipy.optimize</span></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>optimal_solution <span class="op">=</span> minimize(objective, initial_weights, args<span class="op">=</span>(returns),</span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>                            method<span class="op">=</span><span class="st">'SLSQP'</span>, bounds<span class="op">=</span>bounds, constraints<span class="op">=</span>{<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: check_sum})</span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>optimal_weights <span class="op">=</span> optimal_solution.x</span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Display optimal weights</span></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>optimal_weights_df <span class="op">=</span> pd.DataFrame(optimal_weights, index<span class="op">=</span>all_assets, columns<span class="op">=</span>[<span class="st">'Optimal Weight'</span>])</span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a><span class="co">#optimal_weights_percent = optimal_weights_df * 100</span></span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the weights in percentage form</span></span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(optimal_weights_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  7 of 7 completed</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>       Optimal Weight
ASML      0.107482   
TSLA      0.182479   
BRK-B     0.183304   
MSFT      0.194264   
ABBV      0.083253   
LMT       0.091662   
TAIL      0.157556   
**************************************************************************************
**************************************************************************************</code></pre>
</div>
</div>
<div id="f33ee822-d10b-4b74-b006-2408c6f0b850" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>, <span class="st">'ABBV'</span>, <span class="st">'LMT'</span>]</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>protective_etf <span class="op">=</span> [<span class="st">'TAIL'</span>]</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices <span class="op">+</span> protective_etf, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns with TAIL</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>portfolio_returns_with_tail <span class="op">=</span> (returns[stocks <span class="op">+</span> protective_etf] <span class="op">*</span> optimal_weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate cumulative returns</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_without_tail <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_returns_without_tail).cumprod()</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_with_tail <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_returns_with_tail).cumprod()</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^GSPC'</span>]).cumprod()</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>cumulative_ndx_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns[<span class="st">'^NDX'</span>]).cumprod()</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Define metrics functions</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annualized_return(returns, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    compounded_growth <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns).prod()</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    n_periods <span class="op">=</span> returns.count()</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> compounded_growth <span class="op">**</span> (periods_per_year <span class="op">/</span> n_periods) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> annualized_volatility(returns, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> returns.std() <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sharpe_ratio(returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    excess_returns <span class="op">=</span> returns <span class="op">-</span> risk_free_rate <span class="op">/</span> periods_per_year</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> excess_returns.mean() <span class="op">/</span> returns.std() <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sortino_ratio(returns, risk_free_rate<span class="op">=</span><span class="fl">0.02</span>, periods_per_year<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    downside_returns <span class="op">=</span> returns[returns <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    excess_returns <span class="op">=</span> returns <span class="op">-</span> risk_free_rate <span class="op">/</span> periods_per_year</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> excess_returns.mean() <span class="op">/</span> downside_returns.std() <span class="op">*</span> np.sqrt(periods_per_year)</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> max_drawdown(returns):</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    cumulative_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> returns).cumprod()</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>    peak <span class="op">=</span> cumulative_returns.expanding(min_periods<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>()</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>    drawdown <span class="op">=</span> (cumulative_returns <span class="op">-</span> peak) <span class="op">/</span> peak</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> drawdown.<span class="bu">min</span>()</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> alpha_beta(returns, benchmark_returns):</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> np.cov(returns, benchmark_returns)</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> cov_matrix[<span class="dv">0</span>, <span class="dv">1</span>] <span class="op">/</span> cov_matrix[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> returns.mean() <span class="op">-</span> beta <span class="op">*</span> benchmark_returns.mean()</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alpha, beta</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> var_es(returns, confidence_level<span class="op">=</span><span class="fl">0.95</span>, forecast_volatility<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the mean return (daily)</span></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>    mean_return_daily <span class="op">=</span> returns.mean()</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Volatility calculation</span></span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> forecast_volatility:</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit GARCH(1,1) model to the return series</span></span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>        am <span class="op">=</span> arch_model(returns <span class="op">*</span> <span class="dv">100</span>, vol<span class="op">=</span><span class="st">'Garch'</span>, p<span class="op">=</span><span class="dv">1</span>, q<span class="op">=</span><span class="dv">1</span>, dist<span class="op">=</span><span class="st">'t'</span>)</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> am.fit(disp<span class="op">=</span><span class="st">'off'</span>)</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use last forecasted volatility (scaled back to decimal)</span></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>        std_dev_daily <span class="op">=</span> res.forecast(horizon<span class="op">=</span><span class="dv">1</span>).variance.values[<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>] <span class="op">**</span> <span class="fl">0.5</span> <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use historical standard deviation</span></span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>        std_dev_daily <span class="op">=</span> returns.std()</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degrees of freedom for Student's t-distribution</span></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Adjust as needed based on data</span></span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>    t_dist <span class="op">=</span> t(df)</span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># t-score for the given confidence level (left tail)</span></span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>    t_score <span class="op">=</span> t_dist.ppf(confidence_level)</span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time horizons in days</span></span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>    periods <span class="op">=</span> {<span class="st">'1m'</span>: <span class="dv">21</span>, <span class="st">'6m'</span>: <span class="dv">126</span>, <span class="st">'1y'</span>: <span class="dv">252</span>}</span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>    var_list <span class="op">=</span> []</span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a>    es_list <span class="op">=</span> []</span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> days <span class="kw">in</span> periods.values():</span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a>        mean_return_period <span class="op">=</span> mean_return_daily <span class="op">*</span> days</span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>        std_dev_period <span class="op">=</span> std_dev_daily <span class="op">*</span> np.sqrt(days)</span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VaR Calculation</span></span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a>        var <span class="op">=</span> <span class="op">-</span> (mean_return_period <span class="op">+</span> t_score <span class="op">*</span> std_dev_period)</span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ES Calculation</span></span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a>        es_factor <span class="op">=</span> (t_dist.pdf(t_score) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> confidence_level)) <span class="op">*</span> ((df <span class="op">+</span> t_score<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> (df <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a>        es <span class="op">=</span> <span class="op">-</span> (mean_return_period <span class="op">+</span> es_factor <span class="op">*</span> std_dev_period)</span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true" tabindex="-1"></a>        var_list.append(var)</span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true" tabindex="-1"></a>        es_list.append(es)</span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a>    var_1m, var_6m, var_1y <span class="op">=</span> var_list</span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a>    es_1m, es_6m, es_1y <span class="op">=</span> es_list</span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> var_1m, var_6m, var_1y, es_1m, es_6m, es_1y</span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Alpha, Beta, VaR, and ES for portfolios and benchmarks</span></span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> returns[<span class="st">'^GSPC'</span>]</span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true" tabindex="-1"></a>alpha_portfolio_without_tail, beta_portfolio_without_tail <span class="op">=</span> alpha_beta(portfolio_returns_without_tail, market_returns)</span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true" tabindex="-1"></a>alpha_portfolio_with_tail, beta_portfolio_with_tail <span class="op">=</span> alpha_beta(portfolio_returns_with_tail, market_returns)</span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a>var_1m_without_tail, var_6m_without_tail, var_1y_without_tail, es_1m_without_tail, es_6m_without_tail, es_1y_without_tail <span class="op">=</span> var_es(portfolio_returns_without_tail, forecast_volatility<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a>var_1m_with_tail, var_6m_with_tail, var_1y_with_tail, es_1m_with_tail, es_6m_with_tail, es_1y_with_tail <span class="op">=</span> var_es(portfolio_returns_with_tail, forecast_volatility<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for mini-fund portfolio without TAIL</span></span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a>portfolio_metrics_without_tail <span class="op">=</span> {</span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Alpha'</span>: alpha_portfolio_without_tail,</span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Beta'</span>: beta_portfolio_without_tail,</span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(portfolio_returns_without_tail),</span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(portfolio_returns_without_tail),</span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(portfolio_returns_without_tail),</span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(portfolio_returns_without_tail),</span>
<span id="cb41-114"><a href="#cb41-114" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(portfolio_returns_without_tail),</span>
<span id="cb41-115"><a href="#cb41-115" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1M (95%)'</span>: var_1m_without_tail,</span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 6M (95%)'</span>: var_6m_without_tail,</span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1Y (95%)'</span>: var_1y_without_tail,</span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1M (95%)'</span>: es_1m_without_tail,</span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 6M (95%)'</span>: es_6m_without_tail,</span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1Y (95%)'</span>: es_1y_without_tail</span>
<span id="cb41-121"><a href="#cb41-121" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-122"><a href="#cb41-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-123"><a href="#cb41-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for mini-fund portfolio with TAIL</span></span>
<span id="cb41-124"><a href="#cb41-124" aria-hidden="true" tabindex="-1"></a>portfolio_metrics_with_tail <span class="op">=</span> {</span>
<span id="cb41-125"><a href="#cb41-125" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Alpha'</span>: alpha_portfolio_with_tail,</span>
<span id="cb41-126"><a href="#cb41-126" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Beta'</span>: beta_portfolio_with_tail,</span>
<span id="cb41-127"><a href="#cb41-127" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(portfolio_returns_with_tail),</span>
<span id="cb41-128"><a href="#cb41-128" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(portfolio_returns_with_tail),</span>
<span id="cb41-129"><a href="#cb41-129" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(portfolio_returns_with_tail),</span>
<span id="cb41-130"><a href="#cb41-130" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(portfolio_returns_with_tail),</span>
<span id="cb41-131"><a href="#cb41-131" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(portfolio_returns_with_tail),</span>
<span id="cb41-132"><a href="#cb41-132" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1M (95%)'</span>: var_1m_with_tail,</span>
<span id="cb41-133"><a href="#cb41-133" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 6M (95%)'</span>: var_6m_with_tail,</span>
<span id="cb41-134"><a href="#cb41-134" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1Y (95%)'</span>: var_1y_with_tail,</span>
<span id="cb41-135"><a href="#cb41-135" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1M (95%)'</span>: es_1m_with_tail,</span>
<span id="cb41-136"><a href="#cb41-136" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 6M (95%)'</span>: es_6m_with_tail,</span>
<span id="cb41-137"><a href="#cb41-137" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1Y (95%)'</span>: es_1y_with_tail</span>
<span id="cb41-138"><a href="#cb41-138" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-139"><a href="#cb41-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-140"><a href="#cb41-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate metrics for S&amp;P 500</span></span>
<span id="cb41-141"><a href="#cb41-141" aria-hidden="true" tabindex="-1"></a>sp500_metrics <span class="op">=</span> {</span>
<span id="cb41-142"><a href="#cb41-142" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Beta'</span>: <span class="dv">1</span>,</span>
<span id="cb41-143"><a href="#cb41-143" aria-hidden="true" tabindex="-1"></a>    <span class="st">'R-Square'</span>: <span class="dv">1</span>,</span>
<span id="cb41-144"><a href="#cb41-144" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annualized Return'</span>: annualized_return(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb41-145"><a href="#cb41-145" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Volatility'</span>: annualized_volatility(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb41-146"><a href="#cb41-146" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sharpe Ratio'</span>: sharpe_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb41-147"><a href="#cb41-147" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Sortino Ratio'</span>: sortino_ratio(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb41-148"><a href="#cb41-148" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>: max_drawdown(returns[<span class="st">'^GSPC'</span>]),</span>
<span id="cb41-149"><a href="#cb41-149" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1M (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">0</span>],</span>
<span id="cb41-150"><a href="#cb41-150" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 6M (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">1</span>],</span>
<span id="cb41-151"><a href="#cb41-151" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VaR 1Y (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">2</span>],</span>
<span id="cb41-152"><a href="#cb41-152" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1M (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">3</span>],</span>
<span id="cb41-153"><a href="#cb41-153" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 6M (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">4</span>],</span>
<span id="cb41-154"><a href="#cb41-154" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ES 1Y (95%)'</span>: var_es(returns[<span class="st">'^GSPC'</span>])[<span class="dv">5</span>]</span>
<span id="cb41-155"><a href="#cb41-155" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-156"><a href="#cb41-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-157"><a href="#cb41-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-158"><a href="#cb41-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize cumulative returns to 100 for easy comparison</span></span>
<span id="cb41-159"><a href="#cb41-159" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_without_tail_normalized <span class="op">=</span> cumulative_portfolio_returns_without_tail <span class="op">/</span> cumulative_portfolio_returns_without_tail.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb41-160"><a href="#cb41-160" aria-hidden="true" tabindex="-1"></a>cumulative_portfolio_returns_with_tail_normalized <span class="op">=</span> cumulative_portfolio_returns_with_tail <span class="op">/</span> cumulative_portfolio_returns_with_tail.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb41-161"><a href="#cb41-161" aria-hidden="true" tabindex="-1"></a>cumulative_sp500_returns_normalized <span class="op">=</span> cumulative_sp500_returns <span class="op">/</span> cumulative_sp500_returns.iloc[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb41-162"><a href="#cb41-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-163"><a href="#cb41-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data</span></span>
<span id="cb41-164"><a href="#cb41-164" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb41-165"><a href="#cb41-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-166"><a href="#cb41-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the portfolio without TAIL</span></span>
<span id="cb41-167"><a href="#cb41-167" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_portfolio_returns_without_tail_normalized, label<span class="op">=</span><span class="st">'Portfolio-GV-O2'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb41-168"><a href="#cb41-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-169"><a href="#cb41-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the portfolio with TAIL</span></span>
<span id="cb41-170"><a href="#cb41-170" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_portfolio_returns_with_tail_normalized, label<span class="op">=</span><span class="st">'Portfolio-GV-TAIL-O'</span>, color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb41-171"><a href="#cb41-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-172"><a href="#cb41-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot benchmark indices</span></span>
<span id="cb41-173"><a href="#cb41-173" aria-hidden="true" tabindex="-1"></a>plt.plot(cumulative_sp500_returns_normalized, label<span class="op">=</span><span class="st">'S&amp;P 500'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb41-174"><a href="#cb41-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-175"><a href="#cb41-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title</span></span>
<span id="cb41-176"><a href="#cb41-176" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Growth of Portfolio-GV-TAIL-O vs Portfolio-GV-O2 (no TAIL) vs S&amp;P 500 and Nasdaq-100 (2000-2024)'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb41-177"><a href="#cb41-177" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Year'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb41-178"><a href="#cb41-178" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Growth (Normalized to 100)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb41-179"><a href="#cb41-179" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb41-180"><a href="#cb41-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-181"><a href="#cb41-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb41-182"><a href="#cb41-182" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb41-183"><a href="#cb41-183" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb41-184"><a href="#cb41-184" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb41-185"><a href="#cb41-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-186"><a href="#cb41-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results into a DataFrame</span></span>
<span id="cb41-187"><a href="#cb41-187" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame([portfolio_metrics_without_tail, portfolio_metrics_with_tail, sp500_metrics, ndx_metrics], </span>
<span id="cb41-188"><a href="#cb41-188" aria-hidden="true" tabindex="-1"></a>                          index<span class="op">=</span>[<span class="st">'Portfolio-GV-O2'</span>, <span class="st">'Portfolio-GV-TAIL-O'</span>, <span class="st">'S&amp;P 500'</span>, <span class="st">'Nasdaq-100'</span>])</span>
<span id="cb41-189"><a href="#cb41-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-190"><a href="#cb41-190" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust display settings to show all columns without wrapping</span></span>
<span id="cb41-191"><a href="#cb41-191" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="va">None</span>)          <span class="co"># Show all columns</span></span>
<span id="cb41-192"><a href="#cb41-192" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.expand_frame_repr'</span>, <span class="va">False</span>)   <span class="co"># Prevent DataFrame from wrapping</span></span>
<span id="cb41-193"><a href="#cb41-193" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="dv">1000</span>)                <span class="co"># Set width to large enough value</span></span>
<span id="cb41-194"><a href="#cb41-194" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.colheader_justify'</span>, <span class="st">'center'</span>) <span class="co"># Center align the headers</span></span>
<span id="cb41-195"><a href="#cb41-195" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="st">'</span><span class="sc">{:.6f}</span><span class="st">'</span>.<span class="bu">format</span>)  <span class="co"># Format float to 6 decimal places</span></span>
<span id="cb41-196"><a href="#cb41-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-197"><a href="#cb41-197" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  9 of 9 completed</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="MiniFund_VolatilityRegime_Backtest_2000_2024_files/figure-html/cell-18-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                      Alpha    Beta    Annualized Return  Volatility  Sharpe Ratio  Sortino Ratio  Max Drawdown  VaR 1M (95%)  VaR 6M (95%)  VaR 1Y (95%)  ES 1M (95%)  ES 6M (95%)  ES 1Y (95%)  R-Square
Portfolio-GV-O2     0.000622 1.086780      0.299328        0.243712     1.115379      1.433413      -0.350050     -0.106745     -0.347816     -0.577361    -0.142540    -0.435495    -0.701359         NaN
Portfolio-GV-TAIL-O 0.000554 0.837946      0.251487        0.196279     1.139983      1.500943      -0.275660     -0.088748     -0.289508     -0.480820    -0.118467    -0.362305    -0.583771         NaN
S&amp;P 500                  NaN 1.000000      0.110526        0.196321     0.530843      0.634252      -0.339250     -0.124550     -0.341836     -0.519811    -0.174143    -0.463314    -0.691607    1.000000
Nasdaq-100               NaN 1.000000      0.183523        0.241768     0.735701      0.939876      -0.355631     -0.157124     -0.443419     -0.685044    -0.218199    -0.593020    -0.896611    1.000000</code></pre>
</div>
</div>
</section>
<section id="cwarp" class="level2">
<h2 class="anchored" data-anchor-id="cwarp">CWARP</h2>
<p>https://docsend.com/view/teaqrcewe7ht423x</p>
<div id="05ddcfa2-db41-4bdb-b491-897ea0467adc" class="cell" data-execution_count="59">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to calculate Sortino Ratio</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Rp: Return of Portfolio, Rf: Risk-Free Rate, sigma_dp: Downside Deviation of Portfolio</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sortino_ratio(Rp, Rf, sigma_dp):</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (Rp <span class="op">-</span> Rf) <span class="op">/</span> sigma_dp</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to calculate Return to Max Drawdown (RMDD)</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Rp: Return of Portfolio, Lp: Trough value of Replacement Portfolio, Pp: Peak value of Replacement Portfolio</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> return_to_max_drawdown(Rp, Lp, Pp):</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (Rp <span class="op">-</span> Rf) <span class="op">/</span> ((Lp <span class="op">-</span> Pp) <span class="op">/</span> Pp)</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the CWARP Calculation Function</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Sn: Sortino Ratio of New Portfolio, Sp: Sortino Ratio of Replacement Portfolio</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="co"># RMDDn: Return to Max Drawdown of New Portfolio, RMDDp: Return to Max Drawdown of Replacement Portfolio</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cwarp_calculation(Sn, Sp, RMDDn, RMDDp):</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (np.sqrt((Sn <span class="op">/</span> Sp) <span class="op">*</span> (RMDDn <span class="op">/</span> RMDDp)) <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical data for portfolio and benchmarks</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>stocks <span class="op">=</span> [<span class="st">'ASML'</span>, <span class="st">'TSLA'</span>, <span class="st">'BRK-B'</span>, <span class="st">'MSFT'</span>, <span class="st">'ABBV'</span>, <span class="st">'LMT'</span>]</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>benchmark_indices <span class="op">=</span> [<span class="st">'^GSPC'</span>, <span class="st">'^NDX'</span>]  <span class="co"># S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> yf.download(stocks <span class="op">+</span> benchmark_indices, start<span class="op">=</span><span class="st">'2000-01-01'</span>, end<span class="op">=</span><span class="st">'2024-01-01'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Equal weights for portfolio</span></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> np.array([<span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.25</span>, <span class="fl">0.18</span>, <span class="fl">0.10</span>, <span class="fl">0.12</span>])</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate portfolio returns</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> (returns[stocks] <span class="op">*</span> weights).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Risk-free rate (assumed)</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>Rf <span class="op">=</span> <span class="fl">0.02</span> <span class="op">/</span> <span class="dv">252</span>  <span class="co"># Annual risk-free rate divided by trading days</span></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Sortino Ratios for Portfolio, S&amp;P 500, and Nasdaq-100</span></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>portfolio_downside_std <span class="op">=</span> portfolio_returns[portfolio_returns <span class="op">&lt;</span> <span class="dv">0</span>].std()</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>sp500_downside_std <span class="op">=</span> returns[<span class="st">'^GSPC'</span>][returns[<span class="st">'^GSPC'</span>] <span class="op">&lt;</span> <span class="dv">0</span>].std()</span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>ndx_downside_std <span class="op">=</span> returns[<span class="st">'^NDX'</span>][returns[<span class="st">'^NDX'</span>] <span class="op">&lt;</span> <span class="dv">0</span>].std()</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>Sp_portfolio <span class="op">=</span> sortino_ratio(portfolio_returns.mean(), Rf, portfolio_downside_std)</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>Sp_sp500 <span class="op">=</span> sortino_ratio(returns[<span class="st">'^GSPC'</span>].mean(), Rf, sp500_downside_std)</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>Sp_ndx <span class="op">=</span> sortino_ratio(returns[<span class="st">'^NDX'</span>].mean(), Rf, ndx_downside_std)</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Return to Max Drawdowns for Portfolio, S&amp;P 500, and Nasdaq-100</span></span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>portfolio_peak <span class="op">=</span> portfolio_returns.cummax()</span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>portfolio_drawdown <span class="op">=</span> (portfolio_returns <span class="op">-</span> portfolio_peak) <span class="op">/</span> portfolio_peak</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>Lp_portfolio <span class="op">=</span> portfolio_drawdown.<span class="bu">min</span>()</span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>Pp_portfolio <span class="op">=</span> portfolio_peak.<span class="bu">max</span>()</span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>RMDD_portfolio <span class="op">=</span> return_to_max_drawdown(portfolio_returns.mean(), Lp_portfolio, Pp_portfolio)</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>sp500_peak <span class="op">=</span> returns[<span class="st">'^GSPC'</span>].cummax()</span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>sp500_drawdown <span class="op">=</span> (returns[<span class="st">'^GSPC'</span>] <span class="op">-</span> sp500_peak) <span class="op">/</span> sp500_peak</span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>Lp_sp500 <span class="op">=</span> sp500_drawdown.<span class="bu">min</span>()</span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>Pp_sp500 <span class="op">=</span> sp500_peak.<span class="bu">max</span>()</span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>RMDD_sp500 <span class="op">=</span> return_to_max_drawdown(returns[<span class="st">'^GSPC'</span>].mean(), Lp_sp500, Pp_sp500)</span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>ndx_peak <span class="op">=</span> returns[<span class="st">'^NDX'</span>].cummax()</span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a>ndx_drawdown <span class="op">=</span> (returns[<span class="st">'^NDX'</span>] <span class="op">-</span> ndx_peak) <span class="op">/</span> ndx_peak</span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>Lp_ndx <span class="op">=</span> ndx_drawdown.<span class="bu">min</span>()</span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a>Pp_ndx <span class="op">=</span> ndx_peak.<span class="bu">max</span>()</span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>RMDD_ndx <span class="op">=</span> return_to_max_drawdown(returns[<span class="st">'^NDX'</span>].mean(), Lp_ndx, Pp_ndx)</span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate CWARP for Portfolio vs S&amp;P 500 and Nasdaq-100</span></span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>cwarp_portfolio_sp500 <span class="op">=</span> cwarp_calculation(Sp_portfolio, Sp_sp500, RMDD_portfolio, RMDD_sp500)</span>
<span id="cb44-69"><a href="#cb44-69" aria-hidden="true" tabindex="-1"></a>cwarp_portfolio_ndx <span class="op">=</span> cwarp_calculation(Sp_portfolio, Sp_ndx, RMDD_portfolio, RMDD_ndx)</span>
<span id="cb44-70"><a href="#cb44-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-71"><a href="#cb44-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CWARP Value (Portfolio vs S&amp;P 500): </span><span class="sc">{</span>cwarp_portfolio_sp500<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb44-72"><a href="#cb44-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CWARP Value (Portfolio vs Nasdaq-100): </span><span class="sc">{</span>cwarp_portfolio_ndx<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>[*********************100%***********************]  8 of 8 completed</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CWARP Value (Portfolio vs S&amp;P 500): 162.3071593499393
CWARP Value (Portfolio vs Nasdaq-100): 78.84851594077611</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/dbose\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>