<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3.2 Fama-French Factors and Valuation Data – Deb Bose</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b3b235ae6ba71d6e5c2a90c00144237d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Deb Bose</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../posts/"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../notebooks/index.html"> 
<span class="menu-text">Notebooks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../papers/index.html"> 
<span class="menu-text">Papers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dbose"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#shiller-cape-data" id="toc-shiller-cape-data" class="nav-link active" data-scroll-target="#shiller-cape-data">3.3 Shiller CAPE Data</a></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">4. Feature Engineering</a>
  <ul class="collapse">
  <li><a href="#construct-liquidity-variables" id="toc-construct-liquidity-variables" class="nav-link" data-scroll-target="#construct-liquidity-variables">4.1 Construct Liquidity Variables</a></li>
  <li><a href="#construct-valuation-spread-measure" id="toc-construct-valuation-spread-measure" class="nav-link" data-scroll-target="#construct-valuation-spread-measure">4.2 Construct Valuation Spread Measure</a></li>
  </ul></li>
  <li><a href="#liquidity-index-construction-via-sparse-pca" id="toc-liquidity-index-construction-via-sparse-pca" class="nav-link" data-scroll-target="#liquidity-index-construction-via-sparse-pca">5. Liquidity Index Construction via Sparse PCA</a>
  <ul class="collapse">
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">5.1 Methodology</a></li>
  <li><a href="#explained-variance-is-too-small-45" id="toc-explained-variance-is-too-small-45" class="nav-link" data-scroll-target="#explained-variance-is-too-small-45">Explained variance is too small = ~45%</a></li>
  </ul></li>
  <li><a href="#regime-detection-via-hidden-markov-models" id="toc-regime-detection-via-hidden-markov-models" class="nav-link" data-scroll-target="#regime-detection-via-hidden-markov-models">6. Regime Detection via Hidden Markov Models</a>
  <ul class="collapse">
  <li><a href="#hmm-specification" id="toc-hmm-specification" class="nav-link" data-scroll-target="#hmm-specification">6.1 HMM Specification</a></li>
  <li><a href="#validation" id="toc-validation" class="nav-link" data-scroll-target="#validation">Validation</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">3.2 Fama-French Factors and Valuation Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="3d00a58e-4a8d-475c-b918-0e3a2a6fc561" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Core libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Data fetching</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas_datareader <span class="im">as</span> pdr</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fredapi <span class="im">import</span> Fred</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Statistical modeling</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA, SparsePCA</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.covariance <span class="im">import</span> LedoitWolf</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hmmlearn <span class="im">import</span> hmm</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.api <span class="im">import</span> VAR</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.stattools <span class="im">import</span> grangercausalitytests, adfuller, kpss</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.stats.diagnostic <span class="im">import</span> acorr_ljungbox</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> jarque_bera, shapiro</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">'seaborn-v0_8-darkgrid'</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>sns.set_palette(<span class="st">"husl"</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">14</span>, <span class="dv">8</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'font.size'</span>] <span class="op">=</span> <span class="dv">11</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ All libraries imported successfully"</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Analysis date: </span><span class="sc">{</span>datetime<span class="sc">.</span>now()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ All libraries imported successfully
Analysis date: 2026-01-26</code></pre>
</div>
</div>
<div id="fcf1b617-8287-4ee2-9fae-dea4532f3053" class="cell" data-execution_count="81">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"1990-01-01"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>end_date   <span class="op">=</span> <span class="st">"2025-12-31"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- FRED series codes ---</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>FRED_SERIES <span class="op">=</span> {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"M2"</span>:   <span class="st">"M2SL"</span>,      <span class="co"># M2 money stock (monthly, SA)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FED_BS"</span>:<span class="st">"WALCL"</span>,     <span class="co"># Fed balance sheet total assets (weekly)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FFR"</span>: <span class="st">"DFF"</span>,  </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Real_Rate"</span>: <span class="st">"REAINTRATREARAT1YE"</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"T3M"</span>:   <span class="st">"DTB3"</span>,     <span class="co"># 3-Month T-Bill rate (monthly)</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"T10Y"</span>:  <span class="st">"DGS10"</span>,     <span class="co"># 10-Year Treasury yield (daily -&gt; resample monthly)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"BAA"</span>:    <span class="st">"DBAA"</span>,       <span class="co"># Moody's Baa corporate yield (monthly)</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AAA"</span>:    <span class="st">"DAAA"</span>,       <span class="co"># Moody's Aaa corporate yield (monthly)</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CPI"</span>:    <span class="st">"CPIAUCSL"</span>,  <span class="co"># CPI index (monthly, SA)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CORE_CPI"</span>: <span class="st">"CPILFESL"</span>,    <span class="co"># Core CPI</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"GDP"</span>:    <span class="st">"GDP"</span>,       <span class="co"># Nominal GDP (quarterly, SAAR)</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'IORB'</span>: <span class="st">'IORB'</span>,                    <span class="co"># Interest on Reserve Balances</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RRP'</span>: <span class="st">'RRPONTSYD'</span>,                <span class="co"># Overnight Reverse Repo</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TGA'</span>: <span class="st">'WTREGEN'</span>,                  <span class="co"># Treasury General Account</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Bank_Reserves'</span>: <span class="st">'TOTRESNS'</span>,       <span class="co"># Total Reserves</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CI_Loans'</span>: <span class="st">'TOTBKCR'</span>,             <span class="co"># Bank Credit, All Commercial Banks</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Consumer_Credit'</span>: <span class="st">'TOTALSL'</span>,      <span class="co"># Consumer Credit Outstanding</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mortgage_Rate'</span>: <span class="st">'MORTGAGE30US'</span>,   <span class="co"># 30Y Mortgage Rate</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Prime_Rate'</span>: <span class="st">'DPRIME'</span>,            <span class="co"># Bank Prime Loan Rate</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'STLFSI'</span>: <span class="st">'STLFSI'</span>,                <span class="co"># St. Louis Fed Financial Stress</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Dollar_Index'</span>: <span class="st">'DTWEXBGS'</span>,        <span class="co"># # Global Liquidity: Trade-Weighted Dollar</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Household_Debt_Service'</span>: <span class="st">'TDSP'</span>,  <span class="co"># Household Liquidity: Household Debt Service Ratio</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co"># For equity factors: Fama-French via pandas_datareader (famafrench)</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>FF_FACTORS_DATASET <span class="op">=</span> <span class="st">"F-F_Research_Data_5_Factors_2x3"</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_fred_series(series_dict, start, end):</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co">    Download FRED series into a single monthly DataFrame.</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co">    series_dict : dict</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co">        Mapping logical_name -&gt; FRED code.</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    dfs <span class="op">=</span> []</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, code <span class="kw">in</span> series_dict.items():</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Downloading </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">) from FRED..."</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> pdr.DataReader(code, <span class="st">"fred"</span>, start, end)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> s.rename(columns<span class="op">=</span>{code: name})</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        dfs.append(s)</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.concat(dfs, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure monthly freq by end-of-month sampling</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.resample(<span class="st">"M"</span>).last()</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1f53cd67-b4d1-46a0-9035-320c8d68d278" class="cell" data-execution_count="82">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>macro_data <span class="op">=</span> download_fred_series(FRED_SERIES, start_date, end_date)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Start from the original GDP values only (drop NaNs)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>gdp_series <span class="op">=</span> macro_data[<span class="st">"GDP"</span>].dropna()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Collapse to unique quarter-end values</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#    - If GDP is timestamped at quarter *start* (e.g. 2025-04-01),</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#      this will move it to the quarter end (2025-06-30) and give unique labels.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>gdp_q <span class="op">=</span> gdp_series.resample(<span class="st">"Q"</span>).last()   <span class="co"># quarterly, at quarter-end (e.g. 2025-03-31, 2025-06-30, ...)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Downsample to monthly and forward-fill within the quarter</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>gdp_m <span class="op">=</span> gdp_q.resample(<span class="st">"M"</span>).ffill()</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Assign back into macro_raw, aligning on the monthly index</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>macro_data[<span class="st">"GDP"</span>] <span class="op">=</span> gdp_m</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>macro_data.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading M2 (M2SL) from FRED...
Downloading FED_BS (WALCL) from FRED...
Downloading FFR (DFF) from FRED...
Downloading Real_Rate (REAINTRATREARAT1YE) from FRED...
Downloading T3M (DTB3) from FRED...
Downloading T10Y (DGS10) from FRED...
Downloading BAA (DBAA) from FRED...
Downloading AAA (DAAA) from FRED...
Downloading CPI (CPIAUCSL) from FRED...
Downloading CORE_CPI (CPILFESL) from FRED...
Downloading GDP (GDP) from FRED...
Downloading IORB (IORB) from FRED...
Downloading RRP (RRPONTSYD) from FRED...
Downloading TGA (WTREGEN) from FRED...
Downloading Bank_Reserves (TOTRESNS) from FRED...
Downloading CI_Loans (TOTBKCR) from FRED...
Downloading Consumer_Credit (TOTALSL) from FRED...
Downloading Mortgage_Rate (MORTGAGE30US) from FRED...
Downloading Prime_Rate (DPRIME) from FRED...
Downloading STLFSI (STLFSI) from FRED...
Downloading Dollar_Index (DTWEXBGS) from FRED...
Downloading Household_Debt_Service (TDSP) from FRED...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="82">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2</th>
<th data-quarto-table-cell-role="th">FED_BS</th>
<th data-quarto-table-cell-role="th">FFR</th>
<th data-quarto-table-cell-role="th">Real_Rate</th>
<th data-quarto-table-cell-role="th">T3M</th>
<th data-quarto-table-cell-role="th">T10Y</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">CORE_CPI</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">RRP</th>
<th data-quarto-table-cell-role="th">TGA</th>
<th data-quarto-table-cell-role="th">Bank_Reserves</th>
<th data-quarto-table-cell-role="th">CI_Loans</th>
<th data-quarto-table-cell-role="th">Consumer_Credit</th>
<th data-quarto-table-cell-role="th">Mortgage_Rate</th>
<th data-quarto-table-cell-role="th">Prime_Rate</th>
<th data-quarto-table-cell-role="th">STLFSI</th>
<th data-quarto-table-cell-role="th">Dollar_Index</th>
<th data-quarto-table-cell-role="th">Household_Debt_Service</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">DATE</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>22108.3</td>
<td>6603384.0</td>
<td>4.33</td>
<td>1.523005</td>
<td>4.05</td>
<td>4.23</td>
<td>6.03</td>
<td>5.42</td>
<td>323.364</td>
<td>329.793</td>
<td>...</td>
<td>77.898</td>
<td>589998.0</td>
<td>3281.9</td>
<td>18720.1524</td>
<td>5059896.38</td>
<td>6.56</td>
<td>7.50</td>
<td>NaN</td>
<td>120.6028</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.4</td>
<td>6608395.0</td>
<td>4.09</td>
<td>1.149868</td>
<td>3.86</td>
<td>4.16</td>
<td>5.83</td>
<td>5.22</td>
<td>324.368</td>
<td>330.542</td>
<td>...</td>
<td>49.071</td>
<td>804856.0</td>
<td>3068.1</td>
<td>18759.8099</td>
<td>5071365.99</td>
<td>6.30</td>
<td>7.25</td>
<td>NaN</td>
<td>120.5624</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>22298.0</td>
<td>6587034.0</td>
<td>3.86</td>
<td>0.973381</td>
<td>3.73</td>
<td>4.11</td>
<td>5.80</td>
<td>5.22</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>51.802</td>
<td>957990.0</td>
<td>2944.9</td>
<td>18820.7752</td>
<td>5080601.87</td>
<td>6.17</td>
<td>7.00</td>
<td>NaN</td>
<td>121.7715</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>22322.4</td>
<td>6552419.0</td>
<td>3.89</td>
<td>1.001027</td>
<td>3.73</td>
<td>4.02</td>
<td>5.80</td>
<td>5.18</td>
<td>325.031</td>
<td>331.068</td>
<td>...</td>
<td>7.561</td>
<td>903394.0</td>
<td>2879.3</td>
<td>18925.1502</td>
<td>5084831.24</td>
<td>6.23</td>
<td>7.00</td>
<td>NaN</td>
<td>121.4288</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-12-31</th>
<td>NaN</td>
<td>6640618.0</td>
<td>3.64</td>
<td>-0.135174</td>
<td>3.57</td>
<td>4.18</td>
<td>5.90</td>
<td>5.35</td>
<td>326.030</td>
<td>331.860</td>
<td>...</td>
<td>105.993</td>
<td>837306.0</td>
<td>NaN</td>
<td>18934.1126</td>
<td>NaN</td>
<td>6.15</td>
<td>6.75</td>
<td>NaN</td>
<td>120.1166</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>5 rows × 22 columns</p>
</div>
</div>
</div>
<div id="90242e1e-f95a-4636-82dc-8495aa43298d" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_ff_factors(start, end):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Download monthly Fama-French 5 factors (2x3) using pandas_datareader.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Downloading Fama-French factors (famafrench)..."</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    ff_raw <span class="op">=</span> pdr.DataReader(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span>FF_FACTORS_DATASET,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        data_source<span class="op">=</span><span class="st">"famafrench"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        start<span class="op">=</span>start,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        end<span class="op">=</span>end</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    )[<span class="dv">0</span>]  <span class="co"># table [0] contains the data</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    ff <span class="op">=</span> (ff_raw</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>          .divide(<span class="dv">100</span>)  <span class="co"># convert from % to decimal</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>          .reset_index(names<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>          .assign(date<span class="op">=</span><span class="kw">lambda</span> x: pd.to_datetime(x[<span class="st">"date"</span>].astype(<span class="bu">str</span>)))</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>          .rename(<span class="bu">str</span>.lower, axis<span class="op">=</span><span class="st">"columns"</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>          .rename(columns<span class="op">=</span>{<span class="st">"mkt-rf"</span>: <span class="st">"mkt_excess"</span>}))</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    ff <span class="op">=</span> ff.set_index(<span class="st">"date"</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ff</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>ff_factors <span class="op">=</span> download_ff_factors(start_date, end_date)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>ff_adj <span class="op">=</span> ff_factors.copy()</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>ff_adj.index <span class="op">=</span> ff_adj.index.to_period(<span class="st">"M"</span>).to_timestamp(<span class="st">"M"</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>ff_adj.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading Fama-French factors (famafrench)...</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0067</td>
<td>0.0208</td>
<td>0.0038</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>0.0196</td>
<td>-0.0131</td>
<td>-0.0309</td>
<td>-0.0522</td>
<td>-0.0403</td>
<td>0.0037</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>-0.0013</td>
<td>0.0147</td>
<td>0.0376</td>
<td>0.0143</td>
<td>0.0068</td>
<td>0.0030</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="shiller-cape-data" class="level3">
<h3 class="anchored" data-anchor-id="shiller-cape-data">3.3 Shiller CAPE Data</h3>
<p>https://shillerdata.com/</p>
<div id="702ef36f-2a5c-4bd9-ae62-df5d64fd18d7" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_yyyy_mm_to_date(s: <span class="bu">str</span>):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert 'YYYY.MM' to a proper datetime.</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Handles the special case where October appears as YYYY.1 instead of YYYY.10.</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">str</span>(s).strip()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> s.split(<span class="st">"."</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(parts) <span class="op">!=</span> <span class="dv">2</span>:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Unexpected date format: </span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    year <span class="op">=</span> <span class="bu">int</span>(parts[<span class="dv">0</span>])</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    mm <span class="op">=</span> parts[<span class="dv">1</span>]</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fix: "1" should be "10" (October)</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mm <span class="op">==</span> <span class="st">"1"</span>:</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> <span class="bu">int</span>(mm)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Timestamp(year<span class="op">=</span>year, month<span class="op">=</span>month, day<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load CAPE CSV ---</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>sp500_cape_raw <span class="op">=</span> pd.read_csv(<span class="st">"data/sp500-cape-1990-2025.csv"</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean + parse</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>sp500_cape_raw[<span class="st">"date"</span>] <span class="op">=</span> sp500_cape_raw[<span class="st">"Date"</span>].<span class="bu">apply</span>(parse_yyyy_mm_to_date)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>sp500_cape_raw <span class="op">=</span> (</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    sp500_cape_raw[[<span class="st">"date"</span>, <span class="st">"SP500"</span>, <span class="st">"CAPE"</span>]]</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    .set_index(<span class="st">"date"</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    .sort_index()</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to month-end aligned CAPE series</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>sp500_cape_m <span class="op">=</span> sp500_cape_raw.resample(<span class="st">"M"</span>).last()</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>sp500_cape_m.rename(columns<span class="op">=</span>{<span class="st">"CAPE"</span>: <span class="st">"CAPE"</span>, <span class="st">"SP500"</span>: <span class="st">"P"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>sp500_cape_m.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">P</th>
<th data-quarto-table-cell-role="th">CAPE</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>6408.95</td>
<td>37.85</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>6584.02</td>
<td>38.58</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>6735.69</td>
<td>39.21</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>6740.89</td>
<td>39.12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-12-31</th>
<td>6812.63</td>
<td>39.42</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="3821ca6f-5db9-478f-a18a-cd0714572d67" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas_datareader <span class="im">as</span> pdr</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch the VIXCLS series from FRED</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>vix_data <span class="op">=</span> pdr.get_data_fred(<span class="st">'VIXCLS'</span>, start<span class="op">=</span>start_date, end<span class="op">=</span>end_date)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the results</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(vix.tail())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>            VIXCLS
DATE              
2025-12-25     NaN
2025-12-26   13.60
2025-12-29   14.20
2025-12-30   14.33
2025-12-31   14.95</code></pre>
</div>
</div>
<div id="e4f9e483-3022-4e31-962c-fddddca04acf" class="cell" data-execution_count="84">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all data</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>combined_df <span class="op">=</span> pd.concat([</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    macro_data,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    ff_adj,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    sp500_cape_m,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    vix_data.rename(columns<span class="op">=</span>{<span class="st">"VIXCLS"</span>: <span class="st">"VIX"</span>})</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows with too many missing values</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>combined_df <span class="op">=</span> combined_df.dropna(thresh<span class="op">=</span><span class="bu">len</span>(combined_df.columns) <span class="op">*</span> <span class="fl">0.7</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>combined_df.tail()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2</th>
<th data-quarto-table-cell-role="th">FED_BS</th>
<th data-quarto-table-cell-role="th">FFR</th>
<th data-quarto-table-cell-role="th">Real_Rate</th>
<th data-quarto-table-cell-role="th">T3M</th>
<th data-quarto-table-cell-role="th">T10Y</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">CORE_CPI</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Household_Debt_Service</th>
<th data-quarto-table-cell-role="th">mkt_excess</th>
<th data-quarto-table-cell-role="th">smb</th>
<th data-quarto-table-cell-role="th">hml</th>
<th data-quarto-table-cell-role="th">rmw</th>
<th data-quarto-table-cell-role="th">cma</th>
<th data-quarto-table-cell-role="th">rf</th>
<th data-quarto-table-cell-role="th">P</th>
<th data-quarto-table-cell-role="th">CAPE</th>
<th data-quarto-table-cell-role="th">VIX</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>22028.7</td>
<td>6642578.0</td>
<td>4.33</td>
<td>0.838904</td>
<td>4.24</td>
<td>4.37</td>
<td>6.04</td>
<td>5.41</td>
<td>322.132</td>
<td>328.656</td>
<td>...</td>
<td>11.256338</td>
<td>0.0198</td>
<td>-0.0015</td>
<td>-0.0127</td>
<td>-0.0029</td>
<td>-0.0207</td>
<td>0.0034</td>
<td>6296.50</td>
<td>37.47</td>
<td>16.72</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>22108.3</td>
<td>6603384.0</td>
<td>4.33</td>
<td>1.523005</td>
<td>4.05</td>
<td>4.23</td>
<td>6.03</td>
<td>5.42</td>
<td>323.364</td>
<td>329.793</td>
<td>...</td>
<td>NaN</td>
<td>0.0185</td>
<td>0.0488</td>
<td>0.0442</td>
<td>-0.0067</td>
<td>0.0208</td>
<td>0.0038</td>
<td>6408.95</td>
<td>37.85</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.4</td>
<td>6608395.0</td>
<td>4.09</td>
<td>1.149868</td>
<td>3.86</td>
<td>4.16</td>
<td>5.83</td>
<td>5.22</td>
<td>324.368</td>
<td>330.542</td>
<td>...</td>
<td>NaN</td>
<td>0.0339</td>
<td>-0.0218</td>
<td>-0.0105</td>
<td>-0.0203</td>
<td>-0.0222</td>
<td>0.0033</td>
<td>6584.02</td>
<td>38.58</td>
<td>16.28</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>22298.0</td>
<td>6587034.0</td>
<td>3.86</td>
<td>0.973381</td>
<td>3.73</td>
<td>4.11</td>
<td>5.80</td>
<td>5.22</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>NaN</td>
<td>0.0196</td>
<td>-0.0131</td>
<td>-0.0309</td>
<td>-0.0522</td>
<td>-0.0403</td>
<td>0.0037</td>
<td>6735.69</td>
<td>39.21</td>
<td>17.44</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>22322.4</td>
<td>6552419.0</td>
<td>3.89</td>
<td>1.001027</td>
<td>3.73</td>
<td>4.02</td>
<td>5.80</td>
<td>5.18</td>
<td>325.031</td>
<td>331.068</td>
<td>...</td>
<td>NaN</td>
<td>-0.0013</td>
<td>0.0147</td>
<td>0.0376</td>
<td>0.0143</td>
<td>0.0068</td>
<td>0.0030</td>
<td>6740.89</td>
<td>39.12</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>5 rows × 31 columns</p>
</div>
</div>
</div>
</section>
<section id="feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering">4. Feature Engineering</h2>
<section id="construct-liquidity-variables" class="level3">
<h3 class="anchored" data-anchor-id="construct-liquidity-variables">4.1 Construct Liquidity Variables</h3>
<div id="65679d83-092e-480d-b60d-e49d71222d86" class="cell" data-execution_count="85">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> engineer_liquidity_features(df):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create liquidity-related features from raw macro data</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Growth rates</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'M2_growth'</span>] <span class="op">=</span> df[<span class="st">'M2'</span>].pct_change(<span class="dv">12</span>) <span class="op">*</span> <span class="dv">100</span>  <span class="co"># YoY % change</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'FED_BS_growth'</span>] <span class="op">=</span> df[<span class="st">'FED_BS'</span>].pct_change(<span class="dv">12</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Term spread</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Term_Spread'</span>] <span class="op">=</span> df[<span class="st">'T10Y'</span>] <span class="op">-</span> df[<span class="st">'FFR'</span>]</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Credit spread</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Credit_Spread'</span>] <span class="op">=</span> df[<span class="st">'BAA'</span>] <span class="op">-</span> df[<span class="st">'AAA'</span>]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Real interest rate (ex-post using CPI)</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'CPI_inflation'</span>] <span class="op">=</span> df[<span class="st">'CPI'</span>].pct_change(<span class="dv">12</span>) <span class="op">*</span> <span class="dv">100</span>  <span class="co"># YoY inflation</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#df['Real_Rate'] = df['FFR'] - df['CPI_inflation']</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Valuation metrics</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'log_CAPE'</span>] <span class="op">=</span> np.log(df[<span class="st">'CAPE'</span>])</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'CAPE_zscore'</span>] <span class="op">=</span> (df[<span class="st">'CAPE'</span>] <span class="op">-</span> df[<span class="st">'CAPE'</span>].rolling(<span class="dv">60</span>).mean()) <span class="op">/</span> df[<span class="st">'CAPE'</span>].rolling(<span class="dv">60</span>).std()</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6. Risk-adjusted term spread</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Risk_Adj_Spread'</span>] <span class="op">=</span> df[<span class="st">'Term_Spread'</span>] <span class="op">/</span> (df[<span class="st">'VIX'</span>] <span class="op">/</span> <span class="dv">100</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#7 Net liquidity</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'Net_Liq'</span>] <span class="op">=</span> df[<span class="st">'FED_BS'</span>] <span class="op">-</span> (df[<span class="st">'TGA'</span>] <span class="op">+</span> df[<span class="st">'RRP'</span>])</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply feature engineering</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>df_features <span class="op">=</span> engineer_liquidity_features(combined_df)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Feature engineering complete"</span>)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">New features created:"</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>new_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> df_features.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> combined_df.columns]</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> new_cols:</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>df_features.tail(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Feature engineering complete

New features created:
  - M2_growth
  - FED_BS_growth
  - Term_Spread
  - Credit_Spread
  - CPI_inflation
  - log_CAPE
  - CAPE_zscore
  - Risk_Adj_Spread
  - Net_Liq</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="85">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2</th>
<th data-quarto-table-cell-role="th">FED_BS</th>
<th data-quarto-table-cell-role="th">FFR</th>
<th data-quarto-table-cell-role="th">Real_Rate</th>
<th data-quarto-table-cell-role="th">T3M</th>
<th data-quarto-table-cell-role="th">T10Y</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">CORE_CPI</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">VIX</th>
<th data-quarto-table-cell-role="th">M2_growth</th>
<th data-quarto-table-cell-role="th">FED_BS_growth</th>
<th data-quarto-table-cell-role="th">Term_Spread</th>
<th data-quarto-table-cell-role="th">Credit_Spread</th>
<th data-quarto-table-cell-role="th">CPI_inflation</th>
<th data-quarto-table-cell-role="th">log_CAPE</th>
<th data-quarto-table-cell-role="th">CAPE_zscore</th>
<th data-quarto-table-cell-role="th">Risk_Adj_Spread</th>
<th data-quarto-table-cell-role="th">Net_Liq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>22028.7</td>
<td>6642578.0</td>
<td>4.33</td>
<td>0.838904</td>
<td>4.24</td>
<td>4.37</td>
<td>6.04</td>
<td>5.41</td>
<td>322.132</td>
<td>328.656</td>
<td>...</td>
<td>16.72</td>
<td>4.480153</td>
<td>-7.464249</td>
<td>0.04</td>
<td>0.63</td>
<td>2.731801</td>
<td>3.623541</td>
<td>1.242869</td>
<td>0.239234</td>
<td>6271856.555</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>22108.3</td>
<td>6603384.0</td>
<td>4.33</td>
<td>1.523005</td>
<td>4.05</td>
<td>4.23</td>
<td>6.03</td>
<td>5.42</td>
<td>323.364</td>
<td>329.793</td>
<td>...</td>
<td>NaN</td>
<td>4.427283</td>
<td>-7.298001</td>
<td>-0.10</td>
<td>0.61</td>
<td>2.939220</td>
<td>3.633631</td>
<td>1.306865</td>
<td>NaN</td>
<td>6013308.102</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.4</td>
<td>6608395.0</td>
<td>4.09</td>
<td>1.149868</td>
<td>3.86</td>
<td>4.16</td>
<td>5.83</td>
<td>5.22</td>
<td>324.368</td>
<td>330.542</td>
<td>...</td>
<td>16.28</td>
<td>4.492553</td>
<td>-6.661865</td>
<td>0.07</td>
<td>0.61</td>
<td>3.022700</td>
<td>3.652734</td>
<td>1.461587</td>
<td>0.429975</td>
<td>5803489.929</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>22298.0</td>
<td>6587034.0</td>
<td>3.86</td>
<td>0.973381</td>
<td>3.73</td>
<td>4.11</td>
<td>5.80</td>
<td>5.22</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>17.44</td>
<td>4.645651</td>
<td>-6.080511</td>
<td>0.25</td>
<td>0.58</td>
<td>2.789925</td>
<td>3.668932</td>
<td>1.575675</td>
<td>1.433486</td>
<td>5628992.198</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>22322.4</td>
<td>6552419.0</td>
<td>3.89</td>
<td>1.001027</td>
<td>3.73</td>
<td>4.02</td>
<td>5.80</td>
<td>5.18</td>
<td>325.031</td>
<td>331.068</td>
<td>...</td>
<td>NaN</td>
<td>4.271300</td>
<td>-5.108093</td>
<td>0.13</td>
<td>0.62</td>
<td>2.711969</td>
<td>3.666634</td>
<td>1.490940</td>
<td>NaN</td>
<td>5649017.439</td>
</tr>
</tbody>
</table>

<p>5 rows × 40 columns</p>
</div>
</div>
</div>
</section>
<section id="construct-valuation-spread-measure" class="level3">
<h3 class="anchored" data-anchor-id="construct-valuation-spread-measure">4.2 Construct Valuation Spread Measure</h3>
<p>We define valuation spread as the return differential between cheap (high B/M) and expensive (low B/M) stocks. This is proxied by the HML (High Minus Low) factor from Fama-French.</p>
<div id="8ea77c44-03b9-475c-a830-eef5db04dea3" class="cell" data-execution_count="86">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_valuation_spread(df):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct valuation spread measure</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Primary measure: HML (Fama-French) represents value premium</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Secondary: CAPE z-score as market-level valuation</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cumulative HML performance (value vs growth)</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'HML_cumret'</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">'hml'</span>] <span class="op">/</span> <span class="dv">100</span>).cumprod()</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rolling 12-month HML performance</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'HML_12m'</span>] <span class="op">=</span> df[<span class="st">'hml'</span>].rolling(<span class="dv">12</span>).<span class="bu">sum</span>()</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define valuation spread as:</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Positive = cheap stocks outperforming (value regime)</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Negative = expensive stocks outperforming (growth regime)</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'V_spread'</span>] <span class="op">=</span> df[<span class="st">'HML_12m'</span>]  <span class="co"># 12-month rolling HML</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'V_spread_z'</span>] <span class="op">=</span> (df[<span class="st">'V_spread'</span>] <span class="op">-</span> df[<span class="st">'V_spread'</span>].mean()) <span class="op">/</span> df[<span class="st">'V_spread'</span>].std()</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Also use CAPE z-score as alternative valuation measure</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'V_level'</span>] <span class="op">=</span> df[<span class="st">'CAPE_zscore'</span>]</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>df_features <span class="op">=</span> construct_valuation_spread(df_features)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Valuation spread measures constructed"</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">V_spread (HML 12m) stats:"</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_features[<span class="st">'V_spread'</span>].describe())</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>df_features.tail(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Valuation spread measures constructed

V_spread (HML 12m) stats:
count    420.000000
mean       0.018185
std        0.141636
min       -0.417500
25%       -0.078100
50%        0.016600
75%        0.095125
max        0.579800
Name: V_spread, dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="86">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2</th>
<th data-quarto-table-cell-role="th">FED_BS</th>
<th data-quarto-table-cell-role="th">FFR</th>
<th data-quarto-table-cell-role="th">Real_Rate</th>
<th data-quarto-table-cell-role="th">T3M</th>
<th data-quarto-table-cell-role="th">T10Y</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">CORE_CPI</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">CPI_inflation</th>
<th data-quarto-table-cell-role="th">log_CAPE</th>
<th data-quarto-table-cell-role="th">CAPE_zscore</th>
<th data-quarto-table-cell-role="th">Risk_Adj_Spread</th>
<th data-quarto-table-cell-role="th">Net_Liq</th>
<th data-quarto-table-cell-role="th">HML_cumret</th>
<th data-quarto-table-cell-role="th">HML_12m</th>
<th data-quarto-table-cell-role="th">V_spread</th>
<th data-quarto-table-cell-role="th">V_spread_z</th>
<th data-quarto-table-cell-role="th">V_level</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>22028.7</td>
<td>6642578.0</td>
<td>4.33</td>
<td>0.838904</td>
<td>4.24</td>
<td>4.37</td>
<td>6.04</td>
<td>5.41</td>
<td>322.132</td>
<td>328.656</td>
<td>...</td>
<td>2.731801</td>
<td>3.623541</td>
<td>1.242869</td>
<td>0.239234</td>
<td>6271856.555</td>
<td>1.005492</td>
<td>-0.0558</td>
<td>-0.0558</td>
<td>-0.522355</td>
<td>1.242869</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-08-31</th>
<td>22108.3</td>
<td>6603384.0</td>
<td>4.33</td>
<td>1.523005</td>
<td>4.05</td>
<td>4.23</td>
<td>6.03</td>
<td>5.42</td>
<td>323.364</td>
<td>329.793</td>
<td>...</td>
<td>2.939220</td>
<td>3.633631</td>
<td>1.306865</td>
<td>NaN</td>
<td>6013308.102</td>
<td>1.005936</td>
<td>-0.0006</td>
<td>-0.0006</td>
<td>-0.132625</td>
<td>1.306865</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.4</td>
<td>6608395.0</td>
<td>4.09</td>
<td>1.149868</td>
<td>3.86</td>
<td>4.16</td>
<td>5.83</td>
<td>5.22</td>
<td>324.368</td>
<td>330.542</td>
<td>...</td>
<td>3.022700</td>
<td>3.652734</td>
<td>1.461587</td>
<td>0.429975</td>
<td>5803489.929</td>
<td>1.005831</td>
<td>0.0166</td>
<td>0.0166</td>
<td>-0.011187</td>
<td>1.461587</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-10-31</th>
<td>22298.0</td>
<td>6587034.0</td>
<td>3.86</td>
<td>0.973381</td>
<td>3.73</td>
<td>4.11</td>
<td>5.80</td>
<td>5.22</td>
<td>NaN</td>
<td>NaN</td>
<td>...</td>
<td>2.789925</td>
<td>3.668932</td>
<td>1.575675</td>
<td>1.433486</td>
<td>5628992.198</td>
<td>1.005520</td>
<td>-0.0229</td>
<td>-0.0229</td>
<td>-0.290070</td>
<td>1.575675</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>22322.4</td>
<td>6552419.0</td>
<td>3.89</td>
<td>1.001027</td>
<td>3.73</td>
<td>4.02</td>
<td>5.80</td>
<td>5.18</td>
<td>325.031</td>
<td>331.068</td>
<td>...</td>
<td>2.711969</td>
<td>3.666634</td>
<td>1.490940</td>
<td>NaN</td>
<td>5649017.439</td>
<td>1.005898</td>
<td>0.0132</td>
<td>0.0132</td>
<td>-0.035192</td>
<td>1.490940</td>
</tr>
</tbody>
</table>

<p>5 rows × 45 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="liquidity-index-construction-via-sparse-pca" class="level2">
<h2 class="anchored" data-anchor-id="liquidity-index-construction-via-sparse-pca">5. Liquidity Index Construction via Sparse PCA</h2>
<section id="methodology" class="level3">
<h3 class="anchored" data-anchor-id="methodology">5.1 Methodology</h3>
<p>We construct a composite liquidity index using Sparse PCA (Zou et al.&nbsp;2006, Witten et al.&nbsp;2009) which:</p>
<ol type="1">
<li>Maximizes explained variance like standard PCA</li>
<li>Enforces sparsity via L1 penalty for interpretability</li>
<li>Selects only the most relevant liquidity indicators</li>
</ol>
<p><strong>Liquidity proxies:</strong> - Fed balance sheet growth (QE intensity) - Real interest rates (opportunity cost) - Term spread (yield curve steepness) - Credit spreads (credit conditions) - VIX (risk appetite)</p>
<p>All variables are sign-adjusted so higher values = easier liquidity conditions.</p>
<div id="dbf3243a-d1ae-4c4d-92d9-83a454c1e0c0" class="cell" data-execution_count="71">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_features.tail(<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2</th>
<th data-quarto-table-cell-role="th">FED_BS</th>
<th data-quarto-table-cell-role="th">FFR</th>
<th data-quarto-table-cell-role="th">Real_Rate</th>
<th data-quarto-table-cell-role="th">T3M</th>
<th data-quarto-table-cell-role="th">T10Y</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">CORE_CPI</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Credit_Spread</th>
<th data-quarto-table-cell-role="th">CPI_inflation</th>
<th data-quarto-table-cell-role="th">log_CAPE</th>
<th data-quarto-table-cell-role="th">CAPE_zscore</th>
<th data-quarto-table-cell-role="th">Risk_Adj_Spread</th>
<th data-quarto-table-cell-role="th">HML_cumret</th>
<th data-quarto-table-cell-role="th">HML_12m</th>
<th data-quarto-table-cell-role="th">V_spread</th>
<th data-quarto-table-cell-role="th">V_spread_z</th>
<th data-quarto-table-cell-role="th">V_level</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>22322.4</td>
<td>6552419.0</td>
<td>3.89</td>
<td>1.001027</td>
<td>3.73</td>
<td>4.02</td>
<td>5.8</td>
<td>5.18</td>
<td>325.031</td>
<td>331.068</td>
<td>...</td>
<td>0.62</td>
<td>2.711969</td>
<td>3.666634</td>
<td>1.49094</td>
<td>NaN</td>
<td>1.005898</td>
<td>0.0132</td>
<td>0.0132</td>
<td>-0.035192</td>
<td>1.49094</td>
</tr>
</tbody>
</table>

<p>1 rows × 33 columns</p>
</div>
</div>
</div>
<div id="9baca787-f092-4c5b-a15f-181d063b9599" class="cell" data-execution_count="93">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_liquidity_index(df, method<span class="op">=</span><span class="st">'sparse'</span>, n_components<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Build liquidity index using PCA or Sparse PCA</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    df : DataFrame</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Input data</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">    method : str</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">        'pca' or 'sparse'</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    n_components : int</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of components</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : float</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Sparsity penalty (only for sparse PCA)</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select liquidity variables</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    liq_vars <span class="op">=</span> [</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'M2_growth'</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'FED_BS_growth'</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Term_Spread'</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Real_Rate'</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Credit_Spread'</span>,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VIX'</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract data and drop NaN</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[liq_vars].copy()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> X.dropna()</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sign adjustments: higher = easier liquidity</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    X[<span class="st">'Real_Rate'</span>] <span class="op">=</span> <span class="op">-</span>X[<span class="st">'Real_Rate'</span>]  <span class="co"># Lower real rates = easier</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    X[<span class="st">'Credit_Spread'</span>] <span class="op">=</span> <span class="op">-</span>X[<span class="st">'Credit_Spread'</span>]  <span class="co"># Tighter spreads = easier</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    X[<span class="st">'VIX'</span>] <span class="op">=</span> <span class="op">-</span>X[<span class="st">'VIX'</span>]  <span class="co"># Lower VIX = easier</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    X_scaled_df <span class="op">=</span> pd.DataFrame(X_scaled, index<span class="op">=</span>X.index, columns<span class="op">=</span>X.columns)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit PCA/Sparse PCA</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="op">==</span> <span class="st">'sparse'</span>:</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> SparsePCA(n_components<span class="op">=</span>n_components, alpha<span class="op">=</span>alpha, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> PCA(n_components<span class="op">=</span>n_components)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit and transform</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> model.fit_transform(X_scaled)</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create series</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    L_series <span class="op">=</span> pd.Series(L[:, <span class="dv">0</span>], index<span class="op">=</span>X.index, name<span class="op">=</span><span class="st">'L'</span>)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get loadings</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    loadings <span class="op">=</span> pd.DataFrame(</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        model.components_.T,</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>X.columns,</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>[<span class="st">'PC1'</span>]</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate explained variance</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="op">==</span> <span class="st">'pca'</span>:</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>        explained_var <span class="op">=</span> model.explained_variance_ratio_[<span class="dv">0</span>]</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For sparse PCA, compute manually</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>        var_explained <span class="op">=</span> np.var(L[:, <span class="dv">0</span>]) <span class="op">/</span> np.<span class="bu">sum</span>(np.var(X_scaled, axis<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>        explained_var <span class="op">=</span> var_explained</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Liquidity Index Construction (</span><span class="sc">{</span>method<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Variance explained: </span><span class="sc">{</span>explained_var<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Loadings:"</span>)</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(loadings.sort_values(<span class="st">'PC1'</span>, ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Liquidity index range: </span><span class="sc">{</span>L_series<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>L_series<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean: </span><span class="sc">{</span>L_series<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">, Std: </span><span class="sc">{</span>L_series<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L_series, loadings, model, X_scaled_df</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Build liquidity index</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>L_index, loadings, pca_model, scaled_features <span class="op">=</span> build_liquidity_index(</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>    df_features,</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'sparse'</span>,</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>  <span class="co"># Moderate sparsity</span></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
Liquidity Index Construction (SPARSE)
======================================================================

Variance explained: 44.98%

Loadings:
                    PC1
FED_BS_growth  0.525122
M2_growth      0.379190
Term_Spread    0.370752
Real_Rate      0.244985
Credit_Spread -0.414407
VIX           -0.459623

Liquidity index range: -3.15 to 7.11
Mean: 0.00, Std: 1.65</code></pre>
</div>
</div>
<section id="liquidity-index-augmentation-two-layer-liquidity-flow-vs-stock-excess" class="level4">
<h4 class="anchored" data-anchor-id="liquidity-index-augmentation-two-layer-liquidity-flow-vs-stock-excess">Liquidity Index Augmentation: Two-layer liquidity: Flow vs Stock / Excess</h4>
</section>
<section id="add-level-excess-variables" class="level4">
<h4 class="anchored" data-anchor-id="add-level-excess-variables">Add level / excess variables</h4>
<p>Examples (all can be pulled from FRED):</p>
<p><strong>Log level vs pre-2008 trend</strong></p>
<p>Let <span class="math inline">\(m_t = \log M2_t\)</span>. Fit a linear trend on a pre-QE baseline (say 1985–2007):</p>
<p><span class="math inline">\(m_t \approx a + bt \quad (t \le 2007)\)</span></p>
<p>Then define excess money stock:</p>
<p><span class="math inline">\(EM_t = m_t - (a + bt)\)</span></p>
<p>After 2008, <span class="math inline">\(EM_t\)</span> becomes increasingly positive if M2 grows above its historical trend.</p>
<p>Similarly for the Fed Balance Sheet, let <span class="math inline">\(b_t = \log(\text{FedBal}_t)\)</span>:</p>
<p><span class="math inline">\(EB_t = b_t - (\alpha + \beta t)\)</span> (pre-2007 trend)</p>
<hr>
<p><strong>Excess liquidity versus real economy</strong></p>
<p>Use real GDP series (e.g., GDPC1) and define:</p>
<p><span class="math inline">\(EL_t = \log M2_t - \log GDP_t\)</span></p>
<p>Or measure multi-year excess growth:</p>
<p><span class="math inline">\(EL_t(3y) = \log M2_t - \log M2_{t-36} - (\log GDP_t - \log GDP_{t-36})\)</span></p>
<hr>
<p><strong>ZIRP / negative real-rate indicator</strong></p>
<p><span class="math inline">\(D_t^{ZIRP} = 1(r_t^{real} &lt; 0)\)</span></p>
<p>From 2009–2015, this should be mostly 1.</p>
<hr>
</section>
<section id="build-an-augmented-feature-vector" class="level4">
<h4 class="anchored" data-anchor-id="build-an-augmented-feature-vector">Build an augmented feature vector</h4>
<p>Instead of only:</p>
<p><span class="math inline">\(x_t = \{ \Delta \log M2_t,\; \Delta \log FedBal_t,\; TS_t,\; r_t^{real},\; CS_t \}\)</span></p>
<p>Let’s expand to:</p>
<p><span class="math inline">\(x_t^{aug} = \{
\Delta \log M2_t,\;
\Delta \log FedBal_t,\;
TS_t,\;
r_t^{real},\;
CS_t,\;
EM_t,\;
EB_t,\;
EL_t,\;
EL_t(3y),\;
D_t^{ZIRP}
\}\)</span></p>
<p>Then standardize and perform PCA / SparsePCA on this.</p>
<ul>
<li><strong>PC1</strong> (or a combination) loading heavily on <span class="math inline">\(EM\)</span>, <span class="math inline">\(EB\)</span>, <span class="math inline">\(EL\)</span>, <span class="math inline">\(D_t^{ZIRP}\)</span> → structural easy-money regime<br>
</li>
<li><strong>PC2</strong> (or your current PC1) loading on short-horizon changes → flow / shock liquidity</li>
</ul>
<div id="71c92649-812b-4970-92dd-78833fb3b67e" class="cell" data-execution_count="88">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df_features.columns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>Index(['M2', 'FED_BS', 'FFR', 'Real_Rate', 'T3M', 'T10Y', 'BAA', 'AAA', 'CPI',
       'CORE_CPI', 'GDP', 'IORB', 'RRP', 'TGA', 'Bank_Reserves', 'CI_Loans',
       'Consumer_Credit', 'Mortgage_Rate', 'Prime_Rate', 'STLFSI',
       'Dollar_Index', 'Household_Debt_Service', 'mkt_excess', 'smb', 'hml',
       'rmw', 'cma', 'rf', 'P', 'CAPE', 'VIX', 'M2_growth', 'FED_BS_growth',
       'Term_Spread', 'Credit_Spread', 'CPI_inflation', 'log_CAPE',
       'CAPE_zscore', 'Risk_Adj_Spread', 'Net_Liq', 'HML_cumret', 'HML_12m',
       'V_spread', 'V_spread_z', 'V_level'],
      dtype='object')</code></pre>
</div>
</div>
<div id="ac411b0c-a6ef-4984-92ad-23143b1a97a8" class="cell" data-execution_count="92">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> augment_liquidity_index(df_features):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df_features.copy()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flow proxies</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dlog_M2"</span>]      <span class="op">=</span> np.log(df[<span class="st">"M2"</span>]).diff()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dlog_FED_BS"</span>]  <span class="op">=</span> np.log(df[<span class="st">"FED_BS"</span>]).diff()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Levels</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_M2"</span>]      <span class="op">=</span> np.log(df[<span class="st">"M2"</span>])</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_FED_BS"</span>] <span class="op">=</span> np.log(df[<span class="st">"FED_BS"</span>])</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use data up to 2007-12-31 to fit trends</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    pre <span class="op">=</span> df.loc[: <span class="st">"2007-12-31"</span>].copy()</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Trend for M2 ---</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    pre_m2 <span class="op">=</span> pre[<span class="st">"log_M2"</span>].dropna()</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    t_m2   <span class="op">=</span> np.arange(<span class="bu">len</span>(pre_m2))</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    coefs_M2 <span class="op">=</span> np.polyfit(t_m2, pre_m2.values, deg<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    t_full <span class="op">=</span> np.arange(<span class="bu">len</span>(df))</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    trend_M2 <span class="op">=</span> np.polyval(coefs_M2, t_full)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"EM"</span>] <span class="op">=</span> df[<span class="st">"log_M2"</span>] <span class="op">-</span> trend_M2</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Trend for Fed balance sheet ---</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    pre_fb <span class="op">=</span> pre[<span class="st">"log_FED_BS"</span>].dropna()</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    t_fb   <span class="op">=</span> np.arange(<span class="bu">len</span>(pre_fb))</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    coefs_FB <span class="op">=</span> np.polyfit(t_fb, pre_fb.values, deg<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    trend_FB <span class="op">=</span> np.polyval(coefs_FB, t_full)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"EB"</span>] <span class="op">=</span> df[<span class="st">"log_FED_BS"</span>] <span class="op">-</span> trend_FB</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Excess liquidity vs GDP over 3y</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_GDP"</span>] <span class="op">=</span> np.log(df[<span class="st">"GDP"</span>])</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"EL_3y"</span>] <span class="op">=</span> (df[<span class="st">"log_M2"</span>] <span class="op">-</span> df[<span class="st">"log_M2"</span>].shift(<span class="dv">36</span>)) <span class="op">-</span> <span class="op">\</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>                  (df[<span class="st">"log_GDP"</span>] <span class="op">-</span> df[<span class="st">"log_GDP"</span>].shift(<span class="dv">36</span>))</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>df_features_aug <span class="op">=</span> augment_liquidity_index(df_features)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>df_features_aug.tail(<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="92">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2</th>
<th data-quarto-table-cell-role="th">FED_BS</th>
<th data-quarto-table-cell-role="th">FFR</th>
<th data-quarto-table-cell-role="th">Real_Rate</th>
<th data-quarto-table-cell-role="th">T3M</th>
<th data-quarto-table-cell-role="th">T10Y</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">CORE_CPI</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">V_spread_z</th>
<th data-quarto-table-cell-role="th">V_level</th>
<th data-quarto-table-cell-role="th">dlog_M2</th>
<th data-quarto-table-cell-role="th">dlog_FED_BS</th>
<th data-quarto-table-cell-role="th">log_M2</th>
<th data-quarto-table-cell-role="th">log_FED_BS</th>
<th data-quarto-table-cell-role="th">EM</th>
<th data-quarto-table-cell-role="th">EB</th>
<th data-quarto-table-cell-role="th">log_GDP</th>
<th data-quarto-table-cell-role="th">EL_3y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-11-30</th>
<td>22322.4</td>
<td>6552419.0</td>
<td>3.89</td>
<td>1.001027</td>
<td>3.73</td>
<td>4.02</td>
<td>5.8</td>
<td>5.18</td>
<td>325.031</td>
<td>331.068</td>
<td>...</td>
<td>-0.035192</td>
<td>1.49094</td>
<td>0.001094</td>
<td>-0.005269</td>
<td>10.013346</td>
<td>15.695345</td>
<td>0.19326</td>
<td>0.685233</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>1 rows × 53 columns</p>
</div>
</div>
</div>
<div id="c1f00771-299b-4f74-b39e-c96073925ef0" class="cell" data-execution_count="94">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_liquidity_index_aug(df, method<span class="op">=</span><span class="st">'sparse'</span>, n_components<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Build liquidity index using PCA or Sparse PCA</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">    df : DataFrame</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Input data</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">    method : str</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">        'pca' or 'sparse'</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">    n_components : int</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of components</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : float</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Sparsity penalty (only for sparse PCA)</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select liquidity variables</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    liq_vars <span class="op">=</span> [</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'M2_growth'</span>,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'FED_BS_growth'</span>,</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'EM'</span>,</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'EB'</span>,</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'EL_3y'</span>,</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Term_Spread'</span>,</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Real_Rate'</span>,</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Credit_Spread'</span>,</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VIX'</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract data and drop NaN</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[liq_vars].copy()</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> X.dropna()</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sign adjustments: higher = easier liquidity</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    X[<span class="st">'Real_Rate'</span>] <span class="op">=</span> <span class="op">-</span>X[<span class="st">'Real_Rate'</span>]  <span class="co"># Lower real rates = easier</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    X[<span class="st">'Credit_Spread'</span>] <span class="op">=</span> <span class="op">-</span>X[<span class="st">'Credit_Spread'</span>]  <span class="co"># Tighter spreads = easier</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    X[<span class="st">'VIX'</span>] <span class="op">=</span> <span class="op">-</span>X[<span class="st">'VIX'</span>]  <span class="co"># Lower VIX = easier</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    X_scaled_df <span class="op">=</span> pd.DataFrame(X_scaled, index<span class="op">=</span>X.index, columns<span class="op">=</span>X.columns)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit PCA/Sparse PCA</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="op">==</span> <span class="st">'sparse'</span>:</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> SparsePCA(n_components<span class="op">=</span>n_components, alpha<span class="op">=</span>alpha, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> PCA(n_components<span class="op">=</span>n_components)</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit and transform</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> model.fit_transform(X_scaled)</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create series</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    L_series <span class="op">=</span> pd.Series(L[:, <span class="dv">0</span>], index<span class="op">=</span>X.index, name<span class="op">=</span><span class="st">'L'</span>)</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get loadings</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>    loadings <span class="op">=</span> pd.DataFrame(</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>        model.components_.T,</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>X.columns,</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>[<span class="st">'PC1'</span>]</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate explained variance</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="op">==</span> <span class="st">'pca'</span>:</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>        explained_var <span class="op">=</span> model.explained_variance_ratio_[<span class="dv">0</span>]</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For sparse PCA, compute manually</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>        var_explained <span class="op">=</span> np.var(L[:, <span class="dv">0</span>]) <span class="op">/</span> np.<span class="bu">sum</span>(np.var(X_scaled, axis<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>        explained_var <span class="op">=</span> var_explained</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Liquidity Index Construction (</span><span class="sc">{</span>method<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Variance explained: </span><span class="sc">{</span>explained_var<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Loadings:"</span>)</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(loadings.sort_values(<span class="st">'PC1'</span>, ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Liquidity index range: </span><span class="sc">{</span>L_series<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>L_series<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean: </span><span class="sc">{</span>L_series<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">, Std: </span><span class="sc">{</span>L_series<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L_series, loadings, model, X_scaled_df</span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Build liquidity index</span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>L_index, loadings, pca_model, scaled_features <span class="op">=</span> build_liquidity_index_aug(</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>    df_features_aug,</span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'sparse'</span>,</span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>  <span class="co"># Moderate sparsity</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
Liquidity Index Construction (SPARSE)
======================================================================

Variance explained: 37.40%

Loadings:
                    PC1
EL_3y          0.479785
FED_BS_growth  0.414107
M2_growth      0.386169
Term_Spread    0.365477
Real_Rate      0.348663
EB             0.135796
EM             0.091370
Credit_Spread -0.242676
VIX           -0.329204

Liquidity index range: -4.23 to 4.97
Mean: -0.00, Std: 1.84</code></pre>
</div>
</div>
</section>
</section>
<section id="explained-variance-is-too-small-45" class="level3">
<h3 class="anchored" data-anchor-id="explained-variance-is-too-small-45">Explained variance is too small = ~45%</h3>
<div id="42d3b88a-a9bf-4fc0-9b6d-955956682e67" class="cell" data-execution_count="104">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_liquidity_index_aug_1(df, method<span class="op">=</span><span class="st">'sparse'</span>, n_components<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Build liquidity index using PCA or Sparse PCA</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">    df : DataFrame</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Input data</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    method : str</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">        'pca' or 'sparse'</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">    n_components : int</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of components</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : float</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Sparsity penalty (only for sparse PCA)</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Select liquidity variables</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># liq_vars = [</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'Net_Liq',</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'M2_growth',</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'FED_BS_growth',</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'EM',</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'EB',</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'EL_3y',</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'Term_Spread',</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'Real_Rate',</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'Credit_Spread',</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'VIX',</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'Dollar_Index',</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'Household_Debt_Service',</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     'STLFSI'</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ]</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    liq_vars <span class="op">=</span> [</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">'M2_growth'</span>,</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">'FED_BS_growth'</span>,</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Term_Spread'</span>,</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Real_Rate'</span>,</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Credit_Spread'</span>,</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VIX'</span>,</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'EL_3y'</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract data and drop NaN</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[liq_vars].copy()</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> X.dropna()</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ========================================</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CORRECT SIGN ADJUSTMENTS</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rule: Higher value = EASIER liquidity</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ========================================</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variables to FLIP (higher originally means tighter)</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>    flip_vars <span class="op">=</span> {</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Real_Rate'</span>: <span class="st">'Higher real rates = tighter → FLIP'</span>,</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Credit_Spread'</span>: <span class="st">'Wider spreads = tighter → FLIP'</span>,</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VIX'</span>: <span class="st">'Higher VIX = tighter → FLIP'</span>,</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">'STLFSI'</span>: <span class="st">'Higher stress = tighter → FLIP'</span>,</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Dollar_Index'</span>: <span class="st">'Stronger dollar = tighter → FLIP'</span>,</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Household_Debt_Service'</span>: <span class="st">'Higher burden = tighter → FLIP'</span>,</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variables to KEEP (higher already means easier)</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    keep_vars <span class="op">=</span> {</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Net_Liq'</span>: <span class="st">'Higher net liquidity = easier → KEEP'</span>,</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">'M2_growth'</span>: <span class="st">'Higher growth = easier → KEEP'</span>,</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">'FED_BS_growth'</span>: <span class="st">'Higher growth = easier → KEEP'</span>,</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">'EM'</span>: <span class="st">'Higher excess M2 = easier → KEEP'</span>,</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">'EB'</span>: <span class="st">'Higher excess Fed BS = easier → KEEP'</span>,</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">'EL_3y'</span>: <span class="st">'Higher excess liquidity = easier → KEEP'</span>,</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Term_Spread'</span>: <span class="st">'Positive slope = easier → KEEP'</span>,</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">➖ Flipping (higher = tighter):"</span>)</span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var, reason <span class="kw">in</span> flip_vars.items():</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> var <span class="kw">in</span> X.columns:</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>            X[var] <span class="op">=</span> <span class="op">-</span>X[var]</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>var<span class="sc">:25s}</span><span class="ss">: </span><span class="sc">{</span>reason<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✅ Keeping (higher = easier):"</span>)</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var, reason <span class="kw">in</span> keep_vars.items():</span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> var <span class="kw">in</span> X.columns:</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>var<span class="sc">:25s}</span><span class="ss">: </span><span class="sc">{</span>reason<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize</span></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>    X_scaled_df <span class="op">=</span> pd.DataFrame(X_scaled, index<span class="op">=</span>X.index, columns<span class="op">=</span>X.columns)</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit PCA/Sparse PCA</span></span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="op">==</span> <span class="st">'sparse'</span>:</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> SparsePCA(n_components<span class="op">=</span>n_components, alpha<span class="op">=</span>alpha, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> PCA(n_components<span class="op">=</span>n_components)</span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit and transform</span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> model.fit_transform(X_scaled)</span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create series</span></span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>    L_series <span class="op">=</span> pd.Series(L[:, <span class="dv">0</span>], index<span class="op">=</span>X.index, name<span class="op">=</span><span class="st">'L'</span>)</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get loadings</span></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>    loadings <span class="op">=</span> pd.DataFrame(</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>        model.components_.T,</span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>X.columns,</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>[<span class="st">'PC1'</span>]</span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate explained variance</span></span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="op">==</span> <span class="st">'pca'</span>:</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>        explained_var <span class="op">=</span> model.explained_variance_ratio_[<span class="dv">0</span>]</span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For sparse PCA, compute manually</span></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>        var_explained <span class="op">=</span> np.var(L[:, <span class="dv">0</span>]) <span class="op">/</span> np.<span class="bu">sum</span>(np.var(X_scaled, axis<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>        explained_var <span class="op">=</span> var_explained</span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Liquidity Index Construction (</span><span class="sc">{</span>method<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Variance explained: </span><span class="sc">{</span>explained_var<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Loadings:"</span>)</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(loadings.sort_values(<span class="st">'PC1'</span>, ascending<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Liquidity index range: </span><span class="sc">{</span>L_series<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>L_series<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Mean: </span><span class="sc">{</span>L_series<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">, Std: </span><span class="sc">{</span>L_series<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L_series, loadings, model, X_scaled_df</span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Build liquidity index</span></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>L_index, loadings, pca_model, scaled_features <span class="op">=</span> build_liquidity_index_aug_1(</span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>    df_features_aug,</span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">'sparse'</span>,</span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>  <span class="co"># Moderate sparsity</span></span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
➖ Flipping (higher = tighter):
   Real_Rate                : Higher real rates = tighter → FLIP
   Credit_Spread            : Wider spreads = tighter → FLIP
   VIX                      : Higher VIX = tighter → FLIP

✅ Keeping (higher = easier):
   M2_growth                : Higher growth = easier → KEEP
   FED_BS_growth            : Higher growth = easier → KEEP
   EL_3y                    : Higher excess liquidity = easier → KEEP
   Term_Spread              : Positive slope = easier → KEEP

======================================================================
Liquidity Index Construction (SPARSE)
======================================================================

Variance explained: 47.21%

Loadings:
                    PC1
EL_3y          0.472608
FED_BS_growth  0.428525
Term_Spread    0.385863
M2_growth      0.381727
Real_Rate      0.334564
Credit_Spread -0.269403
VIX           -0.337477

Liquidity index range: -4.46 to 5.37
Mean: -0.00, Std: 1.82</code></pre>
</div>
</div>
</section>
</section>
<section id="regime-detection-via-hidden-markov-models" class="level2">
<h2 class="anchored" data-anchor-id="regime-detection-via-hidden-markov-models">6. Regime Detection via Hidden Markov Models</h2>
<section id="hmm-specification" class="level3">
<h3 class="anchored" data-anchor-id="hmm-specification">6.1 HMM Specification</h3>
<p>We employ a 3-state Gaussian HMM to identify: - <strong>State 0 (Tight):</strong> Low liquidity, restrictive monetary policy - <strong>State 1 (Neutral):</strong> Normal conditions - <strong>State 2 (High):</strong> Easy liquidity, expansionary policy</p>
<p>The model assumes: <span class="math display">\[L_t | s_t = k \sim \mathcal{N}(\mu_k, \sigma_k^2)\]</span></p>
<p>With transition matrix capturing regime persistence.</p>
<div id="ee7343d6-08b5-408d-a088-6ad80c53c4b3" class="cell" data-execution_count="105">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit_hmm_regimes(L_series, n_states<span class="op">=</span><span class="dv">3</span>, n_iter<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Fit Hidden Markov Model to identify liquidity regimes</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">    L_series : Series</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Liquidity index</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">    n_states : int</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of hidden states</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">    n_iter : int</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Maximum EM iterations</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare data</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> L_series.dropna().values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit HMM</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> hmm.GaussianHMM(</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        n_components<span class="op">=</span>n_states,</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        covariance_type<span class="op">=</span><span class="st">'full'</span>,</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        n_iter<span class="op">=</span>n_iter,</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    model.fit(X)</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict states (Viterbi algorithm)</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    states <span class="op">=</span> model.predict(X)</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get posterior probabilities</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    posteriors <span class="op">=</span> model.predict_proba(X)</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create results DataFrame</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'L'</span>: L_series.dropna(),</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'state'</span>: states</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_states):</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>        results[<span class="ss">f'prob_state_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> posteriors[:, i]</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort states by mean (0=Tight, 1=Neutral, 2=High)</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    state_means <span class="op">=</span> results.groupby(<span class="st">'state'</span>)[<span class="st">'L'</span>].mean().sort_values()</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    state_mapping <span class="op">=</span> {old: new <span class="cf">for</span> new, old <span class="kw">in</span> <span class="bu">enumerate</span>(state_means.index)}</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'state'</span>] <span class="op">=</span> results[<span class="st">'state'</span>].<span class="bu">map</span>(state_mapping)</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add labels</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    state_labels <span class="op">=</span> {<span class="dv">0</span>: <span class="st">'Tight'</span>, <span class="dv">1</span>: <span class="st">'Neutral'</span>, <span class="dv">2</span>: <span class="st">'High'</span>}</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'state_label'</span>] <span class="op">=</span> results[<span class="st">'state'</span>].<span class="bu">map</span>(state_labels)</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print diagnostics</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"HMM Regime Detection (</span><span class="sc">{</span>n_states<span class="sc">}</span><span class="ss"> states)"</span>)</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Model converged: </span><span class="sc">{</span>model<span class="sc">.</span>monitor_<span class="sc">.</span>converged<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Log-likelihood: </span><span class="sc">{</span>model<span class="sc">.</span>score(X)<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">State statistics:"</span>)</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> state <span class="kw">in</span> <span class="bu">range</span>(n_states):</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> results[<span class="st">'state'</span>] <span class="op">==</span> state</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>        n_obs <span class="op">=</span> mask.<span class="bu">sum</span>()</span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>        pct <span class="op">=</span> n_obs <span class="op">/</span> <span class="bu">len</span>(results) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>        mean_L <span class="op">=</span> results.loc[mask, <span class="st">'L'</span>].mean()</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>        std_L <span class="op">=</span> results.loc[mask, <span class="st">'L'</span>].std()</span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> state_labels[state]</span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  State </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>n_obs<span class="sc">}</span><span class="ss"> obs (</span><span class="sc">{</span>pct<span class="sc">:.1f}</span><span class="ss">%), "</span></span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"L = </span><span class="sc">{</span>mean_L<span class="sc">:+.2f}</span><span class="ss"> ± </span><span class="sc">{</span>std_L<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Transition Matrix:"</span>)</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>    trans_matrix <span class="op">=</span> pd.DataFrame(</span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>        model.transmat_,</span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="ss">f"From_</span><span class="sc">{</span>state_labels[i]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_states)],</span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>[<span class="ss">f"To_</span><span class="sc">{</span>state_labels[i]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_states)]</span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(trans_matrix.<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate regime persistence (diagonal elements)</span></span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>    persistence <span class="op">=</span> np.diag(model.transmat_)</span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Regime persistence (prob. of staying):"</span>)</span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, label <span class="kw">in</span> state_labels.items():</span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>persistence[i]<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results, model, state_labels</span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit HMM</span></span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a>regimes_df, hmm_model, state_labels <span class="op">=</span> fit_hmm_regimes(L_index, n_states<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
HMM Regime Detection (3 states)
======================================================================

Model converged: True
Log-likelihood: -301.76

State statistics:
  State 0 (Tight): 80 obs (43.2%), L = -1.62 ± 0.99
  State 1 (Neutral): 53 obs (28.6%), L = +1.21 ± 1.24
  State 2 (High): 52 obs (28.1%), L = +1.26 ± 1.29

Transition Matrix:
              To_Tight  To_Neutral  To_High
From_Tight       0.001       0.999    0.000
From_Neutral     0.935       0.009    0.056
From_High        0.022       0.004    0.974

Regime persistence (prob. of staying):
  Tight: 0.1%
  Neutral: 0.9%
  High: 97.4%</code></pre>
</div>
</div>
</section>
<section id="validation" class="level3">
<h3 class="anchored" data-anchor-id="validation">Validation</h3>
<div id="fc03397b-2f09-4a61-8bb5-0c37a461c302" class="cell" data-execution_count="106">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> map_to_known_liquidity_regimes():</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Define known Fed policy regimes based on historical record</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format: (start_date, end_date, regime_type, description)</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    known_regimes <span class="op">=</span> [</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># =====================================</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pre-Crisis Era (1990-2007)</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># =====================================</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'1990-01'</span>, <span class="st">'1992-12'</span>, <span class="st">'Neutral'</span>, <span class="st">'Post-1990 Recession, Gradual Easing'</span>),</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'1993-01'</span>, <span class="st">'1994-01'</span>, <span class="st">'High'</span>, <span class="st">'Accommodative Policy, Economic Expansion'</span>),</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'1994-02'</span>, <span class="st">'1995-12'</span>, <span class="st">'Tight'</span>, <span class="st">'Fed Tightening Cycle (3.0% → 6.0%)'</span>),</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'1996-01'</span>, <span class="st">'1998-12'</span>, <span class="st">'Neutral'</span>, <span class="st">'Goldilocks Economy'</span>),</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'1999-01'</span>, <span class="st">'2000-05'</span>, <span class="st">'Tight'</span>, <span class="st">'Dot-com Bubble, Y2K Tightening'</span>),</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2000-06'</span>, <span class="st">'2003-06'</span>, <span class="st">'High'</span>, <span class="st">'Dot-com Crash Response, Aggressive Easing'</span>),</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2003-07'</span>, <span class="st">'2004-05'</span>, <span class="st">'High'</span>, <span class="st">'Ultra-Low Rates (1%), Housing Boom'</span>),</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2004-06'</span>, <span class="st">'2006-06'</span>, <span class="st">'Tight'</span>, <span class="st">'Fed Hiking Cycle (1% → 5.25%)'</span>),</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2006-07'</span>, <span class="st">'2007-07'</span>, <span class="st">'Neutral'</span>, <span class="st">'Pause at Peak, Pre-Crisis'</span>),</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># =====================================</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Financial Crisis &amp; QE Era (2007-2015)</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># =====================================</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2007-08'</span>, <span class="st">'2008-08'</span>, <span class="st">'Neutral'</span>, <span class="st">'Initial Crisis Response, Rate Cuts Begin'</span>),</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2008-09'</span>, <span class="st">'2010-03'</span>, <span class="st">'High'</span>, <span class="st">'QE1: Emergency Response ($1.7T)'</span>),</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2010-04'</span>, <span class="st">'2010-10'</span>, <span class="st">'Neutral'</span>, <span class="st">'QE1 Taper, Brief Pause'</span>),</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2010-11'</span>, <span class="st">'2011-06'</span>, <span class="st">'High'</span>, <span class="st">'QE2: $600B Purchase Program'</span>),</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2011-07'</span>, <span class="st">'2012-08'</span>, <span class="st">'Neutral'</span>, <span class="st">'Operation Twist, Pre-QE3'</span>),</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2012-09'</span>, <span class="st">'2014-10'</span>, <span class="st">'High'</span>, <span class="st">'QE3: $85B/month, then taper'</span>),</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2014-11'</span>, <span class="st">'2015-11'</span>, <span class="st">'Neutral'</span>, <span class="st">'Post-QE3, ZIRP Maintained'</span>),</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># =====================================</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalization Attempt (2015-2019)</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># =====================================</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2015-12'</span>, <span class="st">'2018-12'</span>, <span class="st">'Tight'</span>, <span class="st">'Fed Hiking + QT (0.25% → 2.50%)'</span>),</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2019-01'</span>, <span class="st">'2019-07'</span>, <span class="st">'Neutral'</span>, <span class="st">'Pause, Economic Slowdown'</span>),</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2019-08'</span>, <span class="st">'2019-12'</span>, <span class="st">'High'</span>, <span class="st">'Insurance Cuts + Repo Crisis Response'</span>),</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># =====================================</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># COVID Era (2020-2021)</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># =====================================</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2020-01'</span>, <span class="st">'2020-02'</span>, <span class="st">'Neutral'</span>, <span class="st">'Pre-COVID'</span>),</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2020-03'</span>, <span class="st">'2021-10'</span>, <span class="st">'High'</span>, <span class="st">'COVID QE: Unlimited purchases, ZIRP'</span>),</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2021-11'</span>, <span class="st">'2022-02'</span>, <span class="st">'High'</span>, <span class="st">'Taper Announcement but still easy'</span>),</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># =====================================</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Modern Tightening (2022-2025)</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># =====================================</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2022-03'</span>, <span class="st">'2023-06'</span>, <span class="st">'Tight'</span>, <span class="st">'Aggressive Hikes (0% → 5.25%)'</span>),</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2023-07'</span>, <span class="st">'2024-08'</span>, <span class="st">'Tight'</span>, <span class="st">'Higher for Longer, QT Active'</span>),</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2024-09'</span>, <span class="st">'2025-01'</span>, <span class="st">'Neutral'</span>, <span class="st">'Easing Cycle Begins'</span>),</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to DataFrame</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>    regime_df <span class="op">=</span> pd.DataFrame(known_regimes, columns<span class="op">=</span>[<span class="st">'start'</span>, <span class="st">'end'</span>, <span class="st">'regime'</span>, <span class="st">'description'</span>])</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>    regime_df[<span class="st">'start'</span>] <span class="op">=</span> pd.to_datetime(regime_df[<span class="st">'start'</span>])</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    regime_df[<span class="st">'end'</span>] <span class="op">=</span> pd.to_datetime(regime_df[<span class="st">'end'</span>])</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> regime_df</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_hmm_against_known_regimes(regimes_df, known_regimes_df):</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="co">    Compare HMM-detected regimes to known Fed policy periods</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"REGIME VALIDATION: HMM vs Known Fed Policy"</span>)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expand known regimes to monthly observations</span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>    known_monthly <span class="op">=</span> []</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> known_regimes_df.iterrows():</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>        date_range <span class="op">=</span> pd.date_range(row[<span class="st">'start'</span>], row[<span class="st">'end'</span>], freq<span class="op">=</span><span class="st">'M'</span>)</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> date <span class="kw">in</span> date_range:</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>            known_monthly.append({</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>                <span class="st">'date'</span>: date,</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>                <span class="st">'known_regime'</span>: row[<span class="st">'regime'</span>],</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>                <span class="st">'period_description'</span>: row[<span class="st">'description'</span>]</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>    known_df <span class="op">=</span> pd.DataFrame(known_monthly).set_index(<span class="st">'date'</span>)</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with HMM results</span></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>    comparison <span class="op">=</span> regimes_df.join(known_df, how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>    comparison <span class="op">=</span> comparison.dropna(subset<span class="op">=</span>[<span class="st">'known_regime'</span>, <span class="st">'state_label'</span>])</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Overlap period: </span><span class="sc">{</span>comparison<span class="sc">.</span>index[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>comparison<span class="sc">.</span>index[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Total months: </span><span class="sc">{</span><span class="bu">len</span>(comparison)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =====================================</span></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Confusion Matrix</span></span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =====================================</span></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Confusion Matrix: HMM vs Known Regimes"</span>)</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix, accuracy_score, classification_report</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create confusion matrix</span></span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(comparison[<span class="st">'known_regime'</span>], comparison[<span class="st">'state_label'</span>], </span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>                         labels<span class="op">=</span>[<span class="st">'Tight'</span>, <span class="st">'Neutral'</span>, <span class="st">'High'</span>])</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>    cm_df <span class="op">=</span> pd.DataFrame(cm, </span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>                        index<span class="op">=</span>[<span class="st">'Known_Tight'</span>, <span class="st">'Known_Neutral'</span>, <span class="st">'Known_High'</span>],</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>                        columns<span class="op">=</span>[<span class="st">'HMM_Tight'</span>, <span class="st">'HMM_Neutral'</span>, <span class="st">'HMM_High'</span>])</span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, cm_df)</span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate percentages</span></span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>    cm_pct <span class="op">=</span> cm_df.div(cm_df.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>), axis<span class="op">=</span><span class="dv">0</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Percentages (row-wise):"</span>)</span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(cm_pct.<span class="bu">round</span>(<span class="dv">1</span>))</span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Overall accuracy</span></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> accuracy_score(comparison[<span class="st">'known_regime'</span>], comparison[<span class="st">'state_label'</span>])</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📈 Overall Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =====================================</span></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Regime-by-Regime Analysis</span></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =====================================</span></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Detailed Regime Concordance"</span>)</span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> known_regime <span class="kw">in</span> [<span class="st">'Tight'</span>, <span class="st">'Neutral'</span>, <span class="st">'High'</span>]:</span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> comparison[<span class="st">'known_regime'</span>] <span class="op">==</span> known_regime</span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> comparison[mask]</span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>known_regime<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> REGIME (</span><span class="sc">{</span>mask<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> months):"</span>)</span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># How HMM classified these periods</span></span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>        hmm_dist <span class="op">=</span> subset[<span class="st">'state_label'</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> hmm_regime, pct <span class="kw">in</span> hmm_dist.sort_index().items():</span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a>            status <span class="op">=</span> <span class="st">"✅"</span> <span class="cf">if</span> hmm_regime <span class="op">==</span> known_regime <span class="cf">else</span> <span class="st">"⚠️"</span></span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>status<span class="sc">}</span><span class="ss"> Classified as </span><span class="sc">{</span>hmm_regime<span class="sc">:8s}</span><span class="ss">: </span><span class="sc">{</span>pct<span class="sc">:5.1f}</span><span class="ss">%"</span>)</span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =====================================</span></span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Key Historical Periods Check</span></span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =====================================</span></span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Key Historical Periods Validation"</span>)</span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a>    key_periods <span class="op">=</span> [</span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2008-09'</span>, <span class="st">'2009-12'</span>, <span class="st">'High'</span>, <span class="st">'QE1 (Financial Crisis)'</span>),</span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2010-11'</span>, <span class="st">'2011-06'</span>, <span class="st">'High'</span>, <span class="st">'QE2'</span>),</span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2012-09'</span>, <span class="st">'2014-10'</span>, <span class="st">'High'</span>, <span class="st">'QE3'</span>),</span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2015-12'</span>, <span class="st">'2018-12'</span>, <span class="st">'Tight'</span>, <span class="st">'Fed Hiking + QT'</span>),</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2020-03'</span>, <span class="st">'2021-06'</span>, <span class="st">'High'</span>, <span class="st">'COVID QE (Unlimited)'</span>),</span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'2022-03'</span>, <span class="st">'2023-12'</span>, <span class="st">'Tight'</span>, <span class="st">'Aggressive Rate Hikes'</span>),</span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> start, end, expected, description <span class="kw">in</span> key_periods:</span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a>            mask <span class="op">=</span> (comparison.index <span class="op">&gt;=</span> start) <span class="op">&amp;</span> (comparison.index <span class="op">&lt;=</span> end)</span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a>            subset <span class="op">=</span> comparison[mask]</span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(subset) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Modal HMM regime</span></span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a>            hmm_mode <span class="op">=</span> subset[<span class="st">'state_label'</span>].mode()[<span class="dv">0</span>]</span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a>            hmm_pct <span class="op">=</span> (subset[<span class="st">'state_label'</span>] <span class="op">==</span> hmm_mode).<span class="bu">sum</span>() <span class="op">/</span> <span class="bu">len</span>(subset) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if matches expectation</span></span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a>            match <span class="op">=</span> <span class="st">"✅"</span> <span class="cf">if</span> hmm_mode <span class="op">==</span> expected <span class="cf">else</span> <span class="st">"❌"</span></span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>match<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>description<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   Period: </span><span class="sc">{</span>start<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>end<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   Expected: </span><span class="sc">{</span>expected<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   HMM Mode: </span><span class="sc">{</span>hmm_mode<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>hmm_pct<span class="sc">:.0f}</span><span class="ss">% of period)"</span>)</span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Show distribution</span></span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a>            dist <span class="op">=</span> subset[<span class="st">'state_label'</span>].value_counts()</span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   Distribution: "</span>, end<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> regime, count <span class="kw">in</span> dist.items():</span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>regime<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>count<span class="sc">}</span><span class="ss">, "</span>, end<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>()</span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb28-185"><a href="#cb28-185" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">⚠️  </span><span class="sc">{</span>description<span class="sc">}</span><span class="ss">: Data not available"</span>)</span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =====================================</span></span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mismatches Analysis</span></span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =====================================</span></span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Significant Mismatches (Known ≠ HMM)"</span>)</span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a>    mismatches <span class="op">=</span> comparison[comparison[<span class="st">'known_regime'</span>] <span class="op">!=</span> comparison[<span class="st">'state_label'</span>]]</span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(mismatches) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find consecutive mismatch periods</span></span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a>        mismatch_periods <span class="op">=</span> []</span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a>        current_start <span class="op">=</span> <span class="va">None</span></span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, (date, row) <span class="kw">in</span> <span class="bu">enumerate</span>(mismatches.iterrows()):</span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> current_start <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a>                current_start <span class="op">=</span> date</span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a>                current_known <span class="op">=</span> row[<span class="st">'known_regime'</span>]</span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a>                current_hmm <span class="op">=</span> row[<span class="st">'state_label'</span>]</span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if next row continues the mismatch pattern</span></span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a>            is_last <span class="op">=</span> i <span class="op">==</span> <span class="bu">len</span>(mismatches) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> is_last <span class="kw">or</span> (<span class="kw">not</span> is_last <span class="kw">and</span> mismatches.index[i<span class="op">+</span><span class="dv">1</span>] <span class="op">!=</span> date <span class="op">+</span> pd.DateOffset(months<span class="op">=</span><span class="dv">1</span>)):</span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a>                mismatch_periods.append({</span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'start'</span>: current_start,</span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'end'</span>: date,</span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'known'</span>: current_known,</span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'hmm'</span>: current_hmm,</span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'months'</span>: (date.year <span class="op">-</span> current_start.year) <span class="op">*</span> <span class="dv">12</span> <span class="op">+</span> date.month <span class="op">-</span> current_start.month <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a>                current_start <span class="op">=</span> <span class="va">None</span></span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Show significant mismatches (&gt;= 3 months)</span></span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a>        significant <span class="op">=</span> [p <span class="cf">for</span> p <span class="kw">in</span> mismatch_periods <span class="cf">if</span> p[<span class="st">'months'</span>] <span class="op">&gt;=</span> <span class="dv">3</span>]</span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> significant:</span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Found </span><span class="sc">{</span><span class="bu">len</span>(significant)<span class="sc">}</span><span class="ss"> significant mismatch periods (≥3 months):</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p <span class="kw">in</span> significant:</span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>p[<span class="st">'start'</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>p[<span class="st">'end'</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>p[<span class="st">'months'</span>]<span class="sc">}</span><span class="ss"> months)"</span>)</span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"      Known: </span><span class="sc">{</span>p[<span class="st">'known'</span>]<span class="sc">:8s}</span><span class="ss"> | HMM: </span><span class="sc">{</span>p[<span class="st">'hmm'</span>]<span class="sc">:8s}</span><span class="ss">"</span>)</span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Get description for this period</span></span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a>                desc_mask <span class="op">=</span> (known_regimes_df[<span class="st">'start'</span>] <span class="op">&lt;=</span> p[<span class="st">'start'</span>]) <span class="op">&amp;</span> (known_regimes_df[<span class="st">'end'</span>] <span class="op">&gt;=</span> p[<span class="st">'end'</span>])</span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> desc_mask.<span class="bu">any</span>():</span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a>                    desc <span class="op">=</span> known_regimes_df[desc_mask][<span class="st">'description'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"      Context: </span><span class="sc">{</span>desc<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>()</span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✅ No significant consecutive mismatches (all discrepancies &lt; 3 months)"</span>)</span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">🎉 Perfect match! HMM exactly matches known regimes."</span>)</span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =====================================</span></span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summary Statistics</span></span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =====================================</span></span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SUMMARY STATISTICS"</span>)</span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Agreement Rates by Regime:"</span>)</span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Tight'</span>, <span class="st">'Neutral'</span>, <span class="st">'High'</span>]:</span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> comparison[<span class="st">'known_regime'</span>] <span class="op">==</span> regime</span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a>            agreement <span class="op">=</span> (comparison[mask][<span class="st">'state_label'</span>] <span class="op">==</span> regime).<span class="bu">sum</span>() <span class="op">/</span> mask.<span class="bu">sum</span>() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>regime<span class="sc">:8s}</span><span class="ss">: </span><span class="sc">{</span>agreement<span class="sc">:5.1f}</span><span class="ss">% correct"</span>)</span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Overall Performance:"</span>)</span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Total Accuracy:        </span><span class="sc">{</span>accuracy<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Mismatch Rate:         </span><span class="sc">{</span>(<span class="dv">1</span><span class="op">-</span>accuracy)<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Consecutive Mismatches: </span><span class="sc">{</span><span class="bu">len</span>([p <span class="cf">for</span> p <span class="kw">in</span> mismatch_periods <span class="cf">if</span> p[<span class="st">'months'</span>] <span class="op">&gt;=</span> <span class="dv">3</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Interpretation</span></span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"INTERPRETATION"</span>)</span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> accuracy <span class="op">&gt;=</span> <span class="fl">0.80</span>:</span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✅ EXCELLENT: HMM successfully captures Fed policy regimes"</span>)</span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"   The model shows strong alignment with known monetary policy history."</span>)</span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> accuracy <span class="op">&gt;=</span> <span class="fl">0.65</span>:</span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✔️  GOOD: HMM generally aligns with Fed policy regimes"</span>)</span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"   Some discrepancies exist but the model captures major policy shifts."</span>)</span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> accuracy <span class="op">&gt;=</span> <span class="fl">0.50</span>:</span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">⚠️  MODERATE: HMM shows partial alignment with Fed policy"</span>)</span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"   Consider adjusting liquidity index composition or HMM parameters."</span>)</span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">❌ POOR: HMM does not align well with Fed policy regimes"</span>)</span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"   Major revisions needed to liquidity index or regime detection."</span>)</span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> comparison, cm_df, accuracy</span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a><span class="co"># Run validation</span></span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a>known_regimes_df <span class="op">=</span> map_to_known_liquidity_regimes()</span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a>comparison_df, confusion_matrix, accuracy <span class="op">=</span> validate_hmm_against_known_regimes(</span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a>    regimes_df, </span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a>    known_regimes_df</span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
REGIME VALIDATION: HMM vs Known Fed Policy
======================================================================

📊 Overlap period: 2003-12 to 2024-12
   Total months: 166

======================================================================
Confusion Matrix: HMM vs Known Regimes
======================================================================

                HMM_Tight  HMM_Neutral  HMM_High
Known_Tight           44           11         9
Known_Neutral         21           12        13
Known_High             2           28        26

Percentages (row-wise):
               HMM_Tight  HMM_Neutral  HMM_High
Known_Tight         68.8         17.2      14.1
Known_Neutral       45.7         26.1      28.3
Known_High           3.6         50.0      46.4

📈 Overall Accuracy: 49.4%

======================================================================
Detailed Regime Concordance
======================================================================

TIGHT REGIME (64 months):
   ⚠️ Classified as High    :  14.1%
   ⚠️ Classified as Neutral :  17.2%
   ✅ Classified as Tight   :  68.8%

NEUTRAL REGIME (46 months):
   ⚠️ Classified as High    :  28.3%
   ✅ Classified as Neutral :  26.1%
   ⚠️ Classified as Tight   :  45.7%

HIGH REGIME (56 months):
   ✅ Classified as High    :  46.4%
   ⚠️ Classified as Neutral :  50.0%
   ⚠️ Classified as Tight   :   3.6%

======================================================================
Key Historical Periods Validation
======================================================================

✅ QE1 (Financial Crisis)
   Period: 2008-09 to 2009-12
   Expected: High
   HMM Mode: High (50% of period)
   Distribution: Neutral=5, High=5, 

✅ QE2
   Period: 2010-11 to 2011-06
   Expected: High
   HMM Mode: High (50% of period)
   Distribution: Neutral=3, High=3, 

✅ QE3
   Period: 2012-09 to 2014-10
   Expected: High
   HMM Mode: High (50% of period)
   Distribution: High=9, Neutral=9, 

✅ Fed Hiking + QT
   Period: 2015-12 to 2018-12
   Expected: Tight
   HMM Mode: Tight (58% of period)
   Distribution: Tight=15, Neutral=6, High=5, 

✅ COVID QE (Unlimited)
   Period: 2020-03 to 2021-06
   Expected: High
   HMM Mode: High (50% of period)
   Distribution: High=5, Neutral=5, 

✅ Aggressive Rate Hikes
   Period: 2022-03 to 2023-12
   Expected: Tight
   HMM Mode: Tight (53% of period)
   Distribution: Tight=8, Neutral=4, High=3, 

======================================================================
Significant Mismatches (Known ≠ HMM)
======================================================================

Found 1 significant mismatch periods (≥3 months):

   2007-12 to 2008-02 (3 months)
      Known: Neutral  | HMM: Tight   
      Context: Initial Crisis Response, Rate Cuts Begin


======================================================================
SUMMARY STATISTICS
======================================================================

📊 Agreement Rates by Regime:
   Tight   :  68.8% correct
   Neutral :  26.1% correct
   High    :  46.4% correct

📊 Overall Performance:
   Total Accuracy:        49.4%
   Mismatch Rate:         50.6%
   Consecutive Mismatches: 1

======================================================================
INTERPRETATION
======================================================================

❌ POOR: HMM does not align well with Fed policy regimes
   Major revisions needed to liquidity index or regime detection.</code></pre>
</div>
</div>
<div id="a3a608ae-11c2-4171-aba8-0262d6d78d3e" class="cell" data-execution_count="116">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_advanced_regime_classification_system(df, L_series):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">    State-of-the-art regime classification with proper index alignment</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.ensemble <span class="im">import</span> IsolationForest, RandomForestClassifier</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit, cross_val_score</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, confusion_matrix, roc_auc_score</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> shap</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"ADVANCED REGIME CLASSIFICATION SYSTEM"</span>)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 0: DATA ALIGNMENT</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 0: DATA ALIGNMENT"</span>)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find common index</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    common_idx <span class="op">=</span> df.index.intersection(L_series.index)</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(common_idx) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No overlapping dates between df and L_series!"</span>)</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Data Coverage:"</span>)</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   df range:       </span><span class="sc">{</span>df<span class="sc">.</span>index[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>df<span class="sc">.</span>index[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> obs)"</span>)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   L_series range: </span><span class="sc">{</span>L_series<span class="sc">.</span>index[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>L_series<span class="sc">.</span>index[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(L_series)<span class="sc">}</span><span class="ss"> obs)"</span>)</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Overlap range:  </span><span class="sc">{</span>common_idx[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>common_idx[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(common_idx)<span class="sc">}</span><span class="ss"> obs)"</span>)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use only overlapping data</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    df_aligned <span class="op">=</span> df.loc[common_idx].copy()</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    L_aligned <span class="op">=</span> L_series.loc[common_idx].copy()</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add L to dataframe</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>    df_aligned[<span class="st">'L'</span>] <span class="op">=</span> L_aligned</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for required columns</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    required_cols <span class="op">=</span> [<span class="st">'mkt_excess'</span>]</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    missing_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> required_cols <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> df_aligned.columns]</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> missing_cols:</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Missing required columns: </span><span class="sc">{</span>missing_cols<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Data aligned: </span><span class="sc">{</span><span class="bu">len</span>(df_aligned)<span class="sc">}</span><span class="ss"> observations"</span>)</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 1: Crisis Detection (Isolation Forest)</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 1: CRISIS DETECTION"</span>)</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create crisis features</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>    df_crisis <span class="op">=</span> df_aligned.copy()</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Volatility features</span></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'ret_vol_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).std()</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'ret_vol_12m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">6</span>).std()</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'L_vol_3m'</span>] <span class="op">=</span> df_crisis[<span class="st">'L'</span>].rolling(<span class="dv">3</span>, min_periods<span class="op">=</span><span class="dv">2</span>).std()</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'L_vol_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'L'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).std()</span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return features</span></span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'abs_ret'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].<span class="bu">abs</span>()</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'cum_ret_3m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">3</span>, min_periods<span class="op">=</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'cum_ret_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).<span class="bu">sum</span>()</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drawdown</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>    cumret <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df_crisis[<span class="st">'mkt_excess'</span>]<span class="op">/</span><span class="dv">100</span>).cumprod()</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>    running_max <span class="op">=</span> cumret.expanding().<span class="bu">max</span>()</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'drawdown'</span>] <span class="op">=</span> (cumret <span class="op">/</span> running_max <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'max_dd_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'drawdown'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).<span class="bu">min</span>()</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VIX if available</span></span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>    crisis_features <span class="op">=</span> [<span class="st">'ret_vol_6m'</span>, <span class="st">'ret_vol_12m'</span>, <span class="st">'L_vol_3m'</span>, <span class="st">'L_vol_6m'</span>, </span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'abs_ret'</span>, <span class="st">'cum_ret_3m'</span>, <span class="st">'cum_ret_6m'</span>, <span class="st">'max_dd_6m'</span>]</span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'VIX'</span> <span class="kw">in</span> df_crisis.columns:</span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'VIX_level'</span>] <span class="op">=</span> df_crisis[<span class="st">'VIX'</span>]</span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'VIX_zscore'</span>] <span class="op">=</span> (df_crisis[<span class="st">'VIX'</span>] <span class="op">-</span> df_crisis[<span class="st">'VIX'</span>].rolling(<span class="dv">60</span>, min_periods<span class="op">=</span><span class="dv">30</span>).mean()) <span class="op">/</span> <span class="op">\</span></span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>                                   df_crisis[<span class="st">'VIX'</span>].rolling(<span class="dv">60</span>, min_periods<span class="op">=</span><span class="dv">30</span>).std()</span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>        crisis_features.extend([<span class="st">'VIX_level'</span>, <span class="st">'VIX_zscore'</span>])</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check data availability</span></span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Crisis Features:"</span>)</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feat <span class="kw">in</span> crisis_features:</span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> feat <span class="kw">in</span> df_crisis.columns:</span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>            n_valid <span class="op">=</span> df_crisis[feat].notna().<span class="bu">sum</span>()</span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>feat<span class="sc">:20s}</span><span class="ss">: </span><span class="sc">{</span>n_valid<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(df_crisis)<span class="sc">}</span><span class="ss"> valid"</span>)</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract crisis features and drop NaN</span></span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>    crisis_data <span class="op">=</span> df_crisis[crisis_features].copy()</span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill forward initial NaN from rolling windows (up to 12 months)</span></span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>    crisis_data <span class="op">=</span> crisis_data.fillna(method<span class="op">=</span><span class="st">'bfill'</span>, limit<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>    crisis_data <span class="op">=</span> crisis_data.dropna()</span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Crisis detection dataset: </span><span class="sc">{</span><span class="bu">len</span>(crisis_data)<span class="sc">}</span><span class="ss"> observations"</span>)</span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(crisis_data) <span class="op">&lt;</span> <span class="dv">20</span>:</span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">⚠️  WARNING: Not enough data for crisis detection (</span><span class="sc">{</span><span class="bu">len</span>(crisis_data)<span class="sc">}</span><span class="ss"> obs)"</span>)</span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Skipping crisis detection, will use all data for regime classification"</span>)</span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'is_crisis'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>        df_noncrisis <span class="op">=</span> df_crisis.copy()</span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit Isolation Forest</span></span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a>        iso_forest <span class="op">=</span> IsolationForest(</span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a>            contamination<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a>            max_samples<span class="op">=</span><span class="st">'auto'</span></span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a>        outlier_labels <span class="op">=</span> iso_forest.fit_predict(crisis_data.values)</span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Crisis = outlier + negative return</span></span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a>        is_crisis_candidate <span class="op">=</span> (outlier_labels <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a>        is_negative_return <span class="op">=</span> (df_crisis.loc[crisis_data.index, <span class="st">'mkt_excess'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="dv">2</span>)</span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'is_crisis'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a>        df_crisis.loc[crisis_data.index, <span class="st">'is_crisis'</span>] <span class="op">=</span> is_crisis_candidate <span class="op">&amp;</span> is_negative_return</span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a>        n_crisis <span class="op">=</span> df_crisis[<span class="st">'is_crisis'</span>].<span class="bu">sum</span>()</span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a>        crisis_pct <span class="op">=</span> n_crisis <span class="op">/</span> <span class="bu">len</span>(df_crisis) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Crisis Detection Complete"</span>)</span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Crisis periods:     </span><span class="sc">{</span>n_crisis<span class="sc">}</span><span class="ss"> months (</span><span class="sc">{</span>crisis_pct<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Non-crisis periods: </span><span class="sc">{</span><span class="bu">len</span>(df_crisis) <span class="op">-</span> n_crisis<span class="sc">}</span><span class="ss"> months (</span><span class="sc">{</span><span class="dv">100</span><span class="op">-</span>crisis_pct<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Show crisis periods</span></span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n_crisis <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a>            crisis_periods <span class="op">=</span> df_crisis[df_crisis[<span class="st">'is_crisis'</span>]].index</span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📅 Detected Crisis Months:"</span>)</span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, date <span class="kw">in</span> <span class="bu">enumerate</span>(crisis_periods[:<span class="dv">10</span>], <span class="dv">1</span>):</span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a>                ret <span class="op">=</span> df_crisis.loc[date, <span class="st">'mkt_excess'</span>]</span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>i<span class="sc">:2d}</span><span class="ss">. </span><span class="sc">{</span>date<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss">: Return = </span><span class="sc">{</span>ret<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(crisis_periods) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"   ... and </span><span class="sc">{</span><span class="bu">len</span>(crisis_periods) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> more"</span>)</span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Filter to non-crisis</span></span>
<span id="cb30-151"><a href="#cb30-151" aria-hidden="true" tabindex="-1"></a>        df_noncrisis <span class="op">=</span> df_crisis[<span class="op">~</span>df_crisis[<span class="st">'is_crisis'</span>]].copy()</span>
<span id="cb30-152"><a href="#cb30-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-153"><a href="#cb30-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-154"><a href="#cb30-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 2: Regime Classification Setup</span></span>
<span id="cb30-155"><a href="#cb30-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-156"><a href="#cb30-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-157"><a href="#cb30-157" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-158"><a href="#cb30-158" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 2: REGIME CLASSIFICATION (NON-CRISIS PERIODS)"</span>)</span>
<span id="cb30-159"><a href="#cb30-159" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-160"><a href="#cb30-160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-161"><a href="#cb30-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create regime labels based on liquidity quantiles</span></span>
<span id="cb30-162"><a href="#cb30-162" aria-hidden="true" tabindex="-1"></a>    L_noncrisis <span class="op">=</span> df_noncrisis[<span class="st">'L'</span>]</span>
<span id="cb30-163"><a href="#cb30-163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-164"><a href="#cb30-164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(L_noncrisis) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb30-165"><a href="#cb30-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Not enough non-crisis data: </span><span class="sc">{</span><span class="bu">len</span>(L_noncrisis)<span class="sc">}</span><span class="ss"> observations"</span>)</span>
<span id="cb30-166"><a href="#cb30-166" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-167"><a href="#cb30-167" aria-hidden="true" tabindex="-1"></a>    q33 <span class="op">=</span> L_noncrisis.quantile(<span class="fl">0.33</span>)</span>
<span id="cb30-168"><a href="#cb30-168" aria-hidden="true" tabindex="-1"></a>    q67 <span class="op">=</span> L_noncrisis.quantile(<span class="fl">0.67</span>)</span>
<span id="cb30-169"><a href="#cb30-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-170"><a href="#cb30-170" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Liquidity Quantiles:"</span>)</span>
<span id="cb30-171"><a href="#cb30-171" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   33rd percentile (q33): </span><span class="sc">{</span>q33<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb30-172"><a href="#cb30-172" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   67th percentile (q67): </span><span class="sc">{</span>q67<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb30-173"><a href="#cb30-173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-174"><a href="#cb30-174" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> assign_regime(L_val):</span>
<span id="cb30-175"><a href="#cb30-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> L_val <span class="op">&lt;</span> q33:</span>
<span id="cb30-176"><a href="#cb30-176" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span>  <span class="co"># Tight</span></span>
<span id="cb30-177"><a href="#cb30-177" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> L_val <span class="op">&lt;</span> q67:</span>
<span id="cb30-178"><a href="#cb30-178" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span>  <span class="co"># Neutral</span></span>
<span id="cb30-179"><a href="#cb30-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb30-180"><a href="#cb30-180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">2</span>  <span class="co"># High</span></span>
<span id="cb30-181"><a href="#cb30-181" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-182"><a href="#cb30-182" aria-hidden="true" tabindex="-1"></a>    df_noncrisis[<span class="st">'regime'</span>] <span class="op">=</span> L_noncrisis.<span class="bu">apply</span>(assign_regime)</span>
<span id="cb30-183"><a href="#cb30-183" aria-hidden="true" tabindex="-1"></a>    df_noncrisis[<span class="st">'regime_label'</span>] <span class="op">=</span> df_noncrisis[<span class="st">'regime'</span>].<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'Tight'</span>, <span class="dv">1</span>: <span class="st">'Neutral'</span>, <span class="dv">2</span>: <span class="st">'High'</span>})</span>
<span id="cb30-184"><a href="#cb30-184" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-185"><a href="#cb30-185" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Non-Crisis Regime Distribution:"</span>)</span>
<span id="cb30-186"><a href="#cb30-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime, label <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'Tight'</span>), (<span class="dv">1</span>, <span class="st">'Neutral'</span>), (<span class="dv">2</span>, <span class="st">'High'</span>)]:</span>
<span id="cb30-187"><a href="#cb30-187" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> df_noncrisis[<span class="st">'regime'</span>] <span class="op">==</span> regime</span>
<span id="cb30-188"><a href="#cb30-188" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> mask.<span class="bu">sum</span>()</span>
<span id="cb30-189"><a href="#cb30-189" aria-hidden="true" tabindex="-1"></a>        pct <span class="op">=</span> count <span class="op">/</span> <span class="bu">len</span>(df_noncrisis) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb30-190"><a href="#cb30-190" aria-hidden="true" tabindex="-1"></a>        mean_L <span class="op">=</span> df_noncrisis[mask][<span class="st">'L'</span>].mean()</span>
<span id="cb30-191"><a href="#cb30-191" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>label<span class="sc">:8s}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">:4d}</span><span class="ss"> months (</span><span class="sc">{</span>pct<span class="sc">:5.1f}</span><span class="ss">%), Mean L = </span><span class="sc">{</span>mean_L<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb30-192"><a href="#cb30-192" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-193"><a href="#cb30-193" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-194"><a href="#cb30-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 3: Feature Engineering</span></span>
<span id="cb30-195"><a href="#cb30-195" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-196"><a href="#cb30-196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-197"><a href="#cb30-197" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-198"><a href="#cb30-198" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 3: FEATURE ENGINEERING"</span>)</span>
<span id="cb30-199"><a href="#cb30-199" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-200"><a href="#cb30-200" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-201"><a href="#cb30-201" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build feature set</span></span>
<span id="cb30-202"><a href="#cb30-202" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> []</span>
<span id="cb30-203"><a href="#cb30-203" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-204"><a href="#cb30-204" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Core liquidity components</span></span>
<span id="cb30-205"><a href="#cb30-205" aria-hidden="true" tabindex="-1"></a>    liq_features <span class="op">=</span> [<span class="st">'dlog_M2'</span>, <span class="st">'dlog_FED_BS'</span>, <span class="st">'EM'</span>, <span class="st">'EB'</span>, <span class="st">'EL_3y'</span>]</span>
<span id="cb30-206"><a href="#cb30-206" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Net_Liq'</span> <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb30-207"><a href="#cb30-207" aria-hidden="true" tabindex="-1"></a>        liq_features.append(<span class="st">'Net_Liq'</span>)</span>
<span id="cb30-208"><a href="#cb30-208" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-209"><a href="#cb30-209" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feat <span class="kw">in</span> liq_features:</span>
<span id="cb30-210"><a href="#cb30-210" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> feat <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb30-211"><a href="#cb30-211" aria-hidden="true" tabindex="-1"></a>            feature_cols.append(feat)</span>
<span id="cb30-212"><a href="#cb30-212" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-213"><a href="#cb30-213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rates and spreads</span></span>
<span id="cb30-214"><a href="#cb30-214" aria-hidden="true" tabindex="-1"></a>    rate_features <span class="op">=</span> [<span class="st">'Term_Spread'</span>, <span class="st">'Credit_Spread'</span>]</span>
<span id="cb30-215"><a href="#cb30-215" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Real_Rate'</span> <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb30-216"><a href="#cb30-216" aria-hidden="true" tabindex="-1"></a>        rate_features.append(<span class="st">'Real_Rate'</span>)</span>
<span id="cb30-217"><a href="#cb30-217" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-218"><a href="#cb30-218" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feat <span class="kw">in</span> rate_features:</span>
<span id="cb30-219"><a href="#cb30-219" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> feat <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb30-220"><a href="#cb30-220" aria-hidden="true" tabindex="-1"></a>            feature_cols.append(feat)</span>
<span id="cb30-221"><a href="#cb30-221" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-222"><a href="#cb30-222" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Market indicators</span></span>
<span id="cb30-223"><a href="#cb30-223" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'VIX'</span> <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb30-224"><a href="#cb30-224" aria-hidden="true" tabindex="-1"></a>        feature_cols.append(<span class="st">'VIX'</span>)</span>
<span id="cb30-225"><a href="#cb30-225" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-226"><a href="#cb30-226" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Growth rates</span></span>
<span id="cb30-227"><a href="#cb30-227" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'M2_growth'</span> <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb30-228"><a href="#cb30-228" aria-hidden="true" tabindex="-1"></a>        feature_cols.append(<span class="st">'M2_growth'</span>)</span>
<span id="cb30-229"><a href="#cb30-229" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'FED_BS_growth'</span> <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb30-230"><a href="#cb30-230" aria-hidden="true" tabindex="-1"></a>        feature_cols.append(<span class="st">'FED_BS_growth'</span>)</span>
<span id="cb30-231"><a href="#cb30-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-232"><a href="#cb30-232" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Technical features on L</span></span>
<span id="cb30-233"><a href="#cb30-233" aria-hidden="true" tabindex="-1"></a>    df_noncrisis[<span class="st">'L_ma_3'</span>] <span class="op">=</span> df_noncrisis[<span class="st">'L'</span>].rolling(<span class="dv">3</span>, min_periods<span class="op">=</span><span class="dv">1</span>).mean()</span>
<span id="cb30-234"><a href="#cb30-234" aria-hidden="true" tabindex="-1"></a>    df_noncrisis[<span class="st">'L_ma_6'</span>] <span class="op">=</span> df_noncrisis[<span class="st">'L'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).mean()</span>
<span id="cb30-235"><a href="#cb30-235" aria-hidden="true" tabindex="-1"></a>    df_noncrisis[<span class="st">'L_momentum'</span>] <span class="op">=</span> df_noncrisis[<span class="st">'L'</span>].diff(<span class="dv">3</span>)</span>
<span id="cb30-236"><a href="#cb30-236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-237"><a href="#cb30-237" aria-hidden="true" tabindex="-1"></a>    feature_cols.extend([<span class="st">'L_ma_3'</span>, <span class="st">'L_ma_6'</span>, <span class="st">'L_momentum'</span>])</span>
<span id="cb30-238"><a href="#cb30-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-239"><a href="#cb30-239" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Valuation if available</span></span>
<span id="cb30-240"><a href="#cb30-240" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'V_spread'</span> <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb30-241"><a href="#cb30-241" aria-hidden="true" tabindex="-1"></a>        feature_cols.append(<span class="st">'V_spread'</span>)</span>
<span id="cb30-242"><a href="#cb30-242" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-243"><a href="#cb30-243" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Selected </span><span class="sc">{</span><span class="bu">len</span>(feature_cols)<span class="sc">}</span><span class="ss"> features:"</span>)</span>
<span id="cb30-244"><a href="#cb30-244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, feat <span class="kw">in</span> <span class="bu">enumerate</span>(feature_cols, <span class="dv">1</span>):</span>
<span id="cb30-245"><a href="#cb30-245" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> feat <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb30-246"><a href="#cb30-246" aria-hidden="true" tabindex="-1"></a>            n_valid <span class="op">=</span> df_noncrisis[feat].notna().<span class="bu">sum</span>()</span>
<span id="cb30-247"><a href="#cb30-247" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>i<span class="sc">:2d}</span><span class="ss">. </span><span class="sc">{</span>feat<span class="sc">:20s}</span><span class="ss">: </span><span class="sc">{</span>n_valid<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(df_noncrisis)<span class="sc">}</span><span class="ss"> valid"</span>)</span>
<span id="cb30-248"><a href="#cb30-248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-249"><a href="#cb30-249" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare feature matrix</span></span>
<span id="cb30-250"><a href="#cb30-250" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df_noncrisis[feature_cols].copy()</span>
<span id="cb30-251"><a href="#cb30-251" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df_noncrisis[<span class="st">'regime'</span>].copy()</span>
<span id="cb30-252"><a href="#cb30-252" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-253"><a href="#cb30-253" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Forward fill initial NaN from rolling windows</span></span>
<span id="cb30-254"><a href="#cb30-254" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> X.fillna(method<span class="op">=</span><span class="st">'ffill'</span>, limit<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb30-255"><a href="#cb30-255" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-256"><a href="#cb30-256" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop remaining NaN</span></span>
<span id="cb30-257"><a href="#cb30-257" aria-hidden="true" tabindex="-1"></a>    valid_idx <span class="op">=</span> X.notna().<span class="bu">all</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">&amp;</span> y.notna()</span>
<span id="cb30-258"><a href="#cb30-258" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> X[valid_idx]</span>
<span id="cb30-259"><a href="#cb30-259" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> y[valid_idx]</span>
<span id="cb30-260"><a href="#cb30-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-261"><a href="#cb30-261" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Final ML dataset: </span><span class="sc">{</span><span class="bu">len</span>(X)<span class="sc">}</span><span class="ss"> samples × </span><span class="sc">{</span><span class="bu">len</span>(feature_cols)<span class="sc">}</span><span class="ss"> features"</span>)</span>
<span id="cb30-262"><a href="#cb30-262" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-263"><a href="#cb30-263" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(X) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb30-264"><a href="#cb30-264" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Not enough valid data for ML: </span><span class="sc">{</span><span class="bu">len</span>(X)<span class="sc">}</span><span class="ss"> samples"</span>)</span>
<span id="cb30-265"><a href="#cb30-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-266"><a href="#cb30-266" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-267"><a href="#cb30-267" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 4: Train ML Models</span></span>
<span id="cb30-268"><a href="#cb30-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-269"><a href="#cb30-269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-270"><a href="#cb30-270" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-271"><a href="#cb30-271" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 4: MODEL TRAINING"</span>)</span>
<span id="cb30-272"><a href="#cb30-272" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-273"><a href="#cb30-273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-274"><a href="#cb30-274" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time series split</span></span>
<span id="cb30-275"><a href="#cb30-275" aria-hidden="true" tabindex="-1"></a>    tscv <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span><span class="bu">min</span>(<span class="dv">5</span>, <span class="bu">len</span>(X) <span class="op">//</span> <span class="dv">20</span>))</span>
<span id="cb30-276"><a href="#cb30-276" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-277"><a href="#cb30-277" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Models</span></span>
<span id="cb30-278"><a href="#cb30-278" aria-hidden="true" tabindex="-1"></a>    models <span class="op">=</span> {</span>
<span id="cb30-279"><a href="#cb30-279" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Random Forest'</span>: RandomForestClassifier(</span>
<span id="cb30-280"><a href="#cb30-280" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb30-281"><a href="#cb30-281" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb30-282"><a href="#cb30-282" aria-hidden="true" tabindex="-1"></a>            min_samples_split<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb30-283"><a href="#cb30-283" aria-hidden="true" tabindex="-1"></a>            min_samples_leaf<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb30-284"><a href="#cb30-284" aria-hidden="true" tabindex="-1"></a>            class_weight<span class="op">=</span><span class="st">'balanced'</span>,</span>
<span id="cb30-285"><a href="#cb30-285" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb30-286"><a href="#cb30-286" aria-hidden="true" tabindex="-1"></a>            n_jobs<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb30-287"><a href="#cb30-287" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb30-288"><a href="#cb30-288" aria-hidden="true" tabindex="-1"></a>        <span class="st">'XGBoost'</span>: XGBClassifier(</span>
<span id="cb30-289"><a href="#cb30-289" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb30-290"><a href="#cb30-290" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb30-291"><a href="#cb30-291" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb30-292"><a href="#cb30-292" aria-hidden="true" tabindex="-1"></a>            subsample<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb30-293"><a href="#cb30-293" aria-hidden="true" tabindex="-1"></a>            colsample_bytree<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb30-294"><a href="#cb30-294" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb30-295"><a href="#cb30-295" aria-hidden="true" tabindex="-1"></a>            eval_metric<span class="op">=</span><span class="st">'mlogloss'</span>,</span>
<span id="cb30-296"><a href="#cb30-296" aria-hidden="true" tabindex="-1"></a>            use_label_encoder<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb30-297"><a href="#cb30-297" aria-hidden="true" tabindex="-1"></a>            n_jobs<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb30-298"><a href="#cb30-298" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb30-299"><a href="#cb30-299" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-300"><a href="#cb30-300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-301"><a href="#cb30-301" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb30-302"><a href="#cb30-302" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-303"><a href="#cb30-303" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, model <span class="kw">in</span> models.items():</span>
<span id="cb30-304"><a href="#cb30-304" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-305"><a href="#cb30-305" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Training </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-306"><a href="#cb30-306" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-307"><a href="#cb30-307" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-308"><a href="#cb30-308" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Cross-validation</span></span>
<span id="cb30-309"><a href="#cb30-309" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb30-310"><a href="#cb30-310" aria-hidden="true" tabindex="-1"></a>            cv_scores <span class="op">=</span> cross_val_score(model, X, y, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">'accuracy'</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb30-311"><a href="#cb30-311" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 CV Accuracy: </span><span class="sc">{</span>cv_scores<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss"> (±</span><span class="sc">{</span>cv_scores<span class="sc">.</span>std()<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb30-312"><a href="#cb30-312" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb30-313"><a href="#cb30-313" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">⚠️  CV failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-314"><a href="#cb30-314" aria-hidden="true" tabindex="-1"></a>            cv_scores <span class="op">=</span> np.array([])</span>
<span id="cb30-315"><a href="#cb30-315" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-316"><a href="#cb30-316" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train full model</span></span>
<span id="cb30-317"><a href="#cb30-317" aria-hidden="true" tabindex="-1"></a>        model.fit(X, y)</span>
<span id="cb30-318"><a href="#cb30-318" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-319"><a href="#cb30-319" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Predictions</span></span>
<span id="cb30-320"><a href="#cb30-320" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb30-321"><a href="#cb30-321" aria-hidden="true" tabindex="-1"></a>        y_pred_proba <span class="op">=</span> model.predict_proba(X)</span>
<span id="cb30-322"><a href="#cb30-322" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-323"><a href="#cb30-323" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Metrics</span></span>
<span id="cb30-324"><a href="#cb30-324" aria-hidden="true" tabindex="-1"></a>        accuracy <span class="op">=</span> (y_pred <span class="op">==</span> y).mean()</span>
<span id="cb30-325"><a href="#cb30-325" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-326"><a href="#cb30-326" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb30-327"><a href="#cb30-327" aria-hidden="true" tabindex="-1"></a>            roc_auc <span class="op">=</span> roc_auc_score(y, y_pred_proba, multi_class<span class="op">=</span><span class="st">'ovr'</span>, average<span class="op">=</span><span class="st">'weighted'</span>)</span>
<span id="cb30-328"><a href="#cb30-328" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb30-329"><a href="#cb30-329" aria-hidden="true" tabindex="-1"></a>            roc_auc <span class="op">=</span> np.nan</span>
<span id="cb30-330"><a href="#cb30-330" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-331"><a href="#cb30-331" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📈 Performance:"</span>)</span>
<span id="cb30-332"><a href="#cb30-332" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb30-333"><a href="#cb30-333" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.isnan(roc_auc):</span>
<span id="cb30-334"><a href="#cb30-334" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   ROC-AUC:  </span><span class="sc">{</span>roc_auc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb30-335"><a href="#cb30-335" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-336"><a href="#cb30-336" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Classification report</span></span>
<span id="cb30-337"><a href="#cb30-337" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📋 Classification Report:"</span>)</span>
<span id="cb30-338"><a href="#cb30-338" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(classification_report(y, y_pred, target_names<span class="op">=</span>[<span class="st">'Tight'</span>, <span class="st">'Neutral'</span>, <span class="st">'High'</span>], zero_division<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb30-339"><a href="#cb30-339" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-340"><a href="#cb30-340" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Confusion matrix</span></span>
<span id="cb30-341"><a href="#cb30-341" aria-hidden="true" tabindex="-1"></a>        cm <span class="op">=</span> confusion_matrix(y, y_pred)</span>
<span id="cb30-342"><a href="#cb30-342" aria-hidden="true" tabindex="-1"></a>        cm_pct <span class="op">=</span> cm.astype(<span class="st">'float'</span>) <span class="op">/</span> cm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)[:, np.newaxis] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb30-343"><a href="#cb30-343" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-344"><a href="#cb30-344" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🎯 Confusion Matrix (%):"</span>)</span>
<span id="cb30-345"><a href="#cb30-345" aria-hidden="true" tabindex="-1"></a>        cm_df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb30-346"><a href="#cb30-346" aria-hidden="true" tabindex="-1"></a>            cm_pct,</span>
<span id="cb30-347"><a href="#cb30-347" aria-hidden="true" tabindex="-1"></a>            index<span class="op">=</span>[<span class="st">'True_Tight'</span>, <span class="st">'True_Neutral'</span>, <span class="st">'True_High'</span>],</span>
<span id="cb30-348"><a href="#cb30-348" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>[<span class="st">'Pred_Tight'</span>, <span class="st">'Pred_Neutral'</span>, <span class="st">'Pred_High'</span>]</span>
<span id="cb30-349"><a href="#cb30-349" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb30-350"><a href="#cb30-350" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(cm_df.<span class="bu">round</span>(<span class="dv">1</span>))</span>
<span id="cb30-351"><a href="#cb30-351" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-352"><a href="#cb30-352" aria-hidden="true" tabindex="-1"></a>        results[name] <span class="op">=</span> {</span>
<span id="cb30-353"><a href="#cb30-353" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: model,</span>
<span id="cb30-354"><a href="#cb30-354" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cv_scores'</span>: cv_scores,</span>
<span id="cb30-355"><a href="#cb30-355" aria-hidden="true" tabindex="-1"></a>            <span class="st">'accuracy'</span>: accuracy,</span>
<span id="cb30-356"><a href="#cb30-356" aria-hidden="true" tabindex="-1"></a>            <span class="st">'roc_auc'</span>: roc_auc,</span>
<span id="cb30-357"><a href="#cb30-357" aria-hidden="true" tabindex="-1"></a>            <span class="st">'y_pred'</span>: y_pred,</span>
<span id="cb30-358"><a href="#cb30-358" aria-hidden="true" tabindex="-1"></a>            <span class="st">'y_pred_proba'</span>: y_pred_proba</span>
<span id="cb30-359"><a href="#cb30-359" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb30-360"><a href="#cb30-360" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-361"><a href="#cb30-361" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-362"><a href="#cb30-362" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 5: Feature Importance</span></span>
<span id="cb30-363"><a href="#cb30-363" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-364"><a href="#cb30-364" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-365"><a href="#cb30-365" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-366"><a href="#cb30-366" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 5: FEATURE IMPORTANCE"</span>)</span>
<span id="cb30-367"><a href="#cb30-367" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-368"><a href="#cb30-368" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-369"><a href="#cb30-369" aria-hidden="true" tabindex="-1"></a>    best_model <span class="op">=</span> results[<span class="st">'XGBoost'</span>][<span class="st">'model'</span>]</span>
<span id="cb30-370"><a href="#cb30-370" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-371"><a href="#cb30-371" aria-hidden="true" tabindex="-1"></a>    feature_importance <span class="op">=</span> pd.DataFrame({</span>
<span id="cb30-372"><a href="#cb30-372" aria-hidden="true" tabindex="-1"></a>        <span class="st">'feature'</span>: X.columns,</span>
<span id="cb30-373"><a href="#cb30-373" aria-hidden="true" tabindex="-1"></a>        <span class="st">'importance'</span>: best_model.feature_importances_</span>
<span id="cb30-374"><a href="#cb30-374" aria-hidden="true" tabindex="-1"></a>    }).sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-375"><a href="#cb30-375" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-376"><a href="#cb30-376" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Top 10 Features:"</span>)</span>
<span id="cb30-377"><a href="#cb30-377" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> feature_importance.head(<span class="dv">10</span>).iterrows():</span>
<span id="cb30-378"><a href="#cb30-378" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>row[<span class="st">'feature'</span>]<span class="sc">:20s}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'importance'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb30-379"><a href="#cb30-379" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-380"><a href="#cb30-380" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-381"><a href="#cb30-381" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 6: Final Labels</span></span>
<span id="cb30-382"><a href="#cb30-382" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb30-383"><a href="#cb30-383" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-384"><a href="#cb30-384" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-385"><a href="#cb30-385" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 6: FINAL REGIME ASSIGNMENT"</span>)</span>
<span id="cb30-386"><a href="#cb30-386" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-387"><a href="#cb30-387" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-388"><a href="#cb30-388" aria-hidden="true" tabindex="-1"></a>    df_final <span class="op">=</span> df_crisis.copy()</span>
<span id="cb30-389"><a href="#cb30-389" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">'regime'</span>] <span class="op">=</span> np.nan</span>
<span id="cb30-390"><a href="#cb30-390" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">'regime_label'</span>] <span class="op">=</span> <span class="st">'Unknown'</span></span>
<span id="cb30-391"><a href="#cb30-391" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-392"><a href="#cb30-392" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crisis</span></span>
<span id="cb30-393"><a href="#cb30-393" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'is_crisis'</span> <span class="kw">in</span> df_final.columns:</span>
<span id="cb30-394"><a href="#cb30-394" aria-hidden="true" tabindex="-1"></a>        df_final.loc[df_final[<span class="st">'is_crisis'</span>], <span class="st">'regime'</span>] <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb30-395"><a href="#cb30-395" aria-hidden="true" tabindex="-1"></a>        df_final.loc[df_final[<span class="st">'is_crisis'</span>], <span class="st">'regime_label'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb30-396"><a href="#cb30-396" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-397"><a href="#cb30-397" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ML predictions</span></span>
<span id="cb30-398"><a href="#cb30-398" aria-hidden="true" tabindex="-1"></a>    ml_idx <span class="op">=</span> X.index</span>
<span id="cb30-399"><a href="#cb30-399" aria-hidden="true" tabindex="-1"></a>    df_final.loc[ml_idx, <span class="st">'regime'</span>] <span class="op">=</span> results[<span class="st">'XGBoost'</span>][<span class="st">'y_pred'</span>]</span>
<span id="cb30-400"><a href="#cb30-400" aria-hidden="true" tabindex="-1"></a>    df_final.loc[ml_idx, <span class="st">'regime_label'</span>] <span class="op">=</span> pd.Series(</span>
<span id="cb30-401"><a href="#cb30-401" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'XGBoost'</span>][<span class="st">'y_pred'</span>],</span>
<span id="cb30-402"><a href="#cb30-402" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>ml_idx</span>
<span id="cb30-403"><a href="#cb30-403" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'Tight'</span>, <span class="dv">1</span>: <span class="st">'Neutral'</span>, <span class="dv">2</span>: <span class="st">'High'</span>})</span>
<span id="cb30-404"><a href="#cb30-404" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-405"><a href="#cb30-405" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Final Distribution:"</span>)</span>
<span id="cb30-406"><a href="#cb30-406" aria-hidden="true" tabindex="-1"></a>    dist <span class="op">=</span> df_final[<span class="st">'regime_label'</span>].value_counts()</span>
<span id="cb30-407"><a href="#cb30-407" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime, count <span class="kw">in</span> dist.items():</span>
<span id="cb30-408"><a href="#cb30-408" aria-hidden="true" tabindex="-1"></a>        pct <span class="op">=</span> count <span class="op">/</span> <span class="bu">len</span>(df_final) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb30-409"><a href="#cb30-409" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>regime<span class="sc">:8s}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">:4d}</span><span class="ss"> (</span><span class="sc">{</span>pct<span class="sc">:5.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb30-410"><a href="#cb30-410" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-411"><a href="#cb30-411" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-412"><a href="#cb30-412" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ COMPLETE"</span>)</span>
<span id="cb30-413"><a href="#cb30-413" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-414"><a href="#cb30-414" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-415"><a href="#cb30-415" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_final, results, feature_importance</span>
<span id="cb30-416"><a href="#cb30-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-417"><a href="#cb30-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-418"><a href="#cb30-418" aria-hidden="true" tabindex="-1"></a><span class="co"># Run with proper inputs</span></span>
<span id="cb30-419"><a href="#cb30-419" aria-hidden="true" tabindex="-1"></a>df_regimes_advanced, ml_results, feature_importance <span class="op">=</span> build_advanced_regime_classification_system(</span>
<span id="cb30-420"><a href="#cb30-420" aria-hidden="true" tabindex="-1"></a>    df_features_aug,</span>
<span id="cb30-421"><a href="#cb30-421" aria-hidden="true" tabindex="-1"></a>    L_index</span>
<span id="cb30-422"><a href="#cb30-422" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
ADVANCED REGIME CLASSIFICATION SYSTEM
================================================================================

================================================================================
STEP 0: DATA ALIGNMENT
================================================================================

📊 Data Coverage:
   df range:       1990-01-31 00:00:00 to 2025-11-30 00:00:00 (431 obs)
   L_series range: 2003-12-31 00:00:00 to 2025-09-30 00:00:00 (185 obs)
   Overlap range:  2003-12-31 00:00:00 to 2025-09-30 00:00:00 (185 obs)

✅ Data aligned: 185 observations

================================================================================
STEP 1: CRISIS DETECTION
================================================================================

📊 Crisis Features:
   ret_vol_6m          : 183/185 valid
   ret_vol_12m         : 180/185 valid
   L_vol_3m            : 184/185 valid
   L_vol_6m            : 183/185 valid
   abs_ret             : 185/185 valid
   cum_ret_3m          : 184/185 valid
   cum_ret_6m          : 183/185 valid
   max_dd_6m           : 183/185 valid
   VIX_level           : 185/185 valid
   VIX_zscore          : 156/185 valid

📊 Crisis detection dataset: 168 observations

✅ Crisis Detection Complete
   Crisis periods:     0 months (0.0%)
   Non-crisis periods: 185 months (100.0%)

================================================================================
STEP 2: REGIME CLASSIFICATION (NON-CRISIS PERIODS)
================================================================================

📊 Liquidity Quantiles:
   33rd percentile (q33): -0.80
   67th percentile (q67): +0.69

📊 Non-Crisis Regime Distribution:
   Tight   :   61 months ( 33.0%), Mean L = -1.95
   Neutral :   63 months ( 34.1%), Mean L = +0.00
   High    :   61 months ( 33.0%), Mean L = +1.95

================================================================================
STEP 3: FEATURE ENGINEERING
================================================================================

✅ Selected 16 features:
    1. dlog_M2             : 185/185 valid
    2. dlog_FED_BS         : 185/185 valid
    3. EM                  : 185/185 valid
    4. EB                  : 185/185 valid
    5. EL_3y               : 185/185 valid
    6. Net_Liq             : 118/185 valid
    7. Term_Spread         : 185/185 valid
    8. Credit_Spread       : 185/185 valid
    9. Real_Rate           : 185/185 valid
   10. VIX                 : 185/185 valid
   11. M2_growth           : 185/185 valid
   12. FED_BS_growth       : 185/185 valid
   13. L_ma_3              : 185/185 valid
   14. L_ma_6              : 183/185 valid
   15. L_momentum          : 182/185 valid
   16. V_spread            : 185/185 valid

📊 Final ML dataset: 155 samples × 16 features

================================================================================
STEP 4: MODEL TRAINING
================================================================================

======================================================================
Training Random Forest
======================================================================

📊 CV Accuracy: 0.800 (±0.104)

📈 Performance:
   Accuracy: 0.935
   ROC-AUC:  0.995

📋 Classification Report:
              precision    recall  f1-score   support

       Tight       0.95      0.95      0.95        42
     Neutral       0.89      0.93      0.91        54
        High       0.96      0.93      0.95        59

    accuracy                           0.94       155
   macro avg       0.94      0.94      0.94       155
weighted avg       0.94      0.94      0.94       155


🎯 Confusion Matrix (%):
              Pred_Tight  Pred_Neutral  Pred_High
True_Tight          95.2           4.8        0.0
True_Neutral         3.7          92.6        3.7
True_High            0.0           6.8       93.2

======================================================================
Training XGBoost
======================================================================

📊 CV Accuracy: 0.744 (±0.151)

📈 Performance:
   Accuracy: 1.000
   ROC-AUC:  1.000

📋 Classification Report:
              precision    recall  f1-score   support

       Tight       1.00      1.00      1.00        42
     Neutral       1.00      1.00      1.00        54
        High       1.00      1.00      1.00        59

    accuracy                           1.00       155
   macro avg       1.00      1.00      1.00       155
weighted avg       1.00      1.00      1.00       155


🎯 Confusion Matrix (%):
              Pred_Tight  Pred_Neutral  Pred_High
True_Tight         100.0           0.0        0.0
True_Neutral         0.0         100.0        0.0
True_High            0.0           0.0      100.0

================================================================================
STEP 5: FEATURE IMPORTANCE
================================================================================

📊 Top 10 Features:
   L_ma_6              : 0.3007
   L_ma_3              : 0.2085
   Term_Spread         : 0.1153
   FED_BS_growth       : 0.0552
   EL_3y               : 0.0481
   EM                  : 0.0375
   L_momentum          : 0.0371
   Real_Rate           : 0.0302
   Credit_Spread       : 0.0288
   VIX                 : 0.0272

================================================================================
STEP 6: FINAL REGIME ASSIGNMENT
================================================================================

📊 Final Distribution:
   High    :   59 ( 31.9%)
   Neutral :   54 ( 29.2%)
   Tight   :   42 ( 22.7%)
   Unknown :   30 ( 16.2%)

================================================================================
✅ COMPLETE
================================================================================</code></pre>
</div>
</div>
<div id="5c187b9a-5ef9-40d4-a007-4a54f6bd380c" class="cell" data-execution_count="117">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df_regimes_advanced.tail(<span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="117">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">M2</th>
<th data-quarto-table-cell-role="th">FED_BS</th>
<th data-quarto-table-cell-role="th">FFR</th>
<th data-quarto-table-cell-role="th">Real_Rate</th>
<th data-quarto-table-cell-role="th">T3M</th>
<th data-quarto-table-cell-role="th">T10Y</th>
<th data-quarto-table-cell-role="th">BAA</th>
<th data-quarto-table-cell-role="th">AAA</th>
<th data-quarto-table-cell-role="th">CPI</th>
<th data-quarto-table-cell-role="th">CORE_CPI</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">abs_ret</th>
<th data-quarto-table-cell-role="th">cum_ret_3m</th>
<th data-quarto-table-cell-role="th">cum_ret_6m</th>
<th data-quarto-table-cell-role="th">drawdown</th>
<th data-quarto-table-cell-role="th">max_dd_6m</th>
<th data-quarto-table-cell-role="th">VIX_level</th>
<th data-quarto-table-cell-role="th">VIX_zscore</th>
<th data-quarto-table-cell-role="th">is_crisis</th>
<th data-quarto-table-cell-role="th">regime</th>
<th data-quarto-table-cell-role="th">regime_label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">2025-07-31</th>
<td>22028.7</td>
<td>6642578.0</td>
<td>4.33</td>
<td>0.838904</td>
<td>4.24</td>
<td>4.37</td>
<td>6.04</td>
<td>5.41</td>
<td>322.132</td>
<td>328.656</td>
<td>...</td>
<td>0.0198</td>
<td>0.0600</td>
<td>-0.0002</td>
<td>-0.041738</td>
<td>-0.110072</td>
<td>16.72</td>
<td>-0.536469</td>
<td>False</td>
<td>0.0</td>
<td>Tight</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2025-09-30</th>
<td>22212.4</td>
<td>6608395.0</td>
<td>4.09</td>
<td>1.149868</td>
<td>3.86</td>
<td>4.16</td>
<td>5.83</td>
<td>5.22</td>
<td>324.368</td>
<td>330.542</td>
<td>...</td>
<td>0.0339</td>
<td>0.1023</td>
<td>0.0057</td>
<td>-0.007852</td>
<td>-0.110072</td>
<td>16.28</td>
<td>-0.613043</td>
<td>False</td>
<td>0.0</td>
<td>Tight</td>
</tr>
</tbody>
</table>

<p>2 rows × 68 columns</p>
</div>
</div>
</div>
<div id="79b91dda-f3b3-4ebe-948e-a4a2a5baa5a3" class="cell" data-execution_count="126">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># factor_returns_by_regime = (</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     df_regimes_advanced.groupby("regime_label")[["mkt_excess", "hml", "rmw", "cma"]]</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     .mean() * 100</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print(factor_returns_by_regime)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="93f8d34f-7efb-4897-a3c0-7e7baa16c775" class="cell" data-execution_count="127">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> diagnose_unknown_regimes(df_regimes_advanced, df_features_aug, L_index):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Understand why some periods are marked as Unknown</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"DIAGNOSIS: Unknown Regime Periods"</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find Unknown periods</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    unknown_mask <span class="op">=</span> df_regimes_advanced[<span class="st">'regime_label'</span>] <span class="op">==</span> <span class="st">'Unknown'</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    unknown_dates <span class="op">=</span> df_regimes_advanced[unknown_mask].index</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Unknown Periods: </span><span class="sc">{</span><span class="bu">len</span>(unknown_dates)<span class="sc">}</span><span class="ss"> months (</span><span class="sc">{</span><span class="bu">len</span>(unknown_dates)<span class="op">/</span><span class="bu">len</span>(df_regimes_advanced)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(unknown_dates) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📅 Unknown Date Range:"</span>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   First: </span><span class="sc">{</span>unknown_dates[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Last:  </span><span class="sc">{</span>unknown_dates[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check which features are missing</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🔍 Missing Data Analysis:"</span>)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        feature_cols <span class="op">=</span> [<span class="st">'dlog_M2'</span>, <span class="st">'dlog_FED_BS'</span>, <span class="st">'EM'</span>, <span class="st">'EB'</span>, <span class="st">'EL_3y'</span>, <span class="st">'Net_Liq'</span>,</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'Term_Spread'</span>, <span class="st">'Credit_Spread'</span>, <span class="st">'Real_Rate'</span>, <span class="st">'VIX'</span>,</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'M2_growth'</span>, <span class="st">'FED_BS_growth'</span>, <span class="st">'V_spread'</span>]</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> feat <span class="kw">in</span> feature_cols:</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> feat <span class="kw">in</span> df_features_aug.columns:</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check missing in unknown periods</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>                unknown_data <span class="op">=</span> df_features_aug.loc[unknown_dates, feat]</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>                n_missing <span class="op">=</span> unknown_data.isna().<span class="bu">sum</span>()</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>                pct_missing <span class="op">=</span> n_missing <span class="op">/</span> <span class="bu">len</span>(unknown_dates) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> n_missing <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>feat<span class="sc">:20s}</span><span class="ss">: </span><span class="sc">{</span>n_missing<span class="sc">:3d}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(unknown_dates)<span class="sc">}</span><span class="ss"> missing (</span><span class="sc">{</span>pct_missing<span class="sc">:5.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if Unknown periods cluster at start/end</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📍 Unknown Period Distribution:"</span>)</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Group consecutive unknowns</span></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>        unknown_groups <span class="op">=</span> []</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>        current_group <span class="op">=</span> [unknown_dates[<span class="dv">0</span>]]</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(unknown_dates)):</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (unknown_dates[i] <span class="op">-</span> unknown_dates[i<span class="op">-</span><span class="dv">1</span>]).days <span class="op">&lt;</span> <span class="dv">60</span>:  <span class="co"># Within 2 months</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>                current_group.append(unknown_dates[i])</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>                unknown_groups.append(current_group)</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>                current_group <span class="op">=</span> [unknown_dates[i]]</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>        unknown_groups.append(current_group)</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Found </span><span class="sc">{</span><span class="bu">len</span>(unknown_groups)<span class="sc">}</span><span class="ss"> clusters of unknown periods:"</span>)</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, group <span class="kw">in</span> <span class="bu">enumerate</span>(unknown_groups, <span class="dv">1</span>):</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   Cluster </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>group[<span class="dv">0</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>group[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(group)<span class="sc">}</span><span class="ss"> months)"</span>)</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Run diagnosis</span></span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>diagnose_unknown_regimes(df_regimes_advanced, df_features_aug, L_index)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
DIAGNOSIS: Unknown Regime Periods
================================================================================

📊 Unknown Periods: 30 months (16.2%)

📅 Unknown Date Range:
   First: 2003-12
   Last:  2012-10

🔍 Missing Data Analysis:
   Net_Liq             :  29/30 missing ( 96.7%)

📍 Unknown Period Distribution:
   Found 14 clusters of unknown periods:
   Cluster 1: 2003-12 to 2003-12 (1 months)
   Cluster 2: 2004-03 to 2004-04 (2 months)
   Cluster 3: 2004-12 to 2005-03 (4 months)
   Cluster 4: 2005-05 to 2005-06 (2 months)
   Cluster 5: 2005-08 to 2005-11 (4 months)
   Cluster 6: 2006-01 to 2006-03 (3 months)
   Cluster 7: 2006-05 to 2006-08 (4 months)
   Cluster 8: 2006-10 to 2006-11 (2 months)
   Cluster 9: 2007-01 to 2007-02 (2 months)
   Cluster 10: 2008-02 to 2008-02 (1 months)
   Cluster 11: 2009-11 to 2009-11 (1 months)
   Cluster 12: 2012-05 to 2012-05 (1 months)
   Cluster 13: 2012-07 to 2012-08 (2 months)
   Cluster 14: 2012-10 to 2012-10 (1 months)</code></pre>
</div>
</div>
<div id="5267697a-9d40-4e1b-ac1f-34699c083497" class="cell" data-execution_count="135">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_features_aug.columns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="135">
<pre><code>Index(['M2', 'FED_BS', 'FFR', 'Real_Rate', 'T3M', 'T10Y', 'BAA', 'AAA', 'CPI',
       'CORE_CPI', 'GDP', 'IORB', 'RRP', 'TGA', 'Bank_Reserves', 'CI_Loans',
       'Consumer_Credit', 'Mortgage_Rate', 'Prime_Rate', 'STLFSI',
       'Dollar_Index', 'Household_Debt_Service', 'mkt_excess', 'smb', 'hml',
       'rmw', 'cma', 'rf', 'P', 'CAPE', 'VIX', 'M2_growth', 'FED_BS_growth',
       'Term_Spread', 'Credit_Spread', 'CPI_inflation', 'log_CAPE',
       'CAPE_zscore', 'Risk_Adj_Spread', 'Net_Liq', 'HML_cumret', 'HML_12m',
       'V_spread', 'V_spread_z', 'V_level', 'dlog_M2', 'dlog_FED_BS', 'log_M2',
       'log_FED_BS', 'EM', 'EB', 'log_GDP', 'EL_3y'],
      dtype='object')</code></pre>
</div>
</div>
<div id="3fb02079-76f2-415f-bead-fd9e66ad8394" class="cell" data-execution_count="133">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_hml_regime_classification_with_crisis(df, L_series):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Detect crisis periods (Isolation Forest)</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Classify NON-CRISIS periods by HML regimes</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Predict HML regimes from liquidity features</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.ensemble <span class="im">import</span> IsolationForest, RandomForestClassifier</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit, cross_val_score</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, confusion_matrix</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"HML REGIME CLASSIFICATION (WITH CRISIS DETECTION)"</span>)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 0: Data Alignment</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    common_idx <span class="op">=</span> df.index.intersection(L_series.index)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    df_aligned <span class="op">=</span> df.loc[common_idx].copy()</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    df_aligned[<span class="st">'L'</span>] <span class="op">=</span> L_series.loc[common_idx]</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Aligned: </span><span class="sc">{</span><span class="bu">len</span>(df_aligned)<span class="sc">}</span><span class="ss"> observations"</span>)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 1: Crisis Detection (Isolation Forest)</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 1: CRISIS DETECTION"</span>)</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>    df_crisis <span class="op">=</span> df_aligned.copy()</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create crisis features (volatility, drawdowns, tail events)</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'ret_vol_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).std()</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'ret_vol_12m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">6</span>).std()</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'L_vol_3m'</span>] <span class="op">=</span> df_crisis[<span class="st">'L'</span>].rolling(<span class="dv">3</span>, min_periods<span class="op">=</span><span class="dv">2</span>).std()</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'L_vol_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'L'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).std()</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return features</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'abs_ret'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].<span class="bu">abs</span>()</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'cum_ret_3m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">3</span>, min_periods<span class="op">=</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'cum_ret_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).<span class="bu">sum</span>()</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drawdown</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>    cumret <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df_crisis[<span class="st">'mkt_excess'</span>]<span class="op">/</span><span class="dv">100</span>).cumprod()</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>    running_max <span class="op">=</span> cumret.expanding().<span class="bu">max</span>()</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'drawdown'</span>] <span class="op">=</span> (cumret <span class="op">/</span> running_max <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'max_dd_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'drawdown'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).<span class="bu">min</span>()</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crisis features list</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>    crisis_features <span class="op">=</span> [<span class="st">'ret_vol_6m'</span>, <span class="st">'ret_vol_12m'</span>, <span class="st">'L_vol_3m'</span>, <span class="st">'L_vol_6m'</span>, </span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'abs_ret'</span>, <span class="st">'cum_ret_3m'</span>, <span class="st">'cum_ret_6m'</span>, <span class="st">'max_dd_6m'</span>]</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add VIX if available</span></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'VIX'</span> <span class="kw">in</span> df_crisis.columns:</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'VIX_level'</span>] <span class="op">=</span> df_crisis[<span class="st">'VIX'</span>]</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'VIX_zscore'</span>] <span class="op">=</span> (df_crisis[<span class="st">'VIX'</span>] <span class="op">-</span> df_crisis[<span class="st">'VIX'</span>].rolling(<span class="dv">60</span>, min_periods<span class="op">=</span><span class="dv">30</span>).mean()) <span class="op">/</span> <span class="op">\</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>                                   df_crisis[<span class="st">'VIX'</span>].rolling(<span class="dv">60</span>, min_periods<span class="op">=</span><span class="dv">30</span>).std()</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>        crisis_features.extend([<span class="st">'VIX_level'</span>, <span class="st">'VIX_zscore'</span>])</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Crisis Features Created: </span><span class="sc">{</span><span class="bu">len</span>(crisis_features)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract and clean crisis data</span></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>    crisis_data <span class="op">=</span> df_crisis[crisis_features].copy()</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>    crisis_data <span class="op">=</span> crisis_data.fillna(method<span class="op">=</span><span class="st">'bfill'</span>, limit<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>    crisis_data <span class="op">=</span> crisis_data.dropna()</span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Valid crisis detection samples: </span><span class="sc">{</span><span class="bu">len</span>(crisis_data)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(df_crisis)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(crisis_data) <span class="op">&gt;=</span> <span class="dv">20</span>:</span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit Isolation Forest</span></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>        iso_forest <span class="op">=</span> IsolationForest(</span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>            contamination<span class="op">=</span><span class="fl">0.05</span>,  <span class="co"># Expect ~5% crisis periods</span></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>            max_samples<span class="op">=</span><span class="st">'auto'</span></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a>        outlier_labels <span class="op">=</span> iso_forest.fit_predict(crisis_data.values)</span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Crisis = outlier + negative return (&lt; -2%)</span></span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>        is_crisis_candidate <span class="op">=</span> (outlier_labels <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>        is_negative_return <span class="op">=</span> (df_crisis.loc[crisis_data.index, <span class="st">'mkt_excess'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="dv">2</span>)</span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'is_crisis'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>        df_crisis.loc[crisis_data.index, <span class="st">'is_crisis'</span>] <span class="op">=</span> is_crisis_candidate <span class="op">&amp;</span> is_negative_return</span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>        n_crisis <span class="op">=</span> df_crisis[<span class="st">'is_crisis'</span>].<span class="bu">sum</span>()</span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>        crisis_pct <span class="op">=</span> n_crisis <span class="op">/</span> <span class="bu">len</span>(df_crisis) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Crisis Detection Complete:"</span>)</span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Crisis periods:     </span><span class="sc">{</span>n_crisis<span class="sc">}</span><span class="ss"> months (</span><span class="sc">{</span>crisis_pct<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Non-crisis periods: </span><span class="sc">{</span><span class="bu">len</span>(df_crisis) <span class="op">-</span> n_crisis<span class="sc">}</span><span class="ss"> months (</span><span class="sc">{</span><span class="dv">100</span><span class="op">-</span>crisis_pct<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Show detected crisis periods</span></span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n_crisis <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>            crisis_periods <span class="op">=</span> df_crisis[df_crisis[<span class="st">'is_crisis'</span>]].index</span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📅 Detected Crisis Months:"</span>)</span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, date <span class="kw">in</span> <span class="bu">enumerate</span>(crisis_periods[:<span class="dv">10</span>], <span class="dv">1</span>):</span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a>                ret <span class="op">=</span> df_crisis.loc[date, <span class="st">'mkt_excess'</span>]</span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>                L_val <span class="op">=</span> df_crisis.loc[date, <span class="st">'L'</span>]</span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>i<span class="sc">:2d}</span><span class="ss">. </span><span class="sc">{</span>date<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss">: Return = </span><span class="sc">{</span>ret<span class="sc">:+.2f}</span><span class="ss">%, L = </span><span class="sc">{</span>L_val<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(crisis_periods) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"   ... and </span><span class="sc">{</span><span class="bu">len</span>(crisis_periods) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> more"</span>)</span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">⚠️  Insufficient data for crisis detection, marking all as non-crisis"</span>)</span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'is_crisis'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter to non-crisis periods for HML regime analysis</span></span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a>    df_noncrisis <span class="op">=</span> df_crisis[<span class="op">~</span>df_crisis[<span class="st">'is_crisis'</span>]].copy()</span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Non-Crisis Data: </span><span class="sc">{</span><span class="bu">len</span>(df_noncrisis)<span class="sc">}</span><span class="ss"> observations"</span>)</span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 2: Define HML Regimes (Non-Crisis Only)</span></span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 2: DEFINE HML REGIMES (NON-CRISIS PERIODS)"</span>)</span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for HML data</span></span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'hml'</span> <span class="kw">not</span> <span class="kw">in</span> df_noncrisis.columns <span class="kw">and</span> <span class="st">'HML'</span> <span class="kw">not</span> <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No HML column found in dataframe"</span>)</span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a>    hml_col <span class="op">=</span> <span class="st">'hml'</span> <span class="cf">if</span> <span class="st">'hml'</span> <span class="kw">in</span> df_noncrisis.columns <span class="cf">else</span> <span class="st">'HML'</span></span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use 12-month rolling HML for smoother regimes</span></span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'HML_12m'</span> <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a>        hml_metric <span class="op">=</span> df_noncrisis[<span class="st">'HML_12m'</span>]</span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a>        metric_col <span class="op">=</span> <span class="st">'HML_12m'</span></span>
<span id="cb38-138"><a href="#cb38-138" aria-hidden="true" tabindex="-1"></a>        metric_name <span class="op">=</span> <span class="st">"12-month rolling HML"</span></span>
<span id="cb38-139"><a href="#cb38-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb38-140"><a href="#cb38-140" aria-hidden="true" tabindex="-1"></a>        df_noncrisis[<span class="st">'HML_12m'</span>] <span class="op">=</span> df_noncrisis[hml_col].rolling(<span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">6</span>).<span class="bu">sum</span>()</span>
<span id="cb38-141"><a href="#cb38-141" aria-hidden="true" tabindex="-1"></a>        hml_metric <span class="op">=</span> df_noncrisis[<span class="st">'HML_12m'</span>]</span>
<span id="cb38-142"><a href="#cb38-142" aria-hidden="true" tabindex="-1"></a>        metric_col <span class="op">=</span> <span class="st">'HML_12m'</span></span>
<span id="cb38-143"><a href="#cb38-143" aria-hidden="true" tabindex="-1"></a>        metric_name <span class="op">=</span> <span class="st">"12-month rolling HML (created)"</span></span>
<span id="cb38-144"><a href="#cb38-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-145"><a href="#cb38-145" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Using: </span><span class="sc">{</span>metric_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-146"><a href="#cb38-146" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Range: </span><span class="sc">{</span>hml_metric<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>hml_metric<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb38-147"><a href="#cb38-147" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Mean:  </span><span class="sc">{</span>hml_metric<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb38-148"><a href="#cb38-148" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Std:   </span><span class="sc">{</span>hml_metric<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb38-149"><a href="#cb38-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-150"><a href="#cb38-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define regime thresholds (tertiles on NON-CRISIS data)</span></span>
<span id="cb38-151"><a href="#cb38-151" aria-hidden="true" tabindex="-1"></a>    q33 <span class="op">=</span> hml_metric.quantile(<span class="fl">0.33</span>)</span>
<span id="cb38-152"><a href="#cb38-152" aria-hidden="true" tabindex="-1"></a>    q67 <span class="op">=</span> hml_metric.quantile(<span class="fl">0.67</span>)</span>
<span id="cb38-153"><a href="#cb38-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-154"><a href="#cb38-154" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 HML Regime Thresholds (Non-Crisis):"</span>)</span>
<span id="cb38-155"><a href="#cb38-155" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   33rd percentile: </span><span class="sc">{</span>q33<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb38-156"><a href="#cb38-156" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   67th percentile: </span><span class="sc">{</span>q67<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb38-157"><a href="#cb38-157" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-158"><a href="#cb38-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create regime labels</span></span>
<span id="cb38-159"><a href="#cb38-159" aria-hidden="true" tabindex="-1"></a>    df_noncrisis[<span class="st">'hml_regime'</span>] <span class="op">=</span> pd.cut(</span>
<span id="cb38-160"><a href="#cb38-160" aria-hidden="true" tabindex="-1"></a>        hml_metric,</span>
<span id="cb38-161"><a href="#cb38-161" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span>[<span class="op">-</span>np.inf, q33, q67, np.inf],</span>
<span id="cb38-162"><a href="#cb38-162" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb38-163"><a href="#cb38-163" aria-hidden="true" tabindex="-1"></a>    ).astype(<span class="bu">int</span>)</span>
<span id="cb38-164"><a href="#cb38-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-165"><a href="#cb38-165" aria-hidden="true" tabindex="-1"></a>    df_noncrisis[<span class="st">'hml_regime_label'</span>] <span class="op">=</span> df_noncrisis[<span class="st">'hml_regime'</span>].<span class="bu">map</span>({</span>
<span id="cb38-166"><a href="#cb38-166" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span>: <span class="st">'Growth-Friendly'</span>,</span>
<span id="cb38-167"><a href="#cb38-167" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>: <span class="st">'Neutral'</span>, </span>
<span id="cb38-168"><a href="#cb38-168" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span>: <span class="st">'Value-Friendly'</span></span>
<span id="cb38-169"><a href="#cb38-169" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb38-170"><a href="#cb38-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-171"><a href="#cb38-171" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove NaN regimes</span></span>
<span id="cb38-172"><a href="#cb38-172" aria-hidden="true" tabindex="-1"></a>    df_regimes <span class="op">=</span> df_noncrisis.dropna(subset<span class="op">=</span>[<span class="st">'hml_regime'</span>])</span>
<span id="cb38-173"><a href="#cb38-173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-174"><a href="#cb38-174" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 HML Regime Distribution (Non-Crisis):"</span>)</span>
<span id="cb38-175"><a href="#cb38-175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime, label <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'Growth-Friendly'</span>), (<span class="dv">1</span>, <span class="st">'Neutral'</span>), (<span class="dv">2</span>, <span class="st">'Value-Friendly'</span>)]:</span>
<span id="cb38-176"><a href="#cb38-176" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> df_regimes[<span class="st">'hml_regime'</span>] <span class="op">==</span> regime</span>
<span id="cb38-177"><a href="#cb38-177" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> mask.<span class="bu">sum</span>()</span>
<span id="cb38-178"><a href="#cb38-178" aria-hidden="true" tabindex="-1"></a>        pct <span class="op">=</span> count <span class="op">/</span> <span class="bu">len</span>(df_regimes) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb38-179"><a href="#cb38-179" aria-hidden="true" tabindex="-1"></a>        mean_hml <span class="op">=</span> df_regimes.loc[mask, metric_col].mean()</span>
<span id="cb38-180"><a href="#cb38-180" aria-hidden="true" tabindex="-1"></a>        mean_L <span class="op">=</span> df_regimes.loc[mask, <span class="st">'L'</span>].mean()</span>
<span id="cb38-181"><a href="#cb38-181" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>label<span class="sc">:16s}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">:4d}</span><span class="ss"> (</span><span class="sc">{</span>pct<span class="sc">:5.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb38-182"><a href="#cb38-182" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"      Mean HML: </span><span class="sc">{</span>mean_hml<span class="sc">:+.2f}</span><span class="ss">, Mean L: </span><span class="sc">{</span>mean_L<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb38-183"><a href="#cb38-183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-184"><a href="#cb38-184" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-185"><a href="#cb38-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 3: Feature Engineering (Liquidity)</span></span>
<span id="cb38-186"><a href="#cb38-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-187"><a href="#cb38-187" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-188"><a href="#cb38-188" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-189"><a href="#cb38-189" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 3: LIQUIDITY FEATURES"</span>)</span>
<span id="cb38-190"><a href="#cb38-190" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-191"><a href="#cb38-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-192"><a href="#cb38-192" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> []</span>
<span id="cb38-193"><a href="#cb38-193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-194"><a href="#cb38-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Core liquidity components</span></span>
<span id="cb38-195"><a href="#cb38-195" aria-hidden="true" tabindex="-1"></a>    liq_features <span class="op">=</span> [<span class="st">'dlog_M2'</span>, <span class="st">'dlog_FED_BS'</span>, <span class="st">'EM'</span>, <span class="st">'EB'</span>, <span class="st">'EL_3y'</span>]</span>
<span id="cb38-196"><a href="#cb38-196" aria-hidden="true" tabindex="-1"></a>    feature_cols.extend([f <span class="cf">for</span> f <span class="kw">in</span> liq_features <span class="cf">if</span> f <span class="kw">in</span> df_regimes.columns])</span>
<span id="cb38-197"><a href="#cb38-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-198"><a href="#cb38-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rates and spreads</span></span>
<span id="cb38-199"><a href="#cb38-199" aria-hidden="true" tabindex="-1"></a>    rate_features <span class="op">=</span> [<span class="st">'Term_Spread'</span>, <span class="st">'Credit_Spread'</span>, <span class="st">'Real_Rate'</span>]</span>
<span id="cb38-200"><a href="#cb38-200" aria-hidden="true" tabindex="-1"></a>    feature_cols.extend([f <span class="cf">for</span> f <span class="kw">in</span> rate_features <span class="cf">if</span> f <span class="kw">in</span> df_regimes.columns])</span>
<span id="cb38-201"><a href="#cb38-201" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-202"><a href="#cb38-202" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Market indicators</span></span>
<span id="cb38-203"><a href="#cb38-203" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'VIX'</span> <span class="kw">in</span> df_regimes.columns:</span>
<span id="cb38-204"><a href="#cb38-204" aria-hidden="true" tabindex="-1"></a>        feature_cols.append(<span class="st">'VIX'</span>)</span>
<span id="cb38-205"><a href="#cb38-205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-206"><a href="#cb38-206" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Growth rates</span></span>
<span id="cb38-207"><a href="#cb38-207" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'M2_growth'</span> <span class="kw">in</span> df_regimes.columns:</span>
<span id="cb38-208"><a href="#cb38-208" aria-hidden="true" tabindex="-1"></a>        feature_cols.append(<span class="st">'M2_growth'</span>)</span>
<span id="cb38-209"><a href="#cb38-209" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'FED_BS_growth'</span> <span class="kw">in</span> df_regimes.columns:</span>
<span id="cb38-210"><a href="#cb38-210" aria-hidden="true" tabindex="-1"></a>        feature_cols.append(<span class="st">'FED_BS_growth'</span>)</span>
<span id="cb38-211"><a href="#cb38-211" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-212"><a href="#cb38-212" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LIQUIDITY INDEX (L)</span></span>
<span id="cb38-213"><a href="#cb38-213" aria-hidden="true" tabindex="-1"></a>    feature_cols.append(<span class="st">'L'</span>)</span>
<span id="cb38-214"><a href="#cb38-214" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-215"><a href="#cb38-215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Technical on L</span></span>
<span id="cb38-216"><a href="#cb38-216" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'L_ma_3'</span>] <span class="op">=</span> df_regimes[<span class="st">'L'</span>].rolling(<span class="dv">3</span>, min_periods<span class="op">=</span><span class="dv">1</span>).mean()</span>
<span id="cb38-217"><a href="#cb38-217" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'L_ma_6'</span>] <span class="op">=</span> df_regimes[<span class="st">'L'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).mean()</span>
<span id="cb38-218"><a href="#cb38-218" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'L_momentum'</span>] <span class="op">=</span> df_regimes[<span class="st">'L'</span>].diff(<span class="dv">3</span>)</span>
<span id="cb38-219"><a href="#cb38-219" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'L_accel'</span>] <span class="op">=</span> df_regimes[<span class="st">'L_momentum'</span>].diff(<span class="dv">3</span>)</span>
<span id="cb38-220"><a href="#cb38-220" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-221"><a href="#cb38-221" aria-hidden="true" tabindex="-1"></a>    feature_cols.extend([<span class="st">'L_ma_3'</span>, <span class="st">'L_ma_6'</span>, <span class="st">'L_momentum'</span>, <span class="st">'L_accel'</span>])</span>
<span id="cb38-222"><a href="#cb38-222" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-223"><a href="#cb38-223" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged HML (control for momentum)</span></span>
<span id="cb38-224"><a href="#cb38-224" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'HML_lag3'</span>] <span class="op">=</span> df_regimes[hml_col].shift(<span class="dv">3</span>)</span>
<span id="cb38-225"><a href="#cb38-225" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'HML_lag6'</span>] <span class="op">=</span> df_regimes[hml_col].shift(<span class="dv">6</span>)</span>
<span id="cb38-226"><a href="#cb38-226" aria-hidden="true" tabindex="-1"></a>    feature_cols.extend([<span class="st">'HML_lag3'</span>, <span class="st">'HML_lag6'</span>])</span>
<span id="cb38-227"><a href="#cb38-227" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-228"><a href="#cb38-228" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Selected </span><span class="sc">{</span><span class="bu">len</span>(feature_cols)<span class="sc">}</span><span class="ss"> features"</span>)</span>
<span id="cb38-229"><a href="#cb38-229" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-230"><a href="#cb38-230" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-231"><a href="#cb38-231" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 4: Prepare ML Dataset</span></span>
<span id="cb38-232"><a href="#cb38-232" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-233"><a href="#cb38-233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-234"><a href="#cb38-234" aria-hidden="true" tabindex="-1"></a>    X_raw <span class="op">=</span> df_regimes[feature_cols].copy()</span>
<span id="cb38-235"><a href="#cb38-235" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df_regimes[<span class="st">'hml_regime'</span>].copy()</span>
<span id="cb38-236"><a href="#cb38-236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-237"><a href="#cb38-237" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Imputation</span></span>
<span id="cb38-238"><a href="#cb38-238" aria-hidden="true" tabindex="-1"></a>    X_imputed <span class="op">=</span> X_raw.fillna(method<span class="op">=</span><span class="st">'ffill'</span>, limit<span class="op">=</span><span class="dv">6</span>).fillna(method<span class="op">=</span><span class="st">'bfill'</span>, limit<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb38-239"><a href="#cb38-239" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-240"><a href="#cb38-240" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> X_imputed.columns:</span>
<span id="cb38-241"><a href="#cb38-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> X_imputed[col].isna().<span class="bu">any</span>():</span>
<span id="cb38-242"><a href="#cb38-242" aria-hidden="true" tabindex="-1"></a>            X_imputed[col] <span class="op">=</span> X_imputed[col].fillna(X_imputed[col].median())</span>
<span id="cb38-243"><a href="#cb38-243" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-244"><a href="#cb38-244" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final dataset</span></span>
<span id="cb38-245"><a href="#cb38-245" aria-hidden="true" tabindex="-1"></a>    valid_idx <span class="op">=</span> X_imputed.notna().<span class="bu">all</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">&amp;</span> y.notna()</span>
<span id="cb38-246"><a href="#cb38-246" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> X_imputed[valid_idx]</span>
<span id="cb38-247"><a href="#cb38-247" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> y[valid_idx]</span>
<span id="cb38-248"><a href="#cb38-248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-249"><a href="#cb38-249" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 ML Dataset: </span><span class="sc">{</span><span class="bu">len</span>(X)<span class="sc">}</span><span class="ss"> samples × </span><span class="sc">{</span><span class="bu">len</span>(feature_cols)<span class="sc">}</span><span class="ss"> features"</span>)</span>
<span id="cb38-250"><a href="#cb38-250" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-251"><a href="#cb38-251" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(X) <span class="op">&lt;</span> <span class="dv">50</span>:</span>
<span id="cb38-252"><a href="#cb38-252" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Insufficient data: </span><span class="sc">{</span><span class="bu">len</span>(X)<span class="sc">}</span><span class="ss"> samples"</span>)</span>
<span id="cb38-253"><a href="#cb38-253" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-254"><a href="#cb38-254" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-255"><a href="#cb38-255" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 5: Train Models with CV</span></span>
<span id="cb38-256"><a href="#cb38-256" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-257"><a href="#cb38-257" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-258"><a href="#cb38-258" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-259"><a href="#cb38-259" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 4: MODEL TRAINING &amp; CROSS-VALIDATION"</span>)</span>
<span id="cb38-260"><a href="#cb38-260" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-261"><a href="#cb38-261" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-262"><a href="#cb38-262" aria-hidden="true" tabindex="-1"></a>    tscv <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb38-263"><a href="#cb38-263" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-264"><a href="#cb38-264" aria-hidden="true" tabindex="-1"></a>    models <span class="op">=</span> {</span>
<span id="cb38-265"><a href="#cb38-265" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Random Forest'</span>: RandomForestClassifier(</span>
<span id="cb38-266"><a href="#cb38-266" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb38-267"><a href="#cb38-267" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb38-268"><a href="#cb38-268" aria-hidden="true" tabindex="-1"></a>            min_samples_split<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb38-269"><a href="#cb38-269" aria-hidden="true" tabindex="-1"></a>            min_samples_leaf<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb38-270"><a href="#cb38-270" aria-hidden="true" tabindex="-1"></a>            class_weight<span class="op">=</span><span class="st">'balanced'</span>,</span>
<span id="cb38-271"><a href="#cb38-271" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb38-272"><a href="#cb38-272" aria-hidden="true" tabindex="-1"></a>            n_jobs<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb38-273"><a href="#cb38-273" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb38-274"><a href="#cb38-274" aria-hidden="true" tabindex="-1"></a>        <span class="st">'XGBoost'</span>: XGBClassifier(</span>
<span id="cb38-275"><a href="#cb38-275" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb38-276"><a href="#cb38-276" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb38-277"><a href="#cb38-277" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb38-278"><a href="#cb38-278" aria-hidden="true" tabindex="-1"></a>            subsample<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb38-279"><a href="#cb38-279" aria-hidden="true" tabindex="-1"></a>            colsample_bytree<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb38-280"><a href="#cb38-280" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb38-281"><a href="#cb38-281" aria-hidden="true" tabindex="-1"></a>            eval_metric<span class="op">=</span><span class="st">'mlogloss'</span>,</span>
<span id="cb38-282"><a href="#cb38-282" aria-hidden="true" tabindex="-1"></a>            use_label_encoder<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb38-283"><a href="#cb38-283" aria-hidden="true" tabindex="-1"></a>            n_jobs<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb38-284"><a href="#cb38-284" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-285"><a href="#cb38-285" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-286"><a href="#cb38-286" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-287"><a href="#cb38-287" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb38-288"><a href="#cb38-288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-289"><a href="#cb38-289" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, model <span class="kw">in</span> models.items():</span>
<span id="cb38-290"><a href="#cb38-290" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-291"><a href="#cb38-291" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-292"><a href="#cb38-292" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-293"><a href="#cb38-293" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-294"><a href="#cb38-294" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Cross-validation</span></span>
<span id="cb38-295"><a href="#cb38-295" aria-hidden="true" tabindex="-1"></a>        cv_scores <span class="op">=</span> cross_val_score(model, X, y, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">'accuracy'</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb38-296"><a href="#cb38-296" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-297"><a href="#cb38-297" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Cross-Validation (Time Series):"</span>)</span>
<span id="cb38-298"><a href="#cb38-298" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Mean Accuracy: </span><span class="sc">{</span>cv_scores<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss"> (±</span><span class="sc">{</span>cv_scores<span class="sc">.</span>std()<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb38-299"><a href="#cb38-299" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Fold Scores:   </span><span class="sc">{</span>[<span class="ss">f'</span><span class="sc">{</span>s<span class="sc">:.3f}</span><span class="ss">'</span> <span class="cf">for</span> s <span class="kw">in</span> cv_scores]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-300"><a href="#cb38-300" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-301"><a href="#cb38-301" aria-hidden="true" tabindex="-1"></a>        baseline <span class="op">=</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span></span>
<span id="cb38-302"><a href="#cb38-302" aria-hidden="true" tabindex="-1"></a>        improvement <span class="op">=</span> cv_scores.mean() <span class="op">-</span> baseline</span>
<span id="cb38-303"><a href="#cb38-303" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   vs Baseline:   </span><span class="sc">{</span>improvement<span class="sc">:+.1%}</span><span class="ss">"</span>)</span>
<span id="cb38-304"><a href="#cb38-304" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-305"><a href="#cb38-305" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train full model</span></span>
<span id="cb38-306"><a href="#cb38-306" aria-hidden="true" tabindex="-1"></a>        model.fit(X, y)</span>
<span id="cb38-307"><a href="#cb38-307" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-308"><a href="#cb38-308" aria-hidden="true" tabindex="-1"></a>        <span class="co"># In-sample</span></span>
<span id="cb38-309"><a href="#cb38-309" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb38-310"><a href="#cb38-310" aria-hidden="true" tabindex="-1"></a>        train_acc <span class="op">=</span> (y_pred <span class="op">==</span> y).mean()</span>
<span id="cb38-311"><a href="#cb38-311" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-312"><a href="#cb38-312" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📈 In-Sample Accuracy: </span><span class="sc">{</span>train_acc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb38-313"><a href="#cb38-313" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-314"><a href="#cb38-314" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Classification report</span></span>
<span id="cb38-315"><a href="#cb38-315" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📋 Classification Report:"</span>)</span>
<span id="cb38-316"><a href="#cb38-316" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(classification_report(</span>
<span id="cb38-317"><a href="#cb38-317" aria-hidden="true" tabindex="-1"></a>            y, y_pred,</span>
<span id="cb38-318"><a href="#cb38-318" aria-hidden="true" tabindex="-1"></a>            target_names<span class="op">=</span>[<span class="st">'Growth-Friendly'</span>, <span class="st">'Neutral'</span>, <span class="st">'Value-Friendly'</span>],</span>
<span id="cb38-319"><a href="#cb38-319" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span><span class="dv">0</span></span>
<span id="cb38-320"><a href="#cb38-320" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb38-321"><a href="#cb38-321" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-322"><a href="#cb38-322" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Confusion matrix</span></span>
<span id="cb38-323"><a href="#cb38-323" aria-hidden="true" tabindex="-1"></a>        cm <span class="op">=</span> confusion_matrix(y, y_pred)</span>
<span id="cb38-324"><a href="#cb38-324" aria-hidden="true" tabindex="-1"></a>        cm_pct <span class="op">=</span> cm.astype(<span class="st">'float'</span>) <span class="op">/</span> cm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)[:, np.newaxis] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb38-325"><a href="#cb38-325" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-326"><a href="#cb38-326" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🎯 Confusion Matrix (%):"</span>)</span>
<span id="cb38-327"><a href="#cb38-327" aria-hidden="true" tabindex="-1"></a>        cm_df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb38-328"><a href="#cb38-328" aria-hidden="true" tabindex="-1"></a>            cm_pct,</span>
<span id="cb38-329"><a href="#cb38-329" aria-hidden="true" tabindex="-1"></a>            index<span class="op">=</span>[<span class="st">'True_Growth'</span>, <span class="st">'True_Neutral'</span>, <span class="st">'True_Value'</span>],</span>
<span id="cb38-330"><a href="#cb38-330" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>[<span class="st">'Pred_Growth'</span>, <span class="st">'Pred_Neutral'</span>, <span class="st">'Pred_Value'</span>]</span>
<span id="cb38-331"><a href="#cb38-331" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-332"><a href="#cb38-332" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(cm_df.<span class="bu">round</span>(<span class="dv">1</span>))</span>
<span id="cb38-333"><a href="#cb38-333" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb38-334"><a href="#cb38-334" aria-hidden="true" tabindex="-1"></a>        results[name] <span class="op">=</span> {</span>
<span id="cb38-335"><a href="#cb38-335" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: model,</span>
<span id="cb38-336"><a href="#cb38-336" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cv_scores'</span>: cv_scores,</span>
<span id="cb38-337"><a href="#cb38-337" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cv_mean'</span>: cv_scores.mean(),</span>
<span id="cb38-338"><a href="#cb38-338" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cv_std'</span>: cv_scores.std(),</span>
<span id="cb38-339"><a href="#cb38-339" aria-hidden="true" tabindex="-1"></a>            <span class="st">'train_acc'</span>: train_acc,</span>
<span id="cb38-340"><a href="#cb38-340" aria-hidden="true" tabindex="-1"></a>            <span class="st">'y_pred'</span>: y_pred</span>
<span id="cb38-341"><a href="#cb38-341" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb38-342"><a href="#cb38-342" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-343"><a href="#cb38-343" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-344"><a href="#cb38-344" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 6: Feature Importance</span></span>
<span id="cb38-345"><a href="#cb38-345" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-346"><a href="#cb38-346" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-347"><a href="#cb38-347" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-348"><a href="#cb38-348" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 5: FEATURE IMPORTANCE"</span>)</span>
<span id="cb38-349"><a href="#cb38-349" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-350"><a href="#cb38-350" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-351"><a href="#cb38-351" aria-hidden="true" tabindex="-1"></a>    best_model_name <span class="op">=</span> <span class="bu">max</span>(results, key<span class="op">=</span><span class="kw">lambda</span> k: results[k][<span class="st">'cv_mean'</span>])</span>
<span id="cb38-352"><a href="#cb38-352" aria-hidden="true" tabindex="-1"></a>    best_model <span class="op">=</span> results[best_model_name][<span class="st">'model'</span>]</span>
<span id="cb38-353"><a href="#cb38-353" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-354"><a href="#cb38-354" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🏆 Best Model: </span><span class="sc">{</span>best_model_name<span class="sc">}</span><span class="ss"> (CV: </span><span class="sc">{</span>results[best_model_name][<span class="st">'cv_mean'</span>]<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb38-355"><a href="#cb38-355" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-356"><a href="#cb38-356" aria-hidden="true" tabindex="-1"></a>    feature_importance <span class="op">=</span> pd.DataFrame({</span>
<span id="cb38-357"><a href="#cb38-357" aria-hidden="true" tabindex="-1"></a>        <span class="st">'feature'</span>: X.columns,</span>
<span id="cb38-358"><a href="#cb38-358" aria-hidden="true" tabindex="-1"></a>        <span class="st">'importance'</span>: best_model.feature_importances_</span>
<span id="cb38-359"><a href="#cb38-359" aria-hidden="true" tabindex="-1"></a>    }).sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb38-360"><a href="#cb38-360" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-361"><a href="#cb38-361" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Top 15 Features:"</span>)</span>
<span id="cb38-362"><a href="#cb38-362" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> feature_importance.head(<span class="dv">15</span>).iterrows():</span>
<span id="cb38-363"><a href="#cb38-363" aria-hidden="true" tabindex="-1"></a>        is_liquidity <span class="op">=</span> <span class="bu">any</span>(liq <span class="kw">in</span> row[<span class="st">'feature'</span>] <span class="cf">for</span> liq <span class="kw">in</span> [<span class="st">'L'</span>, <span class="st">'M2'</span>, <span class="st">'FED'</span>, <span class="st">'EM'</span>, <span class="st">'EB'</span>, <span class="st">'EL'</span>])</span>
<span id="cb38-364"><a href="#cb38-364" aria-hidden="true" tabindex="-1"></a>        marker <span class="op">=</span> <span class="st">"💧"</span> <span class="cf">if</span> is_liquidity <span class="cf">else</span> <span class="st">"  "</span></span>
<span id="cb38-365"><a href="#cb38-365" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>marker<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>row[<span class="st">'feature'</span>]<span class="sc">:20s}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'importance'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-366"><a href="#cb38-366" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-367"><a href="#cb38-367" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Liquidity importance</span></span>
<span id="cb38-368"><a href="#cb38-368" aria-hidden="true" tabindex="-1"></a>    liquidity_features <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> feature_importance[<span class="st">'feature'</span>] </span>
<span id="cb38-369"><a href="#cb38-369" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">if</span> <span class="bu">any</span>(liq <span class="kw">in</span> f <span class="cf">for</span> liq <span class="kw">in</span> [<span class="st">'L'</span>, <span class="st">'M2'</span>, <span class="st">'FED'</span>, <span class="st">'EM'</span>, <span class="st">'EB'</span>, <span class="st">'EL'</span>])]</span>
<span id="cb38-370"><a href="#cb38-370" aria-hidden="true" tabindex="-1"></a>    liquidity_importance <span class="op">=</span> feature_importance[feature_importance[<span class="st">'feature'</span>].isin(liquidity_features)][<span class="st">'importance'</span>].<span class="bu">sum</span>()</span>
<span id="cb38-371"><a href="#cb38-371" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-372"><a href="#cb38-372" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">💧 Total Liquidity Importance: </span><span class="sc">{</span>liquidity_importance<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb38-373"><a href="#cb38-373" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-374"><a href="#cb38-374" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-375"><a href="#cb38-375" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 7: Hypothesis Test</span></span>
<span id="cb38-376"><a href="#cb38-376" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-377"><a href="#cb38-377" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-378"><a href="#cb38-378" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-379"><a href="#cb38-379" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"HYPOTHESIS TEST: LIQUIDITY → HML REGIMES"</span>)</span>
<span id="cb38-380"><a href="#cb38-380" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-381"><a href="#cb38-381" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-382"><a href="#cb38-382" aria-hidden="true" tabindex="-1"></a>    best_cv_acc <span class="op">=</span> results[best_model_name][<span class="st">'cv_mean'</span>]</span>
<span id="cb38-383"><a href="#cb38-383" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span></span>
<span id="cb38-384"><a href="#cb38-384" aria-hidden="true" tabindex="-1"></a>    improvement <span class="op">=</span> best_cv_acc <span class="op">-</span> baseline</span>
<span id="cb38-385"><a href="#cb38-385" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-386"><a href="#cb38-386" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Results:"</span>)</span>
<span id="cb38-387"><a href="#cb38-387" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Baseline:      </span><span class="sc">{</span>baseline<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb38-388"><a href="#cb38-388" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   CV Accuracy:   </span><span class="sc">{</span>best_cv_acc<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb38-389"><a href="#cb38-389" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Improvement:   </span><span class="sc">{</span>improvement<span class="sc">:+.1%}</span><span class="ss">"</span>)</span>
<span id="cb38-390"><a href="#cb38-390" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Lift:          </span><span class="sc">{</span>best_cv_acc<span class="op">/</span>baseline<span class="sc">:.2f}</span><span class="ss">x"</span>)</span>
<span id="cb38-391"><a href="#cb38-391" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-392"><a href="#cb38-392" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_cv_acc <span class="op">&gt;=</span> <span class="fl">0.50</span>:</span>
<span id="cb38-393"><a href="#cb38-393" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">   ✅ STRONG SUPPORT for hypothesis"</span>)</span>
<span id="cb38-394"><a href="#cb38-394" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> best_cv_acc <span class="op">&gt;=</span> <span class="fl">0.42</span>:</span>
<span id="cb38-395"><a href="#cb38-395" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">   ✔️  MODERATE SUPPORT for hypothesis"</span>)</span>
<span id="cb38-396"><a href="#cb38-396" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb38-397"><a href="#cb38-397" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">   ❌ WEAK SUPPORT for hypothesis"</span>)</span>
<span id="cb38-398"><a href="#cb38-398" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-399"><a href="#cb38-399" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-400"><a href="#cb38-400" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 8: Final Assignment</span></span>
<span id="cb38-401"><a href="#cb38-401" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb38-402"><a href="#cb38-402" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-403"><a href="#cb38-403" aria-hidden="true" tabindex="-1"></a>    df_final <span class="op">=</span> df_crisis.copy()</span>
<span id="cb38-404"><a href="#cb38-404" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">'final_regime'</span>] <span class="op">=</span> np.nan</span>
<span id="cb38-405"><a href="#cb38-405" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">'final_regime_label'</span>] <span class="op">=</span> <span class="st">'Unknown'</span></span>
<span id="cb38-406"><a href="#cb38-406" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-407"><a href="#cb38-407" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crisis</span></span>
<span id="cb38-408"><a href="#cb38-408" aria-hidden="true" tabindex="-1"></a>    df_final.loc[df_final[<span class="st">'is_crisis'</span>], <span class="st">'final_regime'</span>] <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb38-409"><a href="#cb38-409" aria-hidden="true" tabindex="-1"></a>    df_final.loc[df_final[<span class="st">'is_crisis'</span>], <span class="st">'final_regime_label'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb38-410"><a href="#cb38-410" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-411"><a href="#cb38-411" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HML regimes (predicted)</span></span>
<span id="cb38-412"><a href="#cb38-412" aria-hidden="true" tabindex="-1"></a>    df_final.loc[X.index, <span class="st">'final_regime'</span>] <span class="op">=</span> best_model.predict(X)</span>
<span id="cb38-413"><a href="#cb38-413" aria-hidden="true" tabindex="-1"></a>    df_final.loc[X.index, <span class="st">'final_regime_label'</span>] <span class="op">=</span> pd.Series(</span>
<span id="cb38-414"><a href="#cb38-414" aria-hidden="true" tabindex="-1"></a>        best_model.predict(X),</span>
<span id="cb38-415"><a href="#cb38-415" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>X.index</span>
<span id="cb38-416"><a href="#cb38-416" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'Growth-Friendly'</span>, <span class="dv">1</span>: <span class="st">'Neutral'</span>, <span class="dv">2</span>: <span class="st">'Value-Friendly'</span>})</span>
<span id="cb38-417"><a href="#cb38-417" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-418"><a href="#cb38-418" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Also keep actual HML regime</span></span>
<span id="cb38-419"><a href="#cb38-419" aria-hidden="true" tabindex="-1"></a>    df_final.loc[df_regimes.index, <span class="st">'actual_hml_regime'</span>] <span class="op">=</span> df_regimes[<span class="st">'hml_regime'</span>]</span>
<span id="cb38-420"><a href="#cb38-420" aria-hidden="true" tabindex="-1"></a>    df_final.loc[df_regimes.index, <span class="st">'actual_hml_regime_label'</span>] <span class="op">=</span> df_regimes[<span class="st">'hml_regime_label'</span>]</span>
<span id="cb38-421"><a href="#cb38-421" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-422"><a href="#cb38-422" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Final Distribution:"</span>)</span>
<span id="cb38-423"><a href="#cb38-423" aria-hidden="true" tabindex="-1"></a>    dist <span class="op">=</span> df_final[<span class="st">'final_regime_label'</span>].value_counts()</span>
<span id="cb38-424"><a href="#cb38-424" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Crisis'</span>, <span class="st">'Growth-Friendly'</span>, <span class="st">'Neutral'</span>, <span class="st">'Value-Friendly'</span>, <span class="st">'Unknown'</span>]:</span>
<span id="cb38-425"><a href="#cb38-425" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> regime <span class="kw">in</span> dist.index:</span>
<span id="cb38-426"><a href="#cb38-426" aria-hidden="true" tabindex="-1"></a>            count <span class="op">=</span> dist[regime]</span>
<span id="cb38-427"><a href="#cb38-427" aria-hidden="true" tabindex="-1"></a>            pct <span class="op">=</span> count <span class="op">/</span> <span class="bu">len</span>(df_final) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb38-428"><a href="#cb38-428" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>regime<span class="sc">:16s}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">:4d}</span><span class="ss"> (</span><span class="sc">{</span>pct<span class="sc">:5.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb38-429"><a href="#cb38-429" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-430"><a href="#cb38-430" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-431"><a href="#cb38-431" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ COMPLETE"</span>)</span>
<span id="cb38-432"><a href="#cb38-432" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-433"><a href="#cb38-433" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-434"><a href="#cb38-434" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_final, results, feature_importance</span>
<span id="cb38-435"><a href="#cb38-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-436"><a href="#cb38-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-437"><a href="#cb38-437" aria-hidden="true" tabindex="-1"></a><span class="co"># Run with crisis detection</span></span>
<span id="cb38-438"><a href="#cb38-438" aria-hidden="true" tabindex="-1"></a>df_hml_regimes, hml_results, hml_feat_imp <span class="op">=</span> build_hml_regime_classification_with_crisis(</span>
<span id="cb38-439"><a href="#cb38-439" aria-hidden="true" tabindex="-1"></a>    df_features_aug,</span>
<span id="cb38-440"><a href="#cb38-440" aria-hidden="true" tabindex="-1"></a>    L_index</span>
<span id="cb38-441"><a href="#cb38-441" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
HML REGIME CLASSIFICATION (WITH CRISIS DETECTION)
================================================================================

✅ Aligned: 185 observations

================================================================================
STEP 1: CRISIS DETECTION
================================================================================

📊 Crisis Features Created: 10
   Valid crisis detection samples: 168/185

✅ Crisis Detection Complete:
   Crisis periods:     0 months (0.0%)
   Non-crisis periods: 185 months (100.0%)

📊 Non-Crisis Data: 185 observations

================================================================================
STEP 2: DEFINE HML REGIMES (NON-CRISIS PERIODS)
================================================================================

📊 Using: 12-month rolling HML
   Range: -0.42 to 0.31
   Mean:  -0.00
   Std:   0.13

📊 HML Regime Thresholds (Non-Crisis):
   33rd percentile: -0.07
   67th percentile: 0.06

📊 HML Regime Distribution (Non-Crisis):
   Growth-Friendly :   61 ( 33.0%)
      Mean HML: -0.14, Mean L: +0.16
   Neutral         :   63 ( 34.1%)
      Mean HML: -0.00, Mean L: -0.27
   Value-Friendly  :   61 ( 33.0%)
      Mean HML: +0.13, Mean L: +0.12

================================================================================
STEP 3: LIQUIDITY FEATURES
================================================================================

✅ Selected 18 features

📊 ML Dataset: 185 samples × 18 features

================================================================================
STEP 4: MODEL TRAINING &amp; CROSS-VALIDATION
================================================================================

======================================================================
Random Forest
======================================================================

📊 Cross-Validation (Time Series):
   Mean Accuracy: 0.293 (±0.068)
   Fold Scores:   ['0.300', '0.300', '0.167', '0.367', '0.333']
   vs Baseline:   -4.0%

📈 In-Sample Accuracy: 0.924

📋 Classification Report:
                 precision    recall  f1-score   support

Growth-Friendly       0.94      0.97      0.95        61
        Neutral       0.92      0.89      0.90        63
 Value-Friendly       0.92      0.92      0.92        61

       accuracy                           0.92       185
      macro avg       0.92      0.92      0.92       185
   weighted avg       0.92      0.92      0.92       185


🎯 Confusion Matrix (%):
              Pred_Growth  Pred_Neutral  Pred_Value
True_Growth          96.7           3.3         0.0
True_Neutral          3.2          88.9         7.9
True_Value            3.3           4.9        91.8

======================================================================
XGBoost
======================================================================

📊 Cross-Validation (Time Series):
   Mean Accuracy: 0.293 (±0.108)
   Fold Scores:   ['0.433', '0.167', '0.167', '0.333', '0.367']
   vs Baseline:   -4.0%

📈 In-Sample Accuracy: 1.000

📋 Classification Report:
                 precision    recall  f1-score   support

Growth-Friendly       1.00      1.00      1.00        61
        Neutral       1.00      1.00      1.00        63
 Value-Friendly       1.00      1.00      1.00        61

       accuracy                           1.00       185
      macro avg       1.00      1.00      1.00       185
   weighted avg       1.00      1.00      1.00       185


🎯 Confusion Matrix (%):
              Pred_Growth  Pred_Neutral  Pred_Value
True_Growth         100.0           0.0         0.0
True_Neutral          0.0         100.0         0.0
True_Value            0.0           0.0       100.0

================================================================================
STEP 5: FEATURE IMPORTANCE
================================================================================

🏆 Best Model: Random Forest (CV: 0.293)

📊 Top 15 Features:
   💧 EB                  : 0.1444
   💧 EM                  : 0.1342
      Credit_Spread       : 0.0739
      VIX                 : 0.0566
   💧 FED_BS_growth       : 0.0543
   💧 L_momentum          : 0.0534
      Term_Spread         : 0.0515
   💧 EL_3y               : 0.0507
   💧 dlog_FED_BS         : 0.0505
   💧 L_ma_6              : 0.0471
   💧 L_accel             : 0.0464
   💧 HML_lag6            : 0.0436
   💧 dlog_M2             : 0.0347
   💧 L_ma_3              : 0.0329
   💧 HML_lag3            : 0.0327

💧 Total Liquidity Importance: 78.5%

================================================================================
HYPOTHESIS TEST: LIQUIDITY → HML REGIMES
================================================================================

📊 Results:
   Baseline:      33.3%
   CV Accuracy:   29.3%
   Improvement:   -4.0%
   Lift:          0.88x

   ❌ WEAK SUPPORT for hypothesis

📊 Final Distribution:
   Growth-Friendly :   63 ( 34.1%)
   Neutral         :   61 ( 33.0%)
   Value-Friendly  :   61 ( 33.0%)

================================================================================
✅ COMPLETE
================================================================================</code></pre>
</div>
</div>
<div id="735bfb86-be83-4617-bffa-73ad26f691fc" class="cell" data-execution_count="130">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>factor_returns_by_regime <span class="op">=</span> (</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    df_regimes_fixed.groupby(<span class="st">"regime_label"</span>)[[<span class="st">"mkt_excess"</span>, <span class="st">"hml"</span>, <span class="st">"rmw"</span>, <span class="st">"cma"</span>]]</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    .mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factor_returns_by_regime)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>              mkt_excess       hml       rmw       cma
regime_label                                          
High            0.692131  0.374426  0.289180  0.525246
Neutral         0.826190  0.099524  0.430159 -0.144762
Tight           1.039672 -0.323115  0.007049 -0.536230</code></pre>
</div>
</div>
<div id="f9f80a4a-cecf-4945-bf5d-5e78706a8289" class="cell" data-execution_count="139">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_hml_regime_classification_with_crisis(df, L_series):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Detect crisis periods (Isolation Forest)</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Classify NON-CRISIS periods by HML regimes</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Predict HML regimes from liquidity features</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.ensemble <span class="im">import</span> IsolationForest, RandomForestClassifier</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit, cross_val_score</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, confusion_matrix</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"HML REGIME CLASSIFICATION (WITH CRISIS DETECTION)"</span>)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 0: Data Alignment</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>    common_idx <span class="op">=</span> df.index.intersection(L_series.index)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>    df_aligned <span class="op">=</span> df.loc[common_idx].copy()</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>    df_aligned[<span class="st">'L'</span>] <span class="op">=</span> L_series.loc[common_idx]</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Aligned: </span><span class="sc">{</span><span class="bu">len</span>(df_aligned)<span class="sc">}</span><span class="ss"> observations"</span>)</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 1: Crisis Detection (Isolation Forest)</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 1: CRISIS DETECTION"</span>)</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>    df_crisis <span class="op">=</span> df_aligned.copy()</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create crisis features (volatility, drawdowns, tail events)</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'ret_vol_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).std()</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'ret_vol_12m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">6</span>).std()</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'L_vol_3m'</span>] <span class="op">=</span> df_crisis[<span class="st">'L'</span>].rolling(<span class="dv">3</span>, min_periods<span class="op">=</span><span class="dv">2</span>).std()</span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'L_vol_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'L'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).std()</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return features</span></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'abs_ret'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].<span class="bu">abs</span>()</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'cum_ret_3m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">3</span>, min_periods<span class="op">=</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'cum_ret_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'mkt_excess'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).<span class="bu">sum</span>()</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drawdown</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>    cumret <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df_crisis[<span class="st">'mkt_excess'</span>]<span class="op">/</span><span class="dv">100</span>).cumprod()</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>    running_max <span class="op">=</span> cumret.expanding().<span class="bu">max</span>()</span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'drawdown'</span>] <span class="op">=</span> (cumret <span class="op">/</span> running_max <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>    df_crisis[<span class="st">'max_dd_6m'</span>] <span class="op">=</span> df_crisis[<span class="st">'drawdown'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).<span class="bu">min</span>()</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crisis features list</span></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>    crisis_features <span class="op">=</span> [<span class="st">'ret_vol_6m'</span>, <span class="st">'ret_vol_12m'</span>, <span class="st">'L_vol_3m'</span>, <span class="st">'L_vol_6m'</span>, </span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'abs_ret'</span>, <span class="st">'cum_ret_3m'</span>, <span class="st">'cum_ret_6m'</span>, <span class="st">'max_dd_6m'</span>]</span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add VIX if available</span></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'VIX'</span> <span class="kw">in</span> df_crisis.columns:</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'VIX_level'</span>] <span class="op">=</span> df_crisis[<span class="st">'VIX'</span>]</span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'VIX_zscore'</span>] <span class="op">=</span> (df_crisis[<span class="st">'VIX'</span>] <span class="op">-</span> df_crisis[<span class="st">'VIX'</span>].rolling(<span class="dv">60</span>, min_periods<span class="op">=</span><span class="dv">30</span>).mean()) <span class="op">/</span> <span class="op">\</span></span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>                                   df_crisis[<span class="st">'VIX'</span>].rolling(<span class="dv">60</span>, min_periods<span class="op">=</span><span class="dv">30</span>).std()</span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>        crisis_features.extend([<span class="st">'VIX_level'</span>, <span class="st">'VIX_zscore'</span>])</span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Crisis Features Created: </span><span class="sc">{</span><span class="bu">len</span>(crisis_features)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract and clean crisis data</span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>    crisis_data <span class="op">=</span> df_crisis[crisis_features].copy()</span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>    crisis_data <span class="op">=</span> crisis_data.fillna(method<span class="op">=</span><span class="st">'bfill'</span>, limit<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>    crisis_data <span class="op">=</span> crisis_data.dropna()</span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Valid crisis detection samples: </span><span class="sc">{</span><span class="bu">len</span>(crisis_data)<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(df_crisis)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(crisis_data) <span class="op">&gt;=</span> <span class="dv">20</span>:</span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit Isolation Forest</span></span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>        iso_forest <span class="op">=</span> IsolationForest(</span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a>            contamination<span class="op">=</span><span class="fl">0.05</span>,  <span class="co"># Expect ~5% crisis periods</span></span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a>            max_samples<span class="op">=</span><span class="st">'auto'</span></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a>        outlier_labels <span class="op">=</span> iso_forest.fit_predict(crisis_data.values)</span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Crisis = outlier + negative return (&lt; -2%)</span></span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a>        is_crisis_candidate <span class="op">=</span> (outlier_labels <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a>        is_negative_return <span class="op">=</span> (df_crisis.loc[crisis_data.index, <span class="st">'mkt_excess'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="dv">2</span>)</span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'is_crisis'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a>        df_crisis.loc[crisis_data.index, <span class="st">'is_crisis'</span>] <span class="op">=</span> is_crisis_candidate</span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a>        n_crisis <span class="op">=</span> df_crisis[<span class="st">'is_crisis'</span>].<span class="bu">sum</span>()</span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a>        crisis_pct <span class="op">=</span> n_crisis <span class="op">/</span> <span class="bu">len</span>(df_crisis) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Crisis Detection Complete:"</span>)</span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Crisis periods:     </span><span class="sc">{</span>n_crisis<span class="sc">}</span><span class="ss"> months (</span><span class="sc">{</span>crisis_pct<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb42-99"><a href="#cb42-99" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Non-crisis periods: </span><span class="sc">{</span><span class="bu">len</span>(df_crisis) <span class="op">-</span> n_crisis<span class="sc">}</span><span class="ss"> months (</span><span class="sc">{</span><span class="dv">100</span><span class="op">-</span>crisis_pct<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb42-100"><a href="#cb42-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-101"><a href="#cb42-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Show detected crisis periods</span></span>
<span id="cb42-102"><a href="#cb42-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n_crisis <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb42-103"><a href="#cb42-103" aria-hidden="true" tabindex="-1"></a>            crisis_periods <span class="op">=</span> df_crisis[df_crisis[<span class="st">'is_crisis'</span>]].index</span>
<span id="cb42-104"><a href="#cb42-104" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📅 Detected Crisis Months:"</span>)</span>
<span id="cb42-105"><a href="#cb42-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, date <span class="kw">in</span> <span class="bu">enumerate</span>(crisis_periods[:<span class="dv">10</span>], <span class="dv">1</span>):</span>
<span id="cb42-106"><a href="#cb42-106" aria-hidden="true" tabindex="-1"></a>                ret <span class="op">=</span> df_crisis.loc[date, <span class="st">'mkt_excess'</span>]</span>
<span id="cb42-107"><a href="#cb42-107" aria-hidden="true" tabindex="-1"></a>                L_val <span class="op">=</span> df_crisis.loc[date, <span class="st">'L'</span>]</span>
<span id="cb42-108"><a href="#cb42-108" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>i<span class="sc">:2d}</span><span class="ss">. </span><span class="sc">{</span>date<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss">: Return = </span><span class="sc">{</span>ret<span class="sc">:+.2f}</span><span class="ss">%, L = </span><span class="sc">{</span>L_val<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-109"><a href="#cb42-109" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(crisis_periods) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb42-110"><a href="#cb42-110" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"   ... and </span><span class="sc">{</span><span class="bu">len</span>(crisis_periods) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> more"</span>)</span>
<span id="cb42-111"><a href="#cb42-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb42-112"><a href="#cb42-112" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">⚠️  Insufficient data for crisis detection, marking all as non-crisis"</span>)</span>
<span id="cb42-113"><a href="#cb42-113" aria-hidden="true" tabindex="-1"></a>        df_crisis[<span class="st">'is_crisis'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb42-114"><a href="#cb42-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-115"><a href="#cb42-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter to non-crisis periods for HML regime analysis</span></span>
<span id="cb42-116"><a href="#cb42-116" aria-hidden="true" tabindex="-1"></a>    df_noncrisis <span class="op">=</span> df_crisis[<span class="op">~</span>df_crisis[<span class="st">'is_crisis'</span>]].copy()</span>
<span id="cb42-117"><a href="#cb42-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-118"><a href="#cb42-118" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Non-Crisis Data: </span><span class="sc">{</span><span class="bu">len</span>(df_noncrisis)<span class="sc">}</span><span class="ss"> observations"</span>)</span>
<span id="cb42-119"><a href="#cb42-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-120"><a href="#cb42-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-121"><a href="#cb42-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 2: Define HML Regimes (Non-Crisis Only)</span></span>
<span id="cb42-122"><a href="#cb42-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-123"><a href="#cb42-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-124"><a href="#cb42-124" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-125"><a href="#cb42-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 2: DEFINE HML REGIMES (NON-CRISIS PERIODS)"</span>)</span>
<span id="cb42-126"><a href="#cb42-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-127"><a href="#cb42-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-128"><a href="#cb42-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for HML data</span></span>
<span id="cb42-129"><a href="#cb42-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'hml'</span> <span class="kw">not</span> <span class="kw">in</span> df_noncrisis.columns <span class="kw">and</span> <span class="st">'HML'</span> <span class="kw">not</span> <span class="kw">in</span> df_noncrisis.columns:</span>
<span id="cb42-130"><a href="#cb42-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"No HML column found in dataframe"</span>)</span>
<span id="cb42-131"><a href="#cb42-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-132"><a href="#cb42-132" aria-hidden="true" tabindex="-1"></a>    hml_col <span class="op">=</span> <span class="st">'hml'</span> <span class="cf">if</span> <span class="st">'hml'</span> <span class="kw">in</span> df_noncrisis.columns <span class="cf">else</span> <span class="st">'HML'</span></span>
<span id="cb42-133"><a href="#cb42-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-134"><a href="#cb42-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use 12-month rolling HML for smoother regimes</span></span>
<span id="cb42-135"><a href="#cb42-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if 'HML_12m' in df_noncrisis.columns:</span></span>
<span id="cb42-136"><a href="#cb42-136" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     hml_metric = df_noncrisis['HML_12m']</span></span>
<span id="cb42-137"><a href="#cb42-137" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     metric_col = 'HML_12m'</span></span>
<span id="cb42-138"><a href="#cb42-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     metric_name = "12-month rolling HML"</span></span>
<span id="cb42-139"><a href="#cb42-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># else:</span></span>
<span id="cb42-140"><a href="#cb42-140" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     df_noncrisis['HML_12m'] = df_noncrisis[hml_col].rolling(12, min_periods=6).sum()</span></span>
<span id="cb42-141"><a href="#cb42-141" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     hml_metric = df_noncrisis['HML_12m']</span></span>
<span id="cb42-142"><a href="#cb42-142" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     metric_col = 'HML_12m'</span></span>
<span id="cb42-143"><a href="#cb42-143" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     metric_name = "12-month rolling HML (created)"</span></span>
<span id="cb42-144"><a href="#cb42-144" aria-hidden="true" tabindex="-1"></a>    df_noncrisis[<span class="st">'HML_forward_6m'</span>] <span class="op">=</span> df_noncrisis[hml_col].shift(<span class="op">-</span><span class="dv">6</span>).rolling(</span>
<span id="cb42-145"><a href="#cb42-145" aria-hidden="true" tabindex="-1"></a>        <span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span></span>
<span id="cb42-146"><a href="#cb42-146" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">sum</span>()</span>
<span id="cb42-147"><a href="#cb42-147" aria-hidden="true" tabindex="-1"></a>    hml_metric <span class="op">=</span> df_noncrisis[<span class="st">'HML_forward_6m'</span>]</span>
<span id="cb42-148"><a href="#cb42-148" aria-hidden="true" tabindex="-1"></a>    metric_col <span class="op">=</span> <span class="st">'HML_forward_6m'</span></span>
<span id="cb42-149"><a href="#cb42-149" aria-hidden="true" tabindex="-1"></a>    metric_name <span class="op">=</span> <span class="st">"6-month FORWARD HML"</span></span>
<span id="cb42-150"><a href="#cb42-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-151"><a href="#cb42-151" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Using: </span><span class="sc">{</span>metric_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-152"><a href="#cb42-152" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Range: </span><span class="sc">{</span>hml_metric<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.2f}</span><span class="ss"> to </span><span class="sc">{</span>hml_metric<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-153"><a href="#cb42-153" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Mean:  </span><span class="sc">{</span>hml_metric<span class="sc">.</span>mean()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-154"><a href="#cb42-154" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Std:   </span><span class="sc">{</span>hml_metric<span class="sc">.</span>std()<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-155"><a href="#cb42-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-156"><a href="#cb42-156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove NaN BEFORE creating regimes</span></span>
<span id="cb42-157"><a href="#cb42-157" aria-hidden="true" tabindex="-1"></a>    df_noncrisis_valid <span class="op">=</span> df_noncrisis.dropna(subset<span class="op">=</span>[<span class="st">'HML_forward_6m'</span>]).copy()</span>
<span id="cb42-158"><a href="#cb42-158" aria-hidden="true" tabindex="-1"></a>    hml_metric_valid <span class="op">=</span> df_noncrisis_valid[<span class="st">'HML_forward_6m'</span>]</span>
<span id="cb42-159"><a href="#cb42-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-160"><a href="#cb42-160" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 After removing NaN: </span><span class="sc">{</span><span class="bu">len</span>(df_noncrisis_valid)<span class="sc">}</span><span class="ss"> observations"</span>)</span>
<span id="cb42-161"><a href="#cb42-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-162"><a href="#cb42-162" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define regime thresholds (tertiles on NON-CRISIS data)</span></span>
<span id="cb42-163"><a href="#cb42-163" aria-hidden="true" tabindex="-1"></a>    q33 <span class="op">=</span> hml_metric.quantile(<span class="fl">0.33</span>)</span>
<span id="cb42-164"><a href="#cb42-164" aria-hidden="true" tabindex="-1"></a>    q67 <span class="op">=</span> hml_metric.quantile(<span class="fl">0.67</span>)</span>
<span id="cb42-165"><a href="#cb42-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-166"><a href="#cb42-166" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 HML Regime Thresholds (Non-Crisis):"</span>)</span>
<span id="cb42-167"><a href="#cb42-167" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   33rd percentile: </span><span class="sc">{</span>q33<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-168"><a href="#cb42-168" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   67th percentile: </span><span class="sc">{</span>q67<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-169"><a href="#cb42-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-170"><a href="#cb42-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create regime labels</span></span>
<span id="cb42-171"><a href="#cb42-171" aria-hidden="true" tabindex="-1"></a>    df_noncrisis[<span class="st">'hml_regime'</span>] <span class="op">=</span> pd.cut(</span>
<span id="cb42-172"><a href="#cb42-172" aria-hidden="true" tabindex="-1"></a>        hml_metric_valid,</span>
<span id="cb42-173"><a href="#cb42-173" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span>[<span class="op">-</span>np.inf, q33, q67, np.inf],</span>
<span id="cb42-174"><a href="#cb42-174" aria-hidden="true" tabindex="-1"></a>        labels<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb42-175"><a href="#cb42-175" aria-hidden="true" tabindex="-1"></a>    ).astype(<span class="bu">int</span>)</span>
<span id="cb42-176"><a href="#cb42-176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-177"><a href="#cb42-177" aria-hidden="true" tabindex="-1"></a>    df_noncrisis[<span class="st">'hml_regime_label'</span>] <span class="op">=</span> df_noncrisis[<span class="st">'hml_regime'</span>].<span class="bu">map</span>({</span>
<span id="cb42-178"><a href="#cb42-178" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span>: <span class="st">'Growth-Friendly'</span>,</span>
<span id="cb42-179"><a href="#cb42-179" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span>: <span class="st">'Neutral'</span>, </span>
<span id="cb42-180"><a href="#cb42-180" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span>: <span class="st">'Value-Friendly'</span></span>
<span id="cb42-181"><a href="#cb42-181" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb42-182"><a href="#cb42-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-183"><a href="#cb42-183" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove NaN regimes</span></span>
<span id="cb42-184"><a href="#cb42-184" aria-hidden="true" tabindex="-1"></a>    df_regimes <span class="op">=</span> df_noncrisis.dropna(subset<span class="op">=</span>[<span class="st">'hml_regime'</span>])</span>
<span id="cb42-185"><a href="#cb42-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-186"><a href="#cb42-186" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 HML Regime Distribution (Non-Crisis):"</span>)</span>
<span id="cb42-187"><a href="#cb42-187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime, label <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">'Growth-Friendly'</span>), (<span class="dv">1</span>, <span class="st">'Neutral'</span>), (<span class="dv">2</span>, <span class="st">'Value-Friendly'</span>)]:</span>
<span id="cb42-188"><a href="#cb42-188" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> df_regimes[<span class="st">'hml_regime'</span>] <span class="op">==</span> regime</span>
<span id="cb42-189"><a href="#cb42-189" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> mask.<span class="bu">sum</span>()</span>
<span id="cb42-190"><a href="#cb42-190" aria-hidden="true" tabindex="-1"></a>        pct <span class="op">=</span> count <span class="op">/</span> <span class="bu">len</span>(df_regimes) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-191"><a href="#cb42-191" aria-hidden="true" tabindex="-1"></a>        mean_hml <span class="op">=</span> df_regimes.loc[mask, metric_col].mean()</span>
<span id="cb42-192"><a href="#cb42-192" aria-hidden="true" tabindex="-1"></a>        mean_L <span class="op">=</span> df_regimes.loc[mask, <span class="st">'L'</span>].mean()</span>
<span id="cb42-193"><a href="#cb42-193" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>label<span class="sc">:16s}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">:4d}</span><span class="ss"> (</span><span class="sc">{</span>pct<span class="sc">:5.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb42-194"><a href="#cb42-194" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"      Mean HML: </span><span class="sc">{</span>mean_hml<span class="sc">:+.2f}</span><span class="ss">, Mean L: </span><span class="sc">{</span>mean_L<span class="sc">:+.2f}</span><span class="ss">"</span>)</span>
<span id="cb42-195"><a href="#cb42-195" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-196"><a href="#cb42-196" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-197"><a href="#cb42-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 3: Feature Engineering (Liquidity)</span></span>
<span id="cb42-198"><a href="#cb42-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-199"><a href="#cb42-199" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-200"><a href="#cb42-200" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-201"><a href="#cb42-201" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 3: LIQUIDITY FEATURES"</span>)</span>
<span id="cb42-202"><a href="#cb42-202" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-203"><a href="#cb42-203" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-204"><a href="#cb42-204" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> []</span>
<span id="cb42-205"><a href="#cb42-205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-206"><a href="#cb42-206" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Core liquidity components</span></span>
<span id="cb42-207"><a href="#cb42-207" aria-hidden="true" tabindex="-1"></a>    liq_features <span class="op">=</span> [<span class="st">'dlog_M2'</span>, <span class="st">'dlog_FED_BS'</span>, <span class="st">'EM'</span>, <span class="st">'EB'</span>, <span class="st">'EL_3y'</span>]</span>
<span id="cb42-208"><a href="#cb42-208" aria-hidden="true" tabindex="-1"></a>    feature_cols.extend([f <span class="cf">for</span> f <span class="kw">in</span> liq_features <span class="cf">if</span> f <span class="kw">in</span> df_regimes.columns])</span>
<span id="cb42-209"><a href="#cb42-209" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-210"><a href="#cb42-210" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rates and spreads</span></span>
<span id="cb42-211"><a href="#cb42-211" aria-hidden="true" tabindex="-1"></a>    rate_features <span class="op">=</span> [<span class="st">'Term_Spread'</span>, <span class="st">'Credit_Spread'</span>, <span class="st">'Real_Rate'</span>]</span>
<span id="cb42-212"><a href="#cb42-212" aria-hidden="true" tabindex="-1"></a>    feature_cols.extend([f <span class="cf">for</span> f <span class="kw">in</span> rate_features <span class="cf">if</span> f <span class="kw">in</span> df_regimes.columns])</span>
<span id="cb42-213"><a href="#cb42-213" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-214"><a href="#cb42-214" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Market indicators</span></span>
<span id="cb42-215"><a href="#cb42-215" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'VIX'</span> <span class="kw">in</span> df_regimes.columns:</span>
<span id="cb42-216"><a href="#cb42-216" aria-hidden="true" tabindex="-1"></a>        feature_cols.append(<span class="st">'VIX'</span>)</span>
<span id="cb42-217"><a href="#cb42-217" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-218"><a href="#cb42-218" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Growth rates</span></span>
<span id="cb42-219"><a href="#cb42-219" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'M2_growth'</span> <span class="kw">in</span> df_regimes.columns:</span>
<span id="cb42-220"><a href="#cb42-220" aria-hidden="true" tabindex="-1"></a>        feature_cols.append(<span class="st">'M2_growth'</span>)</span>
<span id="cb42-221"><a href="#cb42-221" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'FED_BS_growth'</span> <span class="kw">in</span> df_regimes.columns:</span>
<span id="cb42-222"><a href="#cb42-222" aria-hidden="true" tabindex="-1"></a>        feature_cols.append(<span class="st">'FED_BS_growth'</span>)</span>
<span id="cb42-223"><a href="#cb42-223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-224"><a href="#cb42-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LIQUIDITY INDEX (L)</span></span>
<span id="cb42-225"><a href="#cb42-225" aria-hidden="true" tabindex="-1"></a>    feature_cols.append(<span class="st">'L'</span>)</span>
<span id="cb42-226"><a href="#cb42-226" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-227"><a href="#cb42-227" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Technical on L</span></span>
<span id="cb42-228"><a href="#cb42-228" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'L_ma_3'</span>] <span class="op">=</span> df_regimes[<span class="st">'L'</span>].rolling(<span class="dv">3</span>, min_periods<span class="op">=</span><span class="dv">1</span>).mean()</span>
<span id="cb42-229"><a href="#cb42-229" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'L_ma_6'</span>] <span class="op">=</span> df_regimes[<span class="st">'L'</span>].rolling(<span class="dv">6</span>, min_periods<span class="op">=</span><span class="dv">3</span>).mean()</span>
<span id="cb42-230"><a href="#cb42-230" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'L_momentum'</span>] <span class="op">=</span> df_regimes[<span class="st">'L'</span>].diff(<span class="dv">3</span>)</span>
<span id="cb42-231"><a href="#cb42-231" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'L_accel'</span>] <span class="op">=</span> df_regimes[<span class="st">'L_momentum'</span>].diff(<span class="dv">3</span>)</span>
<span id="cb42-232"><a href="#cb42-232" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-233"><a href="#cb42-233" aria-hidden="true" tabindex="-1"></a>    feature_cols.extend([<span class="st">'L_ma_3'</span>, <span class="st">'L_ma_6'</span>, <span class="st">'L_momentum'</span>, <span class="st">'L_accel'</span>])</span>
<span id="cb42-234"><a href="#cb42-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-235"><a href="#cb42-235" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged HML (control for momentum)</span></span>
<span id="cb42-236"><a href="#cb42-236" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'HML_lag3'</span>] <span class="op">=</span> df_regimes[hml_col].shift(<span class="dv">3</span>)</span>
<span id="cb42-237"><a href="#cb42-237" aria-hidden="true" tabindex="-1"></a>    df_regimes[<span class="st">'HML_lag6'</span>] <span class="op">=</span> df_regimes[hml_col].shift(<span class="dv">6</span>)</span>
<span id="cb42-238"><a href="#cb42-238" aria-hidden="true" tabindex="-1"></a>    feature_cols.extend([<span class="st">'HML_lag3'</span>, <span class="st">'HML_lag6'</span>])</span>
<span id="cb42-239"><a href="#cb42-239" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-240"><a href="#cb42-240" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✅ Selected </span><span class="sc">{</span><span class="bu">len</span>(feature_cols)<span class="sc">}</span><span class="ss"> features"</span>)</span>
<span id="cb42-241"><a href="#cb42-241" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-242"><a href="#cb42-242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-243"><a href="#cb42-243" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 4: Prepare ML Dataset</span></span>
<span id="cb42-244"><a href="#cb42-244" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-245"><a href="#cb42-245" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-246"><a href="#cb42-246" aria-hidden="true" tabindex="-1"></a>    X_raw <span class="op">=</span> df_regimes[feature_cols].copy()</span>
<span id="cb42-247"><a href="#cb42-247" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df_regimes[<span class="st">'hml_regime'</span>].copy()</span>
<span id="cb42-248"><a href="#cb42-248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-249"><a href="#cb42-249" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Imputation</span></span>
<span id="cb42-250"><a href="#cb42-250" aria-hidden="true" tabindex="-1"></a>    X_imputed <span class="op">=</span> X_raw.fillna(method<span class="op">=</span><span class="st">'ffill'</span>, limit<span class="op">=</span><span class="dv">6</span>).fillna(method<span class="op">=</span><span class="st">'bfill'</span>, limit<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb42-251"><a href="#cb42-251" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-252"><a href="#cb42-252" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> X_imputed.columns:</span>
<span id="cb42-253"><a href="#cb42-253" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> X_imputed[col].isna().<span class="bu">any</span>():</span>
<span id="cb42-254"><a href="#cb42-254" aria-hidden="true" tabindex="-1"></a>            X_imputed[col] <span class="op">=</span> X_imputed[col].fillna(X_imputed[col].median())</span>
<span id="cb42-255"><a href="#cb42-255" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-256"><a href="#cb42-256" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final dataset</span></span>
<span id="cb42-257"><a href="#cb42-257" aria-hidden="true" tabindex="-1"></a>    valid_idx <span class="op">=</span> X_imputed.notna().<span class="bu">all</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">&amp;</span> y.notna()</span>
<span id="cb42-258"><a href="#cb42-258" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> X_imputed[valid_idx]</span>
<span id="cb42-259"><a href="#cb42-259" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> y[valid_idx]</span>
<span id="cb42-260"><a href="#cb42-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-261"><a href="#cb42-261" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 ML Dataset: </span><span class="sc">{</span><span class="bu">len</span>(X)<span class="sc">}</span><span class="ss"> samples × </span><span class="sc">{</span><span class="bu">len</span>(feature_cols)<span class="sc">}</span><span class="ss"> features"</span>)</span>
<span id="cb42-262"><a href="#cb42-262" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-263"><a href="#cb42-263" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(X) <span class="op">&lt;</span> <span class="dv">50</span>:</span>
<span id="cb42-264"><a href="#cb42-264" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Insufficient data: </span><span class="sc">{</span><span class="bu">len</span>(X)<span class="sc">}</span><span class="ss"> samples"</span>)</span>
<span id="cb42-265"><a href="#cb42-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-266"><a href="#cb42-266" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-267"><a href="#cb42-267" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 5: Train Models with CV</span></span>
<span id="cb42-268"><a href="#cb42-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-269"><a href="#cb42-269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-270"><a href="#cb42-270" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-271"><a href="#cb42-271" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 4: MODEL TRAINING &amp; CROSS-VALIDATION"</span>)</span>
<span id="cb42-272"><a href="#cb42-272" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-273"><a href="#cb42-273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-274"><a href="#cb42-274" aria-hidden="true" tabindex="-1"></a>    tscv <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb42-275"><a href="#cb42-275" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-276"><a href="#cb42-276" aria-hidden="true" tabindex="-1"></a>    models <span class="op">=</span> {</span>
<span id="cb42-277"><a href="#cb42-277" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Random Forest'</span>: RandomForestClassifier(</span>
<span id="cb42-278"><a href="#cb42-278" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb42-279"><a href="#cb42-279" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb42-280"><a href="#cb42-280" aria-hidden="true" tabindex="-1"></a>            min_samples_split<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb42-281"><a href="#cb42-281" aria-hidden="true" tabindex="-1"></a>            min_samples_leaf<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb42-282"><a href="#cb42-282" aria-hidden="true" tabindex="-1"></a>            class_weight<span class="op">=</span><span class="st">'balanced'</span>,</span>
<span id="cb42-283"><a href="#cb42-283" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb42-284"><a href="#cb42-284" aria-hidden="true" tabindex="-1"></a>            n_jobs<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb42-285"><a href="#cb42-285" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb42-286"><a href="#cb42-286" aria-hidden="true" tabindex="-1"></a>        <span class="st">'XGBoost'</span>: XGBClassifier(</span>
<span id="cb42-287"><a href="#cb42-287" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb42-288"><a href="#cb42-288" aria-hidden="true" tabindex="-1"></a>            max_depth<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb42-289"><a href="#cb42-289" aria-hidden="true" tabindex="-1"></a>            learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb42-290"><a href="#cb42-290" aria-hidden="true" tabindex="-1"></a>            subsample<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb42-291"><a href="#cb42-291" aria-hidden="true" tabindex="-1"></a>            colsample_bytree<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb42-292"><a href="#cb42-292" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb42-293"><a href="#cb42-293" aria-hidden="true" tabindex="-1"></a>            eval_metric<span class="op">=</span><span class="st">'mlogloss'</span>,</span>
<span id="cb42-294"><a href="#cb42-294" aria-hidden="true" tabindex="-1"></a>            use_label_encoder<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb42-295"><a href="#cb42-295" aria-hidden="true" tabindex="-1"></a>            n_jobs<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb42-296"><a href="#cb42-296" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-297"><a href="#cb42-297" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb42-298"><a href="#cb42-298" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-299"><a href="#cb42-299" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb42-300"><a href="#cb42-300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-301"><a href="#cb42-301" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, model <span class="kw">in</span> models.items():</span>
<span id="cb42-302"><a href="#cb42-302" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-303"><a href="#cb42-303" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-304"><a href="#cb42-304" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">70</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-305"><a href="#cb42-305" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-306"><a href="#cb42-306" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Cross-validation</span></span>
<span id="cb42-307"><a href="#cb42-307" aria-hidden="true" tabindex="-1"></a>        cv_scores <span class="op">=</span> cross_val_score(model, X, y, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">'accuracy'</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb42-308"><a href="#cb42-308" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-309"><a href="#cb42-309" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Cross-Validation (Time Series):"</span>)</span>
<span id="cb42-310"><a href="#cb42-310" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Mean Accuracy: </span><span class="sc">{</span>cv_scores<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss"> (±</span><span class="sc">{</span>cv_scores<span class="sc">.</span>std()<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb42-311"><a href="#cb42-311" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   Fold Scores:   </span><span class="sc">{</span>[<span class="ss">f'</span><span class="sc">{</span>s<span class="sc">:.3f}</span><span class="ss">'</span> <span class="cf">for</span> s <span class="kw">in</span> cv_scores]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-312"><a href="#cb42-312" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-313"><a href="#cb42-313" aria-hidden="true" tabindex="-1"></a>        baseline <span class="op">=</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span></span>
<span id="cb42-314"><a href="#cb42-314" aria-hidden="true" tabindex="-1"></a>        improvement <span class="op">=</span> cv_scores.mean() <span class="op">-</span> baseline</span>
<span id="cb42-315"><a href="#cb42-315" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   vs Baseline:   </span><span class="sc">{</span>improvement<span class="sc">:+.1%}</span><span class="ss">"</span>)</span>
<span id="cb42-316"><a href="#cb42-316" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-317"><a href="#cb42-317" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train full model</span></span>
<span id="cb42-318"><a href="#cb42-318" aria-hidden="true" tabindex="-1"></a>        model.fit(X, y)</span>
<span id="cb42-319"><a href="#cb42-319" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-320"><a href="#cb42-320" aria-hidden="true" tabindex="-1"></a>        <span class="co"># In-sample</span></span>
<span id="cb42-321"><a href="#cb42-321" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb42-322"><a href="#cb42-322" aria-hidden="true" tabindex="-1"></a>        train_acc <span class="op">=</span> (y_pred <span class="op">==</span> y).mean()</span>
<span id="cb42-323"><a href="#cb42-323" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-324"><a href="#cb42-324" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📈 In-Sample Accuracy: </span><span class="sc">{</span>train_acc<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb42-325"><a href="#cb42-325" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-326"><a href="#cb42-326" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Classification report</span></span>
<span id="cb42-327"><a href="#cb42-327" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📋 Classification Report:"</span>)</span>
<span id="cb42-328"><a href="#cb42-328" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(classification_report(</span>
<span id="cb42-329"><a href="#cb42-329" aria-hidden="true" tabindex="-1"></a>            y, y_pred,</span>
<span id="cb42-330"><a href="#cb42-330" aria-hidden="true" tabindex="-1"></a>            target_names<span class="op">=</span>[<span class="st">'Growth-Friendly'</span>, <span class="st">'Neutral'</span>, <span class="st">'Value-Friendly'</span>],</span>
<span id="cb42-331"><a href="#cb42-331" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span><span class="dv">0</span></span>
<span id="cb42-332"><a href="#cb42-332" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb42-333"><a href="#cb42-333" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-334"><a href="#cb42-334" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Confusion matrix</span></span>
<span id="cb42-335"><a href="#cb42-335" aria-hidden="true" tabindex="-1"></a>        cm <span class="op">=</span> confusion_matrix(y, y_pred)</span>
<span id="cb42-336"><a href="#cb42-336" aria-hidden="true" tabindex="-1"></a>        cm_pct <span class="op">=</span> cm.astype(<span class="st">'float'</span>) <span class="op">/</span> cm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)[:, np.newaxis] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-337"><a href="#cb42-337" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-338"><a href="#cb42-338" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🎯 Confusion Matrix (%):"</span>)</span>
<span id="cb42-339"><a href="#cb42-339" aria-hidden="true" tabindex="-1"></a>        cm_df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb42-340"><a href="#cb42-340" aria-hidden="true" tabindex="-1"></a>            cm_pct,</span>
<span id="cb42-341"><a href="#cb42-341" aria-hidden="true" tabindex="-1"></a>            index<span class="op">=</span>[<span class="st">'True_Growth'</span>, <span class="st">'True_Neutral'</span>, <span class="st">'True_Value'</span>],</span>
<span id="cb42-342"><a href="#cb42-342" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>[<span class="st">'Pred_Growth'</span>, <span class="st">'Pred_Neutral'</span>, <span class="st">'Pred_Value'</span>]</span>
<span id="cb42-343"><a href="#cb42-343" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-344"><a href="#cb42-344" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(cm_df.<span class="bu">round</span>(<span class="dv">1</span>))</span>
<span id="cb42-345"><a href="#cb42-345" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-346"><a href="#cb42-346" aria-hidden="true" tabindex="-1"></a>        results[name] <span class="op">=</span> {</span>
<span id="cb42-347"><a href="#cb42-347" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model'</span>: model,</span>
<span id="cb42-348"><a href="#cb42-348" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cv_scores'</span>: cv_scores,</span>
<span id="cb42-349"><a href="#cb42-349" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cv_mean'</span>: cv_scores.mean(),</span>
<span id="cb42-350"><a href="#cb42-350" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cv_std'</span>: cv_scores.std(),</span>
<span id="cb42-351"><a href="#cb42-351" aria-hidden="true" tabindex="-1"></a>            <span class="st">'train_acc'</span>: train_acc,</span>
<span id="cb42-352"><a href="#cb42-352" aria-hidden="true" tabindex="-1"></a>            <span class="st">'y_pred'</span>: y_pred</span>
<span id="cb42-353"><a href="#cb42-353" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb42-354"><a href="#cb42-354" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-355"><a href="#cb42-355" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-356"><a href="#cb42-356" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 6: Feature Importance</span></span>
<span id="cb42-357"><a href="#cb42-357" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-358"><a href="#cb42-358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-359"><a href="#cb42-359" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-360"><a href="#cb42-360" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"STEP 5: FEATURE IMPORTANCE"</span>)</span>
<span id="cb42-361"><a href="#cb42-361" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-362"><a href="#cb42-362" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-363"><a href="#cb42-363" aria-hidden="true" tabindex="-1"></a>    best_model_name <span class="op">=</span> <span class="bu">max</span>(results, key<span class="op">=</span><span class="kw">lambda</span> k: results[k][<span class="st">'cv_mean'</span>])</span>
<span id="cb42-364"><a href="#cb42-364" aria-hidden="true" tabindex="-1"></a>    best_model <span class="op">=</span> results[best_model_name][<span class="st">'model'</span>]</span>
<span id="cb42-365"><a href="#cb42-365" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-366"><a href="#cb42-366" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">🏆 Best Model: </span><span class="sc">{</span>best_model_name<span class="sc">}</span><span class="ss"> (CV: </span><span class="sc">{</span>results[best_model_name][<span class="st">'cv_mean'</span>]<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb42-367"><a href="#cb42-367" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-368"><a href="#cb42-368" aria-hidden="true" tabindex="-1"></a>    feature_importance <span class="op">=</span> pd.DataFrame({</span>
<span id="cb42-369"><a href="#cb42-369" aria-hidden="true" tabindex="-1"></a>        <span class="st">'feature'</span>: X.columns,</span>
<span id="cb42-370"><a href="#cb42-370" aria-hidden="true" tabindex="-1"></a>        <span class="st">'importance'</span>: best_model.feature_importances_</span>
<span id="cb42-371"><a href="#cb42-371" aria-hidden="true" tabindex="-1"></a>    }).sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb42-372"><a href="#cb42-372" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-373"><a href="#cb42-373" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Top 15 Features:"</span>)</span>
<span id="cb42-374"><a href="#cb42-374" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> feature_importance.head(<span class="dv">15</span>).iterrows():</span>
<span id="cb42-375"><a href="#cb42-375" aria-hidden="true" tabindex="-1"></a>        is_liquidity <span class="op">=</span> <span class="bu">any</span>(liq <span class="kw">in</span> row[<span class="st">'feature'</span>] <span class="cf">for</span> liq <span class="kw">in</span> [<span class="st">'L'</span>, <span class="st">'M2'</span>, <span class="st">'FED'</span>, <span class="st">'EM'</span>, <span class="st">'EB'</span>, <span class="st">'EL'</span>])</span>
<span id="cb42-376"><a href="#cb42-376" aria-hidden="true" tabindex="-1"></a>        marker <span class="op">=</span> <span class="st">"💧"</span> <span class="cf">if</span> is_liquidity <span class="cf">else</span> <span class="st">"  "</span></span>
<span id="cb42-377"><a href="#cb42-377" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>marker<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>row[<span class="st">'feature'</span>]<span class="sc">:20s}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'importance'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb42-378"><a href="#cb42-378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-379"><a href="#cb42-379" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Liquidity importance</span></span>
<span id="cb42-380"><a href="#cb42-380" aria-hidden="true" tabindex="-1"></a>    liquidity_features <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> feature_importance[<span class="st">'feature'</span>] </span>
<span id="cb42-381"><a href="#cb42-381" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">if</span> <span class="bu">any</span>(liq <span class="kw">in</span> f <span class="cf">for</span> liq <span class="kw">in</span> [<span class="st">'L'</span>, <span class="st">'M2'</span>, <span class="st">'FED'</span>, <span class="st">'EM'</span>, <span class="st">'EB'</span>, <span class="st">'EL'</span>])]</span>
<span id="cb42-382"><a href="#cb42-382" aria-hidden="true" tabindex="-1"></a>    liquidity_importance <span class="op">=</span> feature_importance[feature_importance[<span class="st">'feature'</span>].isin(liquidity_features)][<span class="st">'importance'</span>].<span class="bu">sum</span>()</span>
<span id="cb42-383"><a href="#cb42-383" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-384"><a href="#cb42-384" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">💧 Total Liquidity Importance: </span><span class="sc">{</span>liquidity_importance<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb42-385"><a href="#cb42-385" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-386"><a href="#cb42-386" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-387"><a href="#cb42-387" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 7: Hypothesis Test</span></span>
<span id="cb42-388"><a href="#cb42-388" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-389"><a href="#cb42-389" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-390"><a href="#cb42-390" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-391"><a href="#cb42-391" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"HYPOTHESIS TEST: LIQUIDITY → HML REGIMES"</span>)</span>
<span id="cb42-392"><a href="#cb42-392" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-393"><a href="#cb42-393" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-394"><a href="#cb42-394" aria-hidden="true" tabindex="-1"></a>    best_cv_acc <span class="op">=</span> results[best_model_name][<span class="st">'cv_mean'</span>]</span>
<span id="cb42-395"><a href="#cb42-395" aria-hidden="true" tabindex="-1"></a>    baseline <span class="op">=</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span></span>
<span id="cb42-396"><a href="#cb42-396" aria-hidden="true" tabindex="-1"></a>    improvement <span class="op">=</span> best_cv_acc <span class="op">-</span> baseline</span>
<span id="cb42-397"><a href="#cb42-397" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-398"><a href="#cb42-398" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Results:"</span>)</span>
<span id="cb42-399"><a href="#cb42-399" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Baseline:      </span><span class="sc">{</span>baseline<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb42-400"><a href="#cb42-400" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   CV Accuracy:   </span><span class="sc">{</span>best_cv_acc<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb42-401"><a href="#cb42-401" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Improvement:   </span><span class="sc">{</span>improvement<span class="sc">:+.1%}</span><span class="ss">"</span>)</span>
<span id="cb42-402"><a href="#cb42-402" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"   Lift:          </span><span class="sc">{</span>best_cv_acc<span class="op">/</span>baseline<span class="sc">:.2f}</span><span class="ss">x"</span>)</span>
<span id="cb42-403"><a href="#cb42-403" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-404"><a href="#cb42-404" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_cv_acc <span class="op">&gt;=</span> <span class="fl">0.50</span>:</span>
<span id="cb42-405"><a href="#cb42-405" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">   ✅ STRONG SUPPORT for hypothesis"</span>)</span>
<span id="cb42-406"><a href="#cb42-406" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> best_cv_acc <span class="op">&gt;=</span> <span class="fl">0.42</span>:</span>
<span id="cb42-407"><a href="#cb42-407" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">   ✔️  MODERATE SUPPORT for hypothesis"</span>)</span>
<span id="cb42-408"><a href="#cb42-408" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb42-409"><a href="#cb42-409" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">   ❌ WEAK SUPPORT for hypothesis"</span>)</span>
<span id="cb42-410"><a href="#cb42-410" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-411"><a href="#cb42-411" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-412"><a href="#cb42-412" aria-hidden="true" tabindex="-1"></a>    <span class="co"># STEP 8: Final Assignment</span></span>
<span id="cb42-413"><a href="#cb42-413" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ==========================================</span></span>
<span id="cb42-414"><a href="#cb42-414" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-415"><a href="#cb42-415" aria-hidden="true" tabindex="-1"></a>    df_final <span class="op">=</span> df_crisis.copy()</span>
<span id="cb42-416"><a href="#cb42-416" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">'final_regime'</span>] <span class="op">=</span> np.nan</span>
<span id="cb42-417"><a href="#cb42-417" aria-hidden="true" tabindex="-1"></a>    df_final[<span class="st">'final_regime_label'</span>] <span class="op">=</span> <span class="st">'Unknown'</span></span>
<span id="cb42-418"><a href="#cb42-418" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-419"><a href="#cb42-419" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crisis</span></span>
<span id="cb42-420"><a href="#cb42-420" aria-hidden="true" tabindex="-1"></a>    df_final.loc[df_final[<span class="st">'is_crisis'</span>], <span class="st">'final_regime'</span>] <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb42-421"><a href="#cb42-421" aria-hidden="true" tabindex="-1"></a>    df_final.loc[df_final[<span class="st">'is_crisis'</span>], <span class="st">'final_regime_label'</span>] <span class="op">=</span> <span class="st">'Crisis'</span></span>
<span id="cb42-422"><a href="#cb42-422" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-423"><a href="#cb42-423" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HML regimes (predicted)</span></span>
<span id="cb42-424"><a href="#cb42-424" aria-hidden="true" tabindex="-1"></a>    df_final.loc[X.index, <span class="st">'final_regime'</span>] <span class="op">=</span> best_model.predict(X)</span>
<span id="cb42-425"><a href="#cb42-425" aria-hidden="true" tabindex="-1"></a>    df_final.loc[X.index, <span class="st">'final_regime_label'</span>] <span class="op">=</span> pd.Series(</span>
<span id="cb42-426"><a href="#cb42-426" aria-hidden="true" tabindex="-1"></a>        best_model.predict(X),</span>
<span id="cb42-427"><a href="#cb42-427" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>X.index</span>
<span id="cb42-428"><a href="#cb42-428" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'Growth-Friendly'</span>, <span class="dv">1</span>: <span class="st">'Neutral'</span>, <span class="dv">2</span>: <span class="st">'Value-Friendly'</span>})</span>
<span id="cb42-429"><a href="#cb42-429" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-430"><a href="#cb42-430" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Also keep actual HML regime</span></span>
<span id="cb42-431"><a href="#cb42-431" aria-hidden="true" tabindex="-1"></a>    df_final.loc[df_regimes.index, <span class="st">'actual_hml_regime'</span>] <span class="op">=</span> df_regimes[<span class="st">'hml_regime'</span>]</span>
<span id="cb42-432"><a href="#cb42-432" aria-hidden="true" tabindex="-1"></a>    df_final.loc[df_regimes.index, <span class="st">'actual_hml_regime_label'</span>] <span class="op">=</span> df_regimes[<span class="st">'hml_regime_label'</span>]</span>
<span id="cb42-433"><a href="#cb42-433" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-434"><a href="#cb42-434" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">📊 Final Distribution:"</span>)</span>
<span id="cb42-435"><a href="#cb42-435" aria-hidden="true" tabindex="-1"></a>    dist <span class="op">=</span> df_final[<span class="st">'final_regime_label'</span>].value_counts()</span>
<span id="cb42-436"><a href="#cb42-436" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> regime <span class="kw">in</span> [<span class="st">'Crisis'</span>, <span class="st">'Growth-Friendly'</span>, <span class="st">'Neutral'</span>, <span class="st">'Value-Friendly'</span>, <span class="st">'Unknown'</span>]:</span>
<span id="cb42-437"><a href="#cb42-437" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> regime <span class="kw">in</span> dist.index:</span>
<span id="cb42-438"><a href="#cb42-438" aria-hidden="true" tabindex="-1"></a>            count <span class="op">=</span> dist[regime]</span>
<span id="cb42-439"><a href="#cb42-439" aria-hidden="true" tabindex="-1"></a>            pct <span class="op">=</span> count <span class="op">/</span> <span class="bu">len</span>(df_final) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb42-440"><a href="#cb42-440" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"   </span><span class="sc">{</span>regime<span class="sc">:16s}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">:4d}</span><span class="ss"> (</span><span class="sc">{</span>pct<span class="sc">:5.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb42-441"><a href="#cb42-441" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-442"><a href="#cb42-442" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-443"><a href="#cb42-443" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ COMPLETE"</span>)</span>
<span id="cb42-444"><a href="#cb42-444" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-445"><a href="#cb42-445" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-446"><a href="#cb42-446" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_final, results, feature_importance</span>
<span id="cb42-447"><a href="#cb42-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-448"><a href="#cb42-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-449"><a href="#cb42-449" aria-hidden="true" tabindex="-1"></a><span class="co"># Run with crisis detection</span></span>
<span id="cb42-450"><a href="#cb42-450" aria-hidden="true" tabindex="-1"></a>df_hml_regimes, hml_results, hml_feat_imp <span class="op">=</span> build_hml_regime_classification_with_crisis(</span>
<span id="cb42-451"><a href="#cb42-451" aria-hidden="true" tabindex="-1"></a>    df_features_aug,</span>
<span id="cb42-452"><a href="#cb42-452" aria-hidden="true" tabindex="-1"></a>    L_index</span>
<span id="cb42-453"><a href="#cb42-453" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
HML REGIME CLASSIFICATION (WITH CRISIS DETECTION)
================================================================================

✅ Aligned: 185 observations

================================================================================
STEP 1: CRISIS DETECTION
================================================================================

📊 Crisis Features Created: 10
   Valid crisis detection samples: 168/185

✅ Crisis Detection Complete:
   Crisis periods:     9 months (4.9%)
   Non-crisis periods: 176 months (95.1%)

📅 Detected Crisis Months:
    1. 2008-09: Return = -0.09%, L = +2.15
    2. 2008-10: Return = -0.17%, L = +5.37
    3. 2008-12: Return = +0.02%, L = +4.80
    4. 2009-03: Return = +0.09%, L = +4.66
    5. 2009-04: Return = +0.10%, L = +4.80
    6. 2009-06: Return = +0.00%, L = +3.73
    7. 2009-07: Return = +0.08%, L = +3.40
    8. 2020-03: Return = -0.13%, L = +1.94
    9. 2020-04: Return = +0.14%, L = +2.11

📊 Non-Crisis Data: 176 observations

================================================================================
STEP 2: DEFINE HML REGIMES (NON-CRISIS PERIODS)
================================================================================

📊 Using: 6-month FORWARD HML
   Range: -0.20 to 0.25
   Mean:  0.00
   Std:   0.07

📊 After removing NaN: 171 observations

📊 HML Regime Thresholds (Non-Crisis):
   33rd percentile: -0.03
   67th percentile: 0.03

📊 HML Regime Distribution (Non-Crisis):
   Growth-Friendly :   57 ( 33.3%)
      Mean HML: -0.07, Mean L: -0.54
   Neutral         :   58 ( 33.9%)
      Mean HML: +0.00, Mean L: +0.03
   Value-Friendly  :   56 ( 32.7%)
      Mean HML: +0.08, Mean L: +0.03

================================================================================
STEP 3: LIQUIDITY FEATURES
================================================================================

✅ Selected 18 features

📊 ML Dataset: 171 samples × 18 features

================================================================================
STEP 4: MODEL TRAINING &amp; CROSS-VALIDATION
================================================================================

======================================================================
Random Forest
======================================================================

📊 Cross-Validation (Time Series):
   Mean Accuracy: 0.307 (±0.107)
   Fold Scores:   ['0.286', '0.214', '0.179', '0.464', '0.393']
   vs Baseline:   -2.6%

📈 In-Sample Accuracy: 0.895

📋 Classification Report:
                 precision    recall  f1-score   support

Growth-Friendly       0.89      0.95      0.92        57
        Neutral       0.84      0.84      0.84        58
 Value-Friendly       0.96      0.89      0.93        56

       accuracy                           0.89       171
      macro avg       0.90      0.90      0.90       171
   weighted avg       0.90      0.89      0.89       171


🎯 Confusion Matrix (%):
              Pred_Growth  Pred_Neutral  Pred_Value
True_Growth          94.7           5.3         0.0
True_Neutral         12.1          84.5         3.4
True_Value            0.0          10.7        89.3

======================================================================
XGBoost
======================================================================

📊 Cross-Validation (Time Series):
   Mean Accuracy: 0.214 (±0.106)
   Fold Scores:   ['0.179', '0.071', '0.179', '0.250', '0.393']
   vs Baseline:   -11.9%

📈 In-Sample Accuracy: 1.000

📋 Classification Report:
                 precision    recall  f1-score   support

Growth-Friendly       1.00      1.00      1.00        57
        Neutral       1.00      1.00      1.00        58
 Value-Friendly       1.00      1.00      1.00        56

       accuracy                           1.00       171
      macro avg       1.00      1.00      1.00       171
   weighted avg       1.00      1.00      1.00       171


🎯 Confusion Matrix (%):
              Pred_Growth  Pred_Neutral  Pred_Value
True_Growth         100.0           0.0         0.0
True_Neutral          0.0         100.0         0.0
True_Value            0.0           0.0       100.0

================================================================================
STEP 5: FEATURE IMPORTANCE
================================================================================

🏆 Best Model: Random Forest (CV: 0.307)

📊 Top 15 Features:
   💧 FED_BS_growth       : 0.1034
      Term_Spread         : 0.0878
   💧 M2_growth           : 0.0815
   💧 EM                  : 0.0766
   💧 EB                  : 0.0755
   💧 HML_lag6            : 0.0583
   💧 L                   : 0.0580
      Credit_Spread       : 0.0547
   💧 EL_3y               : 0.0530
   💧 L_ma_3              : 0.0501
   💧 L_ma_6              : 0.0485
   💧 dlog_M2             : 0.0465
   💧 L_momentum          : 0.0414
      Real_Rate           : 0.0399
   💧 dlog_FED_BS         : 0.0364

💧 Total Liquidity Importance: 78.5%

================================================================================
HYPOTHESIS TEST: LIQUIDITY → HML REGIMES
================================================================================

📊 Results:
   Baseline:      33.3%
   CV Accuracy:   30.7%
   Improvement:   -2.6%
   Lift:          0.92x

   ❌ WEAK SUPPORT for hypothesis

📊 Final Distribution:
   Crisis          :    9 (  4.9%)
   Growth-Friendly :   61 ( 33.0%)
   Neutral         :   58 ( 31.4%)
   Value-Friendly  :   52 ( 28.1%)
   Unknown         :    5 (  2.7%)

================================================================================
✅ COMPLETE
================================================================================</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/dbose\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>