<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Deb Bose">
<meta name="dcterms.date" content="2026-02-22">

<title>Mosaic-20 Cancer Analysis – Deb Bose</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b3b235ae6ba71d6e5c2a90c00144237d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Deb Bose</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../posts/"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../notebooks/index.html"> 
<span class="menu-text">Notebooks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../papers/index.html"> 
<span class="menu-text">Papers</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dbose"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#mosaic-20-project-context" id="toc-mosaic-20-project-context" class="nav-link active" data-scroll-target="#mosaic-20-project-context">MOSAIC-20 Project Context</a>
  <ul class="collapse">
  <li><a href="#objective" id="toc-objective" class="nav-link" data-scroll-target="#objective">Objective</a></li>
  <li><a href="#key-hypotheses" id="toc-key-hypotheses" class="nav-link" data-scroll-target="#key-hypotheses">Key Hypotheses</a></li>
  <li><a href="#primary-finding" id="toc-primary-finding" class="nav-link" data-scroll-target="#primary-finding">Primary Finding</a>
  <ul class="collapse">
  <li><a href="#phase-1" id="toc-phase-1" class="nav-link" data-scroll-target="#phase-1">Phase 1:</a></li>
  </ul></li>
  <li><a href="#analysis-approach" id="toc-analysis-approach" class="nav-link" data-scroll-target="#analysis-approach">Analysis Approach</a>
  <ul class="collapse">
  <li><a href="#phase-1-cdc-wonder-data-analysis-weeks-1-6" id="toc-phase-1-cdc-wonder-data-analysis-weeks-1-6" class="nav-link" data-scroll-target="#phase-1-cdc-wonder-data-analysis-weeks-1-6">Phase 1: CDC WONDER Data Analysis (Weeks 1-6)</a></li>
  <li><a href="#phase-2-in-silico-modeling-2-3-months" id="toc-phase-2-in-silico-modeling-2-3-months" class="nav-link" data-scroll-target="#phase-2-in-silico-modeling-2-3-months">Phase 2: In-Silico Modeling (2-3 months)</a></li>
  </ul></li>
  <li><a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources">Data Sources</a></li>
  <li><a href="#budget-constraints" id="toc-budget-constraints" class="nav-link" data-scroll-target="#budget-constraints">Budget Constraints</a></li>
  <li><a href="#next-immediate-steps" id="toc-next-immediate-steps" class="nav-link" data-scroll-target="#next-immediate-steps">Next Immediate Steps</a></li>
  <li><a href="#cdc-wonder-data-analysis" id="toc-cdc-wonder-data-analysis" class="nav-link" data-scroll-target="#cdc-wonder-data-analysis">CDC WONDER Data Analysis</a></li>
  </ul></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section">============================================================================</a></li>
  <li><a href="#step-1-load-2014-2019-weekly-data" id="toc-step-1-load-2014-2019-weekly-data" class="nav-link" data-scroll-target="#step-1-load-2014-2019-weekly-data">STEP 1: Load 2014-2019 Weekly Data</a></li>
  <li><a href="#section-1" id="toc-section-1" class="nav-link" data-scroll-target="#section-1">============================================================================</a></li>
  <li><a href="#section-2" id="toc-section-2" class="nav-link" data-scroll-target="#section-2">============================================================================</a></li>
  <li><a href="#step-2-load-2018-2026-provisional-data" id="toc-step-2-load-2018-2026-provisional-data" class="nav-link" data-scroll-target="#step-2-load-2018-2026-provisional-data">STEP 2: Load 2018-2026 Provisional Data</a></li>
  <li><a href="#section-3" id="toc-section-3" class="nav-link" data-scroll-target="#section-3">============================================================================</a></li>
  <li><a href="#section-4" id="toc-section-4" class="nav-link" data-scroll-target="#section-4">============================================================================</a></li>
  <li><a href="#step-3-combine-and-deduplicate" id="toc-step-3-combine-and-deduplicate" class="nav-link" data-scroll-target="#step-3-combine-and-deduplicate">STEP 3: Combine and Deduplicate</a></li>
  <li><a href="#section-5" id="toc-section-5" class="nav-link" data-scroll-target="#section-5">============================================================================</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Mosaic-20 Cancer Analysis</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">epidemiology</div>
    <div class="quarto-category">analytics</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Deb Bose </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 22, 2026</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    <p>This notebook investigates temporal patterns in cancer-related mortality and diagnosis proxies in the post–COVID-19 vaccination period using multiple complementary data sources, including U.S. CDC mortality statistics, aggregated insurance claims indicators, and exploratory molecular in-silico modeling of candidate biological mechanisms. The analysis focuses on identifying whether observable population-level shifts or safety signals warrant further clinical and epidemiological scrutiny. Emphasis is placed on careful interpretation of observational trends, adjustment for major confounders such as pandemic-era healthcare disruption, delayed screening, demographic effects, and baseline secular cancer trends. The molecular modeling component is presented as hypothesis-generating rather than confirmatory. Overall, the notebook provides a reproducible framework for exploring associations across datasets while distinguishing correlation from causal inference in complex public health settings</p>
  </div>
</div>


</header>


<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="mosaic-20-cancer-analysis_files/figure-html/543b75ef-0559-4508-a8ea-096c58181636-1-1d9a0db5-1bb3-4e99-abca-87efab5b5541.png" class="img-fluid figure-img"></p>
<figcaption>image.png</figcaption>
</figure>
</div>
<section id="mosaic-20-project-context" class="level1">
<h1>MOSAIC-20 Project Context</h1>
<section id="objective" class="level2">
<h2 class="anchored" data-anchor-id="objective">Objective</h2>
<p>Analyze potential carcinogenic effects of COVID-19 vaccines through: 1. CDC WONDER mortality data analysis (primary) 2. In-silico whole-body modeling (secondary)</p>
</section>
<section id="key-hypotheses" class="level2">
<h2 class="anchored" data-anchor-id="key-hypotheses">Key Hypotheses</h2>
<p>Testing 20 mechanisms of potential vaccine-induced carcinogenesis: 1. Increased cancer risk (7 major types) 2. Gene disruption 3. Genome integration 4. Genome instability 5. Tumor immune escape 6. DNA repair suppression 7. Chronic inflammation 8. Immune dysregulation 9. microRNA disruption 10. Oncogenic signaling (MAPK, PI3K/AKT/mTOR) 11. Tumor microenvironment remodeling 12. Dormant cancer reactivation 13. TLR inhibition 14. Frameshift protein errors 15. Immune exhaustion 16. IgG4 class switching 17. SV40 promoter effects 18. RAS signaling dysregulation 19. Microbiome disruption 20. Treatment resistance</p>
</section>
<section id="primary-finding" class="level2">
<h2 class="anchored" data-anchor-id="primary-finding">Primary Finding</h2>
<section id="phase-1" class="level3">
<h3 class="anchored" data-anchor-id="phase-1">Phase 1:</h3>
<p>The Bayesian Structural Time Series (CausalImpact) analysis estimates 1,314,451 cumulative excess cancer deaths in the post-intervention period (April 2021 – Jan 2026), representing a +79.79% relative effect over the counterfactual.</p>
<ul>
<li>95% Credible Interval: [1,223,525 – 1,405,227]</li>
<li>Average weekly excess: 5,216.1 deaths/week</li>
<li>Posterior P(Effect &gt; 0): 1.000</li>
<li>Pre-intervention training period: 379 weeks (2014 – April 2021)</li>
<li>Post-intervention prediction period: 252 weeks</li>
<li>Intervention date: April 10, 2021</li>
</ul>
</section>
</section>
<section id="analysis-approach" class="level2">
<h2 class="anchored" data-anchor-id="analysis-approach">Analysis Approach</h2>
<section id="phase-1-cdc-wonder-data-analysis-weeks-1-6" class="level3">
<h3 class="anchored" data-anchor-id="phase-1-cdc-wonder-data-analysis-weeks-1-6">Phase 1: CDC WONDER Data Analysis (Weeks 1-6)</h3>
<ul>
<li>Week 1: Replicate mortality chart</li>
<li>Week 2: Test confounders</li>
<li>Week 3: Dose-response by state</li>
<li>Week 4: Cancer type specificity</li>
<li>Week 5: Geographic variation</li>
<li>Week 6: Age stratification</li>
</ul>
</section>
<section id="phase-2-in-silico-modeling-2-3-months" class="level3">
<h3 class="anchored" data-anchor-id="phase-2-in-silico-modeling-2-3-months">Phase 2: In-Silico Modeling (2-3 months)</h3>
<p>Tools: PK-Sim, PhysiCell, COPASI, VCell - Implement 20 mechanisms - Multi-scale integration - Validation against known data</p>
</section>
</section>
<section id="data-sources" class="level2">
<h2 class="anchored" data-anchor-id="data-sources">Data Sources</h2>
<ul>
<li>CDC WONDER (free, public): https://wonder.cdc.gov</li>
<li>Insurance claims (if budget allows)</li>
<li>In-silico platforms (all open-source)</li>
</ul>
</section>
<section id="budget-constraints" class="level2">
<h2 class="anchored" data-anchor-id="budget-constraints">Budget Constraints</h2>
<ul>
<li>Prefer free/open-source tools</li>
<li>Avoid government data sources if compromised</li>
<li>No IRB requirements (public data + computational)</li>
</ul>
</section>
<section id="next-immediate-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-immediate-steps">Next Immediate Steps</h2>
<ol type="1">
<li>Download CDC WONDER data (C00-C97, ages 0-54, weekly 2018-2025)</li>
<li>Replicate chart in Python/R</li>
<li>Begin systematic confounder analysis</li>
</ol>
</section>
<section id="cdc-wonder-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="cdc-wonder-data-analysis">CDC WONDER Data Analysis</h2>
</section>
</section>
<section id="section" class="level1">
<h1>============================================================================</h1>
</section>
<section id="step-1-load-2014-2019-weekly-data" class="level1">
<h1>STEP 1: Load 2014-2019 Weekly Data</h1>
</section>
<section id="section-1" class="level1">
<h1>============================================================================</h1>
<p>https://wonder.cdc.gov/mcd-icd10.html</p>
<div id="f8e47023-c7f9-49ae-8b12-16b2a7a4c74f" class="cell" data-execution_count="6">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MOSAIC-20: DATA PREPARATION"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[1/4] Loading 2014-2019 weekly data..."</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>file_2014_2019 <span class="op">=</span> <span class="st">'/Users/dbose/projects/dbose-github-pages/dbose.github.io/notebooks/data/Weekly_Counts_of_Deaths_by_State_and_Select_Causes,_2014-2019_20260215.csv'</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>df_old <span class="op">=</span> pd.read_csv(file_2014_2019)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Raw data loaded: </span><span class="sc">{</span><span class="bu">len</span>(df_old)<span class="sc">}</span><span class="ss"> rows"</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Columns: </span><span class="sc">{</span><span class="bu">list</span>(df_old.columns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for United States only</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>df_old <span class="op">=</span> df_old[df_old[<span class="st">'Jurisdiction of Occurrence'</span>] <span class="op">==</span> <span class="st">'United States'</span>].copy()</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  After filtering for US: </span><span class="sc">{</span><span class="bu">len</span>(df_old)<span class="sc">}</span><span class="ss"> rows"</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract and clean deaths column</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>df_old[<span class="st">'deaths'</span>] <span class="op">=</span> df_old[<span class="st">'Malignant neoplasms (C00-C97)'</span>].<span class="bu">str</span>.replace(<span class="st">','</span>, <span class="st">''</span>).astype(<span class="bu">float</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Parse date</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>df_old[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(df_old[<span class="st">'Week Ending Date'</span>])</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract year and week</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>df_old[<span class="st">'year'</span>] <span class="op">=</span> pd.to_numeric(df_old[<span class="st">'MMWR Year'</span>])</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>df_old[<span class="st">'week'</span>] <span class="op">=</span> pd.to_numeric(df_old[<span class="st">'MMWR Week'</span>])</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only needed columns</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>df_old <span class="op">=</span> df_old[[<span class="st">'date'</span>, <span class="st">'year'</span>, <span class="st">'week'</span>, <span class="st">'deaths'</span>]].copy()</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>df_old <span class="op">=</span> df_old.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>df_old[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>df_old[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Total deaths: </span><span class="sc">{</span>df_old[<span class="st">'deaths'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean weekly deaths: </span><span class="sc">{</span>df_old[<span class="st">'deaths'</span>]<span class="sc">.</span>mean()<span class="sc">:,.1f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
MOSAIC-20: DATA PREPARATION
================================================================================

[1/4] Loading 2014-2019 weekly data...
  Raw data loaded: 16902 rows
  Columns: ['Jurisdiction of Occurrence', 'MMWR Year', 'MMWR Week', 'Week Ending Date', 'All  Cause', 'Natural Cause', 'Septicemia (A40-A41)', 'Malignant neoplasms (C00-C97)', 'Diabetes mellitus (E10-E14)', 'Alzheimer disease (G30)', 'Influenza and pneumonia (J10-J18)', 'Chronic lower respiratory diseases (J40-J47)', 'Other diseases of respiratory system (J00-J06,J30-J39,J67,J70-J98)', 'Nephritis, nephrotic syndrome and nephrosis (N00-N07,N17-N19,N25-N27)', 'Symptoms, signs and abnormal clinical and laboratory findings, not elsewhere classified (R00-R99)', 'Diseases of heart (I00-I09,I11,I13,I20-I51)', 'Cerebrovascular diseases (I60-I69)', 'flag_allcause', 'flag_natcause', 'flag_sept', 'flag_neopl', 'flag_diab', 'flag_alz', 'flag_inflpn', 'flag_clrd', 'flag_otherresp', 'flag_nephr', 'flag_otherunk', 'flag_hd', 'flag_stroke']
  After filtering for US: 313 rows
  Date range: 2014-01-04 to 2019-12-28
  Total deaths: 3,583,600
  Mean weekly deaths: 11,449.2</code></pre>
</div>
</div>
</section>
<section id="section-2" class="level1">
<h1>============================================================================</h1>
</section>
<section id="step-2-load-2018-2026-provisional-data" class="level1">
<h1>STEP 2: Load 2018-2026 Provisional Data</h1>
</section>
<section id="section-3" class="level1">
<h1>============================================================================</h1>
<p>Source: https://wonder.cdc.gov/controller/datarequest/D176;jsessionid=DB63A68D81A1D1AE42F356AD3AAC</p>
<div id="6d5f1726-bbf2-4532-b8d2-bed183b0e51c" class="cell" data-execution_count="16">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[2/4] Loading 2018-2026 provisional data..."</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>file_2018_2026 <span class="op">=</span> <span class="st">'/Users/dbose/projects/dbose-github-pages/dbose.github.io/notebooks/data/provisional_mortality_statistics_icd10_codes_2018_by_week_4_ucd.csv'</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>df_new <span class="op">=</span> pd.read_csv(file_2018_2026)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Raw data loaded: </span><span class="sc">{</span><span class="bu">len</span>(df_new)<span class="sc">}</span><span class="ss"> rows"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove footer notes and totals</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>df_new <span class="op">=</span> df_new[df_new[<span class="st">'MMWR Week'</span>].notna()].copy()</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>df_new <span class="op">=</span> df_new[<span class="op">~</span>df_new[<span class="st">'MMWR Week'</span>].<span class="bu">str</span>.contains(<span class="st">'---'</span>, na<span class="op">=</span><span class="va">False</span>)]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>df_new <span class="op">=</span> df_new[df_new[<span class="st">'MMWR Week'</span>] <span class="op">!=</span> <span class="st">'Total'</span>]</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  After cleaning: </span><span class="sc">{</span><span class="bu">len</span>(df_new)<span class="sc">}</span><span class="ss"> rows"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Parse date from week description</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_week_date(week_desc):</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract ending date from week description"""</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.isna(week_desc):</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> week_desc.split(<span class="st">'ending'</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(parts) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    date_str <span class="op">=</span> parts[<span class="dv">1</span>].strip().replace(<span class="st">'(provisional)'</span>, <span class="st">''</span>).strip()</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.to_datetime(date_str, <span class="bu">format</span><span class="op">=</span><span class="st">'%B </span><span class="sc">%d</span><span class="st">, %Y'</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>df_new[<span class="st">'date'</span>] <span class="op">=</span> df_new[<span class="st">'MMWR Week'</span>].<span class="bu">apply</span>(parse_week_date)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>df_new <span class="op">=</span> df_new[df_new[<span class="st">'date'</span>].notna()].copy()</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert deaths to numeric</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>df_new[<span class="st">'deaths'</span>] <span class="op">=</span> pd.to_numeric(df_new[<span class="st">'Deaths'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>df_new <span class="op">=</span> df_new[df_new[<span class="st">'deaths'</span>].notna()].copy()</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract year and week</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>df_new[<span class="st">'year'</span>] <span class="op">=</span> df_new[<span class="st">'date'</span>].dt.year</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>df_new[<span class="st">'week'</span>] <span class="op">=</span> df_new[<span class="st">'date'</span>].dt.isocalendar().week</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only needed columns</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>df_new <span class="op">=</span> df_new[[<span class="st">'date'</span>, <span class="st">'year'</span>, <span class="st">'week'</span>, <span class="st">'deaths'</span>]].copy()</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>df_new <span class="op">=</span> df_new.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>df_new[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>df_new[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Total deaths: </span><span class="sc">{</span>df_new[<span class="st">'deaths'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean weekly deaths: </span><span class="sc">{</span>df_new[<span class="st">'deaths'</span>]<span class="sc">.</span>mean()<span class="sc">:,.1f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
[2/4] Loading 2018-2026 provisional data...
  Raw data loaded: 476 rows
  After cleaning: 422 rows
  Date range: 2018-01-06 to 2026-01-31
  Total deaths: 4,915,536
  Mean weekly deaths: 11,648.2</code></pre>
</div>
</div>
</section>
<section id="section-4" class="level1">
<h1>============================================================================</h1>
</section>
<section id="step-3-combine-and-deduplicate" class="level1">
<h1>STEP 3: Combine and Deduplicate</h1>
</section>
<section id="section-5" class="level1">
<h1>============================================================================</h1>
<div id="fcf3b105-8ffa-499d-af22-5e7746d798c5" class="cell" data-execution_count="17">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[3/4] Combining datasets and deduplicating..."</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify overlap period</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>overlap_start <span class="op">=</span> <span class="bu">max</span>(df_old[<span class="st">'date'</span>].<span class="bu">min</span>(), df_new[<span class="st">'date'</span>].<span class="bu">min</span>())</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>overlap_end <span class="op">=</span> <span class="bu">min</span>(df_old[<span class="st">'date'</span>].<span class="bu">max</span>(), df_new[<span class="st">'date'</span>].<span class="bu">max</span>())</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Overlap period: </span><span class="sc">{</span>overlap_start<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>overlap_end<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Strategy: Keep 2014-2017 from old dataset, 2018-2026 from new dataset</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># (Provisional data is more up-to-date and consistent)</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>cutoff_date <span class="op">=</span> <span class="st">'2018-01-01'</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>df_2014_2017 <span class="op">=</span> df_old[df_old[<span class="st">'date'</span>] <span class="op">&lt;</span> cutoff_date].copy()</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>df_2018_2026 <span class="op">=</span> df_new.copy()</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  From 2014-2019 dataset: </span><span class="sc">{</span><span class="bu">len</span>(df_2014_2017)<span class="sc">}</span><span class="ss"> weeks (2014-2017)"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  From 2018-2026 dataset: </span><span class="sc">{</span><span class="bu">len</span>(df_2018_2026)<span class="sc">}</span><span class="ss"> weeks (2018-2026)"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>df_combined <span class="op">=</span> pd.concat([df_2014_2017, df_2018_2026], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>df_combined <span class="op">=</span> df_combined.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for any remaining duplicates</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>duplicates <span class="op">=</span> df_combined[df_combined.duplicated(subset<span class="op">=</span>[<span class="st">'date'</span>], keep<span class="op">=</span><span class="va">False</span>)]</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(duplicates) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  WARNING: Found </span><span class="sc">{</span><span class="bu">len</span>(duplicates)<span class="sc">}</span><span class="ss"> duplicate dates, keeping last occurrence"</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    df_combined <span class="op">=</span> df_combined.drop_duplicates(subset<span class="op">=</span>[<span class="st">'date'</span>], keep<span class="op">=</span><span class="st">'last'</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Add sequential time index</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>df_combined[<span class="st">'time_index'</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(df_combined))</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  COMBINED DATASET:"</span>)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Total weeks: </span><span class="sc">{</span><span class="bu">len</span>(df_combined)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Date range: </span><span class="sc">{</span>df_combined[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>df_combined[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Total deaths: </span><span class="sc">{</span>df_combined[<span class="st">'deaths'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Mean weekly deaths: </span><span class="sc">{</span>df_combined[<span class="st">'deaths'</span>]<span class="sc">.</span>mean()<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Median weekly deaths: </span><span class="sc">{</span>df_combined[<span class="st">'deaths'</span>]<span class="sc">.</span>median()<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Std deviation: </span><span class="sc">{</span>df_combined[<span class="st">'deaths'</span>]<span class="sc">.</span>std()<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Min: </span><span class="sc">{</span>df_combined[<span class="st">'deaths'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"    Max: </span><span class="sc">{</span>df_combined[<span class="st">'deaths'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:,.0f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
[3/4] Combining datasets and deduplicating...
  Overlap period: 2018-01-06 to 2019-12-28
  From 2014-2019 dataset: 209 weeks (2014-2017)
  From 2018-2026 dataset: 422 weeks (2018-2026)

  COMBINED DATASET:
    Total weeks: 631
    Date range: 2014-01-04 to 2026-01-31
    Total deaths: 7,303,358
    Mean weekly deaths: 11,574.3
    Median weekly deaths: 11,571.0
    Std deviation: 327.4
    Min: 7,857
    Max: 12,787</code></pre>
</div>
</div>
<div id="f527924d-3740-4e02-97e1-bc6dcd6eef3d" class="cell" data-execution_count="11">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_combined.columns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>Index(['date', 'year', 'week', 'deaths', 'time_index'], dtype='object')</code></pre>
</div>
</div>
<div id="9642e2c5-510d-4e29-9af6-bc60eb3a9d65" class="cell" data-execution_count="18">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MOSAIC-20: VISUALIZING COMBINED DATASET"</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the combined dataset</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df_combined[df_combined[<span class="st">'year'</span>] <span class="op">&lt;</span> <span class="dv">2026</span>]</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'date'</span>])</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Dataset loaded: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total deaths: </span><span class="sc">{</span>df[<span class="st">'deaths'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate moving averages</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'ma4'</span>] <span class="op">=</span> df[<span class="st">'deaths'</span>].rolling(window<span class="op">=</span><span class="dv">4</span>, center<span class="op">=</span><span class="va">True</span>).mean()</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'ma13'</span>] <span class="op">=</span> df[<span class="st">'deaths'</span>].rolling(window<span class="op">=</span><span class="dv">13</span>, center<span class="op">=</span><span class="va">True</span>).mean()</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>))</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot raw data</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>ax.plot(df[<span class="st">'date'</span>], df[<span class="st">'deaths'</span>], linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, </span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">'Weekly Deaths'</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot moving averages</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>ax.plot(df[<span class="st">'date'</span>], df[<span class="st">'ma4'</span>], linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'darkblue'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">'4-Week Moving Average'</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>ax.plot(df[<span class="st">'date'</span>], df[<span class="st">'ma13'</span>], linewidth<span class="op">=</span><span class="dv">3</span>, color<span class="op">=</span><span class="st">'red'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">'13-Week Moving Average (Quarterly)'</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark key dates</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>covid_start <span class="op">=</span> pd.Timestamp(<span class="st">'2020-03-11'</span>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>vaccine_rollout <span class="op">=</span> pd.Timestamp(<span class="st">'2021-04-10'</span>)  <span class="co"># Week 14, 2021</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="co"># COVID-19 pandemic start</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>ax.axvline(covid_start, color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>ax.text(covid_start, ax.get_ylim()[<span class="dv">1</span>]<span class="op">*</span><span class="fl">0.98</span>, <span class="st">'COVID-19 Pandemic</span><span class="ch">\n</span><span class="st">March 11, 2020'</span>, </span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, color<span class="op">=</span><span class="st">'orange'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round,pad=0.5'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, edgecolor<span class="op">=</span><span class="st">'orange'</span>, linewidth<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Vaccine rollout</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>ax.axvline(vaccine_rollout, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, zorder<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>ax.text(vaccine_rollout, ax.get_ylim()[<span class="dv">1</span>]<span class="op">*</span><span class="fl">0.85</span>, <span class="st">'Max Vaccine Uptake</span><span class="ch">\n</span><span class="st">Week 14, 2021</span><span class="ch">\n</span><span class="st">(April 10, 2021)'</span>, </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'top'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, color<span class="op">=</span><span class="st">'red'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round,pad=0.6'</span>, facecolor<span class="op">=</span><span class="st">'yellow'</span>, alpha<span class="op">=</span><span class="fl">0.95</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>))</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Add period labels</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>periods <span class="op">=</span> [</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'2014-01-01'</span>, <span class="st">'2019-12-31'</span>, <span class="st">'Pre-COVID Baseline</span><span class="ch">\n</span><span class="st">2014-2019'</span>, <span class="fl">0.15</span>, <span class="st">'blue'</span>),</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'2020-03-11'</span>, <span class="st">'2021-04-03'</span>, <span class="st">'COVID Period</span><span class="ch">\n</span><span class="st">(Lockdowns, Screening Delays)'</span>, <span class="fl">0.45</span>, <span class="st">'orange'</span>),</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'2021-04-10'</span>, <span class="st">'2026-01-31'</span>, <span class="st">'Post-Vaccination Period</span><span class="ch">\n</span><span class="st">2021-2026'</span>, <span class="fl">0.75</span>, <span class="st">'red'</span>)</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> start, end, label, x_pos, color <span class="kw">in</span> periods:</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    start_date <span class="op">=</span> pd.Timestamp(start)</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    end_date <span class="op">=</span> pd.Timestamp(end)</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>    mid_date <span class="op">=</span> start_date <span class="op">+</span> (end_date <span class="op">-</span> start_date) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shade the region</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    ax.axvspan(start_date, end_date, alpha<span class="op">=</span><span class="fl">0.05</span>, color<span class="op">=</span>color, zorder<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add label at bottom</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    ax.text(mid_date, ax.get_ylim()[<span class="dv">0</span>] <span class="op">+</span> (ax.get_ylim()[<span class="dv">1</span>] <span class="op">-</span> ax.get_ylim()[<span class="dv">0</span>])<span class="op">*</span><span class="fl">0.05</span>, </span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>            label, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>, fontsize<span class="op">=</span><span class="dv">10</span>, </span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>            style<span class="op">=</span><span class="st">'italic'</span>, color<span class="op">=</span>color, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>            bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round,pad=0.4'</span>, facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, edgecolor<span class="op">=</span>color))</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Add statistics annotations</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>stats_2014_2019 <span class="op">=</span> df[df[<span class="st">'date'</span>] <span class="op">&lt;</span> <span class="st">'2020-01-01'</span>][<span class="st">'deaths'</span>].agg([<span class="st">'mean'</span>, <span class="st">'std'</span>])</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>stats_2020_2021 <span class="op">=</span> df[(df[<span class="st">'date'</span>] <span class="op">&gt;=</span> <span class="st">'2020-03-11'</span>) <span class="op">&amp;</span> (df[<span class="st">'date'</span>] <span class="op">&lt;</span> <span class="st">'2021-04-10'</span>)][<span class="st">'deaths'</span>].agg([<span class="st">'mean'</span>, <span class="st">'std'</span>])</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>stats_post_vax <span class="op">=</span> df[df[<span class="st">'date'</span>] <span class="op">&gt;=</span> <span class="st">'2021-04-10'</span>][<span class="st">'deaths'</span>].agg([<span class="st">'mean'</span>, <span class="st">'std'</span>])</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>stats_text <span class="op">=</span> <span class="ss">f"""Dataset Statistics:</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a><span class="ss">Pre-COVID (2014-2019):</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a><span class="ss">  Mean: </span><span class="sc">{</span>stats_2014_2019[<span class="st">'mean'</span>]<span class="sc">:,.0f}</span><span class="ss"> deaths/week</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a><span class="ss">  Std:  </span><span class="sc">{</span>stats_2014_2019[<span class="st">'std'</span>]<span class="sc">:,.0f}</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a><span class="ss">COVID Period (2020-2021):</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a><span class="ss">  Mean: </span><span class="sc">{</span>stats_2020_2021[<span class="st">'mean'</span>]<span class="sc">:,.0f}</span><span class="ss"> deaths/week</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a><span class="ss">  Std:  </span><span class="sc">{</span>stats_2020_2021[<span class="st">'std'</span>]<span class="sc">:,.0f}</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a><span class="ss">  Change: </span><span class="sc">{</span>((stats_2020_2021[<span class="st">'mean'</span>]<span class="op">/</span>stats_2014_2019[<span class="st">'mean'</span>]<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">100</span>)<span class="sc">:+.1f}</span><span class="ss">%</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a><span class="ss">Post-Vaccination (2021-2026):</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a><span class="ss">  Mean: </span><span class="sc">{</span>stats_post_vax[<span class="st">'mean'</span>]<span class="sc">:,.0f}</span><span class="ss"> deaths/week</span></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a><span class="ss">  Std:  </span><span class="sc">{</span>stats_post_vax[<span class="st">'std'</span>]<span class="sc">:,.0f}</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a><span class="ss">  Change: </span><span class="sc">{</span>((stats_post_vax[<span class="st">'mean'</span>]<span class="op">/</span>stats_2014_2019[<span class="st">'mean'</span>]<span class="op">-</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">100</span>)<span class="sc">:+.1f}</span><span class="ss">%</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a><span class="ss">Total Dataset:</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a><span class="ss">  Weeks: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a><span class="ss">  Deaths: </span><span class="sc">{</span>df[<span class="st">'deaths'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,.0f}</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a><span class="ss">  Range: </span><span class="sc">{</span>df[<span class="st">'deaths'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:,.0f}</span><span class="ss"> - </span><span class="sc">{</span>df[<span class="st">'deaths'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:,.0f}</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>ax.text(<span class="fl">0.02</span>, <span class="fl">0.97</span>, stats_text,</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>        transform<span class="op">=</span>ax.transAxes,</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>        verticalalignment<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>        horizontalalignment<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'wheat'</span>, alpha<span class="op">=</span><span class="fl">0.95</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>),</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>        family<span class="op">=</span><span class="st">'monospace'</span>)</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Formatting</span></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Weekly Cancer Deaths (All Ages, C00-C97)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Malignant Neoplasms (C00-C97) - All Ages, United States</span><span class="ch">\n</span><span class="st">Weekly Mortality Data 2014-2026'</span>, </span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">16</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Grid</span></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>, which<span class="op">=</span><span class="st">'major'</span>)</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>ax.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.15</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="fl">0.3</span>, which<span class="op">=</span><span class="st">'minor'</span>)</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>ax.set_axisbelow(<span class="va">True</span>)</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Legend</span></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, framealpha<span class="op">=</span><span class="fl">0.95</span>, fontsize<span class="op">=</span><span class="dv">12</span>, shadow<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Format x-axis</span></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y'</span>))</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>ax.xaxis.set_minor_locator(mdates.MonthLocator((<span class="dv">1</span>, <span class="dv">7</span>)))</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Add y-axis formatting</span></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_major_formatter(plt.FuncFormatter(<span class="kw">lambda</span> x, p: <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x)<span class="sc">:,}</span><span class="ss">'</span>))</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Highlight max and min</span></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>max_idx <span class="op">=</span> df[<span class="st">'deaths'</span>].idxmax()</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>min_idx <span class="op">=</span> df[<span class="st">'deaths'</span>].idxmin()</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>ax.plot(df.loc[max_idx, <span class="st">'date'</span>], df.loc[max_idx, <span class="st">'deaths'</span>], </span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>        <span class="st">'r*'</span>, markersize<span class="op">=</span><span class="dv">20</span>, zorder<span class="op">=</span><span class="dv">10</span>, label<span class="op">=</span><span class="st">'_nolegend_'</span>)</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>ax.annotate(<span class="ss">f"Max: </span><span class="sc">{</span>df<span class="sc">.</span>loc[max_idx, <span class="st">'deaths'</span>]<span class="sc">:,.0f}</span><span class="ch">\n</span><span class="sc">{</span>df<span class="sc">.</span>loc[max_idx, <span class="st">'date'</span>]<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>            xy<span class="op">=</span>(df.loc[max_idx, <span class="st">'date'</span>], df.loc[max_idx, <span class="st">'deaths'</span>]),</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>            xytext<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">20</span>), textcoords<span class="op">=</span><span class="st">'offset points'</span>,</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>            fontsize<span class="op">=</span><span class="dv">9</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>            bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round,pad=0.3'</span>, facecolor<span class="op">=</span><span class="st">'yellow'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>),</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>            arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">'-&gt;'</span>, color<span class="op">=</span><span class="st">'red'</span>, lw<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>ax.plot(df.loc[min_idx, <span class="st">'date'</span>], df.loc[min_idx, <span class="st">'deaths'</span>], </span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>        <span class="st">'g*'</span>, markersize<span class="op">=</span><span class="dv">20</span>, zorder<span class="op">=</span><span class="dv">10</span>, label<span class="op">=</span><span class="st">'_nolegend_'</span>)</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>ax.annotate(<span class="ss">f"Min: </span><span class="sc">{</span>df<span class="sc">.</span>loc[min_idx, <span class="st">'deaths'</span>]<span class="sc">:,.0f}</span><span class="ch">\n</span><span class="sc">{</span>df<span class="sc">.</span>loc[min_idx, <span class="st">'date'</span>]<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>            xy<span class="op">=</span>(df.loc[min_idx, <span class="st">'date'</span>], df.loc[min_idx, <span class="st">'deaths'</span>]),</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>            xytext<span class="op">=</span>(<span class="dv">20</span>, <span class="op">-</span><span class="dv">30</span>), textcoords<span class="op">=</span><span class="st">'offset points'</span>,</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>            fontsize<span class="op">=</span><span class="dv">9</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'green'</span>,</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>            bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round,pad=0.3'</span>, facecolor<span class="op">=</span><span class="st">'lightgreen'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, edgecolor<span class="op">=</span><span class="st">'green'</span>),</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>            arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">'-&gt;'</span>, color<span class="op">=</span><span class="st">'green'</span>, lw<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Source citation</span></span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>source_text <span class="op">=</span> (<span class="st">"Data Sources: CDC NCHS Weekly Counts 2014-2019 (aggregated across jurisdictions) + CDC WONDER Provisional Mortality 2018-2026</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"Combined &amp; Deduplicated Dataset | MOSAIC-20 Project | Generated: </span><span class="sc">{</span>datetime<span class="sc">.</span>now()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.01</span>, source_text, ha<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>, style<span class="op">=</span><span class="st">'italic'</span>, color<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(bottom<span class="op">=</span><span class="fl">0.06</span>)</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Save</span></span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">'/Users/dbose/projects/dbose-github-pages/dbose.github.io/notebooks/data/mosaic20_combined_dataset_visualization.png'</span></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ VISUALIZATION COMPLETE"</span>)</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Chart saved to: </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Key Observations:"</span>)</span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  • Clear upward trend 2014-2019"</span>)</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  • COVID disruption visible March 2020"</span>)</span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  • Sustained elevation post April 2021"</span>)</span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  • Max deaths: </span><span class="sc">{</span>df<span class="sc">.</span>loc[max_idx, <span class="st">'deaths'</span>]<span class="sc">:,.0f}</span><span class="ss"> (</span><span class="sc">{</span>df<span class="sc">.</span>loc[max_idx, <span class="st">'date'</span>]<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  • Min deaths: </span><span class="sc">{</span>df<span class="sc">.</span>loc[min_idx, <span class="st">'deaths'</span>]<span class="sc">:,.0f}</span><span class="ss"> (</span><span class="sc">{</span>df<span class="sc">.</span>loc[min_idx, <span class="st">'date'</span>]<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
MOSAIC-20: VISUALIZING COMBINED DATASET
================================================================================

Dataset loaded: 626 weeks
Date range: 2014-01-04 to 2025-12-27
Total deaths: 7,250,874</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
================================================================================
✓ VISUALIZATION COMPLETE
================================================================================
Chart saved to: /Users/dbose/projects/dbose-github-pages/dbose.github.io/notebooks/data/mosaic20_combined_dataset_visualization.png

Key Observations:
  • Clear upward trend 2014-2019
  • COVID disruption visible March 2020
  • Sustained elevation post April 2021
  • Max deaths: 12,787 (2025-02-01)
  • Min deaths: 10,263 (2018-01-06)
================================================================================</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="mosaic-20-cancer-analysis_files/figure-html/cell-6-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="efadb80a-d944-49cf-b658-33f634c03c91" class="cell" data-execution_count="19">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_combined.columns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>Index(['date', 'year', 'week', 'deaths', 'time_index'], dtype='object')</code></pre>
</div>
</div>
<div id="798a4575-eb36-4b8a-afb3-063f2faba8de" class="cell" data-execution_count="21">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MOSAIC-20: BAYESIAN COUNTERFACTUAL ANALYSIS (CORRECTED)"</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 1: Load and Prepare Data</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[1/6] Loading combined dataset..."</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter out 2026 (incomplete data)</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df_combined.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Dataset: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>df[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Define baseline and intervention</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>baseline_end <span class="op">=</span> pd.Timestamp(<span class="st">'2019-12-28'</span>)  <span class="co"># Use 2014-2019 as baseline</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>intervention_date <span class="op">=</span> pd.Timestamp(<span class="st">'2021-04-10'</span>)  <span class="co"># Week 14, 2021</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>baseline_idx <span class="op">=</span> df[df[<span class="st">'date'</span>] <span class="op">==</span> baseline_end].index[<span class="dv">0</span>]</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>intervention_idx <span class="op">=</span> df[df[<span class="st">'date'</span>] <span class="op">==</span> intervention_date].index[<span class="dv">0</span>]</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Baseline period: 2014-2019 (ends </span><span class="sc">{</span>baseline_end<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Intervention date: </span><span class="sc">{</span>intervention_date<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>df_baseline <span class="op">=</span> df[df[<span class="st">'date'</span>] <span class="op">&lt;=</span> baseline_end].copy()</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>df_pre <span class="op">=</span> df[df[<span class="st">'date'</span>] <span class="op">&lt;</span> intervention_date].copy()</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>df_post <span class="op">=</span> df[df[<span class="st">'date'</span>] <span class="op">&gt;=</span> intervention_date].copy()</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Baseline: </span><span class="sc">{</span><span class="bu">len</span>(df_baseline)<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pre-intervention (2014-2021): </span><span class="sc">{</span><span class="bu">len</span>(df_pre)<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Post-intervention (2021-2025): </span><span class="sc">{</span><span class="bu">len</span>(df_post)<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 2: Fit Simple Baseline Model (2014-2019 ONLY)</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[2/6] Fitting baseline model using 2014-2019 data ONLY..."</span>)</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>y_baseline <span class="op">=</span> df_baseline[<span class="st">'deaths'</span>].values</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>n_baseline <span class="op">=</span> <span class="bu">len</span>(y_baseline)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Create CENTERED time index for baseline period only</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>t_baseline <span class="op">=</span> np.arange(n_baseline) <span class="op">-</span> n_baseline <span class="op">/</span> <span class="dv">2</span>  <span class="co"># Center around 0</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple model: mean + trend + seasonality (using baseline data only)</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>X_baseline <span class="op">=</span> np.column_stack([</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    np.ones(n_baseline),  <span class="co"># Intercept</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    t_baseline,  <span class="co"># CENTERED linear trend</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> np.arange(n_baseline) <span class="op">/</span> <span class="dv">52</span>),  <span class="co"># Annual seasonality</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    np.cos(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> np.arange(n_baseline) <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    np.sin(<span class="dv">4</span> <span class="op">*</span> np.pi <span class="op">*</span> np.arange(n_baseline) <span class="op">/</span> <span class="dv">52</span>),  <span class="co"># Semi-annual</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>    np.cos(<span class="dv">4</span> <span class="op">*</span> np.pi <span class="op">*</span> np.arange(n_baseline) <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard Bayesian linear regression</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bayesian_regression_simple(X, y, n_samples<span class="op">=</span><span class="dv">5000</span>):</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simple Bayesian regression with proper priors"""</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    n, p <span class="op">=</span> X.shape</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Informative priors based on data</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    y_mean <span class="op">=</span> y.mean()</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    y_std <span class="op">=</span> y.std()</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prior for intercept: centered on data mean</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    beta_prior_mean <span class="op">=</span> np.zeros(p)</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    beta_prior_mean[<span class="dv">0</span>] <span class="op">=</span> y_mean</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prior covariance</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    beta_prior_cov <span class="op">=</span> np.diag([y_std<span class="op">**</span><span class="dv">2</span>, <span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">100</span>, <span class="dv">100</span>])  <span class="co"># Weak prior except intercept</span></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inverse-Gamma prior for variance</span></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    alpha_prior <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    beta_prior <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> y_std<span class="op">**</span><span class="dv">2</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Storage</span></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>    beta_samples <span class="op">=</span> np.zeros((n_samples, p))</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    sigma2_samples <span class="op">=</span> np.zeros(n_samples)</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    sigma2 <span class="op">=</span> y_std<span class="op">**</span><span class="dv">2</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Gibbs sampling</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_samples):</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sample beta | sigma2, y</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>        V_beta <span class="op">=</span> np.linalg.inv(np.linalg.inv(beta_prior_cov) <span class="op">+</span> X.T <span class="op">@</span> X <span class="op">/</span> sigma2)</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>        m_beta <span class="op">=</span> V_beta <span class="op">@</span> (np.linalg.inv(beta_prior_cov) <span class="op">@</span> beta_prior_mean <span class="op">+</span> X.T <span class="op">@</span> y <span class="op">/</span> sigma2)</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>        beta <span class="op">=</span> np.random.multivariate_normal(m_beta, V_beta)</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sample sigma2 | beta, y</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>        resid <span class="op">=</span> y <span class="op">-</span> X <span class="op">@</span> beta</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>        alpha_post <span class="op">=</span> alpha_prior <span class="op">+</span> n <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>        beta_post <span class="op">=</span> beta_prior <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> np.<span class="bu">sum</span>(resid<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>        sigma2 <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> np.random.gamma(alpha_post, <span class="dv">1</span> <span class="op">/</span> beta_post)</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>        beta_samples[i] <span class="op">=</span> beta</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>        sigma2_samples[i] <span class="op">=</span> sigma2</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Burn-in</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>    burn <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> beta_samples[burn:], sigma2_samples[burn:]</span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Running Bayesian MCMC (5000 iterations)..."</span>)</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>beta_samples, sigma2_samples <span class="op">=</span> bayesian_regression_simple(X_baseline, y_baseline)</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>baseline_mean <span class="op">=</span> beta_samples[:, <span class="dv">0</span>].mean()</span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a>baseline_trend <span class="op">=</span> beta_samples[:, <span class="dv">1</span>].mean()</span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Baseline mean: </span><span class="sc">{</span>baseline_mean<span class="sc">:,.1f}</span><span class="ss"> deaths/week"</span>)</span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Baseline trend: </span><span class="sc">{</span>baseline_trend<span class="sc">:.4f}</span><span class="ss"> deaths/week per week"</span>)</span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Annual trend: </span><span class="sc">{</span>baseline_trend <span class="op">*</span> <span class="dv">52</span><span class="sc">:,.1f}</span><span class="ss"> deaths/year"</span>)</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Baseline std: </span><span class="sc">{</span>np<span class="sc">.</span>sqrt(sigma2_samples.mean())<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Observed 2014-2019 mean: </span><span class="sc">{</span>y_baseline<span class="sc">.</span>mean()<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3: Project Counterfactual Forward</span></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[3/6] Projecting counterfactual for full period..."</span>)</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a><span class="co"># For counterfactual, we continue the baseline pattern forward</span></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Time index relative to </span><span class="re">END</span><span class="co"> of baseline period</span></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>n_total <span class="op">=</span> <span class="bu">len</span>(df)</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>t_counterfactual <span class="op">=</span> np.arange(n_total) <span class="op">-</span> baseline_idx  <span class="co"># Time relative to end of baseline</span></span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>X_full <span class="op">=</span> np.column_stack([</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>    np.ones(n_total),</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>    t_counterfactual,</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>    np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> np.arange(n_total) <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>    np.cos(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> np.arange(n_total) <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>    np.sin(<span class="dv">4</span> <span class="op">*</span> np.pi <span class="op">*</span> np.arange(n_total) <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>    np.cos(<span class="dv">4</span> <span class="op">*</span> np.pi <span class="op">*</span> np.arange(n_total) <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate counterfactual samples</span></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>n_posterior <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>y_counter_samples <span class="op">=</span> np.zeros((n_posterior, n_total))</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_posterior):</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.random.randint(<span class="bu">len</span>(beta_samples))</span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> beta_samples[idx]</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> np.sqrt(sigma2_samples[idx])</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mean prediction</span></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>    y_mean <span class="op">=</span> X_full <span class="op">@</span> beta</span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add noise</span></span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>    y_counter_samples[i] <span class="op">=</span> y_mean <span class="op">+</span> np.random.randn(n_total) <span class="op">*</span> sigma</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior statistics</span></span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>y_counter_mean <span class="op">=</span> y_counter_samples.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>y_counter_lower <span class="op">=</span> np.percentile(y_counter_samples, <span class="fl">2.5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>y_counter_upper <span class="op">=</span> np.percentile(y_counter_samples, <span class="fl">97.5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'counterfactual'</span>] <span class="op">=</span> y_counter_mean</span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'counter_lower'</span>] <span class="op">=</span> y_counter_lower</span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'counter_upper'</span>] <span class="op">=</span> y_counter_upper</span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Counterfactual at baseline end (2019): </span><span class="sc">{</span>y_counter_mean[baseline_idx]<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Counterfactual at intervention (2021): </span><span class="sc">{</span>y_counter_mean[intervention_idx]<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Counterfactual at end (2025): </span><span class="sc">{</span>y_counter_mean[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Actual at intervention: </span><span class="sc">{</span>df<span class="sc">.</span>iloc[intervention_idx][<span class="st">'deaths'</span>]<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 4: Calculate Causal Effect</span></span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[4/6] Calculating causal effect..."</span>)</span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'effect'</span>] <span class="op">=</span> df[<span class="st">'deaths'</span>] <span class="op">-</span> df[<span class="st">'counterfactual'</span>]</span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'effect_lower'</span>] <span class="op">=</span> df[<span class="st">'deaths'</span>] <span class="op">-</span> df[<span class="st">'counter_upper'</span>]</span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'effect_upper'</span>] <span class="op">=</span> df[<span class="st">'deaths'</span>] <span class="op">-</span> df[<span class="st">'counter_lower'</span>]</span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Post-intervention summary</span></span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>post <span class="op">=</span> df[df[<span class="st">'date'</span>] <span class="op">&gt;=</span> intervention_date].copy()</span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>total_obs <span class="op">=</span> post[<span class="st">'deaths'</span>].<span class="bu">sum</span>()</span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>total_counter <span class="op">=</span> post[<span class="st">'counterfactual'</span>].<span class="bu">sum</span>()</span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>cumulative_effect <span class="op">=</span> post[<span class="st">'effect'</span>].<span class="bu">sum</span>()</span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>cumulative_lower <span class="op">=</span> post[<span class="st">'effect_lower'</span>].<span class="bu">sum</span>()</span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>cumulative_upper <span class="op">=</span> post[<span class="st">'effect_upper'</span>].<span class="bu">sum</span>()</span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>avg_effect <span class="op">=</span> post[<span class="st">'effect'</span>].mean()</span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>relative <span class="op">=</span> cumulative_effect <span class="op">/</span> total_counter <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  POST-INTERVENTION SUMMARY:"</span>)</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Observed deaths: </span><span class="sc">{</span>total_obs<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Counterfactual: </span><span class="sc">{</span>total_counter<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Cumulative effect: </span><span class="sc">{</span>cumulative_effect<span class="sc">:,.0f}</span><span class="ss"> (</span><span class="sc">{</span>relative<span class="sc">:+.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  95% CI: [</span><span class="sc">{</span>cumulative_lower<span class="sc">:,.0f}</span><span class="ss">, </span><span class="sc">{</span>cumulative_upper<span class="sc">:,.0f}</span><span class="ss">]"</span>)</span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Average weekly: </span><span class="sc">{</span>avg_effect<span class="sc">:,.1f}</span><span class="ss"> deaths/week"</span>)</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 5: Posterior Probabilities</span></span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[5/6] Computing posterior probabilities..."</span>)</span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>effect_samples <span class="op">=</span> np.zeros(n_posterior)</span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_posterior):</span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a>    post_counter <span class="op">=</span> y_counter_samples[i, intervention_idx:]</span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>    post_obs <span class="op">=</span> df_post[<span class="st">'deaths'</span>].values</span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>    effect_samples[i] <span class="op">=</span> (post_obs <span class="op">-</span> post_counter).<span class="bu">sum</span>()</span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>prob_pos <span class="op">=</span> (effect_samples <span class="op">&gt;</span> <span class="dv">0</span>).mean()</span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>prob_neg <span class="op">=</span> (effect_samples <span class="op">&lt;</span> <span class="dv">0</span>).mean()</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  P(Effect &gt; 0): </span><span class="sc">{</span>prob_pos<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  P(Effect &lt; 0): </span><span class="sc">{</span>prob_neg<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 6: Visualization</span></span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[6/6] Creating visualization..."</span>)</span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">14</span>))</span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>gs <span class="op">=</span> fig.add_gridspec(<span class="dv">4</span>, <span class="dv">2</span>, height_ratios<span class="op">=</span>[<span class="fl">1.2</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>], hspace<span class="op">=</span><span class="fl">0.35</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 1: Observed vs Counterfactual</span></span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, :])</span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>ax1.plot(df[<span class="st">'date'</span>], df[<span class="st">'deaths'</span>], linewidth<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">'black'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Observed'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>ax1.plot(df[<span class="st">'date'</span>], df[<span class="st">'counterfactual'</span>], linewidth<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">'blue'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, </span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>         alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Counterfactual (2014-2019 Baseline)'</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>ax1.fill_between(df[<span class="st">'date'</span>], df[<span class="st">'counter_lower'</span>], df[<span class="st">'counter_upper'</span>],</span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>                  alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'blue'</span>, label<span class="op">=</span><span class="st">'95% CI'</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark periods</span></span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>ax1.axvline(baseline_end, color<span class="op">=</span><span class="st">'green'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>ax1.text(baseline_end, ax1.get_ylim()[<span class="dv">1</span>]<span class="op">*</span><span class="fl">0.98</span>, <span class="st">'Baseline End</span><span class="ch">\n</span><span class="st">(2019-12-31)'</span>, </span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>         ha<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'green'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>ax1.axvline(intervention_date, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, zorder<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>ax1.text(intervention_date, ax1.get_ylim()[<span class="dv">1</span>]<span class="op">*</span><span class="fl">0.88</span>, </span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>         <span class="st">'Max Vaccine Uptake</span><span class="ch">\n</span><span class="st">Week 14, 2021'</span>, </span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>         ha<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, color<span class="op">=</span><span class="st">'red'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>         bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'yellow'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>, linewidth<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Weekly Deaths'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Bayesian Counterfactual Analysis: Observed vs Expected (2014-2019 Baseline)</span><span class="ch">\n</span><span class="st">Malignant Neoplasms (C00-C97), All Ages'</span>, </span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>              fontsize<span class="op">=</span><span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>ax1.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, framealpha<span class="op">=</span><span class="fl">0.95</span>)</span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>ax1.yaxis.set_major_formatter(plt.FuncFormatter(<span class="kw">lambda</span> x, p: <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x)<span class="sc">:,}</span><span class="ss">'</span>))</span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 2: Causal Effect</span></span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, :])</span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>post_dates <span class="op">=</span> post[<span class="st">'date'</span>]</span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>ax2.plot(post_dates, post[<span class="st">'effect'</span>], linewidth<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">'darkred'</span>, label<span class="op">=</span><span class="st">'Causal Effect'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>ax2.fill_between(post_dates, post[<span class="st">'effect_lower'</span>], post[<span class="st">'effect_upper'</span>],</span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>                  alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'95% CI'</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>ax2.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>ax2.fill_between(post_dates, <span class="dv">0</span>, post[<span class="st">'effect'</span>],</span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>                  where<span class="op">=</span>(post[<span class="st">'effect'</span>] <span class="op">&gt;</span> <span class="dv">0</span>), alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'red'</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>ax2.fill_between(post_dates, <span class="dv">0</span>, post[<span class="st">'effect'</span>],</span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a>                  where<span class="op">=</span>(post[<span class="st">'effect'</span>] <span class="op">&lt;</span> <span class="dv">0</span>), alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'green'</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Causal Effect (Deaths/Week)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Estimated Causal Impact (Post-Intervention)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>ax2.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>stats_text <span class="op">=</span> <span class="ss">f"""Cumulative Causal Impact:</span></span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a><span class="ss">Effect: </span><span class="sc">{</span>cumulative_effect<span class="sc">:,.0f}</span><span class="ss"> deaths</span></span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a><span class="ss">95% CI: [</span><span class="sc">{</span>cumulative_lower<span class="sc">:,.0f}</span><span class="ss">, </span><span class="sc">{</span>cumulative_upper<span class="sc">:,.0f}</span><span class="ss">]</span></span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a><span class="ss">Avg Weekly: </span><span class="sc">{</span>avg_effect<span class="sc">:,.1f}</span><span class="ss">/week</span></span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a><span class="ss">Relative: </span><span class="sc">{</span>relative<span class="sc">:+.2f}</span><span class="ss">%</span></span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a><span class="ss">P(Effect &gt; 0): </span><span class="sc">{</span>prob_pos<span class="sc">:.3f}</span></span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>ax2.text(<span class="fl">0.98</span>, <span class="fl">0.97</span>, stats_text, transform<span class="op">=</span>ax2.transAxes,</span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>         fontsize<span class="op">=</span><span class="dv">10</span>, va<span class="op">=</span><span class="st">'top'</span>, ha<span class="op">=</span><span class="st">'right'</span>,</span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>         bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'wheat'</span>, alpha<span class="op">=</span><span class="fl">0.95</span>),</span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>         family<span class="op">=</span><span class="st">'monospace'</span>)</span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 3: Cumulative</span></span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>ax3 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>cumsum <span class="op">=</span> post[<span class="st">'effect'</span>].cumsum()</span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>cumsum_lower <span class="op">=</span> post[<span class="st">'effect_lower'</span>].cumsum()</span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>cumsum_upper <span class="op">=</span> post[<span class="st">'effect_upper'</span>].cumsum()</span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>ax3.plot(post_dates, cumsum, linewidth<span class="op">=</span><span class="dv">3</span>, color<span class="op">=</span><span class="st">'darkred'</span>)</span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>ax3.fill_between(post_dates, cumsum_lower, cumsum_upper, alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>ax3.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Cumulative Deaths'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Cumulative Causal Impact'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>ax3.yaxis.set_major_formatter(plt.FuncFormatter(<span class="kw">lambda</span> x, p: <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x)<span class="sc">:,}</span><span class="ss">'</span>))</span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 4: Posterior Distribution</span></span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>ax4 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>ax4.hist(effect_samples, bins<span class="op">=</span><span class="dv">50</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">'steelblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>ax4.axvline(np.median(effect_samples), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f'Median: </span><span class="sc">{</span>np<span class="sc">.</span>median(effect_samples)<span class="sc">:,.0f}</span><span class="ss">'</span>)</span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>ax4.axvline(np.percentile(effect_samples, <span class="fl">2.5</span>), color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>ax4.axvline(np.percentile(effect_samples, <span class="fl">97.5</span>), color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>ax4.axvline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>ax4.set_xlabel(<span class="st">'Cumulative Effect (Deaths)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a>ax4.set_ylabel(<span class="st">'Density'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>ax4.set_title(<span class="st">'Posterior Distribution'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>ax4.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>ax4.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 5: Pointwise Probability</span></span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>ax5 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">3</span>, :])</span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>pointwise_prob <span class="op">=</span> np.zeros(<span class="bu">len</span>(post))</span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(post)):</span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>    idx_full <span class="op">=</span> intervention_idx <span class="op">+</span> i</span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>    effect_at_t <span class="op">=</span> df[<span class="st">'deaths'</span>].iloc[idx_full] <span class="op">-</span> y_counter_samples[:, idx_full]</span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>    pointwise_prob[i] <span class="op">=</span> (effect_at_t <span class="op">&gt;</span> <span class="dv">0</span>).mean()</span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>ax5.plot(post_dates, pointwise_prob, linewidth<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">'purple'</span>)</span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>ax5.axhline(<span class="fl">0.5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>ax5.axhline(<span class="fl">0.95</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>ax5.fill_between(post_dates, <span class="fl">0.5</span>, pointwise_prob,</span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>                  where<span class="op">=</span>(pointwise_prob <span class="op">&gt;</span> <span class="fl">0.5</span>), alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>ax5.fill_between(post_dates, <span class="fl">0.5</span>, pointwise_prob,</span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a>                  where<span class="op">=</span>(pointwise_prob <span class="op">&lt;</span> <span class="fl">0.5</span>), alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>ax5.set_xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>ax5.set_ylabel(<span class="st">'Probability'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>ax5.set_title(<span class="st">'Pointwise Posterior Probability of Positive Effect'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>ax5.set_ylim([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>ax5.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a><span class="co"># Format x-axes</span></span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> [ax1, ax2, ax3, ax5]:</span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y'</span>))</span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>source <span class="op">=</span> (<span class="ss">f"Bayesian Counterfactual | Baseline: 2014-2019 | Intervention: 2021-04-10 | MOSAIC-20</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"Generated: </span><span class="sc">{</span>datetime<span class="sc">.</span>now()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.01</span>, source, ha<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>, style<span class="op">=</span><span class="st">'italic'</span>, color<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(bottom<span class="op">=</span><span class="fl">0.04</span>)</span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">'/mnt/user-data/outputs/mosaic20_bayesian_counterfactual_corrected.png'</span></span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a><span class="co"># Save results</span></span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> df[[<span class="st">'date'</span>, <span class="st">'deaths'</span>, <span class="st">'counterfactual'</span>, <span class="st">'counter_lower'</span>, <span class="st">'counter_upper'</span>,</span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'effect'</span>, <span class="st">'effect_lower'</span>, <span class="st">'effect_upper'</span>]].copy()</span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a>results_df.to_csv(<span class="st">'/mnt/user-data/outputs/mosaic20_bayesian_results_corrected.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ ANALYSIS COMPLETE"</span>)</span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved to: </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">FINAL RESULT:"</span>)</span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Cumulative effect: </span><span class="sc">{</span>cumulative_effect<span class="sc">:,.0f}</span><span class="ss"> deaths (</span><span class="sc">{</span>relative<span class="sc">:+.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  95% CI: [</span><span class="sc">{</span>cumulative_lower<span class="sc">:,.0f}</span><span class="ss">, </span><span class="sc">{</span>cumulative_upper<span class="sc">:,.0f}</span><span class="ss">]"</span>)</span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  P(Effect &gt; 0): </span><span class="sc">{</span>prob_pos<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> cumulative_effect <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  CONCLUSION: EXCESS deaths post-intervention"</span>)</span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  CONCLUSION: DEFICIT of deaths post-intervention"</span>)</span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
MOSAIC-20: BAYESIAN COUNTERFACTUAL ANALYSIS (CORRECTED)
================================================================================

[1/6] Loading combined dataset...
  Dataset: 631 weeks
  Date range: 2014-01-04 to 2026-01-31
  Baseline period: 2014-2019 (ends 2019-12-28)
  Intervention date: 2021-04-10
  Baseline: 313 weeks
  Pre-intervention (2014-2021): 379 weeks
  Post-intervention (2021-2025): 252 weeks

[2/6] Fitting baseline model using 2014-2019 data ONLY...
  Running Bayesian MCMC (5000 iterations)...
  Baseline mean: 11,444.0 deaths/week
  Baseline trend: 0.4832 deaths/week per week
  Annual trend: 25.1 deaths/year
  Baseline std: 201.5
  Observed 2014-2019 mean: 11,443.9

[3/6] Projecting counterfactual for full period...
  Counterfactual at baseline end (2019): 11,494.1
  Counterfactual at intervention (2021): 11,462.1
  Counterfactual at end (2025): 11,646.7
  Actual at intervention: 11,561.0

[4/6] Calculating causal effect...

  POST-INTERVENTION SUMMARY:
  Observed deaths: 2,961,786
  Counterfactual: 2,906,800
  Cumulative effect: 54,986 (+1.89%)
  95% CI: [-45,031, 155,543]
  Average weekly: 218.2 deaths/week

[5/6] Computing posterior probabilities...
  P(Effect &gt; 0): 1.000
  P(Effect &lt; 0): 0.000

[6/6] Creating visualization...</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[21], line 358</span>
<span class="ansi-green-fg ansi-bold">    355</span> plt<span style="color:rgb(98,98,98)">.</span>subplots_adjust(bottom<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0.04</span>)
<span class="ansi-green-fg ansi-bold">    357</span> output_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">/mnt/user-data/outputs/mosaic20_bayesian_counterfactual_corrected.png</span><span style="color:rgb(175,0,0)">'</span>
<span class="ansi-green-fg">--&gt; 358</span> <span class="ansi-yellow-bg">plt</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">savefig</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">output_path</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dpi</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">300</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">bbox_inches</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">tight</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    360</span> <span style="font-style:italic;color:rgb(95,135,135)"># Save results</span>
<span class="ansi-green-fg ansi-bold">    361</span> results_df <span style="color:rgb(98,98,98)">=</span> df[[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">date</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">deaths</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">counterfactual</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">counter_lower</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">counter_upper</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">    362</span>                  <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">effect</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">effect_lower</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">effect_upper</span><span style="color:rgb(175,0,0)">'</span>]]<span style="color:rgb(98,98,98)">.</span>copy()

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/pyplot.py:1023</span>, in <span class="ansi-cyan-fg">savefig</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1020</span> <span style="color:rgb(175,0,255)">@_copy_docstring_and_deprecators</span>(Figure<span style="color:rgb(98,98,98)">.</span>savefig)
<span class="ansi-green-fg ansi-bold">   1021</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">savefig</span>(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs):
<span class="ansi-green-fg ansi-bold">   1022</span>     fig <span style="color:rgb(98,98,98)">=</span> gcf()
<span class="ansi-green-fg">-&gt; 1023</span>     res <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">fig</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">savefig</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1024</span>     fig<span style="color:rgb(98,98,98)">.</span>canvas<span style="color:rgb(98,98,98)">.</span>draw_idle()  <span style="font-style:italic;color:rgb(95,135,135)"># Need this if 'transparent=True', to reset colors.</span>
<span class="ansi-green-fg ansi-bold">   1025</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> res

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/figure.py:3378</span>, in <span class="ansi-cyan-fg">Figure.savefig</span><span class="ansi-blue-fg">(self, fname, transparent, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   3374</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> ax <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>axes:
<span class="ansi-green-fg ansi-bold">   3375</span>         stack<span style="color:rgb(98,98,98)">.</span>enter_context(
<span class="ansi-green-fg ansi-bold">   3376</span>             ax<span style="color:rgb(98,98,98)">.</span>patch<span style="color:rgb(98,98,98)">.</span>_cm_set(facecolor<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">none</span><span style="color:rgb(175,0,0)">'</span>, edgecolor<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">none</span><span style="color:rgb(175,0,0)">'</span>))
<span class="ansi-green-fg">-&gt; 3378</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">canvas</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">print_figure</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">fname</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/backend_bases.py:2366</span>, in <span class="ansi-cyan-fg">FigureCanvasBase.print_figure</span><span class="ansi-blue-fg">(self, filename, dpi, facecolor, edgecolor, orientation, format, bbox_inches, pad_inches, bbox_extra_artists, backend, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   2362</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   2363</span>     <span style="font-style:italic;color:rgb(95,135,135)"># _get_renderer may change the figure dpi (as vector formats</span>
<span class="ansi-green-fg ansi-bold">   2364</span>     <span style="font-style:italic;color:rgb(95,135,135)"># force the figure dpi to 72), so we need to set it again here.</span>
<span class="ansi-green-fg ansi-bold">   2365</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> cbook<span style="color:rgb(98,98,98)">.</span>_setattr_cm(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>figure, dpi<span style="color:rgb(98,98,98)">=</span>dpi):
<span class="ansi-green-fg">-&gt; 2366</span>         result <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">print_method</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">   2367</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">filename</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   2368</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">facecolor</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">facecolor</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   2369</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">edgecolor</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">edgecolor</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   2370</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">orientation</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">orientation</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   2371</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">bbox_inches_restore</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">_bbox_inches_restore</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   2372</span> <span class="ansi-yellow-bg">            </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   2373</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">   2374</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> bbox_inches <span style="font-weight:bold;color:rgb(175,0,255)">and</span> restore_bbox:

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/backend_bases.py:2232</span>, in <span class="ansi-cyan-fg">FigureCanvasBase._switch_canvas_and_return_print_method.&lt;locals&gt;.&lt;lambda&gt;</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   2228</span>     optional_kws <span style="color:rgb(98,98,98)">=</span> {  <span style="font-style:italic;color:rgb(95,135,135)"># Passed by print_figure for other renderers.</span>
<span class="ansi-green-fg ansi-bold">   2229</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">dpi</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">facecolor</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">edgecolor</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">orientation</span><span style="color:rgb(175,0,0)">"</span>,
<span class="ansi-green-fg ansi-bold">   2230</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">bbox_inches_restore</span><span style="color:rgb(175,0,0)">"</span>}
<span class="ansi-green-fg ansi-bold">   2231</span>     skip <span style="color:rgb(98,98,98)">=</span> optional_kws <span style="color:rgb(98,98,98)">-</span> {<span style="color:rgb(98,98,98)">*</span>inspect<span style="color:rgb(98,98,98)">.</span>signature(meth)<span style="color:rgb(98,98,98)">.</span>parameters}
<span class="ansi-green-fg">-&gt; 2232</span>     print_method <span style="color:rgb(98,98,98)">=</span> functools<span style="color:rgb(98,98,98)">.</span>wraps(meth)(<span style="font-weight:bold;color:rgb(0,135,0)">lambda</span> <span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs: <span class="ansi-yellow-bg">meth</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">   2233</span> <span class="ansi-yellow-bg">        </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">{</span><span class="ansi-yellow-bg">k</span><span class="ansi-yellow-bg">:</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">v</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">for</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">k</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">v</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(175,0,255)" class="ansi-yellow-bg">in</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">items</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">if</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">k</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(175,0,255)" class="ansi-yellow-bg">not</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(175,0,255)" class="ansi-yellow-bg">in</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">skip</span><span class="ansi-yellow-bg">}</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">   2234</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:  <span style="font-style:italic;color:rgb(95,135,135)"># Let third-parties do as they see fit.</span>
<span class="ansi-green-fg ansi-bold">   2235</span>     print_method <span style="color:rgb(98,98,98)">=</span> meth

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:509</span>, in <span class="ansi-cyan-fg">FigureCanvasAgg.print_png</span><span class="ansi-blue-fg">(self, filename_or_obj, metadata, pil_kwargs)</span>
<span class="ansi-green-fg ansi-bold">    462</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">print_png</span>(<span style="color:rgb(0,135,0)">self</span>, filename_or_obj, <span style="color:rgb(98,98,98)">*</span>, metadata<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">None</span>, pil_kwargs<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">None</span>):
<span class="ansi-green-fg ansi-bold">    463</span> <span style="color:rgb(188,188,188)">    </span><span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    464</span> <span style="font-style:italic;color:rgb(175,0,0)">    Write the figure to a PNG file.</span>
<span class="ansi-green-fg ansi-bold">    465</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    507</span> <span style="font-style:italic;color:rgb(175,0,0)">        *metadata*, including the default 'Software' key.</span>
<span class="ansi-green-fg ansi-bold">    508</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">--&gt; 509</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_print_pil</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filename_or_obj</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">png</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">pil_kwargs</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">metadata</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:458</span>, in <span class="ansi-cyan-fg">FigureCanvasAgg._print_pil</span><span class="ansi-blue-fg">(self, filename_or_obj, fmt, pil_kwargs, metadata)</span>
<span class="ansi-green-fg ansi-bold">    453</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    454</span> <span style="font-style:italic;color:rgb(175,0,0)">Draw the canvas, then save it using `.image.imsave` (to which</span>
<span class="ansi-green-fg ansi-bold">    455</span> <span style="font-style:italic;color:rgb(175,0,0)">*pil_kwargs* and *metadata* are forwarded).</span>
<span class="ansi-green-fg ansi-bold">    456</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    457</span> FigureCanvasAgg<span style="color:rgb(98,98,98)">.</span>draw(<span style="color:rgb(0,135,0)">self</span>)
<span class="ansi-green-fg">--&gt; 458</span> <span class="ansi-yellow-bg">mpl</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">image</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">imsave</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    459</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">filename_or_obj</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">buffer_rgba</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">format</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">fmt</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">origin</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">upper</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    460</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">dpi</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">figure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">dpi</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">metadata</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">metadata</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">pil_kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">pil_kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/image.py:1689</span>, in <span class="ansi-cyan-fg">imsave</span><span class="ansi-blue-fg">(fname, arr, vmin, vmax, cmap, format, origin, dpi, metadata, pil_kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1687</span> pil_kwargs<span style="color:rgb(98,98,98)">.</span>setdefault(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">format</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(0,135,0)">format</span>)
<span class="ansi-green-fg ansi-bold">   1688</span> pil_kwargs<span style="color:rgb(98,98,98)">.</span>setdefault(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">dpi</span><span style="color:rgb(175,0,0)">"</span>, (dpi, dpi))
<span class="ansi-green-fg">-&gt; 1689</span> <span class="ansi-yellow-bg">image</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">save</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">fname</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">pil_kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/PIL/Image.py:2410</span>, in <span class="ansi-cyan-fg">Image.save</span><span class="ansi-blue-fg">(self, fp, format, **params)</span>
<span class="ansi-green-fg ansi-bold">   2408</span>         fp <span style="color:rgb(98,98,98)">=</span> builtins<span style="color:rgb(98,98,98)">.</span>open(filename, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">r+b</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   2409</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 2410</span>         fp <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">builtins</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filename</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">w+b</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   2412</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   2413</span>     save_handler(<span style="color:rgb(0,135,0)">self</span>, fp, filename)

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: '/mnt/user-data/outputs/mosaic20_bayesian_counterfactual_corrected.png'</pre>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="mosaic-20-cancer-analysis_files/figure-html/cell-8-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="5947169e-7601-47c5-86d5-c4b029df5c9d" class="cell" data-execution_count="22">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">MOSAIC-20: CausalImpact Analysis</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">Implements Bayesian structural time series for causal inference</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">Based on Google's CausalImpact methodology</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.linalg <span class="im">import</span> solve</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"MOSAIC-20: CAUSAL IMPACT ANALYSIS (Bayesian Structural Time Series)"</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 1: Load and Prepare Data</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[1/5] Loading data..."</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df_combined.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Define periods</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>pre_period_end <span class="op">=</span> pd.Timestamp(<span class="st">'2021-04-03'</span>)  <span class="co"># Week before intervention</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>post_period_start <span class="op">=</span> pd.Timestamp(<span class="st">'2021-04-10'</span>)  <span class="co"># Week 14, 2021</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>pre_data <span class="op">=</span> df[df[<span class="st">'date'</span>] <span class="op">&lt;=</span> pre_period_end].copy()</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>post_data <span class="op">=</span> df[df[<span class="st">'date'</span>] <span class="op">&gt;=</span> post_period_start].copy()</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>all_data <span class="op">=</span> df.copy()</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Total: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pre-intervention: </span><span class="sc">{</span><span class="bu">len</span>(pre_data)<span class="sc">}</span><span class="ss"> weeks (training)"</span>)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Post-intervention: </span><span class="sc">{</span><span class="bu">len</span>(post_data)<span class="sc">}</span><span class="ss"> weeks (prediction)"</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Intervention date: </span><span class="sc">{</span>post_period_start<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 2: Bayesian Structural Time Series Model</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[2/5] Fitting Bayesian Structural Time Series model..."</span>)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BayesianStructuralTimeSeries:</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="co">    Implements local level + trend + seasonal components</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="co">    Similar to CausalImpact's default specification</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, y, seasonal_period<span class="op">=</span><span class="dv">52</span>):</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.y <span class="op">=</span> y</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n <span class="op">=</span> <span class="bu">len</span>(y)</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.seasonal_period <span class="op">=</span> seasonal_period</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, n_samples<span class="op">=</span><span class="dv">2000</span>, burn_in<span class="op">=</span><span class="dv">500</span>):</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Fit model using Gibbs sampling"""</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> <span class="va">self</span>.y</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="va">self</span>.n</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Design matrix for seasonality</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> np.arange(n)</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>        X_seasonal <span class="op">=</span> np.column_stack([</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>            np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>            np.cos(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>            np.sin(<span class="dv">4</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>            np.cos(<span class="dv">4</span> <span class="op">*</span> np.pi <span class="op">*</span> t <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize parameters</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>        level <span class="op">=</span> np.zeros(n)</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>        trend <span class="op">=</span> np.zeros(n)</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>        seasonal <span class="op">=</span> np.zeros((n, <span class="dv">4</span>))</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initial values</span></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>        level[<span class="dv">0</span>] <span class="op">=</span> y[<span class="dv">0</span>]</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>        trend[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Hyperparameters (variances)</span></span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>        sigma_obs <span class="op">=</span> np.std(y)</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>        sigma_level <span class="op">=</span> sigma_obs <span class="op">/</span> <span class="dv">10</span></span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>        sigma_trend <span class="op">=</span> sigma_obs <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>        sigma_seasonal <span class="op">=</span> sigma_obs <span class="op">/</span> <span class="dv">20</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Storage for samples</span></span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>        level_samples <span class="op">=</span> np.zeros((n_samples, n))</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>        trend_samples <span class="op">=</span> np.zeros((n_samples, n))</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>        seasonal_coef_samples <span class="op">=</span> np.zeros((n_samples, <span class="dv">4</span>))</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>        sigma_samples <span class="op">=</span> np.zeros((n_samples, <span class="dv">3</span>))  <span class="co"># obs, level, trend</span></span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gibbs sampling</span></span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Running Gibbs sampling (</span><span class="sc">{</span>n_samples<span class="sc">}</span><span class="ss"> iterations)..."</span>)</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> s <span class="kw">in</span> <span class="bu">range</span>(n_samples):</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Sample states (Kalman filter/smoother)</span></span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Simplified: use regression for computational efficiency</span></span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Current estimate of seasonal component</span></span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>            seasonal_effect <span class="op">=</span> X_seasonal <span class="op">@</span> seasonal_coef_samples[<span class="bu">max</span>(<span class="dv">0</span>, s<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Deseasonalized data</span></span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>            y_deseas <span class="op">=</span> y <span class="op">-</span> seasonal_effect</span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fit local linear trend</span></span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>            <span class="co"># State: [level, trend]</span></span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Transition: level[t] = level[t-1] + trend[t-1]</span></span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>            <span class="co">#            trend[t] = trend[t-1]</span></span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use exponential smoothing for simplicity</span></span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> <span class="fl">0.9</span>  <span class="co"># Level smoothing</span></span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>            beta <span class="op">=</span> <span class="fl">0.1</span>   <span class="co"># Trend smoothing</span></span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a>            level <span class="op">=</span> np.zeros(n)</span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a>            trend <span class="op">=</span> np.zeros(n)</span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a>            level[<span class="dv">0</span>] <span class="op">=</span> y_deseas[<span class="dv">0</span>]</span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a>            trend[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n):</span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a>                level[t] <span class="op">=</span> alpha <span class="op">*</span> y_deseas[t] <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> (level[t<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> trend[t<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>                trend[t] <span class="op">=</span> beta <span class="op">*</span> (level[t] <span class="op">-</span> level[t<span class="op">-</span><span class="dv">1</span>]) <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> beta) <span class="op">*</span> trend[t<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Sample seasonal coefficients</span></span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>            resid <span class="op">=</span> y <span class="op">-</span> (level <span class="op">+</span> trend.cumsum())</span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>            V_seasonal <span class="op">=</span> np.linalg.inv(X_seasonal.T <span class="op">@</span> X_seasonal <span class="op">/</span> sigma_obs<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> </span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>                                      np.eye(<span class="dv">4</span>) <span class="op">/</span> sigma_seasonal<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>            m_seasonal <span class="op">=</span> V_seasonal <span class="op">@</span> (X_seasonal.T <span class="op">@</span> resid <span class="op">/</span> sigma_obs<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>            seasonal_coef <span class="op">=</span> np.random.multivariate_normal(m_seasonal, V_seasonal)</span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Sample variances</span></span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>            resid_full <span class="op">=</span> y <span class="op">-</span> (level <span class="op">+</span> trend.cumsum() <span class="op">+</span> X_seasonal <span class="op">@</span> seasonal_coef)</span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>            sigma_obs <span class="op">=</span> np.sqrt(<span class="dv">1</span> <span class="op">/</span> np.random.gamma(n<span class="op">/</span><span class="dv">2</span>, <span class="dv">2</span><span class="op">/</span>(np.<span class="bu">sum</span>(resid_full<span class="op">**</span><span class="dv">2</span>) <span class="op">+</span> <span class="fl">0.01</span>)))</span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store samples</span></span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a>            level_samples[s] <span class="op">=</span> level</span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a>            trend_samples[s] <span class="op">=</span> trend.cumsum()  <span class="co"># Cumulative trend</span></span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a>            seasonal_coef_samples[s] <span class="op">=</span> seasonal_coef</span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>            sigma_samples[s] <span class="op">=</span> [sigma_obs, sigma_level, sigma_trend]</span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Burn-in</span></span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.level_samples <span class="op">=</span> level_samples[burn_in:]</span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.trend_samples <span class="op">=</span> trend_samples[burn_in:]</span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.seasonal_coef_samples <span class="op">=</span> seasonal_coef_samples[burn_in:]</span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sigma_samples <span class="op">=</span> sigma_samples[burn_in:]</span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Kept </span><span class="sc">{</span><span class="bu">len</span>(<span class="va">self</span>.level_samples)<span class="sc">}</span><span class="ss"> samples after burn-in"</span>)</span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-150"><a href="#cb16-150" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, n_ahead):</span>
<span id="cb16-151"><a href="#cb16-151" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Generate predictive distribution"""</span></span>
<span id="cb16-152"><a href="#cb16-152" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-153"><a href="#cb16-153" aria-hidden="true" tabindex="-1"></a>        n_samples <span class="op">=</span> <span class="bu">len</span>(<span class="va">self</span>.level_samples)</span>
<span id="cb16-154"><a href="#cb16-154" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> np.zeros((n_samples, n_ahead))</span>
<span id="cb16-155"><a href="#cb16-155" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-156"><a href="#cb16-156" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Seasonal design matrix for prediction period</span></span>
<span id="cb16-157"><a href="#cb16-157" aria-hidden="true" tabindex="-1"></a>        t_pred <span class="op">=</span> np.arange(<span class="va">self</span>.n, <span class="va">self</span>.n <span class="op">+</span> n_ahead)</span>
<span id="cb16-158"><a href="#cb16-158" aria-hidden="true" tabindex="-1"></a>        X_pred <span class="op">=</span> np.column_stack([</span>
<span id="cb16-159"><a href="#cb16-159" aria-hidden="true" tabindex="-1"></a>            np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t_pred <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb16-160"><a href="#cb16-160" aria-hidden="true" tabindex="-1"></a>            np.cos(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> t_pred <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb16-161"><a href="#cb16-161" aria-hidden="true" tabindex="-1"></a>            np.sin(<span class="dv">4</span> <span class="op">*</span> np.pi <span class="op">*</span> t_pred <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb16-162"><a href="#cb16-162" aria-hidden="true" tabindex="-1"></a>            np.cos(<span class="dv">4</span> <span class="op">*</span> np.pi <span class="op">*</span> t_pred <span class="op">/</span> <span class="dv">52</span>),</span>
<span id="cb16-163"><a href="#cb16-163" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb16-164"><a href="#cb16-164" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-165"><a href="#cb16-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> s <span class="kw">in</span> <span class="bu">range</span>(n_samples):</span>
<span id="cb16-166"><a href="#cb16-166" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Last level and trend</span></span>
<span id="cb16-167"><a href="#cb16-167" aria-hidden="true" tabindex="-1"></a>            last_level <span class="op">=</span> <span class="va">self</span>.level_samples[s, <span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb16-168"><a href="#cb16-168" aria-hidden="true" tabindex="-1"></a>            last_trend_value <span class="op">=</span> <span class="va">self</span>.trend_samples[s, <span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> <span class="va">self</span>.trend_samples[s, <span class="op">-</span><span class="dv">2</span>] <span class="cf">if</span> <span class="va">self</span>.n <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb16-169"><a href="#cb16-169" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-170"><a href="#cb16-170" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Seasonal component</span></span>
<span id="cb16-171"><a href="#cb16-171" aria-hidden="true" tabindex="-1"></a>            seasonal <span class="op">=</span> X_pred <span class="op">@</span> <span class="va">self</span>.seasonal_coef_samples[s]</span>
<span id="cb16-172"><a href="#cb16-172" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-173"><a href="#cb16-173" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Project forward with trend</span></span>
<span id="cb16-174"><a href="#cb16-174" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(n_ahead):</span>
<span id="cb16-175"><a href="#cb16-175" aria-hidden="true" tabindex="-1"></a>                level_t <span class="op">=</span> last_level <span class="op">+</span> last_trend_value <span class="op">*</span> (t <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb16-176"><a href="#cb16-176" aria-hidden="true" tabindex="-1"></a>                predictions[s, t] <span class="op">=</span> level_t <span class="op">+</span> seasonal[t] <span class="op">+</span> <span class="op">\</span></span>
<span id="cb16-177"><a href="#cb16-177" aria-hidden="true" tabindex="-1"></a>                                   np.random.randn() <span class="op">*</span> <span class="va">self</span>.sigma_samples[s, <span class="dv">0</span>]</span>
<span id="cb16-178"><a href="#cb16-178" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-179"><a href="#cb16-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> predictions</span>
<span id="cb16-180"><a href="#cb16-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-181"><a href="#cb16-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model on pre-intervention data</span></span>
<span id="cb16-182"><a href="#cb16-182" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Initializing BSTS model..."</span>)</span>
<span id="cb16-183"><a href="#cb16-183" aria-hidden="true" tabindex="-1"></a>bsts <span class="op">=</span> BayesianStructuralTimeSeries(pre_data[<span class="st">'deaths'</span>].values, seasonal_period<span class="op">=</span><span class="dv">52</span>)</span>
<span id="cb16-184"><a href="#cb16-184" aria-hidden="true" tabindex="-1"></a>bsts.fit(n_samples<span class="op">=</span><span class="dv">2000</span>, burn_in<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb16-185"><a href="#cb16-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-186"><a href="#cb16-186" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb16-187"><a href="#cb16-187" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 3: Generate Counterfactual Predictions</span></span>
<span id="cb16-188"><a href="#cb16-188" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb16-189"><a href="#cb16-189" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[3/5] Generating counterfactual predictions..."</span>)</span>
<span id="cb16-190"><a href="#cb16-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-191"><a href="#cb16-191" aria-hidden="true" tabindex="-1"></a>n_post <span class="op">=</span> <span class="bu">len</span>(post_data)</span>
<span id="cb16-192"><a href="#cb16-192" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> bsts.predict(n_post)</span>
<span id="cb16-193"><a href="#cb16-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-194"><a href="#cb16-194" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate posterior statistics</span></span>
<span id="cb16-195"><a href="#cb16-195" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="op">=</span> predictions.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-196"><a href="#cb16-196" aria-hidden="true" tabindex="-1"></a>pred_lower <span class="op">=</span> np.percentile(predictions, <span class="fl">2.5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-197"><a href="#cb16-197" aria-hidden="true" tabindex="-1"></a>pred_upper <span class="op">=</span> np.percentile(predictions, <span class="fl">97.5</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-198"><a href="#cb16-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-199"><a href="#cb16-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Add to dataframe</span></span>
<span id="cb16-200"><a href="#cb16-200" aria-hidden="true" tabindex="-1"></a>all_data[<span class="st">'counterfactual'</span>] <span class="op">=</span> np.nan</span>
<span id="cb16-201"><a href="#cb16-201" aria-hidden="true" tabindex="-1"></a>all_data[<span class="st">'counter_lower'</span>] <span class="op">=</span> np.nan</span>
<span id="cb16-202"><a href="#cb16-202" aria-hidden="true" tabindex="-1"></a>all_data[<span class="st">'counter_upper'</span>] <span class="op">=</span> np.nan</span>
<span id="cb16-203"><a href="#cb16-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-204"><a href="#cb16-204" aria-hidden="true" tabindex="-1"></a>post_indices <span class="op">=</span> all_data[all_data[<span class="st">'date'</span>] <span class="op">&gt;=</span> post_period_start].index</span>
<span id="cb16-205"><a href="#cb16-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-206"><a href="#cb16-206" aria-hidden="true" tabindex="-1"></a>all_data.loc[post_indices, <span class="st">'counterfactual'</span>] <span class="op">=</span> pred_mean</span>
<span id="cb16-207"><a href="#cb16-207" aria-hidden="true" tabindex="-1"></a>all_data.loc[post_indices, <span class="st">'counter_lower'</span>] <span class="op">=</span> pred_lower</span>
<span id="cb16-208"><a href="#cb16-208" aria-hidden="true" tabindex="-1"></a>all_data.loc[post_indices, <span class="st">'counter_upper'</span>] <span class="op">=</span> pred_upper</span>
<span id="cb16-209"><a href="#cb16-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-210"><a href="#cb16-210" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Generated predictions for </span><span class="sc">{</span>n_post<span class="sc">}</span><span class="ss"> weeks"</span>)</span>
<span id="cb16-211"><a href="#cb16-211" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean prediction at intervention: </span><span class="sc">{</span>pred_mean[<span class="dv">0</span>]<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb16-212"><a href="#cb16-212" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean prediction at end: </span><span class="sc">{</span>pred_mean[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:,.1f}</span><span class="ss">"</span>)</span>
<span id="cb16-213"><a href="#cb16-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-214"><a href="#cb16-214" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb16-215"><a href="#cb16-215" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 4: Calculate Causal Impact</span></span>
<span id="cb16-216"><a href="#cb16-216" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb16-217"><a href="#cb16-217" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[4/5] Calculating causal impact..."</span>)</span>
<span id="cb16-218"><a href="#cb16-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-219"><a href="#cb16-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Point-wise effect</span></span>
<span id="cb16-220"><a href="#cb16-220" aria-hidden="true" tabindex="-1"></a>post_data_copy <span class="op">=</span> post_data.copy()</span>
<span id="cb16-221"><a href="#cb16-221" aria-hidden="true" tabindex="-1"></a>post_data_copy[<span class="st">'counterfactual'</span>] <span class="op">=</span> pred_mean</span>
<span id="cb16-222"><a href="#cb16-222" aria-hidden="true" tabindex="-1"></a>post_data_copy[<span class="st">'counter_lower'</span>] <span class="op">=</span> pred_lower</span>
<span id="cb16-223"><a href="#cb16-223" aria-hidden="true" tabindex="-1"></a>post_data_copy[<span class="st">'counter_upper'</span>] <span class="op">=</span> pred_upper</span>
<span id="cb16-224"><a href="#cb16-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-225"><a href="#cb16-225" aria-hidden="true" tabindex="-1"></a>post_data_copy[<span class="st">'point_effect'</span>] <span class="op">=</span> post_data_copy[<span class="st">'deaths'</span>] <span class="op">-</span> pred_mean</span>
<span id="cb16-226"><a href="#cb16-226" aria-hidden="true" tabindex="-1"></a>post_data_copy[<span class="st">'point_effect_lower'</span>] <span class="op">=</span> post_data_copy[<span class="st">'deaths'</span>] <span class="op">-</span> pred_upper</span>
<span id="cb16-227"><a href="#cb16-227" aria-hidden="true" tabindex="-1"></a>post_data_copy[<span class="st">'point_effect_upper'</span>] <span class="op">=</span> post_data_copy[<span class="st">'deaths'</span>] <span class="op">-</span> pred_lower</span>
<span id="cb16-228"><a href="#cb16-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-229"><a href="#cb16-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Cumulative effect</span></span>
<span id="cb16-230"><a href="#cb16-230" aria-hidden="true" tabindex="-1"></a>cumulative_samples <span class="op">=</span> (post_data[<span class="st">'deaths'</span>].values <span class="op">-</span> predictions).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-231"><a href="#cb16-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-232"><a href="#cb16-232" aria-hidden="true" tabindex="-1"></a>cumulative_effect <span class="op">=</span> cumulative_samples.mean()</span>
<span id="cb16-233"><a href="#cb16-233" aria-hidden="true" tabindex="-1"></a>cumulative_lower <span class="op">=</span> np.percentile(cumulative_samples, <span class="fl">2.5</span>)</span>
<span id="cb16-234"><a href="#cb16-234" aria-hidden="true" tabindex="-1"></a>cumulative_upper <span class="op">=</span> np.percentile(cumulative_samples, <span class="fl">97.5</span>)</span>
<span id="cb16-235"><a href="#cb16-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-236"><a href="#cb16-236" aria-hidden="true" tabindex="-1"></a><span class="co"># Average effect</span></span>
<span id="cb16-237"><a href="#cb16-237" aria-hidden="true" tabindex="-1"></a>avg_effect <span class="op">=</span> post_data_copy[<span class="st">'point_effect'</span>].mean()</span>
<span id="cb16-238"><a href="#cb16-238" aria-hidden="true" tabindex="-1"></a>avg_lower <span class="op">=</span> np.percentile(post_data[<span class="st">'deaths'</span>].values <span class="op">-</span> predictions, <span class="fl">2.5</span>, axis<span class="op">=</span><span class="dv">1</span>).mean()</span>
<span id="cb16-239"><a href="#cb16-239" aria-hidden="true" tabindex="-1"></a>avg_upper <span class="op">=</span> np.percentile(post_data[<span class="st">'deaths'</span>].values <span class="op">-</span> predictions, <span class="fl">97.5</span>, axis<span class="op">=</span><span class="dv">1</span>).mean()</span>
<span id="cb16-240"><a href="#cb16-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-241"><a href="#cb16-241" aria-hidden="true" tabindex="-1"></a><span class="co"># Relative effect</span></span>
<span id="cb16-242"><a href="#cb16-242" aria-hidden="true" tabindex="-1"></a>total_predicted <span class="op">=</span> pred_mean.<span class="bu">sum</span>()</span>
<span id="cb16-243"><a href="#cb16-243" aria-hidden="true" tabindex="-1"></a>relative_effect <span class="op">=</span> (cumulative_effect <span class="op">/</span> total_predicted) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb16-244"><a href="#cb16-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-245"><a href="#cb16-245" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior probability</span></span>
<span id="cb16-246"><a href="#cb16-246" aria-hidden="true" tabindex="-1"></a>prob_causal_effect <span class="op">=</span> (cumulative_samples <span class="op">&gt;</span> <span class="dv">0</span>).mean()</span>
<span id="cb16-247"><a href="#cb16-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-248"><a href="#cb16-248" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">  CAUSAL IMPACT SUMMARY:"</span>)</span>
<span id="cb16-249"><a href="#cb16-249" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Cumulative effect: </span><span class="sc">{</span>cumulative_effect<span class="sc">:,.0f}</span><span class="ss"> deaths"</span>)</span>
<span id="cb16-250"><a href="#cb16-250" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  95% CI: [</span><span class="sc">{</span>cumulative_lower<span class="sc">:,.0f}</span><span class="ss">, </span><span class="sc">{</span>cumulative_upper<span class="sc">:,.0f}</span><span class="ss">]"</span>)</span>
<span id="cb16-251"><a href="#cb16-251" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Average weekly effect: </span><span class="sc">{</span>avg_effect<span class="sc">:,.1f}</span><span class="ss"> deaths/week"</span>)</span>
<span id="cb16-252"><a href="#cb16-252" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Relative effect: </span><span class="sc">{</span>relative_effect<span class="sc">:+.2f}</span><span class="ss">%"</span>)</span>
<span id="cb16-253"><a href="#cb16-253" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Posterior P(effect &gt; 0): </span><span class="sc">{</span>prob_causal_effect<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb16-254"><a href="#cb16-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-255"><a href="#cb16-255" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb16-256"><a href="#cb16-256" aria-hidden="true" tabindex="-1"></a><span class="co"># STEP 5: Comprehensive Visualization</span></span>
<span id="cb16-257"><a href="#cb16-257" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb16-258"><a href="#cb16-258" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[5/5] Creating CausalImpact visualization..."</span>)</span>
<span id="cb16-259"><a href="#cb16-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-260"><a href="#cb16-260" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">14</span>))</span>
<span id="cb16-261"><a href="#cb16-261" aria-hidden="true" tabindex="-1"></a>gs <span class="op">=</span> fig.add_gridspec(<span class="dv">4</span>, <span class="dv">2</span>, height_ratios<span class="op">=</span>[<span class="fl">1.2</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>], hspace<span class="op">=</span><span class="fl">0.35</span>, wspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-262"><a href="#cb16-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-263"><a href="#cb16-263" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 1: Original series with counterfactual</span></span>
<span id="cb16-264"><a href="#cb16-264" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">0</span>, :])</span>
<span id="cb16-265"><a href="#cb16-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-266"><a href="#cb16-266" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-period</span></span>
<span id="cb16-267"><a href="#cb16-267" aria-hidden="true" tabindex="-1"></a>ax1.plot(pre_data[<span class="st">'date'</span>], pre_data[<span class="st">'deaths'</span>], </span>
<span id="cb16-268"><a href="#cb16-268" aria-hidden="true" tabindex="-1"></a>         linewidth<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">'black'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Observed (Pre)'</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb16-269"><a href="#cb16-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-270"><a href="#cb16-270" aria-hidden="true" tabindex="-1"></a><span class="co"># Post-period</span></span>
<span id="cb16-271"><a href="#cb16-271" aria-hidden="true" tabindex="-1"></a>ax1.plot(post_data[<span class="st">'date'</span>], post_data[<span class="st">'deaths'</span>], </span>
<span id="cb16-272"><a href="#cb16-272" aria-hidden="true" tabindex="-1"></a>         linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'red'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, label<span class="op">=</span><span class="st">'Observed (Post)'</span>, zorder<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb16-273"><a href="#cb16-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-274"><a href="#cb16-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Counterfactual</span></span>
<span id="cb16-275"><a href="#cb16-275" aria-hidden="true" tabindex="-1"></a>ax1.plot(post_data[<span class="st">'date'</span>], pred_mean, </span>
<span id="cb16-276"><a href="#cb16-276" aria-hidden="true" tabindex="-1"></a>         linewidth<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">'blue'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, </span>
<span id="cb16-277"><a href="#cb16-277" aria-hidden="true" tabindex="-1"></a>         alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">'Counterfactual Prediction'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb16-278"><a href="#cb16-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-279"><a href="#cb16-279" aria-hidden="true" tabindex="-1"></a><span class="co"># Credible interval</span></span>
<span id="cb16-280"><a href="#cb16-280" aria-hidden="true" tabindex="-1"></a>ax1.fill_between(post_data[<span class="st">'date'</span>], pred_lower, pred_upper,</span>
<span id="cb16-281"><a href="#cb16-281" aria-hidden="true" tabindex="-1"></a>                  alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'blue'</span>, label<span class="op">=</span><span class="st">'95% Credible Interval'</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-282"><a href="#cb16-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-283"><a href="#cb16-283" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark intervention</span></span>
<span id="cb16-284"><a href="#cb16-284" aria-hidden="true" tabindex="-1"></a>ax1.axvline(post_period_start, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">3</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, zorder<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb16-285"><a href="#cb16-285" aria-hidden="true" tabindex="-1"></a>ax1.text(post_period_start, ax1.get_ylim()[<span class="dv">1</span>]<span class="op">*</span><span class="fl">0.95</span>, </span>
<span id="cb16-286"><a href="#cb16-286" aria-hidden="true" tabindex="-1"></a>         <span class="st">'Intervention</span><span class="ch">\n</span><span class="st">(Week 14, 2021)'</span>, </span>
<span id="cb16-287"><a href="#cb16-287" aria-hidden="true" tabindex="-1"></a>         ha<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, color<span class="op">=</span><span class="st">'red'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb16-288"><a href="#cb16-288" aria-hidden="true" tabindex="-1"></a>         bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'yellow'</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, edgecolor<span class="op">=</span><span class="st">'red'</span>, linewidth<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb16-289"><a href="#cb16-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-290"><a href="#cb16-290" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Weekly Deaths'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb16-291"><a href="#cb16-291" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'CausalImpact Analysis: Bayesian Structural Time Series</span><span class="ch">\n</span><span class="st">Malignant Neoplasms (C00-C97), All Ages'</span>, </span>
<span id="cb16-292"><a href="#cb16-292" aria-hidden="true" tabindex="-1"></a>              fontsize<span class="op">=</span><span class="dv">15</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb16-293"><a href="#cb16-293" aria-hidden="true" tabindex="-1"></a>ax1.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">11</span>, framealpha<span class="op">=</span><span class="fl">0.95</span>)</span>
<span id="cb16-294"><a href="#cb16-294" aria-hidden="true" tabindex="-1"></a>ax1.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-295"><a href="#cb16-295" aria-hidden="true" tabindex="-1"></a>ax1.yaxis.set_major_formatter(plt.FuncFormatter(<span class="kw">lambda</span> x, p: <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x)<span class="sc">:,}</span><span class="ss">'</span>))</span>
<span id="cb16-296"><a href="#cb16-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-297"><a href="#cb16-297" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 2: Point-wise causal effect</span></span>
<span id="cb16-298"><a href="#cb16-298" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">1</span>, :])</span>
<span id="cb16-299"><a href="#cb16-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-300"><a href="#cb16-300" aria-hidden="true" tabindex="-1"></a>ax2.plot(post_data[<span class="st">'date'</span>], post_data_copy[<span class="st">'point_effect'</span>], </span>
<span id="cb16-301"><a href="#cb16-301" aria-hidden="true" tabindex="-1"></a>         linewidth<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">'darkred'</span>, label<span class="op">=</span><span class="st">'Point-wise Effect'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb16-302"><a href="#cb16-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-303"><a href="#cb16-303" aria-hidden="true" tabindex="-1"></a>ax2.fill_between(post_data[<span class="st">'date'</span>], </span>
<span id="cb16-304"><a href="#cb16-304" aria-hidden="true" tabindex="-1"></a>                  post_data_copy[<span class="st">'point_effect_lower'</span>], </span>
<span id="cb16-305"><a href="#cb16-305" aria-hidden="true" tabindex="-1"></a>                  post_data_copy[<span class="st">'point_effect_upper'</span>],</span>
<span id="cb16-306"><a href="#cb16-306" aria-hidden="true" tabindex="-1"></a>                  alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'95% CI'</span>, zorder<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb16-307"><a href="#cb16-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-308"><a href="#cb16-308" aria-hidden="true" tabindex="-1"></a>ax2.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb16-309"><a href="#cb16-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-310"><a href="#cb16-310" aria-hidden="true" tabindex="-1"></a><span class="co"># Shade positive/negative</span></span>
<span id="cb16-311"><a href="#cb16-311" aria-hidden="true" tabindex="-1"></a>ax2.fill_between(post_data[<span class="st">'date'</span>], <span class="dv">0</span>, post_data_copy[<span class="st">'point_effect'</span>],</span>
<span id="cb16-312"><a href="#cb16-312" aria-hidden="true" tabindex="-1"></a>                  where<span class="op">=</span>(post_data_copy[<span class="st">'point_effect'</span>] <span class="op">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb16-313"><a href="#cb16-313" aria-hidden="true" tabindex="-1"></a>                  alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'Positive Effect'</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-314"><a href="#cb16-314" aria-hidden="true" tabindex="-1"></a>ax2.fill_between(post_data[<span class="st">'date'</span>], <span class="dv">0</span>, post_data_copy[<span class="st">'point_effect'</span>],</span>
<span id="cb16-315"><a href="#cb16-315" aria-hidden="true" tabindex="-1"></a>                  where<span class="op">=</span>(post_data_copy[<span class="st">'point_effect'</span>] <span class="op">&lt;</span> <span class="dv">0</span>),</span>
<span id="cb16-316"><a href="#cb16-316" aria-hidden="true" tabindex="-1"></a>                  alpha<span class="op">=</span><span class="fl">0.2</span>, color<span class="op">=</span><span class="st">'green'</span>, label<span class="op">=</span><span class="st">'Negative Effect'</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-317"><a href="#cb16-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-318"><a href="#cb16-318" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Point-wise Effect</span><span class="ch">\n</span><span class="st">(Deaths/Week)'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb16-319"><a href="#cb16-319" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Point-wise Causal Effect (Observed - Counterfactual)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb16-320"><a href="#cb16-320" aria-hidden="true" tabindex="-1"></a>ax2.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>, framealpha<span class="op">=</span><span class="fl">0.95</span>)</span>
<span id="cb16-321"><a href="#cb16-321" aria-hidden="true" tabindex="-1"></a>ax2.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-322"><a href="#cb16-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-323"><a href="#cb16-323" aria-hidden="true" tabindex="-1"></a><span class="co"># Stats box</span></span>
<span id="cb16-324"><a href="#cb16-324" aria-hidden="true" tabindex="-1"></a>stats_text <span class="op">=</span> <span class="ss">f"""Causal Impact:</span></span>
<span id="cb16-325"><a href="#cb16-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-326"><a href="#cb16-326" aria-hidden="true" tabindex="-1"></a><span class="ss">Cumulative: </span><span class="sc">{</span>cumulative_effect<span class="sc">:,.0f}</span></span>
<span id="cb16-327"><a href="#cb16-327" aria-hidden="true" tabindex="-1"></a><span class="ss">95% CI: [</span><span class="sc">{</span>cumulative_lower<span class="sc">:,.0f}</span><span class="ss">, </span><span class="sc">{</span>cumulative_upper<span class="sc">:,.0f}</span><span class="ss">]</span></span>
<span id="cb16-328"><a href="#cb16-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-329"><a href="#cb16-329" aria-hidden="true" tabindex="-1"></a><span class="ss">Avg Weekly: </span><span class="sc">{</span>avg_effect<span class="sc">:,.1f}</span></span>
<span id="cb16-330"><a href="#cb16-330" aria-hidden="true" tabindex="-1"></a><span class="ss">Relative: </span><span class="sc">{</span>relative_effect<span class="sc">:+.2f}</span><span class="ss">%</span></span>
<span id="cb16-331"><a href="#cb16-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-332"><a href="#cb16-332" aria-hidden="true" tabindex="-1"></a><span class="ss">P(effect &gt; 0): </span><span class="sc">{</span>prob_causal_effect<span class="sc">:.3f}</span></span>
<span id="cb16-333"><a href="#cb16-333" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb16-334"><a href="#cb16-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-335"><a href="#cb16-335" aria-hidden="true" tabindex="-1"></a>ax2.text(<span class="fl">0.98</span>, <span class="fl">0.97</span>, stats_text, transform<span class="op">=</span>ax2.transAxes,</span>
<span id="cb16-336"><a href="#cb16-336" aria-hidden="true" tabindex="-1"></a>         fontsize<span class="op">=</span><span class="dv">10</span>, va<span class="op">=</span><span class="st">'top'</span>, ha<span class="op">=</span><span class="st">'right'</span>,</span>
<span id="cb16-337"><a href="#cb16-337" aria-hidden="true" tabindex="-1"></a>         bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">'round'</span>, facecolor<span class="op">=</span><span class="st">'wheat'</span>, alpha<span class="op">=</span><span class="fl">0.95</span>),</span>
<span id="cb16-338"><a href="#cb16-338" aria-hidden="true" tabindex="-1"></a>         family<span class="op">=</span><span class="st">'monospace'</span>)</span>
<span id="cb16-339"><a href="#cb16-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-340"><a href="#cb16-340" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 3: Cumulative effect</span></span>
<span id="cb16-341"><a href="#cb16-341" aria-hidden="true" tabindex="-1"></a>ax3 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">0</span>])</span>
<span id="cb16-342"><a href="#cb16-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-343"><a href="#cb16-343" aria-hidden="true" tabindex="-1"></a>cumsum_effect <span class="op">=</span> post_data_copy[<span class="st">'point_effect'</span>].cumsum()</span>
<span id="cb16-344"><a href="#cb16-344" aria-hidden="true" tabindex="-1"></a>cumsum_lower <span class="op">=</span> post_data_copy[<span class="st">'point_effect_lower'</span>].cumsum()</span>
<span id="cb16-345"><a href="#cb16-345" aria-hidden="true" tabindex="-1"></a>cumsum_upper <span class="op">=</span> post_data_copy[<span class="st">'point_effect_upper'</span>].cumsum()</span>
<span id="cb16-346"><a href="#cb16-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-347"><a href="#cb16-347" aria-hidden="true" tabindex="-1"></a>ax3.plot(post_data[<span class="st">'date'</span>], cumsum_effect, linewidth<span class="op">=</span><span class="dv">3</span>, color<span class="op">=</span><span class="st">'darkred'</span>, </span>
<span id="cb16-348"><a href="#cb16-348" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'Cumulative Effect'</span>)</span>
<span id="cb16-349"><a href="#cb16-349" aria-hidden="true" tabindex="-1"></a>ax3.fill_between(post_data[<span class="st">'date'</span>], cumsum_lower, cumsum_upper,</span>
<span id="cb16-350"><a href="#cb16-350" aria-hidden="true" tabindex="-1"></a>                  alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'95% CI'</span>)</span>
<span id="cb16-351"><a href="#cb16-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-352"><a href="#cb16-352" aria-hidden="true" tabindex="-1"></a>ax3.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb16-353"><a href="#cb16-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-354"><a href="#cb16-354" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'Date'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb16-355"><a href="#cb16-355" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Cumulative Effect (Deaths)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb16-356"><a href="#cb16-356" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Cumulative Causal Effect Over Time'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb16-357"><a href="#cb16-357" aria-hidden="true" tabindex="-1"></a>ax3.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">10</span>, framealpha<span class="op">=</span><span class="fl">0.95</span>)</span>
<span id="cb16-358"><a href="#cb16-358" aria-hidden="true" tabindex="-1"></a>ax3.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-359"><a href="#cb16-359" aria-hidden="true" tabindex="-1"></a>ax3.yaxis.set_major_formatter(plt.FuncFormatter(<span class="kw">lambda</span> x, p: <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x)<span class="sc">:,}</span><span class="ss">'</span>))</span>
<span id="cb16-360"><a href="#cb16-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-361"><a href="#cb16-361" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 4: Posterior distribution</span></span>
<span id="cb16-362"><a href="#cb16-362" aria-hidden="true" tabindex="-1"></a>ax4 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb16-363"><a href="#cb16-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-364"><a href="#cb16-364" aria-hidden="true" tabindex="-1"></a>ax4.hist(cumulative_samples, bins<span class="op">=</span><span class="dv">50</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, </span>
<span id="cb16-365"><a href="#cb16-365" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span><span class="st">'steelblue'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'Posterior'</span>)</span>
<span id="cb16-366"><a href="#cb16-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-367"><a href="#cb16-367" aria-hidden="true" tabindex="-1"></a>ax4.axvline(np.median(cumulative_samples), color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb16-368"><a href="#cb16-368" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f'Median: </span><span class="sc">{</span>np<span class="sc">.</span>median(cumulative_samples)<span class="sc">:,.0f}</span><span class="ss">'</span>)</span>
<span id="cb16-369"><a href="#cb16-369" aria-hidden="true" tabindex="-1"></a>ax4.axvline(cumulative_lower, color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb16-370"><a href="#cb16-370" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f'2.5%: </span><span class="sc">{</span>cumulative_lower<span class="sc">:,.0f}</span><span class="ss">'</span>)</span>
<span id="cb16-371"><a href="#cb16-371" aria-hidden="true" tabindex="-1"></a>ax4.axvline(cumulative_upper, color<span class="op">=</span><span class="st">'orange'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb16-372"><a href="#cb16-372" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f'97.5%: </span><span class="sc">{</span>cumulative_upper<span class="sc">:,.0f}</span><span class="ss">'</span>)</span>
<span id="cb16-373"><a href="#cb16-373" aria-hidden="true" tabindex="-1"></a>ax4.axvline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb16-374"><a href="#cb16-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-375"><a href="#cb16-375" aria-hidden="true" tabindex="-1"></a>ax4.set_xlabel(<span class="st">'Cumulative Causal Effect (Deaths)'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb16-376"><a href="#cb16-376" aria-hidden="true" tabindex="-1"></a>ax4.set_ylabel(<span class="st">'Density'</span>, fontsize<span class="op">=</span><span class="dv">12</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb16-377"><a href="#cb16-377" aria-hidden="true" tabindex="-1"></a>ax4.set_title(<span class="st">'Posterior Distribution of Cumulative Effect'</span>, fontsize<span class="op">=</span><span class="dv">13</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb16-378"><a href="#cb16-378" aria-hidden="true" tabindex="-1"></a>ax4.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">9</span>, framealpha<span class="op">=</span><span class="fl">0.95</span>)</span>
<span id="cb16-379"><a href="#cb16-379" aria-hidden="true" tabindex="-1"></a>ax4.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb16-380"><a href="#cb16-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-381"><a href="#cb16-381" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 5: Summary table</span></span>
<span id="cb16-382"><a href="#cb16-382" aria-hidden="true" tabindex="-1"></a>ax5 <span class="op">=</span> fig.add_subplot(gs[<span class="dv">3</span>, :])</span>
<span id="cb16-383"><a href="#cb16-383" aria-hidden="true" tabindex="-1"></a>ax5.axis(<span class="st">'off'</span>)</span>
<span id="cb16-384"><a href="#cb16-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-385"><a href="#cb16-385" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> [</span>
<span id="cb16-386"><a href="#cb16-386" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Metric'</span>, <span class="st">'Value'</span>, <span class="st">'95% Credible Interval'</span>],</span>
<span id="cb16-387"><a href="#cb16-387" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'─'</span><span class="op">*</span><span class="dv">50</span>, <span class="st">'─'</span><span class="op">*</span><span class="dv">30</span>, <span class="st">'─'</span><span class="op">*</span><span class="dv">40</span>],</span>
<span id="cb16-388"><a href="#cb16-388" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Cumulative absolute effect'</span>, <span class="ss">f'</span><span class="sc">{</span>cumulative_effect<span class="sc">:,.0f}</span><span class="ss"> deaths'</span>, </span>
<span id="cb16-389"><a href="#cb16-389" aria-hidden="true" tabindex="-1"></a>     <span class="ss">f'[</span><span class="sc">{</span>cumulative_lower<span class="sc">:,.0f}</span><span class="ss">, </span><span class="sc">{</span>cumulative_upper<span class="sc">:,.0f}</span><span class="ss">]'</span>],</span>
<span id="cb16-390"><a href="#cb16-390" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Cumulative relative effect'</span>, <span class="ss">f'</span><span class="sc">{</span>relative_effect<span class="sc">:+.2f}</span><span class="ss">%'</span>, <span class="st">''</span>],</span>
<span id="cb16-391"><a href="#cb16-391" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Average absolute effect'</span>, <span class="ss">f'</span><span class="sc">{</span>avg_effect<span class="sc">:,.1f}</span><span class="ss"> deaths/week'</span>, <span class="st">''</span>],</span>
<span id="cb16-392"><a href="#cb16-392" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Posterior tail-area probability (P(effect &gt; 0))'</span>, <span class="ss">f'</span><span class="sc">{</span>prob_causal_effect<span class="sc">:.3f}</span><span class="ss">'</span>, <span class="st">''</span>],</span>
<span id="cb16-393"><a href="#cb16-393" aria-hidden="true" tabindex="-1"></a>    [<span class="st">''</span>, <span class="st">''</span>, <span class="st">''</span>],</span>
<span id="cb16-394"><a href="#cb16-394" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Pre-intervention period'</span>, <span class="ss">f'</span><span class="sc">{</span>pre_data[<span class="st">"date"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>pre_data[<span class="st">"date"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">'</span>, </span>
<span id="cb16-395"><a href="#cb16-395" aria-hidden="true" tabindex="-1"></a>     <span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(pre_data)<span class="sc">}</span><span class="ss"> weeks'</span>],</span>
<span id="cb16-396"><a href="#cb16-396" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'Post-intervention period'</span>, <span class="ss">f'</span><span class="sc">{</span>post_data[<span class="st">"date"</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>post_data[<span class="st">"date"</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">'</span>, </span>
<span id="cb16-397"><a href="#cb16-397" aria-hidden="true" tabindex="-1"></a>     <span class="ss">f'</span><span class="sc">{</span><span class="bu">len</span>(post_data)<span class="sc">}</span><span class="ss"> weeks'</span>],</span>
<span id="cb16-398"><a href="#cb16-398" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb16-399"><a href="#cb16-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-400"><a href="#cb16-400" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> ax5.table(cellText<span class="op">=</span>summary_data, cellLoc<span class="op">=</span><span class="st">'left'</span>, loc<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb16-401"><a href="#cb16-401" aria-hidden="true" tabindex="-1"></a>                  bbox<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="cb16-402"><a href="#cb16-402" aria-hidden="true" tabindex="-1"></a>table.auto_set_font_size(<span class="va">False</span>)</span>
<span id="cb16-403"><a href="#cb16-403" aria-hidden="true" tabindex="-1"></a>table.set_fontsize(<span class="dv">11</span>)</span>
<span id="cb16-404"><a href="#cb16-404" aria-hidden="true" tabindex="-1"></a>table.scale(<span class="dv">1</span>, <span class="fl">2.5</span>)</span>
<span id="cb16-405"><a href="#cb16-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-406"><a href="#cb16-406" aria-hidden="true" tabindex="-1"></a><span class="co"># Style header</span></span>
<span id="cb16-407"><a href="#cb16-407" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb16-408"><a href="#cb16-408" aria-hidden="true" tabindex="-1"></a>    table[(<span class="dv">0</span>, i)].set_facecolor(<span class="st">'#4CAF50'</span>)</span>
<span id="cb16-409"><a href="#cb16-409" aria-hidden="true" tabindex="-1"></a>    table[(<span class="dv">0</span>, i)].set_text_props(weight<span class="op">=</span><span class="st">'bold'</span>, color<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb16-410"><a href="#cb16-410" aria-hidden="true" tabindex="-1"></a>    table[(<span class="dv">1</span>, i)].set_facecolor(<span class="st">'#E0E0E0'</span>)</span>
<span id="cb16-411"><a href="#cb16-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-412"><a href="#cb16-412" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternate rows</span></span>
<span id="cb16-413"><a href="#cb16-413" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="bu">len</span>(summary_data)):</span>
<span id="cb16-414"><a href="#cb16-414" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> <span class="st">'#F5F5F5'</span> <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'white'</span></span>
<span id="cb16-415"><a href="#cb16-415" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb16-416"><a href="#cb16-416" aria-hidden="true" tabindex="-1"></a>        table[(i, j)].set_facecolor(color)</span>
<span id="cb16-417"><a href="#cb16-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-418"><a href="#cb16-418" aria-hidden="true" tabindex="-1"></a>ax5.set_title(<span class="st">'CausalImpact Summary Report'</span>, fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb16-419"><a href="#cb16-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-420"><a href="#cb16-420" aria-hidden="true" tabindex="-1"></a><span class="co"># Format x-axes</span></span>
<span id="cb16-421"><a href="#cb16-421" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> [ax1, ax2, ax3]:</span>
<span id="cb16-422"><a href="#cb16-422" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_locator(mdates.YearLocator())</span>
<span id="cb16-423"><a href="#cb16-423" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">'%Y'</span>))</span>
<span id="cb16-424"><a href="#cb16-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-425"><a href="#cb16-425" aria-hidden="true" tabindex="-1"></a><span class="co"># Source</span></span>
<span id="cb16-426"><a href="#cb16-426" aria-hidden="true" tabindex="-1"></a>source <span class="op">=</span> (<span class="ss">f"CausalImpact Analysis | Bayesian Structural Time Series | MOSAIC-20 Project</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb16-427"><a href="#cb16-427" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"Intervention: 2021-04-10 | MCMC samples: 1500 (after 500 burn-in) | Generated: </span><span class="sc">{</span>datetime<span class="sc">.</span>now()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-428"><a href="#cb16-428" aria-hidden="true" tabindex="-1"></a>fig.text(<span class="fl">0.5</span>, <span class="fl">0.01</span>, source, ha<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>, style<span class="op">=</span><span class="st">'italic'</span>, color<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb16-429"><a href="#cb16-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-430"><a href="#cb16-430" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-431"><a href="#cb16-431" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(bottom<span class="op">=</span><span class="fl">0.04</span>)</span>
<span id="cb16-432"><a href="#cb16-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-433"><a href="#cb16-433" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> <span class="st">'/mnt/user-data/outputs/mosaic20_causalimpact_analysis.png'</span></span>
<span id="cb16-434"><a href="#cb16-434" aria-hidden="true" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb16-435"><a href="#cb16-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-436"><a href="#cb16-436" aria-hidden="true" tabindex="-1"></a><span class="co"># Save results</span></span>
<span id="cb16-437"><a href="#cb16-437" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> all_data[[<span class="st">'date'</span>, <span class="st">'deaths'</span>, <span class="st">'counterfactual'</span>, <span class="st">'counter_lower'</span>, <span class="st">'counter_upper'</span>]].copy()</span>
<span id="cb16-438"><a href="#cb16-438" aria-hidden="true" tabindex="-1"></a>results_df[<span class="st">'point_effect'</span>] <span class="op">=</span> results_df[<span class="st">'deaths'</span>] <span class="op">-</span> results_df[<span class="st">'counterfactual'</span>]</span>
<span id="cb16-439"><a href="#cb16-439" aria-hidden="true" tabindex="-1"></a>results_df.to_csv(<span class="st">'/mnt/user-data/outputs/mosaic20_causalimpact_results.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb16-440"><a href="#cb16-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-441"><a href="#cb16-441" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-442"><a href="#cb16-442" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ CAUSALIMPACT ANALYSIS COMPLETE"</span>)</span>
<span id="cb16-443"><a href="#cb16-443" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb16-444"><a href="#cb16-444" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Visualization: </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-445"><a href="#cb16-445" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">FINAL CAUSAL IMPACT ESTIMATE:"</span>)</span>
<span id="cb16-446"><a href="#cb16-446" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Cumulative effect: </span><span class="sc">{</span>cumulative_effect<span class="sc">:,.0f}</span><span class="ss"> deaths (</span><span class="sc">{</span>relative_effect<span class="sc">:+.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb16-447"><a href="#cb16-447" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  95% Credible Interval: [</span><span class="sc">{</span>cumulative_lower<span class="sc">:,.0f}</span><span class="ss">, </span><span class="sc">{</span>cumulative_upper<span class="sc">:,.0f}</span><span class="ss">]"</span>)</span>
<span id="cb16-448"><a href="#cb16-448" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Posterior probability of causal effect: </span><span class="sc">{</span>prob_causal_effect<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb16-449"><a href="#cb16-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-450"><a href="#cb16-450" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> prob_causal_effect <span class="op">&gt;</span> <span class="fl">0.95</span>:</span>
<span id="cb16-451"><a href="#cb16-451" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  CONCLUSION: Strong evidence of POSITIVE causal effect"</span>)</span>
<span id="cb16-452"><a href="#cb16-452" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> prob_causal_effect <span class="op">&lt;</span> <span class="fl">0.05</span>:</span>
<span id="cb16-453"><a href="#cb16-453" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  CONCLUSION: Strong evidence of NEGATIVE causal effect"</span>)</span>
<span id="cb16-454"><a href="#cb16-454" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb16-455"><a href="#cb16-455" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  CONCLUSION: Inconclusive evidence (probability = </span><span class="sc">{</span>prob_causal_effect<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb16-456"><a href="#cb16-456" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span>
<span id="cb16-457"><a href="#cb16-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-458"><a href="#cb16-458" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>================================================================================
MOSAIC-20: CAUSAL IMPACT ANALYSIS (Bayesian Structural Time Series)
================================================================================

[1/5] Loading data...
  Total: 631 weeks
  Pre-intervention: 379 weeks (training)
  Post-intervention: 252 weeks (prediction)
  Intervention date: 2021-04-10

[2/5] Fitting Bayesian Structural Time Series model...
  Initializing BSTS model...
  Running Gibbs sampling (2000 iterations)...
  Kept 1500 samples after burn-in

[3/5] Generating counterfactual predictions...
  Generated predictions for 252 weeks
  Mean prediction at intervention: 11,084.5
  Mean prediction at end: 1,828.9

[4/5] Calculating causal impact...

  CAUSAL IMPACT SUMMARY:
  Cumulative effect: 1,314,451 deaths
  95% CI: [1,223,525, 1,405,227]
  Average weekly effect: 5,216.1 deaths/week
  Relative effect: +79.79%
  Posterior P(effect &gt; 0): 1.000

[5/5] Creating CausalImpact visualization...</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[22], line 434</span>
<span class="ansi-green-fg ansi-bold">    431</span> plt<span style="color:rgb(98,98,98)">.</span>subplots_adjust(bottom<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0.04</span>)
<span class="ansi-green-fg ansi-bold">    433</span> output_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">/mnt/user-data/outputs/mosaic20_causalimpact_analysis.png</span><span style="color:rgb(175,0,0)">'</span>
<span class="ansi-green-fg">--&gt; 434</span> <span class="ansi-yellow-bg">plt</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">savefig</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">output_path</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dpi</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">300</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">bbox_inches</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">tight</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    436</span> <span style="font-style:italic;color:rgb(95,135,135)"># Save results</span>
<span class="ansi-green-fg ansi-bold">    437</span> results_df <span style="color:rgb(98,98,98)">=</span> all_data[[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">date</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">deaths</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">counterfactual</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">counter_lower</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">counter_upper</span><span style="color:rgb(175,0,0)">'</span>]]<span style="color:rgb(98,98,98)">.</span>copy()

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/pyplot.py:1023</span>, in <span class="ansi-cyan-fg">savefig</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1020</span> <span style="color:rgb(175,0,255)">@_copy_docstring_and_deprecators</span>(Figure<span style="color:rgb(98,98,98)">.</span>savefig)
<span class="ansi-green-fg ansi-bold">   1021</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">savefig</span>(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs):
<span class="ansi-green-fg ansi-bold">   1022</span>     fig <span style="color:rgb(98,98,98)">=</span> gcf()
<span class="ansi-green-fg">-&gt; 1023</span>     res <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">fig</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">savefig</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1024</span>     fig<span style="color:rgb(98,98,98)">.</span>canvas<span style="color:rgb(98,98,98)">.</span>draw_idle()  <span style="font-style:italic;color:rgb(95,135,135)"># Need this if 'transparent=True', to reset colors.</span>
<span class="ansi-green-fg ansi-bold">   1025</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> res

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/figure.py:3378</span>, in <span class="ansi-cyan-fg">Figure.savefig</span><span class="ansi-blue-fg">(self, fname, transparent, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   3374</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> ax <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>axes:
<span class="ansi-green-fg ansi-bold">   3375</span>         stack<span style="color:rgb(98,98,98)">.</span>enter_context(
<span class="ansi-green-fg ansi-bold">   3376</span>             ax<span style="color:rgb(98,98,98)">.</span>patch<span style="color:rgb(98,98,98)">.</span>_cm_set(facecolor<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">none</span><span style="color:rgb(175,0,0)">'</span>, edgecolor<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">none</span><span style="color:rgb(175,0,0)">'</span>))
<span class="ansi-green-fg">-&gt; 3378</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">canvas</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">print_figure</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">fname</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/backend_bases.py:2366</span>, in <span class="ansi-cyan-fg">FigureCanvasBase.print_figure</span><span class="ansi-blue-fg">(self, filename, dpi, facecolor, edgecolor, orientation, format, bbox_inches, pad_inches, bbox_extra_artists, backend, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   2362</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   2363</span>     <span style="font-style:italic;color:rgb(95,135,135)"># _get_renderer may change the figure dpi (as vector formats</span>
<span class="ansi-green-fg ansi-bold">   2364</span>     <span style="font-style:italic;color:rgb(95,135,135)"># force the figure dpi to 72), so we need to set it again here.</span>
<span class="ansi-green-fg ansi-bold">   2365</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> cbook<span style="color:rgb(98,98,98)">.</span>_setattr_cm(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>figure, dpi<span style="color:rgb(98,98,98)">=</span>dpi):
<span class="ansi-green-fg">-&gt; 2366</span>         result <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">print_method</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">   2367</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">filename</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   2368</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">facecolor</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">facecolor</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   2369</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">edgecolor</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">edgecolor</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   2370</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">orientation</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">orientation</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   2371</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">bbox_inches_restore</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">_bbox_inches_restore</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   2372</span> <span class="ansi-yellow-bg">            </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   2373</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">   2374</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> bbox_inches <span style="font-weight:bold;color:rgb(175,0,255)">and</span> restore_bbox:

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/backend_bases.py:2232</span>, in <span class="ansi-cyan-fg">FigureCanvasBase._switch_canvas_and_return_print_method.&lt;locals&gt;.&lt;lambda&gt;</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   2228</span>     optional_kws <span style="color:rgb(98,98,98)">=</span> {  <span style="font-style:italic;color:rgb(95,135,135)"># Passed by print_figure for other renderers.</span>
<span class="ansi-green-fg ansi-bold">   2229</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">dpi</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">facecolor</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">edgecolor</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">orientation</span><span style="color:rgb(175,0,0)">"</span>,
<span class="ansi-green-fg ansi-bold">   2230</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">bbox_inches_restore</span><span style="color:rgb(175,0,0)">"</span>}
<span class="ansi-green-fg ansi-bold">   2231</span>     skip <span style="color:rgb(98,98,98)">=</span> optional_kws <span style="color:rgb(98,98,98)">-</span> {<span style="color:rgb(98,98,98)">*</span>inspect<span style="color:rgb(98,98,98)">.</span>signature(meth)<span style="color:rgb(98,98,98)">.</span>parameters}
<span class="ansi-green-fg">-&gt; 2232</span>     print_method <span style="color:rgb(98,98,98)">=</span> functools<span style="color:rgb(98,98,98)">.</span>wraps(meth)(<span style="font-weight:bold;color:rgb(0,135,0)">lambda</span> <span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs: <span class="ansi-yellow-bg">meth</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">   2233</span> <span class="ansi-yellow-bg">        </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">{</span><span class="ansi-yellow-bg">k</span><span class="ansi-yellow-bg">:</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">v</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">for</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">k</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">v</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(175,0,255)" class="ansi-yellow-bg">in</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">items</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">if</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">k</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(175,0,255)" class="ansi-yellow-bg">not</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(175,0,255)" class="ansi-yellow-bg">in</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">skip</span><span class="ansi-yellow-bg">}</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">   2234</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:  <span style="font-style:italic;color:rgb(95,135,135)"># Let third-parties do as they see fit.</span>
<span class="ansi-green-fg ansi-bold">   2235</span>     print_method <span style="color:rgb(98,98,98)">=</span> meth

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:509</span>, in <span class="ansi-cyan-fg">FigureCanvasAgg.print_png</span><span class="ansi-blue-fg">(self, filename_or_obj, metadata, pil_kwargs)</span>
<span class="ansi-green-fg ansi-bold">    462</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">print_png</span>(<span style="color:rgb(0,135,0)">self</span>, filename_or_obj, <span style="color:rgb(98,98,98)">*</span>, metadata<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">None</span>, pil_kwargs<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">None</span>):
<span class="ansi-green-fg ansi-bold">    463</span> <span style="color:rgb(188,188,188)">    </span><span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    464</span> <span style="font-style:italic;color:rgb(175,0,0)">    Write the figure to a PNG file.</span>
<span class="ansi-green-fg ansi-bold">    465</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    507</span> <span style="font-style:italic;color:rgb(175,0,0)">        *metadata*, including the default 'Software' key.</span>
<span class="ansi-green-fg ansi-bold">    508</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">--&gt; 509</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_print_pil</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filename_or_obj</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">png</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">pil_kwargs</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">metadata</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:458</span>, in <span class="ansi-cyan-fg">FigureCanvasAgg._print_pil</span><span class="ansi-blue-fg">(self, filename_or_obj, fmt, pil_kwargs, metadata)</span>
<span class="ansi-green-fg ansi-bold">    453</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    454</span> <span style="font-style:italic;color:rgb(175,0,0)">Draw the canvas, then save it using `.image.imsave` (to which</span>
<span class="ansi-green-fg ansi-bold">    455</span> <span style="font-style:italic;color:rgb(175,0,0)">*pil_kwargs* and *metadata* are forwarded).</span>
<span class="ansi-green-fg ansi-bold">    456</span> <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    457</span> FigureCanvasAgg<span style="color:rgb(98,98,98)">.</span>draw(<span style="color:rgb(0,135,0)">self</span>)
<span class="ansi-green-fg">--&gt; 458</span> <span class="ansi-yellow-bg">mpl</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">image</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">imsave</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    459</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">filename_or_obj</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">buffer_rgba</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">format</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">fmt</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">origin</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">upper</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    460</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">dpi</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">figure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">dpi</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">metadata</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">metadata</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">pil_kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">pil_kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/matplotlib/image.py:1689</span>, in <span class="ansi-cyan-fg">imsave</span><span class="ansi-blue-fg">(fname, arr, vmin, vmax, cmap, format, origin, dpi, metadata, pil_kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1687</span> pil_kwargs<span style="color:rgb(98,98,98)">.</span>setdefault(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">format</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(0,135,0)">format</span>)
<span class="ansi-green-fg ansi-bold">   1688</span> pil_kwargs<span style="color:rgb(98,98,98)">.</span>setdefault(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">dpi</span><span style="color:rgb(175,0,0)">"</span>, (dpi, dpi))
<span class="ansi-green-fg">-&gt; 1689</span> <span class="ansi-yellow-bg">image</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">save</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">fname</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">pil_kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/anaconda3/envs/py-data/lib/python3.8/site-packages/PIL/Image.py:2410</span>, in <span class="ansi-cyan-fg">Image.save</span><span class="ansi-blue-fg">(self, fp, format, **params)</span>
<span class="ansi-green-fg ansi-bold">   2408</span>         fp <span style="color:rgb(98,98,98)">=</span> builtins<span style="color:rgb(98,98,98)">.</span>open(filename, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">r+b</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   2409</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 2410</span>         fp <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">builtins</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filename</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">w+b</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   2412</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   2413</span>     save_handler(<span style="color:rgb(0,135,0)">self</span>, fp, filename)

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: '/mnt/user-data/outputs/mosaic20_causalimpact_analysis.png'</pre>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="mosaic-20-cancer-analysis_files/figure-html/cell-9-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/dbose\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>